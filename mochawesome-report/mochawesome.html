<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:88,&quot;tests&quot;:264,&quot;passes&quot;:236,&quot;pending&quot;:24,&quot;failures&quot;:4,&quot;start&quot;:&quot;2023-10-04T02:38:41.015Z&quot;,&quot;end&quot;:&quot;2023-10-04T02:40:17.989Z&quot;,&quot;duration&quot;:96974,&quot;testsRegistered&quot;:264,&quot;passPercent&quot;:98.33333333333333,&quot;pendingPercent&quot;:9.090909090909092,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;69ba5d53-0f4a-4d33-9561-30cee04d9b1a&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e9538e64-973b-4287-81f5-b551fea99936&quot;,&quot;title&quot;:&quot;Asset Amounts &amp; Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values \&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.assetValuesFixture)();\nf.user = hre.users.testUserSeven;\nUser = (0, _redstone.wrapKresko)(hre.Diamond, f.user);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8a54ef54-2364-4f79-996c-bc25ec613e05&quot;,&quot;parentUUID&quot;:&quot;e9538e64-973b-4287-81f5-b551fea99936&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;995f1d44-02bb-4c7e-8e46-145c4484834d&quot;,&quot;title&quot;:&quot;#Collateral Deposit Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit value with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:106,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;82c605da-c9ca-48bc-9957-61d4c427c014&quot;,&quot;parentUUID&quot;:&quot;995f1d44-02bb-4c7e-8e46-145c4484834d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:103,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af2770af-bb57-4080-9e6e-45ad6dac8a82&quot;,&quot;parentUUID&quot;:&quot;995f1d44-02bb-4c7e-8e46-145c4484834d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4df21c6c-d911-4135-b6b3-d2f4b1e21853&quot;,&quot;parentUUID&quot;:&quot;995f1d44-02bb-4c7e-8e46-145c4484834d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value combination of different decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value combination of different decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:251,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(f.user.address, f.CollateralAsset.address, (0, _values.toBig)(10));\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, (0, _values.toBig)(10, 8));\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, (0, _values.toBig)(10, 21));\nconst expectedDepositValue = (0, _values.toBig)(150, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 30\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b16eb971-8d0f-48ac-93a6-4e968beed07d&quot;,&quot;parentUUID&quot;:&quot;995f1d44-02bb-4c7e-8e46-145c4484834d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;82c605da-c9ca-48bc-9957-61d4c427c014&quot;,&quot;af2770af-bb57-4080-9e6e-45ad6dac8a82&quot;,&quot;4df21c6c-d911-4135-b6b3-d2f4b1e21853&quot;,&quot;b16eb971-8d0f-48ac-93a6-4e968beed07d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:568,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;fba7431e-fc4d-45d2-bc62-c48089f16171&quot;,&quot;title&quot;:&quot;#Collateral Deposit Amount&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit amount with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:118,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;874fcd14-26ea-44ba-98b1-cf0d8c012e75&quot;,&quot;parentUUID&quot;:&quot;fba7431e-fc4d-45d2-bc62-c48089f16171&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit amount with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:112,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset8Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset8Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset8Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;abc2050b-d05d-4508-a7ce-4189da8e17d9&quot;,&quot;parentUUID&quot;:&quot;fba7431e-fc4d-45d2-bc62-c48089f16171&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset21Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset21Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset21Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance, 21));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7119527c-afe9-478f-bc42-17d6cc03fca1&quot;,&quot;parentUUID&quot;:&quot;fba7431e-fc4d-45d2-bc62-c48089f16171&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;874fcd14-26ea-44ba-98b1-cf0d8c012e75&quot;,&quot;abc2050b-d05d-4508-a7ce-4189da8e17d9&quot;,&quot;7119527c-afe9-478f-bc42-17d6cc03fca1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:338,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;4a0c14e3-9fc9-4101-b9c5-592f055962ff&quot;,&quot;title&quot;:&quot;#Kresko Asset Debt Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:660,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;66cc9f2a-3b2f-498c-805e-d804ad844f83&quot;,&quot;parentUUID&quot;:&quot;4a0c14e3-9fc9-4101-b9c5-592f055962ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:666,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d2c4085e-1fb6-4ab5-a5cb-fcdd0facadae&quot;,&quot;parentUUID&quot;:&quot;4a0c14e3-9fc9-4101-b9c5-592f055962ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:682,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;67535998-db73-49d5-8689-553d6e9fd62f&quot;,&quot;parentUUID&quot;:&quot;4a0c14e3-9fc9-4101-b9c5-592f055962ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;66cc9f2a-3b2f-498c-805e-d804ad844f83&quot;,&quot;d2c4085e-1fb6-4ab5-a5cb-fcdd0facadae&quot;,&quot;67535998-db73-49d5-8689-553d6e9fd62f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2008,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;739506f9-8af6-444f-8576-ea7d47271c68&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d6914813-9b71-4499-8bc7-60880abfb830&quot;,&quot;parentUUID&quot;:&quot;739506f9-8af6-444f-8576-ea7d47271c68&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;63915d62-0594-4e2d-b31b-307e4004d10b&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:75,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(_hardhat.default.users.deployer.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6d58738-cc0f-411a-a379-d08fc56baf62&quot;,&quot;parentUUID&quot;:&quot;63915d62-0594-4e2d-b31b-307e4004d10b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets standard facet addresses&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets standard facet addresses&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:84,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetAddressesOnChain = (await _hardhat.default.Diamond.facets()).map((f)=&gt;f.facetAddress);\nconst facetAddressesArtifact = f.facets.map((f)=&gt;f.facetAddress);\n(0, _chai.expect)(facetAddressesOnChain.length).to.equal(facetAddressesArtifact.length);\n(0, _chai.expect)(facetAddressesOnChain).to.have.members(facetAddressesArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b8a7de6-19db-41ec-9642-91b6fc933a96&quot;,&quot;parentUUID&quot;:&quot;63915d62-0594-4e2d-b31b-307e4004d10b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets selectors of standard facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets selectors of standard facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:83,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsSelectorsOnChain = (await _hardhat.default.Diamond.facets()).flatMap((f)=&gt;f.functionSelectors);\nconst facetSelectorsOnArtifact = f.facets.flatMap((f)=&gt;f.functionSelectors);\n(0, _chai.expect)(facetsSelectorsOnChain.length).to.equal(facetSelectorsOnArtifact.length);\n(0, _chai.expect)(facetsSelectorsOnChain).to.have.members(facetSelectorsOnArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6eb5d57f-66cd-48b2-b1f0-b3d15a3add13&quot;,&quot;parentUUID&quot;:&quot;63915d62-0594-4e2d-b31b-307e4004d10b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e6d58738-cc0f-411a-a379-d08fc56baf62&quot;,&quot;1b8a7de6-19db-41ec-9642-91b6fc933a96&quot;,&quot;6eb5d57f-66cd-48b2-b1f0-b3d15a3add13&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:242,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;704fa348-0b27-447f-b486-d89db6817b47&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5baddd0e-4b86-4740-ba81-905cf1611585&quot;,&quot;parentUUID&quot;:&quot;704fa348-0b27-447f-b486-d89db6817b47&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;99984964-bf06-41e5-b965-1f70c8dc21a3&quot;,&quot;title&quot;:&quot;#ownership&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:35,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.owner()).to.equal(hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae2267c1-3422-4c24-87cf-4cd979de2e0d&quot;,&quot;parentUUID&quot;:&quot;99984964-bf06-41e5-b965-1f70c8dc21a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct default admin role&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct default admin role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:37,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.hasRole(_roles.default.ADMIN, hre.addr.deployer)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b954c7c6-4f7f-4314-8019-50c7ad51507d&quot;,&quot;parentUUID&quot;:&quot;99984964-bf06-41e5-b965-1f70c8dc21a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets a new pending owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets a new pending owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:76,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\n(0, _chai.expect)(await hre.Diamond.pendingOwner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b909731-5326-4094-bbb1-84d8547bb538&quot;,&quot;parentUUID&quot;:&quot;99984964-bf06-41e5-b965-1f70c8dc21a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets the pending owner as new owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets the pending owner as new owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:133,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\nawait (0, _general.wrapContractWithSigner)(hre.Diamond, pendingOwner).acceptOwnership();\n(0, _chai.expect)(await hre.Diamond.owner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;41305738-5f4b-45c4-b8ef-047a4bc3c950&quot;,&quot;parentUUID&quot;:&quot;99984964-bf06-41e5-b965-1f70c8dc21a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ae2267c1-3422-4c24-87cf-4cd979de2e0d&quot;,&quot;b954c7c6-4f7f-4314-8019-50c7ad51507d&quot;,&quot;7b909731-5326-4094-bbb1-84d8547bb538&quot;,&quot;41305738-5f4b-45c4-b8ef-047a4bc3c950&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:281,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c33be9b8-d7de-44d4-868a-5e1dbc168a79&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7250ccea-5a45-4303-858b-8253ac177abd&quot;,&quot;parentUUID&quot;:&quot;c33be9b8-d7de-44d4-868a-5e1dbc168a79&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;title&quot;:&quot;#upgrades&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can add a new facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can add a new facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:424,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst TEST_OPERATOR_ROLE = hre.ethers.utils.id(\&quot;kresko.test.operator\&quot;);\nconst isTestOperator = await hre.Diamond.hasRole(TEST_OPERATOR_ROLE, hre.addr.userOne);\n// Succesfully added the new operator through the initialization contract\n(0, _chai.expect)(isTestOperator).to.equal(true);\nconst Facet = await hre.ethers.getContractAt([\n    ..._typechain.SmockFacet__factory.abi\n], hre.Diamond.address);\n// Ensure facet has it&#x27;s own storage\nconst operatorFromNewStorage = await Facet.operator(); // Retrieved from SmockStorage\n(0, _chai.expect)(operatorFromNewStorage).to.equal(hre.addr.userOne);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d78fea89-f501-4c8e-a8c4-5fabe7af88ac&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:585,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const NewFacet = await (0, _addfacet.addFacet)({\n    name: \&quot;SmockFacet\&quot;,\n    initializerName: \&quot;SmockInit\&quot;,\n    initializerArgs: hre.addr.userOne\n});\nconst facetsBefore = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.filter((f)=&gt;f.facetAddress === NewFacet.address).length).to.equal(1);\nawait (0, _removefacet.removeFacet)({\n    name: \&quot;SmockFacet\&quot;\n});\nconst facetsAfter = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.length - facetsAfter.length).to.equal(1);\n(0, _chai.expect)(facetsAfter).to.not.deep.contain(NewFacet.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;37de20c9-da20-41e5-930e-2990e2b4eb32&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:165,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Delete acceptOwnership from DiamondOwnershipFacet\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.nonadmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst facetAddress = await hre.Diamond.facetAddress(signature);\nconst functions = await hre.Diamond.facetFunctionSelectors(facetAddress);\nconst Cut = {\n    facetAddress: hre.ethers.constants.AddressZero,\n    action: _types.FacetCutAction.Remove,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure rest of the functions remain\nconst functionsAfterCut = await hre.Diamond.facetFunctionSelectors(facetAddress);\n(0, _chai.expect)(functionsAfterCut.length).to.equal(functions.length - 1);\n// Ensure delegatecall did set the correct pending owner with the cut\nconst contract = await hre.ethers.getContractAt(\&quot;AuthEvent\&quot;, hre.Diamond.address);\nconst filter = contract.filters.PendingOwnershipTransfer(hre.addr.deployer, correctOwner);\nconst [event] = await contract.queryFilter(filter);\nconst { previousOwner, newOwner } = event.args;\n(0, _chai.expect)(previousOwner).to.equal(hre.addr.deployer);\n(0, _chai.expect)(newOwner).to.equal(correctOwner);\n// Ensure there is no function to accept the ownership\nawait (0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, hre.users.nonadmin).acceptOwnership()).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;974d46d7-14cd-4767-9e08-d20ad27bcc45&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can replace a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can replace a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:232,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Same as above but instead replace the function\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.nonadmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst OldOwnershipFacet = await hre.Diamond.facetAddress(signature);\nconst [NewOwnershipFacet, allOwnershipFacetSignatures] = await hre.deploy(\&quot;DiamondOwnershipFacet\&quot;, {\n    deploymentName: \&quot;DiamondOwnershipFacet2\&quot;\n});\n// Only replace a single function, we could replace all of them\nconst Cut = {\n    facetAddress: NewOwnershipFacet.address,\n    action: _types.FacetCutAction.Replace,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure function exists and revert is for invalid address instead of missing function\nawait (0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, hre.users.nonadmin).acceptOwnership()).to.be.reverted;\n// Ensure one function is contained in the new facet\nconst functionsNewFacet = await hre.Diamond.facetFunctionSelectors(NewOwnershipFacet.address);\n(0, _chai.expect)(functionsNewFacet.length).to.equal(1);\n(0, _chai.expect)(functionsNewFacet).to.have.members([\n    signature\n]);\n// Ensure rest are in the previous one\nconst functionsOldFacet = await hre.Diamond.facetFunctionSelectors(OldOwnershipFacet);\n(0, _chai.expect)(functionsOldFacet).to.not.have.members([\n    signature\n]);\n(0, _chai.expect)(functionsOldFacet.length).to.equal(allOwnershipFacetSignatures.length - 1);\n// Ensure correct owner can now accept the ownership\n(0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, hre.users.userOne).acceptOwnership());\nconst currentOwner = await hre.Diamond.owner();\n(0, _chai.expect)(currentOwner).to.equal(correctOwner);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ab12f74-1652-4e6a-bc19-e47810431aac&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can upgrade state&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can upgrade state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:318,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\nconst Factory = await _smock.smock.mock(\&quot;SmockInit\&quot;);\nconst SmockInit = await Factory.deploy();\nconst tx = await SmockInit.populateTransaction.upgradeState();\nawait hre.Diamond.upgradeState(tx.to, tx.data);\n(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7bf6bd89-20cf-4ede-9de8-ed5064e1a8ce&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can preserve old state when extending storage layout&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can preserve old state when extending storage layout&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:650,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\n// Add the first facet\nconst Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst Diamond = await hre.ethers.getContractAt(\&quot;SmockFacet\&quot;, hre.Diamond.address);\nconst isInitialized = await Diamond.smockInitialized();\n(0, _chai.expect)(isInitialized).to.equal(true);\n// Add facet with extended state\n// Add the first facet\nconst Factory2 = await _smock.smock.mock(\&quot;SmockFacet2\&quot;);\nconst SmockFacet2 = await Factory2.deploy();\nconst signatures2 = hre.getSignatures([\n    ..._typechain.SmockFacet2__factory.abi\n]);\nconst Cut2 = {\n    facetAddress: SmockFacet2.address,\n    functionSelectors: signatures2,\n    action: _types.FacetCutAction.Add\n};\n// Initializer only sets the new extended value, does not touch old storage\nconst initData2 = await SmockFacet2.populateTransaction.initialize();\nawait hre.Diamond.diamondCut([\n    Cut2\n], initData2.to, initData2.data);\n// Here we have appended the storage layout with the `extended` bool property.\nconst DiamondExtended = await hre.ethers.getContractAt(\&quot;SmockFacet2\&quot;, hre.Diamond.address);\nconst initializedAfterExtend = await DiamondExtended.getOldStructValueFromExtended();\nconst extendedValue = await DiamondExtended.getNewStructValueFromExtended();\n// Old values remain\n(0, _chai.expect)(initializedAfterExtend).to.equal(true);\n// And we get new ones\n(0, _chai.expect)(extendedValue).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c4d38e8d-6226-4c68-9a6c-b949f6c76ab7&quot;,&quot;parentUUID&quot;:&quot;a227096b-8572-4183-94a5-19505f6ba392&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d78fea89-f501-4c8e-a8c4-5fabe7af88ac&quot;,&quot;37de20c9-da20-41e5-930e-2990e2b4eb32&quot;,&quot;974d46d7-14cd-4767-9e08-d20ad27bcc45&quot;,&quot;1ab12f74-1652-4e6a-bc19-e47810431aac&quot;,&quot;7bf6bd89-20cf-4ede-9de8-ed5064e1a8ce&quot;,&quot;c4d38e8d-6226-4c68-9a6c-b949f6c76ab7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2374,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;3e4cf1eb-fca3-444b-9c59-5e1d160bf8c1&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/03-protocol.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/03-protocol.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c09c0feb-5601-478e-a3a3-a75bdb81a1fb&quot;,&quot;parentUUID&quot;:&quot;3e4cf1eb-fca3-444b-9c59-5e1d160bf8c1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;748f4682-48de-4414-b3bb-243132b0b74d&quot;,&quot;title&quot;:&quot;#protocol initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/03-protocol.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/03-protocol.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;initialized all facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #protocol initialization initialized all facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:79,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsOnChain = (await hre.Diamond.facets()).map(([facetAddress, functionSelectors])=&gt;({\n        facetAddress,\n        functionSelectors\n    }));\nconst expectedFacets = await Promise.all([\n    ..._shared.minterFacets,\n    ..._shared.diamondFacets,\n    ..._shared.scdpFacets,\n    ..._shared.commonFacets\n].map(async (name)=&gt;{\n    const deployment = await hre.deployments.get(name);\n    return {\n        facetAddress: deployment.address,\n        functionSelectors: facetsOnChain.find((f)=&gt;f.facetAddress === deployment.address).functionSelectors\n    };\n}));\n(0, _chai.expect)(facetsOnChain).to.have.deep.members(expectedFacets);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7231c873-833a-4596-9175-c68217e5d4b7&quot;,&quot;parentUUID&quot;:&quot;748f4682-48de-4414-b3bb-243132b0b74d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;initialized correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #protocol initialization initialized correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:276,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.getStorageVersion()).to.equal(4);\nconst { args } = await (0, _shared.getCommonInitializer)(hre);\nconst { args: minterArgs } = await (0, _shared.getMinterInitializer)(hre);\nconst { args: scdpArgs } = await (0, _shared.getSCDPInitializer)(hre);\n(0, _chai.expect)(await hre.Diamond.hasRole(_roles.Role.ADMIN, args.admin)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.hasRole(_roles.Role.SAFETY_COUNCIL, hre.Multisig.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getFeeRecipient()).to.equal(args.treasury);\n(0, _chai.expect)(await hre.Diamond.getMinCollateralRatio()).to.equal(minterArgs.minCollateralRatio);\nconst scdpParams = await hre.Diamond.getCurrentParametersSCDP();\n(0, _chai.expect)(scdpParams.minCollateralRatio).to.equal(scdpArgs.minCollateralRatio);\n(0, _chai.expect)(scdpParams.liquidationThreshold).to.equal(scdpArgs.liquidationThreshold);\n(0, _chai.expect)(scdpParams.swapFeeRecipient).to.equal(scdpArgs.swapFeeRecipient);\n(0, _chai.expect)(await hre.Diamond.getMinDebtValue()).to.equal(args.minDebtValue);\n(0, _chai.expect)(await hre.Diamond.getOracleDeviationPct()).to.equal(args.oracleDeviationPct);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bd683bd9-74c8-4156-8d80-be08d6d38efa&quot;,&quot;parentUUID&quot;:&quot;748f4682-48de-4414-b3bb-243132b0b74d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7231c873-833a-4596-9175-c68217e5d4b7&quot;,&quot;bd683bd9-74c8-4156-8d80-be08d6d38efa&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:355,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;90ed0933-9dd6-4f01-a425-4a26e69f1d3e&quot;,&quot;title&quot;:&quot;Forking&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;34a93691-885d-4bb4-981a-9082eb8354e6&quot;,&quot;title&quot;:&quot;#setup&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should get Kresko from the companion network locally&quot;,&quot;fullTitle&quot;:&quot;Forking #setup should get Kresko from the companion network locally&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5882cc84-97cd-4d28-b04c-854e5d35371c&quot;,&quot;parentUUID&quot;:&quot;34a93691-885d-4bb4-981a-9082eb8354e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;5882cc84-97cd-4d28-b04c-854e5d35371c&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;98c3521c-fbf2-460f-afe4-9e47977d392e&quot;,&quot;title&quot;:&quot;#rate-upgrade-11-04-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deploy facets&quot;,&quot;fullTitle&quot;:&quot;Forking #rate-upgrade-11-04-2023 should be able to deploy facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b09740bb-fd7c-43d8-bbe9-02f4cc42a7db&quot;,&quot;parentUUID&quot;:&quot;98c3521c-fbf2-460f-afe4-9e47977d392e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;b09740bb-fd7c-43d8-bbe9-02f4cc42a7db&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;43894157-c790-4746-a924-681468adedb5&quot;,&quot;title&quot;:&quot;#facet-upgrade-16-05-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;works&quot;,&quot;fullTitle&quot;:&quot;Forking #facet-upgrade-16-05-2023 works&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d69bf581-a18f-4563-8ee9-72fae6d37115&quot;,&quot;parentUUID&quot;:&quot;43894157-c790-4746-a924-681468adedb5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;d69bf581-a18f-4563-8ee9-72fae6d37115&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5fb736c2-5749-4140-8460-70d59ce10d51&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;title&quot;:&quot;#initialization - anchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor \&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.kreskoAssetFixture)({\n    name,\n    symbol\n});\nconsole.debug({\n    symbol: await f.KreskoAsset.symbol(),\n    name: await f.KreskoAsset.name(),\n    anchorSymbol: await f.KreskoAssetAnchor.symbol(),\n    anchorName: await f.KreskoAssetAnchor.name()\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6602b863-1348-47d3-9a41-a4b6b0b24e77&quot;,&quot;parentUUID&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.KreskoAsset.initialize(name, symbol, 18, hre.addr.deployer, hre.Diamond.address)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d76ad914-f3a8-4c37-9572-06ac3b2f1ce0&quot;,&quot;parentUUID&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;11d8882f-9113-47a7-a9d3-70cf8033fec3&quot;,&quot;parentUUID&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(name);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(symbol);\n(0, _chai.expect)(await f.KreskoAsset.kresko()).to.equal(hre.Diamond.address);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.default.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.default.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await f.KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await f.KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;df75d66d-db6a-42c9-ac93-7d05be6e4703&quot;,&quot;parentUUID&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(f.KreskoAsset.reinitializeERC20(newName, newSymbol, 2)).to.not.be.reverted;\n(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(newName);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3b8a71d9-14f2-4801-8811-f3288283e67c&quot;,&quot;parentUUID&quot;:&quot;2da4c0a1-d70c-41e9-b751-23455c65fdd8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d76ad914-f3a8-4c37-9572-06ac3b2f1ce0&quot;,&quot;df75d66d-db6a-42c9-ac93-7d05be6e4703&quot;,&quot;3b8a71d9-14f2-4801-8811-f3288283e67c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;11d8882f-9113-47a7-a9d3-70cf8033fec3&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:51,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;26a30d7a-1c58-4971-9324-290a9f57f3fc&quot;,&quot;title&quot;:&quot;#initialization - wrapped&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.KreskoAssetAnchor.initialize(f.KreskoAsset.address, name, symbol, hre.addr.deployer)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a349b274-d5d6-413b-896f-a16fde630392&quot;,&quot;parentUUID&quot;:&quot;26a30d7a-1c58-4971-9324-290a9f57f3fc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:33,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await f.KreskoAssetAnchor.name()).to.equal(anchorName);\n(0, _chai.expect)(await f.KreskoAssetAnchor.symbol()).to.equal(anchorSymbol);\n(0, _chai.expect)(await f.KreskoAssetAnchor.asset()).to.equal(f.KreskoAsset.address);\n(0, _chai.expect)(await f.KreskoAssetAnchor.hasRole(_roles.default.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAssetAnchor.hasRole(_roles.default.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAssetAnchor.totalSupply()).to.equal(0);\n(0, _chai.expect)(await f.KreskoAssetAnchor.totalAssets()).to.equal(await f.KreskoAsset.totalSupply());\nconst rebaseInfo = await f.KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5778223c-8be8-4ba6-a26c-555bc0c2dfa5&quot;,&quot;parentUUID&quot;:&quot;26a30d7a-1c58-4971-9324-290a9f57f3fc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;614e2105-ee7b-435b-a212-798caae28004&quot;,&quot;parentUUID&quot;:&quot;26a30d7a-1c58-4971-9324-290a9f57f3fc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(f.KreskoAssetAnchor.reinitializeERC20(newName, newSymbol, 2)).to.not.be.reverted;\n(0, _chai.expect)(await f.KreskoAssetAnchor.name()).to.equal(newName);\n(0, _chai.expect)(await f.KreskoAssetAnchor.symbol()).to.equal(newSymbol);\nawait f.KreskoAssetAnchor.reinitializeERC20(name, symbol, 3);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0270a27-08c3-41bf-9946-8e059cbe9f88&quot;,&quot;parentUUID&quot;:&quot;26a30d7a-1c58-4971-9324-290a9f57f3fc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a349b274-d5d6-413b-896f-a16fde630392&quot;,&quot;5778223c-8be8-4ba6-a26c-555bc0c2dfa5&quot;,&quot;f0270a27-08c3-41bf-9946-8e059cbe9f88&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;614e2105-ee7b-435b-a212-798caae28004&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:65,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;6f78c633-232f-4882-9bcb-255adfee1aef&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset } = await (0, _fixtures.kreskoAssetFixture)({\n    name: \&quot;Ether\&quot;,\n    symbol: \&quot;krETH\&quot;\n}));\nthis.owner = hre.users.deployer;\nthis.mintAmount = 125;\nawait KreskoAsset.grantRole(_roles.default.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3cee465f-476e-4b7f-bfd2-ae2db6eb402e&quot;,&quot;parentUUID&quot;:&quot;6f78c633-232f-4882-9bcb-255adfee1aef&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;613b5fca-3a42-4144-917f-43777b72714d&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to mint to their own address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the owner to mint to their own address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:21,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(this.owner.address, this.mintAmount);\n// Check total supply and owner&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e5e58be8-fc4f-459f-b101-0ec50ada89fc&quot;,&quot;parentUUID&quot;:&quot;613b5fca-3a42-4144-917f-43777b72714d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the asset owner to mint to another address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the asset owner to mint to another address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;945dbf5a-d745-4c87-bb89-2e2688d370b0&quot;,&quot;parentUUID&quot;:&quot;613b5fca-3a42-4144-917f-43777b72714d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-owner addresses to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow non-owner addresses to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:42,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).mint(this.owner.address, this.mintAmount)).to.be.reverted;\n// Check total supply and all account balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6c17eeba-a525-4de7-8bff-67ffb65ed37d&quot;,&quot;parentUUID&quot;:&quot;613b5fca-3a42-4144-917f-43777b72714d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow admin to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow admin to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.renounceRole(_roles.default.OPERATOR, this.owner.address);\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.admin).mint(this.owner.address, this.mintAmount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;051a5467-0373-4baa-ad4a-d9bbca9f5303&quot;,&quot;parentUUID&quot;:&quot;613b5fca-3a42-4144-917f-43777b72714d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e5e58be8-fc4f-459f-b101-0ec50ada89fc&quot;,&quot;945dbf5a-d745-4c87-bb89-2e2688d370b0&quot;,&quot;6c17eeba-a525-4de7-8bff-67ffb65ed37d&quot;,&quot;051a5467-0373-4baa-ad4a-d9bbca9f5303&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:116,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.mintAmount = 250;\nawait KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5b3ea1e4-3ac4-4dd4-986d-5c03098e4665&quot;,&quot;parentUUID&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d76e86e5-fa6d-43b9-bb0a-48fce5539ef4&quot;,&quot;parentUUID&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(this.owner).approve(hre.users.userOne.address, this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that token allowances are unchanged\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0f9b923e-9ebe-4070-a2af-e4d5f68a0a4c&quot;,&quot;parentUUID&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the operator to burn more tokens than user holds&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow the operator to burn more tokens than user holds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalance = await KreskoAsset.balanceOf(hre.users.userOne.address);\nconst overUserBalance = Number(userBalance) + 1;\nawait (0, _chai.expect)(KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, overUserBalance)).to.be.reverted;\n// Check total supply and user&#x27;s balances are unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f85c17da-55a7-4530-9576-ff60627f45b6&quot;,&quot;parentUUID&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-operator addresses to burn tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow non-operator addresses to burn tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:33,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAsset.connect(hre.users.userTwo).burn(hre.users.userOne.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${hre.users.userTwo.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and user&#x27;s balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;73b1a9f2-5637-4e75-b447-71a478610587&quot;,&quot;parentUUID&quot;:&quot;bfe8f71e-8f7b-4d86-9a84-286ca56e0280&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d76e86e5-fa6d-43b9-bb0a-48fce5539ef4&quot;,&quot;0f9b923e-9ebe-4070-a2af-e4d5f68a0a4c&quot;,&quot;f85c17da-55a7-4530-9576-ff60627f45b6&quot;,&quot;73b1a9f2-5637-4e75-b447-71a478610587&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:101,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f9f4cd16-0234-46ca-95e4-e7ff692991ef&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset } = await (0, _fixtures.kreskoAssetFixture)({\n    name: \&quot;Ether\&quot;,\n    symbol: \&quot;krETH\&quot;\n}));\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_roles.Role.OPERATOR, hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dc87f207-7d21-4ff0-81ba-4f6043bbbda1&quot;,&quot;parentUUID&quot;:&quot;f9f4cd16-0234-46ca-95e4-e7ff692991ef&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;7cb9fd49-3891-411d-a261-e4b3dadc1069&quot;,&quot;title&quot;:&quot;#rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can set a positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(\&quot;1.525\&quot;);\nconst positive = true;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;34f7c1a9-83ab-42a8-9103-be196914b1b3&quot;,&quot;parentUUID&quot;:&quot;7cb9fd49-3891-411d-a261-e4b3dadc1069&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can set a negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(\&quot;1.525\&quot;);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2bf3113-6c34-414a-aa5e-fdf2f8d67491&quot;,&quot;parentUUID&quot;:&quot;7cb9fd49-3891-411d-a261-e4b3dadc1069&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can be disabled by setting the denominator to 1 ether&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can be disabled by setting the denominator to 1 ether&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(1);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99498cbf-6ebe-4932-9ace-63b23b001259&quot;,&quot;parentUUID&quot;:&quot;7cb9fd49-3891-411d-a261-e4b3dadc1069&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;title&quot;:&quot;#balance + supply&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has no effect when not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply has no effect when not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7007d2f8-d5f7-43c3-8f8b-897e6adfc3b3&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;23fe0fca-c47c-481c-9f0f-4235cb6dd030&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f88b7b18-2f40-463b-9b70-81557dde7a7d&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase  @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase  @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;52981aad-813c-45c1-9f88-69604ada8141&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aa503eb0-1f64-40ec-a543-c1554ce0e7ed&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;61ef5b89-d155-4e03-9baf-7737aaeed3df&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;82c617c1-263e-497c-add7-8150eb31a424&quot;,&quot;parentUUID&quot;:&quot;db886a91-5add-4535-8b68-f31938342acf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7007d2f8-d5f7-43c3-8f8b-897e6adfc3b3&quot;,&quot;23fe0fca-c47c-481c-9f0f-4235cb6dd030&quot;,&quot;f88b7b18-2f40-463b-9b70-81557dde7a7d&quot;,&quot;52981aad-813c-45c1-9f88-69604ada8141&quot;,&quot;aa503eb0-1f64-40ec-a543-c1554ce0e7ed&quot;,&quot;61ef5b89-d155-4e03-9baf-7737aaeed3df&quot;,&quot;82c617c1-263e-497c-add7-8150eb31a424&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:112,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;title&quot;:&quot;#transfer&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has default transfer behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e2ae695-145c-4b2c-bb90-021f85518c36&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transfer behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3ddc6d1-18ee-4e2b-9f66-bc17dfac11d4&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3502c38b-09e5-4ef0-8088-858dfaeea25b&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 100;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;23bdd3f4-1a73-4f50-a2e0-eafee59c9afe&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e41b71d5-2ad3-4e42-881c-d4b2d2db32cf&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:42,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 100;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;28b81e96-efc7-4485-9d71-364a286b8920&quot;,&quot;parentUUID&quot;:&quot;4cf43d2d-0af8-488c-9822-2f81fc64a477&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6e2ae695-145c-4b2c-bb90-021f85518c36&quot;,&quot;a3ddc6d1-18ee-4e2b-9f66-bc17dfac11d4&quot;,&quot;3502c38b-09e5-4ef0-8088-858dfaeea25b&quot;,&quot;23bdd3f4-1a73-4f50-a2e0-eafee59c9afe&quot;,&quot;e41b71d5-2ad3-4e42-881c-d4b2d2db32cf&quot;,&quot;28b81e96-efc7-4485-9d71-364a286b8920&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:217,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;34f7c1a9-83ab-42a8-9103-be196914b1b3&quot;,&quot;c2bf3113-6c34-414a-aa5e-fdf2f8d67491&quot;,&quot;99498cbf-6ebe-4932-9ace-63b23b001259&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:42,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b21c3abd-7979-45a6-ae9e-cd2dc51158fe&quot;,&quot;title&quot;:&quot;KreskoAssetAnchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset, KreskoAssetAnchor } = await (0, _fixtures.kreskoAssetFixture)({\n    name: \&quot;Ether\&quot;,\n    symbol: \&quot;krETH\&quot;\n}));\n// Grant minting rights for test deployer\nawait Promise.all([\n    KreskoAsset.grantRole(_roles.default.OPERATOR, hre.addr.deployer),\n    KreskoAssetAnchor.grantRole(_roles.default.OPERATOR, hre.addr.deployer),\n    KreskoAsset.approve(KreskoAssetAnchor.address, hre.ethers.constants.MaxUint256)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8bde766f-9022-4809-98a9-138f12484236&quot;,&quot;parentUUID&quot;:&quot;b21c3abd-7979-45a6-ae9e-cd2dc51158fe&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;title&quot;:&quot;#minting and burning&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;tracks the supply of underlying&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning tracks the supply of underlying&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_mocks.defaultMintAmount.add(_mocks.defaultMintAmount));\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71e26a73-d396-495f-a8af-8eb6b5514140&quot;,&quot;parentUUID&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning mints 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;55d8fde6-2398-481d-aabd-e6f892e38bba&quot;,&quot;parentUUID&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning deposits 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cc960d45-7f0f-402b-b3cd-22d2e21e6fc8&quot;,&quot;parentUUID&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;redeems 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning redeems 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a863fef8-4964-46e8-b942-2748073b3af8&quot;,&quot;parentUUID&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;withdraws 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning withdraws 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2d691946-3cdb-4dea-bf47-76d7ca566543&quot;,&quot;parentUUID&quot;:&quot;03a08b26-7083-4b63-8e02-e74360a3258a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;55cdf92a-f759-4939-8059-e5650006b37c&quot;,&quot;title&quot;:&quot;#rebases&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;title&quot;:&quot;#conversions&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51b702f1-7b03-4df7-ba37-141c3395c17f&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f326cac0-1176-4042-a118-7c219d8ab669&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;10848b4e-f992-414c-8030-48f297569eb0&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b7e6c12e-5474-474e-ae4e-0b4cbfea5d65&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc08764d-7314-4726-8015-b5798147620f&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;17b6e320-5dbf-4d6d-81b6-597be258345f&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ee3ead66-b556-4238-b1c8-fc461b0ec720&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;000c7ff1-c433-4d4f-8740-624ea83f08d9&quot;,&quot;parentUUID&quot;:&quot;685966ff-583b-4da4-8622-9e13986febd0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;51b702f1-7b03-4df7-ba37-141c3395c17f&quot;,&quot;f326cac0-1176-4042-a118-7c219d8ab669&quot;,&quot;10848b4e-f992-414c-8030-48f297569eb0&quot;,&quot;b7e6c12e-5474-474e-ae4e-0b4cbfea5d65&quot;,&quot;bc08764d-7314-4726-8015-b5798147620f&quot;,&quot;17b6e320-5dbf-4d6d-81b6-597be258345f&quot;,&quot;ee3ead66-b556-4238-b1c8-fc461b0ec720&quot;,&quot;000c7ff1-c433-4d4f-8740-624ea83f08d9&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;71e26a73-d396-495f-a8af-8eb6b5514140&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;55d8fde6-2398-481d-aabd-e6f892e38bba&quot;,&quot;cc960d45-7f0f-402b-b3cd-22d2e21e6fc8&quot;,&quot;a863fef8-4964-46e8-b942-2748073b3af8&quot;,&quot;2d691946-3cdb-4dea-bf47-76d7ca566543&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:26,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d01b0c8b-2603-463b-ab6a-202062def8d6&quot;,&quot;title&quot;:&quot;Test KreskoAsset with Rebase and sync&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d5dc4c6d-1570-4de9-963d-8ee5a8f319d8&quot;,&quot;parentUUID&quot;:&quot;d01b0c8b-2603-463b-ab6a-202062def8d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;899db3ec-0200-4f61-811b-f99426c5fedc&quot;,&quot;parentUUID&quot;:&quot;d01b0c8b-2603-463b-ab6a-202062def8d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;d5dc4c6d-1570-4de9-963d-8ee5a8f319d8&quot;,&quot;899db3ec-0200-4f61-811b-f99426c5fedc&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f3d34722-522c-4b62-84b7-3c942b6286eb&quot;,&quot;title&quot;:&quot;Minter - Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration \&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fb5e9c22-aa4d-49df-9acd-588110a84a76&quot;,&quot;parentUUID&quot;:&quot;f3d34722-522c-4b62-84b7-3c942b6286eb&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;title&quot;:&quot;#configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can modify all parameters&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can modify all parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:404,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = (0, _mocks.testMinterParams)(hre.users.treasury.address);\nawait (0, _chai.expect)(hre.Diamond.updateMinCollateralRatio(update.minCollateralRatio)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateLiquidationThreshold(update.liquidationThreshold)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationRatio(update.MLR)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(0.05e4)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateSequencerGracePeriodTime(1000)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateExtOracleDecimals(2)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateMinDebtValue(20e8)).to.not.be.reverted;\nconst { minCollateralRatio, maxLiquidationRatio, liquidationThreshold } = await hre.Diamond.getMinterParameters();\n(0, _chai.expect)(await hre.Diamond.getMinDebtValue()).to.equal(20e8);\n(0, _chai.expect)(await hre.Diamond.getExtOracleDecimals()).to.equal(2);\n(0, _chai.expect)(await hre.Diamond.getOracleDeviationPct()).to.equal(0.05e4);\n(0, _chai.expect)(update.minCollateralRatio).to.equal(minCollateralRatio);\n(0, _chai.expect)(update.MLR).to.equal(maxLiquidationRatio);\n(0, _chai.expect)(update.liquidationThreshold).to.equal(liquidationThreshold);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3bf0124-5951-47e9-9d25-1b1e872e9aac&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:466,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract } = await (0, _collaterals.addMockExtAsset)(_mocks.testCollateralConfig);\n(0, _chai.expect)(await hre.Diamond.getCollateralExists(contract.address)).to.equal(true);\nconst priceOfOne = await hre.Diamond.getValue(contract.address, (0, _values.toBig)(1));\n(0, _chai.expect)(Number(priceOfOne)).to.equal((0, _values.toBig)(_mocks.testCollateralConfig.price, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae54d673-bbd7-4d03-b285-4e7ee6b440b1&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:738,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract, assetInfo } = await (0, _krassets.addMockKreskoAsset)();\nconst values = await assetInfo();\nconst kreskoPriceAnswer = (0, _values.fromBig)(await hre.Diamond.getValue(contract.address, (0, _values.toBig)(1)), 8);\nconst config = _mocks.testKrAssetConfig.krAssetConfig;\n(0, _chai.expect)(values.isKrAsset).to.equal(true);\n(0, _chai.expect)(values.kFactor).to.equal(config.kFactor);\n(0, _chai.expect)(kreskoPriceAnswer).to.equal(_mocks.testKrAssetConfig.price);\n(0, _chai.expect)(values.supplyLimit).to.equal(config.supplyLimit);\n(0, _chai.expect)(values.closeFee).to.equal(config.closeFee);\n(0, _chai.expect)(values.openFee).to.equal(config.openFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bb5f095d-4b4e-4a6d-945e-25b8299978a9&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update external oracle decimals&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update external oracle decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:72,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const decimals = 8;\nawait hre.Diamond.updateExtOracleDecimals(decimals);\n(0, _chai.expect)(await hre.Diamond.getExtOracleDecimals()).to.equal(decimals);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bda010d0-7f76-4f03-9103-62305a1bb1b5&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update max liquidation ratio&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update max liquidation ratio&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentMLM = await hre.Diamond.getMaxLiquidationRatio();\nconst newMLR = 1.42e4;\n(0, _chai.expect)(currentMLM).to.not.eq(newMLR);\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationRatio(newMLR)).to.not.be.reverted;\n(0, _chai.expect)(await hre.Diamond.getMaxLiquidationRatio()).to.eq(newMLR);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b426194-f89d-4692-b8aa-160d4664bce7&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update oracle deviation pct&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update oracle deviation pct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentODPCT = await hre.Diamond.getOracleDeviationPct();\nconst newODPCT = 0.03e4;\n(0, _chai.expect)(currentODPCT.eq(newODPCT)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(newODPCT)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getOracleDeviationPct()).eq(newODPCT)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a83baa99-dd0b-4cc3-b62f-2cc287a47f8f&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update kFactor of a kresko asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update kFactor of a kresko asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getAsset(f.KrAsset.address)).kFactor;\nconst newRatio = 1.2e4;\n(0, _chai.expect)(oldRatio === newRatio).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateKFactor(f.KrAsset.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getAsset(f.KrAsset.address)).kFactor === newRatio).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2bf34690-0c62-4ada-af22-e577e0a144c2&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update cFactor of a collateral asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update cFactor of a collateral asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getAsset(f.Collateral.address)).factor;\nconst newRatio = 0.9e4;\n(0, _chai.expect)(oldRatio === newRatio).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateCollateralFactor(f.Collateral.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getAsset(f.Collateral.address)).factor === newRatio).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a6ce927-2373-4073-ae5a-7cf2e6941e38&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update values of a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update values of a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:462,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oracleAnswer = (0, _values.fromBig)((await f.KrAsset.priceFeed.latestRoundData())[1], 8);\nconst priceOfOne = (0, _values.fromBig)(await hre.Diamond.getValue(f.KrAsset.address, (0, _values.toBig)(1)), 8);\n(0, _chai.expect)(oracleAnswer).to.equal(priceOfOne);\n(0, _chai.expect)(oracleAnswer).to.equal(_mocks.testKrAssetConfig.price);\nconst update = {\n    kFactor: 1.2e4,\n    supplyLimit: (0, _values.toBig)(12000),\n    closeFee: 0.03e4,\n    openFee: 0.03e4,\n    anchor: f.KrAsset.anchor.address\n};\nconst FakeFeed = await (0, _oracle.getFakeOracle)(20);\nconst newConfig = await (0, _general.getAssetConfig)(f.KrAsset.contract, {\n    ..._mocks.testKrAssetConfig,\n    feed: FakeFeed.address,\n    price: 20,\n    krAssetConfig: update\n});\nawait hre.Diamond.updateFeeds(newConfig.assetStruct.underlyingId, newConfig.feedConfig);\nawait (0, _general.wrapContractWithSigner)(hre.Diamond, hre.users.deployer).updateAsset(f.KrAsset.address, newConfig.assetStruct);\nconst newValues = await hre.Diamond.getAsset(f.KrAsset.address);\nconst updatedOracleAnswer = (0, _values.fromBig)((await FakeFeed.latestRoundData())[1], 8);\nconst newPriceOfOne = (0, _values.fromBig)(await hre.Diamond.getValue(f.KrAsset.address, (0, _values.toBig)(1)), 8);\n(0, _chai.expect)(newValues.isKrAsset).to.equal(true);\n(0, _chai.expect)(newValues.isCollateral).to.equal(false);\n(0, _chai.expect)(newValues.kFactor).to.equal(update.kFactor);\n(0, _chai.expect)(newValues.supplyLimit).to.equal(update.supplyLimit);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(newPriceOfOne);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(20);\nconst update2 = {\n    ...await hre.Diamond.getAsset(f.KrAsset.address),\n    kFactor: 1.75e4,\n    supplyLimit: (0, _values.toBig)(12000),\n    closeFee: 0.052e4,\n    openFee: 0.052e4,\n    isSCDPKrAsset: true,\n    swapInFeeSCDP: 0.052e4,\n    liqIncentiveSCDP: 1.1e4,\n    anchor: f.KrAsset.anchor.address\n};\nawait hre.Diamond.updateAsset(f.KrAsset.address, update2);\nconst newValues2 = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(newValues2.isKrAsset).to.equal(true);\n(0, _chai.expect)(newValues2.isSCDPCollateral).to.equal(true);\n(0, _chai.expect)(newValues2.isCollateral).to.equal(false);\n(0, _chai.expect)(newValues2.isSCDPDepositAsset).to.equal(false);\n(0, _chai.expect)(newValues2.isSCDPCoverAsset).to.equal(false);\n(0, _chai.expect)(newValues2.kFactor).to.equal(update2.kFactor);\n(0, _chai.expect)(newValues2.openFee).to.equal(update2.closeFee);\n(0, _chai.expect)(newValues2.closeFee).to.equal(update2.openFee);\n(0, _chai.expect)(newValues2.swapInFeeSCDP).to.equal(update2.swapInFeeSCDP);\n(0, _chai.expect)(newValues2.supplyLimit).to.equal(update2.supplyLimit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d746ae7d-62ed-48c5-9574-59fc42ac66f7&quot;,&quot;parentUUID&quot;:&quot;ab4d57c8-2974-4142-8ac7-b89e199c4061&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f3bf0124-5951-47e9-9d25-1b1e872e9aac&quot;,&quot;ae54d673-bbd7-4d03-b285-4e7ee6b440b1&quot;,&quot;bb5f095d-4b4e-4a6d-945e-25b8299978a9&quot;,&quot;bda010d0-7f76-4f03-9103-62305a1bb1b5&quot;,&quot;9b426194-f89d-4692-b8aa-160d4664bce7&quot;,&quot;a83baa99-dd0b-4cc3-b62f-2cc287a47f8f&quot;,&quot;2bf34690-0c62-4ada-af22-e577e0a144c2&quot;,&quot;4a6ce927-2373-4073-ae5a-7cf2e6941e38&quot;,&quot;d746ae7d-62ed-48c5-9574-59fc42ac66f7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2576,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;00457628-aad1-4bdb-a4d1-59f81acc6e40&quot;,&quot;title&quot;:&quot;Minter - Deposit Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw \&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.depositWithdrawFixture)();\n[[user, User], [depositor, Depositor], [withdrawer, Withdrawer]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2090ed6a-db25-47d6-b807-b1ad5931da98&quot;,&quot;parentUUID&quot;:&quot;00457628-aad1-4bdb-a4d1-59f81acc6e40&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;20d797c1-1616-4c2d-8db5-c11452e0af10&quot;,&quot;title&quot;:&quot;#collateral&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;title&quot;:&quot;#deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:124,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _values.toBig)(100);\nawait f.KrAssetCollateral.setBalance(user, collateralAmount, _hardhat.default.Diamond.address);\nconst depositAmount = collateralAmount.div(2);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Rebase the asset according to params\nconst denominator = 4;\nconst positive = true;\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebasedDepositAmount = depositAmount.mul(denominator);\nconst withdrawAmount = rebasedDepositAmount.sub(9e11.toString());\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountCollateralAssets(user.address)).to.include(f.KrAssetCollateral.address);\nawait (0, _chai.expect)(User.withdrawCollateral(user.address, f.KrAssetCollateral.address, withdrawAmount, 0)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;COLLATERAL_VALUE_LOW\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0a594c1a-ee97-4d68-ba84-fe05aba0011f&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _values.toBig)(100);\nawait f.KrAssetCollateral.setBalance(user, collateralAmount, _hardhat.default.Diamond.address);\nawait (0, _chai.expect)(User.depositCollateral(user.address, f.KrAssetCollateral.address, 9e11.toString())).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;COLLATERAL_VALUE_LOW\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb072aab-061f-4f94-8c5a-d3ff56437617&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit whitelisted collateral&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit whitelisted collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Account has deposit entry\nconst depositedCollateralAssetsAfter = await _optimizations.default.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Account&#x27;s collateral deposit balances have increased\n(0, _chai.expect)(await _optimizations.default.getAccountCollateralAmount(depositor.address, f.Collateral.address)).to.equal(f.initialDeposits);\n// Kresko&#x27;s balance has increased\n(0, _chai.expect)(await f.Collateral.balanceOf(_hardhat.default.Diamond.address)).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Account&#x27;s balance has decreased\n(0, _chai.expect)((0, _values.fromBig)(await f.Collateral.balanceOf(depositor.address))).to.equal((0, _values.fromBig)(f.initialBalance) - (0, _values.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af649d65-7f46-4985-ba58-dde837394285&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:161,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the user&#x27;s deposited collateral assets should be empty.\nconst depositedCollateralAssetsBefore = await _hardhat.default.Diamond.getAccountCollateralAssets(user.address);\n(0, _chai.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral, from depositor -&gt; user.\nawait (0, _chai.expect)(Depositor.depositCollateral(user.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets has been pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits);\n// Confirm the amount as been transferred from the user into Kresko.sol\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Confirm the depositor&#x27;s wallet balance has been adjusted accordingly\nconst depositorBalanceAfter = await f.Collateral.balanceOf(depositor.address);\n(0, _chai.expect)((0, _values.fromBig)(depositorBalanceAfter)).to.equal((0, _values.fromBig)(f.initialBalance) - (0, _values.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f85ad79-af11-4240-be95-2de12a5b6cee&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit more collateral to an existing deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit more collateral to an existing deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:154,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit first batch of collateral\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit second batch of collateral\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets hasn&#x27;t been double-pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(depositor.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.add(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3ac4df9-6ebd-4396-b856-7a64dcb2a874&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to have deposited multiple collateral assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to have deposited multiple collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load user account with a different type of collateral\nawait f.Collateral2.setBalance(depositor, f.initialBalance, _hardhat.default.Diamond.address);\n// Deposit batch of first collateral type\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit batch of second collateral type\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral2.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets contains both collateral assets\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address,\n    f.Collateral2.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d9c76695-085e-488c-9af4-dee342c4b01e&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralDeposited event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should emit CollateralDeposited event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:51,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits);\nconst event = await (0, _events.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralDeposited\&quot;);\n(0, _chai.expect)(event.account).to.equal(depositor.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ead758d1-58ba-4a91-8235-7929c5894cef&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing collateral that has not been whitelisted&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing collateral that has not been whitelisted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, \&quot;0x0000000000000000000000000000000000000001\&quot;, f.initialDeposits)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;COLLATERAL_DOES_NOT_EXIST\&quot;).withArgs(\&quot;0x0000000000000000000000000000000000000001\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;467e7a7e-960e-47e1-a7ea-1f764b8af260&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, 0)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;ZERO_DEPOSIT\&quot;).withArgs(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b7e01ec-b327-4b97-b0c1-a2c080411a02&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if collateral is not depositable&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if collateral is not depositable&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { deployer, devTwo, extOne } = await _hardhat.default.ethers.getNamedSigners();\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    true,\n    0\n], [\n    deployer,\n    devTwo,\n    extOne\n]);\nconst isDepositPaused = await _hardhat.default.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isDepositPaused).to.equal(true);\nawait (0, _chai.expect)((0, _redstone.wrapKresko)(_hardhat.default.Diamond, depositor).depositCollateral(depositor.address, f.Collateral.contract.address, 0)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;ACTION_PAUSED_FOR_ASSET\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1308ba85-6a42-4591-9b11-719e96bfb792&quot;,&quot;parentUUID&quot;:&quot;fe053635-aec8-4736-8010-876e9a6b45c3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0a594c1a-ee97-4d68-ba84-fe05aba0011f&quot;,&quot;eb072aab-061f-4f94-8c5a-d3ff56437617&quot;,&quot;af649d65-7f46-4985-ba58-dde837394285&quot;,&quot;6f85ad79-af11-4240-be95-2de12a5b6cee&quot;,&quot;f3ac4df9-6ebd-4396-b856-7a64dcb2a874&quot;,&quot;d9c76695-085e-488c-9af4-dee342c4b01e&quot;,&quot;ead758d1-58ba-4a91-8235-7929c5894cef&quot;,&quot;467e7a7e-960e-47e1-a7ea-1f764b8af260&quot;,&quot;4b7e01ec-b327-4b97-b0c1-a2c080411a02&quot;,&quot;1308ba85-6a42-4591-9b11-719e96bfb792&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:911,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;bb1e60eb-1cd6-4147-9e84-e649a5b49b7f&quot;,&quot;title&quot;:&quot;#withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their entire deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw their entire deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:158,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0);\n// Ensure that the collateral asset is removed from the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssetsPostWithdraw = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssetsPostWithdraw).to.deep.equal([]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(0);\n// Ensure the amount transferred is correct\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(0);\nconst userOneBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5d3fa021-3290-4e6e-976a-a9c540d323a1&quot;,&quot;parentUUID&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to withdraw a portion of their deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw a portion of their deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:155,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst userOneBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits.sub(amountDeposited));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1efa9ecc-d31d-44a5-8a94-3c1b6187cf83&quot;,&quot;parentUUID&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow trusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:195,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait _hardhat.default.Diamond.grantRole(_roles.default.MANAGER, user.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_roles.default.MANAGER, user.address)).to.equal(true);\nconst collateralBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\nawait (0, _chai.expect)(User.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0)).to.not.be.reverted;\nconst collateralAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n// Ensure that collateral was withdrawn\n(0, _chai.expect)(collateralAfter).to.equal(collateralBefore.sub(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3cb5bf9c-8f95-44bc-9d26-24f856fb5334&quot;,&quot;parentUUID&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralWithdrawn event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should emit CollateralWithdrawn event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:46,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0);\nconst event = await (0, _events.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralWithdrawn\&quot;);\n(0, _chai.expect)(event.account).to.equal(withdrawer.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fecbe5f5-2dc2-4a87-9875-a8cf090d815f&quot;,&quot;parentUUID&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(User.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialBalance, 0)).to.be.revertedWith(`AccessControl: account ${user.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5ea5414f-f536-4f2f-83ad-84475896cf46&quot;,&quot;parentUUID&quot;:&quot;9ac27854-3d98-4eb4-aeca-6deffcf8a785&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is &gt; 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 \&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:192,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne mints some kr assets\nthis.mintAmount = (0, _values.toBig)(100);\nawait Withdrawer.mintKreskoAsset(withdrawer.address, f.KrAsset.address, this.mintAmount);\n// Mint amount differs from deposited amount due to open fee\nconst amountDeposited = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\nthis.initialUserOneDeposited = amountDeposited;\nthis.mcr = await _optimizations.default.getMinCollateralRatio();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1828f332-5c26-4b39-ace3-a5becf687abb&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:517,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = (0, _values.toBig)(10);\n// Ensure that the withdrawal would not put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst [accMinCollateralValue, accCollateralValue, withdrawnCollateralValue] = await Promise.all([\n    _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr),\n    _hardhat.default.Diamond.getAccountTotalCollateralValue(withdrawer.address),\n    _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount)\n]);\n(0, _chai.expect)(accCollateralValue.sub(withdrawnCollateralValue).gte(accMinCollateralValue)).to.be.true;\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0);\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _optimizations.default.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Check the balances of the contract and user\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst withdrawerBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(withdrawerBalance).to.equal(withdrawAmount);\n// Ensure the account&#x27;s minimum collateral value is &lt;= the account collateral value\nconst accountMinCollateralValueAfter = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr);\nconst accountCollateralValueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(withdrawer.address);\n(0, _chai.expect)(accountMinCollateralValueAfter.lte(accountCollateralValueAfter)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99fb45a1-f7f4-4d99-b92d-a61c0c8eedc8&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:122,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomUser = _hardhat.default.users.userFour;\nawait f.Collateral.setBalance(randomUser, _ethers.BigNumber.from(0));\nawait f.Collateral.setBalance(randomUser, (0, _values.toBig)(1000));\nawait f.Collateral.contract.connect(randomUser).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(1000),\n    user: randomUser\n});\nawait (0, _collaterals.withdrawCollateral)({\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(1010),\n    user: randomUser\n});\n(0, _chai.expect)(await f.Collateral.balanceOf(randomUser.address)).to.equal((0, _values.toBig)(1000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b80db3d-814a-4fba-897c-80363d07bd5b&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if withdrawing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if withdrawing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 0;\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, 0, withdrawAmount)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;ZERO_AMOUNT\&quot;).withArgs(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6a715d53-c85e-45fb-aa2d-d5f6c6556a35&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the withdrawal violates the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the withdrawal violates the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:310,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne has a debt position, so attempting to withdraw the entire collateral deposit should be impossible\nconst withdrawAmount = f.initialBalance;\n// Ensure that the withdrawal would in fact put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr);\nconst accountCollateralValue = await _hardhat.default.Diamond.getAccountTotalCollateralValue(withdrawer.address);\nconst withdrawnCollateralValue = await _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount);\n(0, _chai.expect)(accountCollateralValue.sub(withdrawnCollateralValue).lt(accountMinCollateralValue)).to.be.true;\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;COLLATERAL_VALUE_LOW\&quot;).withArgs(0, 150000000000);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6bbd2654-1832-4062-bd38-a51276035770&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:37,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 1)).to.be.revertedWithCustomError((0, _errors.CError)(_hardhat.default), \&quot;INVALID_ASSET_INDEX\&quot;).withArgs(f.Collateral.address, 1, 0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8cfad9b-379b-4c02-8357-818621065834&quot;,&quot;parentUUID&quot;:&quot;07d40bea-b95c-4441-b16d-76cafab85866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;99fb45a1-f7f4-4d99-b92d-a61c0c8eedc8&quot;,&quot;7b80db3d-814a-4fba-897c-80363d07bd5b&quot;,&quot;6a715d53-c85e-45fb-aa2d-d5f6c6556a35&quot;,&quot;6bbd2654-1832-4062-bd38-a51276035770&quot;,&quot;c8cfad9b-379b-4c02-8357-818621065834&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1026,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;5d3fa021-3290-4e6e-976a-a9c540d323a1&quot;,&quot;1efa9ecc-d31d-44a5-8a94-3c1b6187cf83&quot;,&quot;3cb5bf9c-8f95-44bc-9d26-24f856fb5334&quot;,&quot;fecbe5f5-2dc2-4a87-9875-a8cf090d815f&quot;,&quot;5ea5414f-f536-4f2f-83ad-84475896cf46&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:609,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;58379467-d59c-46d1-80e3-fa7eea1995f2&quot;,&quot;title&quot;:&quot;#deposit - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase \&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:207,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setBalance(user, f.initialBalance, _hardhat.default.Diamond.address);\n// Add krAsset as a collateral with anchor and cFactor of 1\n// Allowance for Kresko\nawait f.KrAssetCollateral.contract.setVariable(\&quot;_allowances\&quot;, {\n    [user.address]: {\n        [_hardhat.default.Diamond.address]: _hardhat.default.ethers.constants.MaxInt256\n    }\n});\n// Deposit some collateral\nawait User.depositCollateral(user.address, f.Collateral.address, f.initialDeposits);\n// Mint some krAssets\nawait User.mintKreskoAsset(user.address, f.KrAssetCollateral.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await User.getAccountDebtAmount(user.address, f.KrAssetCollateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff142319-999b-4589-b7f7-cad9ecca4050&quot;,&quot;parentUUID&quot;:&quot;58379467-d59c-46d1-80e3-fa7eea1995f2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;title&quot;:&quot;deposit amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:134,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst expectedDepositsAfter = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(expectedDepositsAfter);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c905c0f2-0431-4d7f-8c0e-a3e22338b1dc&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:135,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmountAfterRebase = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmountAfterRebase);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a969e0b2-0b4b-4d65-83fb-d79446b02d63&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b58380d1-e664-46bb-942f-daec2707c517&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:122,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2a33e35-1499-4ff6-a243-f1c392a182f8&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:162,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(halfDepositAfterRebase);\n// Deposit second time\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d5ae4683-0b47-49bb-93c8-867d23525914&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:161,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfterRebase = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfterRebase).to.equal(halfDepositAfterRebase);\n// Deposit second time\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b14dd608-78de-4077-aa5c-3a6cf028bce7&quot;,&quot;parentUUID&quot;:&quot;6d6e08e9-1f74-41c6-85d8-b21659357f5f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c905c0f2-0431-4d7f-8c0e-a3e22338b1dc&quot;,&quot;a969e0b2-0b4b-4d65-83fb-d79446b02d63&quot;,&quot;b58380d1-e664-46bb-942f-daec2707c517&quot;,&quot;b2a33e35-1499-4ff6-a243-f1c392a182f8&quot;,&quot;d5ae4683-0b47-49bb-93c8-867d23525914&quot;,&quot;b14dd608-78de-4077-aa5c-3a6cf028bce7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:835,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;title&quot;:&quot;deposit usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:254,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nf.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;288d1568-29ae-4a93-ac32-c85e25817a0b&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:256,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nf.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b3a477d-2df5-446f-8c34-7b0c11e7a44e&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:266,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Get expected value before rebase and deposit\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, depositAmount);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5efc258c-cd7f-4b20-8586-68b06efbf5ff&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:185,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Get expected value before rebase and deposit\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, depositAmount);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5808e38d-bbb7-4e3e-8470-f10e30d6a276&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:369,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst valueAfterRebase = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst expectedValueAfterSecondDeposit = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, fullDepositAmount);\n// Deposit more\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c27d8a56-8df2-42e0-8911-92e87d12a67b&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:432,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst valueAfterRebase = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst expectedValueAfterSecondDeposit = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, fullDepositAmount);\n// Deposit more\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5adf044b-6115-4a01-b2b9-2894eb25ea89&quot;,&quot;parentUUID&quot;:&quot;491e7501-6f0f-41fe-9813-ae5b13d52dfd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;288d1568-29ae-4a93-ac32-c85e25817a0b&quot;,&quot;1b3a477d-2df5-446f-8c34-7b0c11e7a44e&quot;,&quot;5efc258c-cd7f-4b20-8586-68b06efbf5ff&quot;,&quot;5808e38d-bbb7-4e3e-8470-f10e30d6a276&quot;,&quot;c27d8a56-8df2-42e0-8911-92e87d12a67b&quot;,&quot;5adf044b-6115-4a01-b2b9-2894eb25ea89&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1762,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;22aaf5e7-e515-4924-8e08-bd74891ba509&quot;,&quot;title&quot;:&quot;#withdraw - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase \&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:147,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Withdrawer.mintKreskoAsset(withdrawer.address, f.KrAssetCollateral.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await _optimizations.default.getAccountDebtAmount(withdrawer.address, f.KrAssetCollateral);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5f934b87-4dae-454d-b050-fbb579b5ebb1&quot;,&quot;parentUUID&quot;:&quot;22aaf5e7-e515-4924-8e08-bd74891ba509&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;title&quot;:&quot;withdraw amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:235,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit collateral before rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9d34c015-9e6c-4076-92e2-0fb3f9e90316&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:275,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit collateral before rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;92e96ed3-a6c6-4005-bc63-87dd1c9c78e0&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after an positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:229,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d53dfe4d-1a07-4e60-880b-71252c9eb0ca&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:230,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;87813032-8063-4f9b-9988-33dbef7384b3&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:277,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit before the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;55cb9921-9cd0-4635-8c8a-4e92627a6b02&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:281,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit before the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d961097d-0f45-44e6-b32a-c704eaaa6dd4&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:185,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _values.toBig)(10);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst nrcBalanceBefore = await f.Collateral.contract.balanceOf(withdrawer.address);\nconst expectedNrcBalanceAfter = nrcBalanceBefore.add(withdrawAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.Collateral.address));\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(withdrawer.address)).to.equal(expectedNrcBalanceAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3459ef86-6c4b-48b3-87da-ed06a1921356&quot;,&quot;parentUUID&quot;:&quot;7a27e998-7205-44f2-9775-c061c5d49e7e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9d34c015-9e6c-4076-92e2-0fb3f9e90316&quot;,&quot;92e96ed3-a6c6-4005-bc63-87dd1c9c78e0&quot;,&quot;d53dfe4d-1a07-4e60-880b-71252c9eb0ca&quot;,&quot;87813032-8063-4f9b-9988-33dbef7384b3&quot;,&quot;55cb9921-9cd0-4635-8c8a-4e92627a6b02&quot;,&quot;d961097d-0f45-44e6-b32a-c704eaaa6dd4&quot;,&quot;3459ef86-6c4b-48b3-87da-ed06a1921356&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1712,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;title&quot;:&quot;withdraw usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:221,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b711a866-5a00-4efc-88d9-1e0152a5ee58&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:222,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;da20a9ca-9a59-4c6d-9573-3afb44541c5c&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:225,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2b61d15a-05b2-4ca6-b4ff-e311d4051fe1&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:298,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;be85eff4-f461-4aa5-83da-6b085263fb7d&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:433,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Deposit more\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e803e172-fac2-4661-9c1c-2255292948e1&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:421,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(denominator).div(2);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Deposit more\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f957bf25-8dcd-49d4-9172-e9e8396f2a91&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:599,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _values.toBig)(10);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst accountValueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(withdrawer.address);\nconst [nrcValueBefore] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.Collateral.address);\nconst withdrawValue = await _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount);\nconst expectedNrcValueAfter = nrcValueBefore.sub(withdrawValue);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalAccountValue = await _hardhat.default.Diamond.getAccountTotalCollateralValue(withdrawer.address);\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(finalValue).to.equal(expectedNrcValueAfter);\n(0, _chai.expect)(finalAccountValue).to.equal(accountValueBefore.sub(withdrawValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b53da0ba-0946-46c6-b263-e265b651d6ee&quot;,&quot;parentUUID&quot;:&quot;71a6f958-1347-4774-9745-9cd4a293e293&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b711a866-5a00-4efc-88d9-1e0152a5ee58&quot;,&quot;da20a9ca-9a59-4c6d-9573-3afb44541c5c&quot;,&quot;2b61d15a-05b2-4ca6-b4ff-e311d4051fe1&quot;,&quot;be85eff4-f461-4aa5-83da-6b085263fb7d&quot;,&quot;e803e172-fac2-4661-9c1c-2255292948e1&quot;,&quot;f957bf25-8dcd-49d4-9172-e9e8396f2a91&quot;,&quot;b53da0ba-0946-46c6-b263-e265b651d6ee&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2419,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0a28a52a-607a-41e6-9bbd-8c7bef914994&quot;,&quot;title&quot;:&quot;Minter - Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations \&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:77,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.liquidationsFixture)();\n[[user1, User], [user2], [user3], [user4], [user5], [liquidator, Liquidator], [liquidatorTwo, LiquidatorTwo]] = f.users;\nawait f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6785f0e3-8015-462b-9039-b8ab29357808&quot;,&quot;parentUUID&quot;:&quot;0a28a52a-607a-41e6-9bbd-8c7bef914994&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e0227a90-0afa-42d3-90db-eab4b7530702&quot;,&quot;title&quot;:&quot;#isAccountLiquidatable&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify accounts below their liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #isAccountLiquidatable should identify accounts below their liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:463,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [cr, minCollateralUSD, initialCanLiquidate] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(user1.address),\n    hre.Diamond.getAccountMinCollateralAtRatio(user1.address, hre.Diamond.getLiquidationThreshold()),\n    hre.Diamond.getAccountLiquidatable(user1.address)\n]);\n(0, _chai.expect)(cr).to.be.equal(1.5e4);\n(0, _chai.expect)(f.initialDeposits.mul(10).gt(minCollateralUSD));\n(0, _chai.expect)(initialCanLiquidate).to.equal(false);\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e75836eb-62f0-4af5-aef6-21f5bddcdeea&quot;,&quot;parentUUID&quot;:&quot;e0227a90-0afa-42d3-90db-eab4b7530702&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e75836eb-62f0-4af5-aef6-21f5bddcdeea&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:463,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;312ec06d-f5c3-408a-ae2d-474cd2978ab8&quot;,&quot;title&quot;:&quot;#maxLiquidatableValue&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1167,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const MLVBeforeC1 = await hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral.address);\nconst MLVBeforeC2 = await hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral2.address);\n(0, _chai.expect)(MLVBeforeC1.repayValue).to.be.closeTo(MLVBeforeC2.repayValue, USD_DELTA);\nawait hre.Diamond.updateCollateralFactor(f.Collateral.address, 0.25e4);\nawait (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: f.initialDeposits.div(2),\n    asset: f.Collateral2\n});\nconst expectedCR = 1.125e4;\nconst [crAfter, isLiquidatableAfter, MLVAfterC1, MLVAfterC2] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(user1.address),\n    hre.Diamond.getAccountLiquidatable(user1.address),\n    hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral.address),\n    hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral2.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.true;\n(0, _chai.expect)(crAfter).to.be.closeTo(expectedCR, 1);\n(0, _chai.expect)(MLVAfterC1.repayValue).to.gt(MLVBeforeC1.repayValue);\n(0, _chai.expect)(MLVAfterC2.repayValue).to.gt(MLVBeforeC2.repayValue);\n(0, _chai.expect)(MLVAfterC2.repayValue.gt(MLVAfterC1.repayValue)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0bd6e85-a7bf-48c2-8b60-581b28920351&quot;,&quot;parentUUID&quot;:&quot;312ec06d-f5c3-408a-ae2d-474cd2978ab8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV with multiple cdps&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV with multiple cdps&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:593,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: (0, _values.toBig)(0.1, 8),\n    asset: f.Collateral8Dec\n});\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.true;\nconst [maxLiq, maxLiq8Dec] = await Promise.all([\n    hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral.address),\n    hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(maxLiq.repayValue).gt(0);\n(0, _chai.expect)(maxLiq8Dec.repayValue).gt(0);\n(0, _chai.expect)(maxLiq.repayValue).gt(maxLiq8Dec.repayValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3a8516a-777c-48c6-a70c-a1b6599268fa&quot;,&quot;parentUUID&quot;:&quot;312ec06d-f5c3-408a-ae2d-474cd2978ab8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b0bd6e85-a7bf-48c2-8b60-581b28920351&quot;,&quot;f3a8516a-777c-48c6-a70c-a1b6599268fa&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1760,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a284e29b-8ac8-4ef0-a743-3dfa11031763&quot;,&quot;title&quot;:&quot;#liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;title&quot;:&quot;#liquidate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate \&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(7.5);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;205022c1-af02-472e-bf0b-037af14dfb42&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow unhealthy accounts to be liquidated&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow unhealthy accounts to be liquidated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:316,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Fetch pre-liquidation state for users and contracts\nconst beforeUserOneCollateralAmount = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral);\nconst userOneDebtBefore = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst liquidatorBalanceBefore = await f.Collateral.balanceOf(liquidator.address);\nconst liquidatorBalanceKrBefore = await f.KrAsset.balanceOf(liquidator.address);\nconst kreskoBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\n// Liquidate userOne\nconst maxRepayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _values.toBig)(11, 8));\nawait Liquidator.liquidate(user1.address, f.KrAsset.address, maxRepayAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address));\n// Confirm that the liquidated user&#x27;s debt amount has decreased by the repaid amount\nconst userOneDebtAfterLiquidation = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebtAfterLiquidation.eq(userOneDebtBefore.sub(maxRepayAmount)));\n// Confirm that some of the liquidated user&#x27;s collateral has been seized\nconst userOneCollateralAfterLiquidation = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral);\n(0, _chai.expect)(userOneCollateralAfterLiquidation.lt(beforeUserOneCollateralAmount));\n// Confirm that userTwo&#x27;s kresko asset balance has decreased by the repaid amount\n(0, _chai.expect)(await f.KrAsset.balanceOf(liquidator.address)).eq(liquidatorBalanceKrBefore.sub(maxRepayAmount));\n// Confirm that userTwo has received some collateral from the contract\n(0, _chai.expect)(await f.Collateral.balanceOf(liquidator.address)).gt(liquidatorBalanceBefore);\n// Confirm that Kresko contract&#x27;s collateral balance has decreased.\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).lt(kreskoBalanceBefore);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2c5bb30a-ddd0-4bd3-9d62-1947c4d1885c&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with a single CDP&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with a single CDP&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:804,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updateCollateralFactor(f.Collateral.address, 0.99e4);\nawait hre.Diamond.updateKFactor(f.KrAsset.address, 1.02e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral.address);\nawait Liquidator.liquidate(user1.address, f.KrAsset.address, maxLiq.repayAmount.add((0, _values.toBig)(1222, 27)), f.Collateral.address, maxLiq.repayAssetIndex, maxLiq.seizeAssetIndex);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(user1.address)).to.be.eq(await _optimizations.default.getMaxLiquidationRatio());\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c97cfcfc-ece9-4aba-a01a-807ec37546c7&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with multiple CDPs&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with multiple CDPs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1141,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: (0, _values.toBig)(10, 8),\n    asset: f.Collateral8Dec\n});\nf.Collateral.setPrice(5.5);\nf.Collateral8Dec.setPrice(6);\nawait hre.Diamond.updateCollateralFactor(f.Collateral.address, 0.9754e4);\nawait hre.Diamond.updateKFactor(f.KrAsset.address, 1.05e4);\nawait (0, _liquidations.liquidate)(user1, f.KrAsset, f.Collateral8Dec);\nconst [crAfter, isLiquidatableAfter] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(user1.address),\n    hre.Diamond.getAccountLiquidatable(user1.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.false;\n(0, _chai.expect)(crAfter).to.be.eq(await _optimizations.default.getMaxLiquidationRatio());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d009a69a-5d3d-4f48-825f-ff381fc29b3f&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit LiquidationOccurred event&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should emit LiquidationOccurred event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:321,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _values.toBig)(11));\nconst tx = await Liquidator.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address));\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;LiquidationOccurred\&quot;);\n(0, _chai.expect)(event.args.account).to.equal(user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(liquidator.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.repayAmount).to.equal(repayAmount);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;caf1630b-3bcf-4f6e-a944-a918db0655fd&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations of healthy accounts&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations of healthy accounts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:119,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(10);\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _chai.expect)(Liquidator.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;CANNOT_LIQUIDATE\&quot;).withArgs(16500000000, 15400000000);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3e0a2840-2afe-4954-8f31-3bb0401a5dce&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations if repayment amount is 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations if repayment amount is 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 0;\nawait (0, _chai.expect)(LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;ZERO_REPAY\&quot;).withArgs(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;561cc68a-3e90-4f9b-8168-00430e80926d&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should clamp liquidations if repay value/amount exceeds debt&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should clamp liquidations if repay value/amount exceeds debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:749,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Get user&#x27;s debt for this kresko asset\nconst krAssetDebtUserOne = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n// Ensure we are repaying more than debt\nconst repayAmount = krAssetDebtUserOne.add((0, _values.toBig)(10));\nawait f.KrAsset.setBalance(liquidatorTwo, repayAmount, hre.Diamond.address);\n// Liquidation should fail\nconst liquidatorBalanceBefore = await f.KrAsset.balanceOf(liquidatorTwo.address);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(user1.address, f.KrAsset.address, f.Collateral.address);\n(0, _chai.expect)(maxLiq.repayAmount).to.be.lt(repayAmount);\nconst tx = await LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0);\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;LiquidationOccurred\&quot;);\nconst liquidatorBalanceAfter = await f.KrAsset.balanceOf(liquidatorTwo.address);\n(0, _chai.expect)(event.args.account).to.equal(user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(liquidatorTwo.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.args.repayAmount).to.not.equal(repayAmount);\n(0, _chai.expect)(event.args.repayAmount).to.equal(maxLiq.repayAmount);\n(0, _chai.expect)(event.args.collateralSent).to.be.equal(maxLiq.seizeAmount);\n(0, _chai.expect)(liquidatorBalanceAfter.add(repayAmount)).to.not.equal(liquidatorBalanceBefore);\n(0, _chai.expect)(liquidatorBalanceAfter.add(maxLiq.repayAmount)).to.equal(liquidatorBalanceBefore);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(user1.address)).to.be.eq(await hre.Diamond.getMaxLiquidationRatio());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58fd5de0-786f-43fc-94ed-27070d493cf7&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:492,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(f.Collateral.config.args.price);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;\nconst minCollateralUSD = await hre.Diamond.getAccountMinCollateralAtRatio(user1.address, _optimizations.default.getMinCollateralRatio());\nconst liquidationThresholdUSD = await hre.Diamond.getAccountMinCollateralAtRatio(user1.address, _optimizations.default.getLiquidationThreshold());\nf.Collateral.setPrice(9.9);\nconst accountCollateralValue = await hre.Diamond.getAccountTotalCollateralValue(user1.address);\n(0, _chai.expect)(accountCollateralValue.lt(minCollateralUSD)).to.be.true;\n(0, _chai.expect)(accountCollateralValue.gt(liquidationThresholdUSD)).to.be.true;\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;920c3b37-6077-4edc-8e7d-e1ba65fce9b4&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations without liquidator token approval for Kresko Assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow liquidations without liquidator token approval for Kresko Assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:327,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check that liquidator&#x27;s token approval to Kresko.sol contract is 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(liquidatorTwo.address, hre.Diamond.address)).to.equal(0);\nconst repayAmount = (0, _values.toBig)(0.5);\nawait f.KrAsset.setBalance(liquidatorTwo, repayAmount);\nawait LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0);\n// Confirm that liquidator&#x27;s token approval is still 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(user2.address, hre.Diamond.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;be50338c-03a9-46da-b80f-694d376bae89&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:347,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = (0, _values.toBig)(0.5);\nawait f.KrAsset.setBalance(liquidatorTwo, repayAmount);\nawait f.KrAsset.contract.setVariable(\&quot;_allowances\&quot;, {\n    [liquidatorTwo.address]: {\n        [hre.Diamond.address]: repayAmount\n    }\n});\nawait (0, _chai.expect)(LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0)).not.to.be.reverted;\n// Confirm that liquidator&#x27;s token approval is unchanged\n(0, _chai.expect)(await f.KrAsset.contract.allowance(liquidatorTwo.address, hre.Diamond.address)).to.equal(repayAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79b5c9bf-645e-448a-98b7-159d22563b4e&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow borrowers to liquidate themselves&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow borrowers to liquidate themselves&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 5;\nawait (0, _chai.expect)(User.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;SELF_LIQUIDATION\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;de03e9fd-f94c-4c5f-835c-fd6230ad4dd7&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should error on seize underflow&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should error on seize underflow&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2527633-1043-4c38-8084-f72dcb115154&quot;,&quot;parentUUID&quot;:&quot;e8f8bbf6-584e-4b20-8543-29bc4ef09841&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2c5bb30a-ddd0-4bd3-9d62-1947c4d1885c&quot;,&quot;c97cfcfc-ece9-4aba-a01a-807ec37546c7&quot;,&quot;d009a69a-5d3d-4f48-825f-ff381fc29b3f&quot;,&quot;caf1630b-3bcf-4f6e-a944-a918db0655fd&quot;,&quot;3e0a2840-2afe-4954-8f31-3bb0401a5dce&quot;,&quot;561cc68a-3e90-4f9b-8168-00430e80926d&quot;,&quot;58fd5de0-786f-43fc-94ed-27070d493cf7&quot;,&quot;920c3b37-6077-4edc-8e7d-e1ba65fce9b4&quot;,&quot;be50338c-03a9-46da-b80f-694d376bae89&quot;,&quot;79b5c9bf-645e-448a-98b7-159d22563b4e&quot;,&quot;de03e9fd-f94c-4c5f-835c-fd6230ad4dd7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;f2527633-1043-4c38-8084-f72dcb115154&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:4686,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;title&quot;:&quot;#liquidate - rebasing events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events \&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.resetRebasing();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ad4ded1d-960b-40a8-9db8-d62e051f51b2&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should setup correct&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should setup correct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:416,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [mcr, cr, cr2, liquidatable] = await Promise.all([\n    _optimizations.default.getMinCollateralRatio(),\n    hre.Diamond.getAccountCollateralRatio(user3.address),\n    hre.Diamond.getAccountCollateralRatio(user4.address),\n    hre.Diamond.getAccountLiquidatable(user3.address)\n]);\n(0, _chai.expect)(cr).to.closeTo(mcr, 1);\n(0, _chai.expect)(cr2).to.closeTo(mcr, 1);\n(0, _chai.expect)(liquidatable).to.be.false;&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;AssertionError: expected 15008 to be close to 15000 +/- 1&quot;,&quot;estack&quot;:&quot;AssertionError: expected 15008 to be close to 15000 +/- 1\n    at Context.&lt;anonymous&gt; (src/test/minter/03-liquidation.ts:370:23)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at runNextTicks (node:internal/process/task_queues:64:3)\n    at listOnTimeout (node:internal/timers:538:9)\n    at processTimers (node:internal/timers:512:7)&quot;},&quot;uuid&quot;:&quot;ac879d02-d535-417b-97d6-2e1b5445d9ca&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(Liquidator.liquidate(user4.address, f.KrAsset.address, 100, f.Collateral.address, _optimizations.default.getAccountMintIndex(user4.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user4.address, f.Collateral.address))).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;CANNOT_LIQUIDATE\&quot;).withArgs(1000000000000, 933333332400);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5b737734-44c5-4453-b446-57ebeef95f85&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:116,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(Liquidator.liquidate(user4.address, f.KrAsset.address, 100, f.Collateral.address, _optimizations.default.getAccountMintIndex(user4.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user4.address, f.Collateral.address))).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;CANNOT_LIQUIDATE\&quot;).withArgs(1000000000000, 933333332400);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7d4d59a3-d43f-46a9-bc58-f3f7ce6112e1&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1374,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.false;\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.true;\nawait (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true);\nawait (0, _chai.expect)((0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;476a90df-36ff-44b9-ac65-b5c375c427be&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1155,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.false;\nf.KrAsset.setPrice(rebasePrice + 1);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.true;\nawait (0, _chai.expect)((0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;24f31080-6008-47c4-ad04-1d04ed71a144&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate krAsset collaterals up to min amount&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate krAsset collaterals up to min amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:794,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.KrAssetCollateral.setPrice(100);\nawait hre.Diamond.updateCollateralFactor(f.KrAssetCollateral.address, 0.99e4);\nawait hre.Diamond.updateKFactor(f.KrAssetCollateral.address, 1e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(user3.address, f.KrAssetCollateral.address, f.KrAssetCollateral.address);\nawait f.KrAssetCollateral.setBalance(hre.users.liquidator, maxLiq.repayAmount, hre.Diamond.address);\nawait Liquidator.liquidate(user3.address, f.KrAssetCollateral.address, maxLiq.repayAmount.sub(1e9), f.KrAssetCollateral.address, maxLiq.repayAssetIndex, maxLiq.seizeAssetIndex);\nconst depositsAfter = await hre.Diamond.getAccountCollateralAmount(user3.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsAfter).to.equal(1e12.toString());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;286f97f3-80a4-4afa-92c7-55a157955e43&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate to 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate to 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:720,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.KrAssetCollateral.setPrice(100);\nawait hre.Diamond.updateCollateralFactor(f.KrAssetCollateral.address, 1e4);\nawait hre.Diamond.updateKFactor(f.KrAssetCollateral.address, 1e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(user3.address, f.KrAssetCollateral.address, f.KrAssetCollateral.address);\nconst liquidationAmount = maxLiq.repayAmount.add((0, _values.toBig)(20, 27));\nawait f.KrAssetCollateral.setBalance(hre.users.liquidator, liquidationAmount, hre.Diamond.address);\nawait Liquidator.liquidate(user3.address, f.KrAssetCollateral.address, liquidationAmount, f.KrAssetCollateral.address, maxLiq.repayAssetIndex, maxLiq.seizeAssetIndex);\nconst depositsAfter = await hre.Diamond.getAccountCollateralAmount(user3.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;29ef9dcd-a9e0-4490-b469-d02ca61094d6&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2322,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nf.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user4.address)){\n    const values = await (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(user4.address), 8);\nresults.userOneHFAfter = (await hre.Diamond.getAccountCollateralRatio(user4.address)).toNumber();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = newPrice / denominator;\n// Rebase\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user5.address)){\n    const values = await (0, _liquidations.liquidate)(user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(user5.address), 8);\nresults.userTwoHFAfter = (await hre.Diamond.getAccountCollateralRatio(user5.address)).toNumber();\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid * denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f07b17b-1c91-455b-8d46-3546daf3b694&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of assets after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of assets after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2292,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nf.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user4.address)){\n    const values = await (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(user4.address), 8);\nresults.userOneHFAfter = (await hre.Diamond.getAccountCollateralRatio(user4.address)).toNumber();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = newPrice * denominator;\n// Rebase\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user5.address)){\n    const values = await (0, _liquidations.liquidate)(user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(user5.address), 8);\nresults.userTwoHFAfter = (await hre.Diamond.getAccountCollateralRatio(user5.address)).toNumber();\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid / denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f476897-6b2a-4924-ad9f-15e16048508a&quot;,&quot;parentUUID&quot;:&quot;2aacb139-b9d6-46dc-93db-6a5808617953&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5b737734-44c5-4453-b446-57ebeef95f85&quot;,&quot;7d4d59a3-d43f-46a9-bc58-f3f7ce6112e1&quot;,&quot;476a90df-36ff-44b9-ac65-b5c375c427be&quot;,&quot;24f31080-6008-47c4-ad04-1d04ed71a144&quot;,&quot;286f97f3-80a4-4afa-92c7-55a157955e43&quot;,&quot;29ef9dcd-a9e0-4490-b469-d02ca61094d6&quot;,&quot;9f07b17b-1c91-455b-8d46-3546daf3b694&quot;,&quot;1f476897-6b2a-4924-ad9f-15e16048508a&quot;],&quot;failures&quot;:[&quot;ac879d02-d535-417b-97d6-2e1b5445d9ca&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:9300,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;29615adc-7051-4507-986a-38c87effbccb&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.mintRepayFixture)();\n[[user1, User1], [user2, User2]] = f.users;\nawait f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bd264b91-8013-4b14-87bd-c9d5a62c5b84&quot;,&quot;parentUUID&quot;:&quot;29615adc-7051-4507-986a-38c87effbccb&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f579df3b-618f-4bee-a4c4-ebcfa68c87a1&quot;,&quot;title&quot;:&quot;#mint+burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:272,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(f.initialMintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, _values.toBig)(10);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMinted = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMinted).to.equal(mintAmount);\n// Confirm the user&#x27;s Kresko asset balance has increased\nconst userBalance = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalance).to.equal(mintAmount);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter.eq(kreskoAssetTotalSupplyBefore.add(mintAmount)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2817f784-3705-4a51-a5d8-98d18a851277&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow successive, valid mints of the same Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow successive, valid mints of the same Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:462,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Mint Kresko asset\nconst firstMintAmount = (0, _values.toBig)(50);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _values.toBig)(50);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, secondMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets is unchanged\nconst mintedKreskoAssetsFinal = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedFinal = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedFinal).to.closeTo(firstMintAmount.add(secondMintAmount), INTEREST_RATE_DELTA);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceFinal).to.closeTo(amountMintedFinal, INTEREST_RATE_DELTA);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyFinal = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyFinal).to.closeTo(kreskoAssetTotalSupplyAfter.add(secondMintAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;839e2398-9173-4087-b158-21584c991ff2&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint multiple different Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint multiple different Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:349,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, _values.toBig)(10);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _values.toBig)(20);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset2.address, secondMintAmount);\n// Confirm that the second address has been pushed to the array of the user&#x27;s minted Kresko assets\nconst mintedKreskoAssetsFinal = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address,\n    f.KrAsset2.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedAssetTwo = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset2);\n(0, _chai.expect)(amountMintedAssetTwo).to.equal(secondMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset2.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceFinal).to.equal(amountMintedAssetTwo);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst secondKreskoAssetTotalSupply = await f.KrAsset2.contract.totalSupply();\n(0, _chai.expect)(secondKreskoAssetTotalSupply).to.equal(secondMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a6b4e075-2a85-4f0a-8ca3-7dbf08d8cadd&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:252,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the mint amount&#x27;s USD value is equal to the contract&#x27;s current minimum debt value\nconst mintAmount = (0, _values.toBig)(1); // 1 * $10 = $10\nconst mintAmountUSDValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nconst currMinimumDebtValue = await hre.Diamond.getMinDebtValue();\n(0, _chai.expect)(mintAmountUSDValue).to.equal(currMinimumDebtValue);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Confirm that the mint was successful and user&#x27;s balances have increased\nconst finalKreskoAssetDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(finalKreskoAssetDebt).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ee0ea598-155e-4b3f-9506-a4dea856a14d&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:194,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_roles.default.MANAGER, user2.address);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// userThree (trusted contract) mints Kresko asset for userOne\nconst mintAmount = (0, _values.toBig)(1);\nawait User2.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Check that debt exists now for userOne\nconst userTwoBalanceAfter = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userTwoBalanceAfter).to.equal(mintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;09568f5f-0890-463e-9584-2fc9bbd5be9b&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetMinted event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should emit KreskoAssetMinted event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:162,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await User1.mintKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount);\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, \&quot;KreskoAssetMinted\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7a90aa6b-f685-4a21-a125-1a0ed1114506&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:51,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(User1.mintKreskoAsset(user2.address, f.KrAsset.address, (0, _values.toBig)(1))).to.be.revertedWith(`AccessControl: account ${user1.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4b95114-ef48-4a07-8a65-99cad5a9edcc&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:214,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currMinimumDebtValue = await _optimizations.default.getMinDebtValue();\nconst mintAmount = currMinimumDebtValue.wadDiv(_mocks.TEN_USD.bn(8)).sub(1e9);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;MINT_VALUE_LOW\&quot;).withArgs(f.KrAsset.address, 10e8 - 1, currMinimumDebtValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;acabc90e-cb7d-49cc-8fe2-03375c323962&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt to mint a non-deployed, non-whitelisted Kresko asset\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, \&quot;0x0000000000000000000000000000000000000002\&quot;, (0, _values.toBig)(1))).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;KRASSET_DOES_NOT_EXIST\&quot;).withArgs(\&quot;0x0000000000000000000000000000000000000002\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;27f1e100-a17a-4903-9e12-7f155df758b0&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:336,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmountDeposited = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral.address);\nconst MCR = await hre.Diamond.getMinCollateralRatio();\nconst mcrAmount = collateralAmountDeposited.percentMul(MCR);\nconst mintAmount = mcrAmount.add(1);\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nconst userState = await hre.Diamond.getAccountState(user1.address);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;COLLATERAL_VALUE_LOW\&quot;).withArgs(userState.totalCollateralValue, mintValue.percentMul(MCR));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4cbbf7a5-54e4-4bdb-b7ac-315892d482d0&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:237,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// User deposits another 10,000 collateral tokens, enabling mints of up to 20,000/1.5 = ~13,333 kresko asset tokens\nawait f.Collateral.setBalance(user1, (0, _values.toBig)(100000000));\nawait (0, _chai.expect)(User1.depositCollateral(user1.address, f.Collateral.address, (0, _values.toBig)(10000))).not.to.be.reverted;\nconst assetSupplyLimit = (0, _values.toBig)(1);\nconst mintAmount = (0, _values.toBig)(2);\nawait f.KrAsset.update({\n    ...f.KrAsset.config.args,\n    krAssetConfig: {\n        ...f.KrAsset.config.args.krAssetConfig,\n        supplyLimit: assetSupplyLimit\n    }\n});\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;MAX_SUPPLY_EXCEEDED\&quot;).withArgs(f.KrAsset.address, (await f.KrAsset.contract.totalSupply()).add(mintAmount), assetSupplyLimit);\nawait f.KrAsset.update({\n    ...f.KrAsset.config.args,\n    krAssetConfig: {\n        ...f.KrAsset.config.args.krAssetConfig,\n        supplyLimit: assetSupplyLimit\n    }\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d821afbe-e225-4625-81a3-b0dc91d9a1f3&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bfb3e049-6eba-499a-b49f-70b72251475c&quot;,&quot;parentUUID&quot;:&quot;2737c84d-6f91-4d8d-bbf3-30e069c49cf6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2817f784-3705-4a51-a5d8-98d18a851277&quot;,&quot;839e2398-9173-4087-b158-21584c991ff2&quot;,&quot;a6b4e075-2a85-4f0a-8ca3-7dbf08d8cadd&quot;,&quot;ee0ea598-155e-4b3f-9506-a4dea856a14d&quot;,&quot;09568f5f-0890-463e-9584-2fc9bbd5be9b&quot;,&quot;7a90aa6b-f685-4a21-a125-1a0ed1114506&quot;,&quot;a4b95114-ef48-4a07-8a65-99cad5a9edcc&quot;,&quot;acabc90e-cb7d-49cc-8fe2-03375c323962&quot;,&quot;27f1e100-a17a-4903-9e12-7f155df758b0&quot;,&quot;4cbbf7a5-54e4-4bdb-b7ac-315892d482d0&quot;,&quot;d821afbe-e225-4625-81a3-b0dc91d9a1f3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;bfb3e049-6eba-499a-b49f-70b72251475c&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:2567,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;bcfcc2f4-82c8-4557-a8f8-29e8ffa1db1d&quot;,&quot;title&quot;:&quot;#mint - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a935d990-a82a-458c-94e7-b2a44f5ee58f&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:238,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;06147352-9b75-4d2e-967d-30cba3bea3ab&quot;,&quot;parentUUID&quot;:&quot;a935d990-a82a-458c-94e7-b2a44f5ee58f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:195,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44ccd652-d950-4796-9455-259cd214da0a&quot;,&quot;parentUUID&quot;:&quot;a935d990-a82a-458c-94e7-b2a44f5ee58f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:197,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79de5778-3038-4574-b4e8-6ab471489db1&quot;,&quot;parentUUID&quot;:&quot;a935d990-a82a-458c-94e7-b2a44f5ee58f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:196,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fdf875d7-2f35-4a7c-bca9-e3bf96cd6a1a&quot;,&quot;parentUUID&quot;:&quot;a935d990-a82a-458c-94e7-b2a44f5ee58f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;06147352-9b75-4d2e-967d-30cba3bea3ab&quot;,&quot;44ccd652-d950-4796-9455-259cd214da0a&quot;,&quot;79de5778-3038-4574-b4e8-6ab471489db1&quot;,&quot;fdf875d7-2f35-4a7c-bca9-e3bf96cd6a1a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:826,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;40de840e-7e1a-4822-b098-f1f2b4a2c5d3&quot;,&quot;title&quot;:&quot;debt values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when mint is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst valueBeforeRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n// Adjust price accordingly\nconst assetPrice = await f.KrAsset.getPrice();\nf.KrAsset.setPrice((0, _values.fromBig)(assetPrice.div(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8608540c-e2a2-46fb-bc11-db59eff52c1d&quot;,&quot;parentUUID&quot;:&quot;40de840e-7e1a-4822-b098-f1f2b4a2c5d3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when mint is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:295,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst valueBeforeRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n// Adjust price accordingly\nconst assetPrice = await f.KrAsset.getPrice();\nf.KrAsset.setPrice((0, _values.fromBig)(assetPrice.mul(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5493c3e5-492d-4696-a72d-6cf89f7de520&quot;,&quot;parentUUID&quot;:&quot;40de840e-7e1a-4822-b098-f1f2b4a2c5d3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:290,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.mul(denominator);\nconst assetPrice = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price accordingly\nf.KrAsset.setPrice((0, _values.fromBig)(assetPrice, 8) / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4d4b6a6c-f34c-477a-98b5-8310b3de08f2&quot;,&quot;parentUUID&quot;:&quot;40de840e-7e1a-4822-b098-f1f2b4a2c5d3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:288,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.div(denominator);\nconst assetPrice = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price accordingly\nf.KrAsset.setPrice((0, _values.fromBig)(assetPrice.mul(denominator), 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;edcb8cb4-3db1-4533-9041-a783d0096086&quot;,&quot;parentUUID&quot;:&quot;40de840e-7e1a-4822-b098-f1f2b4a2c5d3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8608540c-e2a2-46fb-bc11-db59eff52c1d&quot;,&quot;5493c3e5-492d-4696-a72d-6cf89f7de520&quot;,&quot;4d4b6a6c-f34c-477a-98b5-8310b3de08f2&quot;,&quot;edcb8cb4-3db1-4533-9041-a783d0096086&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1172,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;7d8a3ae7-9501-4eae-bdd7-5a1faf02827d&quot;,&quot;title&quot;:&quot;debt values and amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:675,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetPrice = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintAmountAfterRebase = mintAmount.mul(denominator);\nconst assetPriceRebase = assetPrice.div(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nf.KrAsset.setPrice((0, _values.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.equal(debtValueAfterFirstMint);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.equal(valueBeforeRebase);\n// Mint after rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmountAfterRebase);\n// Ensure debt amounts and balances match\nconst balanceAfterSecondMint = await f.KrAsset.contract.balanceOf(user1.address);\n// Ensure balance matches\nconst expectedBalanceAfterSecondMint = balanceAfterFirstRebase.add(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterSecondMint).to.equal(expectedBalanceAfterSecondMint);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterSecondMint, f.KrAsset)).to.closeTo(debtValueAfterFirstMint.mul(2), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(valueBeforeRebase.mul(2), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3c583418-3f26-4354-aaf1-1b52225233b2&quot;,&quot;parentUUID&quot;:&quot;7d8a3ae7-9501-4eae-bdd7-5a1faf02827d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:669,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetPrice = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintAmountAfterRebase = mintAmount.div(denominator);\nconst assetPriceRebase = assetPrice.mul(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nf.KrAsset.setPrice((0, _values.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(debtValueAfterFirstRebase).to.equal(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint, f.KrAsset));\n(0, _chai.expect)(debtValueAfterFirstRebase).to.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, f.KrAsset));\n// Mint after rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmountAfterRebase);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountTotalDebtValue(user1.address);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(await (0, _calculations.toScaledAmount)(valueBeforeRebase.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9a34ea11-794f-41df-9b9c-8297cebe9a9e&quot;,&quot;parentUUID&quot;:&quot;7d8a3ae7-9501-4eae-bdd7-5a1faf02827d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3c583418-3f26-4354-aaf1-1b52225233b2&quot;,&quot;9a34ea11-794f-41df-9b9c-8297cebe9a9e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1344,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:194,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User1.mintKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9592b400-86f7-453a-a9db-3a8d2a5415dc&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to burn some of their Kresko asset balances&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn some of their Kresko asset balances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:155,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _values.toBig)(1);\nconst kreskoAssetIndex = 0;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user no long holds the burned Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userBalance).to.equal(f.initialMintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userDebt).to.closeTo(f.initialMintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d21ec392-c33d-48d0-86f2-3d3fe041056d&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn their full balance of a Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn their full balance of a Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;939a61c2-d89e-4bcd-bcbf-e7e2fd22d14c&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:198,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_roles.default.MANAGER, user2.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _values.toBig)(1);\nconst kreskoAssetIndex = 0;\nconst userOneBalanceBefore = await f.KrAsset.balanceOf(user1.address);\n// User three burns it&#x27;s KreskoAsset to reduce userOnes debt\nawait User2.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// await expect(User2.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.not.be\n//   .reverted;\n// Confirm the userOne had no effect on it&#x27;s kreskoAsset balance\nconst userOneBalance = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userOneBalance).to.equal(userOneBalanceBefore, \&quot;userOneBalance\&quot;);\n// Confirm the userThree no long holds the burned Kresko asset amount\nconst userThreeBalance = await f.KrAsset.balanceOf(user2.address);\n(0, _chai.expect)(userThreeBalance).to.equal(f.initialMintAmount.sub(burnAmount), \&quot;userThreeBalance\&quot;);\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount), \&quot;totalSupplyAfter\&quot;);\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user2.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n], \&quot;mintedKreskoAssetsAfter\&quot;);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebt).to.equal(f.initialMintAmount.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;72c95a22-d37c-4978-8bd3-b073ad6fdb2c&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;361fc74d-9cf7-42bf-b08f-bc46d18435ec&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:193,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalanceBefore = await f.KrAsset.balanceOf(user1.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Calculate actual burn amount\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst minDebtValue = (0, _values.fromBig)(await _optimizations.default.getMinDebtValue(), 8);\nconst oraclePrice = f.KrAsset.config.args.price;\nconst burnAmount = (0, _values.toBig)((0, _values.fromBig)(userOneDebt) - minDebtValue / oraclePrice);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user holds the expected Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(user1.address);\n// expect(fromBig(userBalance)).to.equal(fromBig(userBalanceBefore.sub(burnAmount)));\n(0, _chai.expect)(userBalance).eq(userBalanceBefore.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).eq(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst newUserDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(newUserDebt).to.be.equal(userOneDebt.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;300d9c2a-ac67-4f0d-9181-3c9c0a40f0d3&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetBurned event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should emit KreskoAssetBurned event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:150,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst tx = await User1.burnKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount.div(5), kreskoAssetIndex);\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, \&quot;KreskoAssetBurned\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount.div(5));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4d2883cd-7501-4096-891c-8fda25a61009&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:262,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const secondMintAmount = 1;\nconst burnAmount = f.initialMintAmount.add(secondMintAmount);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, secondMintAmount)).to.not.be.reverted;\nconst kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cfe786a4-9f26-4fc1-9099-41657cf1f5c4&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, 0, kreskoAssetIndex)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;ZERO_BURN\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca506e35-9ec9-4160-95f4-9cac5aebb1e7&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User2.burnKreskoAsset(user1.address, f.KrAsset.address, 100, kreskoAssetIndex)).to.be.revertedWith(`AccessControl: account ${user2.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d26c43a5-e4db-4152-8459-53d7508cc830&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst debt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst burnAmount = debt.add((0, _values.toBig)(1));\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3d6757d9-ce82-4325-bfac-34261d5ed540&quot;,&quot;parentUUID&quot;:&quot;ecc3204a-8924-4cd4-906c-3a2ac942ca48&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;71c9d631-ccfd-42e0-9263-8415bcbd8f52&quot;,&quot;title&quot;:&quot;Protocol open fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol open fee should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:445,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const openFee = 0.01e4;\nawait f.KrAsset.update({\n    ...f.KrAsset.config.args,\n    krAssetConfig: {\n        ...f.KrAsset.config.args.krAssetConfig,\n        openFee,\n        supplyLimit: _values.MaxUint128\n    }\n});\nconst mintAmount = (0, _values.toBig)(1);\nconst mintValue = mintAmount.wadMul(_mocks.TEN_USD.bn(8));\nconst expectedFeeValue = mintValue.percentMul(openFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.wadDiv(_mocks.TEN_USD.bn(8));\n// Get the balances prior to the fee being charged.\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Mint Kresko asset\nconst tx = await User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal(expectedCollateralFeeAmount);\n// Ensure the emitted event is as expected.\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, \&quot;OpenFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedCollateralFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// Now verify that calcExpectedFee function returns accurate fee amount\nconst [, values] = await hre.Diamond.previewFee(user1.address, f.KrAsset.address, mintAmount, _fees.default.OPEN);\n(0, _chai.expect)(values[0]).eq(expectedCollateralFeeAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4aaa8fb-1efe-47d9-8fd4-2e1a43909209&quot;,&quot;parentUUID&quot;:&quot;71c9d631-ccfd-42e0-9263-8415bcbd8f52&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a4aaa8fb-1efe-47d9-8fd4-2e1a43909209&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:445,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;cb634295-0fb9-4c11-bf8d-f8efcb5609b0&quot;,&quot;title&quot;:&quot;Protocol Close Fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:193,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const burnAmount = (0, _values.toBig)(1);\nconst burnValue = burnAmount.wadMul(_mocks.TEN_USD.bn(8));\nconst closeFee = f.KrAsset.config.args.krAssetConfig.closeFee; // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nconst expectedFeeValue = burnValue.percentMul(closeFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.wadDiv(f.Collateral.config.args.price.bn(8));\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nconst tx = await User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal(expectedCollateralFeeAmount);\n// Ensure the emitted event is as expected.\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedCollateralFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6be256f7-8b38-4e3b-a3df-639be736a730&quot;,&quot;parentUUID&quot;:&quot;cb634295-0fb9-4c11-bf8d-f8efcb5609b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:465,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = (0, _values.toBig)(1);\nconst expectedFeeAmount = burnAmount.percentMul(f.KrAsset.config.args.krAssetConfig.closeFee);\nconst expectedFeeValue = expectedFeeAmount.wadMul((0, _values.toBig)(_mocks.TEN_USD, 8));\nconst event = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: burnAmount\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = true;\nf.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount.mul(denominator);\nawait (0, _collaterals.withdrawCollateral)({\n    user: user2,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(wAmount)\n});\nconst eventAfterRebase = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: burnAmountRebase\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6cd07164-6818-46f5-a556-665e46a8f5e8&quot;,&quot;parentUUID&quot;:&quot;cb634295-0fb9-4c11-bf8d-f8efcb5609b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:470,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = (0, _values.toBig)(1);\nconst expectedFeeAmount = burnAmount.percentMul(f.KrAsset.config.args.krAssetConfig.closeFee);\nconst expectedFeeValue = expectedFeeAmount.wadMul((0, _values.toBig)(_mocks.TEN_USD, 8));\nconst event = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: burnAmount\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = false;\nconst priceAfter = (0, _values.fromBig)(await f.KrAsset.getPrice(), 8) * denominator;\nf.KrAsset.setPrice(priceAfter);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount.div(denominator);\nawait (0, _collaterals.withdrawCollateral)({\n    user: user2,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(wAmount)\n});\nconst eventAfterRebase = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: burnAmountRebase\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;280a3fc8-0cb5-44db-85a9-6afc0791019b&quot;,&quot;parentUUID&quot;:&quot;cb634295-0fb9-4c11-bf8d-f8efcb5609b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6be256f7-8b38-4e3b-a3df-639be736a730&quot;,&quot;6cd07164-6818-46f5-a556-665e46a8f5e8&quot;,&quot;280a3fc8-0cb5-44db-85a9-6afc0791019b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1128,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;d21ec392-c33d-48d0-86f2-3d3fe041056d&quot;,&quot;72c95a22-d37c-4978-8bd3-b073ad6fdb2c&quot;,&quot;300d9c2a-ac67-4f0d-9181-3c9c0a40f0d3&quot;,&quot;4d2883cd-7501-4096-891c-8fda25a61009&quot;,&quot;cfe786a4-9f26-4fc1-9099-41657cf1f5c4&quot;,&quot;ca506e35-9ec9-4160-95f4-9cac5aebb1e7&quot;,&quot;d26c43a5-e4db-4152-8459-53d7508cc830&quot;,&quot;3d6757d9-ce82-4325-bfac-34261d5ed540&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;939a61c2-d89e-4bcd-bcbf-e7e2fd22d14c&quot;,&quot;361fc74d-9cf7-42bf-b08f-bc46d18435ec&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:1067,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;17f4a8fc-b171-42ed-8f7b-952e37054f4e&quot;,&quot;title&quot;:&quot;#burn - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase \&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _krassets.mintKrAsset)({\n    asset: f.KrAsset,\n    amount: mintAmount,\n    user: user1\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b13cfd7a-7eba-497e-a7ce-84946363bed6&quot;,&quot;parentUUID&quot;:&quot;17f4a8fc-b171-42ed-8f7b-952e37054f4e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a0534517-3d8f-4d43-a433-d7cad1d71cbb&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:204,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(debtAfter).to.equal(0);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(0);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(f.initialMintAmount); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;37654746-8bb0-4b25-8d32-465b391944b6&quot;,&quot;parentUUID&quot;:&quot;a0534517-3d8f-4d43-a433-d7cad1d71cbb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:237,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).mul(denominator);\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.mul(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.div(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b578da50-fac9-4a18-8e7c-4e841ac8af4b&quot;,&quot;parentUUID&quot;:&quot;a0534517-3d8f-4d43-a433-d7cad1d71cbb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:198,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = 0;\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = (0, _values.fromBig)(await f.KrAsset.contract.balanceOf(user1.address));\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal((0, _values.toBig)(expectedBalanceAfterBurn * denominator).add(f.initialMintAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b43a440-e957-45a8-b321-545ad94e5a08&quot;,&quot;parentUUID&quot;:&quot;a0534517-3d8f-4d43-a433-d7cad1d71cbb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:241,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).div(denominator);\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.div(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.mul(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;23c0e10f-2c16-4d4b-8886-fe6135338edc&quot;,&quot;parentUUID&quot;:&quot;a0534517-3d8f-4d43-a433-d7cad1d71cbb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;37654746-8bb0-4b25-8d32-465b391944b6&quot;,&quot;b578da50-fac9-4a18-8e7c-4e841ac8af4b&quot;,&quot;4b43a440-e957-45a8-b321-545ad94e5a08&quot;,&quot;23c0e10f-2c16-4d4b-8886-fe6135338edc&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:880,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b9ed5800-6b8b-4b73-8d72-597410526e52&quot;,&quot;title&quot;:&quot;debt value and mintedKreskoAssets book-keeping is calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:221,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst fullRepayAmount = mintAmount.mul(denominator);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;61db2f5f-82ac-4b5f-9458-078d885ca28a&quot;,&quot;parentUUID&quot;:&quot;b9ed5800-6b8b-4b73-8d72-597410526e52&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:375,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Should contain minted krAsset\nconst mintedKreskoAssetsBeforeBurn = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBeforeBurn).to.contain(f.KrAsset.address);\n// Burn assets\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e3eafc22-b6ac-440b-a7bf-69c9dcef9439&quot;,&quot;parentUUID&quot;:&quot;b9ed5800-6b8b-4b73-8d72-597410526e52&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:253,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst fullRepayAmount = mintAmount.div(denominator);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e745cae6-d200-46f6-8a63-733595410ee3&quot;,&quot;parentUUID&quot;:&quot;b9ed5800-6b8b-4b73-8d72-597410526e52&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:458,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nf.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cbf834b3-1c9f-4013-9662-ef59f0490f72&quot;,&quot;parentUUID&quot;:&quot;b9ed5800-6b8b-4b73-8d72-597410526e52&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;61db2f5f-82ac-4b5f-9458-078d885ca28a&quot;,&quot;e3eafc22-b6ac-440b-a7bf-69c9dcef9439&quot;,&quot;e745cae6-d200-46f6-8a63-733595410ee3&quot;,&quot;cbf834b3-1c9f-4013-9662-ef59f0490f72&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1307,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;65da53f3-4a69-4684-a34d-82eb380e15fc&quot;,&quot;title&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw \&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n[, , [user]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e4a5d17-cfcb-4aa0-8392-854788798520&quot;,&quot;parentUUID&quot;:&quot;65da53f3-4a69-4684-a34d-82eb380e15fc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;991c8137-1390-4119-8447-c7a8028e7d73&quot;,&quot;title&quot;:&quot;#unchecked-collateral-withdrawal&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;title&quot;:&quot;#unchecked-withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;withdraw correct amount&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw withdraw correct amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawalAmount = 42069;\nawait (0, _chai.expect)(f.Receiver.testWithdrawalAmount(f.Collateral.address, withdrawalAmount)).to.not.be.revertedWith(\&quot;wront amount received\&quot;);\n(0, _chai.expect)(await f.Collateral.balanceOf(f.Receiver.address)).to.equal(withdrawalAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44da27ca-7a17-4dcf-95a3-c6d19383eab5&quot;,&quot;parentUUID&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should send correct values to the callback&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should send correct values to the callback&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:268,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst balKreskoBefore = await f.Collateral.contract.balanceOf(hre.Diamond.address);\nawait Receiver.test(f.Collateral.address, 1);\n(0, _chai.expect)(await Receiver.collateralAsset()).to.equal(f.Collateral.address);\n(0, _chai.expect)(await Receiver.account()).to.equal(user.address);\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(1);\nconst balKreskoAfter = await f.Collateral.contract.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore.sub(balKreskoAfter)).to.equal(1);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a003f38d-a426-446a-991f-113753800b39&quot;,&quot;parentUUID&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw collateral up to MRC without returning it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw collateral up to MRC without returning it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:627,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait Receiver.test(f.Collateral.address, maxWithdrawAmount);\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(user.address)).to.be.eq(1.5e4);\nawait (0, _chai.expect)(Receiver.test(f.Collateral.address, 10e15.toString())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95defc15-9a94-46fc-8bed-af75b93ce9a9&quot;,&quot;parentUUID&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and return it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and return it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:187,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\nconst balKreskoBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nawait Receiver.testRedeposit(f.Collateral.address, deposits);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(deposits);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(deposits);\n(0, _chai.expect)(await f.Collateral.balanceOf(Receiver.address)).to.equal(0);\nconst balKreskoAfter = await f.Collateral.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore).to.equal(balKreskoAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f73dde0e-222d-4e40-b28d-f643eab1c2e2&quot;,&quot;parentUUID&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:132,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\n// set second collateral price to half of the first and balance to twice that\nf.Collateral2.setPrice(10);\nawait f.Collateral2.setBalance(user, f.depositAmount);\nawait f.Collateral2.contract.setVariable(\&quot;_allowances\&quot;, {\n    [user.address]: {\n        [hre.Diamond.address]: f.depositAmount,\n        [Receiver.address]: f.depositAmount\n    }\n});\nawait Receiver.testDepositAlternate(f.Collateral.address, deposits, f.Collateral2.address);\nconst secondCollateralDeposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral2.address);\n(0, _chai.expect)(secondCollateralDeposits.eq(deposits)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;67b1c3b4-d9fb-4382-85de-99047a82672b&quot;,&quot;parentUUID&quot;:&quot;4e97e2e4-6617-4ced-965a-401faa8cf2e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;44da27ca-7a17-4dcf-95a3-c6d19383eab5&quot;,&quot;a003f38d-a426-446a-991f-113753800b39&quot;,&quot;95defc15-9a94-46fc-8bed-af75b93ce9a9&quot;,&quot;f73dde0e-222d-4e40-b28d-f643eab1c2e2&quot;,&quot;67b1c3b4-d9fb-4382-85de-99047a82672b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1339,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;e1fbc92d-b610-41ba-b1ea-aed1860d5345&quot;,&quot;title&quot;:&quot;#unchecked-withdraw-reverts&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert on zero withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert on zero withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 0)).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 0)).to.be.revertedWith(Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;24bc3099-f226-466f-b4f5-e7c4b780d5ff&quot;,&quot;parentUUID&quot;:&quot;e1fbc92d-b610-41ba-b1ea-aed1860d5345&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert with no manager role&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert with no manager role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.revokeRole(_roles.default.MANAGER, f.Receiver.address);\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 10000)).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 10000)).to.be.revertedWith(\n            //     `AccessControl: account ${f.Receiver.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`,\n            // );&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;200e5431-bebd-4fe1-9b34-24191ebdc6ce&quot;,&quot;parentUUID&quot;:&quot;e1fbc92d-b610-41ba-b1ea-aed1860d5345&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:308,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()))).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff6ee59f-7d9d-4f55-875a-8e8bde11ba58&quot;,&quot;parentUUID&quot;:&quot;e1fbc92d-b610-41ba-b1ea-aed1860d5345&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after redeposit&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after redeposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:309,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(Receiver.testInsufficientRedeposit(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()))).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;074e8da5-c772-4026-ac88-e7f1a110f723&quot;,&quot;parentUUID&quot;:&quot;e1fbc92d-b610-41ba-b1ea-aed1860d5345&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;24bc3099-f226-466f-b4f5-e7c4b780d5ff&quot;,&quot;200e5431-bebd-4fe1-9b34-24191ebdc6ce&quot;,&quot;ff6ee59f-7d9d-4f55-875a-8e8bde11ba58&quot;,&quot;074e8da5-c772-4026-ac88-e7f1a110f723&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:776,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;cb64bee9-c63c-47d5-aef8-2503f34310be&quot;,&quot;title&quot;:&quot;Gating&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/06-gating.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/06-gating.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;fullTitle&quot;:&quot;Gating \&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:104,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n// Set Gating phase to 3\nawait hre.Diamond.updatePhase(2);\n// setup collateral for userOne and userTwo\nthis.initialBalance = (0, _values.toBig)(100000);\nawait f.Collateral.setBalance(hre.users.userOne, this.initialBalance, hre.Diamond.address);\nawait f.Collateral.setBalance(hre.users.userTwo, this.initialBalance, hre.Diamond.address);\nthis.depositArgsOne = {\n    user: hre.users.userOne,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(10000)\n};\nthis.depositArgsTwo = {\n    user: hre.users.userTwo,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(10000)\n};\n// Deploy nft contract\n[this.nft] = await hre.deploy(\&quot;MockERC1155\&quot;, {\n    args: [],\n    from: hre.users.deployer.address\n});\nawait hre.Diamond.updateKreskian(this.nft.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fb3f3e47-aca1-4f37-ad03-1f63dd1b93ac&quot;,&quot;parentUUID&quot;:&quot;cb64bee9-c63c-47d5-aef8-2503f34310be&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not allow to deposit collateral if the user doesn&#x27;t have required nft&#x27;s&quot;,&quot;fullTitle&quot;:&quot;Gating should not allow to deposit collateral if the user doesn&#x27;t have required nft&#x27;s&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:48,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56864fe8-b10d-474b-8ea6-e1dcd58e6d60&quot;,&quot;parentUUID&quot;:&quot;cb64bee9-c63c-47d5-aef8-2503f34310be&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow to deposit collateral if the user has the required nft&#x27;s&quot;,&quot;fullTitle&quot;:&quot;Gating should allow to deposit collateral if the user has the required nft&#x27;s&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.nft.safeTransferFrom(hre.users.deployer.address, this.depositArgsOne.user.address, 0, 1, \&quot;0x00\&quot;);\nawait (0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd3a70be-fbf5-4e02-8a76-de442deebe8f&quot;,&quot;parentUUID&quot;:&quot;cb64bee9-c63c-47d5-aef8-2503f34310be&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;After all the phases anyone should be able to deposit collateral&quot;,&quot;fullTitle&quot;:&quot;Gating After all the phases anyone should be able to deposit collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:89,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updatePhase(3);\n// Anyone should be able to deposit collateral\nawait (0, _chai.expect)((0, _general.wrapContractWithSigner)(hre.Diamond, this.depositArgsTwo.user).depositCollateral(this.depositArgsTwo.user.address, f.Collateral.address, this.depositArgsTwo.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5ed70716-b997-4068-b7cb-6513d4cb954b&quot;,&quot;parentUUID&quot;:&quot;cb64bee9-c63c-47d5-aef8-2503f34310be&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;56864fe8-b10d-474b-8ea6-e1dcd58e6d60&quot;,&quot;fd3a70be-fbf5-4e02-8a76-de442deebe8f&quot;,&quot;5ed70716-b997-4068-b7cb-6513d4cb954b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:197,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;8d1390bc-bb69-4c4c-9a9e-44983b43468e&quot;,&quot;title&quot;:&quot;Oracles&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracles \&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n// Deploy one price feed\n[, [user]] = f.users;\nthis.deployer = await hre.ethers.getNamedSigner(\&quot;deployer\&quot;);\nthis.userOne = await hre.ethers.getNamedSigner(\&quot;userOne\&quot;);\nmockSequencerUptimeFeed = await (await hre.ethers.getContractFactory(\&quot;MockSequencerUptimeFeed\&quot;)).deploy();\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eab63cf0-d308-4061-a14d-0a2de9ddbb23&quot;,&quot;parentUUID&quot;:&quot;8d1390bc-bb69-4c4c-9a9e-44983b43468e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;title&quot;:&quot;Redstone&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have correct setup&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should have correct setup&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:72,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// check initial conditions\n(0, _chai.expect)(await hre.Diamond.getAccountTotalCollateralValue(user.address)).to.equal((0, _values.toBig)(10000, 8), \&quot;collateral value should be $10\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;07bdd480-bb6d-4b36-87b0-724b3314fe46&quot;,&quot;parentUUID&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get redstone price when chainlink price = 0&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should get redstone price when chainlink price = 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 0\nf.Collateral.setPrice(0);\nconst redstoneCollateralPrice = 20;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _mocks.testCollateralConfig.underlyingId,\n        value: redstoneCollateralPrice\n    }\n]);\n(0, _chai.expect)(await redstoneDiamond.getAccountTotalCollateralValue(user.address)).to.equal(f.depositAmount.wadMul((0, _values.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $20\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;234e935a-b56b-4ed4-bed9-dfb02bfd357f&quot;,&quot;parentUUID&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get primary price when price +- oracleDeviationPct of reference price &quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should get primary price when price +- oracleDeviationPct of reference price &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:100,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setOracleOrder([\n    _types.OracleType.Redstone,\n    _types.OracleType.Chainlink\n]);\n/// set chainlink price to 12\nf.Collateral.setPrice(12);\n/// set redstone price to 11\nconst redstoneCollateralPrice = 11;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _mocks.testCollateralConfig.underlyingId,\n        value: redstoneCollateralPrice\n    }\n]);\n(0, _chai.expect)(await redstoneDiamond.getAccountTotalCollateralValue(user.address)).to.equal(f.depositAmount.wadMul((0, _values.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $11\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;982fe659-712d-49d3-89ed-1498c842a3e9&quot;,&quot;parentUUID&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if price deviates too much&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should revert if price deviates too much&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 20\nf.Collateral.setPrice(20);\nconst redstoneCollateralPrice = 10;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _mocks.testCollateralConfig.underlyingId,\n        value: redstoneCollateralPrice\n    }\n]);\n// should revert if price deviates more than oracleDeviationPct\nawait (0, _chai.expect)(redstoneDiamond.getAccountTotalCollateralValue(user.address)).to.be.reverted;\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ecdf785d-9650-4cb3-9296-b34e6d37cb11&quot;,&quot;parentUUID&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return redstone price if sequencer is down&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should return redstone price if sequencer is down&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:94,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 5\nf.Collateral.setPrice(5);\nconst redstoneCollateralPrice = 200;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _mocks.testCollateralConfig.underlyingId,\n        value: redstoneCollateralPrice\n    }\n]);\n/// set sequencer uptime feed address\nawait redstoneDiamond.updateSequencerUptimeFeed(mockSequencerUptimeFeed.address);\n// should return redstone price if sequencer is down\n(0, _chai.expect)(await redstoneDiamond.getAccountTotalCollateralValue(user.address)).to.be.equal(f.depositAmount.wadMul((0, _values.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $200\&quot;);\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6926aeec-db85-4e91-ac53-eee3d2806f40&quot;,&quot;parentUUID&quot;:&quot;149a9bcb-8157-4f76-ad01-ebdcbf832cc6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;07bdd480-bb6d-4b36-87b0-724b3314fe46&quot;,&quot;234e935a-b56b-4ed4-bed9-dfb02bfd357f&quot;,&quot;982fe659-712d-49d3-89ed-1498c842a3e9&quot;,&quot;ecdf785d-9650-4cb3-9296-b34e6d37cb11&quot;,&quot;6926aeec-db85-4e91-ac53-eee3d2806f40&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:383,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;25ff70c3-deb2-40ab-9295-858d53505371&quot;,&quot;title&quot;:&quot;Safety Council&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n// These are the 5 signers on the SafetyCouncil multisig\nconst { deployer, devTwo, extOne, extTwo, devOne } = await hre.ethers.getNamedSigners();\nthis.deployer = deployer;\nthis.devOne = devOne;\nthis.devTwo = devTwo;\nthis.extOne = extOne;\nthis.extTwo = extTwo;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;54fafa21-7a8f-4d12-a6d7-2f9772c5271a&quot;,&quot;parentUUID&quot;:&quot;25ff70c3-deb2-40ab-9295-858d53505371&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;948c0423-da3a-4039-b9ed-016ed23ad861&quot;,&quot;title&quot;:&quot;#setSafetyStateSet&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;correctly sets the safety state&quot;,&quot;fullTitle&quot;:&quot;Safety Council #setSafetyStateSet correctly sets the safety state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const beforeSafetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(beforeSafetyState).to.equal(false);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;setSafetyStateSet\&quot;, [\n    true\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst safetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(safetyState).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8d5ff077-3138-494f-9a49-7eebf68ff6e9&quot;,&quot;parentUUID&quot;:&quot;948c0423-da3a-4039-b9ed-016ed23ad861&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8d5ff077-3138-494f-9a49-7eebf68ff6e9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:93,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;43f6cf92-31f7-42ea-a420-6d03cf892a55&quot;,&quot;title&quot;:&quot;#toggleAssetsPaused&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b3265615-5ece-4b9d-9bae-01f26fe0dcf3&quot;,&quot;title&quot;:&quot;multisig signature threshold&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;multisig transacts successfully with majority of signers (3/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with majority of signers (3/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f06e781d-5cc4-41d6-bf06-9e767c6a1a6e&quot;,&quot;parentUUID&quot;:&quot;b3265615-5ece-4b9d-9bae-01f26fe0dcf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3370aa2-c737-4e75-aef4-79075546c67c&quot;,&quot;parentUUID&quot;:&quot;b3265615-5ece-4b9d-9bae-01f26fe0dcf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with all signers (5/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with all signers (5/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:61,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.devTwo,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;643b5069-2f53-46bc-b406-f39d152388d6&quot;,&quot;parentUUID&quot;:&quot;b3265615-5ece-4b9d-9bae-01f26fe0dcf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;AssertionError: Expected transaction to be reverted with reason &#x27;&#x27;, but it reverted with reason &#x27;GS020&#x27;&quot;,&quot;estack&quot;:&quot;AssertionError: Expected transaction to be reverted with reason &#x27;&#x27;, but it reverted with reason &#x27;GS020&#x27;\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at runNextTicks (node:internal/process/task_queues:64:3)\n    at listOnTimeout (node:internal/timers:538:9)\n    at processTimers (node:internal/timers:512:7)\n    at async Context.&lt;anonymous&gt; (src/test/safety/00-council.ts:85:17)&quot;},&quot;uuid&quot;:&quot;336271a6-ed29-450e-9b34-c2b625816f5b&quot;,&quot;parentUUID&quot;:&quot;b3265615-5ece-4b9d-9bae-01f26fe0dcf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f06e781d-5cc4-41d6-bf06-9e767c6a1a6e&quot;,&quot;f3370aa2-c737-4e75-aef4-79075546c67c&quot;,&quot;643b5069-2f53-46bc-b406-f39d152388d6&quot;],&quot;failures&quot;:[&quot;336271a6-ed29-450e-9b34-c2b625816f5b&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:193,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;8b045331-d1a5-4fe2-b3ca-6a5d6acd454b&quot;,&quot;title&quot;:&quot;toggle actions only for listed assets&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle actions for listed collateral assets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6d3ba0f-6c12-48f7-86c4-9fe81dd70843&quot;,&quot;parentUUID&quot;:&quot;8b045331-d1a5-4fe2-b3ca-6a5d6acd454b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle actions for listed krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.KrAsset.address\n    ],\n    _actions.default.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.REPAY.toString(), f.KrAsset.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2322bba5-8df7-433d-8b73-43c747c8ec6d&quot;,&quot;parentUUID&quot;:&quot;8b045331-d1a5-4fe2-b3ca-6a5d6acd454b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomAddr = hre.ethers.utils.computeAddress(\&quot;0xb976778317b23a1285ec2d483eda6904d9319135b89f1d8eee9f6d2593e2665d\&quot;);\nawait (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        randomAddr\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), randomAddr);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;AssertionError: Expected transaction to be reverted with reason &#x27;&#x27;, but it reverted with reason &#x27;GS013&#x27;&quot;,&quot;estack&quot;:&quot;AssertionError: Expected transaction to be reverted with reason &#x27;&#x27;, but it reverted with reason &#x27;GS013&#x27;\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at runNextTicks (node:internal/process/task_queues:64:3)\n    at listOnTimeout (node:internal/timers:538:9)\n    at processTimers (node:internal/timers:512:7)\n    at async Context.&lt;anonymous&gt; (src/test/safety/00-council.ts:132:17)&quot;},&quot;uuid&quot;:&quot;5943c4b2-1941-4095-84c0-3840ce24af4f&quot;,&quot;parentUUID&quot;:&quot;8b045331-d1a5-4fe2-b3ca-6a5d6acd454b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e6d3ba0f-6c12-48f7-86c4-9fe81dd70843&quot;,&quot;2322bba5-8df7-433d-8b73-43c747c8ec6d&quot;],&quot;failures&quot;:[&quot;5943c4b2-1941-4095-84c0-3840ce24af4f&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:144,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b1000a37-7bd2-4774-933a-d49f82024aec&quot;,&quot;title&quot;:&quot;duration based pausing&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can optionally set a timeout on a given pause command&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing can optionally set a timeout on a given pause command&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000000;\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst depositSafetyState = await hre.Diamond.safetyStateFor(f.Collateral.address, _actions.default.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f764491-6f1a-465d-8ae8-6451f7a4a88d&quot;,&quot;parentUUID&quot;:&quot;b1000a37-7bd2-4774-933a-d49f82024aec&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;duration based pause functionality should expire after the duration has passed&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing duration based pause functionality should expire after the duration has passed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fc6e191c-fcc9-47ad-8dad-9395d56449cc&quot;,&quot;parentUUID&quot;:&quot;b1000a37-7bd2-4774-933a-d49f82024aec&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6f764491-6f1a-465d-8ae8-6451f7a4a88d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;fc6e191c-fcc9-47ad-8dad-9395d56449cc&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:60,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;title&quot;:&quot;toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle action DEPOSIT pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action DEPOSIT pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:114,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_actions.default.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2827fed4-936f-4f4a-9e74-63d9081710cf&quot;,&quot;parentUUID&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action WITHDRAW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action WITHDRAW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:115,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_actions.default.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_actions.default.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;185135dd-2947-43d9-88ea-6a959815f14e&quot;,&quot;parentUUID&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action REPAY pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action REPAY pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:115,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_actions.default.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_actions.default.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9084b273-23b3-4942-b87e-999aca0dd9ad&quot;,&quot;parentUUID&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action BORROW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action BORROW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:114,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_actions.default.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_actions.default.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a42664b9-5f48-4988-8909-a850f24506dd&quot;,&quot;parentUUID&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action LIQUIDATION pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action LIQUIDATION pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:114,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_actions.default.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_actions.default.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3bc602dc-7ef2-4620-a38b-5339ee657e46&quot;,&quot;parentUUID&quot;:&quot;adfd4970-2e5e-4a00-a5d4-3641f637cb27&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2827fed4-936f-4f4a-9e74-63d9081710cf&quot;,&quot;185135dd-2947-43d9-88ea-6a959815f14e&quot;,&quot;9084b273-23b3-4942-b87e-999aca0dd9ad&quot;,&quot;a42664b9-5f48-4988-8909-a850f24506dd&quot;,&quot;3bc602dc-7ef2-4620-a38b-5339ee657e46&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:572,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;59685359-4231-41e6-8817-497013c81120&quot;,&quot;title&quot;:&quot;event emission&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused event emission should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _actions.default.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;SafetyStateChange\&quot;);\n(0, _chai.expect)(event.action).to.equal(_actions.default.DEPOSIT);\n(0, _chai.expect)(event.asset).to.equal(f.Collateral.address);\n// @ts-ignore\n(0, _chai.expect)(event.description.hash).to.equal(hre.ethers.utils.keccak256(hre.ethers.utils.toUtf8Bytes(\&quot;paused\&quot;)));&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;TypeError: (0 , _lib.getInternalEvent) is not a function&quot;,&quot;estack&quot;:&quot;TypeError: (0 , _lib.getInternalEvent) is not a function\n    at Context.&lt;anonymous&gt; (src/test/safety/00-council.ts:340:53)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at runNextTicks (node:internal/process/task_queues:64:3)\n    at listOnTimeout (node:internal/timers:538:9)\n    at processTimers (node:internal/timers:512:7)&quot;},&quot;uuid&quot;:&quot;d70f0983-4cf8-45e1-8f29-83140a4035bd&quot;,&quot;parentUUID&quot;:&quot;59685359-4231-41e6-8817-497013c81120&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;d70f0983-4cf8-45e1-8f29-83140a4035bd&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:22,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;bcc97c22-09f5-41dd-8da0-5234c4f67d96&quot;,&quot;title&quot;:&quot;SCDP&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP \&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.scdpFixture)({\n    krAssets: createAssets,\n    collaterals: createCollaterals\n});\n[[swapper, KreskoSwapper], [depositor, KreskoDepositor], [depositor2, KreskoDepositor2], [, KreskoLiquidator]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;646e350f-b35d-4a17-b9cf-1468d866b402&quot;,&quot;parentUUID&quot;:&quot;bcc97c22-09f5-41dd-8da0-5234c4f67d96&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ad4b35f7-999f-445d-bdb8-ae700219811e&quot;,&quot;title&quot;:&quot;#Test&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Test\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test \&quot;before each\&quot; hook in \&quot;#Test\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;adeccc7e-e0e0-4787-a962-eaeddc4112ef&quot;,&quot;parentUUID&quot;:&quot;ad4b35f7-999f-445d-bdb8-ae700219811e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;title&quot;:&quot;#Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be initialized correctly&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be initialized correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:314,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { args } = await (0, _shared.getSCDPInitializer)(hre);\nconst configuration = await hre.Diamond.getCurrentParametersSCDP();\n(0, _chai.expect)(configuration.swapFeeRecipient).to.equal(args.swapFeeRecipient);\n(0, _chai.expect)(configuration.liquidationThreshold).to.equal(args.liquidationThreshold);\n(0, _chai.expect)(configuration.minCollateralRatio).to.equal(args.minCollateralRatio);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include.members([\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst depositsEnabled = await Promise.all([\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral.address),\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral8Dec.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KISS.address)\n]);\n(0, _chai.expect)(depositsEnabled).to.deep.equal([\n    true,\n    true,\n    false,\n    false,\n    true\n]);\nconst depositAssets = await hre.Diamond.getDepositAssetsSCDP();\n(0, _chai.expect)(depositAssets).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KISS.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a5481f2b-1831-4dc3-b4d8-a2bda4124385&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to whitelist new deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to whitelist new deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:181,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetInfoBefore = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoBefore.isSCDPDepositAsset).to.equal(false);\nawait hre.Diamond.updateAsset(f.KrAsset2.address, {\n    ...assetInfoBefore,\n    isSCDPDepositAsset: true,\n    depositLimitSCDP: 1\n});\nconst assetInfoAfter = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoAfter.decimals).to.equal(await f.KISS.contract.decimals());\n(0, _chai.expect)(assetInfoAfter.liquidityIndexSCDP).to.equal(_values.RAY);\n(0, _chai.expect)(assetInfoAfter.depositLimitSCDP).to.equal(1);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8cc9b36d-0785-4f00-8537-7e89ba893b03&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update deposit limit of asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to update deposit limit of asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updateDepositLimitSCDP(f.Collateral.address, 1);\nconst collateral = await hre.Diamond.getAsset(f.Collateral.address);\n(0, _chai.expect)(collateral.decimals).to.equal(await f.Collateral.contract.decimals());\n(0, _chai.expect)(collateral.liquidityIndexSCDP).to.equal(_values.RAY);\n(0, _chai.expect)(collateral.depositLimitSCDP).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f0c63d9-9e0e-41c0-9bb7-cca27f113c15&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable a deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable a deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:144,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setDepositAssetSCDP(f.Collateral.address, false);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.Collateral.address);\nconst depositAssets = await hre.Diamond.getDepositAssetsSCDP();\n(0, _chai.expect)(depositAssets).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;811cb914-f25d-4611-a3ec-2039223792fa&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable and enable a collateral asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable and enable a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:464,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setCollateralSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositAssetsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\nawait hre.Diamond.setDepositAssetSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setCollateralSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositAssetsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setDepositAssetSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getDepositAssetsSCDP()).to.include(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8455ecda-a683-4766-9b6f-3354c01831eb&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to add whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to add whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(scdpKrAssetConfig.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(scdpKrAssetConfig.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(scdpKrAssetConfig.liqIncentiveSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(scdpKrAssetConfig.protocolFeeShareSCDP);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a7e82284-f97d-4944-b01d-0c1c67c71c24&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to update a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:207,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = {\n    ...f.KrAsset.config.assetStruct,\n    swapInFeeSCDP: 0.05e4,\n    swapOutFeeSCDP: 0.05e4,\n    liqIncentiveSCDP: 1.06e4,\n    protocolFeeShareSCDP: 0.4e4\n};\nawait hre.Diamond.updateAsset(f.KrAsset.address, update);\nconst assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(update.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(update.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(update.protocolFeeShareSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(update.liqIncentiveSCDP);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include(f.KrAsset.address);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5e38b939-cbe2-41d5-a9b9-b5f03840444e&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to remove a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to remove a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setKrAssetSCDP(f.KrAsset.address, false);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.not.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;90e7318e-ebea-485f-b007-c50756171445&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to enable and disable swap pairs&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to enable and disable swap pairs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:217,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapPairsEnabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: true\n    }\n];\nawait hre.Diamond.setSwapPairs(swapPairsEnabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(true);\nconst swapPairsDisabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: false\n    }\n];\nawait hre.Diamond.setSwapPairs(swapPairsDisabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(false);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02889cb4-b8d0-49aa-9098-e3cbd8ced5a6&quot;,&quot;parentUUID&quot;:&quot;e39d3f81-cd7d-4cf7-995e-aa494b753b54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a5481f2b-1831-4dc3-b4d8-a2bda4124385&quot;,&quot;8cc9b36d-0785-4f00-8537-7e89ba893b03&quot;,&quot;6f0c63d9-9e0e-41c0-9bb7-cca27f113c15&quot;,&quot;811cb914-f25d-4611-a3ec-2039223792fa&quot;,&quot;8455ecda-a683-4766-9b6f-3354c01831eb&quot;,&quot;a7e82284-f97d-4944-b01d-0c1c67c71c24&quot;,&quot;5e38b939-cbe2-41d5-a9b9-b5f03840444e&quot;,&quot;90e7318e-ebea-485f-b007-c50756171445&quot;,&quot;02889cb4-b8d0-49aa-9098-e3cbd8ced5a6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1756,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2542fc38-01a2-4b17-8ff3-7ff9043ea521&quot;,&quot;title&quot;:&quot;#Deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deposit collateral, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Deposit should be able to deposit collateral, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1140,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _values.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted = (collateralPrice * depositAmount).ebn(8); // cfactor = 1\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    return (0, _redstone.wrapKresko)(hre.Diamond, user).depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n}));\nconst [userInfos, statistics, assetInfo] = await Promise.all([\n    hre.Diamond.getAccountInfosSCDP(f.usersArr.map((user)=&gt;user.address), [\n        f.Collateral.address\n    ]),\n    hre.Diamond.getStatisticsSCDP(),\n    hre.Diamond.getAssetInfoSCDP(f.Collateral.address)\n]);\nfor (const userInfo of userInfos){\n    const balance = await f.Collateral.balanceOf(userInfo.account);\n    (0, _chai.expect)(balance).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].scaledDepositAmount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.totalScaledDepositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].depositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].scaledDepositValue).to.equal(expectedValueUnadjusted);\n}\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.depositAmount).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.depositValue).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.collateralValue).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.debtValue).to.equal(0);\n// Adjusted\n(0, _chai.expect)(assetInfo.depositValueAdjusted).to.equal(expectedValueAdjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.collateralValueAdjusted).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.debtValueAdjusted).to.equal(0);\n(0, _chai.expect)(statistics.effectiveDebtValue).to.equal(0);\n(0, _chai.expect)(statistics.crDebtValueAdjusted).to.equal(0);\n(0, _chai.expect)(statistics.crDebtValue).to.equal(0);\n(0, _chai.expect)(statistics.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dac63818-0862-4149-b943-4c498f378138&quot;,&quot;parentUUID&quot;:&quot;2542fc38-01a2-4b17-8ff3-7ff9043ea521&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Deposit should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1424,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _values.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted = (0, _values.toBig)(collateralPrice / 1 * depositAmount, 8); // cfactor = 1\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(collateralPrice * 0.8 * depositAmount, 8); // cfactor = 0.8\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    const User = (0, _general.wrapContractWithSigner)(hre.Diamond, user);\n    return Promise.all([\n        User.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        User.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));\nconst [userInfos, assetInfos, globals] = await Promise.all([\n    hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.getStatisticsSCDP()\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(depositAmount8Dec);\n    (0, _chai.expect)(userInfo.deposits[1].depositValue).to.equal(expectedValueUnadjusted8Dec);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec));\n}\n(0, _chai.expect)(assetInfos[0].depositAmount).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfos[1].depositAmount).to.equal(depositAmount8Dec.mul(f.usersArr.length));\n// WITH_FACTORS global\nconst valueTotalAdjusted = expectedValueAdjusted.mul(f.usersArr.length);\nconst valueTotalAdjusted8Dec = expectedValueAdjusted8Dec.mul(f.usersArr.length);\nconst valueAdjusted = valueTotalAdjusted.add(valueTotalAdjusted8Dec);\n(0, _chai.expect)(assetInfos[0].depositValueAdjusted).to.equal(valueTotalAdjusted);\n(0, _chai.expect)(assetInfos[1].depositValueAdjusted).to.equal(valueTotalAdjusted8Dec);\n(0, _chai.expect)(globals.collateralValueAdjusted).to.equal(valueAdjusted);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);\n// WITHOUT_FACTORS global\nconst valueTotalUnadjusted = expectedValueUnadjusted.mul(f.usersArr.length);\nconst valueTotalUnadjusted8Dec = expectedValueUnadjusted8Dec.mul(f.usersArr.length);\nconst valueUnadjusted = valueTotalUnadjusted.add(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal(valueTotalUnadjusted);\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(globals.collateralValue).to.equal(valueUnadjusted);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;31a24f91-f4ac-4eec-a1f3-76041a019aab&quot;,&quot;parentUUID&quot;:&quot;2542fc38-01a2-4b17-8ff3-7ff9043ea521&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;dac63818-0862-4149-b943-4c498f378138&quot;,&quot;31a24f91-f4ac-4eec-a1f3-76041a019aab&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2564,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2533c83d-1d98-40d6-ad98-c7589a71b090&quot;,&quot;title&quot;:&quot;#Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw \&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:249,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(hre.Diamond, user);\n    await Promise.all([\n        UserKresko.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        UserKresko.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;873c25e4-187f-4f28-86d9-e8f45a65cc1e&quot;,&quot;parentUUID&quot;:&quot;2533c83d-1d98-40d6-ad98-c7589a71b090&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to withdraw full collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw should be able to withdraw full collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1545,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(hre.Diamond, user);\n    return Promise.all([\n        UserKresko.withdrawSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        UserKresko.withdrawSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(0);\nconst [userInfos, assetInfos, globals] = await Promise.all([\n    hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.getStatisticsSCDP()\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(await f.Collateral.balanceOf(userInfo.account)).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].scaledDepositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].scaledDepositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(0);\n}\nfor (const assetInfo of assetInfos){\n    (0, _chai.expect)(assetInfo.depositValue).to.equal(0);\n    (0, _chai.expect)(assetInfo.depositAmount).to.equal(0);\n    (0, _chai.expect)(assetInfo.swapDeposits).to.equal(0);\n}\n(0, _chai.expect)(globals.collateralValue).to.equal(0);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f8599fdf-c092-499e-8018-809e3e9e00a7&quot;,&quot;parentUUID&quot;:&quot;2533c83d-1d98-40d6-ad98-c7589a71b090&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw partial collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw should be able to withdraw partial collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1861,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const partialWithdraw = depositAmount18Dec.div(f.usersArr.length);\nconst partialWithdraw8Dec = depositAmount8Dec.div(f.usersArr.length);\nconst expectedValueUnadjusted = (0, _values.toBig)(collateralPrice * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted = (0, _values.toBig)(collateralPrice * 1 * depositAmount, 8).mul(200).div(300); // cfactor = 1\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(collateralPrice * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(collateralPrice * 0.8 * depositAmount, 8).mul(200).div(300); // cfactor = 0.8\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(hre.Diamond, user);\n    return Promise.all([\n        UserKresko.withdrawSCDP(user.address, f.Collateral.address, partialWithdraw),\n        UserKresko.withdrawSCDP(user.address, f.Collateral8Dec.address, partialWithdraw8Dec)\n    ]);\n}));\nconst [collateralBalanceAfter, collateral8DecBalanceAfter, globals, assetInfos, userInfos] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    f.Collateral8Dec.balanceOf(hre.Diamond.address),\n    hre.Diamond.getStatisticsSCDP(),\n    hre.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const [balance18Dec, balance8Dec] = await Promise.all([\n        f.Collateral.balanceOf(userInfo.account),\n        f.Collateral8Dec.balanceOf(userInfo.account)\n    ]);\n    (0, _chai.expect)(balance18Dec).to.equal(partialWithdraw);\n    (0, _chai.expect)(balance8Dec).to.equal(partialWithdraw8Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[0].scaledDepositAmount).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.deposits[1].scaledDepositAmount).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.totalDepositValue).to.closeTo(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec), (0, _values.toBig)(0.00001, 8));\n}\n(0, _chai.expect)(collateralBalanceAfter).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(collateral8DecBalanceAfter).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].depositAmount).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(assetInfos[1].depositAmount).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].depositValue).to.closeTo(expectedValueUnadjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[0].depositValueAdjusted).to.closeTo(expectedValueAdjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].depositValue).to.closeTo(expectedValueUnadjusted8Dec.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].depositValueAdjusted).to.closeTo(expectedValueAdjusted8Dec.mul(f.usersArr.length), 20);\nconst totalValueRemaining = expectedValueUnadjusted8Dec.mul(f.usersArr.length).add(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(globals.collateralValue).to.closeTo(totalValueRemaining, 20);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;705916e3-0c18-4e5e-8909-d09bed041ae0&quot;,&quot;parentUUID&quot;:&quot;2533c83d-1d98-40d6-ad98-c7589a71b090&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f8599fdf-c092-499e-8018-809e3e9e00a7&quot;,&quot;705916e3-0c18-4e5e-8909-d09bed041ae0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3406,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2e5773a1-ca9d-4dee-a56b-7e5b4549ea50&quot;,&quot;title&quot;:&quot;#Fee Distribution&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Fee Distribution \&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;incomeCumulator = hre.users.admin;\nIncomeCumulator = (0, _redstone.wrapKresko)(hre.Diamond, incomeCumulator);\nawait f.Collateral.setBalance(incomeCumulator, depositAmount18Dec.mul(f.usersArr.length), hre.Diamond.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;943539d7-42f0-47df-96db-d99e1ff780bb&quot;,&quot;parentUUID&quot;:&quot;2e5773a1-ca9d-4dee-a56b-7e5b4549ea50&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to cumulate fees into deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Fee Distribution should be able to cumulate fees into deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3175,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fees = depositAmount18Dec.mul(f.usersArr.length);\nconst expectedValueNoFees = (0, _values.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueFees = expectedValueNoFees.mul(2);\n// deposit some\nawait Promise.all(f.usersArr.map((signer)=&gt;(0, _redstone.wrapKresko)(hre.Diamond, signer).depositSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\n// cumulate some income\nawait IncomeCumulator.cumulateIncomeSCDP(f.Collateral.address, fees);\n// check that the fees are cumulated\nfor (const data of (await hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    (0, _chai.expect)(data.deposits[0].depositValue).to.equal(expectedValueNoFees);\n    (0, _chai.expect)(data.deposits[0].scaledDepositValue).to.equal(expectedValueFees);\n    (0, _chai.expect)(data.totalDepositValue).to.equal(expectedValueNoFees);\n    (0, _chai.expect)(data.totalScaledDepositValue).to.equal(expectedValueFees);\n}\n// withdraw principal\nawait Promise.all(f.usersArr.map((signer)=&gt;(0, _redstone.wrapKresko)(hre.Diamond, signer).withdrawSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\nfor (const user of (await hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(user.account);\n    (0, _chai.expect)(user.deposits[0].depositValue).to.equal(0);\n    (0, _chai.expect)(user.deposits[0].scaledDepositValue).to.equal(expectedValueFees.sub(expectedValueNoFees));\n    (0, _chai.expect)(user.totalScaledDepositValue).to.equal(expectedValueFees.sub(expectedValueNoFees));\n    (0, _chai.expect)(user.totalDepositValue).to.equal(0);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec);\n}\nconst [assetInfo, stats, balance] = await Promise.all([\n    hre.Diamond.getAssetInfoSCDP(f.Collateral.address),\n    hre.Diamond.getStatisticsSCDP(),\n    f.Collateral.balanceOf(hre.Diamond.address)\n]);\n(0, _chai.expect)(balance).to.equal(fees);\n(0, _chai.expect)(assetInfo.depositAmount).to.equal(0);\n(0, _chai.expect)(assetInfo.depositValue).to.equal(0);\n(0, _chai.expect)(assetInfo.depositValueAdjusted).to.equal(0);\n(0, _chai.expect)(stats.collateralValue).to.equal(0);\n// Withdraw fees\nawait Promise.all(f.usersArr.map((signer)=&gt;{\n    return (0, _redstone.wrapKresko)(hre.Diamond, signer).withdrawSCDP(signer.address, f.Collateral.address, depositAmount18Dec);\n}));\nfor (const data of (await hre.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(data.account);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec.add(depositAmount18Dec));\n    (0, _chai.expect)(data.deposits[0].depositValue).to.equal(0);\n    (0, _chai.expect)(data.deposits[0].scaledDepositValue).to.equal(0);\n    (0, _chai.expect)(data.totalDepositValue).to.equal(0);\n    (0, _chai.expect)(data.totalScaledDepositValue).to.equal(0);\n}\n// nothing left in protocol.\nconst [colalteralBalanceKresko, assetInfoFinal] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    hre.Diamond.getAssetInfoSCDP(f.Collateral.address)\n]);\n(0, _chai.expect)(colalteralBalanceKresko).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositAmount).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositValue).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositValueAdjusted).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;81361bbe-917d-4506-bef5-694be0edf6e3&quot;,&quot;parentUUID&quot;:&quot;2e5773a1-ca9d-4dee-a56b-7e5b4549ea50&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;81361bbe-917d-4506-bef5-694be0edf6e3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3175,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;title&quot;:&quot;#Swap&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap \&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:50,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(depositor, (0, _values.toBig)(10_000));\nawait KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, depositAmount18Dec);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fee651f8-fdd9-449e-b18a-52493bd8f80b&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have collateral in pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should have collateral in pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:87,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const value = await hre.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(value.collateralValue).to.equal((0, _values.toBig)(depositAmount, 8));\n(0, _chai.expect)(value.debtValue).to.equal(0);\n(0, _chai.expect)(value.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f467c647-dec2-44e0-bd81-30973f7d8513&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to preview a swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to preview a swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:117,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nconst assetInPrice = (0, _values.toBig)(ONE_USD, 8);\n(0, _chai.expect)(await f.KrAsset2.getPrice()).to.equal(KreskoAsset2Price.ebn(8));\nconst assetOutPrice = (0, _values.toBig)(KreskoAsset2Price, 8);\nconst feePercentage = FEE_KISS_KRASSET;\nconst feePercentageProtocol = 0.5e4;\nconst expectedTotalFee = swapAmount.percentMul(feePercentage);\nconst expectedProtocolFee = expectedTotalFee.percentMul(feePercentageProtocol);\nconst expectedFee = expectedTotalFee.sub(expectedProtocolFee);\nconst amountInAfterFees = swapAmount.sub(expectedTotalFee);\nconst expectedAmountOut = amountInAfterFees.wadMul(assetInPrice).wadDiv(assetOutPrice);\nconst [amountOut, feeAmount, feeAmountProtocol] = await hre.Diamond.previewSwapSCDP(f.KISS.address, f.KrAsset2.address, swapAmount);\n(0, _chai.expect)(amountOut).to.equal(expectedAmountOut);\n(0, _chai.expect)(feeAmount).to.equal(expectedFee);\n(0, _chai.expect)(feeAmountProtocol).to.equal(expectedProtocolFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;36781535-2fdd-4d8a-b832-2576e45f01cf&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == 0 | swap collateral == 0&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt == 0 | swap collateral == 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1053,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD); // $1\nconst kissInAfterFees = swapAmount.sub(swapAmount.percentMul(FEE_KISS_KRASSET));\nconst expectedAmountOut = kissInAfterFees.wadMul(ONE_USD.ebn(8)).wadDiv(KreskoAsset2Price.ebn(8));\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmount);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedAmountOut);\nconst [KR2Balance, KISSBalance, swapperInfo, assetInfos, global] = await Promise.all([\n    f.KrAsset2.balanceOf(swapper.address),\n    f.KISS.balanceOf(swapper.address),\n    hre.Diamond.getAccountInfoSCDP(swapper.address, [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.getAssetInfosSCDP([\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.getStatisticsSCDP()\n]);\n(0, _chai.expect)(KR2Balance).to.equal(expectedAmountOut);\n(0, _chai.expect)(KISSBalance).to.equal((0, _values.toBig)(10_000).sub(swapAmount));\n(0, _chai.expect)(swapperInfo.deposits[0].depositValue).to.equal(0);\n(0, _chai.expect)(swapperInfo.deposits[1].depositValue).to.equal(0);\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal(expectedAmountOut);\n(0, _chai.expect)(assetInfos[1].swapDeposits).to.equal(kissInAfterFees);\nconst expectedDepositValue = (0, _values.toBig)(depositAmount, 8).add(kissInAfterFees.wadMul(ONE_USD.ebn(8)));\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(expectedDepositValue);\n(0, _chai.expect)(assetInfos[0].debtValue).to.equal(expectedAmountOut.wadMul(KreskoAsset2Price.ebn(8)));\n(0, _chai.expect)(global.collateralValue).to.equal(expectedDepositValue);\n(0, _chai.expect)(global.debtValue).to.equal(expectedAmountOut.wadMul(KreskoAsset2Price.ebn(8)));\n(0, _chai.expect)(global.cr).to.equal(expectedDepositValue.percentDiv(expectedAmountOut.wadMul(KreskoAsset2Price.ebn(8))));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0d321d97-12ca-4167-845b-4541e09ad164&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1191,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD).mul(100); // $100\nconst swapAmountAsset = swapAmount.percentMul(1e4 - FEE_KISS_KRASSET).wadMul(ONE_USD.ebn(8)).wadDiv(KreskoAsset2Price.ebn(8));\nconst expectedKissOut = swapAmountAsset.percentMul(1e4 - FEE_KISS_KRASSET).wadMul(KreskoAsset2Price.ebn(8)).wadDiv(ONE_USD.ebn(8));\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(100)\n});\nawait (0, _krassets.mintKrAsset)({\n    user: swapper,\n    asset: f.KrAsset2,\n    amount: (0, _values.toBig)(0.1)\n});\nconst globalBefore = await hre.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(globalBefore.collateralValue).to.equal(initialDepositValue);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n// the swap that clears debt\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountAsset, 0);\nconst [event, assetInfos] = await Promise.all([\n    (0, _events.getNamedEvent)(tx, \&quot;Swap\&quot;),\n    hre.Diamond.getAssetInfosSCDP([\n        f.KISS.address,\n        f.KrAsset2.address\n    ])\n]);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(0);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal(initialDepositValue);\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(0);\nconst global = await hre.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(global.collateralValue).to.equal((0, _values.toBig)(1000, 8));\n(0, _chai.expect)(global.debtValue).to.equal(0);\n(0, _chai.expect)(global.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bf3a5a5c-81a7-4025-816f-dbef4a6d7e7b&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, debt &gt; assetsIn | swap deposits &gt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, debt &gt; assetsIn | swap deposits &gt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1); // $1\nconst swapValue = (0, _values.toBig)(1, 8);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst assetInfoKISS = await hre.Diamond.getAssetInfoSCDP(f.KISS.address);\nconst feeValueFirstSwap = swapValue.percentMul(FEE_KISS_KRASSET);\nconst valueInAfterFees = swapValue.sub(feeValueFirstSwap);\n(0, _chai.expect)(assetInfoKISS.depositValue).to.equal(depositValue.add(valueInAfterFees));\nconst expectedSwapDeposits = valueInAfterFees.num(8).ebn(18);\n(0, _chai.expect)(assetInfoKISS.swapDeposits).to.equal(expectedSwapDeposits);\nconst swapAmountSecond = (0, _values.toBig)(0.009); // this is $0.90, so less than $0.96 since we want to ensure debt &gt; assetsIn | swap deposits &gt; assetsOut\nconst swapValueSecond = swapAmountSecond.wadMul(KreskoAsset2Price.ebn(8));\nconst feeValueSecondSwap = swapValueSecond.sub(swapValueSecond.percentMul(FEE_KISS_KRASSET));\nconst expectedKissOut = feeValueSecondSwap.wadDiv(ONE_USD.ebn(8)); // 0.8685\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountSecond, 0);\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountSecond);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\nconst [depositValueKR2, depositValueKISS, assetInfos, globals] = await Promise.all([\n    KreskoSwapper.getAccountDepositValueSCDP(swapper.address, f.KrAsset2.address),\n    KreskoSwapper.getAccountDepositValueSCDP(swapper.address, f.KISS.address),\n    hre.Diamond.getAssetInfosSCDP([\n        f.KISS.address,\n        f.KrAsset2.address\n    ]),\n    hre.Diamond.getStatisticsSCDP()\n]);\n(0, _chai.expect)(depositValueKR2).to.equal(0);\n(0, _chai.expect)(depositValueKISS).to.equal(0);\nconst expectedSwapDepositsAfter = expectedSwapDeposits.sub((0, _values.toBig)(0.9));\nconst expectedSwapDepositsValue = expectedSwapDepositsAfter.wadMul(assetInfoKISS.assetPrice);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(expectedSwapDepositsAfter);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal((0, _values.toBig)(depositAmount, 8).add(expectedSwapDepositsValue));\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(expectedSwapDepositsValue);\nconst expectedDebtAfter = expectedSwapDepositsValue.wadDiv(await f.KrAsset2.getPrice());\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(expectedDebtAfter);\nconst expectedCollateralValue = expectedSwapDepositsValue.add(depositAmount.ebn(8));\n(0, _chai.expect)(globals.collateralValue).to.equal(expectedCollateralValue); // swap deposits + collateral deposited\n(0, _chai.expect)(globals.debtValue).to.equal(expectedSwapDepositsValue); //\n(0, _chai.expect)(globals.cr).to.equal(expectedCollateralValue.percentDiv(expectedSwapDepositsValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;47487fd1-16c4-4326-88a1-d2d6c567e892&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, debt &lt; assetsIn | swap deposits &lt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, debt &lt; assetsIn | swap deposits &lt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1990,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmountKiss = (0, _values.toBig)(ONE_USD).mul(100); // $100\nconst swapAmountKrAsset = (0, _values.toBig)(2); // $200\nconst swapValue = 200;\nconst firstSwapFeeAmount = swapAmountKiss.percentMul(FEE_KISS_KRASSET);\nconst expectedKissOutSecondSwap = swapAmountKrAsset.sub(swapAmountKrAsset.percentMul(FEE_KISS_KRASSET)).wadMul(KreskoAsset2Price.ebn(8)).wadDiv(ONE_USD.ebn(8));\nconst krAssetOutFirstSwap = swapAmountKiss.sub(firstSwapFeeAmount).wadMul(ONE_USD.ebn(8)).wadDiv(KreskoAsset2Price.ebn(8));\nconst krAssetOutFirstSwapValue = krAssetOutFirstSwap.wadMul(KreskoAsset2Price.ebn(8));\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(400)\n});\nconst ICDPMintAmount = (0, _values.toBig)(1.04);\nawait (0, _krassets.mintKrAsset)({\n    user: swapper,\n    asset: f.KrAsset2,\n    amount: ICDPMintAmount\n});\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmountKiss, 0);\nconst expectedSwapDeposits = swapAmountKiss.sub(firstSwapFeeAmount);\nconst stats = await hre.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(await KreskoSwapper.getSwapDepositsSCDP(f.KISS.address)).to.equal(expectedSwapDeposits);\n(0, _chai.expect)(stats.collateralValue).to.be.eq(depositAmount.ebn().add(expectedSwapDeposits).wadMul(ONE_USD.ebn(8)));\n// the swap that matters, here user has 0.96 (previous swap) + 1.04 (mint). expecting 192 kiss from swap.\nconst [expectedAmountOut] = await KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmountKrAsset);\n(0, _chai.expect)(expectedAmountOut).to.equal(expectedKissOutSecondSwap);\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountKrAsset, 0);\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountKrAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOutSecondSwap);\nconst assetInfos = await hre.Diamond.getAssetInfosSCDP([\n    f.KISS.address,\n    f.KrAsset2.address\n]);\n// f.KISS deposits sent in swap\nconst acocuntPrincipalDepositsKISS = await KreskoSwapper.getAccountDepositSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(0); // half of 2 krAsset\n(0, _chai.expect)(assetInfos[0].depositAmount).to.equal(acocuntPrincipalDepositsKISS);\n// KrAsset debt is cleared\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(0);\n// KISS debt is issued\nconst expectedKissDebtValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[0].debtValue).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal(expectedKissDebtValue.wadDiv(ONE_USD.ebn(8)));\n// krAsset swap deposits\nconst expectedSwapDepositValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[1].swapDeposits).to.equal((0, _values.toBig)(2).sub(krAssetOutFirstSwap));\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(expectedSwapDepositValue); // asset price is $100\nconst global = await hre.Diamond.getStatisticsSCDP();\nconst expectedCollateralValue = (0, _values.toBig)(1000, 8).add(expectedSwapDepositValue);\n(0, _chai.expect)(global.collateralValue).to.equal(expectedCollateralValue);\n(0, _chai.expect)(global.debtValue).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(global.cr).to.equal(expectedCollateralValue.percentDiv(expectedKissDebtValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a2898a20-2874-4373-b9d9-6975bc3dabeb&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cumulates fees on swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap cumulates fees on swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1007,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmountNew = (0, _values.toBig)(10000 - depositAmount);\nawait f.KISS.setBalance(depositor, depositAmountNew);\nawait KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, depositAmountNew);\nconst swapAmount = (0, _values.toBig)(ONE_USD * 2600); // $1\nconst scaledDepositsStart = await KreskoSwapper.getAccountScaledDepositsSCDP(depositor.address, f.KISS.address);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst scaledDepositsAfterSwap = await KreskoSwapper.getAccountScaledDepositsSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(scaledDepositsAfterSwap).to.gt(scaledDepositsStart);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, f.KrAsset2.balanceOf(swapper.address), 0);\nconst scaledDepositsAfterSecondSwap = await KreskoSwapper.getAccountScaledDepositsSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(scaledDepositsAfterSecondSwap).to.gt(scaledDepositsAfterSwap);\nconst feesGained = await KreskoSwapper.getAccountDepositFeesGainedSCDP(depositor.address, f.KISS.address);\nawait KreskoDepositor.withdrawSCDP(depositor.address, f.KISS.address, feesGained);\nconst [scaledDepositsAfter, feesAfter] = await Promise.all([\n    KreskoSwapper.getAccountScaledDepositsSCDP(depositor.address, f.KISS.address),\n    KreskoSwapper.getAccountDepositFeesGainedSCDP(depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(feesGained).to.eq(feesAfter);\n(0, _chai.expect)(scaledDepositsAfter).to.eq((0, _values.toBig)(10000));\nawait KreskoDepositor.withdrawSCDP(depositor.address, f.KISS.address, (0, _values.toBig)(10000));\nconst [depositsAfterFourth, feesAfterFourth] = await Promise.all([\n    KreskoSwapper.getAccountDepositValueSCDP(depositor.address, f.KISS.address),\n    KreskoSwapper.getAccountScaledDepositsSCDP(depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(depositsAfterFourth).to.eq(0);\n(0, _chai.expect)(feesAfterFourth).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;30b24b12-c2e8-43a6-b659-c93269453f98&quot;,&quot;parentUUID&quot;:&quot;f8c2d57f-cff8-492e-8bb5-56ecaec96810&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f467c647-dec2-44e0-bd81-30973f7d8513&quot;,&quot;36781535-2fdd-4d8a-b832-2576e45f01cf&quot;,&quot;0d321d97-12ca-4167-845b-4541e09ad164&quot;,&quot;bf3a5a5c-81a7-4025-816f-dbef4a6d7e7b&quot;,&quot;47487fd1-16c4-4326-88a1-d2d6c567e892&quot;,&quot;a2898a20-2874-4373-b9d9-6975bc3dabeb&quot;,&quot;30b24b12-c2e8-43a6-b659-c93269453f98&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6556,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;title&quot;:&quot;#Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations \&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;for (const signer of f.usersArr){\n    await f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000));\n}\nawait f.KISS.setBalance(swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(depositor2, (0, _values.toBig)(10_000));\nawait Promise.all([\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec),\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral8Dec.address, depositAmount8Dec),\n    KreskoDepositor2.depositSCDP(depositor2.address, f.KISS.address, depositAmount18Dec)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;302379dd-9423-4547-bba7-f2496612fc9b&quot;,&quot;parentUUID&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should identify if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:542,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD * 2600); // $1\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;403e2883-7d40-4212-9ef9-f393a6c1fffd&quot;,&quot;parentUUID&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert liquidations if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should revert liquidations if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:719,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD * 2600); // $1\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;\nawait f.KrAsset2.setBalance(hre.users.liquidator, (0, _values.toBig)(1_000_000));\nawait (0, _chai.expect)(KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, (0, _values.toBig)(7.7), f.Collateral8Dec.address)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;CANNOT_LIQUIDATE\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ecb8e3f-4f28-4aa9-b652-2ec4405e9c7f&quot;,&quot;parentUUID&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should identify if the pool is underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should identify if the pool is underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:840,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD * 2600);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nf.Collateral.setPrice(collateralPrice / 1000);\nf.Collateral8Dec.setPrice(collateralPrice / 1000);\nconst [stats, params, liquidatable] = await Promise.all([\n    hre.Diamond.getStatisticsSCDP(),\n    hre.Diamond.getCurrentParametersSCDP(),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(stats.cr).to.be.lt(params.liquidationThreshold);\n(0, _chai.expect)(liquidatable).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e5f9653c-d4cc-485e-8901-bf57cc308c46&quot;,&quot;parentUUID&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidating the underwater pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should allow liquidating the underwater pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2611,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD * 2600);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst newKreskoAssetPrice = 500;\nf.KrAsset2.setPrice(newKreskoAssetPrice);\nconst [scdpParams, maxLiquidatable, krAssetPrice, statsBefore] = await Promise.all([\n    hre.Diamond.getCurrentParametersSCDP(),\n    hre.Diamond.getMaxLiqValueSCDP(f.KrAsset2.address, f.Collateral8Dec.address),\n    f.KrAsset2.getPrice(),\n    hre.Diamond.getStatisticsSCDP()\n]);\nconst repayAmount = maxLiquidatable.repayValue.wadDiv(krAssetPrice);\nawait f.KrAsset2.setBalance(hre.users.liquidator, repayAmount.add(1e18.toString()));\n(0, _chai.expect)(statsBefore.cr).to.lt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(statsBefore.cr).to.gt(1e4);\nconst tx = await KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, repayAmount, f.Collateral8Dec.address);\nconst [statsAfter, liquidatableAfter] = await Promise.all([\n    hre.Diamond.getStatisticsSCDP(),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(statsAfter.cr).to.gt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(statsAfter.crDebtValueAdjusted).to.eq(2.01e4);\n(0, _chai.expect)(liquidatableAfter).to.eq(false);\nawait (0, _chai.expect)(KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, repayAmount, f.Collateral8Dec.address)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;CANNOT_LIQUIDATE\&quot;);\nconst event = await (0, _events.getNamedEvent)(tx, \&quot;SCDPLiquidationOccured\&quot;);\nconst expectedSeizeAmount = repayAmount.wadMul((0, _values.toBig)(newKreskoAssetPrice, 8)).percentMul(1.05e4).wadDiv((0, _values.toBig)(collateralPrice, 8)).div(10 ** 10);\n(0, _chai.expect)(event.args.liquidator).to.eq(hre.users.liquidator.address);\n(0, _chai.expect)(event.args.seizeAmount).to.eq(expectedSeizeAmount);\n(0, _chai.expect)(event.args.repayAmount).to.eq(repayAmount);\n(0, _chai.expect)(event.args.seizeCollateral).to.eq(f.Collateral8Dec.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.eq(f.KrAsset2.address);\nconst expectedDepositsAfter = depositAmount8Dec.sub(event.args.seizeAmount);\n(0, _chai.expect)(expectedDepositsAfter).to.be.lt(depositAmount8Dec);\nconst [principalDeposits, depositsWithFees, params] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountScaledDepositsSCDP(depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getCurrentParametersSCDP()\n]);\n(0, _chai.expect)(principalDeposits).to.eq(expectedDepositsAfter);\n(0, _chai.expect)(depositsWithFees).to.eq(expectedDepositsAfter);\nawait KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec.mul(10));\nconst stats = await hre.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(stats.cr).to.gt(params.minCollateralRatio);\nawait (0, _chai.expect)(KreskoDepositor.withdrawSCDP(depositor.address, f.Collateral8Dec.address, expectedDepositsAfter)).to.not.be.reverted;\nconst [principalEnd, depositsWithFeesEnd] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountScaledDepositsSCDP(depositor.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(principalEnd).to.eq(0);\n(0, _chai.expect)(depositsWithFeesEnd).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;68da68d2-a8ae-4594-b58f-2590aa2502a0&quot;,&quot;parentUUID&quot;:&quot;64d6a368-e23f-4a64-a6f0-07b76feabee9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;403e2883-7d40-4212-9ef9-f393a6c1fffd&quot;,&quot;8ecb8e3f-4f28-4aa9-b652-2ec4405e9c7f&quot;,&quot;e5f9653c-d4cc-485e-8901-bf57cc308c46&quot;,&quot;68da68d2-a8ae-4594-b58f-2590aa2502a0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4712,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;title&quot;:&quot;#Error&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error \&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:77,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(depositor, _hardhat.ethers.BigNumber.from(1));\nawait Promise.all([\n    KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, 1),\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;43223985-369b-4ec7-b9fc-99c0e4dc2863&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert depositing unsupported tokens&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert depositing unsupported tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:84,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [UnsupportedToken] = await hre.deploy(\&quot;MockERC20\&quot;, {\n    args: [\n        \&quot;UnsupportedToken\&quot;,\n        \&quot;UnsupportedToken\&quot;,\n        18,\n        (0, _values.toBig)(1)\n    ]\n});\nawait UnsupportedToken.approve(hre.Diamond.address, hre.ethers.constants.MaxUint256);\nconst { deployer } = await hre.getNamedAccounts();\nawait (0, _chai.expect)(hre.Diamond.depositSCDP(deployer, UnsupportedToken.address, 1)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;INVALID_DEPOSIT_ASSET\&quot;).withArgs(UnsupportedToken.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;08813342-61c2-4eae-b28e-6fa2b2384dce&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawing without deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawing without deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoSwapper.withdrawSCDP(depositor.address, f.Collateral.address, 1)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;SCDP_WITHDRAWAL_VIOLATION\&quot;).withArgs(f.Collateral.address, 1, 0, 0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;25a6dfb1-a6e6-496a-9410-112f66448819&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawals below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:422,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(ONE_USD).mul(1000); // $1000\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0); // generates the debt\nconst deposits = await KreskoSwapper.getAccountDepositSCDP(depositor.address, f.Collateral.address);\nawait (0, _chai.expect)(KreskoDepositor.withdrawSCDP(depositor.address, f.Collateral.address, deposits)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;DEBT_EXCEEDS_COLLATERAL\&quot;).withArgs(960e8, 4800e8, 5e4);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c7edbc4-ecc7-497d-b1fb-2c998ccaf504&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals of swap owned collateral deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawals of swap owned collateral deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:388,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0);\nconst deposits = await KreskoSwapper.getSwapDepositsSCDP(f.KrAsset2.address);\n(0, _chai.expect)(deposits).to.be.gt(0);\nawait (0, _chai.expect)(KreskoSwapper.withdrawSCDP(swapper.address, f.KrAsset2.address, deposits)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;SCDP_WITHDRAWAL_VIOLATION\&quot;).withArgs(f.KrAsset2.address, swapAmount, 0, 0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed4d1a59-49a7-4ecd-b134-ecce549aeda7&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping with price below minAmountOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping with price below minAmountOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:266,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nconst [amountOut] = await KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmount);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, amountOut.add(1))).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;SWAP_SLIPPAGE\&quot;).withArgs(amountOut, amountOut.add(1));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd81c783-43e5-4c5f-b249-177a3382e529&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping unsupported asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping unsupported asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.Collateral.address, swapAmount, 0)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;INVALID_ASSET\&quot;).withArgs(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a7e8680b-72d5-44ef-8529-4a2b747a7432&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping a disabled route&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping a disabled route&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:75,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait hre.Diamond.setSwapPairsSingle({\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    enabled: false\n});\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0)).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;SWAP_NOT_ENABLED\&quot;).withArgs(f.KrAsset2.address, f.KISS.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8fd23446-acfa-4c04-bedf-c1feb0f27318&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping causes CDP to go below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping causes CDP to go below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:334,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1_500_000);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nconst tx = KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0);\nawait (0, _chai.expect)(tx).to.be.revertedWithCustomError((0, _errors.CError)(hre), \&quot;DEBT_EXCEEDS_COLLATERAL\&quot;).withArgs(\&quot;15001000000000000\&quot;, \&quot;75000000000000000\&quot;, 5e4);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;886cda98-c424-4a28-81eb-fc6520ccac7f&quot;,&quot;parentUUID&quot;:&quot;7b36d073-a66f-4d31-9759-094fdbe510e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;08813342-61c2-4eae-b28e-6fa2b2384dce&quot;,&quot;25a6dfb1-a6e6-496a-9410-112f66448819&quot;,&quot;5c7edbc4-ecc7-497d-b1fb-2c998ccaf504&quot;,&quot;ed4d1a59-49a7-4ecd-b134-ecce549aeda7&quot;,&quot;fd81c783-43e5-4c5f-b249-177a3382e529&quot;,&quot;a7e8680b-72d5-44ef-8529-4a2b747a7432&quot;,&quot;8fd23446-acfa-4c04-bedf-c1feb0f27318&quot;,&quot;886cda98-c424-4a28-81eb-fc6520ccac7f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1643,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:30000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;kresko-protocol&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>