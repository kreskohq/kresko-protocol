<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:92,&quot;tests&quot;:278,&quot;passes&quot;:245,&quot;pending&quot;:31,&quot;failures&quot;:2,&quot;start&quot;:&quot;2023-07-20T12:32:12.293Z&quot;,&quot;end&quot;:&quot;2023-07-20T12:36:25.203Z&quot;,&quot;duration&quot;:252910,&quot;testsRegistered&quot;:278,&quot;passPercent&quot;:99.19028340080972,&quot;pendingPercent&quot;:11.151079136690647,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;6a526938-b04f-454c-8671-54b9ce6349bc&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;90d161fb-9ce1-498a-aefe-365e4ca7eaa0&quot;,&quot;title&quot;:&quot;Asset Amounts &amp; Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values \&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dcd84f28-fdc1-4f05-bcf8-81792e81ba7c&quot;,&quot;parentUUID&quot;:&quot;90d161fb-9ce1-498a-aefe-365e4ca7eaa0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values \&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2732,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;user = _hardhat.default.users.testUserSeven;\noracleDecimals = await _hardhat.default.Diamond.extOracleDecimals();\nKreskoAsset = await (0, _krassets.addMockKreskoAsset)({\n    name: \&quot;KreskoAssetPrice10USD\&quot;,\n    price: collateralPrice,\n    symbol: \&quot;KreskoAssetPrice10USD\&quot;,\n    closeFee: 0.1,\n    openFee: 0.1,\n    marketOpen: true,\n    factor: 2,\n    supplyLimit: 10\n});\nCollateralAsset = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral18Dec\&quot;,\n    price: kreskoAssetPrice,\n    factor: 0.5,\n    decimals: 18\n});\nCollateralAsset8Dec = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral8Dec\&quot;,\n    price: kreskoAssetPrice,\n    factor: 0.5,\n    decimals: 8\n});\nCollateralAsset21Dec = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral21Dec\&quot;,\n    price: kreskoAssetPrice,\n    factor: 0.5,\n    decimals: 21\n});\nawait CollateralAsset.setBalance(user, (0, _lib.toBig)(startingBalance));\nawait CollateralAsset8Dec.setBalance(user, (0, _lib.toBig)(startingBalance, 8));\nawait CollateralAsset21Dec.setBalance(user, (0, _lib.toBig)(startingBalance, 21));\nawait CollateralAsset.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait CollateralAsset8Dec.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait CollateralAsset21Dec.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;951cd6d9-7fbf-417a-b3ac-0c82f8517afa&quot;,&quot;parentUUID&quot;:&quot;90d161fb-9ce1-498a-aefe-365e4ca7eaa0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fe01bc6b-d80a-420a-9f70-b4f66b817199&quot;,&quot;title&quot;:&quot;#Collateral Deposit Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit value with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nconst expectedDepositValue = (0, _lib.toBig)(50, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset.address, depositAmount);\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9de16f78-dc0f-4380-b611-20f51d16aa79&quot;,&quot;parentUUID&quot;:&quot;fe01bc6b-d80a-420a-9f70-b4f66b817199&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nconst expectedDepositValue = (0, _lib.toBig)(50, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset8Dec.address, depositAmount);\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3a22d8cc-10ae-4287-a0f9-f214d310b9c8&quot;,&quot;parentUUID&quot;:&quot;fe01bc6b-d80a-420a-9f70-b4f66b817199&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nconst expectedDepositValue = (0, _lib.toBig)(50, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset21Dec.address, depositAmount);\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5e3c1450-6f44-4b57-8d3d-de43584b98af&quot;,&quot;parentUUID&quot;:&quot;fe01bc6b-d80a-420a-9f70-b4f66b817199&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value combination of different decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value combination of different decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:148,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset.address, (0, _lib.toBig)(10));\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset8Dec.address, (0, _lib.toBig)(10, 8));\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset21Dec.address, (0, _lib.toBig)(10, 21));\nconst expectedDepositValue = (0, _lib.toBig)(150, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 30\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ea413e6-c861-4a94-8b5f-d3283a951b0f&quot;,&quot;parentUUID&quot;:&quot;fe01bc6b-d80a-420a-9f70-b4f66b817199&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9de16f78-dc0f-4380-b611-20f51d16aa79&quot;,&quot;3a22d8cc-10ae-4287-a0f9-f214d310b9c8&quot;,&quot;5e3c1450-6f44-4b57-8d3d-de43584b98af&quot;,&quot;8ea413e6-c861-4a94-8b5f-d3283a951b0f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:321,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;bfaab738-a05f-495c-8381-bfd7cfd86d54&quot;,&quot;title&quot;:&quot;#Collateral Deposit Amount&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit amount with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:130,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset.address, depositAmount);\nconst withdrawIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(user.address, CollateralAsset.address);\nconst deposits = await _hardhat.default.Diamond.collateralDeposits(user.address, CollateralAsset.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).withdrawCollateral(user.address, CollateralAsset.address, depositAmount, withdrawIndex);\nconst balance = await CollateralAsset.contract.balanceOf(user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(startingBalance));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d11e4eb3-62c5-4b5d-803e-1add8568c7e0&quot;,&quot;parentUUID&quot;:&quot;bfaab738-a05f-495c-8381-bfd7cfd86d54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit amount with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset8Dec.address, depositAmount);\nconst withdrawIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(user.address, CollateralAsset8Dec.address);\nconst deposits = await _hardhat.default.Diamond.collateralDeposits(user.address, CollateralAsset8Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).withdrawCollateral(user.address, CollateralAsset8Dec.address, depositAmount, withdrawIndex);\nconst balance = await CollateralAsset8Dec.contract.balanceOf(user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(startingBalance, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;661baafc-5b09-4f63-b1b5-3af6e32ad1ab&quot;,&quot;parentUUID&quot;:&quot;bfaab738-a05f-495c-8381-bfd7cfd86d54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:152,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset21Dec.address, depositAmount);\nconst withdrawIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(user.address, CollateralAsset21Dec.address);\nconst deposits = await _hardhat.default.Diamond.collateralDeposits(user.address, CollateralAsset21Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).withdrawCollateral(user.address, CollateralAsset21Dec.address, depositAmount, withdrawIndex);\nconst balance = await CollateralAsset21Dec.contract.balanceOf(user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(startingBalance, 21));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c4be147a-e782-4307-8911-e7af6c138d4e&quot;,&quot;parentUUID&quot;:&quot;bfaab738-a05f-495c-8381-bfd7cfd86d54&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d11e4eb3-62c5-4b5d-803e-1add8568c7e0&quot;,&quot;661baafc-5b09-4f63-b1b5-3af6e32ad1ab&quot;,&quot;c4be147a-e782-4307-8911-e7af6c138d4e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:407,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;1c66991d-1c75-4fd4-88d8-a8ae488f2edb&quot;,&quot;title&quot;:&quot;#Kresko Asset Debt Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:399,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).mintKreskoAsset(user.address, KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await _hardhat.default.Diamond.getAccountKrAssetValue(user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await _hardhat.default.Diamond.getKrAssetValue(KreskoAsset.address, mintAmount, true);\nconst kFactor = (await _hardhat.default.Diamond.kreskoAsset(KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0979e0a-0652-44c5-9023-daf57e5f7255&quot;,&quot;parentUUID&quot;:&quot;1c66991d-1c75-4fd4-88d8-a8ae488f2edb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:402,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset8Dec.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).mintKreskoAsset(user.address, KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await _hardhat.default.Diamond.getAccountKrAssetValue(user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await _hardhat.default.Diamond.getKrAssetValue(KreskoAsset.address, mintAmount, true);\nconst kFactor = (await _hardhat.default.Diamond.kreskoAsset(KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1698db4e-57bb-4042-80dc-186b77c19665&quot;,&quot;parentUUID&quot;:&quot;1c66991d-1c75-4fd4-88d8-a8ae488f2edb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:408,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).depositCollateral(user.address, CollateralAsset21Dec.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, oracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user).mintKreskoAsset(user.address, KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, oracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await _hardhat.default.Diamond.getAccountKrAssetValue(user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await _hardhat.default.Diamond.getKrAssetValue(KreskoAsset.address, mintAmount, true);\nconst kFactor = (await _hardhat.default.Diamond.kreskoAsset(KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6fbc7ac8-d4ed-44e6-8269-756bd1a7ed3e&quot;,&quot;parentUUID&quot;:&quot;1c66991d-1c75-4fd4-88d8-a8ae488f2edb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f0979e0a-0652-44c5-9023-daf57e5f7255&quot;,&quot;1698db4e-57bb-4042-80dc-186b77c19665&quot;,&quot;6fbc7ac8-d4ed-44e6-8269-756bd1a7ed3e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1209,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;3c585086-40c9-49f4-bc90-5aaf3adc5ba8&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58e395af-9b92-41f5-8d68-7b1f59f7762e&quot;,&quot;parentUUID&quot;:&quot;3c585086-40c9-49f4-bc90-5aaf3adc5ba8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b0d049c2-88c7-4387-abbb-25b73e934214&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(_hardhat.default.users.deployer.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;55602481-6d5c-4bec-9482-5685ddabbf88&quot;,&quot;parentUUID&quot;:&quot;b0d049c2-88c7-4387-abbb-25b73e934214&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets standard facet addresses&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets standard facet addresses&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetAddressesOnChain = (await _hardhat.default.Diamond.facets()).map((f)=&gt;f.facetAddress);\nconst facetAddressesArtifact = this.facets.map((f)=&gt;f.facetAddress);\n(0, _chai.expect)(facetAddressesOnChain.length).to.equal(facetAddressesArtifact.length);\n(0, _chai.expect)(facetAddressesOnChain).to.have.members(facetAddressesArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6cab5202-b17f-42e4-afaf-33747008bd5d&quot;,&quot;parentUUID&quot;:&quot;b0d049c2-88c7-4387-abbb-25b73e934214&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets selectors of standard facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets selectors of standard facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:43,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsSelectorsOnChain = (await _hardhat.default.Diamond.facets()).flatMap((f)=&gt;f.functionSelectors);\nconst facetSelectorsOnArtifact = this.facets.flatMap((f)=&gt;f.functionSelectors);\n(0, _chai.expect)(facetsSelectorsOnChain.length).to.equal(facetSelectorsOnArtifact.length);\n(0, _chai.expect)(facetsSelectorsOnChain).to.have.members(facetSelectorsOnArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3a97cce7-efea-4cdb-9a8d-be4ea9d68568&quot;,&quot;parentUUID&quot;:&quot;b0d049c2-88c7-4387-abbb-25b73e934214&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;55602481-6d5c-4bec-9482-5685ddabbf88&quot;,&quot;6cab5202-b17f-42e4-afaf-33747008bd5d&quot;,&quot;3a97cce7-efea-4cdb-9a8d-be4ea9d68568&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:126,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;7b4cd8b9-fb00-44a9-952c-389fd1adefe9&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2c925931-2d6a-4de6-928e-fb9d135fbc7c&quot;,&quot;parentUUID&quot;:&quot;7b4cd8b9-fb00-44a9-952c-389fd1adefe9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0894dc73-25d4-4f29-b62b-07eae9b1d78f&quot;,&quot;title&quot;:&quot;#ownership&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(_hardhat.default.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;32f8710e-db2e-41e7-8882-d2ed93c563a3&quot;,&quot;parentUUID&quot;:&quot;0894dc73-25d4-4f29-b62b-07eae9b1d78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct default admin role&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct default admin role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_test.Role.ADMIN, _hardhat.default.addr.deployer)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ab7f927a-c711-45a3-a312-16f39734f06b&quot;,&quot;parentUUID&quot;:&quot;0894dc73-25d4-4f29-b62b-07eae9b1d78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets a new pending owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets a new pending owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:42,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = _hardhat.default.users.userOne;\nawait _hardhat.default.Diamond.transferOwnership(pendingOwner.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.pendingOwner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc20c27f-aff6-4bb5-892a-b5906209651c&quot;,&quot;parentUUID&quot;:&quot;0894dc73-25d4-4f29-b62b-07eae9b1d78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets the pending owner as new owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets the pending owner as new owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:74,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = _hardhat.default.users.userOne;\nawait _hardhat.default.Diamond.transferOwnership(pendingOwner.address);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, pendingOwner).acceptOwnership();\n(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;26c9d5ef-48f9-48e0-8da3-6aa4863469f5&quot;,&quot;parentUUID&quot;:&quot;0894dc73-25d4-4f29-b62b-07eae9b1d78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;32f8710e-db2e-41e7-8882-d2ed93c563a3&quot;,&quot;ab7f927a-c711-45a3-a312-16f39734f06b&quot;,&quot;bc20c27f-aff6-4bb5-892a-b5906209651c&quot;,&quot;26c9d5ef-48f9-48e0-8da3-6aa4863469f5&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:155,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;acbd309a-5fc9-419c-bf70-31ab886ea429&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9fe7589a-f42e-4a7e-a95e-c0f03d5e9212&quot;,&quot;parentUUID&quot;:&quot;acbd309a-5fc9-419c-bf70-31ab886ea429&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;title&quot;:&quot;#upgrades&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can add a new facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can add a new facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:357,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await _hardhat.default.deploy(\&quot;SmockInit\&quot;);\nconst signatures = _hardhat.default.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(_hardhat.default.addr.userOne);\nawait _hardhat.default.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst TEST_OPERATOR_ROLE = _hardhat.default.ethers.utils.id(\&quot;kresko.test.operator\&quot;);\nconst isTestOperator = await _hardhat.default.Diamond.hasRole(TEST_OPERATOR_ROLE, _hardhat.default.addr.userOne);\n// Succesfully added the new operator through the initialization contract\n(0, _chai.expect)(isTestOperator).to.equal(true);\nconst Facet = await _hardhat.default.ethers.getContractAt([\n    ..._typechain.SmockFacet__factory.abi\n], _hardhat.default.Diamond.address);\n// Ensure facet has it&#x27;s own storage\nconst operatorFromNewStorage = await Facet.operator(); // Retrieved from SmockStorage\n(0, _chai.expect)(operatorFromNewStorage).to.equal(_hardhat.default.addr.userOne);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1408705b-34c6-424c-b7b2-398bbabea47a&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:433,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const NewFacet = await (0, _addfacet.addFacet)({\n    name: \&quot;SmockFacet\&quot;,\n    initializerName: \&quot;SmockInit\&quot;,\n    initializerArgs: _hardhat.default.addr.userOne\n});\nconst facetsBefore = await _hardhat.default.Diamond.facets();\n(0, _chai.expect)(facetsBefore.filter((f)=&gt;f.facetAddress === NewFacet.address).length).to.equal(1);\nawait (0, _removefacet.removeFacet)({\n    name: \&quot;SmockFacet\&quot;\n});\nconst facetsAfter = await _hardhat.default.Diamond.facets();\n(0, _chai.expect)(facetsBefore.length - facetsAfter.length).to.equal(1);\n(0, _chai.expect)(facetsAfter).to.not.deep.contain(NewFacet.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;de26eddf-1f6d-4993-8620-e553dd37e876&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:178,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Delete acceptOwnership from DiamondOwnershipFacet\n// Check there is no pending owner\nlet pendingOwner = await _hardhat.default.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(_hardhat.default.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = _hardhat.default.addr.nonadmin;\nawait _hardhat.default.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await _hardhat.default.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = _hardhat.default.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = _hardhat.default.ethers.utils.Interface.getSighash(functionFragment);\nconst facetAddress = await _hardhat.default.Diamond.facetAddress(signature);\nconst functions = await _hardhat.default.Diamond.facetFunctionSelectors(facetAddress);\nconst Cut = {\n    facetAddress: _hardhat.default.ethers.constants.AddressZero,\n    action: _types.FacetCutAction.Remove,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = _hardhat.default.addr.userOne;\nconst initData = await _hardhat.default.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await _hardhat.default.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure rest of the functions remain\nconst functionsAfterCut = await _hardhat.default.Diamond.facetFunctionSelectors(facetAddress);\n(0, _chai.expect)(functionsAfterCut.length).to.equal(functions.length - 1);\n// Ensure delegatecall did set the correct pending owner with the cut\nconst contract = await _hardhat.default.ethers.getContractAt(\&quot;AuthEvent\&quot;, _hardhat.default.Diamond.address);\nconst filter = contract.filters[\&quot;PendingOwnershipTransfer(address,address)\&quot;](_hardhat.default.addr.deployer, correctOwner);\nconst [event] = await _hardhat.default.Diamond.queryFilter(filter);\nconst { previousOwner , newOwner  } = event.args;\n(0, _chai.expect)(previousOwner).to.equal(_hardhat.default.addr.deployer);\n(0, _chai.expect)(newOwner).to.equal(correctOwner);\n// Ensure there is no function to accept the ownership\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.nonadmin).acceptOwnership()).to.be.revertedWith(_test.Error.DIAMOND_INVALID_FUNCTION_SIGNATURE);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;TypeError: Cannot destructure property &#x27;previousOwner&#x27; of &#x27;event.args&#x27; as it is undefined.&quot;,&quot;estack&quot;:&quot;TypeError: Cannot destructure property &#x27;previousOwner&#x27; of &#x27;event.args&#x27; as it is undefined.\n    at Context.&lt;anonymous&gt; (src/test/diamond/02-upgrades.ts:110:21)\n    at runMicrotasks (&lt;anonymous&gt;)\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\n    at runNextTicks (node:internal/process/task_queues:65:3)\n    at listOnTimeout (node:internal/timers:526:9)\n    at processTimers (node:internal/timers:500:7)&quot;},&quot;uuid&quot;:&quot;cb5b5e47-6de5-42fa-8a1f-e2414638f9e0&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can replace a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can replace a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:258,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Same as above but instead replace the function\n// Check there is no pending owner\nlet pendingOwner = await _hardhat.default.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(_hardhat.default.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = _hardhat.default.addr.nonadmin;\nawait _hardhat.default.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await _hardhat.default.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = _hardhat.default.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = _hardhat.default.ethers.utils.Interface.getSighash(functionFragment);\nconst OldOwnershipFacet = await _hardhat.default.Diamond.facetAddress(signature);\nconst [NewOwnershipFacet, allOwnershipFacetSignatures] = await _hardhat.default.deploy(\&quot;DiamondOwnershipFacet\&quot;, {\n    deploymentName: \&quot;DiamondOwnershipFacet2\&quot;\n});\n// Only replace a single function, we could replace all of them\nconst Cut = {\n    facetAddress: NewOwnershipFacet.address,\n    action: _types.FacetCutAction.Replace,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = _hardhat.default.addr.userOne;\nconst initData = await _hardhat.default.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await _hardhat.default.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure function exists and revert is for invalid address instead of missing function\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.nonadmin).acceptOwnership()).to.be.revertedWith(_test.Error.DIAMOND_INVALID_PENDING_OWNER);\n// Ensure one function is contained in the new facet\nconst functionsNewFacet = await _hardhat.default.Diamond.facetFunctionSelectors(NewOwnershipFacet.address);\n(0, _chai.expect)(functionsNewFacet.length).to.equal(1);\n(0, _chai.expect)(functionsNewFacet).to.have.members([\n    signature\n]);\n// Ensure rest are in the previous one\nconst functionsOldFacet = await _hardhat.default.Diamond.facetFunctionSelectors(OldOwnershipFacet);\n(0, _chai.expect)(functionsOldFacet).to.not.have.members([\n    signature\n]);\n(0, _chai.expect)(functionsOldFacet.length).to.equal(allOwnershipFacetSignatures.length - 1);\n// Ensure correct owner can now accept the ownership\n(0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).acceptOwnership());\nconst currentOwner = await _hardhat.default.Diamond.owner();\n(0, _chai.expect)(currentOwner).to.equal(correctOwner);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;472f44b9-50a7-4b32-9397-e7e0561b8be5&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can upgrade state&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can upgrade state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:588,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);\nconst Factory = await _smock.smock.mock(\&quot;SmockInit\&quot;);\nconst SmockInit = await Factory.deploy();\nconst tx = await SmockInit.populateTransaction.upgradeState();\nawait _hardhat.default.Diamond.upgradeState(tx.to, tx.data);\n(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51946e28-1fcd-4a28-a4ea-48248dca32b4&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can preserve old state when extending storage layout&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can preserve old state when extending storage layout&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:648,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);\n// Add the first facet\nconst Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await _hardhat.default.deploy(\&quot;SmockInit\&quot;);\nconst signatures = _hardhat.default.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(_hardhat.default.addr.userOne);\nawait _hardhat.default.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst Diamond = await _hardhat.default.ethers.getContractAt(\&quot;SmockFacet\&quot;, _hardhat.default.Diamond.address);\nconst isInitialized = await Diamond.smockInitialized();\n(0, _chai.expect)(isInitialized).to.equal(true);\n// Add facet with extended state\n// Add the first facet\nconst Factory2 = await _smock.smock.mock(\&quot;SmockFacet2\&quot;);\nconst SmockFacet2 = await Factory2.deploy();\nconst signatures2 = _hardhat.default.getSignatures([\n    ..._typechain.SmockFacet2__factory.abi\n]);\nconst Cut2 = {\n    facetAddress: SmockFacet2.address,\n    functionSelectors: signatures2,\n    action: _types.FacetCutAction.Add\n};\n// Initializer only sets the new extended value, does not touch old storage\nconst initData2 = await SmockFacet2.populateTransaction.initialize();\nawait _hardhat.default.Diamond.diamondCut([\n    Cut2\n], initData2.to, initData2.data);\n// Here we have appended the storage layout with the `extended` bool property.\nconst DiamondExtended = await _hardhat.default.ethers.getContractAt(\&quot;SmockFacet2\&quot;, _hardhat.default.Diamond.address);\nconst initializedAfterExtend = await DiamondExtended.getOldStructValueFromExtended();\nconst extendedValue = await DiamondExtended.getNewStructValueFromExtended();\n// Old values remain\n(0, _chai.expect)(initializedAfterExtend).to.equal(true);\n// And we get new ones\n(0, _chai.expect)(extendedValue).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6992b06a-27c5-4dc9-b8bd-7862de3e49d4&quot;,&quot;parentUUID&quot;:&quot;e5438bae-ce07-4543-bbb8-9cf073452b56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1408705b-34c6-424c-b7b2-398bbabea47a&quot;,&quot;de26eddf-1f6d-4993-8620-e553dd37e876&quot;,&quot;472f44b9-50a7-4b32-9397-e7e0561b8be5&quot;,&quot;51946e28-1fcd-4a28-a4ea-48248dca32b4&quot;,&quot;6992b06a-27c5-4dc9-b8bd-7862de3e49d4&quot;],&quot;failures&quot;:[&quot;cb5b5e47-6de5-42fa-8a1f-e2414638f9e0&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2462,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;08c89987-8c67-486d-82af-7f0adbd105f3&quot;,&quot;title&quot;:&quot;Forking&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;15755008-b787-4ddc-ae2b-2a98c7484cd7&quot;,&quot;title&quot;:&quot;#setup&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should get Kresko from the companion network locally&quot;,&quot;fullTitle&quot;:&quot;Forking #setup should get Kresko from the companion network locally&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c924c3d1-3345-4749-bff6-20ed3057865c&quot;,&quot;parentUUID&quot;:&quot;15755008-b787-4ddc-ae2b-2a98c7484cd7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;c924c3d1-3345-4749-bff6-20ed3057865c&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;6894c346-6dfb-4cd1-8f52-bd481287f7e4&quot;,&quot;title&quot;:&quot;#rate-upgrade-11-04-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deploy facets&quot;,&quot;fullTitle&quot;:&quot;Forking #rate-upgrade-11-04-2023 should be able to deploy facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ea4c73a-6e50-4f48-aecc-3815f2302418&quot;,&quot;parentUUID&quot;:&quot;6894c346-6dfb-4cd1-8f52-bd481287f7e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;9ea4c73a-6e50-4f48-aecc-3815f2302418&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;0fcc8c82-4c89-455e-be4c-7be4031d6640&quot;,&quot;title&quot;:&quot;#facet-upgrade-16-05-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;works&quot;,&quot;fullTitle&quot;:&quot;Forking #facet-upgrade-16-05-2023 works&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f5362c19-a1cf-424e-971e-ef8867ce19d8&quot;,&quot;parentUUID&quot;:&quot;0fcc8c82-4c89-455e-be4c-7be4031d6640&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;f5362c19-a1cf-424e-971e-ef8867ce19d8&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;90668d24-8bca-4923-af87-de4e78d459dd&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2eafbfcf-73e4-4730-99fd-9592f09c78b1&quot;,&quot;parentUUID&quot;:&quot;90668d24-8bca-4923-af87-de4e78d459dd&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;title&quot;:&quot;#initialization - anchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor \&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = this.krAssets.find((k)=&gt;k.deployArgs.name === name);\nKreskoAsset = deployment.contract;\nKreskoAssetAnchor = deployment.anchor;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e42ce6cb-fcfc-4fd6-b526-86bd66cb9d68&quot;,&quot;parentUUID&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAsset.initialize(name, symbol, 18, _hardhat.default.addr.deployer, _hardhat.default.Diamond.address)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2d5846b1-8b14-40f3-be84-aa06b87af25f&quot;,&quot;parentUUID&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = await _hardhat.default.deployments.get(symbol);\nconst implementationAddress = deployment.implementation;\n(0, _chai.expect)(implementationAddress).to.not.equal(_hardhat.default.ethers.constants.AddressZero);\nconst KreskoAssetImpl = await _hardhat.default.ethers.getContractAt(\&quot;KreskoAsset\&quot;, implementationAddress);\nawait (0, _chai.expect)(KreskoAssetImpl.initialize(name, symbol, 18, _hardhat.default.addr.deployer, _hardhat.default.Diamond.address)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;61ac40f8-9c28-4e99-91b5-980bce693cca&quot;,&quot;parentUUID&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:33,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.name()).to.equal(name);\n(0, _chai.expect)(await KreskoAsset.symbol()).to.equal(symbol);\n(0, _chai.expect)(await KreskoAsset.kresko()).to.equal(_hardhat.default.Diamond.address);\n(0, _chai.expect)(await KreskoAsset.hasRole(_test.Role.ADMIN, _hardhat.default.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await KreskoAsset.hasRole(_test.Role.OPERATOR, _hardhat.default.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(\&quot;64000000000000000000\&quot;);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;986403e4-a7c5-48b5-9f54-3cc4f4b29ef1&quot;,&quot;parentUUID&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(KreskoAsset.reinitializeERC20(newName, newSymbol, 2)).to.not.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);\n(0, _chai.expect)(await KreskoAsset.name()).to.equal(newName);\n(0, _chai.expect)(await KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e9e4deb3-0268-4a94-a35c-530d3b114803&quot;,&quot;parentUUID&quot;:&quot;46b00c1c-8bd5-4e08-9f7b-b5479130840e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2d5846b1-8b14-40f3-be84-aa06b87af25f&quot;,&quot;61ac40f8-9c28-4e99-91b5-980bce693cca&quot;,&quot;986403e4-a7c5-48b5-9f54-3cc4f4b29ef1&quot;,&quot;e9e4deb3-0268-4a94-a35c-530d3b114803&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:88,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;title&quot;:&quot;#initialization - wrapped&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - wrapped\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped \&quot;before each\&quot; hook in \&quot;#initialization - wrapped\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = _hardhat.default.krAssets.find((k)=&gt;k.deployArgs.name === name);\nKreskoAsset = deployment.contract;\nKreskoAssetAnchor = deployment.anchor;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;69ce4b58-74bd-4d2e-be48-87ac66ed9de8&quot;,&quot;parentUUID&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAssetAnchor.initialize(KreskoAsset.address, name, symbol, _hardhat.default.addr.deployer)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;305a82f1-9831-46cd-bba0-aec0aea06013&quot;,&quot;parentUUID&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:21,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = await _hardhat.default.deployments.get(_shared.anchorTokenPrefix + symbol);\nconst implementationAddress = deployment.implementation;\n(0, _chai.expect)(implementationAddress).to.not.equal(_hardhat.default.ethers.constants.AddressZero);\nconst KreskoAssetAnchorImpl = await _hardhat.default.ethers.getContractAt(\&quot;KreskoAssetAnchor\&quot;, implementationAddress);\nawait (0, _chai.expect)(KreskoAssetAnchorImpl.initialize(KreskoAsset.address, name, symbol, _hardhat.default.addr.deployer)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;824ea0c8-9933-4763-b754-411faddf1fbf&quot;,&quot;parentUUID&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(KreskoAssetAnchor.reinitializeERC20(newName, newSymbol, 2)).to.not.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);\n(0, _chai.expect)(await KreskoAssetAnchor.name()).to.equal(newName);\n(0, _chai.expect)(await KreskoAssetAnchor.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;380cb85f-9c14-4239-9935-c70fe7549499&quot;,&quot;parentUUID&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAssetAnchor.name()).to.equal(name);\n(0, _chai.expect)(await KreskoAssetAnchor.symbol()).to.equal(_shared.anchorTokenPrefix + symbol);\n(0, _chai.expect)(await KreskoAssetAnchor.asset()).to.equal(KreskoAsset.address);\n(0, _chai.expect)(await KreskoAssetAnchor.hasRole(_test.Role.ADMIN, _hardhat.default.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await KreskoAssetAnchor.hasRole(_test.Role.OPERATOR, _hardhat.default.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(\&quot;64000000000000000000\&quot;);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(await KreskoAsset.totalSupply());\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;876fa975-4844-4687-9871-ee2af51881dc&quot;,&quot;parentUUID&quot;:&quot;4a9204d5-d7e6-4abd-b6fb-8354892de5a0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;305a82f1-9831-46cd-bba0-aec0aea06013&quot;,&quot;824ea0c8-9933-4763-b754-411faddf1fbf&quot;,&quot;380cb85f-9c14-4239-9935-c70fe7549499&quot;,&quot;876fa975-4844-4687-9871-ee2af51881dc&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:113,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;a0e2f683-cc91-41f3-9a17-503e49e2b27d&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6a1ce56-c2b7-42dc-b3f0-1b13d352f4d8&quot;,&quot;parentUUID&quot;:&quot;a0e2f683-cc91-41f3-9a17-503e49e2b27d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.owner = _hardhat.default.users.deployer;\nthis.krAsset = _hardhat.default.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _test.defaultKrAssetArgs.symbol);\nthis.mintAmount = 125;\nawait this.krAsset.contract.grantRole(_test.Role.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;149f990a-3a0e-4fae-bcf9-066a43d793fb&quot;,&quot;parentUUID&quot;:&quot;a0e2f683-cc91-41f3-9a17-503e49e2b27d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;9d05fdca-a2d8-42ca-ad08-6e6533050f5a&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to mint to their own address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the owner to mint to their own address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\nawait this.krAsset.contract.connect(this.owner).mint(this.owner.address, this.mintAmount);\n// Check total supply and owner&#x27;s balances increased\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;976d7bdf-4b4e-40f8-8a39-1381fc05ce05&quot;,&quot;parentUUID&quot;:&quot;9d05fdca-a2d8-42ca-ad08-6e6533050f5a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the asset owner to mint to another address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the asset owner to mint to another address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(0);\nawait this.krAsset.contract.connect(this.owner).mint(_hardhat.default.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances increased\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;76a190d3-4f7a-4ffc-b421-d7aded326e18&quot;,&quot;parentUUID&quot;:&quot;9d05fdca-a2d8-42ca-ad08-6e6533050f5a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-owner addresses to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow non-owner addresses to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\nawait (0, _chai.expect)(this.krAsset.contract.connect(_hardhat.default.users.userOne).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.userOne.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and all account balances unchanged\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0c761a56-c605-4e18-a429-9ad2faf3d8c5&quot;,&quot;parentUUID&quot;:&quot;9d05fdca-a2d8-42ca-ad08-6e6533050f5a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow admin to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow admin to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:71,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.krAsset.contract.renounceRole(_test.Role.OPERATOR, this.owner.address);\nawait (0, _chai.expect)(this.krAsset.contract.connect(_hardhat.default.users.admin).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.admin.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e4b26a05-ca8e-4c05-af02-2361b30bbc63&quot;,&quot;parentUUID&quot;:&quot;9d05fdca-a2d8-42ca-ad08-6e6533050f5a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;976d7bdf-4b4e-40f8-8a39-1381fc05ce05&quot;,&quot;76a190d3-4f7a-4ffc-b421-d7aded326e18&quot;,&quot;0c761a56-c605-4e18-a429-9ad2faf3d8c5&quot;,&quot;e4b26a05-ca8e-4c05-af02-2361b30bbc63&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:172,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.mintAmount = 250;\nawait this.krAsset.contract.connect(this.owner).mint(_hardhat.default.users.userOne.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;abe7e838-1cb2-4ffc-a9a0-a476c01f855b&quot;,&quot;parentUUID&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\nawait this.krAsset.contract.connect(this.owner).burn(_hardhat.default.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7f1c9bcd-30ac-413b-891d-3b6b73c75b4b&quot;,&quot;parentUUID&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:72,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.krAsset.contract.connect(this.owner).approve(_hardhat.default.users.userOne.address, this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.allowance(this.owner.address, _hardhat.default.users.userOne.address)).to.equal(this.mintAmount);\nawait this.krAsset.contract.connect(this.owner).burn(_hardhat.default.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that token allowances are unchanged\n(0, _chai.expect)(await this.krAsset.contract.allowance(this.owner.address, _hardhat.default.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;afb9fe62-a5f9-4b39-bb83-bea7eacb62d9&quot;,&quot;parentUUID&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the operator to burn more tokens than user holds&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow the operator to burn more tokens than user holds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalance = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\nconst overUserBalance = Number(userBalance) + 1;\nawait (0, _chai.expect)(this.krAsset.contract.connect(this.owner).burn(_hardhat.default.users.userOne.address, overUserBalance)).to.be.reverted;\n// Check total supply and user&#x27;s balances are unchanged\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d9a132e1-ee52-4d1a-9f6e-5baaee9fe61b&quot;,&quot;parentUUID&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-operator addresses to burn tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow non-operator addresses to burn tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(this.krAsset.contract.connect(_hardhat.default.users.userTwo).burn(_hardhat.default.users.userOne.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.userTwo.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and user&#x27;s balances unchanged\n(0, _chai.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;43bbb6d6-c628-4d0b-9635-5067ff8db8c3&quot;,&quot;parentUUID&quot;:&quot;be0a406f-9d14-445b-90e0-1ea64522c73d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7f1c9bcd-30ac-413b-891d-3b6b73c75b4b&quot;,&quot;afb9fe62-a5f9-4b39-bb83-bea7eacb62d9&quot;,&quot;d9a132e1-ee52-4d1a-9f6e-5baaee9fe61b&quot;,&quot;43bbb6d6-c628-4d0b-9635-5067ff8db8c3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:165,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;4de4f684-68d0-4e76-9dc3-5109ad47025e&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7c25b570-b0dd-4657-ac92-a83c2d0bb0eb&quot;,&quot;parentUUID&quot;:&quot;4de4f684-68d0-4e76-9dc3-5109ad47025e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;KreskoAsset = hre.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _test.defaultKrAssetArgs.symbol).contract;\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_test.Role.OPERATOR, hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;471bc2e0-72d6-47af-a5aa-4af5d39d6e53&quot;,&quot;parentUUID&quot;:&quot;4de4f684-68d0-4e76-9dc3-5109ad47025e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5e67cc61-24dd-4406-90cc-8a79ba046121&quot;,&quot;title&quot;:&quot;#rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can set a positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(\&quot;1.525\&quot;);\nconst positive = true;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1aee1689-6b26-4eeb-bc1e-08e40193a6ba&quot;,&quot;parentUUID&quot;:&quot;5e67cc61-24dd-4406-90cc-8a79ba046121&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can set a negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(\&quot;1.525\&quot;);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;086b2b6a-d267-4228-82e1-94743fe42745&quot;,&quot;parentUUID&quot;:&quot;5e67cc61-24dd-4406-90cc-8a79ba046121&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can be disabled by setting the denominator to 1 ether&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can be disabled by setting the denominator to 1 ether&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:48,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(1);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fce7991a-7d0b-4c58-b729-3df6f97bb650&quot;,&quot;parentUUID&quot;:&quot;5e67cc61-24dd-4406-90cc-8a79ba046121&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;title&quot;:&quot;#balance + supply&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has no effect when not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply has no effect when not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;27c4d22c-ee67-474b-91cc-04dd5c0bb0a7&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9a118156-7c75-4e95-a4c8-a32e94aa21d5&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3e8aa026-4aad-4456-a63d-4df3a76ed356&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase  @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase  @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ecde3ae6-824b-4ee5-bc84-ab72293cd988&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4f188ddf-4762-4c7c-86ab-23d4e49f6ba1&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:35,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e0766751-149c-4fcc-b87d-88384ce4157e&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0687b8d7-ffa0-4b0a-9e43-35189bc54acf&quot;,&quot;parentUUID&quot;:&quot;e81869f1-25c3-4ee9-b21b-ee2b2c336789&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;27c4d22c-ee67-474b-91cc-04dd5c0bb0a7&quot;,&quot;9a118156-7c75-4e95-a4c8-a32e94aa21d5&quot;,&quot;3e8aa026-4aad-4456-a63d-4df3a76ed356&quot;,&quot;ecde3ae6-824b-4ee5-bc84-ab72293cd988&quot;,&quot;4f188ddf-4762-4c7c-86ab-23d4e49f6ba1&quot;,&quot;e0766751-149c-4fcc-b87d-88384ce4157e&quot;,&quot;0687b8d7-ffa0-4b0a-9e43-35189bc54acf&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:208,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;title&quot;:&quot;#transfer&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has default transfer behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5eb951a5-6245-4151-ada5-631de96a135c&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transfer behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca3f1aa4-79e8-4057-ab84-f3d2caca253f&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:114,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bd75256a-c542-4f7b-b483-fb62b3bdf67e&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:117,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 100;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c9d8dc15-72b1-4531-ae04-815c545b3e8c&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:112,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;37e4bff2-8622-453b-88ce-e0fdfcbefbc5&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 100;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b520507-f80f-4ed0-ac3a-95f1cff10836&quot;,&quot;parentUUID&quot;:&quot;3f7610af-ff52-4833-a323-ca9d00bc0597&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5eb951a5-6245-4151-ada5-631de96a135c&quot;,&quot;ca3f1aa4-79e8-4057-ab84-f3d2caca253f&quot;,&quot;bd75256a-c542-4f7b-b483-fb62b3bdf67e&quot;,&quot;c9d8dc15-72b1-4531-ae04-815c545b3e8c&quot;,&quot;37e4bff2-8622-453b-88ce-e0fdfcbefbc5&quot;,&quot;9b520507-f80f-4ed0-ac3a-95f1cff10836&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:565,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;1aee1689-6b26-4eeb-bc1e-08e40193a6ba&quot;,&quot;086b2b6a-d267-4228-82e1-94743fe42745&quot;,&quot;fce7991a-7d0b-4c58-b729-3df6f97bb650&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:84,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;dd02a63b-6c41-44bd-9a35-d16761986fe9&quot;,&quot;title&quot;:&quot;KreskoAssetAnchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b942ef46-7fb7-4973-9fc0-e64e5556309e&quot;,&quot;parentUUID&quot;:&quot;dd02a63b-6c41-44bd-9a35-d16761986fe9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const asset = hre.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _test.defaultKrAssetArgs.symbol);\nKreskoAsset = asset.contract;\nKreskoAssetAnchor = asset.anchor;\n// Grant minting rights for test deployer\nawait Promise.all([\n    KreskoAsset.grantRole(_test.Role.OPERATOR, hre.addr.deployer),\n    KreskoAssetAnchor.grantRole(_test.Role.OPERATOR, hre.addr.deployer),\n    KreskoAsset.approve(KreskoAssetAnchor.address, hre.ethers.constants.MaxUint256)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f23b442f-2efd-4744-b838-da7a155e8271&quot;,&quot;parentUUID&quot;:&quot;dd02a63b-6c41-44bd-9a35-d16761986fe9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;title&quot;:&quot;#minting and burning&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;tracks the supply of underlying&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning tracks the supply of underlying&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_test.defaultMintAmount.add(_test.defaultMintAmount));\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8a14944e-619c-49db-8830-69c9f18c228c&quot;,&quot;parentUUID&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning mints 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;28fa4eab-654c-4965-b2d5-6dbd27ea94e4&quot;,&quot;parentUUID&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning deposits 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;afbc1513-b7d5-4f02-aa89-4b33f1218f1f&quot;,&quot;parentUUID&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;redeems 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning redeems 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;455fc073-a411-4b36-b20e-8c9da3146813&quot;,&quot;parentUUID&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;withdraws 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning withdraws 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;588e423b-c8c4-4785-8870-ba01dccf0214&quot;,&quot;parentUUID&quot;:&quot;52347445-8444-40f3-b469-073da4130b63&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;7a49e398-de0a-4e3c-92e0-2b906af93912&quot;,&quot;title&quot;:&quot;#rebases&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;title&quot;:&quot;#conversions&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8cd9d9fc-08df-4c8b-9115-e501279af332&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b053b281-5d96-49a3-bde9-fc0edf391f7b&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;81038e97-e9c3-489f-bbd9-68a02c261b3a&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;190a4f87-d731-4646-a17e-a798b6db3f7d&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1db8e580-ccfc-40f1-bfa7-60880144e439&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d34bca7f-bc14-49ec-90bf-e83d8217060a&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e3fb23b5-9d9b-4bd8-88fd-86808e7a99b4&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e5fdca62-1222-4f18-94a9-37a0f1681783&quot;,&quot;parentUUID&quot;:&quot;c9768f99-3d00-442e-8e0c-2e190df598e2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;8cd9d9fc-08df-4c8b-9115-e501279af332&quot;,&quot;b053b281-5d96-49a3-bde9-fc0edf391f7b&quot;,&quot;81038e97-e9c3-489f-bbd9-68a02c261b3a&quot;,&quot;190a4f87-d731-4646-a17e-a798b6db3f7d&quot;,&quot;1db8e580-ccfc-40f1-bfa7-60880144e439&quot;,&quot;d34bca7f-bc14-49ec-90bf-e83d8217060a&quot;,&quot;e3fb23b5-9d9b-4bd8-88fd-86808e7a99b4&quot;,&quot;e5fdca62-1222-4f18-94a9-37a0f1681783&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;8a14944e-619c-49db-8830-69c9f18c228c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;28fa4eab-654c-4965-b2d5-6dbd27ea94e4&quot;,&quot;afbc1513-b7d5-4f02-aa89-4b33f1218f1f&quot;,&quot;455fc073-a411-4b36-b20e-8c9da3146813&quot;,&quot;588e423b-c8c4-4785-8870-ba01dccf0214&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:39,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;08b1808b-bd55-44d8-af49-f94e294df487&quot;,&quot;title&quot;:&quot;Test KreskoAsset with Rebase and sync&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Test KreskoAsset with Rebase and sync\&quot;&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync \&quot;before each\&quot; hook in \&quot;Test KreskoAsset with Rebase and sync\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7548c56c-75ed-41d9-9c2b-e65495598840&quot;,&quot;parentUUID&quot;:&quot;08b1808b-bd55-44d8-af49-f94e294df487&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Test KreskoAsset with Rebase and sync\&quot;&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync \&quot;before each\&quot; hook in \&quot;Test KreskoAsset with Rebase and sync\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;KreskoAsset = _hardhat.default.krAssets.find((asset)=&gt;asset.deployArgs.symbol === \&quot;krETH\&quot;).contract;\nconst KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nconst Pair = await (await _hardhat.default.getContractOrFork(\&quot;UniswapV2Factory\&quot;)).getPair(KreskoAsset.address, KISS.address);\n// address of KISS-krETH pool\nthis.pool = await _hardhat.ethers.getContractAt(\&quot;UniswapV2Pair\&quot;, Pair);\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_test.Role.OPERATOR, _hardhat.default.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;da4a2069-94c1-4b53-af0c-eaf670de141b&quot;,&quot;parentUUID&quot;:&quot;08b1808b-bd55-44d8-af49-f94e294df487&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nconst beforeTotalSupply = await KreskoAsset.totalSupply();\nconst [beforeReserve0, beforeReserve1, beforeTimestamp] = await this.pool.getReserves();\nawait KreskoAsset.mint(_hardhat.default.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nconst [afterReserve0, afterReserve1, afterTimestamp] = await this.pool.getReserves();\n(0, _chai.expect)(await KreskoAsset.balanceOf(_hardhat.default.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(beforeTotalSupply.add(_test.defaultMintAmount).mul(denominator));\n(0, _chai.expect)(afterReserve0).to.equal(beforeReserve0);\n(0, _chai.expect)(afterReserve1).to.equal(beforeReserve1);\n(0, _chai.expect)(beforeTimestamp).to.equal(afterTimestamp);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;748316df-e8bc-4fbb-860d-f4989e7594ba&quot;,&quot;parentUUID&quot;:&quot;08b1808b-bd55-44d8-af49-f94e294df487&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nconst [beforeReserve0, beforeReserve1, beforeTimestamp] = await this.pool.getReserves();\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, [\n    this.pool.address\n]);\nconst [afterReserve0, afterReserve1, afterTimestamp] = await this.pool.getReserves();\nif (beforeReserve0.eq(afterReserve0)) {\n    (0, _chai.expect)(afterReserve1).to.equal(beforeReserve1.mul(denominator));\n} else {\n    (0, _chai.expect)(afterReserve0).to.equal(beforeReserve0.mul(denominator));\n}\n(0, _chai.expect)(afterTimestamp).to.gt(beforeTimestamp);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0adf9b8c-9949-4c23-9392-8c0dea905433&quot;,&quot;parentUUID&quot;:&quot;08b1808b-bd55-44d8-af49-f94e294df487&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;748316df-e8bc-4fbb-860d-f4989e7594ba&quot;,&quot;0adf9b8c-9949-4c23-9392-8c0dea905433&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:58,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;04e31e61-ad8b-43be-a9d9-1e99ae4446d8&quot;,&quot;title&quot;:&quot;Minter - Init&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Init\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Init \&quot;before each\&quot; hook in \&quot;Minter - Init\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e30bd124-24c2-40e9-acac-371c1f33f017&quot;,&quot;parentUUID&quot;:&quot;04e31e61-ad8b-43be-a9d9-1e99ae4446d8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;33eefa93-70e8-4a9a-bd3c-96dd6e5c6960&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct initial state&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization sets correct initial state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:143,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.minterInitializations()).to.equal(1);\nconst { args  } = await (0, _shared.getMinterInitializer)(_hardhat.default);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_test.Role.ADMIN, args.admin)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_test.Role.SAFETY_COUNCIL, _hardhat.default.Multisig.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.feeRecipient()).to.equal(args.treasury);\n(0, _chai.expect)(await _hardhat.default.Diamond.liquidationIncentiveMultiplier()).to.equal(0);\n(0, _chai.expect)(await _hardhat.default.Diamond.minimumCollateralizationRatio()).to.equal(args.minimumCollateralizationRatio);\n(0, _chai.expect)(await _hardhat.default.Diamond.minimumDebtValue()).to.equal(args.minimumDebtValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d470a941-a850-4621-b27b-7ff9c2564ae5&quot;,&quot;parentUUID&quot;:&quot;33eefa93-70e8-4a9a-bd3c-96dd6e5c6960&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:72,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.minterInitializations()).to.equal(1);\nconst initializer = await (0, _shared.getMinterInitializer)(_hardhat.default);\nconst initializerContract = await _hardhat.default.getContractOrFork(initializer.name);\nconst tx = await initializerContract.populateTransaction.initialize(initializer.args);\nawait (0, _chai.expect)(_hardhat.default.Diamond.upgradeState(tx.to, tx.data)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02c28c4e-9957-4db3-aa18-6f4a79efed93&quot;,&quot;parentUUID&quot;:&quot;33eefa93-70e8-4a9a-bd3c-96dd6e5c6960&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;configures all facets correctly&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization configures all facets correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsOnChain = (await _hardhat.default.Diamond.facets()).map(([facetAddress, functionSelectors])=&gt;({\n        facetAddress,\n        functionSelectors\n    }));\nconst expectedFacets = await Promise.all([\n    ..._shared.minterFacets,\n    ..._shared.diamondFacets\n].map(async (name)=&gt;{\n    const deployment = await _hardhat.default.deployments.get(name);\n    return {\n        facetAddress: deployment.address,\n        functionSelectors: facetsOnChain.find((f)=&gt;f.facetAddress === deployment.address).functionSelectors\n    };\n}));\n(0, _chai.expect)(facetsOnChain).to.have.deep.members(expectedFacets);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;049cef02-a83c-4355-9ab7-2efcb7ed851c&quot;,&quot;parentUUID&quot;:&quot;33eefa93-70e8-4a9a-bd3c-96dd6e5c6960&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d470a941-a850-4621-b27b-7ff9c2564ae5&quot;,&quot;02c28c4e-9957-4db3-aa18-6f4a79efed93&quot;,&quot;049cef02-a83c-4355-9ab7-2efcb7ed851c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:255,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;cc582b1c-4b8a-4d40-8fde-1a38cabe84ed&quot;,&quot;title&quot;:&quot;Minter - Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration \&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4f58f317-ee2c-49e1-a8a2-65dcf3d33d50&quot;,&quot;parentUUID&quot;:&quot;cc582b1c-4b8a-4d40-8fde-1a38cabe84ed&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;title&quot;:&quot;#configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can modify all parameters&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can modify all parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:122,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Diamond = (0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.deployer);\nconst update = (0, _test.getNewMinterParams)(hre.users.treasury.address);\nawait (0, _chai.expect)(Diamond.updateMinimumCollateralizationRatio(update.minimumCollateralizationRatio)).to.not.be.reverted;\nawait (0, _chai.expect)(Diamond.updateMinimumDebtValue(update.minimumDebtValue)).to.not.be.reverted;\nawait (0, _chai.expect)(Diamond.updateLiquidationThreshold(update.liquidationThreshold)).to.not.be.reverted;\nawait (0, _chai.expect)(Diamond.updateFeeRecipient(update.feeRecipient)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationMultiplier(update.MLM)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(update.oracleDeviationPct)).to.not.be.reverted;\nconst { minimumCollateralizationRatio , minimumDebtValue , feeRecipient , oracleDeviationPct  } = await hre.Diamond.getAllParams();\n(0, _chai.expect)(update.minimumCollateralizationRatio.toBigInt()).to.equal(minimumCollateralizationRatio);\n(0, _chai.expect)(update.minimumDebtValue.toBigInt()).to.equal(minimumDebtValue);\n(0, _chai.expect)(update.feeRecipient).to.equal(feeRecipient);\n(0, _chai.expect)(update.oracleDeviationPct).to.equal(oracleDeviationPct);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f7fdd33-fcf2-4b4e-9bd4-3653515d8f16&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:825,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract  } = await (0, _collaterals.addMockCollateralAsset)(_test.defaultCollateralArgs);\n(0, _chai.expect)(await hre.Diamond.collateralExists(contract.address)).to.equal(true);\nconst [, oraclePrice] = await hre.Diamond.getCollateralValueAndOraclePrice(contract.address, (0, _lib.toBig)(1), true);\n(0, _chai.expect)(Number(oraclePrice)).to.equal((0, _lib.toBig)(_test.defaultCollateralArgs.price, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9665f72f-b953-4b25-8c69-d9b27fcc78a8&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1058,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract , kresko  } = await (0, _krassets.addMockKreskoAsset)();\nconst values = await kresko();\nconst kreskoPriceAnswer = (0, _lib.fromBig)(await hre.Diamond.getKrAssetValue(contract.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(await hre.Diamond.krAssetExists(contract.address)).to.equal(true);\n(0, _chai.expect)(values.exists).to.equal(true);\n(0, _chai.expect)(values.kFactor).to.equal((0, _lib.toBig)(_test.defaultKrAssetArgs.factor));\n(0, _chai.expect)(kreskoPriceAnswer).to.equal(_test.defaultKrAssetArgs.price);\n(0, _chai.expect)((0, _lib.fromBig)(values.supplyLimit)).to.equal(_test.defaultKrAssetArgs.supplyLimit);\n(0, _chai.expect)((0, _lib.fromBig)(values.closeFee)).to.equal(_test.defaultKrAssetArgs.closeFee);\n(0, _chai.expect)((0, _lib.fromBig)(values.openFee)).to.equal(_test.defaultKrAssetArgs.openFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d41f653f-feff-42d0-9cd0-c8ea98e540f4&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update AMM oracle&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update AMM oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const ammOracle = await _smock.smock.fake(\&quot;UniswapV2Oracle\&quot;);\nawait hre.Diamond.updateAMMOracle(ammOracle.address);\n(0, _chai.expect)(await hre.Diamond.ammOracle()).to.equal(ammOracle.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79cca349-77d7-4896-8ca3-56f70b60cf5d&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update external oracle decimals&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update external oracle decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const decimals = 8;\nawait hre.Diamond.updateExtOracleDecimals(decimals);\n(0, _chai.expect)(await hre.Diamond.extOracleDecimals()).to.equal(decimals);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b24a2a3-a249-44f8-b003-e92dfe092dc2&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update max liquidatable multiplier&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update max liquidatable multiplier&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:56,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentMLM = await hre.Diamond.maxLiquidationMultiplier();\nconst newMLM = (0, _lib.toBig)(1.0002);\n(0, _chai.expect)(currentMLM.eq(newMLM)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationMultiplier(newMLM)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.maxLiquidationMultiplier()).eq(newMLM)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f86ddf63-5df4-4785-a93e-278c1916d839&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update oracle deviation pct&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update oracle deviation pct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentODPCT = await hre.Diamond.oracleDeviationPct();\nconst newODPCT = (0, _lib.toBig)(0.3);\n(0, _chai.expect)(currentODPCT.eq(newODPCT)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(newODPCT)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.oracleDeviationPct()).eq(newODPCT)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8bf1b1f-414d-443e-9d28-b7daf5ef2b6e&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update kFactor of a kresko asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update kFactor of a kresko asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1014,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract  } = await (0, _krassets.addMockKreskoAsset)();\nconst oldRatio = (await hre.Diamond.kreskoAsset(contract.address)).kFactor;\nconst newRatio = (0, _lib.toBig)(1.2);\n(0, _chai.expect)(oldRatio.eq(newRatio)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateKFactor(contract.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.kreskoAsset(contract.address)).kFactor.eq(newRatio)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6ecdb1a0-2f53-4162-bff5-628db8802d0e&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update cFactor of a collateral asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update cFactor of a collateral asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:724,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract  } = await (0, _collaterals.addMockCollateralAsset)();\nconst oldRatio = (await hre.Diamond.collateralAsset(contract.address)).factor;\nconst newRatio = (0, _lib.toBig)(0.9);\n(0, _chai.expect)(oldRatio.eq(newRatio)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateCFactor(contract.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.collateralAsset(contract.address)).factor.eq(newRatio)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8fa8c717-6b00-434a-a81d-77d31a9be4ba&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update values of a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update values of a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1184,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract , anchor , priceFeed  } = await (0, _krassets.addMockKreskoAsset)();\nconst oracleAnswer = (0, _lib.fromBig)((await priceFeed.latestRoundData())[1], 8);\nconst kreskoAnswer = (0, _lib.fromBig)(await hre.Diamond.getKrAssetValue(contract.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(oracleAnswer).to.equal(kreskoAnswer);\n(0, _chai.expect)(oracleAnswer).to.equal(_test.defaultKrAssetArgs.price);\nconst update = {\n    factor: (0, _lib.toBig)(1.2),\n    supplyLimit: 12000,\n    price: 20,\n    closeFee: (0, _lib.toBig)(0.02),\n    openFee: (0, _lib.toBig)(0.02)\n};\nconst [CLFeed] = await (0, _oracle.getMockOraclesFor)(await contract.name(), update.price);\nawait (0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.deployer).updateKreskoAsset(contract.address, await (0, _krassets.getKrAssetConfig)(contract, anchor.address, update.factor, CLFeed.address, (0, _lib.toBig)(update.supplyLimit), update.closeFee, update.openFee));\nconst newValues = await hre.Diamond.kreskoAsset(contract.address);\nconst updatedOracleAnswer = (0, _lib.fromBig)((await CLFeed.latestRoundData())[1], 8);\nconst newKreskoAnswer = (0, _lib.fromBig)(await hre.Diamond.getKrAssetValue(contract.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(newValues.exists).to.equal(true);\n(0, _chai.expect)(Number(newValues.kFactor)).to.equal(Number(update.factor));\n(0, _chai.expect)((0, _lib.fromBig)(newValues.supplyLimit)).to.equal(update.supplyLimit);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(newKreskoAnswer);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(update.price);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b8dfa014-6443-4ab5-a65d-364568ea4cfd&quot;,&quot;parentUUID&quot;:&quot;fdcfe4ca-284c-40b5-ac66-0575c5e4bb28&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1f7fdd33-fcf2-4b4e-9bd4-3653515d8f16&quot;,&quot;9665f72f-b953-4b25-8c69-d9b27fcc78a8&quot;,&quot;d41f653f-feff-42d0-9cd0-c8ea98e540f4&quot;,&quot;79cca349-77d7-4896-8ca3-56f70b60cf5d&quot;,&quot;8b24a2a3-a249-44f8-b003-e92dfe092dc2&quot;,&quot;f86ddf63-5df4-4785-a93e-278c1916d839&quot;,&quot;c8bf1b1f-414d-443e-9d28-b7daf5ef2b6e&quot;,&quot;6ecdb1a0-2f53-4162-bff5-628db8802d0e&quot;,&quot;8fa8c717-6b00-434a-a81d-77d31a9be4ba&quot;,&quot;b8dfa014-6443-4ab5-a65d-364568ea4cfd&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:5140,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;f9dcf298-fa18-415c-8766-ab0f7f53c0b4&quot;,&quot;title&quot;:&quot;Minter - Deposit Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw \&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f1caa0b4-95bf-4e76-9638-fea142154382&quot;,&quot;parentUUID&quot;:&quot;f9dcf298-fa18-415c-8766-ab0f7f53c0b4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw \&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = this.collaterals.find((c)=&gt;c.deployArgs.name === _testutils.defaultCollateralArgs.name);\nthis.initialBalance = (0, _lib.toBig)(100000);\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [_hardhat.default.users.userOne.address]: this.initialBalance\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [_hardhat.default.users.userOne.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\nthis.depositArgs = {\n    user: _hardhat.default.users.userOne,\n    asset: this.collateral,\n    amount: (0, _lib.toBig)(10000)\n};&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a31eee7c-751f-453b-8c9d-909dbafe07e1&quot;,&quot;parentUUID&quot;:&quot;f9dcf298-fa18-415c-8766-ab0f7f53c0b4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5c1f6163-4b10-4bc0-8461-a5bf425ccd2d&quot;,&quot;title&quot;:&quot;#collateral&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;title&quot;:&quot;#deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert if withdrawing a krAsset collateral causing lower deposit amount than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if withdrawing a krAsset collateral causing lower deposit amount than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1342,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const arbitraryUser = _hardhat.default.users.testUserSeven;\nconst collateralAmount = (0, _lib.toBig)(100);\nconst newKrAsset = await (0, _krassets.addMockKreskoAsset)({\n    name: \&quot;krTSLA\&quot;,\n    symbol: \&quot;krTSLA\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: _testutils.BASIS_POINT.mul(1000)\n});\nawait newKrAsset.setBalance(arbitraryUser, collateralAmount);\nawait newKrAsset.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [_hardhat.default.Diamond.address]: collateralAmount.mul(4)\n    }\n});\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).addCollateralAsset(newKrAsset.address, await (0, _collaterals.getCollateralConfig)(newKrAsset.contract, newKrAsset.anchor.address, (0, _lib.toBig)(1), (0, _lib.toBig)(1.05), newKrAsset.mocks.clFeed.address));\nconst depositAmount = collateralAmount.div(2);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, newKrAsset.address, depositAmount);\n// Rebase the asset according to params\nconst denominator = 4;\nconst positive = true;\nawait newKrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebasedDepositAmount = depositAmount.mul(denominator);\nconst withdrawAmount = rebasedDepositAmount.sub(9e11.toString());\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositedCollateralAssets(arbitraryUser.address)).to.deep.equal([\n    newKrAsset.address\n]);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, newKrAsset.address, withdrawAmount, 0)).to.be.revertedWith(_errors.Error.COLLATERAL_AMOUNT_TOO_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59369555-dab0-46b4-bc80-af318a5e9308&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing a krAsset collateral causing lower deposit amount than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing a krAsset collateral causing lower deposit amount than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1189,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const arbitraryUser = _hardhat.default.users.testUserSeven;\nconst collateralAmount = (0, _lib.toBig)(100);\nconst newKrAsset = await (0, _krassets.addMockKreskoAsset)({\n    name: \&quot;krTSLA\&quot;,\n    symbol: \&quot;krTSLA\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: _testutils.BASIS_POINT.mul(1000)\n});\nawait newKrAsset.setBalance(arbitraryUser, collateralAmount);\nawait newKrAsset.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [_hardhat.default.Diamond.address]: collateralAmount.mul(4)\n    }\n});\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).addCollateralAsset(newKrAsset.address, await (0, _collaterals.getCollateralConfig)(newKrAsset.contract, newKrAsset.anchor.address, (0, _lib.toBig)(1), (0, _lib.toBig)(1.05), newKrAsset.mocks.clFeed.address));\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, newKrAsset.address, 9e11.toString())).to.be.revertedWith(_errors.Error.COLLATERAL_AMOUNT_TOO_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f1db6fd-8a9b-4cf5-9d83-6f99577d7b8a&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit whitelisted collateral&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit whitelisted collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Account has no deposited assets\nconst depositedCollateralAssetsBefore = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Account now has deposited assets\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    this.collateral.address\n]);\n// Account&#x27;s collateral deposit balances have increased\n(0, _chai.expect)(await _hardhat.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address)).to.equal(this.depositArgs.amount);\n// Kresko contract&#x27;s collateral balance has increased\n(0, _chai.expect)(await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address)).to.equal(this.depositArgs.amount);\n// Account&#x27;s collateral balance has decreased\n(0, _chai.expect)((0, _lib.fromBig)(await this.collateral.contract.balanceOf(_hardhat.default.users.userOne.address))).to.equal((0, _lib.fromBig)(this.initialBalance) - (0, _lib.fromBig)(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f871004d-ccc2-4e40-9c0f-ee83f1d0e2d1&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load arbitrary user with sufficient collateral for testing purposes\nconst arbitraryUser = _hardhat.default.users.userThree;\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\n// Initially, the array of the user&#x27;s deposited collateral assets should be empty.\nconst depositedCollateralAssetsBefore = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets has been pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    this.collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(this.depositArgs.amount);\n// Confirm the amount as been transferred from the user into Kresko.sol\nconst kreskoBalance = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(this.depositArgs.amount);\n// Confirm the depositor&#x27;s (arbitraryUser) wallet balance has been adjusted accordingly\nconst depositorBalanceAfter = await this.collateral.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)((0, _lib.fromBig)(depositorBalanceAfter)).to.equal((0, _lib.fromBig)(this.initialBalance) - (0, _lib.fromBig)(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f5e63365-c1e5-4366-a5ae-f0caad13de44&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit more collateral to an existing deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit more collateral to an existing deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:101,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit first batch of collateral\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Deposit second batch of collateral\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets hasn&#x27;t been double-pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    this.collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(this.depositArgs.amount.add(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;42169fb2-0fc3-4692-ae0a-cc04aff46b04&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to have deposited multiple collateral assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to have deposited multiple collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:772,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load user account with a different type of collateral\nconst collateralArgs = {\n    name: \&quot;Collateral18Dec\&quot;,\n    price: _testutils.defaultOraclePrice,\n    factor: 1,\n    decimals: _testutils.defaultDecimals\n};\nconst { contract , mocks  } = await (0, _collaterals.addMockCollateralAsset)(collateralArgs);\nawait mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [_hardhat.default.users.userOne.address]: this.initialBalance\n});\nawait mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [_hardhat.default.users.userOne.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\n// Deposit batch of first collateral type\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Deposit batch of second collateral type\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, contract.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets contains both collateral assets\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    this.collateral.address,\n    contract.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4eb2abc8-4581-4fcc-9957-19eae79c1885&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralDeposited event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should emit CollateralDeposited event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralDeposited\&quot;);\n(0, _chai.expect)(event.account).to.equal(this.depositArgs.user.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)(event.amount).to.equal(this.depositArgs.amount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44d8794a-c15b-42fd-a2df-9b676d03ea67&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing collateral that has not been whitelisted&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing collateral that has not been whitelisted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, \&quot;0x0000000000000000000000000000000000000001\&quot;, this.depositArgs.amount)).to.be.revertedWith(_errors.Error.COLLATERAL_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;05f63c8c-7f73-42a6-9612-ce99e6493654&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, 0)).to.be.revertedWith(_errors.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d335d7e2-e482-4d15-be8b-81cc94ef314f&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if collateral is not depositable&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if collateral is not depositable&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:88,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { deployer , devTwo , extOne  } = await _hardhat.default.ethers.getNamedSigners();\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    0\n], [\n    deployer,\n    devTwo,\n    extOne\n]);\nconst isDepositPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isDepositPaused).to.equal(true);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.contract.address, 0)).to.be.revertedWith(_errors.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;93c558a0-8f66-4f49-904a-b6bd74564e71&quot;,&quot;parentUUID&quot;:&quot;c3ddbb75-3c07-4adb-9fd5-3b832cdc226d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;59369555-dab0-46b4-bc80-af318a5e9308&quot;,&quot;1f1db6fd-8a9b-4cf5-9d83-6f99577d7b8a&quot;,&quot;f871004d-ccc2-4e40-9c0f-ee83f1d0e2d1&quot;,&quot;f5e63365-c1e5-4366-a5ae-f0caad13de44&quot;,&quot;42169fb2-0fc3-4692-ae0a-cc04aff46b04&quot;,&quot;4eb2abc8-4581-4fcc-9957-19eae79c1885&quot;,&quot;44d8794a-c15b-42fd-a2df-9b676d03ea67&quot;,&quot;05f63c8c-7f73-42a6-9612-ce99e6493654&quot;,&quot;d335d7e2-e482-4d15-be8b-81cc94ef314f&quot;,&quot;93c558a0-8f66-4f49-904a-b6bd74564e71&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3769,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;959db09f-f913-444d-98d6-9e5e4629ea3a&quot;,&quot;title&quot;:&quot;#withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw \&quot;before each\&quot; hook in \&quot;#withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit collateral\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.contract.address, this.depositArgs.amount)).not.to.be.reverted;\nthis.collateral = this.collaterals[0];\nthis.depositAmount = this.depositArgs.amount;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;38500092-df9f-4efb-bb19-876c42663e1e&quot;,&quot;parentUUID&quot;:&quot;959db09f-f913-444d-98d6-9e5e4629ea3a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their entire deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw their entire deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:135,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositedCollateralAssets = await _hardhat.default.Diamond.getDepositedCollateralAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    this.collateral.address\n]);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, this.depositAmount, 0);\n// Ensure that the collateral asset is removed from the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssetsPostWithdraw = await _hardhat.default.Diamond.getDepositedCollateralAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(depositedCollateralAssetsPostWithdraw).to.deep.equal([]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(0);\n// Ensure the amount transferred is correct\nconst kreskoBalance = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(0);\nconst userOneBalance = await this.collateral.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userOneBalance).to.equal(this.initialBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7f11a52d-ef63-4abd-af5d-3acea38617de&quot;,&quot;parentUUID&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to withdraw a portion of their deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw a portion of their deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = this.depositAmount.div(2);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, withdrawAmount, 0);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(this.depositAmount.sub(withdrawAmount));\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getDepositedCollateralAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    this.collateral.address\n]);\nconst kreskoBalance = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(this.depositAmount.sub(withdrawAmount));\nconst userOneBalance = await this.collateral.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userOneBalance).to.equal(this.initialBalance.sub(amountDeposited));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fab4e1d3-377d-49f3-a93a-f26437096d9d&quot;,&quot;parentUUID&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow trusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:153,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).grantRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address)).to.equal(true);\nconst collateralBefore = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, this.depositAmount, 0)).to.not.be.reverted;\nconst collateralAfter = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\n// Ensure that collateral was withdrawn\n(0, _chai.expect)(collateralAfter).to.equal(collateralBefore.sub(this.depositAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3be5080-4bb0-4d71-9eaf-3c421d9b88f2&quot;,&quot;parentUUID&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralWithdrawn event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should emit CollateralWithdrawn event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:70,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, this.depositAmount, 0);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralWithdrawn\&quot;);\n(0, _chai.expect)(event.account).to.equal(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)(event.amount).to.equal(this.depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2702bd60-6175-49cf-a4e6-157da5b89ffb&quot;,&quot;parentUUID&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, this.initialBalance, 0)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.userThree.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d71eecc4-da6a-4ce8-840e-66214db97407&quot;,&quot;parentUUID&quot;:&quot;f033a375-61e9-4642-97d1-51ea649b9f19&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is &gt; 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 \&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:167,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.krAsset = _hardhat.default.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _testutils.defaultKrAssetArgs.symbol);\n// userOne mints some kr assets\nthis.mintAmount = (0, _lib.toBig)(100);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, this.mintAmount);\n// Mint amount differs from deposited amount due to open fee\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\nthis.initialUserOneDeposited = amountDeposited;\nthis.mcr = await _hardhat.default.Diamond.minimumCollateralizationRatio();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af335776-0696-4a48-beef-c6e41b909a86&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:368,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = (0, _lib.toBig)(10);\n// Ensure that the withdrawal would not put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await _hardhat.default.Diamond.getAccountMinimumCollateralValueAtRatio(_hardhat.default.users.userOne.address, this.mcr);\nconst accountCollateralValue = await _hardhat.default.Diamond.getAccountCollateralValue(_hardhat.default.users.userOne.address);\nconst [withdrawnCollateralValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\n(0, _chai.expect)(accountCollateralValue.sub(withdrawnCollateralValue).gte(accountMinCollateralValue)).to.be.true;\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, withdrawAmount, 0);\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getDepositedCollateralAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    this.collateral.address\n]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(this.depositAmount.sub(withdrawAmount));\n// Check the balances of the contract and user\nconst kreskoBalance = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(this.depositAmount.sub(withdrawAmount));\nconst userOneBalance = await this.collateral.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userOneBalance).to.equal(this.initialBalance.sub(this.depositAmount.sub(withdrawAmount)));\n// Ensure the account&#x27;s minimum collateral value is &lt;= the account collateral value\nconst accountMinCollateralValueAfter = await _hardhat.default.Diamond.getAccountMinimumCollateralValueAtRatio(_hardhat.default.users.userOne.address, this.mcr);\nconst accountCollateralValueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(accountMinCollateralValueAfter.lte(accountCollateralValueAfter)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a53af3f5-a46f-4ab7-ad18-0d71532dee95&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:167,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const user = _hardhat.default.users.userFour;\nawait this.collateral.setBalance(user, _ethers.BigNumber.from(0));\nawait this.collateral.setBalance(user, (0, _lib.toBig)(1000));\nawait this.collateral.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: (0, _lib.toBig)(1000),\n    user\n});\nawait (0, _collaterals.withdrawCollateral)({\n    asset: this.collateral,\n    amount: (0, _lib.toBig)(1010),\n    user\n});\n(0, _chai.expect)(await this.collateral.contract.balanceOf(user.address)).to.equal((0, _lib.toBig)(1000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0d8650b5-543f-4d95-ad64-30f5b098c7bf&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if withdrawing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if withdrawing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, 0, withdrawAmount)).to.be.revertedWith(_errors.Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6b6a2e23-5d12-4ef1-8e85-2cacb8f1dbe7&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the withdrawal violates the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the withdrawal violates the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:235,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne has a debt position, so attempting to withdraw the entire collateral deposit should be impossible\nconst withdrawAmount = this.initialBalance;\n// Ensure that the withdrawal would in fact put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await _hardhat.default.Diamond.getAccountMinimumCollateralValueAtRatio(_hardhat.default.users.userOne.address, this.mcr);\nconst accountCollateralValue = await _hardhat.default.Diamond.getAccountCollateralValue(_hardhat.default.users.userOne.address);\nconst [withdrawnCollateralValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\n(0, _chai.expect)(accountCollateralValue.sub(withdrawnCollateralValue).lt(accountMinCollateralValue)).to.be.true;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, withdrawAmount, 0)).to.be.revertedWith(_errors.Error.COLLATERAL_INSUFFICIENT_AMOUNT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d705172d-8803-4d04-a68c-efbf189c9170&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = this.depositAmount.div(2);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).withdrawCollateral(_hardhat.default.users.userOne.address, this.collateral.address, withdrawAmount, 1)).to.be.revertedWith(_errors.Error.ARRAY_OUT_OF_BOUNDS);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ed30ab8-880b-4a3b-b6f7-23a50a2a5455&quot;,&quot;parentUUID&quot;:&quot;b11812c4-6267-4637-82e9-a17a18970882&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a53af3f5-a46f-4ab7-ad18-0d71532dee95&quot;,&quot;0d8650b5-543f-4d95-ad64-30f5b098c7bf&quot;,&quot;6b6a2e23-5d12-4ef1-8e85-2cacb8f1dbe7&quot;,&quot;d705172d-8803-4d04-a68c-efbf189c9170&quot;,&quot;9ed30ab8-880b-4a3b-b6f7-23a50a2a5455&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:822,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;7f11a52d-ef63-4abd-af5d-3acea38617de&quot;,&quot;fab4e1d3-377d-49f3-a93a-f26437096d9d&quot;,&quot;a3be5080-4bb0-4d71-9eaf-3c421d9b88f2&quot;,&quot;2702bd60-6175-49cf-a4e6-157da5b89ffb&quot;,&quot;d71eecc4-da6a-4ce8-840e-66214db97407&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:507,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;65fb79da-b70f-479f-a057-97e3a5c88fb1&quot;,&quot;title&quot;:&quot;#deposit - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#deposit - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events \&quot;before each\&quot; hook in \&quot;#deposit - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:264,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;arbitraryUser = _hardhat.default.users.userThree;\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\nthis.krAsset = this.krAssets.find((k)=&gt;k.deployArgs.name === _testutils.defaultKrAssetArgs.name);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_testutils.Role.OPERATOR, _hardhat.default.users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).addCollateralAsset(this.krAsset.contract.address, await (0, _collaterals.getCollateralConfig)(this.krAsset.contract, this.krAsset.anchor.address, (0, _lib.toBig)(1), (0, _lib.toBig)(1.05), assetInfo.oracle));\n// Allowance for Kresko\nawait this.krAsset.contract.connect(arbitraryUser).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\n// Deposit some collateral\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.collateral.address, this.depositArgs.amount);\n// Mint some krAssets\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).mintKreskoAsset(arbitraryUser.address, this.krAsset.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).kreskoAssetDebt(arbitraryUser.address, this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff858ad1-dcaa-4d43-9dfa-64b68a21c609&quot;,&quot;parentUUID&quot;:&quot;65fb79da-b70f-479f-a057-97e3a5c88fb1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;title&quot;:&quot;deposit amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst expectedDepositsAfter = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(expectedDepositsAfter);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6669e067-8ed2-484e-91a3-0ef7abd9bb76&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmountAfterRebase = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst depositsBefore = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmountAfterRebase);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b7b19ce4-90e4-4fe1-b571-217a4b23708e&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;489bccb0-18b2-4f4c-a4a3-98516894c523&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:113,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c7de4727-6552-4122-82e5-8d3cde165fa8&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:143,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c13036fd-bc98-4f08-b82b-a249798ad24d&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:145,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfterRebase = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfterRebase).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7989e61d-d117-4c1b-9e97-fdad4f5304c5&quot;,&quot;parentUUID&quot;:&quot;fee3579d-039e-4b88-a1a9-cd50833aae8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6669e067-8ed2-484e-91a3-0ef7abd9bb76&quot;,&quot;b7b19ce4-90e4-4fe1-b571-217a4b23708e&quot;,&quot;489bccb0-18b2-4f4c-a4a3-98516894c523&quot;,&quot;c7de4727-6552-4122-82e5-8d3cde165fa8&quot;,&quot;c13036fd-bc98-4f08-b82b-a249798ad24d&quot;,&quot;7989e61d-d117-4c1b-9e97-fdad4f5304c5&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:727,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;title&quot;:&quot;deposit usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:183,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(newPrice);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae9e605d-ea20-47b7-b5e2-8cc555772273&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:193,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(newPrice);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;feda20da-4d76-486f-a1ca-2227a3e17e1f&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:133,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;52271b68-a7fe-4f20-8630-9772ac08e9d2&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:137,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e2e270a5-4b5e-49dd-8a1b-2115a347961d&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:251,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, fullDepositAmount, false);\n// Deposit more\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.bignumber.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;128465a2-76e9-4df9-b958-2e2a3d6211df&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:648,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, fullDepositAmount, false);\n// Deposit more\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.bignumber.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd55d1e7-5044-4b98-ad81-dcfeeef24e52&quot;,&quot;parentUUID&quot;:&quot;71afb905-6304-477a-a216-69b7c48104e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ae9e605d-ea20-47b7-b5e2-8cc555772273&quot;,&quot;feda20da-4d76-486f-a1ca-2227a3e17e1f&quot;,&quot;52271b68-a7fe-4f20-8630-9772ac08e9d2&quot;,&quot;e2e270a5-4b5e-49dd-8a1b-2115a347961d&quot;,&quot;128465a2-76e9-4df9-b958-2e2a3d6211df&quot;,&quot;fd55d1e7-5044-4b98-ad81-dcfeeef24e52&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1545,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;53c8d62e-0060-4e87-889e-605c7b622725&quot;,&quot;title&quot;:&quot;#withdraw - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events \&quot;before each\&quot; hook in \&quot;#withdraw - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:273,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;arbitraryUser = _hardhat.default.users.userThree;\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\nthis.krAsset = this.krAssets.find((k)=&gt;k.deployArgs.name === _testutils.defaultKrAssetArgs.name);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_testutils.Role.OPERATOR, _hardhat.default.users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).addCollateralAsset(this.krAsset.contract.address, await (0, _collaterals.getCollateralConfig)(this.krAsset.contract, this.krAsset.anchor.address, (0, _lib.toBig)(1), (0, _lib.toBig)(1.05), assetInfo.oracle));\n// Allowance for Kresko\nawait this.krAsset.contract.connect(arbitraryUser).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\n// Deposit some collateral\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.collateral.address, this.depositArgs.amount);\n// Mint some krAssets\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).mintKreskoAsset(arbitraryUser.address, this.krAsset.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).kreskoAssetDebt(arbitraryUser.address, this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1143be16-495f-439d-9c6c-08c77701b629&quot;,&quot;parentUUID&quot;:&quot;53c8d62e-0060-4e87-889e-605c7b622725&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;title&quot;:&quot;withdraw amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:693,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit collateral before rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3f7b6073-4ac6-4cfb-b8f7-68fa340f7c11&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:319,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit collateral before rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;936675c0-8a2f-44ff-9ca5-3223dd3496a0&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made after an positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:272,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ee061dc4-815e-4502-af9d-0542b51ffae6&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:272,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53dcedc5-1545-4813-bf50-0a4c3b6220aa&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:361,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit before the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get deposits before\nconst depositsFirst = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7e87f5f0-8499-47ec-a6d9-262319e3074b&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:459,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit before the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get deposits before\nconst depositsFirst = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\nconst finalDeposits = await _hardhat.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2e6a416-4833-4b95-a893-aa4f4cb4ac9d&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _lib.toBig)(10);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst nrcBalanceBefore = await this.collateral.contract.balanceOf(arbitraryUser.address);\nconst expectedNrcBalanceAfter = nrcBalanceBefore.add(withdrawAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.collateral.address);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.collateral.address, withdrawAmount, cIndex);\n(0, _chai.expect)(await this.collateral.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(expectedNrcBalanceAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1dc16da2-4aa9-4836-897e-edf8c4b71eb8&quot;,&quot;parentUUID&quot;:&quot;f1d121d2-2447-49ff-ad32-f4f48688f937&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3f7b6073-4ac6-4cfb-b8f7-68fa340f7c11&quot;,&quot;936675c0-8a2f-44ff-9ca5-3223dd3496a0&quot;,&quot;ee061dc4-815e-4502-af9d-0542b51ffae6&quot;,&quot;53dcedc5-1545-4813-bf50-0a4c3b6220aa&quot;,&quot;7e87f5f0-8499-47ec-a6d9-262319e3074b&quot;,&quot;f2e6a416-4833-4b95-a893-aa4f4cb4ac9d&quot;,&quot;1dc16da2-4aa9-4836-897e-edf8c4b71eb8&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2599,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;title&quot;:&quot;withdraw usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:312,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b4b4253-8f1c-4668-a8e6-8b0f998e92d1&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:288,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e996545e-d675-49cb-bd15-3e1f7da1afb3&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:276,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, depositAmount, cIndex);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e3a2fcb5-e7ea-469c-a712-90989287b22d&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:266,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, depositAmount, cIndex);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e8c888bb-7c58-434f-8c26-c7fc3d4ef457&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:738,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Deposit more\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59e80144-6030-4fed-b50e-b9258143aeea&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:395,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(denominator).div(2);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Deposit more\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;60e1baf8-07b9-402d-9947-aa76b05dfef2&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:476,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _lib.toBig)(10);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst accountValueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\nconst [nrcValueBefore] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.collateral.address);\nconst [withdrawValue] = await _hardhat.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\nconst expectedNrcValueAfter = nrcValueBefore.sub(withdrawValue);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst cIndex = await _hardhat.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.collateral.address);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, arbitraryUser).withdrawCollateral(arbitraryUser.address, this.collateral.address, withdrawAmount, cIndex);\nconst finalAccountValue = await _hardhat.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\nconst [finalValue] = await _hardhat.default.Diamond.getCollateralAdjustedAndRealValue(arbitraryUser.address, this.collateral.address);\n(0, _chai.expect)(finalValue).to.equal(expectedNrcValueAfter);\n(0, _chai.expect)(finalAccountValue).to.bignumber.equal(accountValueBefore.sub(withdrawValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;80431760-e935-41d5-a129-972af77fb73f&quot;,&quot;parentUUID&quot;:&quot;b9476fbf-6790-4422-8c3c-5ec193b6f0bb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4b4b4253-8f1c-4668-a8e6-8b0f998e92d1&quot;,&quot;e996545e-d675-49cb-bd15-3e1f7da1afb3&quot;,&quot;e3a2fcb5-e7ea-469c-a712-90989287b22d&quot;,&quot;e8c888bb-7c58-434f-8c26-c7fc3d4ef457&quot;,&quot;59e80144-6030-4fed-b50e-b9258143aeea&quot;,&quot;60e1baf8-07b9-402d-9947-aa76b05dfef2&quot;,&quot;80431760-e935-41d5-a129-972af77fb73f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2751,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;046b5be4-1f3f-4455-8afa-9c10adb3b697&quot;,&quot;title&quot;:&quot;Minter - Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations \&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;be3c749f-fd04-43c8-8f89-02b05f575f5a&quot;,&quot;parentUUID&quot;:&quot;046b5be4-1f3f-4455-8afa-9c10adb3b697&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations \&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:360,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// -------------------------------- Set up mock assets --------------------------------\nconst collateralArgs = {\n    name: \&quot;CollateralAsset\&quot;,\n    price: 10,\n    factor: 1,\n    decimals: 18\n};\nthis.collateral = hre.collaterals.find((c)=&gt;c.deployArgs.name === _testutils.defaultCollateralArgs.name);\nthis.collateral = await this.collateral.update(collateralArgs);\nthis.collateral.setPrice(collateralArgs.price);\n// Set up mock KreskoAsset\nconst krAssetArgs = {\n    name: \&quot;KreskoAsset\&quot;,\n    price: 11,\n    factor: 1,\n    supplyLimit: 100000000,\n    closeFee: _testutils.defaultCloseFee,\n    openFee: _testutils.defaultOpenFee\n};\nthis.krAsset = hre.krAssets.find((c)=&gt;c.deployArgs.name === _testutils.defaultKrAssetArgs.name);\nthis.krAsset.setPrice(krAssetArgs.price);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_testutils.Role.OPERATOR, hre.users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.deployer).addCollateralAsset(this.krAsset.contract.address, await (0, _collaterals.getCollateralConfig)(this.krAsset.contract, this.krAsset.anchor.address, (0, _lib.toBig)(1), (0, _lib.toBig)(1.05), assetInfo.oracle));\n// -------------------------------- Set up userOne deposit/debt --------------------------------\nawait this.collateral.setBalance(hre.users.liquidator, (0, _lib.toBig)(100000000));\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hre.users.liquidator.address]: {\n        [hre.Diamond.address]: (0, _lib.toBig)(100000000)\n    }\n});\n// Deposit collateral\nthis.defaultDepositAmount = 20; // 20 * $10 = $200 in collateral asset value\nawait this.collateral.setBalance(hre.users.userOne, (0, _lib.toBig)(this.defaultDepositAmount));\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hre.users.userOne.address]: {\n        [hre.Diamond.address]: (0, _lib.toBig)(this.defaultDepositAmount)\n    }\n});\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.userOne,\n    amount: this.defaultDepositAmount,\n    asset: this.collateral\n});\n// Mint KrAsset\nthis.defaultMintAmount = 10; // 10 * $11 = $110 in debt value\nawait (0, _krassets.mintKrAsset)({\n    user: hre.users.userOne,\n    amount: this.defaultMintAmount,\n    asset: this.krAsset\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e78e2e05-79dc-4571-9419-158cb19c670b&quot;,&quot;parentUUID&quot;:&quot;046b5be4-1f3f-4455-8afa-9c10adb3b697&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;title&quot;:&quot;#maxLiquidatableValue&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#maxLiquidatableValue\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue \&quot;before each\&quot; hook in \&quot;#maxLiquidatableValue\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:703,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmountBig18 = (0, _lib.toBig)(this.defaultDepositAmount * 100);\nconst depositAmountBig8 = (0, _lib.toBig)(this.defaultDepositAmount * 100, 8);\nuser = hre.users.userOne;\nthis.collateral.setPrice(collateralPrice);\nthis.krAsset.setPrice(krAssetPrice);\nawait this.collateral.setBalance(hre.users.userOne, depositAmountBig18);\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hre.users.userOne.address]: {\n        [hre.Diamond.address]: depositAmountBig18\n    }\n});\nnewCollateral = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral\&quot;,\n    decimals: 8,\n    price: 10,\n    factor: 0.9\n});\nawait newCollateral.setBalance(hre.users.userOne, depositAmountBig8);\nawait newCollateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hre.users.userOne.address]: {\n        [hre.Diamond.address]: depositAmountBig8\n    }\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ee2586ea-1e6f-4701-b243-d905fad561be&quot;,&quot;parentUUID&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 1&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 1&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:932,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deposits, borrows] = [\n    (0, _lib.toBig)(20),\n    (0, _lib.toBig)(10)\n];\nawait this.collateral.setBalance(hre.users.userThree, deposits);\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.userThree,\n    amount: deposits,\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: hre.users.userThree,\n    amount: borrows,\n    asset: this.krAsset\n});\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(hre.users.userThree.address)).to.be.false;\n(0, _chai.expect)(await (0, _liquidations.getCR)(hre.users.userThree.address)).to.be.equal(2);\nthis.collateral.setPrice(5);\n(0, _chai.expect)(await (0, _liquidations.getCR)(hre.users.userThree.address)).to.be.equal(1);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(hre.users.userThree.address)).to.be.true;\nconst maxLiquidatableValue = await hre.Diamond.getMaxLiquidation(hre.users.userThree.address, this.krAsset.address, this.collateral.address);\nconst MLCalc = await (0, _liquidations.getExpectedMaxLiq)(hre.users.userThree, this.krAsset, this.collateral);\n(0, _chai.expect)(MLCalc).to.be.closeTo(maxLiquidatableValue, USD_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d21b191b-f28b-4969-9884-347b5d160b89&quot;,&quot;parentUUID&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4372,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updateMinimumDebtValue(0);\nconst userThree = hre.users.userThree;\nconst [deposits1, deposits2] = [\n    (0, _lib.toBig)(10),\n    (0, _lib.toBig)(10)\n];\nconst borrows = (0, _lib.toBig)(10);\nconst collateralPrice = 10;\nthis.collateral.setPrice(collateralPrice);\nconst collateral2 = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral18Dec\&quot;,\n    decimals: 18,\n    factor: 1,\n    price: 10\n});\nawait this.collateral.setBalance(userThree, deposits1);\nawait collateral2.setBalance(userThree, deposits2);\nawait (0, _collaterals.depositCollateral)({\n    user: userThree,\n    amount: deposits2,\n    asset: collateral2\n});\nawait (0, _collaterals.depositCollateral)({\n    user: userThree,\n    amount: deposits1,\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userThree,\n    amount: borrows,\n    asset: this.krAsset\n});\nconst cr = await (0, _liquidations.getCR)(userThree.address);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;\n(0, _chai.expect)(cr).to.be.equal(2);\nawait this.collateral.update({\n    factor: 0.25,\n    name: \&quot;updated\&quot;\n});\nthis.collateral.setPrice(5);\nconst expectedCR = 1.125;\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.closeTo(expectedCR, CR_DELTA);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nconst maxLiquidatableValueC1 = await hre.Diamond.getMaxLiquidation(userThree.address, this.krAsset.address, this.collateral.address);\nconst MLCalcC1 = await (0, _liquidations.getExpectedMaxLiq)(userThree, this.krAsset, this.collateral);\n(0, _chai.expect)(MLCalcC1).to.be.closeTo(maxLiquidatableValueC1, USD_DELTA);\nconst maxLiquidatableValueC2 = await hre.Diamond.getMaxLiquidation(userThree.address, this.krAsset.address, collateral2.address);\nconst MLCalcC2 = await (0, _liquidations.getExpectedMaxLiq)(userThree, this.krAsset, collateral2);\n(0, _chai.expect)(MLCalcC2).to.be.closeTo(maxLiquidatableValueC2, USD_DELTA);\n(0, _chai.expect)(maxLiquidatableValueC2.gt(maxLiquidatableValueC1)).to.be.true;\nawait (0, _liquidations.liquidate)(userThree, this.krAsset, this.collateral);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.lessThan(1.4);\nawait (0, _liquidations.liquidate)(userThree, this.krAsset, collateral2);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.greaterThan(1.4);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;46403df9-703c-443c-a532-d57a9de9cf44&quot;,&quot;parentUUID&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV with single market cdp&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV with single market cdp&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:431,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositCollateral)({\n    user: hre.users.userOne,\n    amount: this.defaultDepositAmount * 49,\n    asset: this.collateral\n});\nthis.collateral.setPrice(collateralPriceAfter * 0.7);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(user.address)).to.be.true;\nconst expectedMaxLiquidatableValue = await (0, _liquidations.getExpectedMaxLiq)(user, this.krAsset, this.collateral);\n(0, _chai.expect)(expectedMaxLiquidatableValue.gt(0)).to.be.true;\nconst maxLiquidatableValue = await hre.Diamond.getMaxLiquidation(user.address, this.krAsset.address, this.collateral.address);\n(0, _chai.expect)(expectedMaxLiquidatableValue).to.be.closeTo(maxLiquidatableValue, USD_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c2dfc90-e06d-4c7b-a86d-4f4c4b2f19cd&quot;,&quot;parentUUID&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV with multiple cdps&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV with multiple cdps&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:976,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositCollateral)({\n    user: hre.users.userOne,\n    amount: this.defaultDepositAmount * 49,\n    asset: this.collateral\n});\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.userOne,\n    amount: (0, _lib.toBig)(0.1, 8),\n    asset: newCollateral\n});\nthis.collateral.setPrice(collateralPriceAfter);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(user.address)).to.be.true;\nconst expectedMaxLiquidatableValue = await (0, _liquidations.getExpectedMaxLiq)(user, this.krAsset, this.collateral);\n(0, _chai.expect)(expectedMaxLiquidatableValue.gt(0)).to.be.true;\nconst maxLiquidatableValue = await hre.Diamond.getMaxLiquidation(user.address, this.krAsset.address, this.collateral.address);\n(0, _chai.expect)(expectedMaxLiquidatableValue).to.be.closeTo(maxLiquidatableValue, USD_DELTA);\nconst expectedMaxLiquidatableValueNewCollateral = await (0, _liquidations.getExpectedMaxLiq)(user, this.krAsset, newCollateral);\n(0, _chai.expect)(expectedMaxLiquidatableValueNewCollateral.gt(0)).to.be.true;\nconst maxLiquidatableValueNewCollateral = await hre.Diamond.getMaxLiquidation(user.address, this.krAsset.address, newCollateral.address);\n(0, _chai.expect)(expectedMaxLiquidatableValueNewCollateral).to.be.closeTo(maxLiquidatableValueNewCollateral, USD_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;637b88aa-9f52-48ec-b0be-6fc691ee162c&quot;,&quot;parentUUID&quot;:&quot;3cbbf342-30f1-4e46-a99c-edce14daae26&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d21b191b-f28b-4969-9884-347b5d160b89&quot;,&quot;46403df9-703c-443c-a532-d57a9de9cf44&quot;,&quot;5c2dfc90-e06d-4c7b-a86d-4f4c4b2f19cd&quot;,&quot;637b88aa-9f52-48ec-b0be-6fc691ee162c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6711,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;46729104-6665-4ef9-8a7d-a425426c2bb6&quot;,&quot;title&quot;:&quot;#liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0d5e372d-5dcf-43c9-9edc-68091aef6cb8&quot;,&quot;title&quot;:&quot;#isAccountLiquidatable&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify accounts below their liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #isAccountLiquidatable should identify accounts below their liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:251,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that current amount is under min collateral value\nconst liquidationThreshold = await hre.Diamond.liquidationThreshold();\nconst minCollateralUSD = await hre.Diamond.getAccountMinimumCollateralValueAtRatio(hre.users.userOne.address, liquidationThreshold);\n(0, _chai.expect)(this.defaultDepositAmount * this.collateral.deployArgs.price &gt; (0, _lib.fromBig)(minCollateralUSD, 8));\n// The account should be NOT liquidatable as collateral value ($200) &gt;= min collateral value ($154)\nconst initialCanLiquidate = await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address);\n(0, _chai.expect)(initialCanLiquidate).to.equal(false);\n// Update collateral price to $7.5\nconst newCollateralPrice = 7.5;\nthis.collateral.setPrice(newCollateralPrice);\nconst [, newCollateralOraclePrice] = await hre.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, (0, _lib.toBig)(1), true);\n(0, _chai.expect)((0, _lib.fromBig)(newCollateralOraclePrice, 8)).to.equal(newCollateralPrice);\n// The account should be liquidatable as collateral value ($140) &lt; min collateral value ($154)\nconst secondaryCanLiquidate = await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address);\n(0, _chai.expect)(secondaryCanLiquidate).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d8d9a18b-6744-42ad-9571-a8394e59fe01&quot;,&quot;parentUUID&quot;:&quot;0d5e372d-5dcf-43c9-9edc-68091aef6cb8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d8d9a18b-6744-42ad-9571-a8394e59fe01&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:251,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;title&quot;:&quot;#liquidate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate \&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userTwo tokens to use for liquidation\nawait this.krAsset.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [hre.users.userTwo.address]: (0, _lib.toBig)(10000)\n});\n// Update collateral price from $10 to $7.5\nconst newCollateralPrice = 7.5;\nthis.collateral.setPrice(newCollateralPrice);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b05cca93-e5db-4af1-adf8-54abdf2abcda&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow unhealthy accounts to be liquidated&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow unhealthy accounts to be liquidated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:594,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm we can liquidate this account\nconst canLiquidate = await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address);\n(0, _chai.expect)(canLiquidate).to.equal(true);\n// Fetch pre-liquidation state for users and contracts\nconst beforeUserOneCollateralAmount = await hre.Diamond.collateralDeposits(hre.users.userOne.address, this.collateral.address);\nconst beforeUserOneDebtAmount = await hre.Diamond.kreskoAssetDebt(hre.users.userOne.address, this.krAsset.address);\nconst beforeUserTwoCollateralBalance = await this.collateral.contract.balanceOf(hre.users.userTwo.address);\nconst beforeUserTwoKreskoAssetBalance = await this.krAsset.contract.balanceOf(hre.users.userTwo.address);\nconst beforeKreskoCollateralBalance = await this.collateral.contract.balanceOf(hre.Diamond.address);\n// Liquidate userOne\nconst maxLiq = await hre.Diamond.getMaxLiquidation(hre.users.userOne.address, this.krAsset.address, this.collateral.address);\nconst maxRepayAmount = (0, _lib.toBig)(Number(maxLiq.div(await this.krAsset.getPrice())));\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, maxRepayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex, false);\n// Confirm that the liquidated user&#x27;s debt amount has decreased by the repaid amount\nconst afterUserOneDebtAmount = await hre.Diamond.kreskoAssetDebt(hre.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(afterUserOneDebtAmount.eq(beforeUserOneDebtAmount.sub(maxRepayAmount)));\n// Confirm that some of the liquidated user&#x27;s collateral has been seized\nconst afterUserOneCollateralAmount = await hre.Diamond.collateralDeposits(hre.users.userOne.address, this.collateral.address);\n(0, _chai.expect)(afterUserOneCollateralAmount.lt(beforeUserOneCollateralAmount));\n// Confirm that userTwo&#x27;s kresko asset balance has decreased by the repaid amount\nconst afterUserTwoKreskoAssetBalance = await this.krAsset.contract.balanceOf(hre.users.userTwo.address);\n(0, _chai.expect)(afterUserTwoKreskoAssetBalance.eq(beforeUserTwoKreskoAssetBalance.sub(maxRepayAmount)));\n// Confirm that userTwo has received some collateral from the contract\nconst afterUserTwoCollateralBalance = await this.collateral.contract.balanceOf(hre.users.userTwo.address);\n(0, _chai.expect)(afterUserTwoCollateralBalance).gt(beforeUserTwoCollateralBalance);\n// Confirm that Kresko contract&#x27;s collateral balance has decreased.\nconst afterKreskoCollateralBalance = await this.collateral.contract.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(afterKreskoCollateralBalance).lt(beforeKreskoCollateralBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b7e338c-5e87-4a45-9bb7-c5706b846871&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to LT with a single CDP&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to LT with a single CDP&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1517,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userThree = hre.users.userThree;\nconst deposits = (0, _lib.toBig)(15);\nconst borrows = (0, _lib.toBig)(10);\nthis.collateral.setPrice(10);\nthis.krAsset.setPrice(10);\nawait this.collateral.setBalance(userThree, deposits);\nawait (0, _collaterals.depositCollateral)({\n    user: userThree,\n    amount: deposits,\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userThree,\n    amount: borrows,\n    asset: this.krAsset\n});\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;\nthis.collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nawait (0, _liquidations.liquidate)(userThree, this.krAsset, this.collateral);\nconst MLM = (0, _lib.fromBig)(await hre.Diamond.maxLiquidationMultiplier(), 18);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.closeTo(1.4 * MLM, CR_DELTA);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d3d41776-a11a-46a5-9345-ab1a24b39633&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to LT with multiple CDPs&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to LT with multiple CDPs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4404,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateral2 = await (0, _collaterals.addMockCollateralAsset)({\n    name: \&quot;Collateral\&quot;,\n    decimals: 18,\n    factor: 1,\n    price: 10\n});\nconst userThree = hre.users.userThree;\nconst [deposits1, deposits2] = [\n    (0, _lib.toBig)(10),\n    (0, _lib.toBig)(5)\n];\nconst borrows = (0, _lib.toBig)(10);\nthis.collateral.setPrice(10);\nthis.krAsset.setPrice(10);\nawait Promise.all([\n    await this.collateral.setBalance(userThree, deposits1),\n    await collateral2.setBalance(userThree, deposits2),\n    await (0, _collaterals.depositCollateral)({\n        user: userThree,\n        amount: deposits1,\n        asset: this.collateral\n    }),\n    await (0, _collaterals.depositCollateral)({\n        user: userThree,\n        amount: deposits2,\n        asset: collateral2\n    }),\n    await (0, _krassets.mintKrAsset)({\n        user: userThree,\n        amount: borrows,\n        asset: this.krAsset\n    })\n]);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;\n// seemingly random order of updates to test that the liquidation works regardless\nthis.collateral.setPrice(6.25);\nawait collateral2.update({\n    factor: 0.975,\n    name: \&quot;updated\&quot;\n});\nawait this.krAsset.update({\n    factor: 1.05,\n    name: \&quot;updated\&quot;,\n    closeFee: 0.02,\n    openFee: 0,\n    supplyLimit: 1000000\n});\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.greaterThan(1.05);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nawait (0, _liquidations.liquidate)(userThree, this.krAsset, this.collateral, true);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.lessThan(1.4);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nawait (0, _liquidations.liquidate)(userThree, this.krAsset, collateral2);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userThree.address)).to.be.closeTo(1.4, CR_DELTA);\n            // expect(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;39c5323a-49d9-46dd-84f5-ed164605e957&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit LiquidationOccurred event&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should emit LiquidationOccurred event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:485,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt liquidation\nconst collateralIndex = await hre.Diamond.getDepositedCollateralAssetIndex(hre.users.userOne.address, this.collateral.address);\nawait this.krAsset.update({\n    name: \&quot;jesus\&quot;,\n    factor: 1.5,\n    supplyLimit: 10000000,\n    closeFee: 0.05,\n    openFee: 0\n});\nconst mintedKreskoAssetIndex = await hre.Diamond.getMintedKreskoAssetsIndex(hre.users.userOne.address, this.krAsset.address);\nconst maxLiqValue = await hre.Diamond.getMaxLiquidation(hre.users.userOne.address, this.krAsset.address, this.collateral.address);\nconst repayAmount = maxLiqValue.wadDiv(await this.krAsset.getPrice());\nconst tx = await (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, collateralIndex, false);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;LiquidationOccurred\&quot;);\n(0, _chai.expect)(event.account).to.equal(hre.users.userOne.address);\n(0, _chai.expect)(event.liquidator).to.equal(hre.users.userTwo.address);\n(0, _chai.expect)(event.repayKreskoAsset).to.equal(this.krAsset.address);\n(0, _chai.expect)(event.repayAmount).to.equal(repayAmount);\n(0, _chai.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4487b6e5-e349-458b-a493-b51c0f273b32&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations of healthy accounts&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations of healthy accounts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:237,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Update collateral price from $5 to $10\nconst newCollateralPrice = 10;\nthis.collateral.setPrice(newCollateralPrice);\n// Confirm that the account has sufficient collateral to not be liquidated\nconst liquidationThreshold = await hre.Diamond.liquidationThreshold();\nconst minimumCollateralUSDValueRequired = await hre.Diamond.getAccountMinimumCollateralValueAtRatio(hre.users.userOne.address, liquidationThreshold);\nconst currUserOneCollateralAmount = await hre.Diamond.collateralDeposits(hre.users.userOne.address, this.collateral.address);\n(0, _chai.expect)((0, _lib.fromBig)(currUserOneCollateralAmount) * newCollateralPrice &gt; (0, _lib.fromBig)(minimumCollateralUSDValueRequired, 8));\nconst canLiquidate = await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address);\n(0, _chai.expect)(canLiquidate).to.equal(false);\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex, false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ecb36845-7079-4143-a975-c10eb2ce4c29&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations if repayment amount is 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations if repayment amount is 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.ZERO_REPAY);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce42f955-fbe6-4458-bc64-ce589c4ecab7&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:130,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Get user&#x27;s debt for this kresko asset\nconst krAssetDebtUserOne = await hre.Diamond.kreskoAssetDebt(hre.users.userOne.address, this.krAsset.address);\n// Ensure we are repaying more than debt\nconst repayAmount = krAssetDebtUserOne.add((0, _lib.toBig)(1));\n// Liquidation should fail\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.KRASSET_BURN_AMOUNT_OVERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;355291e0-5e23-42e4-94cb-dd7514f8fded&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:420,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const maxLiquidationUSD = await hre.Diamond.getMaxLiquidation(hre.users.userOne.address, this.krAsset.address, this.collateral.address);\nconst repaymentAmount = maxLiquidationUSD.add(1e9.toString()).wadDiv(await this.krAsset.getPrice());\n// Ensure liquidation cannot happen\nconst tx = await (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repaymentAmount, this.collateral.address, 0, 0, false);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;LiquidationOccurred\&quot;);\nconst assetInfo = await this.collateral.kresko();\nconst expectedSeizedCollateralAmount = maxLiquidationUSD.wadMul(_ethers.BigNumber.from(assetInfo.liquidationIncentive)).wadDiv(await this.collateral.getPrice());\n(0, _chai.expect)(event.account).to.equal(hre.users.userOne.address);\n(0, _chai.expect)(event.liquidator).to.equal(hre.users.userTwo.address);\n(0, _chai.expect)(event.repayKreskoAsset).to.equal(this.krAsset.address);\n(0, _chai.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)(event.repayAmount).to.not.equal(repaymentAmount);\n(0, _chai.expect)(event.repayAmount).to.be.closeTo(maxLiquidationUSD.wadDiv(await this.krAsset.getPrice()), 1e12);\n(0, _chai.expect)(event.collateralSent).to.be.closeTo(expectedSeizedCollateralAmount, 1e12);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0f64489e-879c-48a5-b27c-fc251783b9bd&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:393,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral.setPrice(this.collateral.deployArgs.price);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address)).to.be.false;\nconst minCollateralUSD = await hre.Diamond.getAccountMinimumCollateralValueAtRatio(hre.users.userOne.address, await hre.Diamond.minimumCollateralizationRatio());\nconst liquidationThresholdUSD = await hre.Diamond.getAccountMinimumCollateralValueAtRatio(hre.users.userOne.address, await hre.Diamond.liquidationThreshold());\nthis.collateral.setPrice(this.collateral.deployArgs.price * 0.775);\nconst accountCollateralValue = await hre.Diamond.getAccountCollateralValue(hre.users.userOne.address);\n(0, _chai.expect)(accountCollateralValue.lt(minCollateralUSD)).to.be.true;\n(0, _chai.expect)(accountCollateralValue.gt(liquidationThresholdUSD)).to.be.true;\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(hre.users.userOne.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e0eb0b2-9653-4d71-b200-cdc7bac97707&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations without liquidator approval of Kresko assets to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow liquidations without liquidator approval of Kresko assets to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:295,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check that liquidator&#x27;s token approval to Kresko.sol contract is 0\n(0, _chai.expect)(await this.krAsset.contract.allowance(hre.users.userTwo.address, hre.Diamond.address)).to.equal(0);\n// Liquidation should succeed despite lack of token approval\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex, false);\n// Confirm that liquidator&#x27;s token approval is still 0\n(0, _chai.expect)(await this.krAsset.contract.allowance(hre.users.userTwo.address, hre.Diamond.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c41dd196-22c3-4dc1-a846-75bd906a35c1&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:290,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidator increases contract&#x27;s token approval\nconst repayAmount = 10;\nawait this.krAsset.contract.connect(hre.users.userTwo).approve(hre.Diamond.address, repayAmount);\n(0, _chai.expect)(await this.krAsset.contract.allowance(hre.users.userTwo.address, hre.Diamond.address)).to.equal(repayAmount);\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userTwo).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex, false)).not.to.be.reverted;\n// Confirm that liquidator&#x27;s token approval is unchanged\n(0, _chai.expect)(await this.krAsset.contract.allowance(hre.users.userTwo.address, hre.Diamond.address)).to.equal(repayAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;28df51c8-3c8b-4c2d-aee2-3bba58035c75&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow borrowers to liquidate themselves&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow borrowers to liquidate themselves&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 5;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.userOne).liquidate(hre.users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.SELF_LIQUIDATION);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;675d8c11-07ec-45c2-9f57-3a0a5375ab82&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow seized amount to underflow without liquidators permission&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow seized amount to underflow without liquidators permission&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1556,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userThree = hre.users.userThree;\nconst deposits = (0, _lib.toBig)(15);\nconst borrows = (0, _lib.toBig)(10);\nthis.collateral.setPrice(10);\nthis.krAsset.setPrice(10);\nawait this.collateral.setBalance(userThree, deposits);\nawait (0, _collaterals.depositCollateral)({\n    user: userThree,\n    amount: deposits,\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userThree,\n    amount: borrows,\n    asset: this.krAsset\n});\nthis.collateral.setPrice(2.5);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nawait this.collateral.setBalance(hre.users.liquidator, deposits.mul(1000));\nconst liqAmount = await (0, _liquidations.getLiqAmount)(userThree, this.krAsset, this.collateral);\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.liquidator,\n    amount: deposits.mul(1000),\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: hre.users.liquidator,\n    amount: liqAmount,\n    asset: this.krAsset\n});\nconst allowSeizeUnderflow = false;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userThree.address, this.krAsset.address, liqAmount, this.collateral.address, await hre.Diamond.getMintedKreskoAssetsIndex(userThree.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userThree.address, this.collateral.address), allowSeizeUnderflow)).to.be.revertedWith(_errors.Error.SEIZED_COLLATERAL_UNDERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;013bec1f-41e4-44db-99b0-e57bd4496d2f&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow seized amount to underflow with liquidators permission&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow seized amount to underflow with liquidators permission&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1535,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userThree = hre.users.userThree;\nconst deposits = (0, _lib.toBig)(15);\nconst borrows = (0, _lib.toBig)(10);\nthis.collateral.setPrice(10);\nthis.krAsset.setPrice(10);\nawait this.collateral.setBalance(userThree, deposits);\nawait (0, _collaterals.depositCollateral)({\n    user: userThree,\n    amount: deposits,\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userThree,\n    amount: borrows,\n    asset: this.krAsset\n});\nthis.collateral.setPrice(2.5);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userThree.address)).to.be.true;\nawait this.collateral.setBalance(hre.users.liquidator, deposits.mul(1000));\nconst liqAmount = await (0, _liquidations.getLiqAmount)(userThree, this.krAsset, this.collateral);\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.liquidator,\n    amount: deposits.mul(1000),\n    asset: this.collateral\n});\nawait (0, _krassets.mintKrAsset)({\n    user: hre.users.liquidator,\n    amount: liqAmount,\n    asset: this.krAsset\n});\nconst allowSeizeUnderflow = true;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userThree.address, this.krAsset.address, liqAmount, this.collateral.address, await hre.Diamond.getMintedKreskoAssetsIndex(userThree.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userThree.address, this.collateral.address), allowSeizeUnderflow)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7a0ecc6d-521d-4e70-baf6-2d0a41b9330e&quot;,&quot;parentUUID&quot;:&quot;44387ac2-abba-436f-b131-69db03b650b0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0b7e338c-5e87-4a45-9bb7-c5706b846871&quot;,&quot;d3d41776-a11a-46a5-9345-ab1a24b39633&quot;,&quot;39c5323a-49d9-46dd-84f5-ed164605e957&quot;,&quot;4487b6e5-e349-458b-a493-b51c0f273b32&quot;,&quot;ecb36845-7079-4143-a975-c10eb2ce4c29&quot;,&quot;ce42f955-fbe6-4458-bc64-ce589c4ecab7&quot;,&quot;355291e0-5e23-42e4-94cb-dd7514f8fded&quot;,&quot;0f64489e-879c-48a5-b27c-fc251783b9bd&quot;,&quot;6e0eb0b2-9653-4d71-b200-cdc7bac97707&quot;,&quot;c41dd196-22c3-4dc1-a846-75bd906a35c1&quot;,&quot;28df51c8-3c8b-4c2d-aee2-3bba58035c75&quot;,&quot;675d8c11-07ec-45c2-9f57-3a0a5375ab82&quot;,&quot;013bec1f-41e4-44db-99b0-e57bd4496d2f&quot;,&quot;7a0ecc6d-521d-4e70-baf6-2d0a41b9330e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:11912,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;title&quot;:&quot;#liquidate - rebasing events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events \&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2201,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;userToLiquidate = hre.users.testUserEight;\nuserToLiquidateTwo = hre.users.testUserNine;\nthis.collateral.setPrice(collateralPrice);\nthis.krAsset.setPrice(krAssetPrice);\n// Deposit collateral for liquidator\nawait (0, _collaterals.depositCollateral)({\n    user: hre.users.liquidator,\n    asset: this.collateral,\n    amount: liquidatorAmounts.collateralDeposits\n});\nawait (0, _testutils.leverageKrAsset)(userToLiquidate, this.krAsset, this.collateral, userToLiquidateAmounts.krAssetCollateralDeposits);\nawait (0, _testutils.leverageKrAsset)(userToLiquidateTwo, this.krAsset, this.collateral, userToLiquidateAmounts.krAssetCollateralDeposits);\nconst mcr = (0, _lib.fromBig)(await hre.Diamond.minimumCollateralizationRatio(), 8);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userToLiquidate.address)).to.lessThanOrEqual(mcr);\n(0, _chai.expect)(await (0, _liquidations.getCR)(userToLiquidateTwo.address)).to.lessThanOrEqual(mcr);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53df6078-6b52-437d-9c4e-97bab03386a3&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:295,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, 1, this.collateral.address, await hre.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.collateral.address), false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7df033dd-1bc2-4dd0-b886-a39dd289e847&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:282,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, 1, this.collateral.address, await hre.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.collateral.address), false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;de8c8beb-6d88-48c1-b588-8a4ec914e1af&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1328,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nthis.collateral.setPrice(5);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.true;\nawait (0, _chai.expect)((0, _liquidations.liquidate)(userToLiquidate, this.krAsset, this.collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;24639c4f-b1f5-46c3-b98f-a2b5e103ef5a&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1404,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nthis.krAsset.setPrice(rebasePrice * 2);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.true;\nawait (0, _chai.expect)((0, _liquidations.liquidate)(userToLiquidate, this.krAsset, this.collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;490e723f-6578-4e65-a14a-cb426c45c7ec&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate krAsset collaterals up to min amount&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate krAsset collaterals up to min amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2855,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 10;\nawait this.collateral.setBalance(userToLiquidate, (0, _lib.toBig)(100));\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, userToLiquidate).depositCollateral(userToLiquidate.address, this.collateral.address, (0, _lib.toBig)(100));\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, userToLiquidate).mintKreskoAsset(userToLiquidate.address, (await (0, _krassets.addMockKreskoAsset)()).address, (0, _lib.toBig)(65));\nthis.krAsset.setPrice(newPrice);\nconst deposits = await hre.Diamond.collateralDeposits(userToLiquidate.address, this.krAsset.address);\nconst debt = await hre.Diamond.kreskoAssetDebt(userToLiquidate.address, this.krAsset.address);\nconst liqAmount = await (0, _liquidations.getLiqAmount)(userToLiquidate, this.krAsset, this.krAsset);\n(0, _chai.expect)(deposits).to.equal(liqAmount);\n(0, _chai.expect)(debt).to.gte(liqAmount);\nawait this.krAsset.setBalance(hre.users.liquidator, debt);\nconst assetInfoCollateral = await hre.Diamond.collateralAsset(this.krAsset.address);\nconst assetInfoKr = await hre.Diamond.kreskoAsset(this.krAsset.address);\nconst liquidationAmount = liqAmount.add(\&quot;263684912200000000\&quot;).wadDiv(assetInfoCollateral.liquidationIncentive).wadMul(_ethers.BigNumber.from(_lib.WAD).sub(assetInfoKr.closeFee)).add(_lib.WAD);\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, liquidationAmount, this.krAsset.address, await hre.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.krAsset.address), false);\nconst depositsAfter = await hre.Diamond.collateralDeposits(userToLiquidate.address, this.krAsset.address);\n(0, _chai.expect)(depositsAfter).to.equal(1e12.toString());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a84b48d8-afc3-40e9-9e85-4d94a489a09e&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate krAsset collaterals to 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate krAsset collaterals to 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2818,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 10;\nawait this.collateral.setBalance(userToLiquidate, (0, _lib.toBig)(100));\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, userToLiquidate).depositCollateral(userToLiquidate.address, this.collateral.address, (0, _lib.toBig)(100));\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, userToLiquidate).mintKreskoAsset(userToLiquidate.address, (await (0, _krassets.addMockKreskoAsset)()).address, (0, _lib.toBig)(65));\nthis.krAsset.setPrice(newPrice);\nconst deposits = await hre.Diamond.collateralDeposits(userToLiquidate.address, this.krAsset.address);\nconst debt = await hre.Diamond.kreskoAssetDebt(userToLiquidate.address, this.krAsset.address);\nconst liqAmount = await (0, _liquidations.getLiqAmount)(userToLiquidate, this.krAsset, this.krAsset);\n(0, _chai.expect)(deposits).to.equal(liqAmount);\n(0, _chai.expect)(debt).to.gte(liqAmount);\nawait this.krAsset.setBalance(hre.users.liquidator, debt);\nconst assetInfoCollateral = await hre.Diamond.collateralAsset(this.krAsset.address);\nconst assetInfoKr = await hre.Diamond.kreskoAsset(this.krAsset.address);\nconst liquidationAmount = liqAmount.add(\&quot;263684912400000000\&quot;).wadDiv(assetInfoCollateral.liquidationIncentive).wadMul(_ethers.BigNumber.from(_lib.WAD).sub(assetInfoKr.closeFee)).add(_lib.WAD);\nawait (0, _testutils.wrapContractWithSigner)(hre.Diamond, hre.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, liquidationAmount, this.krAsset.address, await hre.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hre.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.krAsset.address), false);\nconst depositsAfter = await hre.Diamond.collateralDeposits(userToLiquidate.address, this.krAsset.address);\n(0, _chai.expect)(depositsAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b5ff0674-1c2a-4d93-aff5-2186e5e85778&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5330,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 2;\nthis.krAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)){\n    const values = await (0, _liquidations.liquidate)(userToLiquidate, this.krAsset, this.krAsset);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(userToLiquidate.address), 8);\nresults.userOneHFAfter = await (0, _liquidations.getCR)(userToLiquidate.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = newPrice / denominator;\n// Rebase\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)){\n    const values = await (0, _liquidations.liquidate)(userToLiquidateTwo, this.krAsset, this.krAsset);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(userToLiquidateTwo.address), 8);\nresults.userTwoHFAfter = await (0, _liquidations.getCR)(userToLiquidateTwo.address);\n(0, _chai.expect)(results.userTwoHFAfter).to.closeTo(results.userOneHFAfter, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.collateralSeized * denominator).to.closeTo(results.collateralSeizedRebase, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.debtRepaid * denominator).to.closeTo(results.debtRepaidRebase, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.userOneValueAfter).to.closeTo(results.userTwoValueAfter, INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;805eca76-a57d-4a05-a7cd-3f008a36f06d&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of assets after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of assets after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4926,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 2;\nthis.krAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.isAccountLiquidatable(userToLiquidate.address)){\n    const values = await (0, _liquidations.liquidate)(userToLiquidate, this.krAsset, this.krAsset);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(userToLiquidate.address), 8);\nresults.userOneHFAfter = await (0, _liquidations.getCR)(userToLiquidate.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = newPrice * denominator;\n// Rebase\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)){\n    const values = await (0, _liquidations.liquidate)(userToLiquidateTwo, this.krAsset, this.krAsset);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(userToLiquidateTwo.address), 8);\nresults.userTwoHFAfter = await (0, _liquidations.getCR)(userToLiquidateTwo.address);\n(0, _chai.expect)(results.userTwoHFAfter).to.closeTo(results.userOneHFAfter, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.collateralSeized / denominator).to.closeTo(results.collateralSeizedRebase, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.debtRepaid / denominator).to.closeTo(results.debtRepaidRebase, INTEREST_RATE_DELTA);\n(0, _chai.expect)(results.userOneValueAfter).to.closeTo(results.userTwoValueAfter, INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5bda36c0-897e-4954-9bb5-75381b9aa5a0&quot;,&quot;parentUUID&quot;:&quot;d98cb1cf-38e0-499a-9091-5e26c84159f2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7df033dd-1bc2-4dd0-b886-a39dd289e847&quot;,&quot;de8c8beb-6d88-48c1-b588-8a4ec914e1af&quot;,&quot;24639c4f-b1f5-46c3-b98f-a2b5e103ef5a&quot;,&quot;490e723f-6578-4e65-a14a-cb426c45c7ec&quot;,&quot;a84b48d8-afc3-40e9-9e85-4d94a489a09e&quot;,&quot;b5ff0674-1c2a-4d93-aff5-2186e5e85778&quot;,&quot;805eca76-a57d-4a05-a7cd-3f008a36f06d&quot;,&quot;5bda36c0-897e-4954-9bb5-75381b9aa5a0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:19238,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;893327f5-d6fa-4094-ab88-4af05caf0f43&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0ee33a9c-56b0-40c3-97d1-fff4b6b3fd51&quot;,&quot;parentUUID&quot;:&quot;893327f5-d6fa-4094-ab88-4af05caf0f43&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:77,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = this.collaterals.find((c)=&gt;c.deployArgs.name === _testutils.defaultCollateralArgs.name);\nthis.krAsset = this.krAssets.find((c)=&gt;c.deployArgs.name === _testutils.defaultKrAssetArgs.name);\nawait this.krAsset.contract.grantRole(_testutils.Role.OPERATOR, _hardhat.default.users.deployer.address);\nthis.krAsset.setPrice(this.krAsset.deployArgs.price);\nthis.krAsset.setMarketOpen(this.krAsset.deployArgs.marketOpen);\n// Load account with collateral\nthis.initialBalance = (0, _lib.toBig)(100000);\nawait this.collateral.setBalance(_hardhat.default.users.userOne, this.initialBalance);\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [_hardhat.default.users.userOne.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\nthis.collateral.setPrice(this.collateral.deployArgs.price);\n// User deposits 10,000 collateral\nawait (0, _collaterals.depositCollateral)({\n    amount: 10000,\n    user: _hardhat.default.users.userOne,\n    asset: this.collateral\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c9209484-a274-46e2-a510-e348ef31ab2c&quot;,&quot;parentUUID&quot;:&quot;893327f5-d6fa-4094-ab88-4af05caf0f43&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;29ce5110-4ac7-4e40-a3d8-7cf186164c5e&quot;,&quot;title&quot;:&quot;#mint+burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:261,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, _lib.toBig)(10);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMinted = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(amountMinted).to.equal(mintAmount);\n// Confirm the user&#x27;s Kresko asset balance has increased\nconst userBalance = await this.krAsset.mocks.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalance).to.equal(mintAmount);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter.eq(kreskoAssetTotalSupplyBefore.add(mintAmount)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;947d62cc-d331-4bc8-8398-be2062be397d&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow successive, valid mints of the same Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow successive, valid mints of the same Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:464,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyInitial = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyInitial).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, _lib.toBig)(50);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyInitial.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _lib.toBig)(50);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, secondMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets is unchanged\nconst mintedKreskoAssetsFinal = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedFinal = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(amountMintedFinal).to.closeTo(firstMintAmount.add(secondMintAmount), INTEREST_RATE_DELTA);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalanceFinal).to.closeTo(amountMintedFinal, INTEREST_RATE_DELTA);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyFinal = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyFinal).to.closeTo(kreskoAssetTotalSupplyAfter.add(secondMintAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;befd510e-68b2-4d37-8c2f-c79ab540fcc2&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint multiple different Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint multiple different Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1562,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyInitial = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyInitial).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, _lib.toBig)(10);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyInitial.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Add second mock krAsset to protocol\nconst secondKrAssetArgs = {\n    name: \&quot;SecondKreskoAsset\&quot;,\n    symbol: \&quot;SecondKreskoAsset\&quot;,\n    price: 5,\n    marketOpen: true,\n    factor: 1,\n    supplyLimit: 100000,\n    closeFee: _testutils.defaultCloseFee,\n    openFee: 0\n};\nconst { contract: secondKreskoAsset  } = await (0, _krassets.addMockKreskoAsset)(secondKrAssetArgs);\n// Mint Kresko asset\nconst secondMintAmount = (0, _lib.toBig)(20);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, secondKreskoAsset.address, secondMintAmount);\n// Confirm that the second address has been pushed to the array of the user&#x27;s minted Kresko assets\nconst mintedKreskoAssetsFinal = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    this.krAsset.address,\n    secondKreskoAsset.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedAssetTwo = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, secondKreskoAsset.address);\n(0, _chai.expect)(amountMintedAssetTwo).to.equal(secondMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await secondKreskoAsset.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalanceFinal).to.equal(amountMintedAssetTwo);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst secondKreskoAssetTotalSupply = await secondKreskoAsset.totalSupply();\n(0, _chai.expect)(secondKreskoAssetTotalSupply).to.equal(secondMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e882ffd1-19ee-4290-86b6-cc94459e0953&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the user does not have an existing debt position for this Kresko asset\nconst initialKreskoAssetDebt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(initialKreskoAssetDebt).to.equal(0);\n// Confirm that the mint amount&#x27;s USD value is equal to the contract&#x27;s current minimum debt value\nconst mintAmount = (0, _lib.toBig)(1); // 1 * $10 = $10\nconst mintAmountUSDValue = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\nconst currMinimumDebtValue = await _hardhat.default.Diamond.minimumDebtValue();\n(0, _chai.expect)((0, _lib.fromBig)(mintAmountUSDValue, 8)).to.equal(Number(currMinimumDebtValue) / 10 ** 8);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Confirm that the mint was successful and user&#x27;s balances have increased\nconst finalKreskoAssetDebt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(finalKreskoAssetDebt).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d12ea888-a86e-4f3c-99cc-415f60fcb1ce&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:278,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).grantRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address)).to.equal(true);\n// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// userThree (trusted contract) mints Kresko asset for userOne\nconst mintAmount = (0, _lib.toBig)(10);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Check that debt exists now for userOne\nconst userOneDebtFromUserThreeMint = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(userOneDebtFromUserThreeMint).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e1bcb888-c1fc-4de5-a320-37cb812fa5d0&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetMinted event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should emit KreskoAssetMinted event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:164,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = (0, _lib.toBig)(500);\nconst tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;KreskoAssetMinted\&quot;);\n(0, _chai.expect)(event.account).to.equal(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(this.krAsset.address);\n(0, _chai.expect)(event.amount).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;323efc82-ce8f-4178-a7d9-6bf6738d0fcb&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:70,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, _lib.toBig)(1);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userTwo.address, this.krAsset.address, mintAmount)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.userOne.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;df1775d1-da03-4157-83fb-48f7b6c59bed&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the user does not have an existing debt position for this Kresko asset\nconst initialKreskoAssetDebt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(initialKreskoAssetDebt).to.equal(0);\n// Confirm that the mint amount&#x27;s USD value is below the contract&#x27;s current minimum debt value\nconst minAmount = 100000000; // 8 decimals\nconst mintAmount = minAmount - 1;\nconst mintAmountUSDValue = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\nconst currMinimumDebtValue = await _hardhat.default.Diamond.minimumDebtValue();\n(0, _chai.expect)(Number(mintAmountUSDValue)).to.be.lessThan(Number(currMinimumDebtValue));\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount)).to.be.revertedWith(_errors.Error.KRASSET_MINT_AMOUNT_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;db33dd30-dcbc-472d-bd46-a20cf03e8a71&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt to mint a non-deployed, non-whitelisted Kresko asset\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, \&quot;0x0000000000000000000000000000000000000002\&quot;, (0, _lib.toBig)(1))).to.be.revertedWith(_errors.Error.KRASSET_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e07a2f97-985c-461c-b4c3-39fe35b20387&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:115,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// We can ignore price and collateral factor as both this.collateral and this.krAsset both\n// have the same price ($10) and same collateral factor (1)\nconst collateralAmountDeposited = await _hardhat.default.Diamond.collateralDeposits(_hardhat.default.users.userOne.address, this.collateral.address);\n// Apply 150% MCR and increase deposit amount to be above the maximum allowed by MCR\nconst mcrAmount = (0, _lib.fromBig)(collateralAmountDeposited) / 1.5;\nconst mintAmount = (0, _lib.toBig)(mcrAmount + 1);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount)).to.be.revertedWith(_errors.Error.KRASSET_COLLATERAL_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9a14ec10-1dab-4520-8946-5dfdd8d7f96f&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:82,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// User deposits another 10,000 collateral tokens, enabling mints of up to 20,000/1.5 = ~13,333 kresko asset tokens\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).depositCollateral(_hardhat.default.users.userOne.address, this.collateral.address, (0, _lib.toBig)(10000))).not.to.be.reverted;\nconst krAsset = await _hardhat.default.Diamond.kreskoAsset(this.krAsset.address);\nconst overSupplyLimit = (0, _lib.fromBig)(krAsset.supplyLimit) + 1;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, (0, _lib.toBig)(overSupplyLimit))).to.be.revertedWith(_errors.Error.KRASSET_MAX_SUPPLY_REACHED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6497ddb1-a3c6-49bd-b7c2-f97e3cb183e0&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d3b3d991-6378-4477-b418-e11d0630dc36&quot;,&quot;parentUUID&quot;:&quot;3977cde8-8dcb-49e0-97ba-97c51c1b8b03&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;947d62cc-d331-4bc8-8398-be2062be397d&quot;,&quot;befd510e-68b2-4d37-8c2f-c79ab540fcc2&quot;,&quot;e882ffd1-19ee-4290-86b6-cc94459e0953&quot;,&quot;d12ea888-a86e-4f3c-99cc-415f60fcb1ce&quot;,&quot;e1bcb888-c1fc-4de5-a320-37cb812fa5d0&quot;,&quot;323efc82-ce8f-4178-a7d9-6bf6738d0fcb&quot;,&quot;df1775d1-da03-4157-83fb-48f7b6c59bed&quot;,&quot;db33dd30-dcbc-472d-bd46-a20cf03e8a71&quot;,&quot;e07a2f97-985c-461c-b4c3-39fe35b20387&quot;,&quot;9a14ec10-1dab-4520-8946-5dfdd8d7f96f&quot;,&quot;6497ddb1-a3c6-49bd-b7c2-f97e3cb183e0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;d3b3d991-6378-4477-b418-e11d0630dc36&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:3544,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;2bb8f12c-c393-403e-87fe-ee1b9bc4f380&quot;,&quot;title&quot;:&quot;#mint - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f2ee9e11-8cc3-4b95-97a8-042467dcd269&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:241,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;705d2982-eb76-440c-b04c-b36bbcfe58cb&quot;,&quot;parentUUID&quot;:&quot;f2ee9e11-8cc3-4b95-97a8-042467dcd269&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:243,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8276ce71-d7c0-4f5f-abdd-387f4ddc2f9a&quot;,&quot;parentUUID&quot;:&quot;f2ee9e11-8cc3-4b95-97a8-042467dcd269&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:239,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b52fb5a-55fb-4d76-afb0-13a0c6da5df4&quot;,&quot;parentUUID&quot;:&quot;f2ee9e11-8cc3-4b95-97a8-042467dcd269&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:256,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e7c7e2d0-4c60-41cf-a612-378a8f1b2136&quot;,&quot;parentUUID&quot;:&quot;f2ee9e11-8cc3-4b95-97a8-042467dcd269&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;705d2982-eb76-440c-b04c-b36bbcfe58cb&quot;,&quot;8276ce71-d7c0-4f5f-abdd-387f4ddc2f9a&quot;,&quot;0b52fb5a-55fb-4d76-afb0-13a0c6da5df4&quot;,&quot;e7c7e2d0-4c60-41cf-a612-378a8f1b2136&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:979,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;54ec0703-b3a5-4c76-933f-757c5c773e64&quot;,&quot;title&quot;:&quot;debt values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when mint is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when mint is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:325,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst valueBeforeRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n// Adjust price accordingly\nconst assetPrice = await this.krAsset.getPrice();\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPrice.div(denominator), 8));\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ed3bdd0-6e23-455e-8d52-e9abae5dde63&quot;,&quot;parentUUID&quot;:&quot;54ec0703-b3a5-4c76-933f-757c5c773e64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when mint is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when mint is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:307,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\nconst valueBeforeRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n// Adjust price accordingly\nconst assetPrice = await this.krAsset.getPrice();\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPrice.mul(denominator), 8));\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;46ada493-2e09-49cf-b42f-92744feaef1b&quot;,&quot;parentUUID&quot;:&quot;54ec0703-b3a5-4c76-933f-757c5c773e64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:301,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.mul(denominator);\nconst assetPrice = await this.krAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price accordingly\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPrice, 8) / denominator);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3589278b-1c3b-49d1-88bd-f4cb04a5ec8c&quot;,&quot;parentUUID&quot;:&quot;54ec0703-b3a5-4c76-933f-757c5c773e64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:292,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.div(denominator);\nconst assetPrice = await this.krAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price accordingly\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPrice.mul(denominator), 8));\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b4e259d-6413-4a5d-9485-1c821d4ad050&quot;,&quot;parentUUID&quot;:&quot;54ec0703-b3a5-4c76-933f-757c5c773e64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9ed3bdd0-6e23-455e-8d52-e9abae5dde63&quot;,&quot;46ada493-2e09-49cf-b42f-92744feaef1b&quot;,&quot;3589278b-1c3b-49d1-88bd-f4cb04a5ec8c&quot;,&quot;0b4e259d-6413-4a5d-9485-1c821d4ad050&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1225,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;9b64e8f5-ae8d-41b8-971a-4e87315ddbf3&quot;,&quot;title&quot;:&quot;debt values and amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values and amounts are calculated correctly when minted before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:666,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\nconst assetPrice = await this.krAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintAmountAfterRebase = mintAmount.mul(denominator);\nconst assetPriceRebase = assetPrice.div(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\nconst debtAmountAfterFirstMint = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfterFirstMint = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.bignumber.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPriceRebase, 8));\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\nconst debtAmountAfterFirstRebase = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, this.krAsset)).to.bignumber.equal(debtValueAfterFirstMint);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, this.krAsset)).to.bignumber.equal(valueBeforeRebase);\n// Mint after rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmountAfterRebase);\n// Ensure debt amounts and balances match\nconst balanceAfterSecondMint = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// Ensure balance matches\nconst expectedBalanceAfterSecondMint = balanceAfterFirstRebase.add(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterSecondMint).to.bignumber.equal(expectedBalanceAfterSecondMint);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterSecondMint, this.krAsset)).to.bignumber.closeTo(debtValueAfterFirstMint.mul(2), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(valueBeforeRebase.mul(2), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2bc3b1f5-c0e4-4c24-8be0-f613565859ac&quot;,&quot;parentUUID&quot;:&quot;9b64e8f5-ae8d-41b8-971a-4e87315ddbf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values and amounts are calculated correctly when minted before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:673,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\nconst assetPrice = await this.krAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintAmountAfterRebase = mintAmount.div(denominator);\nconst assetPriceRebase = assetPrice.mul(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Mint before rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\nconst debtAmountAfterFirstMint = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfterFirstMint = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.bignumber.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nthis.krAsset.setPrice((0, _lib.fromBig)(assetPriceRebase, 8));\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(_hardhat.default.users.userOne, this.krAsset);\nconst debtAmountAfterFirstRebase = await userOne.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(debtValueAfterFirstRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint, this.krAsset));\n(0, _chai.expect)(debtValueAfterFirstRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, this.krAsset));\n// Mint after rebase\nawait userOne.mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmountAfterRebase);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await userOne.getAccountKrAssetValue(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint.mul(2), this.krAsset), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(await (0, _calculations.toScaledAmount)(valueBeforeRebase.mul(2), this.krAsset), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ddaf84b-33d4-4a91-9223-761949383d89&quot;,&quot;parentUUID&quot;:&quot;9b64e8f5-ae8d-41b8-971a-4e87315ddbf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2bc3b1f5-c0e4-4c24-8be0-f613565859ac&quot;,&quot;2ddaf84b-33d4-4a91-9223-761949383d89&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1339,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:759,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Create userOne debt position\nthis.mintAmount = (0, _lib.toBig)(20);\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, this.mintAmount);\n// Load userThree with Kresko Assets\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [_hardhat.default.users.userThree.address]: this.initialBalance\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [_hardhat.default.users.userThree.address]: {\n        [_hardhat.default.Diamond.address]: this.initialBalance\n    }\n});\n(0, _chai.expect)(await this.collateral.contract.balanceOf(_hardhat.default.users.userThree.address)).to.equal(this.initialBalance);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).depositCollateral(_hardhat.default.users.userThree.address, this.collateral.address, (0, _lib.toBig)(10000))).not.to.be.reverted;\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).mintKreskoAsset(_hardhat.default.users.userThree.address, this.krAsset.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;10e2e971-e338-4c7e-8d48-3f1ae24cf2dc&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to burn some of their Kresko asset balances&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn some of their Kresko asset balances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:211,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _lib.toBig)(1);\nconst kreskoAssetIndex = 0;\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user no long holds the burned Kresko asset amount\nconst userBalance = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userBalance).to.equal(this.mintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userDebt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(userDebt).to.closeTo(this.mintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8283e4bf-8236-4087-a41c-0dbcd5b6ed4f&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn their full balance of a Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn their full balance of a Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2eeb5efb-b547-438f-b1b4-8a8befcd427c&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:336,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.deployer).grantRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_testutils.Role.MANAGER, _hardhat.default.users.userThree.address)).to.equal(true);\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _lib.toBig)(1);\nconst kreskoAssetIndex = 0;\n// User three burns it&#x27;s KreskoAsset to reduce userOnes debt\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;\n// Confirm the userOne had no effect on it&#x27;s kreskoAsset balance\nconst userOneBalance = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(userOneBalance).to.equal(this.mintAmount);\n// Confirm the userThree no long holds the burned Kresko asset amount\nconst userThreeBalance = await this.krAsset.contract.balanceOf(_hardhat.default.users.userThree.address);\n(0, _chai.expect)(userThreeBalance).to.equal(this.mintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userOneDebt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(userOneDebt).to.closeTo(this.mintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a0eca586-7c9c-44f7-a351-0e5edb6bed80&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;68b6a9b2-a4d6-40bf-aed2-b62ecb2db340&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:759,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalanceBefore = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Calculate actual burn amount\nconst userOneDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst minDebtValue = (0, _lib.fromBig)(await _hardhat.default.Diamond.minimumDebtValue(), 8);\nconst oraclePrice = this.krAsset.deployArgs.price;\nconst burnAmount = (0, _lib.toBig)((0, _lib.fromBig)(userOneDebt) - minDebtValue / oraclePrice);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nawait (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user holds the expected Kresko asset amount\nconst userBalance = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n// expect(fromBig(userBalance)).to.equal(fromBig(userBalanceBefore.sub(burnAmount)));\n(0, _chai.expect)(userBalance).eq(userBalanceBefore.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).eq(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    this.krAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst newUserDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(newUserDebt).to.be.equal(userOneDebt.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0a30e266-f73f-4a56-97db-6ee347008830&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetBurned event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should emit KreskoAssetBurned event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:151,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, this.mintAmount.div(5), kreskoAssetIndex);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;KreskoAssetBurned\&quot;);\n(0, _chai.expect)(event.account).to.equal(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(this.krAsset.address);\n(0, _chai.expect)(event.amount).to.equal(this.mintAmount.div(5));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8d036189-9aa0-4a3a-a311-f182f5f3ea6c&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:378,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const secondMintAmount = 1;\nconst burnAmount = this.mintAmount.add(secondMintAmount);\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, secondMintAmount)).to.not.be.reverted;\nconst kreskoAssetIndex = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;31777be1-47e2-4fc3-a078-59691b2871de&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, 0, kreskoAssetIndex)).to.be.revertedWith(_errors.Error.ZERO_BURN);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;05b3e096-d6c0-4e09-8c4b-0cd67a82b869&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userThree).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, 100, kreskoAssetIndex)).to.be.revertedWith(`AccessControl: account ${_hardhat.default.users.userThree.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fbf5495e-c698-4011-91d9-aa604b4829b3&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst burnAmount = debt.add((0, _lib.toBig)(1));\nawait (0, _chai.expect)((0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f02f166e-7a24-4f43-b561-c69db5e76122&quot;,&quot;parentUUID&quot;:&quot;826fd347-736b-4c9d-bfe7-fd02fbf9f48d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b5038575-8fd0-4646-b925-f7262fee5d01&quot;,&quot;title&quot;:&quot;Protocol open fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol open fee should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:444,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const openFee = 0.01;\nconst openFeeBig = (0, _lib.toBig)(openFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nthis.krAsset = _hardhat.default.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _testutils.defaultKrAssetArgs.symbol);\nawait this.krAsset.update({\n    ..._testutils.defaultKrAssetArgs,\n    openFee\n});\nconst mintAmount = (0, _lib.toBig)(1);\nconst mintValue = mintAmount.mul(this.krAsset.deployArgs.price);\nconst expectedFeeValue = mintValue.mul(openFeeBig);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(this.collateral.deployArgs.price);\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await this.collateral.contract.balanceOf(await _hardhat.default.Diamond.feeRecipient());\n// Mint Kresko asset\nconst tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).mintKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await this.collateral.contract.balanceOf(await _hardhat.default.Diamond.feeRecipient());\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, _lib.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;OpenFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, _lib.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);\n// Now verify that calcExpectedFee function returns accurate fee amount\nconst feeRes = await _hardhat.default.Diamond.calcExpectedFee(_hardhat.default.users.userOne.address, this.krAsset.address, mintAmount, _testutils.Fee.OPEN);\nconst output = feeRes.toString().split(\&quot;,\&quot;);\nconst openFeeAmount = Number(output[1]) / 10 ** 18;\n(0, _chai.expect)(openFeeAmount).eq(normalizedExpectedCollateralFeeAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8fbc114c-5a25-4ebb-ba0c-d135f7e9a1f0&quot;,&quot;parentUUID&quot;:&quot;b5038575-8fd0-4646-b925-f7262fee5d01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8fbc114c-5a25-4ebb-ba0c-d135f7e9a1f0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:444,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;a3e49831-55ce-492c-953c-f8de9838d1cc&quot;,&quot;title&quot;:&quot;Protocol close fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:230,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const burnAmount = (0, _lib.toBig)(1);\nconst burnValue = burnAmount.mul(this.krAsset.deployArgs.price);\nconst closeFee = (0, _lib.toBig)(this.krAsset.deployArgs.closeFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nconst expectedFeeValue = burnValue.mul(closeFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(this.collateral.deployArgs.price);\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await this.collateral.contract.balanceOf(await _hardhat.default.Diamond.feeRecipient());\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nconst tx = await (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne).burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await this.collateral.contract.balanceOf(_hardhat.default.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await this.collateral.contract.balanceOf(await _hardhat.default.Diamond.feeRecipient());\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, _lib.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, _lib.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;be6dc08e-7067-4870-a2e2-d33259ce867a&quot;,&quot;parentUUID&quot;:&quot;a3e49831-55ce-492c-953c-f8de9838d1cc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge correct protocol close fee after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1003,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = 10;\nconst wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = (0, _lib.toBig)(burnAmount * this.krAsset.deployArgs.closeFee);\nconst expectedFeeValue = (0, _lib.toBig)(burnAmount * this.krAsset.deployArgs.price * this.krAsset.deployArgs.closeFee, 8);\nawait (0, _krassets.mintKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: (0, _lib.toBig)(mintAmount)\n});\nawait (0, _collaterals.withdrawCollateral)({\n    user: _hardhat.default.users.userThree,\n    asset: this.collateral,\n    amount: wAmount\n});\nconst event = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: burnAmount\n}), _hardhat.default.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = true;\nconst priceAfter = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(priceAfter);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount * denominator;\nawait (0, _collaterals.withdrawCollateral)({\n    user: _hardhat.default.users.userThree,\n    asset: this.collateral,\n    amount: wAmount\n});\nconst eventAfterRebase = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: burnAmountRebase\n}), _hardhat.default.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ea55e423-81cc-4e68-a389-5934bd451ff0&quot;,&quot;parentUUID&quot;:&quot;a3e49831-55ce-492c-953c-f8de9838d1cc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge correct protocol close fee after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:907,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = 10;\nconst wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = (0, _lib.toBig)(burnAmount * this.krAsset.deployArgs.closeFee);\nconst expectedFeeValue = (0, _lib.toBig)(burnAmount * this.krAsset.deployArgs.price * this.krAsset.deployArgs.closeFee, 8);\nawait (0, _krassets.mintKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: (0, _lib.toBig)(mintAmount)\n});\nawait (0, _collaterals.withdrawCollateral)({\n    user: _hardhat.default.users.userThree,\n    asset: this.collateral,\n    amount: wAmount\n});\nconst event = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: burnAmount\n}), _hardhat.default.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = false;\nconst priceAfter = (0, _lib.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(priceAfter);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount / denominator;\nawait (0, _collaterals.withdrawCollateral)({\n    user: _hardhat.default.users.userThree,\n    asset: this.collateral,\n    amount: wAmount\n});\nconst eventAfterRebase = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: _hardhat.default.users.userThree,\n    asset: this.krAsset,\n    amount: burnAmountRebase\n}), _hardhat.default.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6c96132f-610d-4b2a-9a51-587f5df37507&quot;,&quot;parentUUID&quot;:&quot;a3e49831-55ce-492c-953c-f8de9838d1cc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;be6dc08e-7067-4870-a2e2-d33259ce867a&quot;,&quot;ea55e423-81cc-4e68-a389-5934bd451ff0&quot;,&quot;6c96132f-610d-4b2a-9a51-587f5df37507&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2140,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;8283e4bf-8236-4087-a41c-0dbcd5b6ed4f&quot;,&quot;a0eca586-7c9c-44f7-a351-0e5edb6bed80&quot;,&quot;0a30e266-f73f-4a56-97db-6ee347008830&quot;,&quot;8d036189-9aa0-4a3a-a311-f182f5f3ea6c&quot;,&quot;31777be1-47e2-4fc3-a078-59691b2871de&quot;,&quot;05b3e096-d6c0-4e09-8c4b-0cd67a82b869&quot;,&quot;fbf5495e-c698-4011-91d9-aa604b4829b3&quot;,&quot;f02f166e-7a24-4f43-b561-c69db5e76122&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;2eeb5efb-b547-438f-b1b4-8a8befcd427c&quot;,&quot;68b6a9b2-a4d6-40bf-aed2-b62ecb2db340&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:1966,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;9199dffb-01de-4014-a498-441b5bc93414&quot;,&quot;title&quot;:&quot;#burn - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events \&quot;before each\&quot; hook in \&quot;#burn - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:161,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmountInt,\n    user: _hardhat.default.users.userOne\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b546c4a-aaf6-422e-b813-72654b72465b&quot;,&quot;parentUUID&quot;:&quot;9199dffb-01de-4014-a498-441b5bc93414&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;47835fb2-6df0-41ef-8e87-4d91ccc0f1f8&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:256,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst repayAmount = debt;\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(0);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = (0, _lib.fromBig)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address));\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.closeTo((0, _lib.toBig)(expectedBalanceAfterBurn / denominator), 100000); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;115c4e2c-ac48-453a-8b0d-b153c1514c26&quot;,&quot;parentUUID&quot;:&quot;47835fb2-6df0-41ef-8e87-4d91ccc0f1f8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:276,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst repayAmount = debt.div(2);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).mul(denominator);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.mul(denominator).sub(repayAmount);\nconst balanceAfterBurn = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.div(denominator));\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c390908c-cddd-48c4-8e2f-2a0137691de7&quot;,&quot;parentUUID&quot;:&quot;47835fb2-6df0-41ef-8e87-4d91ccc0f1f8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:259,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst repayAmount = debt;\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = 0;\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = (0, _lib.fromBig)(await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address));\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal((0, _lib.toBig)(expectedBalanceAfterBurn * denominator)); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5239c145-3c66-4349-bfb3-4b7908a37631&quot;,&quot;parentUUID&quot;:&quot;47835fb2-6df0-41ef-8e87-4d91ccc0f1f8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:288,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst repayAmount = debt.div(2);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).div(denominator);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.div(denominator).sub(repayAmount);\nconst balanceAfterBurn = await this.krAsset.contract.balanceOf(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.mul(denominator));\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5cdc4d15-3654-4e62-bd5d-d1e9690ec59b&quot;,&quot;parentUUID&quot;:&quot;47835fb2-6df0-41ef-8e87-4d91ccc0f1f8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;115c4e2c-ac48-453a-8b0d-b153c1514c26&quot;,&quot;c390908c-cddd-48c4-8e2f-2a0137691de7&quot;,&quot;5239c145-3c66-4349-bfb3-4b7908a37631&quot;,&quot;5cdc4d15-3654-4e62-bd5d-d1e9690ec59b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1079,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ffe3ca51-9c89-438d-a67c-c0047a9f1d6f&quot;,&quot;title&quot;:&quot;debt value and mintedKreskoAssets book-keeping is calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:668,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst fullRepayAmount = mintAmount.mul(denominator);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfter = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false);\n(0, _chai.expect)(debtValueAfter).to.equal(0);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd04a6a4-aebe-4132-b3c7-33623fc03a50&quot;,&quot;parentUUID&quot;:&quot;ffe3ca51-9c89-438d-a67c-c0047a9f1d6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:380,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintValue = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Should contain minted krAsset\nconst mintedKreskoAssetsBeforeBurn = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsBeforeBurn).to.contain(this.krAsset.address);\n// Burn assets\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfter = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;364f967f-bb14-473c-8442-544ca7876270&quot;,&quot;parentUUID&quot;:&quot;ffe3ca51-9c89-438d-a67c-c0047a9f1d6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:295,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst fullRepayAmount = mintAmount.div(denominator);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfter = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false);\n(0, _chai.expect)(debtValueAfter).to.equal(0);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c85b055e-8840-4099-870a-2c940305875e&quot;,&quot;parentUUID&quot;:&quot;ffe3ca51-9c89-438d-a67c-c0047a9f1d6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:408,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = (0, _testutils.wrapContractWithSigner)(_hardhat.default.Diamond, _hardhat.default.users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintValue = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = (0, _lib.fromBig)(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nawait userOne.burnKreskoAsset(_hardhat.default.users.userOne.address, this.krAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(_hardhat.default.users.userOne.address, this.krAsset.address);\nconst debtValueAfter = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _hardhat.default.Diamond.getMintedKreskoAssets(_hardhat.default.users.userOne.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;292ac999-9a43-4900-9325-ab76086096fe&quot;,&quot;parentUUID&quot;:&quot;ffe3ca51-9c89-438d-a67c-c0047a9f1d6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;fd04a6a4-aebe-4132-b3c7-33623fc03a50&quot;,&quot;364f967f-bb14-473c-8442-544ca7876270&quot;,&quot;c85b055e-8840-4099-870a-2c940305875e&quot;,&quot;292ac999-9a43-4900-9325-ab76086096fe&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1751,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;d98ef1ec-3df8-422f-b54a-7caee024211f&quot;,&quot;title&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5a9ed9e7-7fec-4133-a274-d039245382a7&quot;,&quot;title&quot;:&quot;#unchecked-collateral-withdrawal&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;title&quot;:&quot;#unchecked-withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should withdraw correct amount&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should withdraw correct amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;005c8129-3fcc-419c-8a25-09727c24c7f7&quot;,&quot;parentUUID&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should send correct values to the callback&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should send correct values to the callback&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2a69ba9-b5aa-4a45-8f8e-a96bb43fe37e&quot;,&quot;parentUUID&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw collateral up to MRC without returning it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw collateral up to MRC without returning it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;72570362-1ab8-448e-88a6-d08e0147b973&quot;,&quot;parentUUID&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and return it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and return it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cc311d42-53d2-4dcd-a794-b321f861d474&quot;,&quot;parentUUID&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;63e08043-fbd5-411f-9aaf-e8cf4f297289&quot;,&quot;parentUUID&quot;:&quot;3130707a-0f6c-4c65-a772-318304556dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;005c8129-3fcc-419c-8a25-09727c24c7f7&quot;,&quot;c2a69ba9-b5aa-4a45-8f8e-a96bb43fe37e&quot;,&quot;72570362-1ab8-448e-88a6-d08e0147b973&quot;,&quot;cc311d42-53d2-4dcd-a794-b321f861d474&quot;,&quot;63e08043-fbd5-411f-9aaf-e8cf4f297289&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;6a519150-aa90-4a5c-9303-a2083c4988bf&quot;,&quot;title&quot;:&quot;#unchecked-withdraw-reverts&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert on zero withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert on zero withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;104931f7-4a4a-49c5-bba7-9a6c8f4194da&quot;,&quot;parentUUID&quot;:&quot;6a519150-aa90-4a5c-9303-a2083c4988bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert with no manager role&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert with no manager role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3d346003-108c-4c42-a429-3f8be5e8421f&quot;,&quot;parentUUID&quot;:&quot;6a519150-aa90-4a5c-9303-a2083c4988bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1c9ef8b7-dd3f-4dae-9b9a-b5e4cd1c3ed1&quot;,&quot;parentUUID&quot;:&quot;6a519150-aa90-4a5c-9303-a2083c4988bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after redeposit&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after redeposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;08a64d8e-90ca-4f99-815c-273b48a15487&quot;,&quot;parentUUID&quot;:&quot;6a519150-aa90-4a5c-9303-a2083c4988bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;104931f7-4a4a-49c5-bba7-9a6c8f4194da&quot;,&quot;3d346003-108c-4c42-a429-3f8be5e8421f&quot;,&quot;1c9ef8b7-dd3f-4dae-9b9a-b5e4cd1c3ed1&quot;,&quot;08a64d8e-90ca-4f99-815c-273b48a15487&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;2e9a9d3d-047f-46ef-8052-2a8147f958f3&quot;,&quot;title&quot;:&quot;Oracle&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Oracle\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracle \&quot;before each\&quot; hook in \&quot;Oracle\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6063408a-7df9-4837-b5ec-a588445574b5&quot;,&quot;parentUUID&quot;:&quot;2e9a9d3d-047f-46ef-8052-2a8147f958f3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Oracle\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracle \&quot;before each\&quot; hook in \&quot;Oracle\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:197,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deploy one price feed\nconst name = \&quot;TEST\&quot;;\nconst decimals = 8;\nconst descriptionFeed = \&quot;Test description\&quot;;\nconst feed = await _hardhat.default.run(_tasks.TASK_DEPLOY_PRICE_FEED, {\n    name,\n    decimals,\n    description: descriptionFeed,\n    log: false\n});\nthis.deployer = await _hardhat.default.ethers.getNamedSigner(\&quot;deployer\&quot;);\nthis.userOne = await _hardhat.default.ethers.getNamedSigner(\&quot;userOne\&quot;);\nthis.pricefeed = feed;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5a27c360-615c-4876-b6a2-8f34df288396&quot;,&quot;parentUUID&quot;:&quot;2e9a9d3d-047f-46ef-8052-2a8147f958f3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;title&quot;:&quot;FluxPriceFeed&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should initialize timestamp value once the initial answer is submitted&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should initialize timestamp value once the initial answer is submitted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.pricefeed.latestTimestamp()).to.equal(0);\nawait this.pricefeed.transmit(TEST_VALUE, true, {\n    from: this.deployer.address\n});\n(0, _chai.expect)(Number(await this.pricefeed.latestTimestamp())).to.be.greaterThan(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f21b38a-a1c1-4bb6-ba2b-eda42816dad1&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestAnswer once it&#x27;s changed&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return latestAnswer once it&#x27;s changed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;11771846-ce56-4b72-8302-9168ee05e191&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return marketOpen once it&#x27;s changed&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return marketOpen once it&#x27;s changed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;da4cef88-b72c-41c1-9fb5-fff6780a710b&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-validator to change values&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should not allow non-validator to change values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eea9a803-1946-4523-9d12-74439baf8e2d&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return description&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.pricefeed.description()).to.equal(\&quot;Test description\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed13f30e-4ce5-445d-b6f7-dae0efee48db&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return decimals&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await this.pricefeed.decimals()).to.equal(8);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0442e590-cef3-417e-806a-80a9f9a91afe&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestRoundData correctly&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return latestRoundData correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2d7aea1c-446b-4298-9994-bf97849edc51&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return getRoundData correctly&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return getRoundData correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, {\n    from: this.deployer.address\n});\nconst roundDataCall = await this.pricefeed.getRoundData(1);\nconst roundData = {\n    roundId: roundDataCall[0].toNumber(),\n    answer: roundDataCall[1].toNumber(),\n    marketOpen: roundDataCall[2].valueOf(),\n    startedAt: roundDataCall[3].toNumber(),\n    updatedAt: roundDataCall[4].toNumber(),\n    answeredInRound: roundDataCall[5].toNumber()\n};\n(0, _chai.expect)(roundData.roundId).to.gt(0);\n(0, _chai.expect)(roundData.startedAt).to.gt(0);\n(0, _chai.expect)(roundData.startedAt).to.equal(roundData.updatedAt);\n(0, _chai.expect)(roundData.answeredInRound).to.equal(roundData.roundId);\n(0, _chai.expect)(roundData.answer).to.equal(TEST_VALUE);\n(0, _chai.expect)(roundData.marketOpen).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b7128c66-5210-4a69-bc72-7d64c4c6dd54&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return getAnswer correctly&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return getAnswer correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, {\n    from: this.deployer.address\n});\n(0, _chai.expect)(await this.pricefeed.getAnswer(1)).to.equal(TEST_VALUE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;985e6dd4-fb0c-496a-bd49-2c78fd3b3fc9&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return marketOpen correctly&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return marketOpen correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, {\n    from: this.deployer.address\n});\n(0, _chai.expect)(await this.pricefeed.getMarketOpen(1)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79e09343-f139-45a8-ac5f-8f6c44386fa5&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestRound correctly&quot;,&quot;fullTitle&quot;:&quot;Oracle FluxPriceFeed should return latestRound correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, {\n    from: this.deployer.address\n});\n(0, _chai.expect)(await this.pricefeed.latestRound()).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;845e4469-bf60-4e40-993d-172ec97be748&quot;,&quot;parentUUID&quot;:&quot;3f1ef71d-83bb-43c9-88cd-7f4dca29ee65&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1f21b38a-a1c1-4bb6-ba2b-eda42816dad1&quot;,&quot;ed13f30e-4ce5-445d-b6f7-dae0efee48db&quot;,&quot;0442e590-cef3-417e-806a-80a9f9a91afe&quot;,&quot;b7128c66-5210-4a69-bc72-7d64c4c6dd54&quot;,&quot;985e6dd4-fb0c-496a-bd49-2c78fd3b3fc9&quot;,&quot;79e09343-f139-45a8-ac5f-8f6c44386fa5&quot;,&quot;845e4469-bf60-4e40-993d-172ec97be748&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;11771846-ce56-4b72-8302-9168ee05e191&quot;,&quot;da4cef88-b72c-41c1-9fb5-fff6780a710b&quot;,&quot;eea9a803-1946-4523-9d12-74439baf8e2d&quot;,&quot;2d7aea1c-446b-4298-9994-bf97849edc51&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:78,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;title&quot;:&quot;Redstone&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-feeds-and-redstone.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Redstone\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracle Redstone \&quot;before each\&quot; hook in \&quot;Redstone\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:329,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { ethers  } = _hardhat.default;\nredstoneCollateral = this.collaterals.find((c)=&gt;c.deployArgs.name === _test.defaultCollateralArgs.name);\n/// set initial collateral price\nredstoneCollateral.setPrice(10);\nconst initialBalance = (0, _lib.toBig)(100000);\nawait redstoneCollateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [_hardhat.default.users.userOne.address]: initialBalance\n});\nawait redstoneCollateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [_hardhat.default.users.userOne.address]: {\n        [_hardhat.default.Diamond.address]: initialBalance\n    }\n});\nconst MockSequencerUptimeFeed = await ethers.getContractFactory(\&quot;MockSequencerUptimeFeed\&quot;);\nmockSequencerUptimeFeed = await MockSequencerUptimeFeed.deploy();\nthis.depositArgs = {\n    user: _hardhat.default.users.userOne,\n    asset: redstoneCollateral,\n    amount: (0, _lib.toBig)(1)\n};\nawait _hardhat.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, redstoneCollateral.address, this.depositArgs.amount);\n// check initial conditions\n(0, _chai.expect)(await redstoneCollateral.getPrice()).to.equal((0, _lib.toBig)(10, 8), \&quot;collateral price should be $10\&quot;);\n// As redstone price is 0, will use chainlink price = 10\n// so collateral value = $10 * 1 = $10\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountCollateralValue(_hardhat.default.users.userOne.address)).to.equal((0, _lib.toBig)(10, 8), \&quot;collateral value should be $10\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ec45638-5fc5-46d7-88cb-6d4c48dce620&quot;,&quot;parentUUID&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should get redstone price when chainlink price = 0&quot;,&quot;fullTitle&quot;:&quot;Oracle Redstone should get redstone price when chainlink price = 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 0\nredstoneCollateral.setPrice(0);\nconst redstoneCollateralPrice = 20;\nconst redstoneDiamond = _evmconnector.WrapperBuilder.wrap(_hardhat.default.Diamond.connect(this.deployer)).usingSimpleNumericMock({\n    mockSignersCount: 1,\n    timestampMilliseconds: Date.now(),\n    dataPoints: [\n        {\n            dataFeedId: \&quot;USDC\&quot;,\n            value: redstoneCollateralPrice\n        }\n    ]\n});\n// so collateral value = $20 * 1 = $20\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(_hardhat.default.users.userOne.address)).to.equal((0, _lib.toBig)(redstoneCollateralPrice, 8), \&quot;collateral value should be $20\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3140ed4c-7afa-4f4c-8821-d75646ef5f9c&quot;,&quot;parentUUID&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get chainlink price when price +- oracleDeviationPct of redstone price &quot;,&quot;fullTitle&quot;:&quot;Oracle Redstone should get chainlink price when price +- oracleDeviationPct of redstone price &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 12\nredstoneCollateral.setPrice(12);\nconst redstoneCollateralPrice = 11;\nconst redstoneDiamond = _evmconnector.WrapperBuilder.wrap(_hardhat.default.Diamond.connect(this.deployer)).usingSimpleNumericMock({\n    mockSignersCount: 1,\n    timestampMilliseconds: Date.now(),\n    dataPoints: [\n        {\n            dataFeedId: \&quot;USDC\&quot;,\n            value: redstoneCollateralPrice\n        }\n    ]\n});\n// so collateral value = $12 * 1 = $12\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(_hardhat.default.users.userOne.address)).to.equal((0, _lib.toBig)(12, 8), \&quot;collateral value should be $20\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6b196cfa-6067-42ab-8c35-a4d720e70cc5&quot;,&quot;parentUUID&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if price deviates too much&quot;,&quot;fullTitle&quot;:&quot;Oracle Redstone should revert if price deviates too much&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 20\nredstoneCollateral.setPrice(20);\nconst redstoneCollateralPrice = 10;\nconst redstoneDiamond = _evmconnector.WrapperBuilder.wrap(_hardhat.default.Diamond.connect(this.deployer)).usingSimpleNumericMock({\n    mockSignersCount: 1,\n    timestampMilliseconds: Date.now(),\n    dataPoints: [\n        {\n            dataFeedId: \&quot;USDC\&quot;,\n            value: redstoneCollateralPrice\n        }\n    ]\n});\n// should revert if price deviates more than oracleDeviationPct\nawait (0, _chai.expect)(redstoneDiamond.getAccountCollateralValue(_hardhat.default.users.userOne.address)).to.be.revertedWith(_test.Error.ORACLE_PRICE_UNSTABLE);\nredstoneCollateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fbb6bf8c-2939-4142-9674-542356281dda&quot;,&quot;parentUUID&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return redstone price if sequencer is down&quot;,&quot;fullTitle&quot;:&quot;Oracle Redstone should return redstone price if sequencer is down&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 5\nredstoneCollateral.setPrice(5);\nconst redstoneCollateralPrice = 200;\nconst redstoneDiamond = _evmconnector.WrapperBuilder.wrap(_hardhat.default.Diamond.connect(this.deployer)).usingSimpleNumericMock({\n    mockSignersCount: 1,\n    timestampMilliseconds: Date.now(),\n    dataPoints: [\n        {\n            dataFeedId: \&quot;USDC\&quot;,\n            value: redstoneCollateralPrice\n        }\n    ]\n});\n/// set sequencer uptime feed address\nawait redstoneDiamond.updateSequencerUptimeFeed(mockSequencerUptimeFeed.address);\n// should return redstone price if sequencer is down\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(_hardhat.default.users.userOne.address)).to.be.equal((0, _lib.toBig)(redstoneCollateralPrice, 8), \&quot;collateral value should be $200\&quot;);\nredstoneCollateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;515b5e69-64a6-44c2-8a06-ed41790a8317&quot;,&quot;parentUUID&quot;:&quot;c0ef3954-de66-47be-a979-dd0f4aafe5a3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3140ed4c-7afa-4f4c-8821-d75646ef5f9c&quot;,&quot;6b196cfa-6067-42ab-8c35-a4d720e70cc5&quot;,&quot;fbb6bf8c-2939-4142-9674-542356281dda&quot;,&quot;515b5e69-64a6-44c2-8a06-ed41790a8317&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:116,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;466ff1c5-8819-4177-896e-8b70d256e275&quot;,&quot;title&quot;:&quot;Safety Council&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dc2db213-581b-4fe0-80cb-b3b4088b1cc1&quot;,&quot;parentUUID&quot;:&quot;466ff1c5-8819-4177-896e-8b70d256e275&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = _hardhat.default.collaterals.find((asset)=&gt;asset.deployArgs.name === _testutils.defaultCollateralArgs.name);\nthis.krAsset = _hardhat.default.krAssets.find((asset)=&gt;asset.deployArgs.symbol === _testutils.defaultKrAssetArgs.symbol);\n// These are the 5 signers on the SafetyCouncil multisig\nconst { deployer , devTwo , extOne , extTwo , extThree  } = await _hardhat.default.ethers.getNamedSigners();\nthis.deployer = deployer;\nthis.devTwo = devTwo;\nthis.extOne = extOne;\nthis.extTwo = extTwo;\nthis.extThree = extThree;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7ab25201-846a-4f5b-95f6-b27cb5215aac&quot;,&quot;parentUUID&quot;:&quot;466ff1c5-8819-4177-896e-8b70d256e275&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;cc70116e-f8d8-48be-abd0-6a70e7c0d6d3&quot;,&quot;title&quot;:&quot;#setSafetyStateSet&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;correctly sets the safety state&quot;,&quot;fullTitle&quot;:&quot;Safety Council #setSafetyStateSet correctly sets the safety state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const beforeSafetyState = await _hardhat.default.Diamond.safetyStateSet();\n(0, _chai.expect)(beforeSafetyState).to.equal(false);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;setSafetyStateSet\&quot;, [\n    true\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst safetyState = await _hardhat.default.Diamond.safetyStateSet();\n(0, _chai.expect)(safetyState).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ea7fbadd-36aa-4464-bdfb-ae246d1b4112&quot;,&quot;parentUUID&quot;:&quot;cc70116e-f8d8-48be-abd0-6a70e7c0d6d3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ea7fbadd-36aa-4464-bdfb-ae246d1b4112&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:81,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;c87d8ece-5966-4a4e-8d5c-6da4f860d14a&quot;,&quot;title&quot;:&quot;#toggleAssetsPaused&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;385238a6-a052-4fe2-b974-4af8bbe99e76&quot;,&quot;title&quot;:&quot;multisig signature threshold&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;multisig transacts successfully with majority of signers (3/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with majority of signers (3/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58446591-6d64-4a8b-9801-103aa9ca25fc&quot;,&quot;parentUUID&quot;:&quot;385238a6-a052-4fe2-b974-4af8bbe99e76&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:63,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0367834-b75f-4be7-9589-aa441dab42f6&quot;,&quot;parentUUID&quot;:&quot;385238a6-a052-4fe2-b974-4af8bbe99e76&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with all signers (5/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with all signers (5/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:63,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne,\n    this.extTwo,\n    this.extThree\n]);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a9c9c20-96ab-4cbe-8cbd-4305b9f920b0&quot;,&quot;parentUUID&quot;:&quot;385238a6-a052-4fe2-b974-4af8bbe99e76&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:41,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;AssertionError: Expected transaction to be reverted&quot;,&quot;estack&quot;:&quot;AssertionError: Expected transaction to be reverted\n    at onSuccess (node_modules/.pnpm/@ethereum-waffle+chai@3.4.4/node_modules/@ethereum-waffle/chai/dist/cjs/matchers/revertedWith.js:8:18)\n    at runMicrotasks (&lt;anonymous&gt;)\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\n    at runNextTicks (node:internal/process/task_queues:65:3)\n    at listOnTimeout (node:internal/timers:526:9)\n    at processTimers (node:internal/timers:500:7)\n    at async Context.&lt;anonymous&gt; (src/test/safety/00-council.ts:96:17)&quot;,&quot;diff&quot;:&quot;- Transaction NOT reverted.\n+ Transaction reverted.\n&quot;},&quot;uuid&quot;:&quot;25e6a1df-be51-4eee-ab26-b4a1e0a9e053&quot;,&quot;parentUUID&quot;:&quot;385238a6-a052-4fe2-b974-4af8bbe99e76&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;58446591-6d64-4a8b-9801-103aa9ca25fc&quot;,&quot;f0367834-b75f-4be7-9589-aa441dab42f6&quot;,&quot;4a9c9c20-96ab-4cbe-8cbd-4305b9f920b0&quot;],&quot;failures&quot;:[&quot;25e6a1df-be51-4eee-ab26-b4a1e0a9e053&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:227,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;142b9f0e-4c5b-4436-ba5f-ff5965d561d6&quot;,&quot;title&quot;:&quot;toggle actions only for listed assets&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle actions for listed collateral assets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:61,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2f8adb7b-d9ca-4b50-a904-66ebd89bb8ca&quot;,&quot;parentUUID&quot;:&quot;142b9f0e-4c5b-4436-ba5f-ff5965d561d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle actions for listed krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:67,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.krAsset.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), this.krAsset.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1dd36864-0fb6-426c-9bf6-6e1b6e9833ec&quot;,&quot;parentUUID&quot;:&quot;142b9f0e-4c5b-4436-ba5f-ff5965d561d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:68,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomAddr = _hardhat.default.ethers.utils.computeAddress(\&quot;0xb976778317b23a1285ec2d483eda6904d9319135b89f1d8eee9f6d2593e2665d\&quot;);\nawait (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        randomAddr\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), randomAddr);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae17787f-016a-4a3b-9d46-bf1f0ef6dc4f&quot;,&quot;parentUUID&quot;:&quot;142b9f0e-4c5b-4436-ba5f-ff5965d561d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2f8adb7b-d9ca-4b50-a904-66ebd89bb8ca&quot;,&quot;1dd36864-0fb6-426c-9bf6-6e1b6e9833ec&quot;,&quot;ae17787f-016a-4a3b-9d46-bf1f0ef6dc4f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:196,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ed734049-0e8e-4839-a5ab-2ae30b6459d6&quot;,&quot;title&quot;:&quot;duration based pausing&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can optionally set a timeout on a given pause command&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing can optionally set a timeout on a given pause command&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000000;\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst depositSafetyState = await _hardhat.default.Diamond.safetyStateFor(this.collateral.address, _testutils.Action.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dd2e29ac-28b9-4b34-84cd-9e451b73f269&quot;,&quot;parentUUID&quot;:&quot;ed734049-0e8e-4839-a5ab-2ae30b6459d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;duration based pause functionality should expire after the duration has passed [PLACEHOLDER]&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing duration based pause functionality should expire after the duration has passed [PLACEHOLDER]&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:64,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000;\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst depositSafetyState = await _hardhat.default.Diamond.safetyStateFor(this.collateral.address, _testutils.Action.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);\n// Confirm that the current blocktime is within the pause action&#x27;s duration\nconst blockNumBefore = await _hardhat.default.ethers.provider.getBlockNumber();\nconst blockBefore = await _hardhat.default.ethers.provider.getBlock(blockNumBefore);\nconst timestampBefore = blockBefore.timestamp;\n(0, _chai.expect)(Number(depositSafetyState[0].timestamp1)).to.be.greaterThan(timestampBefore);\n// Increase time by seven days\nconst sevenDays = 7 * 24 * 60 * 60;\nawait _hardhat.default.ethers.provider.send(\&quot;evm_increaseTime\&quot;, [\n    sevenDays\n]);\nawait _hardhat.default.ethers.provider.send(\&quot;evm_mine\&quot;, []);\n// Confirm that block time has increased as expected\nconst blockNumAfter = await _hardhat.default.ethers.provider.getBlockNumber();\nconst blockAfter = await _hardhat.default.ethers.provider.getBlock(blockNumAfter);\nconst timestampAfter = blockAfter.timestamp;\n(0, _chai.expect)(blockNumAfter).to.be.equal(blockNumBefore + 1);\n(0, _chai.expect)(timestampAfter).to.be.equal(timestampBefore + sevenDays);\n// Confirm that the current blocktime is after the pause action&#x27;s duration\n(0, _chai.expect)(timestampAfter).to.be.greaterThan(Number(depositSafetyState[0].timestamp1));\n            // NOTE: now we can test any functionality that should have now expired&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;17f6b8ea-4649-4ab7-8494-12c71e83ca78&quot;,&quot;parentUUID&quot;:&quot;ed734049-0e8e-4839-a5ab-2ae30b6459d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;dd2e29ac-28b9-4b34-84cd-9e451b73f269&quot;,&quot;17f6b8ea-4649-4ab7-8494-12c71e83ca78&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:124,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;title&quot;:&quot;toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle action DEPOSIT pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action DEPOSIT pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:124,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ec43f999-d2b8-4cc9-89ab-93495190ca0a&quot;,&quot;parentUUID&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action WITHDRAW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action WITHDRAW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.WITHDRAW.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.WITHDRAW.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;68e87a0e-5e86-4b8a-acac-2305497b4b09&quot;,&quot;parentUUID&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action REPAY pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action REPAY pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:129,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3dd802b0-ae31-4b63-aec4-ff7a6ce72c13&quot;,&quot;parentUUID&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action BORROW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action BORROW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:126,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.BORROW.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.BORROW.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc2498e9-192b-4873-87ee-97302d865fa7&quot;,&quot;parentUUID&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action LIQUIDATION pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action LIQUIDATION pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:120,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.LIQUIDATION.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.LIQUIDATION.toString(), this.collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b2078d6-fd9f-40bc-be9b-fd55a4ad39f7&quot;,&quot;parentUUID&quot;:&quot;694059f4-cf14-4670-bd40-4cfd1a0c2f91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ec43f999-d2b8-4cc9-89ab-93495190ca0a&quot;,&quot;68e87a0e-5e86-4b8a-acac-2305497b4b09&quot;,&quot;3dd802b0-ae31-4b63-aec4-ff7a6ce72c13&quot;,&quot;bc2498e9-192b-4873-87ee-97302d865fa7&quot;,&quot;8b2078d6-fd9f-40bc-be9b-fd55a4ad39f7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:620,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;83ca0146-6e02-4385-9737-04815e59a3c5&quot;,&quot;title&quot;:&quot;event emission&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused event emission should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        this.collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;SafetyStateChange\&quot;);\n(0, _chai.expect)(event.action).to.equal(_testutils.Action.DEPOSIT);\n(0, _chai.expect)(event.asset).to.equal(this.collateral.address);\n// @ts-ignore\n(0, _chai.expect)(event.description.hash).to.equal(_hardhat.default.ethers.utils.keccak256(_hardhat.default.ethers.utils.toUtf8Bytes(\&quot;paused\&quot;)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;edf5419f-fd33-4e7c-96da-445ff303f375&quot;,&quot;parentUUID&quot;:&quot;83ca0146-6e02-4385-9737-04815e59a3c5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;edf5419f-fd33-4e7c-96da-445ff303f375&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:39,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;790047d1-68dc-466b-ab53-cf93c97a218f&quot;,&quot;title&quot;:&quot;Interest Rates&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Interest Rates \&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4652f5e9-047f-44ee-9e4e-8a5097f5d199&quot;,&quot;parentUUID&quot;:&quot;790047d1-68dc-466b-ab53-cf93c97a218f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Interest Rates \&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.krAsset = this.krAssets.find((c)=&gt;c.deployArgs.name === _test.defaultKrAssetArgs.name);\nthis.collateral = this.collaterals.find((c)=&gt;c.deployArgs.name === _test.defaultCollateralArgs.name);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3797feec-faa8-4780-848e-2f53d6cf5133&quot;,&quot;parentUUID&quot;:&quot;790047d1-68dc-466b-ab53-cf93c97a218f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1570d8ec-5db8-470b-9195-c12a8cddc367&quot;,&quot;title&quot;:&quot;#init&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;initializes correct stability rates&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init initializes correct stability rates&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const config = await _hardhat.default.Diamond.getStabilityRateConfigurationForAsset(this.krAsset.address);\n// default values\n(0, _chai.expect)(config.debtIndex).to.bignumber.equal(_lib.oneRay);\n(0, _chai.expect)(config.stabilityRate).to.bignumber.equal(_lib.oneRay);\n(0, _chai.expect)(config.asset).to.equal(this.krAsset.address);\n// configured values\n(0, _chai.expect)(config.rateSlope1).to.bignumber.equal(_test.defaultKrAssetArgs.stabilityRates.rateSlope1);\n(0, _chai.expect)(config.rateSlope2).to.bignumber.equal(_test.defaultKrAssetArgs.stabilityRates.rateSlope2);\n(0, _chai.expect)(config.stabilityRateBase).to.bignumber.equal(_test.defaultKrAssetArgs.stabilityRates.stabilityRateBase);\n(0, _chai.expect)(config.optimalPriceRate).to.bignumber.equal(_test.defaultKrAssetArgs.stabilityRates.optimalPriceRate);\n(0, _chai.expect)(config.priceRateDelta).to.bignumber.equal(_test.defaultKrAssetArgs.stabilityRates.priceRateDelta);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c76e4e7-9298-48b9-9d3d-a723bbf5da4a&quot;,&quot;parentUUID&quot;:&quot;1570d8ec-5db8-470b-9195-c12a8cddc367&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;configures correct stability rates&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init configures correct stability rates&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const configuration = {\n    stabilityRateBase: _lib.oneRay,\n    rateSlope1: _lib.oneRay.mul(10),\n    rateSlope2: _lib.oneRay.mul(50),\n    optimalPriceRate: _lib.oneRay.div(2),\n    priceRateDelta: _lib.oneRay.div(100).mul(10)\n};\nawait _hardhat.default.Diamond.updateStabilityRateParams(this.krAsset.address, configuration);\nconst config = await _hardhat.default.Diamond.getStabilityRateConfigurationForAsset(this.krAsset.address);\n// default values\n(0, _chai.expect)(config.debtIndex).to.bignumber.equal(_lib.oneRay);\n(0, _chai.expect)(config.stabilityRate).to.bignumber.equal(_lib.oneRay);\n(0, _chai.expect)(config.asset).to.equal(this.krAsset.address);\n// configured values\n(0, _chai.expect)(config.rateSlope1).to.bignumber.equal(configuration.rateSlope1);\n(0, _chai.expect)(config.rateSlope2).to.bignumber.equal(configuration.rateSlope2);\n(0, _chai.expect)(config.stabilityRateBase).to.bignumber.equal(configuration.stabilityRateBase);\n(0, _chai.expect)(config.optimalPriceRate).to.bignumber.equal(configuration.optimalPriceRate);\n(0, _chai.expect)(config.priceRateDelta).to.bignumber.equal(configuration.priceRateDelta);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0570581c-6759-4f3e-8b1a-9f23ea5f64d8&quot;,&quot;parentUUID&quot;:&quot;1570d8ec-5db8-470b-9195-c12a8cddc367&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant set incorrect values&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init cant set incorrect values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const incorrectOptimalRate = {\n    stabilityRateBase: _lib.oneRay,\n    rateSlope1: _lib.oneRay.mul(10),\n    rateSlope2: _lib.oneRay.mul(50),\n    optimalPriceRate: _lib.oneRay.add(1),\n    priceRateDelta: _lib.oneRay.div(100).mul(10)\n};\nconst incorrectExcessRate = {\n    stabilityRateBase: _lib.oneRay,\n    rateSlope1: _lib.oneRay.mul(10),\n    rateSlope2: _lib.oneRay.mul(50),\n    optimalPriceRate: _lib.oneRay,\n    priceRateDelta: _lib.oneRay.add(1)\n};\nawait (0, _chai.expect)(_hardhat.default.Diamond.setupStabilityRateParams(this.krAsset.address, _test.defaultKrAssetArgs.stabilityRates)).to.be.reverted;\nawait (0, _chai.expect)(_hardhat.default.Diamond.updateStabilityRateParams(this.krAsset.address, incorrectOptimalRate)).to.be.reverted;\nawait (0, _chai.expect)(_hardhat.default.Diamond.updateStabilityRateParams(this.krAsset.address, incorrectExcessRate)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9cc20e0c-ec42-4594-98d6-53fa2b23b150&quot;,&quot;parentUUID&quot;:&quot;1570d8ec-5db8-470b-9195-c12a8cddc367&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5c76e4e7-9298-48b9-9d3d-a723bbf5da4a&quot;,&quot;0570581c-6759-4f3e-8b1a-9f23ea5f64d8&quot;,&quot;9cc20e0c-ec42-4594-98d6-53fa2b23b150&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:160,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;25cb9ed5-0654-4a3f-bef8-8b899a99d84d&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b98b9abf-a729-4d5d-b704-f13ad5f12a78&quot;,&quot;parentUUID&quot;:&quot;25cb9ed5-0654-4a3f-bef8-8b899a99d84d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:591,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;userOne = _hardhat.default.users.deployer;\nthis.krAsset = this.krAssets.find((c)=&gt;c.deployArgs.name === _test.defaultKrAssetArgs.name);\nthis.collateral = this.collaterals.find((c)=&gt;c.deployArgs.name === _test.defaultCollateralArgs.name);\n[UniMath] = await _hardhat.default.deploy(\&quot;UniswapMath\&quot;, {\n    from: _hardhat.default.users.deployer.address,\n    args: [\n        _hardhat.default.UniV2Factory.address,\n        _hardhat.default.UniV2Router.address\n    ]\n});\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, _lib.toBig)(1000);\nconst kLiq = (0, _lib.toBig)(100);\nawait this.collateral.setBalance(userOne, cLiq.mul(2));\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: userOne\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: kLiq\n});\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, _amm.addLiquidity)({\n    user: userOne,\n    router: _hardhat.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset\n});\nupdateTWAP = (0, _amm.getTWAPUpdaterFor)(pair.address);\nawait _hardhat.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56e64e56-3c3f-4a2f-afbe-de1b7aca41b0&quot;,&quot;parentUUID&quot;:&quot;25cb9ed5-0654-4a3f-bef8-8b899a99d84d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;757f3617-956c-498b-b139-0692ed640613&quot;,&quot;title&quot;:&quot;#no-amm-prices&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct rates and debt when there is no amm price&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #no-amm-prices calculates correct rates and debt when there is no amm price&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3312,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const krAssetAmount = (0, _lib.toBig)(1);\nconst krAssetNoBaseRate = await (0, _krassets.addMockKreskoAsset)({\n    name: \&quot;krasset2\&quot;,\n    symbol: \&quot;krasset2\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    stabilityRateBase: _ethers.BigNumber.from(0),\n    price: 10,\n    supplyLimit: 2000\n});\nconst krAssetWithBaseRate = await (0, _krassets.addMockKreskoAsset)({\n    name: \&quot;krasset2\&quot;,\n    symbol: \&quot;krasset2\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    stabilityRateBase: _test.BASIS_POINT.mul(20),\n    price: 10,\n    supplyLimit: 2000\n});\n// Asset\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: krAssetNoBaseRate,\n    amount: krAssetAmount\n});\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: krAssetWithBaseRate,\n    amount: krAssetAmount\n});\nconst lastUpdateTimestamp = await (0, _calculations.getBlockTimestamp)();\nconst debtIndexBefore = await _hardhat.default.Diamond.getDebtIndexForAsset(krAssetWithBaseRate.address);\nawait _hardhatnetworkhelpers.time.increase(+_lib.ONE_YEAR);\n// asset with no base rate and no amm price\nconst debtIndexNoBaseRate = await _hardhat.default.Diamond.getDebtIndexForAsset(krAssetNoBaseRate.address);\nconst debtScaledNoBaseRate = await _hardhat.default.Diamond.kreskoAssetDebt(userOne.address, krAssetNoBaseRate.address);\nconst debtPrincipalNoBaseRate = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userOne.address, krAssetNoBaseRate.address);\nconst debtInterestNoBaseRate = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userOne.address, krAssetNoBaseRate.address);\n(0, _chai.expect)(debtIndexNoBaseRate).to.equal(_lib.oneRay);\n(0, _chai.expect)(debtScaledNoBaseRate).to.equal(debtPrincipalNoBaseRate);\n(0, _chai.expect)(debtInterestNoBaseRate.kissAmount).to.equal(0);\n(0, _chai.expect)(debtInterestNoBaseRate.assetAmount).to.equal(0);\n// asset with base rate and no amm price\nconst debtIndexWithBaseRate = await _hardhat.default.Diamond.getDebtIndexForAsset(krAssetWithBaseRate.address);\nconst debtScaledWithBaseRate = await _hardhat.default.Diamond.kreskoAssetDebt(userOne.address, krAssetWithBaseRate.address);\nconst debtPrincipalWithBaseRate = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userOne.address, krAssetWithBaseRate.address);\nconst debtInterestWithBaseRate = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userOne.address, krAssetWithBaseRate.address);\nconst expectedScaledDebt = await (0, _calculations.toScaledAmount)(debtPrincipalWithBaseRate, krAssetWithBaseRate);\nconst expectedDebtIndex = await (0, _calculations.calcDebtIndex)(krAssetWithBaseRate, debtIndexBefore, lastUpdateTimestamp);\nconst expectedAssetInterest = debtScaledWithBaseRate.sub(debtPrincipalWithBaseRate);\nconst expectedKissInterestAmount = await (0, _calculations.oraclePriceToWad)(_hardhat.default.Diamond.getKrAssetValue(krAssetWithBaseRate.address, expectedAssetInterest, true));\n(0, _chai.expect)(debtIndexWithBaseRate).to.equal(expectedDebtIndex);\n(0, _chai.expect)(debtScaledWithBaseRate).to.equal(expectedScaledDebt);\n(0, _chai.expect)(debtInterestWithBaseRate.assetAmount).to.equal(expectedAssetInterest);\n(0, _chai.expect)(debtInterestWithBaseRate.kissAmount).to.equal(expectedKissInterestAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e832082b-d0cc-4745-aba5-5c5a97e0aad2&quot;,&quot;parentUUID&quot;:&quot;757f3617-956c-498b-b139-0692ed640613&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e832082b-d0cc-4745-aba5-5c5a97e0aad2&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3312,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;0fdd2a7c-4329-417b-81ae-3b27245723b5&quot;,&quot;title&quot;:&quot;#price-rate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct price rates when amm == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:138,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst ammPricesOptimal = await (0, _amm.getAMMPrices)(this.collateral, this.krAsset);\n(0, _chai.expect)(ammPricesOptimal.price0).to.be.closeTo(this.krAsset.deployArgs.price, 0.05);\nconst priceRate = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, _chai.expect)(priceRate).to.bignumber.equal(_lib.oneRay);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0d8c88a-06c5-4a9b-adbe-a41c9fae81e9&quot;,&quot;parentUUID&quot;:&quot;0fdd2a7c-4329-417b-81ae-3b27245723b5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct price rates when amm &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:170,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 105; // 105% eg. 5% premium\nconst expectedPriceRate = _test.ONE_PERCENT.mul(premiumPercentage).mul(997).div(1000);\nconst expectedPrice = this.krAsset.deployArgs.price * (premiumPercentage / 100);\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.collateral.address,\n        this.krAsset.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nconst ammPricesUpPremium = await (0, _amm.getAMMPrices)(this.collateral, this.krAsset);\n(0, _chai.expect)(ammPricesUpPremium.price0).to.be.closeTo(expectedPrice, 0.05);\nawait updateTWAP();\nconst priceRate = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, _chai.expect)(priceRate).to.bignumber.closeTo(expectedPriceRate, _test.BASIS_POINT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;601d83a0-e7c8-4f9a-8268-a5455ba71c66&quot;,&quot;parentUUID&quot;:&quot;0fdd2a7c-4329-417b-81ae-3b27245723b5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct price rates when amm &lt; oracle &quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm &lt; oracle &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:478,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 95; // 95% eg. 5% below oracle price\nconst expectedPriceRate = _test.ONE_PERCENT.mul(premiumPercentage).mul(1003).div(1000);\nconst expectedPrice = this.krAsset.deployArgs.price * (premiumPercentage / 100);\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nconst ammRates = await (0, _amm.getAMMPrices)(this.collateral, this.krAsset);\n(0, _chai.expect)(ammRates.price0).to.be.closeTo(expectedPrice, 0.05);\nawait updateTWAP();\nconst priceRate = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, _chai.expect)(priceRate).to.bignumber.closeTo(expectedPriceRate, _test.BASIS_POINT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2924126-f580-4c04-8103-d110891efa9d&quot;,&quot;parentUUID&quot;:&quot;0fdd2a7c-4329-417b-81ae-3b27245723b5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b0d8c88a-06c5-4a9b-adbe-a41c9fae81e9&quot;,&quot;601d83a0-e7c8-4f9a-8268-a5455ba71c66&quot;,&quot;f2924126-f580-4c04-8103-d110891efa9d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:786,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;2d97215e-e04d-4074-9344-30c4811b8ccc&quot;,&quot;title&quot;:&quot;#stability-rate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct stability rate when amm == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rate when amm == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:130,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nconst stabilityRate = await _hardhat.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\nconst priceRate = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, _chai.expect)(priceRate).to.bignumber.equal(_lib.oneRay);\n(0, _chai.expect)(stabilityRate).to.bignumber.equal((0, _calculations.getExpectedStabilityRate)(priceRate, _test.defaultKrAssetArgs.stabilityRates));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;38ced625-5330-485f-b1d0-56c7f2f87043&quot;,&quot;parentUUID&quot;:&quot;2d97215e-e04d-4074-9344-30c4811b8ccc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct stability rate when amm &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rate when amm &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.collateral.address,\n        this.krAsset.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nconst priceRateActual = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\nconst priceRateDecimal = (0, _lib.fromBig)(priceRateActual, 27);\nconst expectedPriceRateDecimal = (0, _lib.fromBig)(_test.ONE_PERCENT.mul(premiumPercentage).mul(997).div(1000), 27);\n(0, _chai.expect)(priceRateDecimal).to.closeTo(expectedPriceRateDecimal, BPS);\nconst expectedStabilityRate = (0, _calculations.getExpectedStabilityRate)(priceRateActual, _test.defaultKrAssetArgs.stabilityRates);\nconst stabilityRate = await _hardhat.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\n(0, _chai.expect)(stabilityRate).to.bignumber.equal(expectedStabilityRate);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;db82758c-f0c7-4474-a4f4-e498011a1db4&quot;,&quot;parentUUID&quot;:&quot;2d97215e-e04d-4074-9344-30c4811b8ccc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct stability rates when amm &lt; oracle &quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rates when amm &lt; oracle &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:944,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 95; // 95% eg. -5% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nconst priceRateActual = await _hardhat.default.Diamond.getPriceRateForAsset(this.krAsset.address);\nconst priceRateDecimal = (0, _lib.fromBig)(priceRateActual, 27);\nconst expectedPriceRateDecimal = (0, _lib.fromBig)(_test.ONE_PERCENT.mul(premiumPercentage).mul(1003).div(1000), 27);\n(0, _chai.expect)(priceRateDecimal).to.closeTo(expectedPriceRateDecimal, BPS);\nconst expectedStabilityRate = (0, _calculations.getExpectedStabilityRate)(priceRateActual, _test.defaultKrAssetArgs.stabilityRates);\nconst stabilityRate = await _hardhat.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\n(0, _chai.expect)(stabilityRate).to.bignumber.equal(expectedStabilityRate);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;68d8795c-7757-401e-9ccd-f1b4be6f56e1&quot;,&quot;parentUUID&quot;:&quot;2d97215e-e04d-4074-9344-30c4811b8ccc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;38ced625-5330-485f-b1d0-56c7f2f87043&quot;,&quot;db82758c-f0c7-4474-a4f4-e498011a1db4&quot;,&quot;68d8795c-7757-401e-9ccd-f1b4be6f56e1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1240,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;b15c5772-c9c3-4a3f-bf8b-980d23353b1f&quot;,&quot;title&quot;:&quot;#debt-index&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct debt index after a year when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after a year when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:698,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, _calculations.getBlockTimestamp)();\nawait _hardhatnetworkhelpers.time.increase(+_lib.ONE_YEAR);\nconst debtIndexAfter = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, _chai.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, _calculations.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;82722b34-5405-4580-8f70-3436720553bf&quot;,&quot;parentUUID&quot;:&quot;b15c5772-c9c3-4a3f-bf8b-980d23353b1f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt index after year when amm price &lt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after year when amm price &lt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:665,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 90; // 90% eg. -10% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(1).mul(premiumPercentage).div(this.krAsset.deployArgs.price);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, _calculations.getBlockTimestamp)();\nawait _hardhatnetworkhelpers.time.increase(+_lib.ONE_YEAR);\nconst debtIndexAfter = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, _chai.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, _calculations.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d818bd54-dcd4-4e23-88c0-8798a098d6fe&quot;,&quot;parentUUID&quot;:&quot;b15c5772-c9c3-4a3f-bf8b-980d23353b1f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:186,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, _calculations.getBlockTimestamp)();\nawait _hardhatnetworkhelpers.time.increase(+_lib.ONE_YEAR);\nconst debtIndexAfter = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, _chai.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, _calculations.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;64d7e7b6-b2b1-424c-9ead-bab9580a58c6&quot;,&quot;parentUUID&quot;:&quot;b15c5772-c9c3-4a3f-bf8b-980d23353b1f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;82722b34-5405-4580-8f70-3436720553bf&quot;,&quot;d818bd54-dcd4-4e23-88c0-8798a098d6fe&quot;,&quot;64d7e7b6-b2b1-424c-9ead-bab9580a58c6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1549,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;16d4eb14-c9b5-49aa-8cc7-426fb5421072&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2902a881-e9a0-4ed9-b684-d332eabca70f&quot;,&quot;parentUUID&quot;:&quot;16d4eb14-c9b5-49aa-8cc7-426fb5421072&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:660,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;userOne = _hardhat.default.users.deployer;\nuserTwo = _hardhat.default.users.userTwo;\nthis.krAsset = _hardhat.default.krAssets.find((c)=&gt;c.deployArgs.name === _test.defaultKrAssetArgs.name);\nthis.collateral = _hardhat.default.collaterals.find((c)=&gt;c.deployArgs.name === _test.defaultCollateralArgs.name);\n[UniMath] = await _hardhat.default.deploy(\&quot;UniswapMath\&quot;, {\n    from: _hardhat.default.users.deployer.address,\n    args: [\n        _hardhat.default.UniV2Factory.address,\n        _hardhat.default.UniV2Router.address\n    ]\n});\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, _lib.toBig)(1000);\nconst kLiq = (0, _lib.toBig)(100);\nawait this.collateral.setBalance(userOne, cLiq.mul(2));\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: userOne\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: kLiq,\n    user: userOne\n});\nconst anchorBalance = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(anchorBalance).to.equal(kLiq);\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, _amm.addLiquidity)({\n    user: userOne,\n    router: _hardhat.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset\n});\nupdateTWAP = (0, _amm.getTWAPUpdaterFor)(pair.address);\nawait _hardhat.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;96fe5854-e0c5-4868-83f4-f5dbf36b65d1&quot;,&quot;parentUUID&quot;:&quot;16d4eb14-c9b5-49aa-8cc7-426fb5421072&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a99269da-f6fc-4fe9-8f7d-1fd21ae88f49&quot;,&quot;title&quot;:&quot;#debt calculation - mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - mint\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint \&quot;before each\&quot; hook in \&quot;#debt calculation - mint\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;76351568-637b-4725-a9fc-135b137935d9&quot;,&quot;parentUUID&quot;:&quot;a99269da-f6fc-4fe9-8f7d-1fd21ae88f49&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct debt amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct debt amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:980,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait _hardhatnetworkhelpers.time.increase(+_calculations.ONE_YEAR);\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debtAfterYear).to.not.bignumber.equal(debt);\n(0, _chai.expect)(debtAfterYear).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a13efbf2-8b00-41f4-bb44-a93f530e2427&quot;,&quot;parentUUID&quot;:&quot;a99269da-f6fc-4fe9-8f7d-1fd21ae88f49&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt amount when amm price &lt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct debt amount when amm price &lt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:962,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 95; // 95% eg. -5% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait _hardhatnetworkhelpers.time.increase(+_calculations.ONE_YEAR);\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debtAfterYear).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3ea4b24-173e-4110-8d70-44729a1e13ca&quot;,&quot;parentUUID&quot;:&quot;a99269da-f6fc-4fe9-8f7d-1fd21ae88f49&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct rate index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct rate index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:446,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait _hardhatnetworkhelpers.time.increase(+_calculations.ONE_YEAR);\nconst debtIndex = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndex.gt(_lib.oneRay)).to.be.true;\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debtAfterYear).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;85e5e68f-210e-43ea-84b6-b4412b4fd6a9&quot;,&quot;parentUUID&quot;:&quot;a99269da-f6fc-4fe9-8f7d-1fd21ae88f49&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a13efbf2-8b00-41f4-bb44-a93f530e2427&quot;,&quot;a3ea4b24-173e-4110-8d70-44729a1e13ca&quot;,&quot;85e5e68f-210e-43ea-84b6-b4412b4fd6a9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2388,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;4eeb163c-a2f2-4bdf-85f7-ed71661f37bc&quot;,&quot;title&quot;:&quot;#debt calculation - repay&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - repay\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay \&quot;before each\&quot; hook in \&quot;#debt calculation - repay\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:98,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;43f4c2ea-d764-4b62-aa24-d010014d3f2a&quot;,&quot;parentUUID&quot;:&quot;4eeb163c-a2f2-4bdf-85f7-ed71661f37bc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct repay amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct repay amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:694,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 102; // 102% eg. 2% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\n// buy asset, increases price\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.collateral.address,\n        this.krAsset.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.equal(await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst principalBefore = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst burnAmount = mintAmount.div(2);\nawait (0, _krassets.burnKrAsset)({\n    asset: this.krAsset,\n    amount: burnAmount,\n    user: userTwo\n});\nconst debtAfterBurn = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst principalAfter = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(principalAfter).to.equal(principalBefore.sub(burnAmount));\n(0, _chai.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(burnAmount), _hardhat.default.ethers.utils.parseUnits(\&quot;10\&quot;, \&quot;gwei\&quot;));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f585c21a-1f10-44c5-b91c-21b108c296ae&quot;,&quot;parentUUID&quot;:&quot;4eeb163c-a2f2-4bdf-85f7-ed71661f37bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct repay amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct repay amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1037,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 98; // 101% eg. 1% premium\nconst krAssetAmount = (0, _lib.toBig)(1);\nconst collateralAmount = (0, _lib.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, _krassets.mintKrAsset)({\n    user: userOne,\n    asset: this.krAsset,\n    amount: amountIn\n});\n// dump asset, decreases price\nawait (0, _amm.swap)({\n    amount: amountIn,\n    route: [\n        this.krAsset.address,\n        this.collateral.address\n    ],\n    router: _hardhat.default.UniV2Router,\n    user: userOne\n});\nawait updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.closeTo(mintAmount, 10);\nconst year = 60 * 60 * 24 * 365;\nawait _hardhatnetworkhelpers.time.increase(year);\nconst debtIndex = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndex.gt(_lib.oneRay)).to.be.true;\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst halfBalanceAfterYear = (await this.krAsset.contract.balanceOf(userTwo.address)).div(2);\nawait (0, _krassets.burnKrAsset)({\n    asset: this.krAsset,\n    amount: halfBalanceAfterYear,\n    user: userTwo\n});\nconst debtAfterBurn = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(halfBalanceAfterYear), _lib.oneRay.div(10000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dc2697ea-f193-4d8c-8665-086f70f18f76&quot;,&quot;parentUUID&quot;:&quot;4eeb163c-a2f2-4bdf-85f7-ed71661f37bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct rate index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct rate index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:671,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait _hardhat.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.bignumber.closeTo(mintAmount, 10);\nconst year = 60 * 60 * 24 * 365;\nawait _hardhatnetworkhelpers.time.increase(year);\nconst debtIndex = await _hardhat.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, _chai.expect)(debtIndex.gt(_lib.oneRay)).to.be.true;\nconst debtAfterYear = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst halfBalanceAfterYear = (await this.krAsset.contract.balanceOf(userTwo.address)).div(2);\nawait (0, _krassets.burnKrAsset)({\n    asset: this.krAsset,\n    amount: halfBalanceAfterYear,\n    user: userTwo\n});\nconst debtAfterBurn = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(halfBalanceAfterYear), _lib.oneRay.div(10000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4d7f734b-b371-4a92-b897-a48285618ade&quot;,&quot;parentUUID&quot;:&quot;4eeb163c-a2f2-4bdf-85f7-ed71661f37bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f585c21a-1f10-44c5-b91c-21b108c296ae&quot;,&quot;dc2697ea-f193-4d8c-8665-086f70f18f76&quot;,&quot;4d7f734b-b371-4a92-b897-a48285618ade&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2402,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;title&quot;:&quot;#debt calculation - repay interest&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - repay interest\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest \&quot;before each\&quot; hook in \&quot;#debt calculation - repay interest\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a2843458-14de-4909-8820-a9afd349e2e9&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can view account principal debt for asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view account principal debt for asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:490,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst expectedPrincipalDebt = mintAmount.mul(2);\nconst principalDebtAfterOneYear = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(principalDebtAfterOneYear).to.bignumber.equal(expectedPrincipalDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a9dddb1e-9cf4-4ba2-b7a4-9a9048e4ef96&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can view account scaled debt for asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view account scaled debt for asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:547,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst principalDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst accruedInterest = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\nconst expectedScaledDebt = principalDebt.add(accruedInterest.assetAmount);\nconst scaledDebt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(scaledDebt).to.bignumber.equal(expectedScaledDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;890782b9-4439-416b-a4b6-e1a0b05a2442&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can view accrued interest in KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view accrued interest in KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:973,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nconst principalDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst scaledDebt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst expectedValue = await _hardhat.default.Diamond.getKrAssetValue(this.krAsset.address, scaledDebt.sub(principalDebt), true);\nconst accruedInterest = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// 8 decimals\n(0, _chai.expect)(accruedInterest.kissAmount).to.bignumber.equal(expectedValue.mul(10 ** 10));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;775ab19c-76e6-4931-87a3-f56d65ed39a9&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay full interest with KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay full interest with KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:702,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo\n});\n// get the principal before repayment\nconst principalDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n// repay accrued interest\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\n// get values after repayment\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst accruedInterest = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(accruedInterest.assetAmount).to.bignumber.eq(0);\n(0, _chai.expect)(debt).to.bignumber.eq(principalDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;315056bc-64f7-49e5-a4da-5eb291a52d4b&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay partial interest with KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay partial interest with KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:816,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo\n});\nconst accruedInterestBefore = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// get the principal before repayment\nconst debtBefore = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst repaymentAmount = accruedInterestBefore.kissAmount.div(5);\nconst repaymentAmountAsset = accruedInterestBefore.assetAmount.div(5);\n// repay accrued interest\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).repayStabilityRateInterestPartial(userTwo.address, this.krAsset.address, repaymentAmount);\n// get values after repayment\nconst debtAfter = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst accruedInterestAfter = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// TODO: calc exact values instead of closeTo\n(0, _chai.expect)(accruedInterestAfter.kissAmount).to.be.closeTo(accruedInterestBefore.kissAmount.sub(repaymentAmount), RATE_DELTA);\n(0, _chai.expect)(debtAfter).to.be.closeTo(debtBefore.sub(repaymentAmountAsset), RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;60312b41-b539-483c-bb18-110700765c19&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay all interest for multiple assets in batch&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay all interest for multiple assets in batch&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5911,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait this.collateral.setBalance(userTwo, depositAmountBig);\n// Deposit a bit more to cover the mints\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmountBig,\n    user: userTwo\n});\n// Create few krAssets\nconst krAssets = await Promise.all([\n    \&quot;krasset2\&quot;,\n    \&quot;krasset3\&quot;,\n    \&quot;krasset4\&quot;\n].map(async (name)=&gt;await (0, _krassets.addMockKreskoAsset)({\n        name: name,\n        symbol: \&quot;krasset2\&quot;,\n        marketOpen: true,\n        factor: 1,\n        closeFee: 0,\n        openFee: 0,\n        price: 10,\n        supplyLimit: 2000,\n        stabilityRateBase: _test.BASIS_POINT.mul(1000)\n    })));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmountSmall,\n        user: userTwo\n    })));\nconst totalInterestInKISSBefore = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// increase time\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst interestAccrued = await Promise.all(krAssets.map((asset)=&gt;_hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, asset.address)));\nconst expectedKissAmount = interestAccrued.reduce((a, c)=&gt;a.add(c.kissAmount), _ethers.BigNumber.from(0));\nconst totalInterestInKISSAfter = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, _chai.expect)(totalInterestInKISSBefore.lt(totalInterestInKISSAfter)).to.be.true;\n(0, _chai.expect)(totalInterestInKISSAfter).to.bignumber.equal(expectedKissAmount);\nconst KISSMinAmount = (0, _lib.toBig)(10);\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: KISSMinAmount,\n    user: userTwo\n});\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).batchRepayFullStabilityRateInterest(userTwo.address);\nconst totalInterestInKISSAfterRepay = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, _chai.expect)(totalInterestInKISSAfterRepay).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0811daf-49b5-466b-8a36-3faaf38ad592&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay all interest and principal for a single asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay all interest and principal for a single asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1097,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst accruedInterestBeforeBurn = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// repay accrued interest\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, _hardhat.default.ethers.constants.MaxUint256, 0);\nconst accruedInterestAfterBurn = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// Ensure burning does not wipe interest accrued\n(0, _chai.expect)(accruedInterestAfterBurn.assetAmount.gt(accruedInterestBeforeBurn.assetAmount)).to.be.true;\n(0, _chai.expect)(accruedInterestAfterBurn.kissAmount.gt(accruedInterestBeforeBurn.kissAmount)).to.be.true;\nconst mintedKreskoAssetsBefore = await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore.length).to.equal(2);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter.length).to.equal(1);\nconst accruedInterestAfterRepayment = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\nconst principalDebt = await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n// Ensure debt actually gets wiped\n(0, _chai.expect)(principalDebt).to.equal(0);\n(0, _chai.expect)(accruedInterestAfterRepayment.assetAmount).to.equal(0);\n(0, _chai.expect)(accruedInterestAfterRepayment.kissAmount).to.equal(0);\n(0, _chai.expect)(debt).to.equal(0);\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst accruedInterestYearAfterRepayment = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// Sanity check with another year of time that there is no interest accrual\n(0, _chai.expect)(accruedInterestYearAfterRepayment.assetAmount).to.equal(0);\n(0, _chai.expect)(accruedInterestYearAfterRepayment.kissAmount).to.equal(0);\n// Get kr asset value, should be only KISS minted that remains\nconst krAssetValue = await _hardhat.default.Diamond.getAccountKrAssetValue(userTwo.address);\n(0, _chai.expect)(krAssetValue).to.equal((0, _lib.toBig)(10, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a665e33b-a04c-4459-a744-bbadc70ac971&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can batch repay interest and all debt&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can batch repay interest and all debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5611,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait this.collateral.setBalance(userTwo, depositAmountBig);\n// Deposit a bit more to cover the mints\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmountBig,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo\n});\n// Create few krAssets\nconst krAssets = await Promise.all([\n    \&quot;krasset2\&quot;,\n    \&quot;krasset3\&quot;,\n    \&quot;krasset4\&quot;\n].map(async (name)=&gt;await (0, _krassets.addMockKreskoAsset)({\n        name: name,\n        symbol: name,\n        marketOpen: true,\n        factor: 1,\n        closeFee: 0,\n        openFee: 0,\n        price: 10,\n        supplyLimit: 2000,\n        stabilityRateBase: _test.BASIS_POINT.mul(1000)\n    })));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmountSmall,\n        user: userTwo\n    })));\nconst totalInterestInKISSBefore = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// increase time\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst interestAccrued = await Promise.all(krAssets.map((asset)=&gt;_hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, asset.address)));\nconst expectedKissAmount = interestAccrued.reduce((a, c)=&gt;a.add(c.kissAmount), _ethers.BigNumber.from(0));\nconst totalInterestInKISSAfter = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, _chai.expect)(totalInterestInKISSBefore.lt(totalInterestInKISSAfter)).to.be.true;\n(0, _chai.expect)(totalInterestInKISSAfter).to.bignumber.equal(expectedKissAmount);\nawait Promise.all(krAssets.map(async (asset)=&gt;(0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).burnKreskoAsset(userTwo.address, asset.address, _hardhat.default.ethers.constants.MaxUint256, await _hardhat.default.Diamond.getMintedKreskoAssetsIndex(userTwo.address, asset.address))));\nconst mintedKreskoAssetsBefore = await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore.length).to.equal(4);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).batchRepayFullStabilityRateInterest(userTwo.address);\nconst totalInterestInKISSAfterRepay = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, _chai.expect)(totalInterestInKISSAfterRepay).to.equal(0);\nconst mintedKreskoAssetsAfter = await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter.length).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;46e54072-c0c7-48fc-a753-a7d7e99ee6f9&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can open up a new debt positions after wiping all debt + interest&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can open up a new debt positions after wiping all debt + interest&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1836,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst expectedDebtAfterOneYear = await (0, _calculations.toScaledAmountUser)(userTwo, mintAmount, this.krAsset);\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(expectedDebtAfterOneYear);\n// Wipe debt\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, _hardhat.default.ethers.constants.MaxUint256, 0);\nconst accruedInterest = (await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address)).assetAmount;\n// Mint again, before interest repayment\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\n// Ensure debt is principal + interest\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.closeTo(mintAmount.add(accruedInterest), RATE_DELTA);\n// Burn all assets\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, _hardhat.default.ethers.constants.MaxUint256, 0);\n// Ensure debt is equal to interest\nconst accruedInterestAfterBurn = (await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address)).assetAmount;\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(accruedInterestAfterBurn);\n// Repay all interest\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\n// Debt should be wiped\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(0);\n// Mint again\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\n// Scaled should be equal to principal\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(mintAmount);\n// Advance time\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\n// Ensure accrual is the same as the previous year with the same position\nconst debt = await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(debt).to.eq(expectedDebtAfterOneYear);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9dfe4aa5-1469-4824-ab04-047b9d67fbe2&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can fully close a position in single transaction using the helper function&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can fully close a position in single transaction using the helper function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1078,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userOne\n});\nawait KISS.connect(userOne).transfer(userTwo.address, minDebtAmount);\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo\n});\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).closeKrAssetDebtPosition(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(0);\n(0, _chai.expect)(await _hardhat.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address)).to.eq(0);\nconst accruedInterest = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n(0, _chai.expect)(accruedInterest.assetAmount).to.eq(0);\n(0, _chai.expect)(accruedInterest.kissAmount).to.eq(0);\n(0, _chai.expect)((await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address)).length).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b63701b-795d-4ed0-9f8c-fcaa90c899ef&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can fully close all positions and interest in single transaction using the helper function&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can fully close all positions and interest in single transaction using the helper function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5743,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst kissAmount = (await _hardhat.default.Diamond.minimumDebtValue()).mul(10 ** 10).mul(2);\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: kissAmount,\n    user: userOne\n});\nawait KISS.connect(userOne).transfer(userTwo.address, kissAmount);\nconst krAssets = await Promise.all([\n    \&quot;krasset2\&quot;,\n    \&quot;krasset3\&quot;,\n    \&quot;krasset4\&quot;\n].map(async (name)=&gt;await (0, _krassets.addMockKreskoAsset)({\n        name: name,\n        symbol: name,\n        marketOpen: true,\n        factor: 1,\n        closeFee: 0,\n        openFee: 0,\n        price: 10,\n        supplyLimit: 2000,\n        stabilityRateBase: _test.BASIS_POINT.mul(1000)\n    })));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmountSmall,\n        user: userTwo\n    })));\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\n// ~1M gas with 8 krAssets\n// console.log(+(await tx.wait()).gasUsed);\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, userTwo).batchCloseKrAssetDebtPositions(userTwo.address);\nconst accruedInterest = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, _chai.expect)(accruedInterest).to.eq(0);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountKrAssetValue(userTwo.address)).to.eq(0);\n(0, _chai.expect)((await _hardhat.default.Diamond.getMintedKreskoAssets(userTwo.address)).length).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e02a7e3c-9b8d-4b38-b2a1-eff3f44eea6d&quot;,&quot;parentUUID&quot;:&quot;986f15a5-c89e-425d-a8c1-4570d332b9a5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a9dddb1e-9cf4-4ba2-b7a4-9a9048e4ef96&quot;,&quot;890782b9-4439-416b-a4b6-e1a0b05a2442&quot;,&quot;775ab19c-76e6-4931-87a3-f56d65ed39a9&quot;,&quot;315056bc-64f7-49e5-a4da-5eb291a52d4b&quot;,&quot;60312b41-b539-483c-bb18-110700765c19&quot;,&quot;b0811daf-49b5-466b-8a36-3faaf38ad592&quot;,&quot;a665e33b-a04c-4459-a744-bbadc70ac971&quot;,&quot;46e54072-c0c7-48fc-a753-a7d7e99ee6f9&quot;,&quot;9dfe4aa5-1469-4824-ab04-047b9d67fbe2&quot;,&quot;0b63701b-795d-4ed0-9f8c-fcaa90c899ef&quot;,&quot;e02a7e3c-9b8d-4b38-b2a1-eff3f44eea6d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:24804,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;bd45fcbf-7453-461c-b96d-65f551eda770&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await _hardhat.default.deployments.createFixture(async (hre)=&gt;{\n    const result = await hre.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\&quot;Kresko\&quot;)).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \&quot;DAI\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;USDC\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;TSLA\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;ETH\&quot;,\n                    value: 0\n                },\n                {\n                    dataFeedId: \&quot;BTC\&quot;,\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b986b2fd-ba8f-40e0-9b09-2409497ff457&quot;,&quot;parentUUID&quot;:&quot;bd45fcbf-7453-461c-b96d-65f551eda770&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:750,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;liquidator = _hardhat.default.users.deployer;\nuserTwo = _hardhat.default.users.userTwo;\nthis.krAsset = _hardhat.default.krAssets.find((c)=&gt;c.deployArgs.name === _test.defaultKrAssetArgs.name);\nthis.collateral = _hardhat.default.collaterals.find((c)=&gt;c.deployArgs.name === _test.defaultCollateralArgs.name);\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, _lib.toBig)(1000);\nconst kLiq = (0, _lib.toBig)(100);\nawait this.collateral.setBalance(liquidator, cLiq.mul(2));\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: liquidator\n});\nawait (0, _krassets.mintKrAsset)({\n    asset: this.krAsset,\n    amount: kLiq,\n    user: liquidator\n});\nconst anchorBalance = await this.krAsset.anchor.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(anchorBalance).to.equal(kLiq);\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, _amm.addLiquidity)({\n    user: liquidator,\n    router: _hardhat.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset\n});\nupdateTWAP = (0, _amm.getTWAPUpdaterFor)(pair.address);\nawait _hardhat.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dbf910e0-d69a-4c11-835b-872c34026f4d&quot;,&quot;parentUUID&quot;:&quot;bd45fcbf-7453-461c-b96d-65f551eda770&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;title&quot;:&quot;#stability rate - liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/stability-rate/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#stability rate - liquidation\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation \&quot;before each\&quot; hook in \&quot;#stability rate - liquidation\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3344,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Create few krAssets\nkrAssets = await Promise.all([\n    \&quot;krasset2\&quot;,\n    \&quot;krasset3\&quot;,\n    \&quot;krasset4\&quot;\n].map(async (name)=&gt;await (0, _krassets.addMockKreskoAsset)({\n        name: name,\n        symbol: name,\n        marketOpen: true,\n        factor: 1.1,\n        closeFee: 0,\n        openFee: 0,\n        price: 10,\n        supplyLimit: 2000,\n        stabilityRateBase: _test.BASIS_POINT.mul(1000)\n    })));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;935207de-8467-4c08-92aa-cb12430a2a71&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cannot liquidate accrued interest of healthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation cannot liquidate accrued interest of healthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\n// mint each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmount,\n        user: userTwo\n    })));\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\nconst krAsset = krAssets[0];\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, liquidator).liquidateInterest(userTwo.address, krAsset.address, this.collateral.address, false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0a3db105-7c68-4523-ba90-92df9130027d&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot batch liquidate accrued interest of healthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation cannot batch liquidate accrued interest of healthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1313,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\n// mint each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmount,\n        user: userTwo\n    })));\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR);\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, liquidator).batchLiquidateInterest(userTwo.address, this.collateral.address, false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;13380cb9-c798-430d-9452-2c242c0a2261&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can liquidate accrued interest of unhealthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation can liquidate accrued interest of unhealthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2433,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\n// mint each krasset\nawait Promise.all([\n    await KISS.connect(liquidator).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256),\n    await this.collateral.setBalance(userTwo, depositAmount),\n    // Deposit a bit more to cover the mints\n    await (0, _collaterals.depositCollateral)({\n        asset: this.collateral,\n        amount: depositAmount,\n        user: userTwo\n    }),\n    ...krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n            asset: krAsset,\n            amount: mintAmount,\n            user: userTwo\n        }))\n]);\n// Up the asset prices\nconst newPrice = 15;\nkrAssets.map((asset)=&gt;asset.setPrice(newPrice));\n// increase time so account is liquidatable\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR * 4);\n// should be liquidatable\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.true;\n// Asset to liquidate\nconst krAsset = krAssets[0];\nconst interestUSDTotal = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// Liquidator mints KISS\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: interestUSDTotal.add((0, _lib.toBig)(1)),\n    user: liquidator\n});\n// liquidatable value total before\nconst accruedKissInterest = (0, _lib.fromBig)((await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, krAsset.address)).kissAmount);\nconst accountCollateralBefore = await _hardhat.default.Diamond.collateralDeposits(userTwo.address, this.collateral.address);\n// Wipe seized collateral balance before liquidation for easy comparison\nawait this.collateral.setBalance(liquidator, (0, _lib.toBig)(0));\n// Liquidate\nconst tx = await (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, liquidator).liquidateInterest(userTwo.address, krAsset.address, this.collateral.address, false);\n// Should all be wiped\nconst interestAccruedAfterLiq = await _hardhat.default.Diamond.kreskoAssetDebtInterest(userTwo.address, krAsset.address);\n(0, _chai.expect)(interestAccruedAfterLiq.kissAmount).to.eq(0);\n(0, _chai.expect)(interestAccruedAfterLiq.assetAmount).to.eq(0);\nconst accountCollateralAfter = await _hardhat.default.Diamond.collateralDeposits(userTwo.address, this.collateral.address);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;InterestLiquidationOccurred\&quot;);\n// validate interest accrual changes\n(0, _chai.expect)(accountCollateralAfter).to.equal(accountCollateralBefore.sub(event.collateralSent));\nconst liquidationIncentive = (0, _lib.fromBig)((await _hardhat.default.Diamond.collateralAsset(this.collateral.address)).liquidationIncentive);\nconst expectedCollateral = accruedKissInterest / (0, _lib.fromBig)(await this.collateral.getPrice(), 8) * liquidationIncentive;\n// event validation\n(0, _chai.expect)(event.account).to.equal(userTwo.address);\n(0, _chai.expect)(event.liquidator).to.equal(liquidator.address);\n(0, _chai.expect)(event.repayKreskoAsset).to.equal(krAsset.address);\n(0, _chai.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)((0, _lib.fromBig)(event.repayUSD)).to.closeTo(accruedKissInterest, 0.0001);\n(0, _chai.expect)((0, _lib.fromBig)(event.collateralSent).toFixed(6)).to.equal(expectedCollateral.toFixed(6));\n// liquidator received collateral\n(0, _chai.expect)(await this.collateral.contract.balanceOf(liquidator.address)).to.equal(event.collateralSent);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;92bb9d0d-3571-46dc-8b00-daba9cfdde24&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot underflow seized collateral without liquidators permission&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation cannot underflow seized collateral without liquidators permission&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2578,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\n// mint each krasset\nawait Promise.all([\n    await KISS.connect(liquidator).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256),\n    await this.collateral.setBalance(userTwo, depositAmount),\n    // Deposit a bit more to cover the mints\n    await (0, _collaterals.depositCollateral)({\n        asset: this.collateral,\n        amount: depositAmount,\n        user: userTwo\n    }),\n    ...krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n            asset: krAsset,\n            amount: mintAmount,\n            user: userTwo\n        }))\n]);\n// Up the asset prices\nconst newPrice = 15;\nkrAssets.map((asset)=&gt;asset.setPrice(newPrice));\n// increase time by a lot, so account is liquidatable and seized collateral will underflow\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR * 40);\n// should be liquidatable\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.true;\n// Asset to liquidate\nconst krAsset = krAssets[0];\nconst interestUSDTotal = await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// Liquidator mints KISS\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: interestUSDTotal.add((0, _lib.toBig)(1)),\n    user: liquidator\n});\n// Wipe seized collateral balance before liquidation for easy comparison\nawait this.collateral.setBalance(liquidator, (0, _lib.toBig)(0));\n// Liquidate\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, liquidator).liquidateInterest(userTwo.address, krAsset.address, this.collateral.address, false)).to.be.revertedWith(_errors.Error.SEIZED_COLLATERAL_UNDERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ab7c2b9-f2d7-4ef8-9f5c-2ee0b5fdc166&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can batch liquidate accrued interest of unhealthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation can batch liquidate accrued interest of unhealthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3338,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await _hardhat.default.getContractOrFork(\&quot;KISS\&quot;);\nawait KISS.connect(liquidator).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, _collaterals.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo\n});\n// mint each krasset\nawait Promise.all(krAssets.map((krAsset)=&gt;(0, _krassets.mintKrAsset)({\n        asset: krAsset,\n        amount: mintAmount,\n        user: userTwo\n    })));\n// Up the asset prices\nconst newPrice = 15;\nkrAssets.map((asset)=&gt;asset.setPrice(newPrice));\n// increase time so account is liquidatable\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait _hardhatnetworkhelpers.time.increase(_calculations.ONE_YEAR * 4);\n// should be liquidatable\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.true;\nconst interestKissTotal = (0, _lib.fromBig)(await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address));\n// Liquidator mints KISS\nawait (0, _krassets.mintKrAsset)({\n    asset: KISS,\n    amount: interestKissTotal + 1,\n    user: liquidator\n});\n// Wipe seized collateral balance before liquidation for easy comparison\nawait this.collateral.setBalance(liquidator, (0, _lib.toBig)(0));\n// Liquidate\nconst tx = await (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, liquidator).batchLiquidateInterest(userTwo.address, this.collateral.address, false);\nconst interestKissTotalAfter = (0, _lib.fromBig)(await _hardhat.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address));\n(0, _chai.expect)(await _hardhat.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;BatchInterestLiquidationOccurred\&quot;);\nconst repayUSD = (0, _lib.fromBig)(event.repayUSD);\n// interest accrued changes\n(0, _chai.expect)(interestKissTotalAfter).to.closeTo(interestKissTotal - (0, _lib.fromBig)(event.repayUSD), 0.0001);\nconst liquidationIncentive = (0, _lib.fromBig)((await _hardhat.default.Diamond.collateralAsset(this.collateral.address)).liquidationIncentive);\nconst expectedCollateral = repayUSD / (0, _lib.fromBig)(await this.collateral.getPrice(), 8) * liquidationIncentive;\n// event validation\n(0, _chai.expect)(event.account).to.equal(userTwo.address);\n(0, _chai.expect)(event.liquidator).to.equal(liquidator.address);\n(0, _chai.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);\n(0, _chai.expect)((0, _lib.fromBig)(event.collateralSent)).to.closeTo(expectedCollateral, 0.0001);\n(0, _chai.expect)(repayUSD).to.closeTo(interestKissTotal - interestKissTotalAfter, 0.0001);\n// liquidator received collateral\n(0, _chai.expect)(await this.collateral.contract.balanceOf(liquidator.address)).to.equal(event.collateralSent);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3ea88c06-18ff-4aa0-82a9-7e09f4582971&quot;,&quot;parentUUID&quot;:&quot;50760287-45f7-4f76-be63-ad595cda198f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0a3db105-7c68-4523-ba90-92df9130027d&quot;,&quot;13380cb9-c798-430d-9452-2c242c0a2261&quot;,&quot;92bb9d0d-3571-46dc-8b00-daba9cfdde24&quot;,&quot;8ab7c2b9-f2d7-4ef8-9f5c-2ee0b5fdc166&quot;,&quot;3ea88c06-18ff-4aa0-82a9-7e09f4582971&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10885,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:15000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;kresko-protocol&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>