<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:88,&quot;tests&quot;:271,&quot;passes&quot;:248,&quot;pending&quot;:22,&quot;failures&quot;:1,&quot;start&quot;:&quot;2023-09-24T20:51:13.477Z&quot;,&quot;end&quot;:&quot;2023-09-24T20:56:28.764Z&quot;,&quot;duration&quot;:315287,&quot;testsRegistered&quot;:271,&quot;passPercent&quot;:99.59839357429718,&quot;pendingPercent&quot;:8.118081180811808,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;209fe3a0-be86-422b-b9b7-98d5cdb7dbc6&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5dc300d8-ceb9-436c-b87c-d1bb4136e2f9&quot;,&quot;title&quot;:&quot;Asset Amounts &amp; Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values \&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.assetValuesFixture)();\nf.user = hre.users.testUserSeven;\nUser = (0, _redstone.wrapKresko)(hre.Diamond, f.user);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9c4aeec2-9518-43a6-aadb-aabf768a7bb9&quot;,&quot;parentUUID&quot;:&quot;5dc300d8-ceb9-436c-b87c-d1bb4136e2f9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0d74f251-72e4-428b-bcdd-ca5cd91d3d10&quot;,&quot;title&quot;:&quot;#Collateral Deposit Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit value with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:297,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nconst expectedDepositValue = (0, _lib.toBig)(50, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b4ae387-fa94-4cca-89fe-d617cf617cd8&quot;,&quot;parentUUID&quot;:&quot;0d74f251-72e4-428b-bcdd-ca5cd91d3d10&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:293,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nconst expectedDepositValue = (0, _lib.toBig)(50, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7a0337b6-c899-4163-84e9-53153a4f5420&quot;,&quot;parentUUID&quot;:&quot;0d74f251-72e4-428b-bcdd-ca5cd91d3d10&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:294,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nconst expectedDepositValue = (0, _lib.toBig)(50, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9bfb9ece-c01e-4496-aaa0-598cdff3a587&quot;,&quot;parentUUID&quot;:&quot;0d74f251-72e4-428b-bcdd-ca5cd91d3d10&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value combination of different decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value combination of different decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:673,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(f.user.address, f.CollateralAsset.address, (0, _lib.toBig)(10));\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, (0, _lib.toBig)(10, 8));\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, (0, _lib.toBig)(10, 21));\nconst expectedDepositValue = (0, _lib.toBig)(150, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 30\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fae4b40e-0b11-4601-871f-3c7e52a9de59&quot;,&quot;parentUUID&quot;:&quot;0d74f251-72e4-428b-bcdd-ca5cd91d3d10&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9b4ae387-fa94-4cca-89fe-d617cf617cd8&quot;,&quot;7a0337b6-c899-4163-84e9-53153a4f5420&quot;,&quot;9bfb9ece-c01e-4496-aaa0-598cdff3a587&quot;,&quot;fae4b40e-0b11-4601-871f-3c7e52a9de59&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1557,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;4d85c817-91d5-4fd1-9115-53b32b7c233d&quot;,&quot;title&quot;:&quot;#Collateral Deposit Amount&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit amount with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:485,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(f.startingBalance));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;679be393-c0f7-4203-b4f1-e1fe91415e36&quot;,&quot;parentUUID&quot;:&quot;4d85c817-91d5-4fd1-9115-53b32b7c233d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit amount with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:481,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset8Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset8Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset8Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(f.startingBalance, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e71bbed6-d78d-427c-b730-282575df142c&quot;,&quot;parentUUID&quot;:&quot;4d85c817-91d5-4fd1-9115-53b32b7c233d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:484,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset21Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset21Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount, withdrawIndex);\nconst balance = await f.CollateralAsset21Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _lib.toBig)(f.startingBalance, 21));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ec8c3942-6dcc-4af7-b4cf-9bea7c1daf75&quot;,&quot;parentUUID&quot;:&quot;4d85c817-91d5-4fd1-9115-53b32b7c233d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;679be393-c0f7-4203-b4f1-e1fe91415e36&quot;,&quot;e71bbed6-d78d-427c-b730-282575df142c&quot;,&quot;ec8c3942-6dcc-4af7-b4cf-9bea7c1daf75&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1450,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;36d4eb40-644d-46d1-a0d4-42583418dd88&quot;,&quot;title&quot;:&quot;#Kresko Asset Debt Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1875,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, f.extOracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getDebtAmountToValue(f.KreskoAsset.address, mintAmount, true);\nconst kFactor = (await hre.Diamond.getKreskoAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(f.user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0bb197d7-127e-4d46-a02b-545d435ba45b&quot;,&quot;parentUUID&quot;:&quot;36d4eb40-644d-46d1-a0d4-42583418dd88&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1881,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, f.extOracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getDebtAmountToValue(f.KreskoAsset.address, mintAmount, true);\nconst kFactor = (await hre.Diamond.getKreskoAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(f.user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b16c5ef1-7bb6-43e4-95bb-2d6b6f43acaf&quot;,&quot;parentUUID&quot;:&quot;36d4eb40-644d-46d1-a0d4-42583418dd88&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1665,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _lib.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst mintAmount = (0, _lib.toBig)(1);\nconst expectedMintValue = (0, _lib.toBig)(20, f.extOracleDecimals); // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\nawait User.mintKreskoAsset(f.user.address, f.KreskoAsset.address, mintAmount);\nconst expectedDepositValue = (0, _lib.toBig)(49.5, f.extOracleDecimals); // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\nconst depositValue = await hre.Diamond.getAccountCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getDebtAmountToValue(f.KreskoAsset.address, mintAmount, true);\nconst kFactor = (await hre.Diamond.getKreskoAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.wadDiv(kFactor));\nconst collateralRatio = await (0, _liquidations.getCR)(f.user.address, true); // big\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.wadDiv(expectedMintValue)); // 2.475&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a97959e0-7e89-462f-a721-03bfe1fac7ff&quot;,&quot;parentUUID&quot;:&quot;36d4eb40-644d-46d1-a0d4-42583418dd88&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0bb197d7-127e-4d46-a02b-545d435ba45b&quot;,&quot;b16c5ef1-7bb6-43e4-95bb-2d6b6f43acaf&quot;,&quot;a97959e0-7e89-462f-a721-03bfe1fac7ff&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:5421,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;3989a4bb-3fe2-41b0-872c-c13a4a7723d2&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;767f0bd7-1120-4565-91cc-0b3a73c0a0cd&quot;,&quot;parentUUID&quot;:&quot;3989a4bb-3fe2-41b0-872c-c13a4a7723d2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;eb08cc1b-7271-4b00-ad9b-984fb17fc3c1&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:318,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(_hardhat.default.users.deployer.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6b4b411a-f351-4d8b-a277-b62fc372418e&quot;,&quot;parentUUID&quot;:&quot;eb08cc1b-7271-4b00-ad9b-984fb17fc3c1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets standard facet addresses&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets standard facet addresses&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:130,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetAddressesOnChain = (await _hardhat.default.Diamond.facets()).map((f)=&gt;f.facetAddress);\nconst facetAddressesArtifact = f.facets.map((f)=&gt;f.facetAddress);\n(0, _chai.expect)(facetAddressesOnChain.length).to.equal(facetAddressesArtifact.length);\n(0, _chai.expect)(facetAddressesOnChain).to.have.members(facetAddressesArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;98360060-a299-4763-ac18-d813ff0fbc2e&quot;,&quot;parentUUID&quot;:&quot;eb08cc1b-7271-4b00-ad9b-984fb17fc3c1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets selectors of standard facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets selectors of standard facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:128,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsSelectorsOnChain = (await _hardhat.default.Diamond.facets()).flatMap((f)=&gt;f.functionSelectors);\nconst facetSelectorsOnArtifact = f.facets.flatMap((f)=&gt;f.functionSelectors);\n(0, _chai.expect)(facetsSelectorsOnChain.length).to.equal(facetSelectorsOnArtifact.length);\n(0, _chai.expect)(facetsSelectorsOnChain).to.have.members(facetSelectorsOnArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0935a779-f60d-4458-bbd4-233a59e9653a&quot;,&quot;parentUUID&quot;:&quot;eb08cc1b-7271-4b00-ad9b-984fb17fc3c1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6b4b411a-f351-4d8b-a277-b62fc372418e&quot;,&quot;98360060-a299-4763-ac18-d813ff0fbc2e&quot;,&quot;0935a779-f60d-4458-bbd4-233a59e9653a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:576,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5e07627e-dd76-469b-8679-9017f3bc5be8&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _test.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6c2832b8-bf8d-44e9-b9db-94fc117c50bf&quot;,&quot;parentUUID&quot;:&quot;5e07627e-dd76-469b-8679-9017f3bc5be8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;59dc34df-a396-4135-94f7-d5c6e375ca67&quot;,&quot;title&quot;:&quot;#ownership&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:99,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.owner()).to.equal(hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;52580da6-f14f-4d47-a06a-e56e6261fa40&quot;,&quot;parentUUID&quot;:&quot;59dc34df-a396-4135-94f7-d5c6e375ca67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct default admin role&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct default admin role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:98,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.hasRole(_test.Role.ADMIN, hre.addr.deployer)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;888b54e1-af30-4f59-91f5-1fb3e85c9597&quot;,&quot;parentUUID&quot;:&quot;59dc34df-a396-4135-94f7-d5c6e375ca67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets a new pending owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets a new pending owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:198,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\n(0, _chai.expect)(await hre.Diamond.pendingOwner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;736205c9-a567-460b-816a-c49e0eaa3214&quot;,&quot;parentUUID&quot;:&quot;59dc34df-a396-4135-94f7-d5c6e375ca67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets the pending owner as new owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets the pending owner as new owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:327,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\nawait (0, _test.wrapContractWithSigner)(hre.Diamond, pendingOwner).acceptOwnership();\n(0, _chai.expect)(await hre.Diamond.owner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca20ad40-094c-470b-99da-89cfe7cb8f75&quot;,&quot;parentUUID&quot;:&quot;59dc34df-a396-4135-94f7-d5c6e375ca67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;52580da6-f14f-4d47-a06a-e56e6261fa40&quot;,&quot;888b54e1-af30-4f59-91f5-1fb3e85c9597&quot;,&quot;736205c9-a567-460b-816a-c49e0eaa3214&quot;,&quot;ca20ad40-094c-470b-99da-89cfe7cb8f75&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:722,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b3d9dfa8-f333-40ac-83b5-7986848b12a2&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59ca781f-26b1-4f7a-9bbc-abb5ed476c79&quot;,&quot;parentUUID&quot;:&quot;b3d9dfa8-f333-40ac-83b5-7986848b12a2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;title&quot;:&quot;#upgrades&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can add a new facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can add a new facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:681,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst TEST_OPERATOR_ROLE = hre.ethers.utils.id(\&quot;kresko.test.operator\&quot;);\nconst isTestOperator = await hre.Diamond.hasRole(TEST_OPERATOR_ROLE, hre.addr.userOne);\n// Succesfully added the new operator through the initialization contract\n(0, _chai.expect)(isTestOperator).to.equal(true);\nconst Facet = await hre.ethers.getContractAt([\n    ..._typechain.SmockFacet__factory.abi\n], hre.Diamond.address);\n// Ensure facet has it&#x27;s own storage\nconst operatorFromNewStorage = await Facet.operator(); // Retrieved from SmockStorage\n(0, _chai.expect)(operatorFromNewStorage).to.equal(hre.addr.userOne);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;368203b6-a54c-41e3-8fc7-b8cfa5a076b6&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:481,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const NewFacet = await (0, _addfacet.addFacet)({\n    name: \&quot;SmockFacet\&quot;,\n    initializerName: \&quot;SmockInit\&quot;,\n    initializerArgs: hre.addr.userOne\n});\nconst facetsBefore = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.filter((f)=&gt;f.facetAddress === NewFacet.address).length).to.equal(1);\nawait (0, _removefacet.removeFacet)({\n    name: \&quot;SmockFacet\&quot;\n});\nconst facetsAfter = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.length - facetsAfter.length).to.equal(1);\n(0, _chai.expect)(facetsAfter).to.not.deep.contain(NewFacet.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;046cf49f-5f7f-4838-94b4-76bc17b3cc52&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:238,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Delete acceptOwnership from DiamondOwnershipFacet\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.nonadmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst facetAddress = await hre.Diamond.facetAddress(signature);\nconst functions = await hre.Diamond.facetFunctionSelectors(facetAddress);\nconst Cut = {\n    facetAddress: hre.ethers.constants.AddressZero,\n    action: _types.FacetCutAction.Remove,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure rest of the functions remain\nconst functionsAfterCut = await hre.Diamond.facetFunctionSelectors(facetAddress);\n(0, _chai.expect)(functionsAfterCut.length).to.equal(functions.length - 1);\n// Ensure delegatecall did set the correct pending owner with the cut\nconst contract = await hre.ethers.getContractAt(\&quot;AuthEvent\&quot;, hre.Diamond.address);\nconst filter = contract.filters.PendingOwnershipTransfer(hre.addr.deployer, correctOwner);\nconst [event] = await contract.queryFilter(filter);\nconst { previousOwner , newOwner  } = event.args;\n(0, _chai.expect)(previousOwner).to.equal(hre.addr.deployer);\n(0, _chai.expect)(newOwner).to.equal(correctOwner);\n// Ensure there is no function to accept the ownership\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.nonadmin).acceptOwnership()).to.be.revertedWith(_test.Error.DIAMOND_INVALID_FUNCTION_SIGNATURE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d2481512-17d0-4948-982d-981a9d688808&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can replace a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can replace a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:388,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Same as above but instead replace the function\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.nonadmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst OldOwnershipFacet = await hre.Diamond.facetAddress(signature);\nconst [NewOwnershipFacet, allOwnershipFacetSignatures] = await hre.deploy(\&quot;DiamondOwnershipFacet\&quot;, {\n    deploymentName: \&quot;DiamondOwnershipFacet2\&quot;\n});\n// Only replace a single function, we could replace all of them\nconst Cut = {\n    facetAddress: NewOwnershipFacet.address,\n    action: _types.FacetCutAction.Replace,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nawait tx.wait();\n// Ensure function exists and revert is for invalid address instead of missing function\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.nonadmin).acceptOwnership()).to.be.revertedWith(_test.Error.DIAMOND_INVALID_PENDING_OWNER);\n// Ensure one function is contained in the new facet\nconst functionsNewFacet = await hre.Diamond.facetFunctionSelectors(NewOwnershipFacet.address);\n(0, _chai.expect)(functionsNewFacet.length).to.equal(1);\n(0, _chai.expect)(functionsNewFacet).to.have.members([\n    signature\n]);\n// Ensure rest are in the previous one\nconst functionsOldFacet = await hre.Diamond.facetFunctionSelectors(OldOwnershipFacet);\n(0, _chai.expect)(functionsOldFacet).to.not.have.members([\n    signature\n]);\n(0, _chai.expect)(functionsOldFacet.length).to.equal(allOwnershipFacetSignatures.length - 1);\n// Ensure correct owner can now accept the ownership\n(0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.userOne).acceptOwnership());\nconst currentOwner = await hre.Diamond.owner();\n(0, _chai.expect)(currentOwner).to.equal(correctOwner);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8db98586-406f-418a-b092-7726ce772dbe&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can upgrade state&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can upgrade state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:245,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\nconst Factory = await _smock.smock.mock(\&quot;SmockInit\&quot;);\nconst SmockInit = await Factory.deploy();\nconst tx = await SmockInit.populateTransaction.upgradeState();\nawait hre.Diamond.upgradeState(tx.to, tx.data);\n(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0bc0508-deaa-4af2-8afc-04218ea0200f&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can preserve old state when extending storage layout&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can preserve old state when extending storage layout&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:778,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\n// Add the first facet\nconst Factory = await _smock.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst Diamond = await hre.ethers.getContractAt(\&quot;SmockFacet\&quot;, hre.Diamond.address);\nconst isInitialized = await Diamond.smockInitialized();\n(0, _chai.expect)(isInitialized).to.equal(true);\n// Add facet with extended state\n// Add the first facet\nconst Factory2 = await _smock.smock.mock(\&quot;SmockFacet2\&quot;);\nconst SmockFacet2 = await Factory2.deploy();\nconst signatures2 = hre.getSignatures([\n    ..._typechain.SmockFacet2__factory.abi\n]);\nconst Cut2 = {\n    facetAddress: SmockFacet2.address,\n    functionSelectors: signatures2,\n    action: _types.FacetCutAction.Add\n};\n// Initializer only sets the new extended value, does not touch old storage\nconst initData2 = await SmockFacet2.populateTransaction.initialize();\nawait hre.Diamond.diamondCut([\n    Cut2\n], initData2.to, initData2.data);\n// Here we have appended the storage layout with the `extended` bool property.\nconst DiamondExtended = await hre.ethers.getContractAt(\&quot;SmockFacet2\&quot;, hre.Diamond.address);\nconst initializedAfterExtend = await DiamondExtended.getOldStructValueFromExtended();\nconst extendedValue = await DiamondExtended.getNewStructValueFromExtended();\n// Old values remain\n(0, _chai.expect)(initializedAfterExtend).to.equal(true);\n// And we get new ones\n(0, _chai.expect)(extendedValue).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3c72a04-1319-4dc0-b781-7b001dd4b561&quot;,&quot;parentUUID&quot;:&quot;ab5c2316-00b4-4a9c-9ba2-2eee605a3f5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;368203b6-a54c-41e3-8fc7-b8cfa5a076b6&quot;,&quot;046cf49f-5f7f-4838-94b4-76bc17b3cc52&quot;,&quot;d2481512-17d0-4948-982d-981a9d688808&quot;,&quot;8db98586-406f-418a-b092-7726ce772dbe&quot;,&quot;b0bc0508-deaa-4af2-8afc-04218ea0200f&quot;,&quot;f3c72a04-1319-4dc0-b781-7b001dd4b561&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2811,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;affe3b84-9e74-48cd-a441-827724b17058&quot;,&quot;title&quot;:&quot;Forking&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;42851e86-a4cc-4d2b-aae1-801bae65bfe9&quot;,&quot;title&quot;:&quot;#setup&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should get Kresko from the companion network locally&quot;,&quot;fullTitle&quot;:&quot;Forking #setup should get Kresko from the companion network locally&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c7e5238a-bb50-4376-a0ec-6721008bc0c2&quot;,&quot;parentUUID&quot;:&quot;42851e86-a4cc-4d2b-aae1-801bae65bfe9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;c7e5238a-bb50-4376-a0ec-6721008bc0c2&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;be7acb6f-448c-4269-befa-f7b950755cf5&quot;,&quot;title&quot;:&quot;#rate-upgrade-11-04-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deploy facets&quot;,&quot;fullTitle&quot;:&quot;Forking #rate-upgrade-11-04-2023 should be able to deploy facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7260c0a3-c162-4711-b739-5b9b56b6a3b7&quot;,&quot;parentUUID&quot;:&quot;be7acb6f-448c-4269-befa-f7b950755cf5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;7260c0a3-c162-4711-b739-5b9b56b6a3b7&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0744764d-d993-4c2d-814d-f0e58eda0d31&quot;,&quot;title&quot;:&quot;#facet-upgrade-16-05-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;works&quot;,&quot;fullTitle&quot;:&quot;Forking #facet-upgrade-16-05-2023 works&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e22b9e7-8e63-49e7-a0be-15ccb7c9edb7&quot;,&quot;parentUUID&quot;:&quot;0744764d-d993-4c2d-814d-f0e58eda0d31&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;1e22b9e7-8e63-49e7-a0be-15ccb7c9edb7&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;17b846af-ed21-4099-a8fa-eb1d72bcbb31&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;title&quot;:&quot;#initialization - anchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor \&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.defaultFixture)();\nconst deployment = f.krAssets.find((k)=&gt;k.deployArgs.name === name);\nKreskoAsset = deployment.contract;\nKreskoAssetAnchor = deployment.anchor;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;636d512f-698f-4b27-b0f7-f49e3521a2b0&quot;,&quot;parentUUID&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAsset.initialize(name, symbol, 18, hre.addr.deployer, hre.Diamond.address)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c503f787-e169-4ca3-938e-e186c29a9934&quot;,&quot;parentUUID&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;179cd0c5-13fb-4975-bba5-d1bc5bd77d50&quot;,&quot;parentUUID&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:21,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.name()).to.equal(name);\n(0, _chai.expect)(await KreskoAsset.symbol()).to.equal(symbol);\n(0, _chai.expect)(await KreskoAsset.kresko()).to.equal(hre.Diamond.address);\n(0, _chai.expect)(await KreskoAsset.hasRole(_test.Role.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await KreskoAsset.hasRole(_test.Role.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2fee667c-bd50-4993-9948-57222feef03e&quot;,&quot;parentUUID&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(KreskoAsset.reinitializeERC20(newName, newSymbol, 2)).to.not.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);\n(0, _chai.expect)(await KreskoAsset.name()).to.equal(newName);\n(0, _chai.expect)(await KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;13cfbfac-3310-4edb-82a6-67127ef8cb0e&quot;,&quot;parentUUID&quot;:&quot;b2c46ec1-782e-4f6a-80b8-709be75ffdd6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c503f787-e169-4ca3-938e-e186c29a9934&quot;,&quot;2fee667c-bd50-4993-9948-57222feef03e&quot;,&quot;13cfbfac-3310-4edb-82a6-67127ef8cb0e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;179cd0c5-13fb-4975-bba5-d1bc5bd77d50&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:42,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;8be6c3cc-c83f-4677-9d6b-a4df6af08db8&quot;,&quot;title&quot;:&quot;#initialization - wrapped&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAssetAnchor.initialize(KreskoAsset.address, name, symbol, hre.addr.deployer)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95001703-d843-4e41-a3e1-0fcd8bd74271&quot;,&quot;parentUUID&quot;:&quot;8be6c3cc-c83f-4677-9d6b-a4df6af08db8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAssetAnchor.name()).to.equal(name);\n(0, _chai.expect)(await KreskoAssetAnchor.symbol()).to.equal(_shared.anchorTokenPrefix + symbol);\n(0, _chai.expect)(await KreskoAssetAnchor.asset()).to.equal(KreskoAsset.address);\n(0, _chai.expect)(await KreskoAssetAnchor.hasRole(_test.Role.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await KreskoAssetAnchor.hasRole(_test.Role.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(await KreskoAsset.totalSupply());\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7d672772-66f0-4252-833b-90ef08963f2e&quot;,&quot;parentUUID&quot;:&quot;8be6c3cc-c83f-4677-9d6b-a4df6af08db8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;96b605fe-31a8-4470-8eb7-34aa1b6877ea&quot;,&quot;parentUUID&quot;:&quot;8be6c3cc-c83f-4677-9d6b-a4df6af08db8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, _chai.expect)(KreskoAssetAnchor.reinitializeERC20(newName, newSymbol, 2)).to.not.be.revertedWith(_test.Error.ALREADY_INITIALIZED_OZ);\n(0, _chai.expect)(await KreskoAssetAnchor.name()).to.equal(newName);\n(0, _chai.expect)(await KreskoAssetAnchor.symbol()).to.equal(newSymbol);\nawait KreskoAssetAnchor.reinitializeERC20(name, symbol, 3);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0137733-e83e-4192-97ac-e5ab24513da9&quot;,&quot;parentUUID&quot;:&quot;8be6c3cc-c83f-4677-9d6b-a4df6af08db8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;95001703-d843-4e41-a3e1-0fcd8bd74271&quot;,&quot;7d672772-66f0-4252-833b-90ef08963f2e&quot;,&quot;b0137733-e83e-4192-97ac-e5ab24513da9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;96b605fe-31a8-4470-8eb7-34aa1b6877ea&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:51,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;96f51d0a-bffe-4cf2-b609-a1916956d792&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset  } = await (0, _test.kreskoAssetFixture)());\nthis.owner = hre.users.deployer;\nthis.mintAmount = 125;\nawait KreskoAsset.grantRole(_test.Role.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2f63ec96-edc2-4f92-8496-9800177d1616&quot;,&quot;parentUUID&quot;:&quot;96f51d0a-bffe-4cf2-b609-a1916956d792&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;74c54a1d-244e-4abf-b8d1-b0204ddb0f9b&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to mint to their own address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the owner to mint to their own address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(this.owner.address, this.mintAmount);\n// Check total supply and owner&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c64a8c17-67a6-4ece-ba19-18bb2ea56a86&quot;,&quot;parentUUID&quot;:&quot;74c54a1d-244e-4abf-b8d1-b0204ddb0f9b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the asset owner to mint to another address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the asset owner to mint to another address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ff5a56f-2b06-449a-81f5-2daffce29dff&quot;,&quot;parentUUID&quot;:&quot;74c54a1d-244e-4abf-b8d1-b0204ddb0f9b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-owner addresses to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow non-owner addresses to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${hre.users.userOne.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and all account balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b88b4f92-9c95-45d6-b6c3-e05a558c8c68&quot;,&quot;parentUUID&quot;:&quot;74c54a1d-244e-4abf-b8d1-b0204ddb0f9b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow admin to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow admin to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.renounceRole(_test.Role.OPERATOR, this.owner.address);\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.admin).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${hre.users.admin.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;137ed000-0c0e-4639-a3a3-2b6a52affd1f&quot;,&quot;parentUUID&quot;:&quot;74c54a1d-244e-4abf-b8d1-b0204ddb0f9b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c64a8c17-67a6-4ece-ba19-18bb2ea56a86&quot;,&quot;9ff5a56f-2b06-449a-81f5-2daffce29dff&quot;,&quot;b88b4f92-9c95-45d6-b6c3-e05a558c8c68&quot;,&quot;137ed000-0c0e-4639-a3a3-2b6a52affd1f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:105,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.mintAmount = 250;\nawait KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b56bdd66-d6ae-4d3a-92f3-840fd6b29fc9&quot;,&quot;parentUUID&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f15bdb68-23b1-48e3-86c3-bd8ff48dbda2&quot;,&quot;parentUUID&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(this.owner).approve(hre.users.userOne.address, this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that token allowances are unchanged\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e35a7ac8-95b6-4dae-8251-918a061b05ff&quot;,&quot;parentUUID&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the operator to burn more tokens than user holds&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow the operator to burn more tokens than user holds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalance = await KreskoAsset.balanceOf(hre.users.userOne.address);\nconst overUserBalance = Number(userBalance) + 1;\nawait (0, _chai.expect)(KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, overUserBalance)).to.be.reverted;\n// Check total supply and user&#x27;s balances are unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d4f28a14-a3b9-487c-ac20-93d6296c9096&quot;,&quot;parentUUID&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-operator addresses to burn tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow non-operator addresses to burn tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAsset.connect(hre.users.userTwo).burn(hre.users.userOne.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${hre.users.userTwo.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and user&#x27;s balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1a2f19fc-15ab-47d8-84d4-6c8d7b3fdb9d&quot;,&quot;parentUUID&quot;:&quot;9ec91d2a-a989-42bf-8e5a-b648bab1d5d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f15bdb68-23b1-48e3-86c3-bd8ff48dbda2&quot;,&quot;e35a7ac8-95b6-4dae-8251-918a061b05ff&quot;,&quot;d4f28a14-a3b9-487c-ac20-93d6296c9096&quot;,&quot;1a2f19fc-15ab-47d8-84d4-6c8d7b3fdb9d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:88,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;328be3ae-0b3d-46d5-9d09-e63e5cb69582&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset  } = await (0, _test.kreskoAssetFixture)());\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_test.Role.OPERATOR, hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e7897334-f0c6-4c36-b7cd-1f4087e8e62c&quot;,&quot;parentUUID&quot;:&quot;328be3ae-0b3d-46d5-9d09-e63e5cb69582&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;dbbd9be6-8a80-4887-b2af-7c06cb66f6f7&quot;,&quot;title&quot;:&quot;#rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can set a positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(\&quot;1.525\&quot;);\nconst positive = true;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8468481a-2ed2-4d4e-b3f8-6901fec5a537&quot;,&quot;parentUUID&quot;:&quot;dbbd9be6-8a80-4887-b2af-7c06cb66f6f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can set a negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(\&quot;1.525\&quot;);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99d8f64b-616b-4b37-99f2-68dae716e620&quot;,&quot;parentUUID&quot;:&quot;dbbd9be6-8a80-4887-b2af-7c06cb66f6f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can be disabled by setting the denominator to 1 ether&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can be disabled by setting the denominator to 1 ether&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _lib.toBig)(1);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8a11b5d6-e103-4e0f-9061-b614abe9e359&quot;,&quot;parentUUID&quot;:&quot;dbbd9be6-8a80-4887-b2af-7c06cb66f6f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;title&quot;:&quot;#balance + supply&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has no effect when not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply has no effect when not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ea99992-293f-4d03-9199-2134c380f9be&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a30de309-05df-4ccc-9712-0465aad57f13&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;84d0d5e6-a944-41f6-bc08-ad44f32576f5&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase  @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase  @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e578cce-496d-4eb0-9ffd-474fa3588156&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;19caeefc-c088-46b9-8210-2b5b23ec85a5&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4f9472fa-572c-4aca-93ae-6a566411637e&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_test.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_test.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bfd0c186-f293-4f99-ae5e-4bb5c37c8e68&quot;,&quot;parentUUID&quot;:&quot;1469a3c6-4f08-4f5a-9b74-81aae9db3d91&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2ea99992-293f-4d03-9199-2134c380f9be&quot;,&quot;a30de309-05df-4ccc-9712-0465aad57f13&quot;,&quot;84d0d5e6-a944-41f6-bc08-ad44f32576f5&quot;,&quot;1e578cce-496d-4eb0-9ffd-474fa3588156&quot;,&quot;19caeefc-c088-46b9-8210-2b5b23ec85a5&quot;,&quot;4f9472fa-572c-4aca-93ae-6a566411637e&quot;,&quot;bfd0c186-f293-4f99-ae5e-4bb5c37c8e68&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:111,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;title&quot;:&quot;#transfer&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has default transfer behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;29b56a7e-3f0d-4ff2-9efb-fd6bc50876b3&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transfer behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e31f347f-0b44-432e-8775-c83e5a9c3ec3&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9910b0f5-6f8c-429e-b81a-56e4f4808ebe&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 100;\nconst positive = true;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;459ba94a-6837-4c2f-8293-399410ebaac3&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e459f76b-dd9b-4387-9682-d1d71e7d9ea1&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _lib.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _test.defaultMintAmount);\nconst denominator = 100;\nconst positive = false;\nawait KreskoAsset.rebase((0, _lib.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _test.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.revertedWith(_test.Error.NOT_ENOUGH_ALLOWANCE);\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d55043f7-8678-42f7-ad20-12e7b5531d61&quot;,&quot;parentUUID&quot;:&quot;2ec26ac2-b0c3-465d-99ec-e0f586cc5e6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;29b56a7e-3f0d-4ff2-9efb-fd6bc50876b3&quot;,&quot;e31f347f-0b44-432e-8775-c83e5a9c3ec3&quot;,&quot;9910b0f5-6f8c-429e-b81a-56e4f4808ebe&quot;,&quot;459ba94a-6837-4c2f-8293-399410ebaac3&quot;,&quot;e459f76b-dd9b-4387-9682-d1d71e7d9ea1&quot;,&quot;d55043f7-8678-42f7-ad20-12e7b5531d61&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:222,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;8468481a-2ed2-4d4e-b3f8-6901fec5a537&quot;,&quot;99d8f64b-616b-4b37-99f2-68dae716e620&quot;,&quot;8a11b5d6-e103-4e0f-9061-b614abe9e359&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:28,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;cc39efa0-ea7e-424d-a8a0-0651f0d3cf04&quot;,&quot;title&quot;:&quot;KreskoAssetAnchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset , KreskoAssetAnchor  } = await (0, _test.kreskoAssetFixture)());\n// Grant minting rights for test deployer\nawait Promise.all([\n    KreskoAsset.grantRole(_test.Role.OPERATOR, hre.addr.deployer),\n    KreskoAssetAnchor.grantRole(_test.Role.OPERATOR, hre.addr.deployer),\n    KreskoAsset.approve(KreskoAssetAnchor.address, hre.ethers.constants.MaxUint256)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8d474c98-181a-46eb-a45c-1f56b95e370a&quot;,&quot;parentUUID&quot;:&quot;cc39efa0-ea7e-424d-a8a0-0651f0d3cf04&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;title&quot;:&quot;#minting and burning&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;tracks the supply of underlying&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning tracks the supply of underlying&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\nawait KreskoAsset.mint(hre.addr.deployer, _test.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_test.defaultMintAmount.add(_test.defaultMintAmount));\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a69525c2-9c5c-44aa-b2b9-1b6b34dd9970&quot;,&quot;parentUUID&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning mints 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed4295c2-29ba-4ddb-8ac1-9577187bc881&quot;,&quot;parentUUID&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning deposits 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;50313e18-ab8b-4cf3-bc85-3a6be43c1c77&quot;,&quot;parentUUID&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;redeems 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning redeems 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f04cf0b-edc3-41c6-b43a-68d7a6004ce4&quot;,&quot;parentUUID&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;withdraws 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning withdraws 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;65bb4d82-b6ec-4136-b3ea-1a10b4ec4fea&quot;,&quot;parentUUID&quot;:&quot;abaf9a59-12ef-4aa4-b946-78d6a305e1b6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;23f9070b-bfe9-4844-9068-3479607e4d61&quot;,&quot;title&quot;:&quot;#rebases&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;title&quot;:&quot;#conversions&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;46d04b31-dd30-484e-9422-843eb381cb16&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce6927ee-c172-4d1d-9102-8a9af35e1d1c&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cbb40922-5d37-4b7a-a5e7-9d863f8d959d&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6d75d059-c187-464c-a58d-283926ace40e&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;910f4141-ef34-458a-916c-5aedf252c87b&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;964b14a1-a17b-47db-8f5e-2d3b4a0c9f66&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;288f7eee-dc71-48c7-805e-e6097611a518&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;040a717c-4e53-4f38-a553-87c4c3797f12&quot;,&quot;parentUUID&quot;:&quot;d8cc4ef2-60e5-4d5b-983d-07eead36c509&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;46d04b31-dd30-484e-9422-843eb381cb16&quot;,&quot;ce6927ee-c172-4d1d-9102-8a9af35e1d1c&quot;,&quot;cbb40922-5d37-4b7a-a5e7-9d863f8d959d&quot;,&quot;6d75d059-c187-464c-a58d-283926ace40e&quot;,&quot;910f4141-ef34-458a-916c-5aedf252c87b&quot;,&quot;964b14a1-a17b-47db-8f5e-2d3b4a0c9f66&quot;,&quot;288f7eee-dc71-48c7-805e-e6097611a518&quot;,&quot;040a717c-4e53-4f38-a553-87c4c3797f12&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;a69525c2-9c5c-44aa-b2b9-1b6b34dd9970&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;ed4295c2-29ba-4ddb-8ac1-9577187bc881&quot;,&quot;50313e18-ab8b-4cf3-bc85-3a6be43c1c77&quot;,&quot;1f04cf0b-edc3-41c6-b43a-68d7a6004ce4&quot;,&quot;65bb4d82-b6ec-4136-b3ea-1a10b4ec4fea&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:26,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5218818a-2e18-4790-ba80-1d50617e6d3c&quot;,&quot;title&quot;:&quot;Test KreskoAsset with Rebase and sync&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8258345b-02ff-49cf-a03a-dbbda8c6665c&quot;,&quot;parentUUID&quot;:&quot;5218818a-2e18-4790-ba80-1d50617e6d3c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0bc15bea-9011-46c4-b26c-6e5f8951b9ed&quot;,&quot;parentUUID&quot;:&quot;5218818a-2e18-4790-ba80-1d50617e6d3c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;8258345b-02ff-49cf-a03a-dbbda8c6665c&quot;,&quot;0bc15bea-9011-46c4-b26c-6e5f8951b9ed&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;94c20a3c-b723-47d6-abf6-53a4f2fe4ae3&quot;,&quot;title&quot;:&quot;Minter - Init&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Init\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Init \&quot;before each\&quot; hook in \&quot;Minter - Init\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _test.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dd834921-ddae-4695-a476-49cbba26b6e7&quot;,&quot;parentUUID&quot;:&quot;94c20a3c-b723-47d6-abf6-53a4f2fe4ae3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;84ccf55a-8b58-4e52-b444-0785b3c56e68&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct initial state&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization sets correct initial state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:621,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.getStorageVersion()).to.equal(3);\nconst { args  } = await (0, _shared.getMinterInitializer)(hre);\n(0, _chai.expect)(await hre.Diamond.hasRole(_test.Role.ADMIN, args.admin)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.hasRole(_test.Role.SAFETY_COUNCIL, hre.Multisig.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getFeeRecipient()).to.equal(args.treasury);\n(0, _chai.expect)(await hre.Diamond.getMinCollateralRatio()).to.equal(args.minCollateralRatio);\n(0, _chai.expect)(await hre.Diamond.getMinDebtValue()).to.equal(args.minDebtValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;467fc45a-06e6-42ea-ab8a-49bc1a3a0f46&quot;,&quot;parentUUID&quot;:&quot;84ccf55a-8b58-4e52-b444-0785b3c56e68&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:236,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.getStorageVersion()).to.equal(3);\nconst initializer = await (0, _shared.getMinterInitializer)(hre);\nconst initializerContract = await hre.getContractOrFork(initializer.name);\nconst tx = await initializerContract.populateTransaction.initializeMinter(initializer.args);\nawait (0, _chai.expect)(hre.Diamond.upgradeState(tx.to, tx.data)).to.be.revertedWith(_test.Error.ALREADY_INITIALIZED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;82bf8e86-bdbf-4c91-8041-ecee6c32971c&quot;,&quot;parentUUID&quot;:&quot;84ccf55a-8b58-4e52-b444-0785b3c56e68&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;configures all facets correctly&quot;,&quot;fullTitle&quot;:&quot;Minter - Init #initialization configures all facets correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:130,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsOnChain = (await hre.Diamond.facets()).map(([facetAddress, functionSelectors])=&gt;({\n        facetAddress,\n        functionSelectors\n    }));\nconst expectedFacets = await Promise.all([\n    ..._shared.minterFacets,\n    ..._shared.diamondFacets,\n    ..._shared.scdpFacets\n].map(async (name)=&gt;{\n    const deployment = await hre.deployments.get(name);\n    return {\n        facetAddress: deployment.address,\n        functionSelectors: facetsOnChain.find((f)=&gt;f.facetAddress === deployment.address).functionSelectors\n    };\n}));\n(0, _chai.expect)(facetsOnChain).to.have.deep.members(expectedFacets);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;813f2b0f-7b88-4060-956e-879df64cade3&quot;,&quot;parentUUID&quot;:&quot;84ccf55a-8b58-4e52-b444-0785b3c56e68&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;467fc45a-06e6-42ea-ab8a-49bc1a3a0f46&quot;,&quot;82bf8e86-bdbf-4c91-8041-ecee6c32971c&quot;,&quot;813f2b0f-7b88-4060-956e-879df64cade3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:987,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f4c5bf6c-32fa-4d16-9a84-37f68127764c&quot;,&quot;title&quot;:&quot;Minter - Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration \&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8f55d4a0-8d17-4971-b49b-0dc3148742c8&quot;,&quot;parentUUID&quot;:&quot;f4c5bf6c-32fa-4d16-9a84-37f68127764c&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;title&quot;:&quot;#configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can modify all parameters&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can modify all parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:757,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = (0, _test.getNewMinterParams)(hre.users.treasury.address);\nawait (0, _chai.expect)(hre.Diamond.updateMinCollateralRatio(update.minCollateralRatio)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateMinDebtValue(update.minDebtValue)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateLiquidationThreshold(update.liquidationThreshold)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateFeeRecipient(update.feeRecipient)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationRatio(update.MLR)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(update.oracleDeviationPct)).to.not.be.reverted;\nconst { minCollateralRatio , minDebtValue , feeRecipient , oracleDeviationPct  } = await hre.Diamond.getCurrentParameters();\n(0, _chai.expect)(update.minCollateralRatio.toBigInt()).to.equal(minCollateralRatio);\n(0, _chai.expect)(update.minDebtValue.toBigInt()).to.equal(minDebtValue);\n(0, _chai.expect)(update.feeRecipient).to.equal(feeRecipient);\n(0, _chai.expect)(update.oracleDeviationPct).to.equal(oracleDeviationPct);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4486e40b-ec01-41bb-bd48-3d818ca99630&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:960,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract  } = await (0, _collaterals.addMockCollateralAsset)(_test.defaultCollateralArgs);\n(0, _chai.expect)(await hre.Diamond.getCollateralExists(contract.address)).to.equal(true);\nconst [, oraclePrice] = await hre.Diamond.getCollateralAmountToValue(contract.address, (0, _lib.toBig)(1), true);\n(0, _chai.expect)(Number(oraclePrice)).to.equal((0, _lib.toBig)(_test.defaultCollateralArgs.price, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b516726b-3411-4727-9452-f150d32e3466&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1126,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract , kresko  } = await (0, _krassets.addMockKreskoAsset)();\nconst values = await kresko();\nconst kreskoPriceAnswer = (0, _lib.fromBig)(await hre.Diamond.getDebtAmountToValue(contract.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(values.exists).to.equal(true);\n(0, _chai.expect)(values.kFactor).to.equal((0, _lib.toBig)(_test.defaultKrAssetArgs.factor));\n(0, _chai.expect)(kreskoPriceAnswer).to.equal(_test.defaultKrAssetArgs.price);\n(0, _chai.expect)((0, _lib.fromBig)(values.supplyLimit)).to.equal(_test.defaultKrAssetArgs.supplyLimit);\n(0, _chai.expect)((0, _lib.fromBig)(values.closeFee)).to.equal(_test.defaultKrAssetArgs.closeFee);\n(0, _chai.expect)((0, _lib.fromBig)(values.openFee)).to.equal(_test.defaultKrAssetArgs.openFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f6e27ce7-8a19-42e4-b2c6-5f210de2d133&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update external oracle decimals&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update external oracle decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:216,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const decimals = 8;\nawait hre.Diamond.updateExtOracleDecimals(decimals);\n(0, _chai.expect)(await hre.Diamond.getExtOracleDecimals()).to.equal(decimals);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c3af63a-e81a-4a88-877f-2dcea0ee84c9&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update max liquidation ratio&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update max liquidation ratio&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:316,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentMLM = await hre.Diamond.getMaxLiquidationRatio();\nconst newMLR = (0, _lib.toBig)(1.42);\n(0, _chai.expect)(currentMLM.eq(newMLR)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateMaxLiquidationRatio(newMLR)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getMaxLiquidationRatio()).eq(newMLR)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6bfa01e-5232-423c-aca5-9bdd91c1675c&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update oracle deviation pct&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update oracle deviation pct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:296,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentODPCT = await hre.Diamond.getOracleDeviationPct();\nconst newODPCT = (0, _lib.toBig)(0.3);\n(0, _chai.expect)(currentODPCT.eq(newODPCT)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateOracleDeviationPct(newODPCT)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getOracleDeviationPct()).eq(newODPCT)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b4275887-177c-4734-95b0-2864d17c2ac7&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update kFactor of a kresko asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update kFactor of a kresko asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:297,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getKreskoAsset(f.KrAsset.address)).kFactor;\nconst newRatio = (0, _lib.toBig)(1.2);\n(0, _chai.expect)(oldRatio.eq(newRatio)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateKFactor(f.KrAsset.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getKreskoAsset(f.KrAsset.address)).kFactor.eq(newRatio)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5badd5ca-13ac-4e02-a7d7-6f36d8b4821b&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update cFactor of a collateral asset separately&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update cFactor of a collateral asset separately&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getCollateralAsset(f.Collateral.address)).factor;\nconst newRatio = (0, _lib.toBig)(0.9);\n(0, _chai.expect)(oldRatio.eq(newRatio)).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.updateCollateralFactor(f.Collateral.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getCollateralAsset(f.Collateral.address)).factor.eq(newRatio)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;625828c9-4a3f-42bd-8c5f-bb73d622ebd6&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update values of a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update values of a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:645,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oracleAnswer = (0, _lib.fromBig)((await f.KrAsset.priceFeed.latestRoundData())[1], 8);\nconst kreskoAnswer = (0, _lib.fromBig)(await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(oracleAnswer).to.equal(kreskoAnswer);\n(0, _chai.expect)(oracleAnswer).to.equal(_test.defaultKrAssetArgs.price);\nconst update = {\n    factor: (0, _lib.toBig)(1.2),\n    supplyLimit: 12000,\n    price: 20,\n    closeFee: (0, _lib.toBig)(0.02),\n    openFee: (0, _lib.toBig)(0.02)\n};\nconst FakeFeed = await (0, _oracle.getFakeOracle)(update.price);\nawait (0, _test.wrapContractWithSigner)(hre.Diamond, hre.users.deployer).updateKreskoAsset(f.KrAsset.address, ...await (0, _krassets.getKrAssetConfig)(f.KrAsset.contract, f.KrAsset.anchor.address, update.factor, (0, _lib.toBig)(update.supplyLimit), update.closeFee, update.openFee, FakeFeed.address, \&quot;MockKreskoAsset\&quot;, [\n    _oracles.OracleType.Chainlink,\n    _oracles.OracleType.Redstone\n]));\nconst newValues = await hre.Diamond.getKreskoAsset(f.KrAsset.address);\nconst updatedOracleAnswer = (0, _lib.fromBig)((await FakeFeed.latestRoundData())[1], 8);\nconst newKreskoAnswer = (0, _lib.fromBig)(await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, (0, _lib.toBig)(1), true), 8);\n(0, _chai.expect)(newValues.exists).to.equal(true);\n(0, _chai.expect)(Number(newValues.kFactor)).to.equal(Number(update.factor));\n(0, _chai.expect)((0, _lib.fromBig)(newValues.supplyLimit)).to.equal(update.supplyLimit);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(newKreskoAnswer);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(update.price);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;82491af7-c8ee-4237-83b2-325555588ada&quot;,&quot;parentUUID&quot;:&quot;990f976a-aef3-4848-a7f5-0af058920c4c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4486e40b-ec01-41bb-bd48-3d818ca99630&quot;,&quot;b516726b-3411-4727-9452-f150d32e3466&quot;,&quot;f6e27ce7-8a19-42e4-b2c6-5f210de2d133&quot;,&quot;5c3af63a-e81a-4a88-877f-2dcea0ee84c9&quot;,&quot;e6bfa01e-5232-423c-aca5-9bdd91c1675c&quot;,&quot;b4275887-177c-4734-95b0-2864d17c2ac7&quot;,&quot;5badd5ca-13ac-4e02-a7d7-6f36d8b4821b&quot;,&quot;625828c9-4a3f-42bd-8c5f-bb73d622ebd6&quot;,&quot;82491af7-c8ee-4237-83b2-325555588ada&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4912,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;50063e85-f57a-4293-8371-0c110e24c213&quot;,&quot;title&quot;:&quot;Minter - Deposit Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw \&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _testutils.depositWithdrawFixture)();\n[[user, User], [depositor, Depositor], [withdrawer, Withdrawer]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57857a20-911b-4ef9-ab6d-fdf0de2118d1&quot;,&quot;parentUUID&quot;:&quot;50063e85-f57a-4293-8371-0c110e24c213&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;cf651bcb-59e7-4078-816f-0ede38af5c48&quot;,&quot;title&quot;:&quot;#collateral&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;title&quot;:&quot;#deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:512,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _lib.toBig)(100);\nawait f.KrAssetCollateral.setBalance(user, collateralAmount, _hardhat.default.Diamond.address);\nconst depositAmount = collateralAmount.div(2);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Rebase the asset according to params\nconst denominator = 4;\nconst positive = true;\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst rebasedDepositAmount = depositAmount.mul(denominator);\nconst withdrawAmount = rebasedDepositAmount.sub(9e11.toString());\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountCollateralAssets(user.address)).to.include(f.KrAssetCollateral.address);\nawait (0, _chai.expect)(User.withdrawCollateral(user.address, f.KrAssetCollateral.address, withdrawAmount, 0)).to.be.revertedWith(_errors.Error.COLLATERAL_AMOUNT_TOO_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;011b0d11-47f3-473d-9027-2808f470aa42&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:110,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _lib.toBig)(100);\nawait f.KrAssetCollateral.setBalance(user, collateralAmount, _hardhat.default.Diamond.address);\nawait (0, _chai.expect)(User.depositCollateral(user.address, f.KrAssetCollateral.address, 9e11.toString())).to.be.revertedWith(_errors.Error.COLLATERAL_AMOUNT_TOO_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;72011cd6-b464-46b3-b05c-d8dc27697c5d&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit whitelisted collateral&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit whitelisted collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Account has deposit entry\nconst depositedCollateralAssetsAfter = await _optimizations.default.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Account&#x27;s collateral deposit balances have increased\n(0, _chai.expect)(await _optimizations.default.getAccountCollateralAmount(depositor.address, f.Collateral.address)).to.equal(f.initialDeposits);\n// Kresko&#x27;s balance has increased\n(0, _chai.expect)(await f.Collateral.balanceOf(_hardhat.default.Diamond.address)).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Account&#x27;s balance has decreased\n(0, _chai.expect)((0, _lib.fromBig)(await f.Collateral.balanceOf(depositor.address))).to.equal((0, _lib.fromBig)(f.initialBalance) - (0, _lib.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;986bf68b-2fb3-4bf8-ad99-2b13c242f51d&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:443,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the user&#x27;s deposited collateral assets should be empty.\nconst depositedCollateralAssetsBefore = await _hardhat.default.Diamond.getAccountCollateralAssets(user.address);\n(0, _chai.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral, from depositor -&gt; user.\nawait (0, _chai.expect)(Depositor.depositCollateral(user.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets has been pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits);\n// Confirm the amount as been transferred from the user into Kresko.sol\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Confirm the depositor&#x27;s wallet balance has been adjusted accordingly\nconst depositorBalanceAfter = await f.Collateral.balanceOf(depositor.address);\n(0, _chai.expect)((0, _lib.fromBig)(depositorBalanceAfter)).to.equal((0, _lib.fromBig)(f.initialBalance) - (0, _lib.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f395b38f-796d-45ae-855a-28afe2fa827c&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit more collateral to an existing deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit more collateral to an existing deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:411,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit first batch of collateral\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit second batch of collateral\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets hasn&#x27;t been double-pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(depositor.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.add(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4fcedf75-5325-494b-b5a8-6f37b524b03c&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to have deposited multiple collateral assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to have deposited multiple collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:304,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load user account with a different type of collateral\nawait f.Collateral2.setBalance(depositor, f.initialBalance, _hardhat.default.Diamond.address);\n// Deposit batch of first collateral type\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit batch of second collateral type\nawait (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral2.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets contains both collateral assets\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address,\n    f.Collateral2.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4ca28bda-18ab-4b87-abed-1b20182e8634&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralDeposited event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should emit CollateralDeposited event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await Depositor.depositCollateral(depositor.address, f.Collateral.address, f.initialDeposits);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralDeposited\&quot;);\n(0, _chai.expect)(event.account).to.equal(depositor.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;16a19521-32b3-466d-98ca-b4ecf6eb41c7&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing collateral that has not been whitelisted&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing collateral that has not been whitelisted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:96,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, \&quot;0x0000000000000000000000000000000000000001\&quot;, f.initialDeposits)).to.be.revertedWith(_errors.Error.COLLATERAL_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b80194ad-70b4-4803-9231-449f36356c72&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:97,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(Depositor.depositCollateral(depositor.address, f.Collateral.address, 0)).to.be.revertedWith(_errors.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fba5edb6-4cce-4c3e-bc71-cd9bc66ff9fd&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if collateral is not depositable&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if collateral is not depositable&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:265,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { deployer , devTwo , extOne  } = await _hardhat.default.ethers.getNamedSigners();\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    0\n], [\n    deployer,\n    devTwo,\n    extOne\n]);\nconst isDepositPaused = await _hardhat.default.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isDepositPaused).to.equal(true);\nawait (0, _chai.expect)((0, _redstone.wrapKresko)(_hardhat.default.Diamond, depositor).depositCollateral(depositor.address, f.Collateral.contract.address, 0)).to.be.revertedWith(_errors.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2e06c8f6-d8ce-44e0-90ac-f748981da7ad&quot;,&quot;parentUUID&quot;:&quot;bfcb4122-1c43-4a2e-bcf8-978acadb3815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;011b0d11-47f3-473d-9027-2808f470aa42&quot;,&quot;72011cd6-b464-46b3-b05c-d8dc27697c5d&quot;,&quot;986bf68b-2fb3-4bf8-ad99-2b13c242f51d&quot;,&quot;f395b38f-796d-45ae-855a-28afe2fa827c&quot;,&quot;4fcedf75-5325-494b-b5a8-6f37b524b03c&quot;,&quot;4ca28bda-18ab-4b87-abed-1b20182e8634&quot;,&quot;16a19521-32b3-466d-98ca-b4ecf6eb41c7&quot;,&quot;b80194ad-70b4-4803-9231-449f36356c72&quot;,&quot;fba5edb6-4cce-4c3e-bc71-cd9bc66ff9fd&quot;,&quot;2e06c8f6-d8ce-44e0-90ac-f748981da7ad&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2451,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;3a22ba5c-7b93-48f7-a221-b03873a191ef&quot;,&quot;title&quot;:&quot;#withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their entire deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw their entire deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:588,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0);\n// Ensure that the collateral asset is removed from the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssetsPostWithdraw = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssetsPostWithdraw).to.deep.equal([]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(0);\n// Ensure the amount transferred is correct\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(0);\nconst userOneBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3075dc03-33d8-4eed-b576-8179046d65aa&quot;,&quot;parentUUID&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to withdraw a portion of their deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw a portion of their deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:481,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst userOneBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits.sub(amountDeposited));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;edf894dd-9d08-490e-9997-3f6d2e2bb7ab&quot;,&quot;parentUUID&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow trusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:695,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait _hardhat.default.Diamond.grantRole(_testutils.Role.MANAGER, user.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_testutils.Role.MANAGER, user.address)).to.equal(true);\nconst collateralBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\nawait (0, _chai.expect)(User.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0)).to.not.be.reverted;\nconst collateralAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n// Ensure that collateral was withdrawn\n(0, _chai.expect)(collateralAfter).to.equal(collateralBefore.sub(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;96471f33-fe7f-4bfd-b3be-4d5385aa125a&quot;,&quot;parentUUID&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralWithdrawn event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should emit CollateralWithdrawn event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:307,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialDeposits, 0);\nconst event = await (0, _lib.getInternalEvent)(tx, _hardhat.default.Diamond, \&quot;CollateralWithdrawn\&quot;);\n(0, _chai.expect)(event.account).to.equal(withdrawer.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95974956-ca37-4140-a191-213c6a37512e&quot;,&quot;parentUUID&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(User.withdrawCollateral(withdrawer.address, f.Collateral.address, f.initialBalance, 0)).to.be.revertedWith(`AccessControl: account ${user.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed9455b6-c788-4ac3-8f5e-bd9c6841363d&quot;,&quot;parentUUID&quot;:&quot;0e50b9be-b389-4faa-b4df-34c120efbb4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is &gt; 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 \&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:397,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne mints some kr assets\nthis.mintAmount = (0, _lib.toBig)(100);\nawait Withdrawer.mintKreskoAsset(withdrawer.address, f.KrAsset.address, this.mintAmount);\n// Mint amount differs from deposited amount due to open fee\nconst amountDeposited = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\nthis.initialUserOneDeposited = amountDeposited;\nthis.mcr = await _optimizations.default.getMinCollateralRatio();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4bb186e2-3850-47fb-ad73-c3f0f4a769f6&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1648,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = (0, _lib.toBig)(10);\n// Ensure that the withdrawal would not put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst [accMinCollateralValue, accCollateralValue, withdrawnCollateralValue] = await Promise.all([\n    _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr),\n    _hardhat.default.Diamond.getAccountCollateralValue(withdrawer.address),\n    _hardhat.default.Diamond.getCollateralAmountToValue(f.Collateral.address, withdrawAmount, false).then(([value])=&gt;value)\n]);\n(0, _chai.expect)(accCollateralValue.sub(withdrawnCollateralValue).gte(accMinCollateralValue)).to.be.true;\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0);\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _optimizations.default.getAccountCollateralAssets(withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Check the balances of the contract and user\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst withdrawerBalance = await f.Collateral.balanceOf(withdrawer.address);\n(0, _chai.expect)(withdrawerBalance).to.equal(withdrawAmount);\n// Ensure the account&#x27;s minimum collateral value is &lt;= the account collateral value\nconst accountMinCollateralValueAfter = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr);\nconst accountCollateralValueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(withdrawer.address);\n(0, _chai.expect)(accountMinCollateralValueAfter.lte(accountCollateralValueAfter)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3607156d-afe4-42df-b64a-b64e8ff127ec&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:479,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomUser = _hardhat.default.users.userFour;\nawait f.Collateral.setBalance(randomUser, _ethers.BigNumber.from(0));\nawait f.Collateral.setBalance(randomUser, (0, _lib.toBig)(1000));\nawait f.Collateral.contract.connect(randomUser).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(1000),\n    user: randomUser\n});\nawait (0, _collaterals.withdrawCollateral)({\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(1010),\n    user: randomUser\n});\n(0, _chai.expect)(await f.Collateral.balanceOf(randomUser.address)).to.equal((0, _lib.toBig)(1000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44d34652-6720-4a95-bee1-833adb07b812&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if withdrawing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if withdrawing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:112,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 0;\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, 0, withdrawAmount)).to.be.revertedWith(_errors.Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;152ee3e4-868d-43bb-bceb-f5384356796a&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the withdrawal violates the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the withdrawal violates the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1315,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne has a debt position, so attempting to withdraw the entire collateral deposit should be impossible\nconst withdrawAmount = f.initialBalance;\n// Ensure that the withdrawal would in fact put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(withdrawer.address, this.mcr);\nconst accountCollateralValue = await _hardhat.default.Diamond.getAccountCollateralValue(withdrawer.address);\nconst [withdrawnCollateralValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.Collateral.address, withdrawAmount, false);\n(0, _chai.expect)(accountCollateralValue.sub(withdrawnCollateralValue).lt(accountMinCollateralValue)).to.be.true;\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 0)).to.be.revertedWith(_errors.Error.COLLATERAL_INSUFFICIENT_AMOUNT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b5c0beab-4155-478b-8bfe-6a4e097db5c6&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait (0, _chai.expect)(Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, 1)).to.be.revertedWith(_errors.Error.ARRAY_OUT_OF_BOUNDS);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;68befb1d-2282-4d1c-88f9-b9a5ed8a69f3&quot;,&quot;parentUUID&quot;:&quot;eda38119-5d7b-4724-bfc5-45a8fce75d1e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3607156d-afe4-42df-b64a-b64e8ff127ec&quot;,&quot;44d34652-6720-4a95-bee1-833adb07b812&quot;,&quot;152ee3e4-868d-43bb-bceb-f5384356796a&quot;,&quot;b5c0beab-4155-478b-8bfe-6a4e097db5c6&quot;,&quot;68befb1d-2282-4d1c-88f9-b9a5ed8a69f3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3649,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;3075dc03-33d8-4eed-b576-8179046d65aa&quot;,&quot;edf894dd-9d08-490e-9997-3f6d2e2bb7ab&quot;,&quot;96471f33-fe7f-4bfd-b3be-4d5385aa125a&quot;,&quot;95974956-ca37-4140-a191-213c6a37512e&quot;,&quot;ed9455b6-c788-4ac3-8f5e-bd9c6841363d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2178,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;028c5b77-6b8a-4685-b41d-0b0ddb2f3bf0&quot;,&quot;title&quot;:&quot;#deposit - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase \&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:587,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setBalance(user, f.initialBalance, _hardhat.default.Diamond.address);\n// Add krAsset as a collateral with anchor and cFactor of 1\n// Allowance for Kresko\nawait f.KrAssetCollateral.contract.setVariable(\&quot;_allowances\&quot;, {\n    [user.address]: {\n        [_hardhat.default.Diamond.address]: _hardhat.default.ethers.constants.MaxInt256\n    }\n});\n// Deposit some collateral\nawait User.depositCollateral(user.address, f.Collateral.address, f.initialDeposits);\n// Mint some krAssets\nawait User.mintKreskoAsset(user.address, f.KrAssetCollateral.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await User.getAccountDebtAmount(user.address, f.KrAssetCollateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3b39245-4368-4f1f-940d-bea59b681612&quot;,&quot;parentUUID&quot;:&quot;028c5b77-6b8a-4685-b41d-0b0ddb2f3bf0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;title&quot;:&quot;deposit amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:523,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst expectedDepositsAfter = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(expectedDepositsAfter);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c30a86d0-e98c-4734-873c-1f19c103f384&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:339,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmountAfterRebase = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmountAfterRebase);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ed7e0b9-3a09-4124-9d3e-bb0f453397dd&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:325,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;455d9e40-3e08-4a43-b82b-809f726ab356&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:328,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;341d5c99-0e8e-4901-9979-7e5cee70f82f&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:636,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca8232e5-8db6-4018-a5a0-9d812514a31f&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:427,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfterRebase = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfterRebase).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(user.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c694f7a5-de7f-469b-940c-19659975492c&quot;,&quot;parentUUID&quot;:&quot;74eee82a-2c1b-40cf-9793-6627454c991e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c30a86d0-e98c-4734-873c-1f19c103f384&quot;,&quot;9ed7e0b9-3a09-4124-9d3e-bb0f453397dd&quot;,&quot;455d9e40-3e08-4a43-b82b-809f726ab356&quot;,&quot;341d5c99-0e8e-4901-9979-7e5cee70f82f&quot;,&quot;ca8232e5-8db6-4018-a5a0-9d812514a31f&quot;,&quot;c694f7a5-de7f-469b-940c-19659975492c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2578,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;title&quot;:&quot;deposit usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:699,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nf.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0113835-6f50-428e-8d92-064180e6ff28&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:926,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nf.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountCollateralValue(user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1cf3fceb-168b-4a5c-b238-d0b3b7eb4300&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:513,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b697bcdc-2a01-49bb-8bce-1c5e5c1992fb&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:705,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cb09141a-101b-4c3c-8af6-320f493b2867&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:989,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, fullDepositAmount, false);\n// Deposit more\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.bignumber.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2dfaf08e-0b35-45f7-af27-7bfa2d678ca0&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1231,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst [expectedValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.KrAssetCollateral.address, fullDepositAmount, false);\n// Deposit more\nawait User.depositCollateral(user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.bignumber.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7cef2d59-1a6f-4aae-bdd3-790fff4f3df8&quot;,&quot;parentUUID&quot;:&quot;0cc9b25b-47bd-4d18-b6c8-e89f430f8201&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f0113835-6f50-428e-8d92-064180e6ff28&quot;,&quot;1cf3fceb-168b-4a5c-b238-d0b3b7eb4300&quot;,&quot;b697bcdc-2a01-49bb-8bce-1c5e5c1992fb&quot;,&quot;cb09141a-101b-4c3c-8af6-320f493b2867&quot;,&quot;2dfaf08e-0b35-45f7-af27-7bfa2d678ca0&quot;,&quot;7cef2d59-1a6f-4aae-bdd3-790fff4f3df8&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:5063,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;474460fc-28fa-4c14-b365-7c1046ce8240&quot;,&quot;title&quot;:&quot;#withdraw - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase \&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:385,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Withdrawer.mintKreskoAsset(withdrawer.address, f.KrAssetCollateral.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await _optimizations.default.getAccountDebtAmount(withdrawer.address, f.KrAssetCollateral);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4f26c9f8-d807-4c90-9def-04529461a3dc&quot;,&quot;parentUUID&quot;:&quot;474460fc-28fa-4c14-b365-7c1046ce8240&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;title&quot;:&quot;withdraw amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:816,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit collateral before rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3ba38cef-9218-4728-a62c-88975300529b&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1064,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit collateral before rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;41453a06-099b-4371-b0f0-932650516267&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after an positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:810,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b7ddd19-17ad-4afb-a971-6af86ce34fb4&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1017,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3e21ed17-8720-4a5b-abe6-3598d892bf15&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:904,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit before the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;38597808-4f59-423d-a11d-d7cbf51d779b&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1119,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit before the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _optimizations.default.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2b252a18-b1c6-43ad-ba4a-40c680e058ad&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:598,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _lib.toBig)(10);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst nrcBalanceBefore = await f.Collateral.contract.balanceOf(withdrawer.address);\nconst expectedNrcBalanceAfter = nrcBalanceBefore.add(withdrawAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.Collateral.address));\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(expectedNrcBalanceAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb1d4f99-36c5-4e1b-9c35-a2ec01c099ca&quot;,&quot;parentUUID&quot;:&quot;29349364-056a-4fe4-a934-50467f97e647&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3ba38cef-9218-4728-a62c-88975300529b&quot;,&quot;41453a06-099b-4371-b0f0-932650516267&quot;,&quot;1b7ddd19-17ad-4afb-a971-6af86ce34fb4&quot;,&quot;3e21ed17-8720-4a5b-abe6-3598d892bf15&quot;,&quot;38597808-4f59-423d-a11d-d7cbf51d779b&quot;,&quot;2b252a18-b1c6-43ad-ba4a-40c680e058ad&quot;,&quot;eb1d4f99-36c5-4e1b-9c35-a2ec01c099ca&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6328,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;title&quot;:&quot;withdraw usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1013,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aaa49d01-e7d6-4cdf-9980-6666ff0f6f80&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1022,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;09c79ec4-aef4-47c7-bc3a-5e517bd579ba&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:800,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8cbfdec8-71a2-462f-adaf-de2a4033f94f&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1017,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, depositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e217b579-2c63-4086-8de4-5d970e4642ea&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1296,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Deposit more\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3eb82fa-39bd-4063-9825-3eb9146be4fd&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1500,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(denominator).div(2);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.bignumber.equal(valueAfterRebase);\n// Deposit more\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.KrAssetCollateral.address, fullDepositAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(withdrawer.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8429dcb5-94e9-4912-849d-16cad22c2fed&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1970,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _lib.fromBig)(await f.KrAssetCollateral.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, _lib.toBig)(10);\nawait Withdrawer.depositCollateral(withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst accountValueBefore = await _hardhat.default.Diamond.getAccountCollateralValue(withdrawer.address);\nconst [nrcValueBefore] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.Collateral.address);\nconst [withdrawValue] = await _hardhat.default.Diamond.getCollateralAmountToValue(f.Collateral.address, withdrawAmount, false);\nconst expectedNrcValueAfter = nrcValueBefore.sub(withdrawValue);\n// Rebase the asset according to params\nf.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait Withdrawer.withdrawCollateral(withdrawer.address, f.Collateral.address, withdrawAmount, _optimizations.default.getAccountDepositIndex(withdrawer.address, f.KrAssetCollateral.address));\nconst finalAccountValue = await _hardhat.default.Diamond.getAccountCollateralValue(withdrawer.address);\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValueOf(withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(finalValue).to.equal(expectedNrcValueAfter);\n(0, _chai.expect)(finalAccountValue).to.bignumber.equal(accountValueBefore.sub(withdrawValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;07e4e800-20b2-494f-944a-cc6d22820cff&quot;,&quot;parentUUID&quot;:&quot;708d9b21-e358-4093-9f76-99a4283c0e5d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;aaa49d01-e7d6-4cdf-9980-6666ff0f6f80&quot;,&quot;09c79ec4-aef4-47c7-bc3a-5e517bd579ba&quot;,&quot;8cbfdec8-71a2-462f-adaf-de2a4033f94f&quot;,&quot;e217b579-2c63-4086-8de4-5d970e4642ea&quot;,&quot;f3eb82fa-39bd-4063-9825-3eb9146be4fd&quot;,&quot;8429dcb5-94e9-4912-849d-16cad22c2fed&quot;,&quot;07e4e800-20b2-494f-944a-cc6d22820cff&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:8618,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;72b625ea-b414-4ab6-a4fb-5f19ed230261&quot;,&quot;title&quot;:&quot;Minter - Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations \&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _testutils.liquidationsFixture)();\n[[user1, User], [user2], [user3], [user4], [user5], [liquidator, Liquidator], [liquidatorTwo, LiquidatorTwo]] = f.users;\nf.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8db7938d-7bb1-4139-b398-6753deac70a7&quot;,&quot;parentUUID&quot;:&quot;72b625ea-b414-4ab6-a4fb-5f19ed230261&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;bd30b890-285f-4928-8e19-150122e26ab4&quot;,&quot;title&quot;:&quot;#isAccountLiquidatable&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify accounts below their liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #isAccountLiquidatable should identify accounts below their liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1232,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [cr, minCollateralUSD, initialCanLiquidate] = await Promise.all([\n    (0, _liquidations.getCR)(user1.address),\n    hre.Diamond.getAccountMinCollateralAtRatio(user1.address, hre.Diamond.getLiquidationThreshold()),\n    hre.Diamond.getAccountLiquidatable(user1.address)\n]);\n(0, _chai.expect)(cr).to.be.equal(1.5);\n(0, _chai.expect)(f.initialDeposits.mul(10).gt(minCollateralUSD));\n(0, _chai.expect)(initialCanLiquidate).to.equal(false);\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7fdf78ef-e7a4-48e3-a68d-7c3269e996e2&quot;,&quot;parentUUID&quot;:&quot;bd30b890-285f-4928-8e19-150122e26ab4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7fdf78ef-e7a4-48e3-a68d-7c3269e996e2&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1232,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;89eba0e4-9d15-4fe3-867c-1882deccb055&quot;,&quot;title&quot;:&quot;#maxLiquidatableValue&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 1&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 1&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1930,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(7.5);\nconst [crAfter, isLiquidatableAfter, MLV, MLVCalc] = await Promise.all([\n    (0, _liquidations.getCR)(user1.address),\n    hre.Diamond.getAccountLiquidatable(user1.address),\n    hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral.address),\n    (0, _liquidations.getExpectedMaxLiq)(user1, f.KrAsset, f.Collateral)\n]);\n(0, _chai.expect)(crAfter).to.be.equal(1.125);\n(0, _chai.expect)(isLiquidatableAfter).to.be.true;\n(0, _chai.expect)(MLVCalc).to.be.closeTo(MLV, USD_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0f1190b-579b-4191-a670-5e4dc830206d&quot;,&quot;parentUUID&quot;:&quot;89eba0e4-9d15-4fe3-867c-1882deccb055&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2077,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updateCollateralFactor(f.Collateral.address, (0, _lib.toBig)(0.25));\nawait (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: f.initialDeposits.div(2),\n    asset: f.Collateral2\n});\nconst expectedCR = 1.125;\nconst [crAfter, isLiquidatableAfter, MLVAfterC1, MLVAfterC2] = await Promise.all([\n    (0, _liquidations.getCR)(user1.address),\n    hre.Diamond.getAccountLiquidatable(user1.address),\n    hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral.address),\n    hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral2.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.true;\n(0, _chai.expect)(crAfter).to.be.closeTo(expectedCR, CR_DELTA);\n(0, _chai.expect)(MLVAfterC2.gt(MLVAfterC1)).to.be.true;\n        // await liquidate(user1, f.KrAsset, f.Collateral);\n        // expect(await getCR(user1.address)).to.be.gt(1.4);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f29d2c03-6704-4730-9d11-10244737b6a9&quot;,&quot;parentUUID&quot;:&quot;89eba0e4-9d15-4fe3-867c-1882deccb055&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV with multiple cdps&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV with multiple cdps&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: (0, _lib.toBig)(0.1, 8),\n    asset: f.Collateral8Dec\n});\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.true;\nconst [expectedMaxLiq, maxLiq, expectedMaxLiq8Dec, maxLiq8Dec] = await Promise.all([\n    (0, _liquidations.getExpectedMaxLiq)(user1, f.KrAsset, f.Collateral),\n    hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral.address),\n    (0, _liquidations.getExpectedMaxLiq)(user1, f.KrAsset, f.Collateral8Dec),\n    hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(expectedMaxLiq.gt(0)).to.be.true;\n(0, _chai.expect)(expectedMaxLiq8Dec.gt(0)).to.be.true;\n(0, _chai.expect)(expectedMaxLiq).to.be.closeTo(maxLiq, USD_DELTA);\n(0, _chai.expect)(expectedMaxLiq8Dec).to.be.closeTo(maxLiq8Dec, USD_DELTA);\n(0, _chai.expect)(expectedMaxLiq8Dec).lt(expectedMaxLiq);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;01d80dd2-2785-460d-bdc4-9db0d2161ddd&quot;,&quot;parentUUID&quot;:&quot;89eba0e4-9d15-4fe3-867c-1882deccb055&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b0f1190b-579b-4191-a670-5e4dc830206d&quot;,&quot;f29d2c03-6704-4730-9d11-10244737b6a9&quot;,&quot;01d80dd2-2785-460d-bdc4-9db0d2161ddd&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:7230,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;78528b52-9f83-4994-ba41-1d961f60abb8&quot;,&quot;title&quot;:&quot;#liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;title&quot;:&quot;#liquidate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate \&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(7.5);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57f0be95-319d-4250-8bbd-c64eb3d6a4e3&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow unhealthy accounts to be liquidated&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow unhealthy accounts to be liquidated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:868,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Fetch pre-liquidation state for users and contracts\nconst beforeUserOneCollateralAmount = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral);\nconst userOneDebtBefore = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst liquidatorBalanceBefore = await f.Collateral.balanceOf(liquidator.address);\nconst liquidatorBalanceKrBefore = await f.KrAsset.balanceOf(liquidator.address);\nconst kreskoBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\n// Liquidate userOne\nconst maxRepayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _lib.toBig)(11, 8));\nawait Liquidator.liquidate(user1.address, f.KrAsset.address, maxRepayAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address), false);\n// Confirm that the liquidated user&#x27;s debt amount has decreased by the repaid amount\nconst userOneDebtAfterLiquidation = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebtAfterLiquidation.eq(userOneDebtBefore.sub(maxRepayAmount)));\n// Confirm that some of the liquidated user&#x27;s collateral has been seized\nconst userOneCollateralAfterLiquidation = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral);\n(0, _chai.expect)(userOneCollateralAfterLiquidation.lt(beforeUserOneCollateralAmount));\n// Confirm that userTwo&#x27;s kresko asset balance has decreased by the repaid amount\n(0, _chai.expect)(await f.KrAsset.balanceOf(liquidator.address)).eq(liquidatorBalanceKrBefore.sub(maxRepayAmount));\n// Confirm that userTwo has received some collateral from the contract\n(0, _chai.expect)(await f.Collateral.balanceOf(liquidator.address)).gt(liquidatorBalanceBefore);\n// Confirm that Kresko contract&#x27;s collateral balance has decreased.\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).lt(kreskoBalanceBefore);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eaf64fab-83e8-4614-b516-d5574160deb2&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with a single CDP&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with a single CDP&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1801,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _lib.toBig)(11, 8));\nawait Liquidator.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address), false);\n(0, _chai.expect)(await (0, _liquidations.getCR)(user1.address, true)).to.be.closeTo(await _optimizations.default.getMaxLiquidationRatio(), (0, _lib.toBig)(CR_DELTA));\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7684add4-587c-4c1a-bbba-951d43ac5460&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with multiple CDPs&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with multiple CDPs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3011,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: (0, _lib.toBig)(10, 8),\n    asset: f.Collateral8Dec\n});\nf.Collateral.setPrice(5);\nf.Collateral8Dec.setPrice(6);\nawait hre.Diamond.updateCollateralFactor(f.Collateral.address, (0, _lib.toBig)(0.975));\nawait hre.Diamond.updateKFactor(f.KrAsset.address, (0, _lib.toBig)(1.05));\nawait (0, _liquidations.liquidate)(user1, f.KrAsset, f.Collateral8Dec);\nconst [crAfter, isLiquidatableAfter] = await Promise.all([\n    (0, _liquidations.getCR)(user1.address, true),\n    hre.Diamond.getAccountLiquidatable(user1.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.false;\n(0, _chai.expect)(crAfter).to.be.closeTo(await _optimizations.default.getMaxLiquidationRatio(), (0, _lib.toBig)(CR_DELTA));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6457269b-f351-44b6-9f8f-b2ac0d6067e1&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit LiquidationOccurred event&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should emit LiquidationOccurred event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:799,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _lib.toBig)(11));\nconst tx = await Liquidator.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address), false);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;LiquidationOccurred\&quot;);\n(0, _chai.expect)(event.args.account).to.equal(user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(liquidator.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.repayAmount).to.equal(repayAmount);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ef09d099-4a65-4977-8719-50885818dedc&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations of healthy accounts&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations of healthy accounts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:303,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(10);\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _chai.expect)(Liquidator.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex, false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;772cae9a-a16d-4b9b-a704-c0b7e68924ed&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations if repayment amount is 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations if repayment amount is 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:98,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 0;\nawait (0, _chai.expect)(LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.ZERO_REPAY);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;309ad228-47ae-4f69-9c76-8ae6f9885055&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:401,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Get user&#x27;s debt for this kresko asset\nconst krAssetDebtUserOne = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n// Ensure we are repaying more than debt\nconst repayAmount = krAssetDebtUserOne.add((0, _lib.toBig)(1));\n// Liquidation should fail\nawait (0, _chai.expect)(LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.KRASSET_BURN_AMOUNT_OVERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e4cf76a8-03ab-493e-a2ec-8c64eed05c14&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2043,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: user1,\n    amount: (0, _lib.toBig)(2, 8),\n    asset: f.Collateral8Dec\n});\nconst allowedRepaymentValue = await hre.Diamond.getMaxLiquidation(user1.address, f.KrAsset.address, f.Collateral.address);\nconst allowedRepaymentAmount = allowedRepaymentValue.wadDiv((0, _lib.toBig)(11, 8));\nconst overflowRepayment = allowedRepaymentAmount.add((0, _lib.toBig)(1));\nconst tx = await Liquidator.liquidate(user1.address, f.KrAsset.address, overflowRepayment, f.Collateral.address, 0, 0, false);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;LiquidationOccurred\&quot;);\nconst assetInfo = await f.Collateral.kresko();\nconst expectedSeizedCollateralAmount = allowedRepaymentValue.wadMul(_ethers.BigNumber.from(assetInfo.liquidationIncentive)).wadDiv(await f.Collateral.getPrice());\n(0, _chai.expect)(event.args.account).to.equal(user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(liquidator.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.args.repayAmount).to.not.equal(overflowRepayment);\n(0, _chai.expect)(event.args.repayAmount).to.equal(allowedRepaymentAmount);\n(0, _chai.expect)(event.args.collateralSent).to.be.equal(expectedSeizedCollateralAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f51ee38c-1cf4-42b9-89d4-618f2eaac6f9&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1169,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(f.Collateral.deployArgs.price);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;\nconst minCollateralUSD = await hre.Diamond.getAccountMinCollateralAtRatio(user1.address, _optimizations.default.getMinCollateralRatio());\nconst liquidationThresholdUSD = await hre.Diamond.getAccountMinCollateralAtRatio(user1.address, _optimizations.default.getLiquidationThreshold());\nf.Collateral.setPrice(9.9);\nconst accountCollateralValue = await hre.Diamond.getAccountCollateralValue(user1.address);\n(0, _chai.expect)(accountCollateralValue.lt(minCollateralUSD)).to.be.true;\n(0, _chai.expect)(accountCollateralValue.gt(liquidationThresholdUSD)).to.be.true;\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d0bc5920-a07b-4821-8d77-878ea152d1f0&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations without liquidator token approval for Kresko Assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow liquidations without liquidator token approval for Kresko Assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:882,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check that liquidator&#x27;s token approval to Kresko.sol contract is 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(liquidatorTwo.address, hre.Diamond.address)).to.equal(0);\nconst repayAmount = (0, _lib.toBig)(0.5);\nawait f.KrAsset.setBalance(liquidatorTwo, repayAmount);\nawait LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0, false);\n// Confirm that liquidator&#x27;s token approval is still 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(user2.address, hre.Diamond.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cebabd2d-61a9-40d7-8965-b5d86a21dcb1&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1146,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = (0, _lib.toBig)(0.5);\nawait f.KrAsset.setBalance(liquidatorTwo, repayAmount);\nawait f.KrAsset.contract.setVariable(\&quot;_allowances\&quot;, {\n    [liquidatorTwo.address]: {\n        [hre.Diamond.address]: repayAmount\n    }\n});\nawait (0, _chai.expect)(LiquidatorTwo.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0, false)).not.to.be.reverted;\n// Confirm that liquidator&#x27;s token approval is unchanged\n(0, _chai.expect)(await f.KrAsset.contract.allowance(liquidatorTwo.address, hre.Diamond.address)).to.equal(repayAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a895f0d7-7627-48e0-97ae-a7085bfddd48&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow borrowers to liquidate themselves&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow borrowers to liquidate themselves&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:97,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 5;\nawait (0, _chai.expect)(User.liquidate(user1.address, f.KrAsset.address, repayAmount, f.Collateral.address, 0, 0, false)).to.be.revertedWith(_errors.Error.SELF_LIQUIDATION);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;41730840-75d4-4e21-90ef-c6e50cbffaf5&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow seized amount to underflow without liquidators permission&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow seized amount to underflow without liquidators permission&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(6);\nconst liqAmount = await (0, _liquidations.getLiqAmount)(user1, f.KrAsset, f.Collateral);\nconst allowSeizeUnderflow = false;\nawait (0, _chai.expect)(Liquidator.liquidate(user1.address, f.KrAsset.address, liqAmount, f.Collateral.address, 0, 0, allowSeizeUnderflow)).to.be.revertedWith(_errors.Error.SEIZED_COLLATERAL_UNDERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;efcf14ae-bfc3-4179-b24e-ee3b932240a1&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow seized amount to underflow with liquidators permission&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow seized amount to underflow with liquidators permission&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1169,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.Collateral.setPrice(6);\nconst liqAmount = await (0, _liquidations.getLiqAmount)(user1, f.KrAsset, f.Collateral);\nconst allowSeizeUnderflow = true;\nawait (0, _chai.expect)(Liquidator.liquidate(user1.address, f.KrAsset.address, liqAmount, f.Collateral.address, _optimizations.default.getAccountMintIndex(user1.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user1.address, f.Collateral.address), allowSeizeUnderflow)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d9ce82c5-5697-4d3f-a5f2-3551e4bb15e9&quot;,&quot;parentUUID&quot;:&quot;07244040-16c8-414c-beec-9af6a39bc7e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;eaf64fab-83e8-4614-b516-d5574160deb2&quot;,&quot;7684add4-587c-4c1a-bbba-951d43ac5460&quot;,&quot;6457269b-f351-44b6-9f8f-b2ac0d6067e1&quot;,&quot;ef09d099-4a65-4977-8719-50885818dedc&quot;,&quot;772cae9a-a16d-4b9b-a704-c0b7e68924ed&quot;,&quot;309ad228-47ae-4f69-9c76-8ae6f9885055&quot;,&quot;e4cf76a8-03ab-493e-a2ec-8c64eed05c14&quot;,&quot;f51ee38c-1cf4-42b9-89d4-618f2eaac6f9&quot;,&quot;d0bc5920-a07b-4821-8d77-878ea152d1f0&quot;,&quot;cebabd2d-61a9-40d7-8965-b5d86a21dcb1&quot;,&quot;a895f0d7-7627-48e0-97ae-a7085bfddd48&quot;,&quot;41730840-75d4-4e21-90ef-c6e50cbffaf5&quot;,&quot;efcf14ae-bfc3-4179-b24e-ee3b932240a1&quot;,&quot;d9ce82c5-5697-4d3f-a5f2-3551e4bb15e9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:15010,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;title&quot;:&quot;#liquidate - rebasing events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events \&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.resetRebasing();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f55b0f33-8e91-404b-b167-f959c45cdbe0&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should setup correct&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should setup correct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1475,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [mcr, cr, cr2, liquidatable] = await Promise.all([\n    _optimizations.default.getMinCollateralRatio(),\n    (0, _liquidations.getCR)(user3.address),\n    (0, _liquidations.getCR)(user4.address),\n    hre.Diamond.getAccountLiquidatable(user3.address)\n]);\nconst mcrDecimal = (0, _lib.fromBig)(mcr, 18);\n(0, _chai.expect)(cr).to.closeTo(mcrDecimal, 0.001);\n(0, _chai.expect)(cr2).to.closeTo(mcrDecimal, 0.001);\n(0, _chai.expect)(liquidatable).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6912f4b7-2f73-4b95-b2b4-4bd1f8a92282&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:537,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(Liquidator.liquidate(user4.address, f.KrAsset.address, 100, f.Collateral.address, _optimizations.default.getAccountMintIndex(user4.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user4.address, f.Collateral.address), false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5a423cf5-738e-4125-b96c-7ffd439b0039&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:295,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(Liquidator.liquidate(user4.address, f.KrAsset.address, 100, f.Collateral.address, _optimizations.default.getAccountMintIndex(user4.address, f.KrAsset.address), _optimizations.default.getAccountDepositIndex(user4.address, f.Collateral.address), false)).to.be.revertedWith(_errors.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f887468-2c52-4ba5-b731-a6df5431af93&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3247,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.false;\nf.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.true;\nawait (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true);\nawait (0, _chai.expect)((0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ba5b9405-7cd6-45c3-a978-5881bb4d4367&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2821,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.false;\nf.KrAsset.setPrice(rebasePrice + 1);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user4.address)).to.be.true;\nawait (0, _chai.expect)((0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;46be7b30-e8b5-4630-89cd-a1c38845c5ed&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate krAsset collaterals up to min amount&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate krAsset collaterals up to min amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1400,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f.KrAssetCollateral.setPrice(100);\nconst MAGIC_NUMBER = _ethers.BigNumber.from(\&quot;1869158877653366666667\&quot;); // repay amount to bring user3 debt under 1e12\nawait f.KrAssetCollateral.setBalance(hre.users.liquidator, MAGIC_NUMBER, hre.Diamond.address);\nawait Liquidator.liquidate(user3.address, f.KrAssetCollateral.address, MAGIC_NUMBER, f.KrAssetCollateral.address, _optimizations.default.getAccountMintIndex(user3.address, f.KrAssetCollateral.address), _optimizations.default.getAccountDepositIndex(user3.address, f.KrAssetCollateral.address), false);\nconst depositsAfter = await hre.Diamond.getAccountCollateralAmount(user3.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsAfter).to.equal(1e12.toString());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2a6912c-ceff-45bf-800d-4cd78433df24&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6242,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nf.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user4.address)){\n    const values = await (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(user4.address), 8);\nresults.userOneHFAfter = await (0, _liquidations.getCR)(user4.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = newPrice / denominator;\n// Rebase\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user5.address)){\n    const values = await (0, _liquidations.liquidate)(user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(user5.address), 8);\nresults.userTwoHFAfter = await (0, _liquidations.getCR)(user5.address);\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid * denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;89aed2ff-1a49-439a-bb14-00ef5c802a84&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of assets after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of assets after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6303,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nf.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user4.address)){\n    const values = await (0, _liquidations.liquidate)(user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(user4.address), 8);\nresults.userOneHFAfter = await (0, _liquidations.getCR)(user4.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = newPrice * denominator;\n// Rebase\nf.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(user5.address)){\n    const values = await (0, _liquidations.liquidate)(user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _lib.fromBig)(await hre.Diamond.getAccountCollateralValue(user5.address), 8);\nresults.userTwoHFAfter = await (0, _liquidations.getCR)(user5.address);\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid / denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ab22dd9-5e58-4bd5-9e90-57d2cb760f67&quot;,&quot;parentUUID&quot;:&quot;ab5bef44-431d-4044-996f-96d37bc79606&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6912f4b7-2f73-4b95-b2b4-4bd1f8a92282&quot;,&quot;5a423cf5-738e-4125-b96c-7ffd439b0039&quot;,&quot;6f887468-2c52-4ba5-b731-a6df5431af93&quot;,&quot;ba5b9405-7cd6-45c3-a978-5881bb4d4367&quot;,&quot;46be7b30-e8b5-4630-89cd-a1c38845c5ed&quot;,&quot;c2a6912c-ceff-45bf-800d-4cd78433df24&quot;,&quot;89aed2ff-1a49-439a-bb14-00ef5c802a84&quot;,&quot;1ab22dd9-5e58-4bd5-9e90-57d2cb760f67&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:22320,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;2fb3ff3f-e8a0-4491-8519-18feac2c7ce6&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _testutils.mintRepayFixture)();\n[[user1, User1], [user2, User2]] = f.users;\nf.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;13c4e45d-0718-433b-b6da-72d8b5e7481f&quot;,&quot;parentUUID&quot;:&quot;2fb3ff3f-e8a0-4491-8519-18feac2c7ce6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;763a66cf-2561-4195-bb55-1ee286a5ecac&quot;,&quot;title&quot;:&quot;#mint+burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:901,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(f.initialMintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, _lib.toBig)(10);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMinted = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMinted).to.equal(mintAmount);\n// Confirm the user&#x27;s Kresko asset balance has increased\nconst userBalance = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalance).to.equal(mintAmount);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter.eq(kreskoAssetTotalSupplyBefore.add(mintAmount)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;00ae00a8-69a3-43d6-80ea-e12a03705bda&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow successive, valid mints of the same Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow successive, valid mints of the same Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1272,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Mint Kresko asset\nconst firstMintAmount = (0, _lib.toBig)(50);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _lib.toBig)(50);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, secondMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets is unchanged\nconst mintedKreskoAssetsFinal = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedFinal = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedFinal).to.closeTo(firstMintAmount.add(secondMintAmount), INTEREST_RATE_DELTA);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceFinal).to.closeTo(amountMintedFinal, INTEREST_RATE_DELTA);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyFinal = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyFinal).to.closeTo(kreskoAssetTotalSupplyAfter.add(secondMintAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;439954a6-6b9c-44f5-9efb-fee327ee21ce&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint multiple different Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint multiple different Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:864,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, _lib.toBig)(10);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _lib.toBig)(20);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset2.address, secondMintAmount);\n// Confirm that the second address has been pushed to the array of the user&#x27;s minted Kresko assets\nconst mintedKreskoAssetsFinal = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address,\n    f.KrAsset2.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedAssetTwo = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset2);\n(0, _chai.expect)(amountMintedAssetTwo).to.equal(secondMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset2.balanceOf(user1.address);\n(0, _chai.expect)(userBalanceFinal).to.equal(amountMintedAssetTwo);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst secondKreskoAssetTotalSupply = await f.KrAsset2.contract.totalSupply();\n(0, _chai.expect)(secondKreskoAssetTotalSupply).to.equal(secondMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c6a28c53-78b1-4b33-94c1-fdc30debba73&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:882,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the mint amount&#x27;s USD value is equal to the contract&#x27;s current minimum debt value\nconst mintAmount = (0, _lib.toBig)(1); // 1 * $10 = $10\nconst mintAmountUSDValue = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\nconst currMinimumDebtValue = await hre.Diamond.getMinDebtValue();\n(0, _chai.expect)((0, _lib.fromBig)(mintAmountUSDValue, 8)).to.equal(Number(currMinimumDebtValue) / 10 ** 8);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Confirm that the mint was successful and user&#x27;s balances have increased\nconst finalKreskoAssetDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(finalKreskoAssetDebt).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9fb17ee7-7645-4f52-9ecf-f60410f6d360&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:485,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_testutils.Role.MANAGER, user2.address);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// userThree (trusted contract) mints Kresko asset for userOne\nconst mintAmount = (0, _lib.toBig)(1);\nawait User2.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Check that debt exists now for userOne\nconst userTwoBalanceAfter = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userTwoBalanceAfter).to.equal(mintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79332e67-7b2c-48c8-b2c2-2a061f2badc2&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetMinted event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should emit KreskoAssetMinted event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:386,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await User1.mintKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;KreskoAssetMinted\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3bd33565-cd00-4d23-9ddd-02606cc7f38f&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(User1.mintKreskoAsset(user2.address, f.KrAsset.address, (0, _lib.toBig)(1))).to.be.revertedWith(`AccessControl: account ${user1.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;63c91090-b45c-42b2-9da7-e78baa3bbb50&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:390,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currMinimumDebtValue = await _optimizations.default.getMinDebtValue();\nconst mintAmount = currMinimumDebtValue.div(_testutils.TEN_USD).sub(1);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount)).to.be.revertedWith(_errors.Error.KRASSET_MINT_AMOUNT_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e888f34f-0443-4e26-bb3a-b4ff4e57a630&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:94,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt to mint a non-deployed, non-whitelisted Kresko asset\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, \&quot;0x0000000000000000000000000000000000000002\&quot;, (0, _lib.toBig)(1))).to.be.revertedWith(_errors.Error.KRASSET_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f5bcd4e9-926b-4904-b7bd-ceabbe90f7ee&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:287,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// We can ignore price and collateral factor as both f.Collateral and f.KrAsset both\n// have the same price ($10) and same collateral factor (1)\nconst collateralAmountDeposited = await _optimizations.default.getAccountCollateralAmount(user1.address, f.Collateral.address);\n// Apply 150% MCR and increase deposit amount to be above the maximum allowed by MCR\nconst mcrAmount = (0, _lib.fromBig)(collateralAmountDeposited) / 1.5;\nconst mintAmount = (0, _lib.toBig)(mcrAmount + 1);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount)).to.be.revertedWith(_errors.Error.KRASSET_COLLATERAL_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a7e6e3b8-ee35-4b3d-afb2-9bef35227ed9&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:293,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// User deposits another 10,000 collateral tokens, enabling mints of up to 20,000/1.5 = ~13,333 kresko asset tokens\nawait f.Collateral.setBalance(user1, (0, _lib.toBig)(100000000));\nawait (0, _chai.expect)(User1.depositCollateral(user1.address, f.Collateral.address, (0, _lib.toBig)(10000))).not.to.be.reverted;\nconst krAsset = await hre.Diamond.getKreskoAsset(f.KrAsset.address);\nconst overSupplyLimit = (0, _lib.fromBig)(krAsset.supplyLimit) + 1;\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, (0, _lib.toBig)(overSupplyLimit))).to.be.revertedWith(_errors.Error.KRASSET_MAX_SUPPLY_REACHED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9779bcb6-4ede-41b2-bf30-a9d181bcb915&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;49dfc343-ffde-4ba5-afa0-c7174343afdb&quot;,&quot;parentUUID&quot;:&quot;74c941b4-1061-4051-ad55-2da48a29b2dd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;00ae00a8-69a3-43d6-80ea-e12a03705bda&quot;,&quot;439954a6-6b9c-44f5-9efb-fee327ee21ce&quot;,&quot;c6a28c53-78b1-4b33-94c1-fdc30debba73&quot;,&quot;9fb17ee7-7645-4f52-9ecf-f60410f6d360&quot;,&quot;79332e67-7b2c-48c8-b2c2-2a061f2badc2&quot;,&quot;3bd33565-cd00-4d23-9ddd-02606cc7f38f&quot;,&quot;63c91090-b45c-42b2-9da7-e78baa3bbb50&quot;,&quot;e888f34f-0443-4e26-bb3a-b4ff4e57a630&quot;,&quot;f5bcd4e9-926b-4904-b7bd-ceabbe90f7ee&quot;,&quot;a7e6e3b8-ee35-4b3d-afb2-9bef35227ed9&quot;,&quot;9779bcb6-4ede-41b2-bf30-a9d181bcb915&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;49dfc343-ffde-4ba5-afa0-c7174343afdb&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:5962,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;53268e4e-6fa1-4839-a275-869ae51ab1a5&quot;,&quot;title&quot;:&quot;#mint - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;30f49828-2e08-4e00-989b-e90f450ebb43&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:489,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6cd11a1e-4fac-4984-aaf2-3dd5c94d455f&quot;,&quot;parentUUID&quot;:&quot;30f49828-2e08-4e00-989b-e90f450ebb43&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:491,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5e65d604-1d9c-43b0-b128-563d177fbb16&quot;,&quot;parentUUID&quot;:&quot;30f49828-2e08-4e00-989b-e90f450ebb43&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:698,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e74f0e3a-fa10-431f-89b1-f60d524b668e&quot;,&quot;parentUUID&quot;:&quot;30f49828-2e08-4e00-989b-e90f450ebb43&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:494,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst balanceBefore = await f.KrAsset.balanceOf(user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b5d9e42-1707-4136-9000-2520a4983dbe&quot;,&quot;parentUUID&quot;:&quot;30f49828-2e08-4e00-989b-e90f450ebb43&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6cd11a1e-4fac-4984-aaf2-3dd5c94d455f&quot;,&quot;5e65d604-1d9c-43b0-b128-563d177fbb16&quot;,&quot;e74f0e3a-fa10-431f-89b1-f60d524b668e&quot;,&quot;8b5d9e42-1707-4136-9000-2520a4983dbe&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2172,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;6b5383ce-48e8-41bf-89a3-09097b325cd2&quot;,&quot;title&quot;:&quot;debt values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when mint is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:783,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst valueBeforeRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n// Adjust price accordingly\nconst assetPrice = await f.KrAsset.getPrice();\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPrice.div(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3bcee7a2-c9a5-4928-9d12-6fe4a02a55f0&quot;,&quot;parentUUID&quot;:&quot;6b5383ce-48e8-41bf-89a3-09097b325cd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when mint is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:778,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\nconst valueBeforeRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n// Adjust price accordingly\nconst assetPrice = await f.KrAsset.getPrice();\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPrice.mul(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f7f5d10-ccaa-4ccf-89ce-d294b9863b81&quot;,&quot;parentUUID&quot;:&quot;6b5383ce-48e8-41bf-89a3-09097b325cd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:775,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.mul(denominator);\nconst assetPrice = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\n// Adjust price accordingly\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPrice, 8) / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a97f729-a68c-4432-bcf6-6ad78c8543b5&quot;,&quot;parentUUID&quot;:&quot;6b5383ce-48e8-41bf-89a3-09097b325cd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1012,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.div(denominator);\nconst assetPrice = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\n// Adjust price accordingly\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPrice.mul(denominator), 8));\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(valueAfterRebase).to.bignumber.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4706f93a-1006-48ea-bcf0-8c7673682be5&quot;,&quot;parentUUID&quot;:&quot;6b5383ce-48e8-41bf-89a3-09097b325cd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3bcee7a2-c9a5-4928-9d12-6fe4a02a55f0&quot;,&quot;9f7f5d10-ccaa-4ccf-89ce-d294b9863b81&quot;,&quot;4a97f729-a68c-4432-bcf6-6ad78c8543b5&quot;,&quot;4706f93a-1006-48ea-bcf0-8c7673682be5&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3348,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d0e4270d-f0b1-47a4-b3f2-08248370b470&quot;,&quot;title&quot;:&quot;debt values and amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1861,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetPrice = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintAmountAfterRebase = mintAmount.mul(denominator);\nconst assetPriceRebase = assetPrice.div(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountDebtValue(user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.bignumber.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.bignumber.equal(debtValueAfterFirstMint);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.bignumber.equal(valueBeforeRebase);\n// Mint after rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmountAfterRebase);\n// Ensure debt amounts and balances match\nconst balanceAfterSecondMint = await f.KrAsset.contract.balanceOf(user1.address);\n// Ensure balance matches\nconst expectedBalanceAfterSecondMint = balanceAfterFirstRebase.add(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterSecondMint).to.bignumber.equal(expectedBalanceAfterSecondMint);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterSecondMint, f.KrAsset)).to.bignumber.closeTo(debtValueAfterFirstMint.mul(2), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(valueBeforeRebase.mul(2), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a27dbf5b-7c4f-4cba-a0a9-158ee2eb731e&quot;,&quot;parentUUID&quot;:&quot;d0e4270d-f0b1-47a4-b3f2-08248370b470&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2053,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetPrice = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintAmountAfterRebase = mintAmount.div(denominator);\nconst assetPriceRebase = assetPrice.mul(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\n// Mint before rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountDebtValue(user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.bignumber.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nf.KrAsset.setPrice((0, _lib.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(debtValueAfterFirstRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint, f.KrAsset));\n(0, _chai.expect)(debtValueAfterFirstRebase).to.bignumber.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, f.KrAsset));\n// Mint after rebase\nawait User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmountAfterRebase);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountDebtValue(user1.address);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.bignumber.closeTo(await (0, _calculations.toScaledAmount)(valueBeforeRebase.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71cdea2f-eb98-4596-88d2-5cbd240bb9f5&quot;,&quot;parentUUID&quot;:&quot;d0e4270d-f0b1-47a4-b3f2-08248370b470&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a27dbf5b-7c4f-4cba-a0a9-158ee2eb731e&quot;,&quot;71cdea2f-eb98-4596-88d2-5cbd240bb9f5&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3914,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:609,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User1.mintKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a291b959-8e9f-479d-a964-1635f9b8b2d8&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to burn some of their Kresko asset balances&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn some of their Kresko asset balances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:390,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _lib.toBig)(1);\nconst kreskoAssetIndex = 0;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user no long holds the burned Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userBalance).to.equal(f.initialMintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userDebt).to.closeTo(f.initialMintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51a919ee-9160-4d4c-b959-1bdb1c366634&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn their full balance of a Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn their full balance of a Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;147c6b09-201c-4be8-85c1-d5c45dc47939&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:491,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_testutils.Role.MANAGER, user2.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _lib.toBig)(1);\nconst kreskoAssetIndex = 0;\nconst userOneBalanceBefore = await f.KrAsset.balanceOf(user1.address);\n// User three burns it&#x27;s KreskoAsset to reduce userOnes debt\nawait (0, _chai.expect)(User2.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;\n// Confirm the userOne had no effect on it&#x27;s kreskoAsset balance\nconst userOneBalance = await f.KrAsset.balanceOf(user1.address);\n(0, _chai.expect)(userOneBalance).to.equal(userOneBalanceBefore, \&quot;userOneBalance\&quot;);\n// Confirm the userThree no long holds the burned Kresko asset amount\nconst userThreeBalance = await f.KrAsset.balanceOf(user2.address);\n(0, _chai.expect)(userThreeBalance).to.equal(f.initialMintAmount.sub(burnAmount), \&quot;userThreeBalance\&quot;);\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount), \&quot;totalSupplyAfter\&quot;);\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user2.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n], \&quot;mintedKreskoAssetsAfter\&quot;);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebt).to.equal(f.initialMintAmount.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6dd648fb-e29e-4fc0-978d-69dd7f39846b&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;beccd2f0-49af-451c-93e6-3d0c70498316&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:395,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalanceBefore = await f.KrAsset.balanceOf(user1.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Calculate actual burn amount\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst minDebtValue = (0, _lib.fromBig)(await _optimizations.default.getMinDebtValue(), 8);\nconst oraclePrice = f.KrAsset.deployArgs.price;\nconst burnAmount = (0, _lib.toBig)((0, _lib.fromBig)(userOneDebt) - minDebtValue / oraclePrice);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user holds the expected Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(user1.address);\n// expect(fromBig(userBalance)).to.equal(fromBig(userBalanceBefore.sub(burnAmount)));\n(0, _chai.expect)(userBalance).eq(userBalanceBefore.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).eq(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst newUserDebt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\n(0, _chai.expect)(newUserDebt).to.be.equal(userOneDebt.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;917e3189-5f49-44a2-b3bf-21dc8f0c73f8&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetBurned event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should emit KreskoAssetBurned event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:391,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst tx = await User1.burnKreskoAsset(user1.address, f.KrAsset.address, f.initialMintAmount.div(5), kreskoAssetIndex);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;KreskoAssetBurned\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount.div(5));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8712b62-ac48-4c6d-8294-f88685579631&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1091,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const secondMintAmount = 1;\nconst burnAmount = f.initialMintAmount.add(secondMintAmount);\nawait (0, _chai.expect)(User1.mintKreskoAsset(user1.address, f.KrAsset.address, secondMintAmount)).to.not.be.reverted;\nconst kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b9898e6d-286d-4d3c-93f5-8248f8779309&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:94,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, 0, kreskoAssetIndex)).to.be.revertedWith(_errors.Error.ZERO_BURN);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e02ab52e-f1eb-4181-a823-d51e61f14116&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:104,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(User2.burnKreskoAsset(user1.address, f.KrAsset.address, 100, kreskoAssetIndex)).to.be.revertedWith(`AccessControl: account ${user2.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5644aecb-8a08-4f5d-ab96-45176960d826&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:96,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst debt = await _optimizations.default.getAccountDebtAmount(user1.address, f.KrAsset);\nconst burnAmount = debt.add((0, _lib.toBig)(1));\nawait (0, _chai.expect)(User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;333a923c-0d79-4fbc-ae52-83e3a24f5598&quot;,&quot;parentUUID&quot;:&quot;5f3f479b-adaf-4aca-bccc-646b403803a8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b2e4fddb-6dcd-4118-ab64-a2324072a6b1&quot;,&quot;title&quot;:&quot;Protocol open fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol open fee should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1419,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const openFee = 0.01;\nconst openFeeBig = (0, _lib.toBig)(openFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nawait f.KrAsset.update({\n    ..._testutils.defaultKrAssetArgs,\n    openFee\n});\nconst mintAmount = (0, _lib.toBig)(1);\nconst mintValue = mintAmount.mul(_testutils.TEN_USD);\nconst expectedFeeValue = mintValue.mul(openFeeBig);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(_testutils.TEN_USD);\n// Get the balances prior to the fee being charged.\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Mint Kresko asset\nconst tx = await User1.mintKreskoAsset(user1.address, f.KrAsset.address, mintAmount);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, _lib.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;OpenFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, _lib.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);\n// Now verify that calcExpectedFee function returns accurate fee amount\nconst feeRes = await hre.Diamond.previewFee(user1.address, f.KrAsset.address, mintAmount, _testutils.Fee.OPEN);\nconst output = feeRes.toString().split(\&quot;,\&quot;);\nconst openFeeAmount = Number(output[1]) / 10 ** 18;\n(0, _chai.expect)(openFeeAmount).eq(normalizedExpectedCollateralFeeAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7af8a69c-1381-4f49-bf1d-1550a564bfac&quot;,&quot;parentUUID&quot;:&quot;b2e4fddb-6dcd-4118-ab64-a2324072a6b1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7af8a69c-1381-4f49-bf1d-1550a564bfac&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1419,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;03500773-8078-4ccc-b764-11d135aa4aaa&quot;,&quot;title&quot;:&quot;Protocol Close Fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:488,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const burnAmount = (0, _lib.toBig)(1);\nconst burnValue = burnAmount.mul(_testutils.TEN_USD);\nconst closeFee = (0, _lib.toBig)(f.KrAsset.deployArgs.closeFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nconst expectedFeeValue = burnValue.mul(closeFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(f.Collateral.deployArgs.price);\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nconst tx = await User1.burnKreskoAsset(user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, _lib.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.account).to.equal(user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal((0, _lib.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, _lib.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc38db7a-49a1-42fd-a4b2-b5e85c7feace&quot;,&quot;parentUUID&quot;:&quot;03500773-8078-4ccc-b764-11d135aa4aaa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1261,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = (0, _lib.toBig)(burnAmount * f.KrAsset.deployArgs.closeFee);\nconst expectedFeeValue = (0, _lib.toBig)(burnAmount * _testutils.TEN_USD * f.KrAsset.deployArgs.closeFee, 8);\nconst event = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: (0, _lib.toBig)(burnAmount)\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = true;\nf.KrAsset.setPrice(_testutils.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount * denominator;\nawait (0, _collaterals.withdrawCollateral)({\n    user: user2,\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(wAmount)\n});\nconst eventAfterRebase = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: (0, _lib.toBig)(burnAmountRebase)\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca427e64-0692-4338-8b0a-264a70af5e42&quot;,&quot;parentUUID&quot;:&quot;03500773-8078-4ccc-b764-11d135aa4aaa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1263,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = (0, _lib.toBig)(burnAmount * f.KrAsset.deployArgs.closeFee);\nconst expectedFeeValue = (0, _lib.toBig)(burnAmount * _testutils.TEN_USD * f.KrAsset.deployArgs.closeFee, 8);\nconst event = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: (0, _lib.toBig)(burnAmount)\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = false;\nconst priceAfter = (0, _lib.fromBig)(await f.KrAsset.getPrice(), 8) * denominator;\nf.KrAsset.setPrice(priceAfter);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount / denominator;\nawait (0, _collaterals.withdrawCollateral)({\n    user: user2,\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(wAmount)\n});\nconst eventAfterRebase = await (0, _lib.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: user2,\n    asset: f.KrAsset,\n    amount: (0, _lib.toBig)(burnAmountRebase)\n}), hre.Diamond, \&quot;CloseFeePaid\&quot;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;132227c3-f6db-46f0-9aed-9e2b7c600c88&quot;,&quot;parentUUID&quot;:&quot;03500773-8078-4ccc-b764-11d135aa4aaa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;bc38db7a-49a1-42fd-a4b2-b5e85c7feace&quot;,&quot;ca427e64-0692-4338-8b0a-264a70af5e42&quot;,&quot;132227c3-f6db-46f0-9aed-9e2b7c600c88&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3012,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;51a919ee-9160-4d4c-b959-1bdb1c366634&quot;,&quot;6dd648fb-e29e-4fc0-978d-69dd7f39846b&quot;,&quot;917e3189-5f49-44a2-b3bf-21dc8f0c73f8&quot;,&quot;c8712b62-ac48-4c6d-8294-f88685579631&quot;,&quot;b9898e6d-286d-4d3c-93f5-8248f8779309&quot;,&quot;e02ab52e-f1eb-4181-a823-d51e61f14116&quot;,&quot;5644aecb-8a08-4f5d-ab96-45176960d826&quot;,&quot;333a923c-0d79-4fbc-ae52-83e3a24f5598&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;147c6b09-201c-4be8-85c1-d5c45dc47939&quot;,&quot;beccd2f0-49af-451c-93e6-3d0c70498316&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:3052,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;7bdbbcf2-b103-4e7e-a35e-3cf504e2af86&quot;,&quot;title&quot;:&quot;#burn - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase \&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:415,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _krassets.mintKrAsset)({\n    asset: f.KrAsset,\n    amount: mintAmount,\n    user: user1\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;05b4817c-862d-4f88-8876-f93aa49fccd8&quot;,&quot;parentUUID&quot;:&quot;7bdbbcf2-b103-4e7e-a35e-3cf504e2af86&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0a0009e7-4af6-4ba6-81a0-df7b3980c115&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:807,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(0);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(0);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(f.initialMintAmount); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c5f87a8e-3f13-429d-9259-7ebe11bd06b7&quot;,&quot;parentUUID&quot;:&quot;0a0009e7-4af6-4ba6-81a0-df7b3980c115&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:598,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).mul(denominator);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.mul(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.div(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cf26cbc5-b47d-4f96-a97a-f85401a1bf2d&quot;,&quot;parentUUID&quot;:&quot;0a0009e7-4af6-4ba6-81a0-df7b3980c115&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:598,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = 0;\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = (0, _lib.fromBig)(await f.KrAsset.contract.balanceOf(user1.address));\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal((0, _lib.toBig)(expectedBalanceAfterBurn * denominator).add(f.initialMintAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5d414e06-d177-4d9d-8fc1-562a1b592d07&quot;,&quot;parentUUID&quot;:&quot;0a0009e7-4af6-4ba6-81a0-df7b3980c115&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:803,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).div(denominator);\n(0, _chai.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.div(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.mul(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dea3c6e4-19ba-45eb-b086-14802d3f5d4d&quot;,&quot;parentUUID&quot;:&quot;0a0009e7-4af6-4ba6-81a0-df7b3980c115&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c5f87a8e-3f13-429d-9259-7ebe11bd06b7&quot;,&quot;cf26cbc5-b47d-4f96-a97a-f85401a1bf2d&quot;,&quot;5d414e06-d177-4d9d-8fc1-562a1b592d07&quot;,&quot;dea3c6e4-19ba-45eb-b086-14802d3f5d4d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2806,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;9c44a6c8-47e3-4046-8a5a-e139be7add0b&quot;,&quot;title&quot;:&quot;debt value and mintedKreskoAssets book-keeping is calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:680,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst fullRepayAmount = mintAmount.mul(denominator);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, debtAfter, false);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;85e305cf-7540-4b8c-bad5-cc0a7f251d48&quot;,&quot;parentUUID&quot;:&quot;9c44a6c8-47e3-4046-8a5a-e139be7add0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1189,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintValue = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Should contain minted krAsset\nconst mintedKreskoAssetsBeforeBurn = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBeforeBurn).to.contain(f.KrAsset.address);\n// Burn assets\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, debtAfter, false);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _optimizations.default.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5afe4194-5047-4578-bf56-dad52b627189&quot;,&quot;parentUUID&quot;:&quot;9c44a6c8-47e3-4046-8a5a-e139be7add0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:678,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst fullRepayAmount = mintAmount.div(denominator);\n// Adjust price according to rebase params\nf.KrAsset.setPrice(_testutils.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, debtAfter, false);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;50a25057-008b-4849-b597-0e86b2bd8ba7&quot;,&quot;parentUUID&quot;:&quot;9c44a6c8-47e3-4046-8a5a-e139be7add0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1282,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintValue = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, mintAmount, false);\nf.KrAsset.setPrice(_testutils.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _lib.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nawait User1.burnKreskoAsset(user1.address, f.KrAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getDebtAmountToValue(f.KrAsset.address, debtAfter, false);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hre.Diamond.getAccountMintedAssets(user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;93761c66-e9f3-4f2d-9cad-d29ad378430c&quot;,&quot;parentUUID&quot;:&quot;9c44a6c8-47e3-4046-8a5a-e139be7add0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;85e305cf-7540-4b8c-bad5-cc0a7f251d48&quot;,&quot;5afe4194-5047-4578-bf56-dad52b627189&quot;,&quot;50a25057-008b-4849-b597-0e86b2bd8ba7&quot;,&quot;93761c66-e9f3-4f2d-9cad-d29ad378430c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3829,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;429f3c05-e6b6-4c69-b629-a26d09cbe9a2&quot;,&quot;title&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw \&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _testutils.defaultFixture)();\n[, , [user]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;10005070-d36b-42c5-81e2-15fcc88ae632&quot;,&quot;parentUUID&quot;:&quot;429f3c05-e6b6-4c69-b629-a26d09cbe9a2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;94ee86d5-78ef-4ca9-8e2a-24e6b0df402a&quot;,&quot;title&quot;:&quot;#unchecked-collateral-withdrawal&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;title&quot;:&quot;#unchecked-withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;withdraw correct amount&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw withdraw correct amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:400,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawalAmount = 42069;\nawait (0, _chai.expect)(f.Receiver.testWithdrawalAmount(f.Collateral.address, withdrawalAmount)).to.not.be.revertedWith(\&quot;wront amount received\&quot;);\n(0, _chai.expect)(await f.Collateral.balanceOf(f.Receiver.address)).to.equal(withdrawalAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;31b4a0f0-0a25-48d2-8534-be48fe5ab444&quot;,&quot;parentUUID&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should send correct values to the callback&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should send correct values to the callback&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:851,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst balKreskoBefore = await f.Collateral.contract.balanceOf(hre.Diamond.address);\nawait Receiver.test(f.Collateral.address, 1);\n(0, _chai.expect)(await Receiver.collateralAsset()).to.equal(f.Collateral.address);\n(0, _chai.expect)(await Receiver.account()).to.equal(user.address);\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(1);\nconst balKreskoAfter = await f.Collateral.contract.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore.sub(balKreskoAfter)).to.equal(1);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0975100-4416-4a18-bdf4-3f94ea64a132&quot;,&quot;parentUUID&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw collateral up to MRC without returning it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw collateral up to MRC without returning it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1852,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount  } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait Receiver.test(f.Collateral.address, maxWithdrawAmount);\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(user.address)).to.be.closeTo(15e17.toString(), 1e10.toString());\nawait (0, _chai.expect)(Receiver.test(f.Collateral.address, 10e15.toString())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;054c9b8e-1bbe-473d-bfdd-1598dec11407&quot;,&quot;parentUUID&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and return it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and return it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:586,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\nconst balKreskoBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nawait Receiver.testRedeposit(f.Collateral.address, deposits);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(deposits);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(deposits);\n(0, _chai.expect)(await f.Collateral.balanceOf(Receiver.address)).to.equal(0);\nconst balKreskoAfter = await f.Collateral.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore).to.equal(balKreskoAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ec77a380-2ab7-474d-80d2-e49d7dacbb8d&quot;,&quot;parentUUID&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:413,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\n// set second collateral price to half of the first and balance to twice that\nf.Collateral2.setPrice(10);\nawait f.Collateral2.setBalance(user, f.depositAmount);\nawait f.Collateral2.contract.setVariable(\&quot;_allowances\&quot;, {\n    [user.address]: {\n        [hre.Diamond.address]: f.depositAmount,\n        [Receiver.address]: f.depositAmount\n    }\n});\nawait Receiver.testDepositAlternate(f.Collateral.address, deposits, f.Collateral2.address);\nconst secondCollateralDeposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral2.address);\n(0, _chai.expect)(secondCollateralDeposits.eq(deposits)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5f3f06c5-3d3d-443b-88a0-a603755b0c71&quot;,&quot;parentUUID&quot;:&quot;d832a8c6-efe2-4198-8a83-1c4938de66cb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;31b4a0f0-0a25-48d2-8534-be48fe5ab444&quot;,&quot;b0975100-4416-4a18-bdf4-3f94ea64a132&quot;,&quot;054c9b8e-1bbe-473d-bfdd-1598dec11407&quot;,&quot;ec77a380-2ab7-474d-80d2-e49d7dacbb8d&quot;,&quot;5f3f06c5-3d3d-443b-88a0-a603755b0c71&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4102,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;09dd9e6f-a97d-4433-a0ce-23606a1f651e&quot;,&quot;title&quot;:&quot;#unchecked-withdraw-reverts&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert on zero withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert on zero withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:110,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 0)).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 0)).to.be.revertedWith(Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e5480433-36e0-4cda-8629-9860d27b5918&quot;,&quot;parentUUID&quot;:&quot;09dd9e6f-a97d-4433-a0ce-23606a1f651e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert with no manager role&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert with no manager role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:223,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.revokeRole(_testutils.Role.MANAGER, f.Receiver.address);\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 10000)).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 10000)).to.be.revertedWith(\n            //     `AccessControl: account ${f.Receiver.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`,\n            // );&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;75a6cae1-61bb-466c-a503-220826fe7d1a&quot;,&quot;parentUUID&quot;:&quot;09dd9e6f-a97d-4433-a0ce-23606a1f651e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:883,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { maxWithdrawAmount  } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()))).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1d21cb94-30b1-4a4a-9ced-d0803343d3d9&quot;,&quot;parentUUID&quot;:&quot;09dd9e6f-a97d-4433-a0ce-23606a1f651e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after redeposit&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after redeposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:896,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount  } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(Receiver.testInsufficientRedeposit(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()))).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b24eb23-8a1c-46a4-a9c5-2397ac184050&quot;,&quot;parentUUID&quot;:&quot;09dd9e6f-a97d-4433-a0ce-23606a1f651e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e5480433-36e0-4cda-8629-9860d27b5918&quot;,&quot;75a6cae1-61bb-466c-a503-220826fe7d1a&quot;,&quot;1d21cb94-30b1-4a4a-9ced-d0803343d3d9&quot;,&quot;0b24eb23-8a1c-46a4-a9c5-2397ac184050&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2112,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;45bac1e1-345d-46ac-900f-84b6bd0057b9&quot;,&quot;title&quot;:&quot;Gating&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/minter/06-gating.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/06-gating.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;fullTitle&quot;:&quot;Gating \&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:233,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.defaultFixture)();\n// Set Gating phase to 3\nawait hre.Diamond.updatePhase(2);\n// setup collateral for userOne and userTwo\nthis.initialBalance = (0, _lib.toBig)(100000);\nawait f.Collateral.setBalance(hre.users.userOne, this.initialBalance, hre.Diamond.address);\nawait f.Collateral.setBalance(hre.users.userTwo, this.initialBalance, hre.Diamond.address);\nthis.depositArgsOne = {\n    user: hre.users.userOne,\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(10000)\n};\nthis.depositArgsTwo = {\n    user: hre.users.userTwo,\n    asset: f.Collateral,\n    amount: (0, _lib.toBig)(10000)\n};\n// Deploy nft contract\n[this.nft] = await hre.deploy(\&quot;MockERC1155\&quot;, {\n    args: [],\n    from: hre.users.deployer.address\n});\nawait hre.Diamond.updateKreskian(this.nft.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;35e204b5-d06f-4554-899b-1ad48df86e94&quot;,&quot;parentUUID&quot;:&quot;45bac1e1-345d-46ac-900f-84b6bd0057b9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not allow to deposit collateral if the user doesn&#x27;t have required nft&#x27;s&quot;,&quot;fullTitle&quot;:&quot;Gating should not allow to deposit collateral if the user doesn&#x27;t have required nft&#x27;s&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:127,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.revertedWith(_test.Error.MISSING_PHASE_3_NFT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b065bfa8-a3bb-4ae5-99fd-8714810303a5&quot;,&quot;parentUUID&quot;:&quot;45bac1e1-345d-46ac-900f-84b6bd0057b9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow to deposit collateral if the user has the required nft&#x27;s&quot;,&quot;fullTitle&quot;:&quot;Gating should allow to deposit collateral if the user has the required nft&#x27;s&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:140,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.nft.safeTransferFrom(hre.users.deployer.address, this.depositArgsOne.user.address, 0, 1, \&quot;0x00\&quot;);\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0501343f-50f3-468f-9a5f-ae6dea635525&quot;,&quot;parentUUID&quot;:&quot;45bac1e1-345d-46ac-900f-84b6bd0057b9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;After all the phases anyone should be able to deposit collateral&quot;,&quot;fullTitle&quot;:&quot;Gating After all the phases anyone should be able to deposit collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:228,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.updatePhase(3);\n// Anyone should be able to deposit collateral\nawait (0, _chai.expect)((0, _test.wrapContractWithSigner)(hre.Diamond, this.depositArgsTwo.user).depositCollateral(this.depositArgsTwo.user.address, f.Collateral.address, this.depositArgsTwo.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;40e47a78-3143-4ece-a8eb-c34d4a23dd87&quot;,&quot;parentUUID&quot;:&quot;45bac1e1-345d-46ac-900f-84b6bd0057b9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b065bfa8-a3bb-4ae5-99fd-8714810303a5&quot;,&quot;0501343f-50f3-468f-9a5f-ae6dea635525&quot;,&quot;40e47a78-3143-4ece-a8eb-c34d4a23dd87&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:495,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;1c15d1ef-b2d4-4466-9452-ce05e04eb142&quot;,&quot;title&quot;:&quot;Oracles&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracles \&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.defaultFixture)();\n// Deploy one price feed\n[, [user]] = f.users;\nthis.deployer = await hre.ethers.getNamedSigner(\&quot;deployer\&quot;);\nthis.userOne = await hre.ethers.getNamedSigner(\&quot;userOne\&quot;);\nmockSequencerUptimeFeed = await (await hre.ethers.getContractFactory(\&quot;MockSequencerUptimeFeed\&quot;)).deploy();\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;97cc1509-4deb-4c98-96ed-bf5952328be2&quot;,&quot;parentUUID&quot;:&quot;1c15d1ef-b2d4-4466-9452-ce05e04eb142&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;title&quot;:&quot;Redstone&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have correct setup&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should have correct setup&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:193,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// check initial conditions\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralValue(user.address)).to.equal((0, _lib.toBig)(10000, 8), \&quot;collateral value should be $10\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;47ce2b35-6254-4df8-9f12-b38fc54029f5&quot;,&quot;parentUUID&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get redstone price when chainlink price = 0&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should get redstone price when chainlink price = 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:116,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 0\nf.Collateral.setPrice(0);\nconst redstoneCollateralPrice = 20;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _test.defaultCollateralArgs.redstoneId,\n        value: redstoneCollateralPrice\n    }\n]);\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(user.address)).to.equal(f.depositAmount.wadMul((0, _lib.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $20\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1dafae24-98e8-48b2-a42b-922572aec9bd&quot;,&quot;parentUUID&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get primary price when price +- oracleDeviationPct of reference price &quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should get primary price when price +- oracleDeviationPct of reference price &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:218,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setOracleOrder([\n    _oracles.OracleType.Redstone,\n    _oracles.OracleType.Chainlink\n]);\n/// set chainlink price to 12\nf.Collateral.setPrice(12);\n/// set redstone price to 11\nconst redstoneCollateralPrice = 11;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _test.defaultCollateralArgs.redstoneId,\n        value: redstoneCollateralPrice\n    }\n]);\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(user.address)).to.equal(f.depositAmount.wadMul((0, _lib.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $11\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e9941b1-9e4e-4cb2-8d35-b9260119ad85&quot;,&quot;parentUUID&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if price deviates too much&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should revert if price deviates too much&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:344,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 20\nf.Collateral.setPrice(20);\nconst redstoneCollateralPrice = 10;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _test.defaultCollateralArgs.redstoneId,\n        value: redstoneCollateralPrice\n    }\n]);\n// should revert if price deviates more than oracleDeviationPct\nawait (0, _chai.expect)(redstoneDiamond.getAccountCollateralValue(user.address)).to.be.revertedWith(_test.Error.ORACLE_PRICE_UNSTABLE);\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6ceb4e91-5dae-4490-8a32-30ea8ac43b22&quot;,&quot;parentUUID&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return redstone price if sequencer is down&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should return redstone price if sequencer is down&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:226,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 5\nf.Collateral.setPrice(5);\nconst redstoneCollateralPrice = 200;\nconst redstoneDiamond = (0, _redstone.wrapPrices)(hre.Diamond, [\n    {\n        dataFeedId: _test.defaultCollateralArgs.redstoneId,\n        value: redstoneCollateralPrice\n    }\n]);\n/// set sequencer uptime feed address\nawait redstoneDiamond.updateSequencerUptimeFeed(mockSequencerUptimeFeed.address);\n// should return redstone price if sequencer is down\n(0, _chai.expect)(await redstoneDiamond.getAccountCollateralValue(user.address)).to.be.equal(f.depositAmount.wadMul((0, _lib.toBig)(redstoneCollateralPrice, 8)), \&quot;collateral value should be $200\&quot;);\nf.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1c5a2747-4ddc-4826-8bc0-8d781c7a088c&quot;,&quot;parentUUID&quot;:&quot;6f8c32bb-2688-46b6-8c97-0afff7087430&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;47ce2b35-6254-4df8-9f12-b38fc54029f5&quot;,&quot;1dafae24-98e8-48b2-a42b-922572aec9bd&quot;,&quot;6e9941b1-9e4e-4cb2-8d35-b9260119ad85&quot;,&quot;6ceb4e91-5dae-4490-8a32-30ea8ac43b22&quot;,&quot;1c5a2747-4ddc-4826-8bc0-8d781c7a088c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1097,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;7619e43d-bdae-47e8-962f-0e1d37436c4f&quot;,&quot;title&quot;:&quot;Safety Council&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _testutils.defaultFixture)();\n// These are the 5 signers on the SafetyCouncil multisig\nconst { deployer , devTwo , extOne , extTwo , devOne  } = await hre.ethers.getNamedSigners();\nthis.deployer = deployer;\nthis.devOne = devOne;\nthis.devTwo = devTwo;\nthis.extOne = extOne;\nthis.extTwo = extTwo;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;22fd0070-564d-429e-93b9-cfd8c1ab0007&quot;,&quot;parentUUID&quot;:&quot;7619e43d-bdae-47e8-962f-0e1d37436c4f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;50c00de2-2dc4-44fa-8c8a-3c4f8241a159&quot;,&quot;title&quot;:&quot;#setSafetyStateSet&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;correctly sets the safety state&quot;,&quot;fullTitle&quot;:&quot;Safety Council #setSafetyStateSet correctly sets the safety state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:224,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const beforeSafetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(beforeSafetyState).to.equal(false);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;setSafetyStateSet\&quot;, [\n    true\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst safetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(safetyState).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6227cb64-7769-49e6-82e3-f148ca9a292f&quot;,&quot;parentUUID&quot;:&quot;50c00de2-2dc4-44fa-8c8a-3c4f8241a159&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6227cb64-7769-49e6-82e3-f148ca9a292f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:224,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f7c43863-3fa1-431c-b103-ca6e3690ee47&quot;,&quot;title&quot;:&quot;#toggleAssetsPaused&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1f22d231-6d19-4d06-bf9b-e9cf4e9dbf6f&quot;,&quot;title&quot;:&quot;multisig signature threshold&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;multisig transacts successfully with majority of signers (3/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with majority of signers (3/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:128,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b326cfa6-a35b-45fa-94e7-d8084c64029b&quot;,&quot;parentUUID&quot;:&quot;1f22d231-6d19-4d06-bf9b-e9cf4e9dbf6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:357,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;38d35c1c-8516-48f5-9a41-b4e83dca0a6b&quot;,&quot;parentUUID&quot;:&quot;1f22d231-6d19-4d06-bf9b-e9cf4e9dbf6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with all signers (5/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with all signers (5/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:138,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.devTwo,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;40a543a3-b472-4f09-a6c6-b10e189a7092&quot;,&quot;parentUUID&quot;:&quot;1f22d231-6d19-4d06-bf9b-e9cf4e9dbf6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:115,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b98ed1e7-be12-4b4f-8ad5-dc433aaf970a&quot;,&quot;parentUUID&quot;:&quot;1f22d231-6d19-4d06-bf9b-e9cf4e9dbf6f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b326cfa6-a35b-45fa-94e7-d8084c64029b&quot;,&quot;38d35c1c-8516-48f5-9a41-b4e83dca0a6b&quot;,&quot;40a543a3-b472-4f09-a6c6-b10e189a7092&quot;,&quot;b98ed1e7-be12-4b4f-8ad5-dc433aaf970a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:738,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5bf71be0-1112-41b0-b263-28114410a3e5&quot;,&quot;title&quot;:&quot;toggle actions only for listed assets&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle actions for listed collateral assets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ebe760d-2466-4004-99b6-0960455eafe9&quot;,&quot;parentUUID&quot;:&quot;5bf71be0-1112-41b0-b263-28114410a3e5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle actions for listed krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.KrAsset.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), f.KrAsset.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a2d8a48f-7560-45e3-8580-815338b2d918&quot;,&quot;parentUUID&quot;:&quot;5bf71be0-1112-41b0-b263-28114410a3e5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomAddr = hre.ethers.utils.computeAddress(\&quot;0xb976778317b23a1285ec2d483eda6904d9319135b89f1d8eee9f6d2593e2665d\&quot;);\nawait (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        randomAddr\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), randomAddr);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca7dc833-d274-4dfc-97d4-3e51e5b341a7&quot;,&quot;parentUUID&quot;:&quot;5bf71be0-1112-41b0-b263-28114410a3e5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2ebe760d-2466-4004-99b6-0960455eafe9&quot;,&quot;a2d8a48f-7560-45e3-8580-815338b2d918&quot;,&quot;ca7dc833-d274-4dfc-97d4-3e51e5b341a7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:369,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5ec2e5e0-2952-45e4-944d-3b6c229dcbf5&quot;,&quot;title&quot;:&quot;duration based pausing&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can optionally set a timeout on a given pause command&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing can optionally set a timeout on a given pause command&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:338,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000000;\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst depositSafetyState = await hre.Diamond.safetyStateFor(f.Collateral.address, _testutils.Action.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9415ba84-d208-4a79-b393-253c469ab0d4&quot;,&quot;parentUUID&quot;:&quot;5ec2e5e0-2952-45e4-944d-3b6c229dcbf5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;duration based pause functionality should expire after the duration has passed&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing duration based pause functionality should expire after the duration has passed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:139,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000;\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst depositSafetyState = await hre.Diamond.safetyStateFor(f.Collateral.address, _testutils.Action.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);\n// Confirm that the current blocktime is within the pause action&#x27;s duration\nconst blockNumBefore = await hre.ethers.provider.getBlockNumber();\nconst blockBefore = await hre.ethers.provider.getBlock(blockNumBefore);\nconst timestampBefore = blockBefore.timestamp;\n(0, _chai.expect)(Number(depositSafetyState[0].timestamp1)).to.be.greaterThan(timestampBefore);\n// Increase time by seven days\nconst sevenDays = 7 * 24 * 60 * 60;\nawait hre.ethers.provider.send(\&quot;evm_increaseTime\&quot;, [\n    sevenDays\n]);\nawait hre.ethers.provider.send(\&quot;evm_mine\&quot;, []);\n// Confirm that block time has increased as expected\nconst blockNumAfter = await hre.ethers.provider.getBlockNumber();\nconst blockAfter = await hre.ethers.provider.getBlock(blockNumAfter);\nconst timestampAfter = blockAfter.timestamp;\n(0, _chai.expect)(blockNumAfter).to.be.equal(blockNumBefore + 1);\n(0, _chai.expect)(timestampAfter).to.be.equal(timestampBefore + sevenDays);\n// Confirm that the current blocktime is after the pause action&#x27;s duration\n(0, _chai.expect)(timestampAfter).to.be.greaterThan(Number(depositSafetyState[0].timestamp1));\n            // NOTE: now we can test any functionality that should have now expired&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;AssertionError: expected 1696197146 to equal 1696197145&quot;,&quot;estack&quot;:&quot;AssertionError: expected 1696197146 to equal 1696197145\n    at Proxy.assertEqual (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/core/assertions.js:1038:12)\n    at Proxy.methodWrapper (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/addMethod.js:57:25)\n    at Proxy.&lt;anonymous&gt; (node_modules/.pnpm/chai-bn@0.3.1_chai@4.3.7/node_modules/chai-bn/chai-bn.js:49:31)\n    at Proxy.overwritingMethodWrapper (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)\n    at Proxy.&lt;anonymous&gt; (node_modules/.pnpm/@ethereum-waffle+chai@3.4.4/node_modules/@ethereum-waffle/chai/dist/cjs/matchers/bigNumber.js:36:20)\n    at Proxy.overwritingMethodWrapper (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)\n    at doAsserterAsyncAndAddThen (node_modules/.pnpm/chai-as-promised@7.1.1_chai@4.3.7/node_modules/chai-as-promised/lib/chai-as-promised.js:289:22)\n    at Proxy.&lt;anonymous&gt; (node_modules/.pnpm/chai-as-promised@7.1.1_chai@4.3.7/node_modules/chai-as-promised/lib/chai-as-promised.js:255:20)\n    at Proxy.equal (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)\n    at Context.&lt;anonymous&gt; (src/test/safety/00-council.ts:198:46)&quot;,&quot;diff&quot;:&quot;- 1696197146\n+ 1696197145\n&quot;},&quot;uuid&quot;:&quot;ffecdcf5-07e8-4892-9e30-8c8e27bfa680&quot;,&quot;parentUUID&quot;:&quot;5ec2e5e0-2952-45e4-944d-3b6c229dcbf5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9415ba84-d208-4a79-b393-253c469ab0d4&quot;],&quot;failures&quot;:[&quot;ffecdcf5-07e8-4892-9e30-8c8e27bfa680&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:477,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;title&quot;:&quot;toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle action DEPOSIT pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action DEPOSIT pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:247,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_testutils.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;98c1ef3d-c5ee-46d0-9869-8ee1d9c73a65&quot;,&quot;parentUUID&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action WITHDRAW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action WITHDRAW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:242,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_testutils.Action.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f73e8aae-6e75-474a-b129-6adadf3a8fc1&quot;,&quot;parentUUID&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action REPAY pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action REPAY pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:240,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_testutils.Action.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;509c6a2a-3257-4de2-be78-4aa88ff0a09c&quot;,&quot;parentUUID&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action BORROW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action BORROW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:242,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_testutils.Action.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02081e6d-6f84-455b-bac8-9a2b2e04c9ed&quot;,&quot;parentUUID&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action LIQUIDATION pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action LIQUIDATION pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:238,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_testutils.Action.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_testutils.Action.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d5956480-a565-43b0-b00f-13bbf91f4a36&quot;,&quot;parentUUID&quot;:&quot;cb635ae6-4b7a-4502-a58e-affaa4373e1b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;98c1ef3d-c5ee-46d0-9869-8ee1d9c73a65&quot;,&quot;f73e8aae-6e75-474a-b129-6adadf3a8fc1&quot;,&quot;509c6a2a-3257-4de2-be78-4aa88ff0a09c&quot;,&quot;02081e6d-6f84-455b-bac8-9a2b2e04c9ed&quot;,&quot;d5956480-a565-43b0-b00f-13bbf91f4a36&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1209,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;03714247-282f-44a3-a9e6-e870f7fad662&quot;,&quot;title&quot;:&quot;event emission&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused event emission should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, \&quot;toggleAssetsPaused\&quot;, [\n    [\n        f.Collateral.address\n    ],\n    _testutils.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devTwo,\n    this.extOne\n]);\nconst event = await (0, _lib.getInternalEvent)(tx, hre.Diamond, \&quot;SafetyStateChange\&quot;);\n(0, _chai.expect)(event.action).to.equal(_testutils.Action.DEPOSIT);\n(0, _chai.expect)(event.asset).to.equal(f.Collateral.address);\n// @ts-ignore\n(0, _chai.expect)(event.description.hash).to.equal(hre.ethers.utils.keccak256(hre.ethers.utils.toUtf8Bytes(\&quot;paused\&quot;)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6c21c8e0-7773-4d48-b3ca-3c1b656ab8df&quot;,&quot;parentUUID&quot;:&quot;03714247-282f-44a3-a9e6-e870f7fad662&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6c21c8e0-7773-4d48-b3ca-3c1b656ab8df&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:24,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;9d4efad5-7b2b-438a-92c5-f1f5785d6041&quot;,&quot;title&quot;:&quot;SCDP&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP \&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _test.scdpFixture)({\n    krAssets: createAssets,\n    collaterals: createCollaterals,\n    swapKISSConfig,\n    defaultCollateralConfig,\n    defaultKrAssetConfig,\n    swapKrAssetConfig\n});\n[[swapper, KreskoSwapper], [depositor, KreskoDepositor], [depositor2, KreskoDepositor2], [, KreskoLiquidator]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8fbbfd6c-633a-4bd8-a68e-7246cc00c032&quot;,&quot;parentUUID&quot;:&quot;9d4efad5-7b2b-438a-92c5-f1f5785d6041&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;6393ab1b-bbcc-4441-9ba6-5a80411b17b0&quot;,&quot;title&quot;:&quot;#Test&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Test\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test \&quot;before each\&quot; hook in \&quot;#Test\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8cc8eec9-3b88-43ca-9aea-96aca10eb3d2&quot;,&quot;parentUUID&quot;:&quot;6393ab1b-bbcc-4441-9ba6-5a80411b17b0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;title&quot;:&quot;#Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be initialized correctly&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be initialized correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1351,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { args  } = await (0, _shared.getSCDPInitializer)(_hardhat.default);\nconst configuration = await _hardhat.default.Diamond.getCurrentParametersSCDP();\n(0, _chai.expect)(configuration.swapFeeRecipient).to.equal(args.swapFeeRecipient);\n(0, _chai.expect)(configuration.lt).to.equal(args.lt);\n(0, _chai.expect)(configuration.mcr).to.equal(args.mcr);\nconst collaterals = await _hardhat.default.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.deep.equal([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst krAssets = await _hardhat.default.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.deep.equal([\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst depositsEnabled = await Promise.all([\n    _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address),\n    _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral8Dec.address),\n    _hardhat.default.Diamond.getDepositEnabledSCDP(f.KrAsset.address),\n    _hardhat.default.Diamond.getDepositEnabledSCDP(f.KrAsset2.address),\n    _hardhat.default.Diamond.getDepositEnabledSCDP(f.KISS.address)\n]);\n(0, _chai.expect)(depositsEnabled).to.deep.equal([\n    true,\n    true,\n    false,\n    false,\n    false\n]);\nconst depositAssets = await _hardhat.default.Diamond.getDepositAssetsSCDP();\n(0, _chai.expect)(depositAssets).to.deep.equal([\n    f.Collateral.address,\n    f.Collateral8Dec.address\n]);\nconst assetsEnabled = await Promise.all([\n    _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral.address),\n    _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral8Dec.address),\n    _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset.address),\n    _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset2.address),\n    _hardhat.default.Diamond.getAssetEnabledSCDP(f.KISS.address)\n]);\n(0, _chai.expect)(assetsEnabled).to.deep.equal([\n    true,\n    true,\n    true,\n    true,\n    true\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57a5d8a7-e606-4acc-8cef-5c0286c38268&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to whitelist new deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to whitelist new deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:303,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.addDepositAssetsSCDP([\n    f.KISS.address\n], [\n    defaultCollateralConfig\n]);\nconst collateral = await _hardhat.default.Diamond.getCollateralSCDP(f.KISS.address);\n(0, _chai.expect)(collateral.decimals).to.equal(await f.KISS.contract.decimals());\n(0, _chai.expect)(collateral.liquidityIndex).to.equal(_lib.RAY);\n(0, _chai.expect)(collateral.depositLimit).to.equal(defaultCollateralConfig.depositLimit);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.KISS.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9c48b6d3-c80d-48f2-a932-b8295f5d85c7&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update deposit limit of asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to update deposit limit of asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:197,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.updateDepositLimitSCDP(f.Collateral.address, 1);\nconst collateral = await _hardhat.default.Diamond.getCollateralSCDP(f.Collateral.address);\n(0, _chai.expect)(collateral.decimals).to.equal(await f.Collateral.contract.decimals());\n(0, _chai.expect)(collateral.liquidityIndex).to.equal(_lib.RAY);\n(0, _chai.expect)(collateral.depositLimit).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb2cd0ff-c87a-42cb-963a-c8bbc48d4901&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable a deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable a deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:493,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.disableAssetsSCDP([\n    f.Collateral.address\n], true);\nconst collaterals = await _hardhat.default.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.Collateral.address);\nconst depositAssets = await _hardhat.default.Diamond.getDepositAssetsSCDP();\n(0, _chai.expect)(depositAssets).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1556f89a-fa4a-4e24-9d4a-3f4407b918ac&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable and enable a collateral asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable and enable a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1175,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.disableAssetsSCDP([\n    f.Collateral.address\n], false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getCollateralsSCDP()).to.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositAssetsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait _hardhat.default.Diamond.enableAssetsSCDP([\n    f.Collateral.address\n], false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getCollateralsSCDP()).to.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositAssetsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait _hardhat.default.Diamond.enableAssetsSCDP([\n    f.Collateral.address\n], true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;032c9fd3-e7c7-4089-86db-4ceb895d09bf&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to remove a collateral asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to remove a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:393,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.removeCollateralsSCDP([\n    f.Collateral.address\n]);\nconst collaterals = await _hardhat.default.Diamond.getDepositAssetsSCDP();\n(0, _chai.expect)(collaterals).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.Collateral.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5ef8141e-599d-4836-99be-03b1a109eca3&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to add whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to add whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:193,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetInfo = await _hardhat.default.Diamond.getKreskoAssetSCDP(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.openFee).to.equal(swapKrAssetConfig.openFee);\n(0, _chai.expect)(assetInfo.closeFee).to.equal(swapKrAssetConfig.closeFee);\n(0, _chai.expect)(assetInfo.liquidationIncentive).to.equal(swapKrAssetConfig.liquidationIncentive);\n(0, _chai.expect)(assetInfo.protocolFee).to.equal(swapKrAssetConfig.protocolFee);\n(0, _chai.expect)(assetInfo.supplyLimit).to.equal(swapKrAssetConfig.supplyLimit);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;42cd1808-bbfb-481d-89b2-42395f589135&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to update a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:584,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = {\n    openFee: (0, _lib.toBig)(0.05),\n    closeFee: (0, _lib.toBig)(0.05),\n    liquidationIncentive: (0, _lib.toBig)(1.06),\n    protocolFee: (0, _lib.toBig)(0.4),\n    supplyLimit: (0, _lib.toBig)(50000)\n};\nawait _hardhat.default.Diamond.updateKrAssetSCDP(f.KrAsset.address, update);\nconst assetInfo = await _hardhat.default.Diamond.getKreskoAssetSCDP(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.openFee).to.equal(update.openFee);\n(0, _chai.expect)(assetInfo.closeFee).to.equal(update.closeFee);\n(0, _chai.expect)(assetInfo.protocolFee).to.equal(update.protocolFee);\n(0, _chai.expect)(assetInfo.liquidationIncentive).to.equal(update.liquidationIncentive);\n(0, _chai.expect)(assetInfo.supplyLimit).to.equal(update.supplyLimit);\nconst krAssets = await _hardhat.default.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include(f.KrAsset.address);\nconst collaterals = await _hardhat.default.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.KrAsset.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;781c8ddb-a897-4168-ada6-f895c836eeca&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:294,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.disableAssetsSCDP([\n    f.KrAsset.address\n], false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getKreskoAssetsSCDP()).to.include(f.KrAsset.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;182dbfc1-2838-444a-8bde-d04865c30b08&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to remove a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to remove a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:396,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.removeKrAssetsSCDP([\n    f.KrAsset.address\n]);\nconst krAssets = await _hardhat.default.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.not.include(f.KrAsset.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KrAsset.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb594227-0b9a-45fd-8237-59c6f7256493&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable and enable a collateral asset that is also a kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to disable and enable a collateral asset that is also a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1276,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.addDepositAssetsSCDP([\n    f.KISS.address\n], [\n    defaultCollateralConfig\n]);\nawait _hardhat.default.Diamond.disableAssetsSCDP([\n    f.KISS.address\n], false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getCollateralsSCDP()).to.include(f.KISS.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositAssetsSCDP()).to.not.include(f.KISS.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KISS.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.KISS.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getKreskoAssetsSCDP()).to.include(f.KISS.address);\nawait _hardhat.default.Diamond.enableAssetsSCDP([\n    f.KISS.address\n], true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getCollateralsSCDP()).to.include(f.KISS.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositAssetsSCDP()).to.include(f.KISS.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.getAssetEnabledSCDP(f.KISS.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getDepositEnabledSCDP(f.KISS.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getKreskoAssetsSCDP()).to.include(f.KISS.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e30a9874-9939-45fd-9711-88778c87b885&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to enable and disable swap pairs&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Configuration should be able to enable and disable swap pairs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:587,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapPairsEnabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: true\n    }\n];\nawait _hardhat.default.Diamond.setSwapPairs(swapPairsEnabled);\n(0, _chai.expect)(await _hardhat.default.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(true);\n(0, _chai.expect)(await _hardhat.default.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(true);\nconst swapPairsDisabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: false\n    }\n];\nawait _hardhat.default.Diamond.setSwapPairs(swapPairsDisabled);\n(0, _chai.expect)(await _hardhat.default.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(false);\n(0, _chai.expect)(await _hardhat.default.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2fecfd07-5447-4aa7-8c64-ca171751ffe1&quot;,&quot;parentUUID&quot;:&quot;f1f0efff-7194-4d0e-a3e1-6653e8126e07&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;57a5d8a7-e606-4acc-8cef-5c0286c38268&quot;,&quot;9c48b6d3-c80d-48f2-a932-b8295f5d85c7&quot;,&quot;eb2cd0ff-c87a-42cb-963a-c8bbc48d4901&quot;,&quot;1556f89a-fa4a-4e24-9d4a-3f4407b918ac&quot;,&quot;032c9fd3-e7c7-4089-86db-4ceb895d09bf&quot;,&quot;5ef8141e-599d-4836-99be-03b1a109eca3&quot;,&quot;42cd1808-bbfb-481d-89b2-42395f589135&quot;,&quot;781c8ddb-a897-4168-ada6-f895c836eeca&quot;,&quot;182dbfc1-2838-444a-8bde-d04865c30b08&quot;,&quot;eb594227-0b9a-45fd-8237-59c6f7256493&quot;,&quot;e30a9874-9939-45fd-9711-88778c87b885&quot;,&quot;2fecfd07-5447-4aa7-8c64-ca171751ffe1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:7242,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0dbbf1ea-5c0e-4c61-a665-56962326a309&quot;,&quot;title&quot;:&quot;#Deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deposit collateral, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Deposit should be able to deposit collateral, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5253,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _lib.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted = (0, _lib.toBig)(collateralPrice / 1 * depositAmount, 8); // cfactor = 1\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    return (0, _redstone.wrapKresko)(_hardhat.default.Diamond, user).depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n}));\nconst [userInfos, statistics, assetInfo] = await Promise.all([\n    _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((user)=&gt;user.address), [\n        f.Collateral.address\n    ]),\n    _hardhat.default.Diamond.getStatisticsSCDP(),\n    _hardhat.default.Diamond.getAssetInfoSCDP(f.Collateral.address)\n]);\nfor (const userInfo of userInfos){\n    const balance = await f.Collateral.balanceOf(userInfo.account);\n    (0, _chai.expect)(balance).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmountWithFees).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.totalDepositValueWithFees).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].depositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].depositValueWithFees).to.equal(expectedValueUnadjusted);\n}\n(0, _chai.expect)(await f.Collateral.balanceOf(_hardhat.default.Diamond.address)).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.depositAmount).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.depositValue).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.collateralValue).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.debtValue).to.equal(0);\n// Adjusted\n(0, _chai.expect)(assetInfo.depositValueAdjusted).to.equal(expectedValueAdjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.collateralValueAdjusted).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(statistics.debtValueAdjusted).to.equal(0);\n(0, _chai.expect)(statistics.effectiveDebtValue).to.equal(0);\n(0, _chai.expect)(statistics.crDebtValueAdjusted).to.equal(0);\n(0, _chai.expect)(statistics.crDebtValue).to.equal(0);\n(0, _chai.expect)(statistics.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b5f3fae3-35a8-4b1d-a17c-ad6ec2ecdd0a&quot;,&quot;parentUUID&quot;:&quot;0dbbf1ea-5c0e-4c61-a665-56962326a309&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Deposit should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5572,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _lib.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted = (0, _lib.toBig)(collateralPrice / 1 * depositAmount, 8); // cfactor = 1\nconst expectedValueUnadjusted8Dec = (0, _lib.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueAdjusted8Dec = (0, _lib.toBig)(collateralPrice * 0.8 * depositAmount, 8); // cfactor = 0.8\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    const User = (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, user);\n    return Promise.all([\n        User.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        User.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));\nconst [userInfos, assetInfos, globals] = await Promise.all([\n    _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    _hardhat.default.Diamond.getStatisticsSCDP()\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositValue).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(depositAmount8Dec);\n    (0, _chai.expect)(userInfo.deposits[1].depositValue).to.equal(expectedValueUnadjusted8Dec);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec));\n}\n(0, _chai.expect)(assetInfos[0].depositAmount).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfos[1].depositAmount).to.equal(depositAmount8Dec.mul(f.usersArr.length));\n// WITH_FACTORS global\nconst valueTotalAdjusted = expectedValueAdjusted.mul(f.usersArr.length);\nconst valueTotalAdjusted8Dec = expectedValueAdjusted8Dec.mul(f.usersArr.length);\nconst valueAdjusted = valueTotalAdjusted.add(valueTotalAdjusted8Dec);\n(0, _chai.expect)(assetInfos[0].depositValueAdjusted).to.equal(valueTotalAdjusted);\n(0, _chai.expect)(assetInfos[1].depositValueAdjusted).to.equal(valueTotalAdjusted8Dec);\n(0, _chai.expect)(globals.collateralValueAdjusted).to.equal(valueAdjusted);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);\n// WITHOUT_FACTORS global\nconst valueTotalUnadjusted = expectedValueUnadjusted.mul(f.usersArr.length);\nconst valueTotalUnadjusted8Dec = expectedValueUnadjusted8Dec.mul(f.usersArr.length);\nconst valueUnadjusted = valueTotalUnadjusted.add(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal(valueTotalUnadjusted);\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(globals.collateralValue).to.equal(valueUnadjusted);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8f54846e-fdc3-4d24-8c50-6c944469ec44&quot;,&quot;parentUUID&quot;:&quot;0dbbf1ea-5c0e-4c61-a665-56962326a309&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b5f3fae3-35a8-4b1d-a17c-ad6ec2ecdd0a&quot;,&quot;8f54846e-fdc3-4d24-8c50-6c944469ec44&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10825,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;4d94c2a7-1af5-4786-9e3e-dfb61d5bb14d&quot;,&quot;title&quot;:&quot;#Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw \&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:707,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(_hardhat.default.Diamond, user);\n    await Promise.all([\n        UserKresko.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        UserKresko.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;89dce32e-944f-4819-ac0d-26c159c0d971&quot;,&quot;parentUUID&quot;:&quot;4d94c2a7-1af5-4786-9e3e-dfb61d5bb14d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to withdraw full collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw should be able to withdraw full collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11411,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(_hardhat.default.Diamond, user);\n    return Promise.all([\n        UserKresko.withdrawSCDP(user.address, f.Collateral.address, depositAmount18Dec),\n        UserKresko.withdrawSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec)\n    ]);\n}));\n(0, _chai.expect)(await f.Collateral.balanceOf(_hardhat.default.Diamond.address)).to.equal(0);\nconst [userInfos, assetInfos, globals] = await Promise.all([\n    _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    _hardhat.default.Diamond.getStatisticsSCDP()\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(await f.Collateral.balanceOf(userInfo.account)).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmountWithFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].depositAmountWithFees).to.equal(0);\n    (0, _chai.expect)(userInfo.totalDepositValue).to.equal(0);\n}\nfor (const assetInfo of assetInfos){\n    (0, _chai.expect)(assetInfo.depositValue).to.equal(0);\n    (0, _chai.expect)(assetInfo.depositAmount).to.equal(0);\n    (0, _chai.expect)(assetInfo.swapDeposits).to.equal(0);\n}\n(0, _chai.expect)(globals.collateralValue).to.equal(0);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fb583ef5-18bd-4862-9a2f-9eb06046851c&quot;,&quot;parentUUID&quot;:&quot;4d94c2a7-1af5-4786-9e3e-dfb61d5bb14d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw partial collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Withdraw should be able to withdraw partial collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10881,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const partialWithdraw = depositAmount18Dec.div(f.usersArr.length);\nconst partialWithdraw8Dec = depositAmount8Dec.div(f.usersArr.length);\nconst expectedValueUnadjusted = (0, _lib.toBig)(collateralPrice * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted = (0, _lib.toBig)(collateralPrice * 1 * depositAmount, 8).mul(200).div(300); // cfactor = 1\nconst expectedValueUnadjusted8Dec = (0, _lib.toBig)(collateralPrice * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted8Dec = (0, _lib.toBig)(collateralPrice * 0.8 * depositAmount, 8).mul(200).div(300); // cfactor = 0.8\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    const UserKresko = (0, _redstone.wrapKresko)(_hardhat.default.Diamond, user);\n    return Promise.all([\n        UserKresko.withdrawSCDP(user.address, f.Collateral.address, partialWithdraw),\n        UserKresko.withdrawSCDP(user.address, f.Collateral8Dec.address, partialWithdraw8Dec)\n    ]);\n}));\nconst [collateralBalanceAfter, collateral8DecBalanceAfter, globals, assetInfos, userInfos] = await Promise.all([\n    f.Collateral.balanceOf(_hardhat.default.Diamond.address),\n    f.Collateral8Dec.balanceOf(_hardhat.default.Diamond.address),\n    _hardhat.default.Diamond.getStatisticsSCDP(),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const [balance18Dec, balance8Dec] = await Promise.all([\n        f.Collateral.balanceOf(userInfo.account),\n        f.Collateral8Dec.balanceOf(userInfo.account)\n    ]);\n    (0, _chai.expect)(balance18Dec).to.equal(partialWithdraw);\n    (0, _chai.expect)(balance8Dec).to.equal(partialWithdraw8Dec);\n    (0, _chai.expect)(userInfo.deposits[0].depositAmount).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[0].depositAmountWithFees).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[1].depositAmount).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.deposits[1].depositAmountWithFees).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.totalDepositValue).to.closeTo(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec), (0, _lib.toBig)(0.00001, 8));\n}\n(0, _chai.expect)(collateralBalanceAfter).to.closeTo((0, _lib.toBig)(2000), 1);\n(0, _chai.expect)(collateral8DecBalanceAfter).to.closeTo((0, _lib.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].depositAmount).to.closeTo((0, _lib.toBig)(2000), 1);\n(0, _chai.expect)(assetInfos[1].depositAmount).to.closeTo((0, _lib.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].depositValue).to.closeTo(expectedValueUnadjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[0].depositValueAdjusted).to.closeTo(expectedValueAdjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].depositValue).to.closeTo(expectedValueUnadjusted8Dec.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].depositValueAdjusted).to.closeTo(expectedValueAdjusted8Dec.mul(f.usersArr.length), 20);\nconst totalValueRemaining = expectedValueUnadjusted8Dec.mul(f.usersArr.length).add(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(globals.collateralValue).to.closeTo(totalValueRemaining, 20);\n(0, _chai.expect)(globals.debtValue).to.equal(0);\n(0, _chai.expect)(globals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;15a93e90-2eba-472e-9710-03644de34065&quot;,&quot;parentUUID&quot;:&quot;4d94c2a7-1af5-4786-9e3e-dfb61d5bb14d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;fb583ef5-18bd-4862-9a2f-9eb06046851c&quot;,&quot;15a93e90-2eba-472e-9710-03644de34065&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:22292,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a11af4e2-1ee9-4b55-9c11-fa57c63c4ebf&quot;,&quot;title&quot;:&quot;#Fee Distribution&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Fee Distribution \&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;incomeCumulator = _hardhat.default.users.admin;\nIncomeCumulator = (0, _redstone.wrapKresko)(_hardhat.default.Diamond, incomeCumulator);\nawait f.Collateral.setBalance(incomeCumulator, depositAmount18Dec.mul(f.usersArr.length), _hardhat.default.Diamond.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d3c0abc6-a119-4d2e-88bb-d30d99cb7ce3&quot;,&quot;parentUUID&quot;:&quot;a11af4e2-1ee9-4b55-9c11-fa57c63c4ebf&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to cumulate fees into deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Fee Distribution should be able to cumulate fees into deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19124,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fees = depositAmount18Dec.mul(f.usersArr.length);\nconst expectedValueNoFees = (0, _lib.toBig)(collateralPrice * depositAmount, 8);\nconst expectedValueFees = expectedValueNoFees.mul(2);\n// deposit some\nawait Promise.all(f.usersArr.map((signer)=&gt;(0, _redstone.wrapKresko)(_hardhat.default.Diamond, signer).depositSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\n// cumulate some income\nawait IncomeCumulator.cumulateIncomeSCDP(f.Collateral.address, fees);\n// check that the fees are cumulated\nfor (const data of (await _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    (0, _chai.expect)(data.deposits[0].depositValue).to.equal(expectedValueNoFees);\n    (0, _chai.expect)(data.deposits[0].depositValueWithFees).to.equal(expectedValueFees);\n    (0, _chai.expect)(data.totalDepositValue).to.equal(expectedValueNoFees);\n    (0, _chai.expect)(data.totalDepositValueWithFees).to.equal(expectedValueFees);\n}\n// withdraw principal\nawait Promise.all(f.usersArr.map((signer)=&gt;(0, _redstone.wrapKresko)(_hardhat.default.Diamond, signer).withdrawSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\nfor (const user of (await _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(user.account);\n    (0, _chai.expect)(user.deposits[0].depositValue).to.equal(0);\n    (0, _chai.expect)(user.deposits[0].depositValueWithFees).to.equal(expectedValueFees.sub(expectedValueNoFees));\n    (0, _chai.expect)(user.totalDepositValueWithFees).to.equal(expectedValueFees.sub(expectedValueNoFees));\n    (0, _chai.expect)(user.totalDepositValue).to.equal(0);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec);\n}\nconst [assetInfo, stats, balance] = await Promise.all([\n    _hardhat.default.Diamond.getAssetInfoSCDP(f.Collateral.address),\n    _hardhat.default.Diamond.getStatisticsSCDP(),\n    f.Collateral.balanceOf(_hardhat.default.Diamond.address)\n]);\n(0, _chai.expect)(balance).to.equal(fees);\n(0, _chai.expect)(assetInfo.depositAmount).to.equal(0);\n(0, _chai.expect)(assetInfo.depositValue).to.equal(0);\n(0, _chai.expect)(assetInfo.depositValueAdjusted).to.equal(0);\n(0, _chai.expect)(stats.collateralValue).to.equal(0);\n// Withdraw fees\nawait Promise.all(f.usersArr.map((signer)=&gt;{\n    return (0, _redstone.wrapKresko)(_hardhat.default.Diamond, signer).withdrawSCDP(signer.address, f.Collateral.address, depositAmount18Dec);\n}));\nfor (const data of (await _hardhat.default.Diamond.getAccountInfosSCDP(f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(data.account);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec.add(depositAmount18Dec));\n    (0, _chai.expect)(data.deposits[0].depositValue).to.equal(0);\n    (0, _chai.expect)(data.deposits[0].depositValueWithFees).to.equal(0);\n    (0, _chai.expect)(data.totalDepositValue).to.equal(0);\n    (0, _chai.expect)(data.totalDepositValueWithFees).to.equal(0);\n}\n// nothing left in protocol.\nconst [colalteralBalanceKresko, assetInfoFinal] = await Promise.all([\n    f.Collateral.balanceOf(_hardhat.default.Diamond.address),\n    _hardhat.default.Diamond.getAssetInfoSCDP(f.Collateral.address)\n]);\n(0, _chai.expect)(colalteralBalanceKresko).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositAmount).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositValue).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.depositValueAdjusted).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b23891df-dc88-4112-b020-d6c22656b6c3&quot;,&quot;parentUUID&quot;:&quot;a11af4e2-1ee9-4b55-9c11-fa57c63c4ebf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b23891df-dc88-4112-b020-d6c22656b6c3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:19124,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;title&quot;:&quot;#Swap&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap \&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:217,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// mint some f.KISS for users\nawait _hardhat.default.Diamond.addDepositAssetsSCDP([\n    f.KISS.address\n], [\n    defaultCollateralConfig\n]);\nawait Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _lib.toBig)(1000000))));\nawait f.KISS.setBalance(swapper, (0, _lib.toBig)(10000));\nawait f.KISS.setBalance(depositor, (0, _lib.toBig)(10000));\nawait KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, depositAmount18Dec);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3860c212-d483-494b-b5a3-174cf8696601&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have collateral in pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should have collateral in pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1239,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const value = await _hardhat.default.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(value.collateralValue).to.equal((0, _lib.toBig)(depositAmount, 8));\n(0, _chai.expect)(value.debtValue).to.equal(0);\n(0, _chai.expect)(value.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;567a27f0-5954-47fd-b4ab-b767f8ad863d&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to preview a swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to preview a swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD);\nconst assetInPrice = (0, _lib.toBig)(ONE_USD, 8);\nconst assetOutPrice = (0, _lib.toBig)(KreskoAsset2Price, 8);\nconst feePercentage = (0, _lib.toBig)(0.015 + 0.025);\nconst feePercentageProtocol = (0, _lib.toBig)(0.5);\nconst expectedTotalFee = swapAmount.wadMul(feePercentage);\nconst expectedProtocolFee = expectedTotalFee.wadMul(feePercentageProtocol);\nconst expectedFee = expectedTotalFee.sub(expectedProtocolFee);\nconst amountInAfterFees = swapAmount.sub(expectedTotalFee);\nconst expectedAmountOut = amountInAfterFees.wadMul(assetInPrice).wadDiv(assetOutPrice);\nconst [amountOut, feeAmount, feeAmountProtocol] = await _hardhat.default.Diamond.previewSwapSCDP(f.KISS.address, f.KrAsset2.address, (0, _lib.toBig)(1));\n(0, _chai.expect)(amountOut).to.equal(expectedAmountOut);\n(0, _chai.expect)(feeAmount).to.equal(expectedFee);\n(0, _chai.expect)(feeAmountProtocol).to.equal(expectedProtocolFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;414757e4-f478-49a1-b856-4950941fe516&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == 0 | swap collateral == 0 upgraded&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt == 0 | swap collateral == 0 upgraded&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4329,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD); // $1\nconst expectedAmountOut = (0, _lib.toBig)(0.0096); // $100 * 0.0096 = $0.96\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmount);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedAmountOut);\nconst [KR2Balance, KISSBalance, swapperInfo, assetInfos, global] = await Promise.all([\n    f.KrAsset2.balanceOf(swapper.address),\n    f.KISS.balanceOf(swapper.address),\n    _hardhat.default.Diamond.getAccountInfoSCDP(swapper.address, [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    _hardhat.default.Diamond.getStatisticsSCDP()\n]);\n(0, _chai.expect)(KR2Balance).to.equal(expectedAmountOut);\n(0, _chai.expect)(KISSBalance).to.equal((0, _lib.toBig)(10000).sub(swapAmount));\n(0, _chai.expect)(swapperInfo.deposits[0].depositValue).to.equal(0);\n(0, _chai.expect)(swapperInfo.deposits[1].depositValue).to.equal(0);\n(0, _chai.expect)(assetInfos[1].swapDeposits).to.equal((0, _lib.toBig)(0.96));\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal((0, _lib.toBig)(0.0096));\nconst expectedDepositValue = (0, _lib.toBig)(depositAmount + 0.96, 8);\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(expectedDepositValue);\n(0, _chai.expect)(assetInfos[0].debtValue).to.equal((0, _lib.toBig)(0.96, 8));\n(0, _chai.expect)(global.collateralValue).to.equal(expectedDepositValue);\n(0, _chai.expect)(global.debtValue).to.equal((0, _lib.toBig)(0.96, 8));\n(0, _chai.expect)(global.cr).to.equal(expectedDepositValue.wadDiv((0, _lib.toBig)(0.96, 8)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8dff9c7b-4df6-41fb-9398-22b5a58eda43&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD).mul(100); // $100\nconst swapAmountAsset = (0, _lib.toBig)(0.96); // $96\nconst expectedKissOut = (0, _lib.toBig)(92.16); // $100 * 0.96 = $96\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: swapper,\n    asset: f.KISS,\n    amount: (0, _lib.toBig)(100)\n});\nawait (0, _krassets.mintKrAsset)({\n    user: swapper,\n    asset: f.KrAsset2,\n    amount: (0, _lib.toBig)(0.1)\n});\nconst globalBefore = await _hardhat.default.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(globalBefore.collateralValue).to.equal(initialDepositValue);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n// the swap that clears debt\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountAsset, 0);\nconst [event, assetInfos] = await Promise.all([\n    (0, _lib.getNamedEvent)(tx, \&quot;Swap\&quot;),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.KISS.address,\n        f.KrAsset2.address\n    ])\n]);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(0);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal(initialDepositValue);\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(0);\nconst global = await _hardhat.default.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(global.collateralValue).to.equal((0, _lib.toBig)(1000, 8));\n(0, _chai.expect)(global.debtValue).to.equal(0);\n(0, _chai.expect)(global.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;989d4908-27a1-42a7-8d7a-17194eaa9ea6&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt &gt; assetsIn | swap collateral &gt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt &gt; assetsIn | swap collateral &gt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5568,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD); // $1\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst assetInfoKISS = await _hardhat.default.Diamond.getAssetInfoSCDP(f.KISS.address);\n(0, _chai.expect)(assetInfoKISS.depositValue).to.equal((0, _lib.toBig)(depositAmount + 0.96, 8));\nconst expectedSwapDeposits = (0, _lib.toBig)(0.96);\n(0, _chai.expect)(assetInfoKISS.swapDeposits).to.equal(expectedSwapDeposits);\nconst swapAmountSecond = (0, _lib.toBig)(0.009); // this is $0.90, so less than $0.96 since we want to ensure shared debt &gt; assetsIn | swap collateral &gt; assetsOut\nconst expectedKissOut = (0, _lib.toBig)(0.864); // 0.9 - (0.9 * 0.04) = 0.864\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountSecond, 0);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountSecond);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\nconst [depositValueKR2, depositValueKISS, assetInfos, globals] = await Promise.all([\n    KreskoSwapper.getAccountDepositValueSCDP(swapper.address, f.KrAsset2.address),\n    KreskoSwapper.getAccountDepositValueSCDP(swapper.address, f.KISS.address),\n    _hardhat.default.Diamond.getAssetInfosSCDP([\n        f.KISS.address,\n        f.KrAsset2.address\n    ]),\n    _hardhat.default.Diamond.getStatisticsSCDP()\n]);\n(0, _chai.expect)(depositValueKR2).to.equal(0);\n(0, _chai.expect)(depositValueKISS).to.equal(0);\nconst expectedSwapDepositsAfter = expectedSwapDeposits.sub((0, _lib.toBig)(0.9));\nconst expectedSwapDepositsValue = expectedSwapDepositsAfter.wadMul(assetInfoKISS.assetPrice);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(expectedSwapDepositsAfter);\n(0, _chai.expect)(assetInfos[0].depositValue).to.equal((0, _lib.toBig)(depositAmount, 8).add(expectedSwapDepositsValue));\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(expectedSwapDepositsValue);\nconst expectedDebtAfter = expectedSwapDepositsValue.wadDiv(await f.KrAsset2.getPrice());\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(expectedDebtAfter);\nconst expectedCollateralValue = (0, _lib.toBig)(depositAmount + 0.06, 8);\n(0, _chai.expect)(globals.collateralValue).to.equal(expectedCollateralValue); // swap deposits + collateral deposited\n(0, _chai.expect)(globals.debtValue).to.equal(0.06e8); //\n(0, _chai.expect)(globals.cr).to.equal(expectedCollateralValue.wadDiv((0, _lib.toBig)(0.06, 8)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fcb0dfa7-5158-4ac7-911f-7808b944733d&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt &lt; assetsIn | swap collateral &lt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap should be able to swap, shared debt &lt; assetsIn | swap collateral &lt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8622,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmountKiss = (0, _lib.toBig)(ONE_USD).mul(100); // $100\nconst swapAmountKrAsset = (0, _lib.toBig)(2); // $200\nconst swapValue = 200;\nconst expectedKissOut = (0, _lib.toBig)(192); // $200 * 0.96 = $192\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: swapper,\n    asset: f.KISS,\n    amount: (0, _lib.toBig)(400)\n});\nconst ICDPMintAmount = (0, _lib.toBig)(1.04);\nawait (0, _krassets.mintKrAsset)({\n    user: swapper,\n    asset: f.KrAsset2,\n    amount: ICDPMintAmount\n});\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmountKiss, 0);\nconst stats = await _hardhat.default.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(await KreskoSwapper.getSwapDepositsSCDP(f.KISS.address)).to.equal((0, _lib.toBig)(96));\n(0, _chai.expect)(stats.collateralValue).to.be.eq((0, _lib.toBig)(depositAmount + 96, 8));\n// the swap that matters, here user has 0.96 (previous swap) + 1.04 (mint). expecting 192 kiss from swap.\nconst [expectedAmountOut] = await KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmountKrAsset);\n(0, _chai.expect)(expectedAmountOut).to.equal(expectedKissOut);\nconst tx = await KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmountKrAsset, 0);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;Swap\&quot;);\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountKrAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\nconst assetInfos = await _hardhat.default.Diamond.getAssetInfosSCDP([\n    f.KISS.address,\n    f.KrAsset2.address\n]);\n// f.KISS deposits sent in swap\nconst acocuntPrincipalDepositsKISS = await KreskoSwapper.getAccountDepositSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(assetInfos[0].swapDeposits).to.equal(0); // half of 2 krAsset\n(0, _chai.expect)(assetInfos[0].depositAmount).to.equal(acocuntPrincipalDepositsKISS);\n// KrAsset debt is cleared\n(0, _chai.expect)(assetInfos[1].debtValue).to.equal(0);\n(0, _chai.expect)(assetInfos[1].debtAmount).to.equal(0);\n// f.KISS debt is issued\nconst expectedKissDebtValue = (0, _lib.toBig)(swapValue - 96, 8);\n(0, _chai.expect)(assetInfos[0].debtValue).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(assetInfos[0].debtAmount).to.equal((0, _lib.toBig)(swapValue - 96));\n// krAsset swap deposits\nconst expectedSwapDepositValue = (0, _lib.toBig)(swapValue - 96, 8);\n(0, _chai.expect)(assetInfos[1].swapDeposits).to.equal((0, _lib.toBig)(2 - 0.96));\n(0, _chai.expect)(assetInfos[1].depositValue).to.equal(expectedSwapDepositValue); // asset price is $100\nconst global = await _hardhat.default.Diamond.getStatisticsSCDP();\nconst expectedCollateralValue = (0, _lib.toBig)(1000, 8).add(expectedSwapDepositValue);\n(0, _chai.expect)(global.collateralValue).to.equal(expectedCollateralValue);\n(0, _chai.expect)(global.debtValue).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(global.cr).to.equal(expectedCollateralValue.wadDiv(expectedKissDebtValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1c4a5267-cec1-49b0-abcd-39cdaf8939ba&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cumulates fees on swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Swap cumulates fees on swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7003,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmountNew = (0, _lib.toBig)(10000 - depositAmount);\nawait f.KISS.setBalance(depositor, depositAmountNew);\nawait KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, depositAmountNew);\nconst swapAmount = (0, _lib.toBig)(ONE_USD * 2600); // $1\nconst balFeesBefore = await KreskoSwapper.getAccountDepositValueWithFeesSCDP(depositor.address, f.KISS.address);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst balFeesAfterFirst = await KreskoSwapper.getAccountDepositValueWithFeesSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(balFeesAfterFirst).to.gt(balFeesBefore);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, f.KrAsset2.balanceOf(swapper.address), 0);\nconst balFeesAfterSecond = await KreskoSwapper.getAccountDepositValueWithFeesSCDP(depositor.address, f.KISS.address);\n(0, _chai.expect)(balFeesAfterSecond).to.gt(balFeesAfterFirst);\nconst feesBefore = await KreskoSwapper.getAccountDepositFeesGainedSCDP(depositor.address, f.KISS.address);\nawait KreskoDepositor.withdrawSCDP(depositor.address, f.KISS.address, feesBefore);\nconst [feesAfterThird, feesAfter] = await Promise.all([\n    KreskoSwapper.getAccountDepositValueWithFeesSCDP(depositor.address, f.KISS.address),\n    KreskoSwapper.getAccountDepositFeesGainedSCDP(depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(feesBefore).to.eq(feesAfter);\n(0, _chai.expect)(feesAfterThird).to.eq(10000e8);\nawait KreskoDepositor.withdrawSCDP(depositor.address, f.KISS.address, (0, _lib.toBig)(10000));\nconst [depositsAfterFourth, feesAfterFourth] = await Promise.all([\n    KreskoSwapper.getAccountDepositValueSCDP(depositor.address, f.KISS.address),\n    KreskoSwapper.getAccountDepositValueWithFeesSCDP(depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(depositsAfterFourth).to.eq(0);\n(0, _chai.expect)(feesAfterFourth).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f28acf26-ee8a-4f54-a47a-ffb5324f6d1d&quot;,&quot;parentUUID&quot;:&quot;a94ffbb0-e706-4ecd-b339-c658fba43d14&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;567a27f0-5954-47fd-b4ab-b767f8ad863d&quot;,&quot;414757e4-f478-49a1-b856-4950941fe516&quot;,&quot;8dff9c7b-4df6-41fb-9398-22b5a58eda43&quot;,&quot;989d4908-27a1-42a7-8d7a-17194eaa9ea6&quot;,&quot;fcb0dfa7-5158-4ac7-911f-7808b944733d&quot;,&quot;1c4a5267-cec1-49b0-abcd-39cdaf8939ba&quot;,&quot;f28acf26-ee8a-4f54-a47a-ffb5324f6d1d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:34359,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;title&quot;:&quot;#Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations \&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:414,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await _hardhat.default.Diamond.addDepositAssetsSCDP([\n    f.KISS.address,\n    f.KrAsset2.address\n], [\n    defaultCollateralConfig,\n    defaultCollateralConfig\n]);\nfor (const signer of f.usersArr){\n    await f.Collateral.setBalance(signer, (0, _lib.toBig)(1000000));\n}\nawait f.KISS.setBalance(swapper, (0, _lib.toBig)(10000));\nawait f.KISS.setBalance(depositor2, (0, _lib.toBig)(10000));\nawait Promise.all([\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec),\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral8Dec.address, depositAmount8Dec),\n    KreskoDepositor2.depositSCDP(depositor2.address, f.KISS.address, depositAmount18Dec)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6ec1ca68-375b-4444-a04f-118e087cde6f&quot;,&quot;parentUUID&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should identify if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2466,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD * 2600); // $1\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n(0, _chai.expect)(await _hardhat.default.Diamond.getLiquidatableSCDP()).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b31b3a50-08cd-4bfb-bf35-f3d13c71c88b&quot;,&quot;parentUUID&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert liquidations if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should revert liquidations if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3760,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD * 2600); // $1\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\n(0, _chai.expect)(await _hardhat.default.Diamond.getLiquidatableSCDP()).to.be.false;\nawait f.KrAsset2.setBalance(_hardhat.default.users.liquidator, (0, _lib.toBig)(1000000));\nawait (0, _chai.expect)(KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, (0, _lib.toBig)(7.7), f.Collateral8Dec.address)).to.be.revertedWith(\&quot;not-liquidatable\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;db98caf6-53f2-4783-be9f-a16f8ff002fd&quot;,&quot;parentUUID&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should identify if the pool is underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should identify if the pool is underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4165,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD * 2600);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nf.Collateral.setPrice(collateralPrice / 1000);\nf.Collateral8Dec.setPrice(collateralPrice / 1000);\nconst [stats, params, liquidatable] = await Promise.all([\n    _hardhat.default.Diamond.getStatisticsSCDP(),\n    _hardhat.default.Diamond.getCurrentParametersSCDP(),\n    _hardhat.default.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(stats.cr).to.be.lt(params.lt);\n(0, _chai.expect)(liquidatable).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;45808976-eb36-4388-b593-2447042260e5&quot;,&quot;parentUUID&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidating the underwater pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Liquidations should allow liquidating the underwater pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13370,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD * 2600);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0);\nconst newKreskoAssetPrice = 500;\nf.KrAsset2.setPrice(newKreskoAssetPrice);\nconst [scdpParams, maxLiquidatable, krAssetPrice, statsBefore] = await Promise.all([\n    _hardhat.default.Diamond.getCurrentParametersSCDP(),\n    _hardhat.default.Diamond.getMaxLiqValueSCDP(f.KrAsset2.address, f.Collateral8Dec.address),\n    f.KrAsset2.getPrice(),\n    _hardhat.default.Diamond.getStatisticsSCDP()\n]);\nconst repayAmount = maxLiquidatable.wadDiv(krAssetPrice);\nawait f.KrAsset2.setBalance(_hardhat.default.users.liquidator, repayAmount.add(1e18.toString()));\n(0, _chai.expect)(statsBefore.cr).to.lt(scdpParams.lt);\nconst tx = await KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, repayAmount, f.Collateral8Dec.address);\nconst [statsAfter, liquidatableAfter] = await Promise.all([\n    _hardhat.default.Diamond.getStatisticsSCDP(),\n    _hardhat.default.Diamond.getLiquidatableSCDP()\n]);\n// console.log(\&quot;liq\&quot;, (await tx.wait()).gasUsed.toString());\n(0, _chai.expect)(statsAfter.cr).to.gt(scdpParams.lt);\n(0, _chai.expect)(liquidatableAfter).to.equal(false);\nawait (0, _chai.expect)(KreskoLiquidator.liquidateSCDP(f.KrAsset2.address, repayAmount, f.Collateral8Dec.address)).to.be.revertedWith(\&quot;not-liquidatable\&quot;);\nconst event = await (0, _lib.getNamedEvent)(tx, \&quot;SCDPLiquidationOccured\&quot;);\nconst expectedSeizeAmount = repayAmount.wadMul((0, _lib.toBig)(newKreskoAssetPrice, 8)).wadMul((0, _lib.toBig)(1.05)).wadDiv((0, _lib.toBig)(collateralPrice, 8)).div(10 ** 10);\n(0, _chai.expect)(event.args.liquidator).to.eq(_hardhat.default.users.liquidator.address);\n(0, _chai.expect)(event.args.seizeAmount).to.eq(expectedSeizeAmount);\n(0, _chai.expect)(event.args.repayAmount).to.eq(repayAmount);\n(0, _chai.expect)(event.args.seizeCollateral).to.eq(f.Collateral8Dec.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.eq(f.KrAsset2.address);\nconst expectedDepositsAfter = depositAmount8Dec.sub(event.args.seizeAmount);\n(0, _chai.expect)(expectedDepositsAfter).to.be.lt(depositAmount8Dec);\nconst [principalDeposits, depositsWithFees, params] = await Promise.all([\n    _hardhat.default.Diamond.getAccountDepositSCDP(depositor.address, f.Collateral8Dec.address),\n    _hardhat.default.Diamond.getAccountDepositWithFeesSCDP(depositor.address, f.Collateral8Dec.address),\n    _hardhat.default.Diamond.getCurrentParametersSCDP()\n]);\n(0, _chai.expect)(principalDeposits).to.eq(expectedDepositsAfter);\n(0, _chai.expect)(depositsWithFees).to.eq(expectedDepositsAfter);\nawait KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec.mul(10));\nconst stats = await _hardhat.default.Diamond.getStatisticsSCDP();\n(0, _chai.expect)(stats.cr).to.gt(params.mcr);\nawait (0, _chai.expect)(KreskoDepositor.withdrawSCDP(depositor.address, f.Collateral8Dec.address, expectedDepositsAfter)).to.not.be.reverted;\nconst [principalEnd, depositsWithFeesEnd] = await Promise.all([\n    _hardhat.default.Diamond.getAccountDepositSCDP(depositor.address, f.Collateral8Dec.address),\n    _hardhat.default.Diamond.getAccountDepositWithFeesSCDP(depositor.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(principalEnd).to.eq(0);\n(0, _chai.expect)(depositsWithFeesEnd).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;701d8d80-b6b7-4bb1-945f-715b10a94681&quot;,&quot;parentUUID&quot;:&quot;ac838306-4320-4dbb-b6d3-f9366b48b29f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b31b3a50-08cd-4bfb-bf35-f3d13c71c88b&quot;,&quot;db98caf6-53f2-4783-be9f-a16f8ff002fd&quot;,&quot;45808976-eb36-4388-b593-2447042260e5&quot;,&quot;701d8d80-b6b7-4bb1-945f-715b10a94681&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:23761,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;title&quot;:&quot;#Error&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error \&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:319,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _lib.toBig)(1000000))));\nawait f.KISS.setBalance(swapper, (0, _lib.toBig)(10000));\nawait f.KISS.setBalance(depositor, _hardhat.ethers.BigNumber.from(1));\nawait _hardhat.default.Diamond.addDepositAssetsSCDP([\n    f.KISS.address\n], [\n    defaultCollateralConfig\n]);\nawait Promise.all([\n    KreskoDepositor.depositSCDP(depositor.address, f.KISS.address, 1),\n    KreskoDepositor.depositSCDP(depositor.address, f.Collateral.address, depositAmount18Dec)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e66115f2-dedd-4230-a1d6-53c47735596c&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert depositing unsupported tokens&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert depositing unsupported tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:159,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [UnsupportedToken] = await _hardhat.default.deploy(\&quot;MockERC20\&quot;, {\n    args: [\n        \&quot;UnsupportedToken\&quot;,\n        \&quot;UnsupportedToken\&quot;,\n        18,\n        (0, _lib.toBig)(1)\n    ]\n});\nawait UnsupportedToken.approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nconst { deployer  } = await _hardhat.default.getNamedAccounts();\nawait (0, _chai.expect)(_hardhat.default.Diamond.depositSCDP(deployer, UnsupportedToken.address, 1)).to.be.revertedWith(\&quot;deposit-not-enabled\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c337db0-fe36-4638-990b-7867ab4b89d6&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawing without deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawing without deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:99,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoSwapper.withdrawSCDP(depositor.address, f.Collateral.address, 1)).to.be.revertedWith(\&quot;withdrawal-violation\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ab91ee1-b0e7-4491-b3bf-fbe26cc96201&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawals below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2896,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(ONE_USD).mul(1000); // $1000\nawait KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0); // generate debt\nconst deposits = await KreskoSwapper.getAccountDepositSCDP(depositor.address, f.Collateral.address);\nawait (0, _chai.expect)(KreskoDepositor.withdrawSCDP(depositor.address, f.Collateral.address, deposits)).to.be.revertedWith(\&quot;withdraw-mcr-violation\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff204a93-2bef-46ff-b64f-3deb0e71d612&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals of swap owned collateral deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert withdrawals of swap owned collateral deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1958,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0);\nconst deposits = await KreskoSwapper.getSwapDepositsSCDP(f.KrAsset2.address);\n(0, _chai.expect)(deposits).to.be.gt(0);\nawait (0, _chai.expect)(KreskoSwapper.withdrawSCDP(swapper.address, f.KrAsset2.address, deposits)).to.be.revertedWith(\&quot;withdrawal-violation\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0cd37bcd-e42b-4060-a612-6c48fdfdea92&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping with price below minAmountOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping with price below minAmountOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1191,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nconst [amountOut] = await KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmount);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, amountOut.add(1))).to.be.revertedWith(\&quot;swap-slippage\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;00d214c0-c47a-4df4-9cf8-fcadf14aed4f&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping unsupported route&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping unsupported route&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.Collateral.address, swapAmount, 0)).to.be.revertedWith(\&quot;swap-disabled\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;19f572fe-66df-4ff3-a602-605ec4707153&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping if asset in is disabled&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping if asset in is disabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:207,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait _hardhat.default.Diamond.disableAssetsSCDP([\n    f.KrAsset2.address\n], false);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0)).to.be.revertedWith(\&quot;asset-in-disabled\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;352b00d7-50fe-4c35-b7d3-2395e4d8fac2&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping if asset out is disabled&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping if asset out is disabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:217,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nawait _hardhat.default.Diamond.disableAssetsSCDP([\n    f.KrAsset2.address\n], false);\nawait (0, _chai.expect)(KreskoSwapper.swapSCDP(swapper.address, f.KISS.address, f.KrAsset2.address, swapAmount, 0)).to.be.revertedWith(\&quot;asset-out-disabled\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;49561129-9300-4c32-8f40-a05148945845&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping causes CDP to go below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Test #Error should revert swapping causes CDP to go below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1743,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _lib.toBig)(1500000);\nawait f.KrAsset2.setBalance(swapper, swapAmount);\nconst tx = KreskoSwapper.swapSCDP(swapper.address, f.KrAsset2.address, f.KISS.address, swapAmount, 0);\nawait (0, _chai.expect)(tx).to.be.revertedWith(\&quot;swap-mcr-violation\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a1f47659-fd2f-42ee-98d5-9265848d29e2&quot;,&quot;parentUUID&quot;:&quot;3602a241-1130-4252-a856-151276009bd3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5c337db0-fe36-4638-990b-7867ab4b89d6&quot;,&quot;8ab91ee1-b0e7-4491-b3bf-fbe26cc96201&quot;,&quot;ff204a93-2bef-46ff-b64f-3deb0e71d612&quot;,&quot;0cd37bcd-e42b-4060-a612-6c48fdfdea92&quot;,&quot;00d214c0-c47a-4df4-9cf8-fcadf14aed4f&quot;,&quot;19f572fe-66df-4ff3-a602-605ec4707153&quot;,&quot;352b00d7-50fe-4c35-b7d3-2395e4d8fac2&quot;,&quot;49561129-9300-4c32-8f40-a05148945845&quot;,&quot;a1f47659-fd2f-42ee-98d5-9265848d29e2&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:8578,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:30000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;kresko-protocol&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/panukettunen/Projects/kresko-protocol/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>