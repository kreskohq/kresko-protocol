{
  "stats": {
    "suites": 2,
    "tests": 1,
    "passes": 0,
    "pending": 0,
    "failures": 1,
    "start": "2023-09-01T02:27:35.045Z",
    "end": "2023-09-01T02:27:46.750Z",
    "duration": 11705,
    "testsRegistered": 1,
    "passPercent": 0,
    "pendingPercent": 0,
    "other": 0,
    "hasOther": false,
    "skipped": 0,
    "hasSkipped": false
  },
  "results": [
    {
      "uuid": "9efd2677-be68-4431-9e9b-1aa43230419d",
      "title": "",
      "fullFile": "/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts",
      "file": "/src/test/scdp/00-scdp.ts",
      "beforeHooks": [],
      "afterHooks": [],
      "tests": [],
      "suites": [
        {
          "uuid": "c7f3eb75-63ac-4a11-a474-9577e2e430c0",
          "title": "SCDP",
          "fullFile": "/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts",
          "file": "/src/test/scdp/00-scdp.ts",
          "beforeHooks": [
            {
              "title": "\"before each\" hook in \"SCDP\"",
              "fullTitle": "SCDP \"before each\" hook in \"SCDP\"",
              "timedOut": false,
              "duration": 55,
              "state": null,
              "speed": null,
              "pass": false,
              "fail": false,
              "pending": false,
              "context": null,
              "code": "const fixture = await _hardhat.default.deployments.createFixture(async (hre)=>{\n    const result = await hre.deployments.fixture(fixtureName);\n    await _hardhatnetworkhelpers.time.increase(3602);\n    if (result.Diamond) {\n        hre.Diamond = _evmconnector.WrapperBuilder.wrap(await hre.getContractOrFork(\"Kresko\")).usingSimpleNumericMock({\n            mockSignersCount: 1,\n            timestampMilliseconds: Date.now(),\n            dataPoints: [\n                {\n                    dataFeedId: \"DAI\",\n                    value: 0\n                },\n                {\n                    dataFeedId: \"USDC\",\n                    value: 0\n                },\n                {\n                    dataFeedId: \"TSLA\",\n                    value: 0\n                },\n                {\n                    dataFeedId: \"ETH\",\n                    value: 0\n                },\n                {\n                    dataFeedId: \"BTC\",\n                    value: 0\n                }\n            ]\n        });\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets\n    };\n})();\nthis.facets = fixture.facets || [];\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;",
              "err": {},
              "uuid": "57bb441c-4dae-4e16-afeb-fdfe354e2362",
              "parentUUID": "c7f3eb75-63ac-4a11-a474-9577e2e430c0",
              "isHook": true,
              "skipped": false
            },
            {
              "title": "\"before each\" hook in \"SCDP\"",
              "fullTitle": "SCDP \"before each\" hook in \"SCDP\"",
              "timedOut": false,
              "duration": 6681,
              "state": null,
              "speed": null,
              "pass": false,
              "fail": false,
              "pending": false,
              "context": null,
              "code": "users = [\n    _hardhat.default.users.testUserFive,\n    _hardhat.default.users.testUserSix,\n    _hardhat.default.users.testUserSeven\n];\n[KreskoAsset, CollateralAsset, CollateralAsset8Dec] = await Promise.all([\n    (0, _krassets.addMockKreskoAsset)({\n        name: \"KreskoAssetPrice10USD\",\n        price: collateralPrice,\n        symbol: \"KreskoAssetPrice10USD\",\n        closeFee: 0.1,\n        openFee: 0.1,\n        marketOpen: true,\n        factor: 1.25,\n        supplyLimit: 100000\n    }, true),\n    (0, _collaterals.addMockCollateralAsset)({\n        name: \"Collateral18Dec\",\n        price: collateralPrice,\n        factor: 1,\n        decimals: 18\n    }),\n    (0, _collaterals.addMockCollateralAsset)({\n        name: \"Collateral8Dec\",\n        price: collateralPrice,\n        factor: 0.8,\n        decimals: 8\n    })\n]);\nfor (const user of users){\n    await Promise.all([\n        await CollateralAsset.setBalance(user, depositAmount18Dec),\n        await CollateralAsset8Dec.setBalance(user, depositAmount8Dec),\n        await CollateralAsset.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256),\n        await CollateralAsset8Dec.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256)\n    ]);\n}",
              "err": {},
              "uuid": "e28ca1b4-6172-4f73-91e1-2919312f0c49",
              "parentUUID": "c7f3eb75-63ac-4a11-a474-9577e2e430c0",
              "isHook": true,
              "skipped": false
            }
          ],
          "afterHooks": [],
          "tests": [],
          "suites": [
            {
              "uuid": "9cc590f2-7430-4b9f-ac2c-877a9502ce97",
              "title": "#Swap",
              "fullFile": "/Users/panukettunen/Projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Swap\"",
                  "fullTitle": "SCDP #Swap \"before each\" hook in \"#Swap\"",
                  "timedOut": false,
                  "duration": 4307,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "swapper = users[0];\ndepositor = users[1];\n[KreskoAsset2, KISS] = await Promise.all([\n    (0, _krassets.addMockKreskoAsset)({\n        name: \"KreskoAssetPrice100USD\",\n        price: KreskoAsset2Price,\n        symbol: \"KreskoAssetPrice100USD\",\n        closeFee: 0.05,\n        openFee: 0.05,\n        marketOpen: true,\n        factor: 1,\n        supplyLimit: 1000\n    }, true),\n    (0, _krassets.addMockKreskoAsset)({\n        name: \"KISS\",\n        price: ONE_USD,\n        symbol: \"KISS\",\n        closeFee: 0.025,\n        openFee: 0.025,\n        marketOpen: true,\n        factor: 1,\n        supplyLimit: 1000000\n    }, true)\n]);\nawait _hardhat.default.Diamond.setSCDPFeeAsset(KISS.address);\n// setup collaterals and krAssets in shared pool\nconst krAssetConfig = {\n    openFee: (0, _lib.toBig)(0.015),\n    closeFee: (0, _lib.toBig)(0.015),\n    liquidationIncentive: (0, _lib.toBig)(1.05),\n    protocolFee: (0, _lib.toBig)(0.25),\n    supplyLimit: (0, _lib.toBig)(1000000)\n};\nconst KISSConfig = {\n    openFee: (0, _lib.toBig)(0.025),\n    closeFee: (0, _lib.toBig)(0.025),\n    liquidationIncentive: (0, _lib.toBig)(1.05),\n    protocolFee: (0, _lib.toBig)(0.25),\n    supplyLimit: (0, _lib.toBig)(1000000)\n};\nawait Promise.all([\n    await _hardhat.default.Diamond.enablePoolCollaterals([\n        CollateralAsset.address,\n        CollateralAsset8Dec.address,\n        KISS.address,\n        KreskoAsset.address,\n        KreskoAsset2.address\n    ], [\n        defaultCollateralConfig,\n        defaultCollateralConfig,\n        defaultCollateralConfig,\n        defaultCollateralConfig,\n        defaultCollateralConfig\n    ]),\n    await _hardhat.default.Diamond.enablePoolKrAssets([\n        KreskoAsset.address,\n        KreskoAsset2.address,\n        KISS.address\n    ], [\n        krAssetConfig,\n        krAssetConfig,\n        KISSConfig\n    ]),\n    await _hardhat.default.Diamond.setSwapPairs([\n        {\n            assetIn: KreskoAsset2.address,\n            assetOut: KreskoAsset.address,\n            enabled: true\n        },\n        {\n            assetIn: KISS.address,\n            assetOut: KreskoAsset2.address,\n            enabled: true\n        },\n        {\n            assetIn: KreskoAsset.address,\n            assetOut: KISS.address,\n            enabled: true\n        }\n    ])\n]);\n// mint some KISS for users\nfor (const user of users){\n    await CollateralAsset.setBalance(user, (0, _lib.toBig)(1000000));\n    await CollateralAsset.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\n    await KISS.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\n    await KreskoAsset2.contract.connect(user).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\n}\nawait KISS.setBalance(swapper, (0, _lib.toBig)(10000));\nawait KISS.setBalance(depositor, (0, _lib.toBig)(10000));\n// await wrapContractWithSigner(hre.Diamond, depositor).poolDeposit(\n//     depositor.address,\n//     CollateralAsset.address,\n//     depositAmount18Dec, // $10k\n// );\nawait (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, depositor).poolDeposit(depositor.address, KISS.address, depositAmount18Dec);",
                  "err": {},
                  "uuid": "28129bd8-b49b-4850-bf05-a8b0b9c3c956",
                  "parentUUID": "9cc590f2-7430-4b9f-ac2c-877a9502ce97",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should be able to swap, shared debt > assetsIn | swap collateral > assetsOut",
                  "fullTitle": "SCDP #Swap should be able to swap, shared debt > assetsIn | swap collateral > assetsOut",
                  "timedOut": false,
                  "duration": 658,
                  "state": "failed",
                  "speed": null,
                  "pass": false,
                  "fail": true,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _lib.toBig)(ONE_USD); // $1\nconst expectedAmountOutAsset = (0, _lib.toBig)(0.0096); // $100 * 0.0096 = $0.96\nconst expectedSecondFeeValue = (0, _lib.toBig)(0.96, 8).wadMul((0, _lib.toBig)(0.04)); // $0.96 * 4% = $0.0384\nconst expectedSecondFeeKISS = (0, _lib.toBig)(0.96).wadMul((0, _lib.toBig)(0.04)); // 0.96 * 4% = 0.0384\nconst expectedAmountOutKISS = (0, _lib.toBig)(0.96).sub(expectedSecondFeeKISS); // = 0.9216\nconst Kresko = (0, _test.wrapContractWithSigner)(_hardhat.default.Diamond, swapper);\nawait Kresko.swap(swapper.address, KISS.address, KreskoAsset2.address, swapAmount, 0);\nconst tx = await Kresko.swap(swapper.address, KreskoAsset2.address, KISS.address, expectedAmountOutAsset, 0);\nconst event = await (0, _lib.getNamedEvent)(tx, \"Swap\");\n(0, _chai.expect)(event.args.who).to.equal(swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(KreskoAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(expectedAmountOutAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedAmountOutKISS);\n(0, _chai.expect)(await Kresko.getPoolAccountDepositsValue(swapper.address, KreskoAsset2.address, true)).to.equal(0);\n(0, _chai.expect)(await Kresko.getPoolAccountDepositsValue(swapper.address, KISS.address, true)).to.equal(0);\n(0, _chai.expect)(await Kresko.getPoolSwapDeposits(KISS.address)).to.equal(expectedSecondFeeKISS);\n(0, _chai.expect)(await Kresko.getPoolDepositsValue(KISS.address, true)).to.equal(expectedSecondFeeValue);\n(0, _chai.expect)(await Kresko.getPoolKrAssetDebtValue(KreskoAsset2.address, true)).to.equal(expectedSecondFeeValue);\n(0, _chai.expect)(await Kresko.getPoolKrAssetDebt(KreskoAsset2.address)).to.equal(expectedSecondFeeKISS.wadDiv((0, _lib.toBig)(KreskoAsset2Price)));\nconst global = await _hardhat.default.Diamond.getPoolStats(true);\nconst expectedCollateralValue = (0, _lib.toBig)(10000, 8).add(expectedSecondFeeValue);\nconst expectedDebtValue = expectedSecondFeeValue;\n(0, _chai.expect)(global.collateralValue).to.equal(expectedCollateralValue);\n(0, _chai.expect)(global.debtValue).to.equal(expectedDebtValue);\n(0, _chai.expect)(global.cr).to.equal(expectedCollateralValue.wadDiv(expectedDebtValue));",
                  "err": {
                    "message": "AssertionError: Expected \"0\" to be equal 38400000000000000",
                    "estack": "AssertionError: Expected \"0\" to be equal 38400000000000000\n    at Proxy.<anonymous> (node_modules/.pnpm/@ethereum-waffle+chai@3.4.4/node_modules/@ethereum-waffle/chai/dist/cjs/matchers/bigNumber.js:33:18)\n    at Proxy.overwritingMethodWrapper (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)\n    at doAsserterAsyncAndAddThen (node_modules/.pnpm/chai-as-promised@7.1.1_chai@4.3.7/node_modules/chai-as-promised/lib/chai-as-promised.js:289:22)\n    at Proxy.<anonymous> (node_modules/.pnpm/chai-as-promised@7.1.1_chai@4.3.7/node_modules/chai-as-promised/lib/chai-as-promised.js:255:20)\n    at Proxy.equal (node_modules/.pnpm/chai@4.3.7/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)\n    at Context.<anonymous> (src/test/scdp/00-scdp.ts:714:71)\n    at runMicrotasks (<anonymous>)\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\n    at runNextTicks (node:internal/process/task_queues:65:3)\n    at listOnTimeout (node:internal/timers:526:9)",
                    "diff": " {\n-   \"_hex\": \"0x886c98b7600000\"\n+   \"_hex\": \"0x00\"\n   \"_isBigNumber\": true\n }\n"
                  },
                  "uuid": "6c454464-1889-40c8-a306-4b5f8ae6bd4e",
                  "parentUUID": "9cc590f2-7430-4b9f-ac2c-877a9502ce97",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [],
              "failures": [
                "6c454464-1889-40c8-a306-4b5f8ae6bd4e"
              ],
              "pending": [],
              "skipped": [],
              "duration": 658,
              "root": false,
              "rootEmpty": false,
              "_timeout": 15000
            }
          ],
          "passes": [],
          "failures": [],
          "pending": [],
          "skipped": [],
          "duration": 0,
          "root": false,
          "rootEmpty": false,
          "_timeout": 15000
        }
      ],
      "passes": [],
      "failures": [],
      "pending": [],
      "skipped": [],
      "duration": 0,
      "root": true,
      "rootEmpty": true,
      "_timeout": 15000
    }
  ],
  "meta": {
    "mocha": {
      "version": "10.2.0"
    },
    "mochawesome": {
      "options": {
        "quiet": false,
        "reportFilename": "mochawesome",
        "saveHtml": true,
        "saveJson": true,
        "consoleReporter": "spec",
        "useInlineDiffs": false,
        "code": true
      },
      "version": "7.1.3"
    },
    "marge": {
      "options": null,
      "version": "6.2.0"
    }
  }
}