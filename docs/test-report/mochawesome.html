<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Kresko Protocol Hardhat Test Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:90,&quot;tests&quot;:277,&quot;passes&quot;:256,&quot;pending&quot;:21,&quot;failures&quot;:0,&quot;start&quot;:&quot;2024-02-01T22:12:23.707Z&quot;,&quot;end&quot;:&quot;2024-02-01T22:13:54.225Z&quot;,&quot;duration&quot;:90518,&quot;testsRegistered&quot;:277,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:7.581227436823104,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;0e4465dd-a788-4bea-8761-6e5204e024ad&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;82e66d61-cd07-48b7-9530-4f2d3455d58d&quot;,&quot;title&quot;:&quot;Asset Amounts &amp; Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values \&quot;before each\&quot; hook in \&quot;Asset Amounts &amp; Values\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.assetValuesFixture)();\nf.user = hre.users.userEight;\nUser = hre.Diamond.connect(f.user);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;516bfb24-265f-430e-a74e-a027cbc4f68b&quot;,&quot;parentUUID&quot;:&quot;82e66d61-cd07-48b7-9530-4f2d3455d58d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;60a5922a-decc-46fb-b9c1-c1225ad6ca3f&quot;,&quot;title&quot;:&quot;#Collateral Deposit Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit value with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\n;\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6384bc9d-1a7b-4b1c-9915-8c03cbd0b921&quot;,&quot;parentUUID&quot;:&quot;60a5922a-decc-46fb-b9c1-c1225ad6ca3f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\n;\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02d1ca2f-6b2f-4fd8-b557-2f424170fe6c&quot;,&quot;parentUUID&quot;:&quot;60a5922a-decc-46fb-b9c1-c1225ad6ca3f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nconst expectedDepositValue = (0, _values.toBig)(50, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10\n;\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56627577-c43d-4311-b6c7-6322438c5a9d&quot;,&quot;parentUUID&quot;:&quot;60a5922a-decc-46fb-b9c1-c1225ad6ca3f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value combination of different decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Values should return the correct deposit value combination of different decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await User.depositCollateral(f.user.address, f.CollateralAsset.address, (0, _values.toBig)(10));\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, (0, _values.toBig)(10, 8));\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, (0, _values.toBig)(10, 21));\nconst expectedDepositValue = (0, _values.toBig)(150, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 30\n;\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e7dc5e47-bce0-431a-afef-f7ada041876f&quot;,&quot;parentUUID&quot;:&quot;60a5922a-decc-46fb-b9c1-c1225ad6ca3f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6384bc9d-1a7b-4b1c-9915-8c03cbd0b921&quot;,&quot;02d1ca2f-6b2f-4fd8-b557-2f424170fe6c&quot;,&quot;56627577-c43d-4311-b6c7-6322438c5a9d&quot;,&quot;e7dc5e47-bce0-431a-afef-f7ada041876f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:123,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;54601485-40be-4095-834d-e563535ca7bc&quot;,&quot;title&quot;:&quot;#Collateral Deposit Amount&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct deposit amount with 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:70,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral({\n    account: f.user.address,\n    asset: f.CollateralAsset.address,\n    amount: depositAmount,\n    collateralIndex: withdrawIndex,\n    receiver: f.user.address\n}, await hre.updateData());\nconst balance = await f.CollateralAsset.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1a210849-9280-4d43-8f30-ca28fce7d849&quot;,&quot;parentUUID&quot;:&quot;54601485-40be-4095-834d-e563535ca7bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit amount with less than 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit amount with less than 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst withdrawIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset8Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset8Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral({\n    account: f.user.address,\n    asset: f.CollateralAsset8Dec.address,\n    amount: depositAmount,\n    collateralIndex: withdrawIndex,\n    receiver: f.user.address\n}, await hre.updateData());\nconst balance = await f.CollateralAsset8Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fe5c28af-a2cc-4dac-a5fe-6405c780c4b3&quot;,&quot;parentUUID&quot;:&quot;54601485-40be-4095-834d-e563535ca7bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct deposit value with over 18 decimals&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Collateral Deposit Amount should return the correct deposit value with over 18 decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst collateralIndex = await _optimizations.default.getAccountDepositIndex(f.user.address, f.CollateralAsset21Dec.address);\nconst deposits = await hre.Diamond.getAccountCollateralAmount(f.user.address, f.CollateralAsset21Dec.address);\n(0, _chai.expect)(deposits).to.equal(depositAmount);\nawait User.withdrawCollateral({\n    account: f.user.address,\n    asset: f.CollateralAsset21Dec.address,\n    amount: depositAmount,\n    collateralIndex,\n    receiver: f.user.address\n}, await hre.updateData());\nconst balance = await f.CollateralAsset21Dec.balanceOf(f.user.address);\n(0, _chai.expect)(balance).to.equal((0, _values.toBig)(f.startingBalance, 21));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b8ca85bd-07ec-40e2-8efc-c726b8eb1b4f&quot;,&quot;parentUUID&quot;:&quot;54601485-40be-4095-834d-e563535ca7bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1a210849-9280-4d43-8f30-ca28fce7d849&quot;,&quot;fe5c28af-a2cc-4dac-a5fe-6405c780c4b3&quot;,&quot;b8ca85bd-07ec-40e2-8efc-c726b8eb1b4f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:198,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;af33124c-539b-4878-ae29-2349c08f3a05&quot;,&quot;title&quot;:&quot;#Kresko Asset Debt Values&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/asset-values/00-asset-values.ts&quot;,&quot;file&quot;:&quot;/src/test/asset-values/00-asset-values.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:155,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10);\nawait User.depositCollateral(f.user.address, f.CollateralAsset.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals) // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\n;\nawait User.mintKreskoAsset({\n    account: f.user.address,\n    krAsset: f.KreskoAsset.address,\n    amount: mintAmount,\n    receiver: f.user.address\n}, await hre.updateData());\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\n;\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)) // 2.475\n;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d97b8ec9-924d-4471-8a62-c00c4f3c64e5&quot;,&quot;parentUUID&quot;:&quot;af33124c-539b-4878-ae29-2349c08f3a05&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with less than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:162,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 8);\nawait User.depositCollateral(f.user.address, f.CollateralAsset8Dec.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals) // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\n;\nawait User.mintKreskoAsset({\n    account: f.user.address,\n    krAsset: f.KreskoAsset.address,\n    amount: mintAmount,\n    receiver: f.user.address\n}, await hre.updateData());\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\n;\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)) // 2.475\n;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e94101f-1348-47cc-82e8-1c7ba4f91074&quot;,&quot;parentUUID&quot;:&quot;af33124c-539b-4878-ae29-2349c08f3a05&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;fullTitle&quot;:&quot;Asset Amounts &amp; Values #Kresko Asset Debt Values should return the correct debt value (+CR) with more than 18 decimal collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:160,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmount = (0, _values.toBig)(10, 21);\nawait User.depositCollateral(f.user.address, f.CollateralAsset21Dec.address, depositAmount);\nconst mintAmount = (0, _values.toBig)(1);\nconst expectedMintValue = (0, _values.toBig)(20, f.oracleDecimals) // kFactor = 2, krAssetPrice = 10, mintAmount = 1, openFee = 0.1\n;\nawait User.mintKreskoAsset({\n    account: f.user.address,\n    krAsset: f.KreskoAsset.address,\n    amount: mintAmount,\n    receiver: f.user.address\n}, await hre.updateData());\nconst expectedDepositValue = (0, _values.toBig)(49.5, f.oracleDecimals) // cfactor = 0.5, collateralPrice = 10, depositAmount = 10, openFee = 0.1\n;\nconst depositValue = await hre.Diamond.getAccountTotalCollateralValue(f.user.address);\n(0, _chai.expect)(depositValue).to.equal(expectedDepositValue);\nconst mintValue = await hre.Diamond.getAccountTotalDebtValue(f.user.address);\n(0, _chai.expect)(mintValue).to.equal(expectedMintValue);\nconst assetValue = await hre.Diamond.getValue(f.KreskoAsset.address, mintAmount);\nconst kFactor = (await hre.Diamond.getAsset(f.KreskoAsset.address)).kFactor;\n(0, _chai.expect)(assetValue).to.equal(expectedMintValue.percentDiv(kFactor));\nconst collateralRatio = await hre.Diamond.getAccountCollateralRatio(f.user.address);\n(0, _chai.expect)(collateralRatio).to.equal(expectedDepositValue.percentDiv(expectedMintValue)) // 2.475\n;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2f8b73a-5a42-448f-8d1d-5ccd0b4c5982&quot;,&quot;parentUUID&quot;:&quot;af33124c-539b-4878-ae29-2349c08f3a05&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d97b8ec9-924d-4471-8a62-c00c4f3c64e5&quot;,&quot;6e94101f-1348-47cc-82e8-1c7ba4f91074&quot;,&quot;f2f8b73a-5a42-448f-8d1d-5ccd0b4c5982&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:477,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;af78c602-1dfb-4b31-b1cb-3c86ca5234b9&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fcd71484-0d8b-433a-bf25-6b7798c9370a&quot;,&quot;parentUUID&quot;:&quot;af78c602-1dfb-4b31-b1cb-3c86ca5234b9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ef75ab74-8a34-4464-9da0-7e7ca608eebb&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await _hardhat.default.Diamond.owner()).to.equal(_hardhat.default.users.deployer.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.initialized()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7ec3c170-9377-45da-b38f-d58e34d3221c&quot;,&quot;parentUUID&quot;:&quot;ef75ab74-8a34-4464-9da0-7e7ca608eebb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets standard facet addresses&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets standard facet addresses&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:53,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetAddressesOnChain = (await _hardhat.default.Diamond.facets()).map((f)=&gt;f.facetAddress);\nconst facetAddressesArtifact = f.facets.map((f)=&gt;f.facetAddress);\n(0, _chai.expect)(facetAddressesOnChain.length).to.equal(facetAddressesArtifact.length);\n(0, _chai.expect)(facetAddressesOnChain).to.have.members(facetAddressesArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ae20df8-b906-4402-a0b9-b3ba33ed82bd&quot;,&quot;parentUUID&quot;:&quot;ef75ab74-8a34-4464-9da0-7e7ca608eebb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets selectors of standard facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets selectors of standard facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:53,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsSelectorsOnChain = (await _hardhat.default.Diamond.facets()).flatMap((f)=&gt;f.functionSelectors);\nconst facetSelectorsOnArtifact = f.facets.flatMap((f)=&gt;f.functionSelectors);\n(0, _chai.expect)(facetsSelectorsOnChain.length).to.equal(facetSelectorsOnArtifact.length);\n(0, _chai.expect)(facetsSelectorsOnChain).to.have.members(facetSelectorsOnArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0bf9b29c-e0df-4b21-ba3c-6cd30a6c6ad7&quot;,&quot;parentUUID&quot;:&quot;ef75ab74-8a34-4464-9da0-7e7ca608eebb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7ec3c170-9377-45da-b38f-d58e34d3221c&quot;,&quot;2ae20df8-b906-4402-a0b9-b3ba33ed82bd&quot;,&quot;0bf9b29c-e0df-4b21-ba3c-6cd30a6c6ad7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:112,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;231f8ef5-77be-436c-9cdb-fc00c3f4c657&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3bd320c9-9d63-4e98-80a3-c7ed0a419d7c&quot;,&quot;parentUUID&quot;:&quot;231f8ef5-77be-436c-9cdb-fc00c3f4c657&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5c020daf-a33d-4876-bc8f-f03c38f0dc6e&quot;,&quot;title&quot;:&quot;#ownership&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.owner()).to.equal(hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9d93b4a3-836d-4a48-8c1b-4684a026c6df&quot;,&quot;parentUUID&quot;:&quot;5c020daf-a33d-4876-bc8f-f03c38f0dc6e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct default admin role&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct default admin role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.hasRole(_roles.Role.ADMIN, hre.addr.deployer)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0fea949a-498c-4cc6-8402-a1c782f9d6b2&quot;,&quot;parentUUID&quot;:&quot;5c020daf-a33d-4876-bc8f-f03c38f0dc6e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets a new pending owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets a new pending owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\n(0, _chai.expect)(await hre.Diamond.pendingOwner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a54985b9-4f01-4887-8ca2-ecec475d3b0d&quot;,&quot;parentUUID&quot;:&quot;5c020daf-a33d-4876-bc8f-f03c38f0dc6e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets the pending owner as new owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets the pending owner as new owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = hre.users.userOne;\nawait hre.Diamond.transferOwnership(pendingOwner.address);\nawait hre.Diamond.connect(pendingOwner).acceptOwnership();\n(0, _chai.expect)(await hre.Diamond.owner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e9f8b98a-0683-438b-b7a3-94131f2f94a6&quot;,&quot;parentUUID&quot;:&quot;5c020daf-a33d-4876-bc8f-f03c38f0dc6e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9d93b4a3-836d-4a48-8c1b-4684a026c6df&quot;,&quot;0fea949a-498c-4cc6-8402-a1c782f9d6b2&quot;,&quot;a54985b9-4f01-4887-8ca2-ecec475d3b0d&quot;,&quot;e9f8b98a-0683-438b-b7a3-94131f2f94a6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:32,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;dec095d9-26f6-4536-b33e-60240e2765c5&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.diamondFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9bcba3dd-b3e1-47e0-889f-b2b5ee173c32&quot;,&quot;parentUUID&quot;:&quot;dec095d9-26f6-4536-b33e-60240e2765c5&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;title&quot;:&quot;#upgrades&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can add a new facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can add a new facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1056,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Factory = await _smock.smock.mock(&#x27;SmockFacet&#x27;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(&#x27;SmockInit&#x27;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst TEST_OPERATOR_ROLE = hre.ethers.utils.id(&#x27;kresko.test.operator&#x27;);\nconst isTestOperator = await hre.Diamond.hasRole(TEST_OPERATOR_ROLE, hre.addr.userOne);\n// Succesfully added the new operator through the initialization contract\n(0, _chai.expect)(isTestOperator).to.equal(true);\nconst Facet = await hre.ethers.getContractAt([\n    ..._typechain.SmockFacet__factory.abi\n], hre.Diamond.address);\n// Ensure facet has it&#x27;s own storage\nconst operatorFromNewStorage = await Facet.operator() // Retrieved from SmockStorage\n;\n(0, _chai.expect)(operatorFromNewStorage).to.equal(hre.addr.userOne);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;24f7f8ae-2bc9-4eaf-8555-3bb00b46b240&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:503,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const NewFacet = await (0, _addfacet.addFacet)({\n    name: &#x27;SmockFacet&#x27;,\n    initializerName: &#x27;SmockInit&#x27;,\n    initializerArgs: hre.addr.userOne\n});\nconst facetsBefore = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.filter((f)=&gt;f.facetAddress === NewFacet.address).length).to.equal(1);\nawait (0, _removefacet.removeFacet)({\n    name: &#x27;SmockFacet&#x27;\n});\nconst facetsAfter = await hre.Diamond.facets();\n(0, _chai.expect)(facetsBefore.length - facetsAfter.length).to.equal(1);\n(0, _chai.expect)(facetsAfter).to.not.deep.contain(NewFacet.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e394f05e-e495-4f54-a34a-99fdd0449122&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Delete acceptOwnership from DiamondStateFacet\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.notAdmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[&#x27;acceptOwnership()&#x27;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst facetAddress = await hre.Diamond.facetAddress(signature);\nconst functions = await hre.Diamond.facetFunctionSelectors(facetAddress);\nconst Cut = {\n    facetAddress: hre.ethers.constants.AddressZero,\n    action: _types.FacetCutAction.Remove,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\n// Ensure rest of the functions remain\nconst functionsAfterCut = await hre.Diamond.facetFunctionSelectors(facetAddress);\n(0, _chai.expect)(functionsAfterCut.length).to.equal(functions.length - 1);\n// Ensure delegatecall did set the correct pending owner with the cut\nconst contract = await hre.ethers.getContractAt(&#x27;DSCore&#x27;, hre.Diamond.address);\nconst filter = contract.filters.PendingOwnershipTransfer(hre.addr.deployer, correctOwner);\nconst [event] = await contract.queryFilter(filter);\nconst { previousOwner, newOwner } = event.args;\n(0, _chai.expect)(previousOwner).to.equal(hre.addr.deployer);\n(0, _chai.expect)(newOwner).to.equal(correctOwner);\n// Ensure there is no function to accept the ownership\nawait (0, _chai.expect)(hre.Diamond.connect(hre.users.notAdmin).acceptOwnership()).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0dc3cc59-1abe-4f51-9e90-770fe758dfe9&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can replace a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can replace a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:79,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Same as above but instead replace the function\n// Check there is no pending owner\nlet pendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(hre.ethers.constants.AddressZero);\n// Transfer to eg. wrong address\nconst wrongOwner = hre.addr.notAdmin;\nawait hre.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hre.Diamond.pendingOwner();\n(0, _chai.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hre.Diamond.interface.functions[&#x27;acceptOwnership()&#x27;];\nconst signature = hre.ethers.utils.Interface.getSighash(functionFragment);\nconst OldOwnershipFacet = await hre.Diamond.facetAddress(signature);\nconst [NewOwnershipFacet, allOwnershipFacetSignatures] = await hre.deploy(&#x27;DiamondStateFacet&#x27;, {\n    deploymentName: &#x27;DiamondStateFacet2&#x27;\n});\n// Only replace a single function, we could replace all of them\nconst Cut = {\n    facetAddress: NewOwnershipFacet.address,\n    action: _types.FacetCutAction.Replace,\n    functionSelectors: [\n        signature\n    ]\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = hre.addr.userOne;\nconst initData = await hre.Diamond.populateTransaction.transferOwnership(correctOwner);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\n// Ensure function exists and revert is for invalid address instead of missing function\nawait (0, _chai.expect)(hre.Diamond.connect(hre.users.notAdmin).acceptOwnership()).to.be.reverted;\n// Ensure one function is contained in the new facet\nconst functionsNewFacet = await hre.Diamond.facetFunctionSelectors(NewOwnershipFacet.address);\n(0, _chai.expect)(functionsNewFacet.length).to.equal(1);\n(0, _chai.expect)(functionsNewFacet).to.have.members([\n    signature\n]);\n// Ensure rest are in the previous one\nconst functionsOldFacet = await hre.Diamond.facetFunctionSelectors(OldOwnershipFacet);\n(0, _chai.expect)(functionsOldFacet).to.not.have.members([\n    signature\n]);\n(0, _chai.expect)(functionsOldFacet.length).to.equal(allOwnershipFacetSignatures.length - 1);\n// Ensure correct owner can now accept the ownership\n(0, _chai.expect)(hre.Diamond.connect(hre.users.userOne).acceptOwnership());\nconst currentOwner = await hre.Diamond.owner();\n(0, _chai.expect)(currentOwner).to.equal(correctOwner);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e4146ba-039e-4778-9067-a7303b76cce6&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can upgrade state&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can upgrade state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:940,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\nconst Factory = await _smock.smock.mock(&#x27;SmockInit&#x27;);\nconst SmockInit = await Factory.deploy();\nconst tx = await SmockInit.populateTransaction.upgradeState();\nawait hre.Diamond.executeInitializer(tx.to, tx.data);\n(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3cf64fed-414e-4dfa-8c67-aca994d105ac&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can preserve old state when extending storage layout&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can preserve old state when extending storage layout&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1654,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.initialized()).to.equal(true);\n// Add the first facet\nconst Factory = await _smock.smock.mock(&#x27;SmockFacet&#x27;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hre.deploy(&#x27;SmockInit&#x27;);\nconst signatures = hre.getSignatures([\n    ..._typechain.SmockFacet__factory.abi\n]);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: _types.FacetCutAction.Add\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(hre.addr.userOne);\nawait hre.Diamond.diamondCut([\n    Cut\n], initData.to, initData.data);\nconst Diamond = await hre.ethers.getContractAt(&#x27;SmockFacet&#x27;, hre.Diamond.address);\nconst isInitialized = await Diamond.smockInitialized();\n(0, _chai.expect)(isInitialized).to.equal(true);\n// Add facet with extended state\n// Add the first facet\nconst Factory2 = await _smock.smock.mock(&#x27;SmockFacet2&#x27;);\nconst SmockFacet2 = await Factory2.deploy();\nconst signatures2 = hre.getSignatures([\n    ..._typechain.SmockFacet2__factory.abi\n]);\nconst Cut2 = {\n    facetAddress: SmockFacet2.address,\n    functionSelectors: signatures2,\n    action: _types.FacetCutAction.Add\n};\n// Initializer only sets the new extended value, does not touch old storage\nconst initData2 = await SmockFacet2.populateTransaction.initialize();\nawait hre.Diamond.diamondCut([\n    Cut2\n], initData2.to, initData2.data);\n// Here we have appended the storage layout with the `extended` bool property.\nconst DiamondExtended = await hre.ethers.getContractAt(&#x27;SmockFacet2&#x27;, hre.Diamond.address);\nconst initializedAfterExtend = await DiamondExtended.getOldStructValueFromExtended();\nconst extendedValue = await DiamondExtended.getNewStructValueFromExtended();\n// Old values remain\n(0, _chai.expect)(initializedAfterExtend).to.equal(true);\n// And we get new ones\n(0, _chai.expect)(extendedValue).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;475f321b-3a4f-4408-a80e-80029eb2d9f7&quot;,&quot;parentUUID&quot;:&quot;5b8625d6-2f4b-4698-8147-e5ef7553467a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;24f7f8ae-2bc9-4eaf-8555-3bb00b46b240&quot;,&quot;e394f05e-e495-4f54-a34a-99fdd0449122&quot;,&quot;0dc3cc59-1abe-4f51-9e90-770fe758dfe9&quot;,&quot;1e4146ba-039e-4778-9067-a7303b76cce6&quot;,&quot;3cf64fed-414e-4dfa-8c67-aca994d105ac&quot;,&quot;475f321b-3a4f-4408-a80e-80029eb2d9f7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4287,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;31f89c43-ac44-485f-bffb-10408d6c38f1&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/03-protocol.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/03-protocol.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _fixtures.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e101670d-3efc-487d-b173-98212e9638b8&quot;,&quot;parentUUID&quot;:&quot;31f89c43-ac44-485f-bffb-10408d6c38f1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0566fb72-01cb-4c4d-b4d7-6b8303345bc0&quot;,&quot;title&quot;:&quot;#protocol initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/diamond/03-protocol.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/03-protocol.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;initialized all facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #protocol initialization initialized all facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsOnChain = (await hre.Diamond.facets()).map(([facetAddress, functionSelectors])=&gt;({\n        facetAddress,\n        functionSelectors\n    }));\nconst expectedFacets = await Promise.all([\n    ..._deploy.diamondFacets,\n    ..._deploy.minterFacets,\n    ..._deploy.scdpFacets,\n    ..._deploy.commonFacets,\n    ..._deploy.peripheryFacets\n].map(async (name)=&gt;{\n    const deployment = await hre.deployments.get(name);\n    return {\n        facetAddress: deployment.address,\n        functionSelectors: facetsOnChain.find((f)=&gt;f.facetAddress === deployment.address).functionSelectors\n    };\n}));\n(0, _chai.expect)(facetsOnChain).to.have.deep.members(expectedFacets);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d6df476c-0e65-4975-8552-4c0ba1d5b699&quot;,&quot;parentUUID&quot;:&quot;0566fb72-01cb-4c4d-b4d7-6b8303345bc0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;initialized correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #protocol initialization initialized correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await hre.Diamond.getStorageVersion()).to.equal(3);\nconst GatingManager = await hre.deployments.get(&#x27;GatingManager&#x27;);\nconst { args } = await (0, _deploy.getCommonInitializer)(hre, GatingManager.address);\nconst { args: minterArgs } = await (0, _deploy.getMinterInitializer)(hre);\nconst { args: scdpArgs } = await (0, _deploy.getSCDPInitializer)(hre);\n(0, _chai.expect)(await hre.Diamond.hasRole(_roles.Role.ADMIN, args.admin)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.hasRole(_roles.Role.SAFETY_COUNCIL, hre.Multisig.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getFeeRecipient()).to.equal(args.treasury);\n(0, _chai.expect)(await hre.Diamond.getPythEndpoint()).to.equal(args.pythEp);\n(0, _chai.expect)(await hre.Diamond.getMinCollateralRatioMinter()).to.equal(minterArgs.minCollateralRatio);\n(0, _chai.expect)(await hre.Diamond.getLiquidationThresholdMinter()).to.equal(minterArgs.liquidationThreshold);\n(0, _chai.expect)(await hre.Diamond.getMinDebtValueMinter()).to.equal(minterArgs.minDebtValue);\n(0, _chai.expect)(await hre.Diamond.getMaxLiquidationRatioMinter()).to.equal(Number(minterArgs.liquidationThreshold) + 0.01e4);\nconst scdpParams = await hre.Diamond.getParametersSCDP();\n(0, _chai.expect)(scdpParams.minCollateralRatio).to.equal(scdpArgs.minCollateralRatio);\n(0, _chai.expect)(scdpParams.liquidationThreshold).to.equal(scdpArgs.liquidationThreshold);\n(0, _chai.expect)(await hre.Diamond.getOracleDeviationPct()).to.equal(args.maxPriceDeviationPct);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5dbec90a-12d5-4e88-b458-7323a88d4952&quot;,&quot;parentUUID&quot;:&quot;0566fb72-01cb-4c4d-b4d7-6b8303345bc0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can modify configuration parameters&quot;,&quot;fullTitle&quot;:&quot;Diamond #protocol initialization can modify configuration parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:35,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(hre.Diamond.setMaxPriceDeviationPct(0.05e4)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.setSequencerGracePeriod(1000)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.setDefaultOraclePrecision(9)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.setMinDebtValueMinter(20e8)).to.not.be.reverted;\n(0, _chai.expect)(await hre.Diamond.getMinDebtValueMinter()).to.equal(20e8);\n(0, _chai.expect)(await hre.Diamond.getDefaultOraclePrecision()).to.equal(9);\n(0, _chai.expect)(await hre.Diamond.getOracleDeviationPct()).to.equal(0.05e4);\n(0, _chai.expect)(await hre.Diamond.getSequencerGracePeriod()).to.equal(1000);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99de6d6c-7e9c-4778-8b2c-39d6afb25f12&quot;,&quot;parentUUID&quot;:&quot;0566fb72-01cb-4c4d-b4d7-6b8303345bc0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d6df476c-0e65-4975-8552-4c0ba1d5b699&quot;,&quot;5dbec90a-12d5-4e88-b458-7323a88d4952&quot;,&quot;99de6d6c-7e9c-4778-8b2c-39d6afb25f12&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:129,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a1f21084-89b2-414a-837a-0c159b49f452&quot;,&quot;title&quot;:&quot;Forking&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c7cf548c-16af-4003-b9d3-724cd51d189b&quot;,&quot;title&quot;:&quot;#setup&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should get Kresko from the companion network locally&quot;,&quot;fullTitle&quot;:&quot;Forking #setup should get Kresko from the companion network locally&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;de551dd8-f37e-439f-84d1-18201c207a87&quot;,&quot;parentUUID&quot;:&quot;c7cf548c-16af-4003-b9d3-724cd51d189b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;de551dd8-f37e-439f-84d1-18201c207a87&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;e38e2955-6e29-4728-8f94-d7f40cbe5a31&quot;,&quot;title&quot;:&quot;#rate-upgrade-11-04-2023&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/forking/00-setup.ts&quot;,&quot;file&quot;:&quot;/src/test/forking/00-setup.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deploy facets&quot;,&quot;fullTitle&quot;:&quot;Forking #rate-upgrade-11-04-2023 should be able to deploy facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a081c708-2fda-40a1-bc64-56e4141f3af0&quot;,&quot;parentUUID&quot;:&quot;e38e2955-6e29-4728-8f94-d7f40cbe5a31&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;a081c708-2fda-40a1-bc64-56e4141f3af0&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f607e92c-68b1-41a2-95ac-90516dcbc5e6&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.kreskoAssetFixture)({\n    name,\n    symbol,\n    underlyingToken: _viem.zeroAddress\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e99a8d2c-2d44-44d1-8f37-7be2cf7161ce&quot;,&quot;parentUUID&quot;:&quot;f607e92c-68b1-41a2-95ac-90516dcbc5e6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;95eb5764-18db-45b9-ac6e-7cd195dd8861&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(name);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(symbol);\n(0, _chai.expect)(await f.KreskoAsset.kresko()).to.equal(hre.Diamond.address);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.Role.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.Role.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await f.KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await f.KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b5d3cc8-c0a2-4be5-bbaf-ad671dcd2c79&quot;,&quot;parentUUID&quot;:&quot;95eb5764-18db-45b9-ac6e-7cd195dd8861&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = &#x27;foo&#x27;;\nconst newSymbol = &#x27;bar&#x27;;\nawait (0, _chai.expect)(f.KreskoAsset.reinitializeERC20(newName, newSymbol, 2)).to.not.be.reverted;\n(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(newName);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e3962794-61e5-459d-9291-c2456df1ed4d&quot;,&quot;parentUUID&quot;:&quot;95eb5764-18db-45b9-ac6e-7cd195dd8861&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1826ac84-6363-4f16-8063-e22caf28f4a7&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset #initialization cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.KreskoAsset.initialize(name, symbol, 18, hre.addr.deployer, hre.Diamond.address, hre.ethers.constants.AddressZero, hre.addr.deployer, 0, 0)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;abd56d2f-0e19-4811-94cd-54d6cf11e03c&quot;,&quot;parentUUID&quot;:&quot;1826ac84-6363-4f16-8063-e22caf28f4a7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset #initialization cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;228afea6-0bc9-4a02-a2d4-638bd955b9f4&quot;,&quot;parentUUID&quot;:&quot;1826ac84-6363-4f16-8063-e22caf28f4a7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(name);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(symbol);\n(0, _chai.expect)(await f.KreskoAsset.kresko()).to.equal(hre.Diamond.address);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.Role.DEFAULT_ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.Role.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.hasRole(_roles.Role.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await f.KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await f.KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;018822b6-9153-4381-9a3c-964bf5bdb510&quot;,&quot;parentUUID&quot;:&quot;1826ac84-6363-4f16-8063-e22caf28f4a7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset KreskoAsset #initialization can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = &#x27;foo&#x27;;\nconst newSymbol = &#x27;bar&#x27;;\nawait (0, _chai.expect)(f.KreskoAsset.reinitializeERC20(newName, newSymbol, 2)).to.not.be.reverted;\n(0, _chai.expect)(await f.KreskoAsset.name()).to.equal(newName);\n(0, _chai.expect)(await f.KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6c83433-21eb-4771-b611-2c1a1bb150fd&quot;,&quot;parentUUID&quot;:&quot;1826ac84-6363-4f16-8063-e22caf28f4a7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;abd56d2f-0e19-4811-94cd-54d6cf11e03c&quot;,&quot;018822b6-9153-4381-9a3c-964bf5bdb510&quot;,&quot;e6c83433-21eb-4771-b611-2c1a1bb150fd&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;228afea6-0bc9-4a02-a2d4-638bd955b9f4&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:50,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;8b5d3cc8-c0a2-4be5-bbaf-ad671dcd2c79&quot;,&quot;e3962794-61e5-459d-9291-c2456df1ed4d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:36,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d076e148-2c70-4b32-880a-3528f2dbf232&quot;,&quot;title&quot;:&quot;#initialization - anchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.KreskoAssetAnchor.initialize(f.KreskoAsset.address, name, symbol, hre.addr.deployer)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;418bcdf5-bc8b-4986-8cf8-4cd2f176c440&quot;,&quot;parentUUID&quot;:&quot;d076e148-2c70-4b32-880a-3528f2dbf232&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await f.KreskoAssetAnchor.name()).to.equal(anchorName);\n(0, _chai.expect)(await f.KreskoAssetAnchor.symbol()).to.equal(anchorSymbol);\n(0, _chai.expect)(await f.KreskoAssetAnchor.asset()).to.equal(f.KreskoAsset.address);\n(0, _chai.expect)(await f.KreskoAssetAnchor.hasRole(_roles.Role.ADMIN, hre.addr.deployer)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAssetAnchor.hasRole(_roles.Role.OPERATOR, hre.Diamond.address)).to.equal(true);\n(0, _chai.expect)(await f.KreskoAssetAnchor.totalSupply()).to.equal(0);\n(0, _chai.expect)(await f.KreskoAssetAnchor.totalAssets()).to.equal(await f.KreskoAsset.totalSupply());\nconst rebaseInfo = await f.KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).to.equal(0);\n(0, _chai.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02096225-d021-4f65-91f9-b37312d63350&quot;,&quot;parentUUID&quot;:&quot;d076e148-2c70-4b32-880a-3528f2dbf232&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = await hre.deployments.get(anchorSymbol);\nconst implementationAddress = deployment.implementation;\n(0, _chai.expect)(implementationAddress).to.not.equal(hre.ethers.constants.AddressZero);\nconst KreskoAssetAnchorImpl = await hre.ethers.getContractAt(&#x27;KreskoAssetAnchor&#x27;, implementationAddress);\nawait (0, _chai.expect)(KreskoAssetAnchorImpl.initialize(f.KreskoAsset.address, name, symbol, hre.addr.deployer)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f26f7bd4-6fc4-4f95-9cba-974931c5d0ee&quot;,&quot;parentUUID&quot;:&quot;d076e148-2c70-4b32-880a-3528f2dbf232&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = &#x27;foo&#x27;;\nconst newSymbol = &#x27;bar&#x27;;\nawait (0, _chai.expect)(f.KreskoAssetAnchor.reinitializeERC20(newName, newSymbol, 2)).to.not.be.reverted;\n(0, _chai.expect)(await f.KreskoAssetAnchor.name()).to.equal(newName);\n(0, _chai.expect)(await f.KreskoAssetAnchor.symbol()).to.equal(newSymbol);\nawait f.KreskoAssetAnchor.reinitializeERC20(name, symbol, 3);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0cde65a4-a9f2-4036-b6e2-7b6868b4f774&quot;,&quot;parentUUID&quot;:&quot;d076e148-2c70-4b32-880a-3528f2dbf232&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;418bcdf5-bc8b-4986-8cf8-4cd2f176c440&quot;,&quot;02096225-d021-4f65-91f9-b37312d63350&quot;,&quot;f26f7bd4-6fc4-4f95-9cba-974931c5d0ee&quot;,&quot;0cde65a4-a9f2-4036-b6e2-7b6868b4f774&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:81,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c4d9d905-1457-4b86-8c60-7de28060713c&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;({ KreskoAsset } = await (0, _fixtures.kreskoAssetFixture)({\n    name: &#x27;Ether&#x27;,\n    symbol: &#x27;krETH&#x27;,\n    underlyingToken: _viem.zeroAddress\n}));\nthis.mintAmount = 125;\nthis.owner = hre.users.deployer;\nawait KreskoAsset.grantRole(_roles.Role.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff54c0c2-b309-4f69-9048-211aff7d27aa&quot;,&quot;parentUUID&quot;:&quot;c4d9d905-1457-4b86-8c60-7de28060713c&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;6704b32a-7b5e-4b95-9433-04100603c9bd&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to mint to their own address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the owner to mint to their own address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(this.owner.address, this.mintAmount);\n// Check total supply and owner&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;31af83b2-1e13-4815-b885-688e56b9af38&quot;,&quot;parentUUID&quot;:&quot;6704b32a-7b5e-4b95-9433-04100603c9bd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the asset owner to mint to another address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the asset owner to mint to another address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\nawait KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances increased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd6ea1d0-2d74-4568-8f96-adc8f05ebbe8&quot;,&quot;parentUUID&quot;:&quot;6704b32a-7b5e-4b95-9433-04100603c9bd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-owner addresses to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow non-owner addresses to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).mint(this.owner.address, this.mintAmount)).to.be.reverted;\n// Check total supply and all account balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95f0d816-a625-4d7a-ab9e-75f3245e3e41&quot;,&quot;parentUUID&quot;:&quot;6704b32a-7b5e-4b95-9433-04100603c9bd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow admin to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow admin to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.renounceRole(_roles.Role.OPERATOR, this.owner.address);\nawait (0, _chai.expect)(KreskoAsset.connect(this.owner).mint(this.owner.address, this.mintAmount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ad4a9810-43ae-46c3-9d3d-e4f6fb4b338f&quot;,&quot;parentUUID&quot;:&quot;6704b32a-7b5e-4b95-9433-04100603c9bd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;31af83b2-1e13-4815-b885-688e56b9af38&quot;,&quot;fd6ea1d0-2d74-4568-8f96-adc8f05ebbe8&quot;,&quot;95f0d816-a625-4d7a-ab9e-75f3245e3e41&quot;,&quot;ad4a9810-43ae-46c3-9d3d-e4f6fb4b338f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:61,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(this.owner).mint(hre.users.userOne.address, this.mintAmount);\nthis.owner = hre.users.deployer;\nthis.mintAmount = 125;\nawait KreskoAsset.grantRole(_roles.Role.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff1e913e-3855-4f8e-8676-9eab93af6886&quot;,&quot;parentUUID&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;00f44c4c-b0ba-424a-9037-a8069b21eee7&quot;,&quot;parentUUID&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(this.owner).approve(hre.users.userOne.address, this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);\nawait KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, _chai.expect)(await KreskoAsset.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that token allowances are unchanged\n(0, _chai.expect)(await KreskoAsset.allowance(this.owner.address, hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a72c27a6-60da-452e-a929-4c148cd065f4&quot;,&quot;parentUUID&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the operator to burn more tokens than user holds&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow the operator to burn more tokens than user holds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalance = await KreskoAsset.balanceOf(hre.users.userOne.address);\nconst overUserBalance = Number(userBalance) + 1;\nawait (0, _chai.expect)(KreskoAsset.connect(this.owner).burn(hre.users.userOne.address, overUserBalance)).to.be.reverted;\n// Check total supply and user&#x27;s balances are unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95797a30-faec-4fd9-9299-9a44b0e875f1&quot;,&quot;parentUUID&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-operator addresses to burn tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow non-operator addresses to burn tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(KreskoAsset.connect(hre.users.userTwo).burn(hre.users.userOne.address, this.mintAmount)).to.be.revertedWithCustomError(KreskoAsset, &#x27;AccessControlUnauthorizedAccount&#x27;).withArgs(hre.users.userTwo.address, _roles.Role.OPERATOR);\n// Check total supply and user&#x27;s balances unchanged\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(this.mintAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c509cf5a-bb5f-4557-9cd3-a48fa4d8d9e1&quot;,&quot;parentUUID&quot;:&quot;dba70661-c5c5-48ed-8642-ebe5db91e42d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;00f44c4c-b0ba-424a-9037-a8069b21eee7&quot;,&quot;a72c27a6-60da-452e-a929-4c148cd065f4&quot;,&quot;95797a30-faec-4fd9-9299-9a44b0e875f1&quot;,&quot;c509cf5a-bb5f-4557-9cd3-a48fa4d8d9e1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:63,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;429ef221-3218-4f93-8c40-11066901e31e&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1080,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const result = await hre.deployments.fixture(&#x27;diamond-init&#x27;);\nif (result.Diamond) {\n    hre.Diamond = await hre.getContractOrFork(&#x27;Kresko&#x27;);\n}\nKreskoAsset = (await (0, _createkrasset.createKrAsset)(&#x27;krSYMBOL&#x27;, &#x27;Kresko Asset: SYMBOL&#x27;, 18, _viem.zeroAddress)).KreskoAsset;\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_roles.Role.OPERATOR, hre.addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d103ce7c-75e8-4da0-b2eb-c962e0945ba6&quot;,&quot;parentUUID&quot;:&quot;429ef221-3218-4f93-8c40-11066901e31e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;7fca3da1-56a6-4711-ba95-522edb614a56&quot;,&quot;title&quot;:&quot;#rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can set a positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(&#x27;1.525&#x27;);\nconst positive = true;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;33376c83-7a69-4fb4-94dc-1f02fbb629dd&quot;,&quot;parentUUID&quot;:&quot;7fca3da1-56a6-4711-ba95-522edb614a56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can set a negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(&#x27;1.525&#x27;);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, _chai.expect)(rebaseInfo.denominator).equal(denominator);\n(0, _chai.expect)(rebaseInfo.positive).equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;86d0b29b-413a-4b50-bd6c-b97b159fc0bc&quot;,&quot;parentUUID&quot;:&quot;7fca3da1-56a6-4711-ba95-522edb614a56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can be disabled by setting the denominator to 1 ether&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can be disabled by setting the denominator to 1 ether&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = (0, _values.toBig)(1);\nconst positive = false;\nawait (0, _chai.expect)(KreskoAsset.rebase(denominator, positive, [])).to.not.be.reverted;\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f084bbbc-7435-4163-96e1-8fbb01882ada&quot;,&quot;parentUUID&quot;:&quot;7fca3da1-56a6-4711-ba95-522edb614a56&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;title&quot;:&quot;#balance + supply&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has no effect when not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply has no effect when not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAsset.isRebased()).to.equal(false);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f6d41845-73cb-4b5a-8a06-b87f1a1b6175&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cb02dd8c-24b0-4bbf-909c-033ea66e2dad&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e3bb4c6d-6894-4ca2-8a2a-236477c4b4ed&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase  @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase  @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = true;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.mul(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e2830ab7-8543-41b6-a1b6-0348365c676d&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1a84cdb1-803f-43fb-ae26-91a25a93d749&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57acb16b-09ac-4299-befd-49ef67791f77&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = false;\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(_mocks.defaultMintAmount.div(denominator));\n(0, _chai.expect)(await KreskoAsset.totalSupply()).to.equal(_mocks.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e1e911e1-389b-48b4-aea1-5cd5db39b1e9&quot;,&quot;parentUUID&quot;:&quot;a9c7058a-118c-4b18-8b2b-50ec6f5df4ba&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f6d41845-73cb-4b5a-8a06-b87f1a1b6175&quot;,&quot;cb02dd8c-24b0-4bbf-909c-033ea66e2dad&quot;,&quot;e3bb4c6d-6894-4ca2-8a2a-236477c4b4ed&quot;,&quot;e2830ab7-8543-41b6-a1b6-0348365c676d&quot;,&quot;1a84cdb1-803f-43fb-ae26-91a25a93d749&quot;,&quot;57acb16b-09ac-4299-befd-49ef67791f77&quot;,&quot;e1e911e1-389b-48b4-aea1-5cd5db39b1e9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:100,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;title&quot;:&quot;#transfer&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has default transfer behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;27aa38e1-8dd2-4b5e-baf6-c3a04833b43b&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transfer behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.transfer(hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fab8a8ef-9a01-488c-8910-537c71262057&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9045dca0-3db1-412b-b9bd-bbb388ecc04e&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 100;\nconst positive = true;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce05a615-2d3c-463d-b78c-c438ea5aee54&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ec79a3c4-c6a4-4fef-8e68-85d2ad02d0e2&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = (0, _values.toBig)(1);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\nawait KreskoAsset.mint(hre.addr.userOne, _mocks.defaultMintAmount);\nconst denominator = 100;\nconst positive = false;\nawait KreskoAsset.rebase((0, _values.toBig)(denominator), positive, []);\nawait KreskoAsset.approve(hre.addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = _mocks.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount);\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, _chai.expect)(await KreskoAsset.balanceOf(hre.addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, _chai.expect)(KreskoAsset.connect(hre.users.userOne).transferFrom(hre.addr.deployer, hre.addr.userOne, transferAmount)).to.be.reverted;\n(0, _chai.expect)(await KreskoAsset.allowance(hre.addr.deployer, hre.addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c65dba1-ac18-4550-b6b5-df55898f4077&quot;,&quot;parentUUID&quot;:&quot;b19a6c92-a55b-46c5-bfd2-39904e27b042&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;27aa38e1-8dd2-4b5e-baf6-c3a04833b43b&quot;,&quot;fab8a8ef-9a01-488c-8910-537c71262057&quot;,&quot;9045dca0-3db1-412b-b9bd-bbb388ecc04e&quot;,&quot;ce05a615-2d3c-463d-b78c-c438ea5aee54&quot;,&quot;ec79a3c4-c6a4-4fef-8e68-85d2ad02d0e2&quot;,&quot;5c65dba1-ac18-4550-b6b5-df55898f4077&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:198,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;33376c83-7a69-4fb4-94dc-1f02fbb629dd&quot;,&quot;86d0b29b-413a-4b50-bd6c-b97b159fc0bc&quot;,&quot;f084bbbc-7435-4163-96e1-8fbb01882ada&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:28,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0c56fe97-7ddd-4414-a6b1-e032223c7a6a&quot;,&quot;title&quot;:&quot;KreskoAssetAnchor&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:806,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const result = await hre.deployments.fixture(&#x27;diamond-init&#x27;);\nif (result.Diamond) {\n    hre.Diamond = await hre.getContractOrFork(&#x27;Kresko&#x27;);\n}\nconst deployments = await (0, _createkrasset.createKrAsset)(&#x27;krSYMBOL&#x27;, &#x27;Kresko Asset: SYMBOL&#x27;, 18, _viem.zeroAddress);\nKreskoAsset = deployments.KreskoAsset;\nKreskoAssetAnchor = deployments.KreskoAssetAnchor;\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(_roles.Role.OPERATOR, hre.addr.deployer);\n// Grant minting rights for test deployer\nawait Promise.all([\n    KreskoAsset.grantRole(_roles.Role.OPERATOR, hre.addr.deployer),\n    KreskoAssetAnchor.grantRole(_roles.Role.OPERATOR, hre.addr.deployer),\n    KreskoAsset.approve(KreskoAssetAnchor.address, hre.ethers.constants.MaxUint256)\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3f0b11b8-9f31-4a35-8095-ed72605f7e60&quot;,&quot;parentUUID&quot;:&quot;0c56fe97-7ddd-4414-a6b1-e032223c7a6a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;title&quot;:&quot;#minting and burning&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;tracks the supply of underlying&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning tracks the supply of underlying&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\nawait KreskoAsset.mint(hre.addr.deployer, _mocks.defaultMintAmount);\n(0, _chai.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(_mocks.defaultMintAmount.add(_mocks.defaultMintAmount));\n(0, _chai.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a9ae084-a739-4333-a312-b5e04f5872cf&quot;,&quot;parentUUID&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning mints 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;92f70022-85d2-4e87-9075-2120cd7e1bc0&quot;,&quot;parentUUID&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning deposits 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0d263baf-67cb-484c-89ce-595a8dff5947&quot;,&quot;parentUUID&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;redeems 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning redeems 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e77aa4d-ec23-4212-bb9c-8fa8557cb44e&quot;,&quot;parentUUID&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;withdraws 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning withdraws 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f796405b-e922-4029-ab60-4f7d6defc570&quot;,&quot;parentUUID&quot;:&quot;40ce9b36-c4d6-4fe9-84ae-5267a31b24ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f26145bd-e65b-43c2-9f20-862620af55b3&quot;,&quot;title&quot;:&quot;#rebases&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;title&quot;:&quot;#conversions&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b9204a43-eb12-4f4c-88a9-26122480c008&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4f876f89-5fe4-4bc5-aa16-e5a2864666c4&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;41e5af64-f5da-4f99-828c-cc15a20a7684&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;83eb74a8-8509-4723-bd7d-8baeaaff9189&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7ea8d809-51be-4464-aef7-b614b0ab920d&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae149fcb-5fef-4c64-bf27-71f66e1b90f8&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d41d83c9-a633-4fa8-a97a-8d3ecc563f04&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c04f28eb-70ab-4d34-b1c1-e0c1b6acaeb5&quot;,&quot;parentUUID&quot;:&quot;12321a6a-2dd1-4c9d-beac-5e4952f3adf3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;b9204a43-eb12-4f4c-88a9-26122480c008&quot;,&quot;4f876f89-5fe4-4bc5-aa16-e5a2864666c4&quot;,&quot;41e5af64-f5da-4f99-828c-cc15a20a7684&quot;,&quot;83eb74a8-8509-4723-bd7d-8baeaaff9189&quot;,&quot;7ea8d809-51be-4464-aef7-b614b0ab920d&quot;,&quot;ae149fcb-5fef-4c64-bf27-71f66e1b90f8&quot;,&quot;d41d83c9-a633-4fa8-a97a-8d3ecc563f04&quot;,&quot;c04f28eb-70ab-4d34-b1c1-e0c1b6acaeb5&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;4a9ae084-a739-4333-a312-b5e04f5872cf&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;92f70022-85d2-4e87-9075-2120cd7e1bc0&quot;,&quot;0d263baf-67cb-484c-89ce-595a8dff5947&quot;,&quot;1e77aa4d-ec23-4212-bb9c-8fa8557cb44e&quot;,&quot;f796405b-e922-4029-ab60-4f7d6defc570&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:22,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;1385c657-0f69-431c-81a5-22b938f91a4f&quot;,&quot;title&quot;:&quot;Test KreskoAsset with Rebase and sync&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/04-krasset-sync-rebase.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with no sync of uniswap pools - Reserves not updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3b71555-e710-4573-b97d-29a453b7c10c&quot;,&quot;parentUUID&quot;:&quot;1385c657-0f69-431c-81a5-22b938f91a4f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;fullTitle&quot;:&quot;Test KreskoAsset with Rebase and sync Rebases the asset with sync of uniswap pools - Reserve should be updated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;07aa6517-c81b-42e2-99c8-3e679d2e6a01&quot;,&quot;parentUUID&quot;:&quot;1385c657-0f69-431c-81a5-22b938f91a4f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;f3b71555-e710-4573-b97d-29a453b7c10c&quot;,&quot;07aa6517-c81b-42e2-99c8-3e679d2e6a01&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;de5e6d5d-8226-4d87-a514-866fab11fbab&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:42,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;operator = hre.users.deployer;\nuser = hre.users.userOne;\ntreasury = hre.addr.treasury;\n({ KreskoAsset } = await (0, _fixtures.kreskoAssetFixture)({\n    name: &#x27;Ether&#x27;,\n    symbol: &#x27;krETH&#x27;\n}));\n// Deploy WETH\nWETH = await hre.ethers.deployContract(&#x27;WETH9&#x27;);\n// Give WETH to deployer\nawait WETH.connect(user).deposit({\n    value: (0, _values.toBig)(100)\n});\nawait KreskoAsset.connect(hre.users.deployer).grantRole(_roles.Role.OPERATOR, operator.address);\nawait KreskoAsset.connect(hre.users.deployer).setUnderlying(WETH.address);\n// Approve WETH for KreskoAsset\nawait WETH.connect(user).approve(KreskoAsset.address, hre.ethers.constants.MaxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9975af8a-816d-4c59-974c-b83e5a9b0936&quot;,&quot;parentUUID&quot;:&quot;de5e6d5d-8226-4d87-a514-866fab11fbab&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;title&quot;:&quot;Deposit / Wrap&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cannot deposit when paused&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Deposit / Wrap cannot deposit when paused&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(operator).pause();\nawait (0, _chai.expect)(KreskoAsset.wrap(user.address, (0, _values.toBig)(10))).to.be.revertedWithCustomError(KreskoAsset, &#x27;EnforcedPause&#x27;);\nawait KreskoAsset.connect(operator).unpause();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;19d72954-3693-44e0-88cf-f7d7f0029337&quot;,&quot;parentUUID&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can deposit with token&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Deposit / Wrap can deposit with token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(user).wrap(user.address, (0, _values.toBig)(10));\n(0, _chai.expect)(await KreskoAsset.balanceOf(user.address)).to.equal((0, _values.toBig)(10));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;272e0e6f-c752-40ea-98e7-232fde111418&quot;,&quot;parentUUID&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot deposit native token if not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Deposit / Wrap cannot deposit native token if not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(user.sendTransaction({\n    to: KreskoAsset.address,\n    value: (0, _values.toBig)(10)\n})).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;20e43f71-ba84-4972-ae17-a3a510ede58b&quot;,&quot;parentUUID&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can deposit native token if enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Deposit / Wrap can deposit native token if enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:73,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(operator).enableNativeUnderlying(true);\nconst prevBalance = await KreskoAsset.balanceOf(user.address);\nawait user.sendTransaction({\n    to: KreskoAsset.address,\n    value: (0, _values.toBig)(10)\n});\nconst currentBalance = await KreskoAsset.balanceOf(user.address);\n(0, _chai.expect)(currentBalance.sub(prevBalance)).to.equal((0, _values.toBig)(10));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a7e1d16-acff-4d5b-bb3b-bded85815e2e&quot;,&quot;parentUUID&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;transfers the correct fees to feeRecipient&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Deposit / Wrap transfers the correct fees to feeRecipient&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:141,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(operator).setOpenFee(0.1e4);\nawait KreskoAsset.connect(operator).enableNativeUnderlying(true);\nlet prevBalanceDevOne = await KreskoAsset.balanceOf(user.address);\nconst treasuryWETHBal = await WETH.balanceOf(treasury);\nawait KreskoAsset.connect(user).wrap(user.address, (0, _values.toBig)(10));\nlet currentBalanceDevOne = await KreskoAsset.balanceOf(user.address);\nconst currentWETHBalanceTreasury = await WETH.balanceOf(treasury);\n(0, _chai.expect)(currentBalanceDevOne.sub(prevBalanceDevOne)).to.equal((0, _values.toBig)(9));\n(0, _chai.expect)(currentWETHBalanceTreasury.sub(treasuryWETHBal)).to.equal((0, _values.toBig)(1));\nprevBalanceDevOne = await KreskoAsset.balanceOf(user.address);\nconst prevBalanceTreasury = await hre.ethers.provider.getBalance(treasury);\nawait user.sendTransaction({\n    to: KreskoAsset.address,\n    value: (0, _values.toBig)(10)\n});\ncurrentBalanceDevOne = await KreskoAsset.balanceOf(user.address);\nconst currentBalanceTreasury = await hre.ethers.provider.getBalance(treasury);\n(0, _chai.expect)(currentBalanceDevOne.sub(prevBalanceDevOne)).to.equal((0, _values.toBig)(9));\n(0, _chai.expect)(currentBalanceTreasury.sub(prevBalanceTreasury)).to.equal((0, _values.toBig)(1));\n// Set openfee to 0\nawait KreskoAsset.connect(operator).setOpenFee(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2b8018c-21e6-48fd-819b-22d3a75e6ea3&quot;,&quot;parentUUID&quot;:&quot;0f5d37b6-633a-42fa-8441-ddff3c0583f7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;19d72954-3693-44e0-88cf-f7d7f0029337&quot;,&quot;272e0e6f-c752-40ea-98e7-232fde111418&quot;,&quot;20e43f71-ba84-4972-ae17-a3a510ede58b&quot;,&quot;4a7e1d16-acff-4d5b-bb3b-bded85815e2e&quot;,&quot;b2b8018c-21e6-48fd-819b-22d3a75e6ea3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:245,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;title&quot;:&quot;Withdraw / Unwrap&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/05-krasset-wrap.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Withdraw / Unwrap\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Withdraw / Unwrap \&quot;before each\&quot; hook in \&quot;Withdraw / Unwrap\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit some tokens here\nawait KreskoAsset.connect(user).wrap(user.address, (0, _values.toBig)(10));\nawait KreskoAsset.connect(operator).enableNativeUnderlying(true);\nawait user.sendTransaction({\n    to: KreskoAsset.address,\n    value: (0, _values.toBig)(100)\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a9d12ef1-dcdd-4426-b0b7-57f8c3147e25&quot;,&quot;parentUUID&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cannot withdraw when paused&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Withdraw / Unwrap cannot withdraw when paused&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(operator).pause();\nawait (0, _chai.expect)(KreskoAsset.connect(user).unwrap(user.address, (0, _values.toBig)(1), false)).to.be.revertedWithCustomError(KreskoAsset, &#x27;EnforcedPause&#x27;);\nawait KreskoAsset.connect(operator).unpause();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;184c3159-5b24-4c9a-89de-273fe25261e0&quot;,&quot;parentUUID&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can withdraw&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Withdraw / Unwrap can withdraw&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const prevBalance = await WETH.balanceOf(user.address);\nawait KreskoAsset.connect(user).unwrap(user.address, (0, _values.toBig)(1), false);\nconst currentBalance = await WETH.balanceOf(user.address);\n(0, _chai.expect)(currentBalance).to.equal((0, _values.toBig)(1).add(prevBalance));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;49d6de05-0337-442c-a5e7-5c2a38503fe0&quot;,&quot;parentUUID&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can withdraw native token if enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Withdraw / Unwrap can withdraw native token if enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.connect(operator).enableNativeUnderlying(true);\nconst prevBalance = await KreskoAsset.balanceOf(user.address);\nawait KreskoAsset.connect(user).unwrap(user.address, (0, _values.toBig)(1), true);\nconst currentBalance = await KreskoAsset.balanceOf(user.address);\n(0, _chai.expect)(prevBalance.sub(currentBalance)).to.equal((0, _values.toBig)(1));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;07a24b70-c991-4cdf-bbe6-b446c7b9a795&quot;,&quot;parentUUID&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;transfers the correct fees to feeRecipient&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset Withdraw / Unwrap transfers the correct fees to feeRecipient&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// set close fee to 10%\nawait KreskoAsset.connect(operator).setCloseFee(0.1e4);\nconst prevBalanceDevOne = await WETH.balanceOf(user.address);\nlet prevBalanceTreasury = await WETH.balanceOf(treasury);\nawait KreskoAsset.connect(user).unwrap(user.address, (0, _values.toBig)(9), false);\nconst currentBalanceDevOne = await WETH.balanceOf(user.address);\nlet currentBalanceTreasury = await WETH.balanceOf(treasury);\n(0, _chai.expect)(currentBalanceDevOne.sub(prevBalanceDevOne)).to.equal((0, _values.toBig)(8.1));\n(0, _chai.expect)(currentBalanceTreasury.sub(prevBalanceTreasury)).to.equal((0, _values.toBig)(0.9));\n// Withdraw native token and check if fee is transferred\nawait user.sendTransaction({\n    to: KreskoAsset.address,\n    value: (0, _values.toBig)(10)\n});\nprevBalanceTreasury = await hre.ethers.provider.getBalance(treasury);\nawait KreskoAsset.connect(user).unwrap(user.address, (0, _values.toBig)(9), true);\ncurrentBalanceTreasury = await hre.ethers.provider.getBalance(treasury);\n(0, _chai.expect)(currentBalanceTreasury.sub(prevBalanceTreasury)).to.equal((0, _values.toBig)(0.9));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3edc67a3-6aca-4237-8387-1fee41f99675&quot;,&quot;parentUUID&quot;:&quot;24c67d3f-394a-400a-8bbe-8c95bec00ec8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;184c3159-5b24-4c9a-89de-273fe25261e0&quot;,&quot;49d6de05-0337-442c-a5e7-5c2a38503fe0&quot;,&quot;07a24b70-c991-4cdf-bbe6-b446c7b9a795&quot;,&quot;3edc67a3-6aca-4237-8387-1fee41f99675&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:172,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b98f7730-b9b9-43fc-9b48-3a56a14e2065&quot;,&quot;title&quot;:&quot;Minter - Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration \&quot;before each\&quot; hook in \&quot;Minter - Configuration\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6ed5e4a4-12c7-4b6f-b4ed-82d14a69ba96&quot;,&quot;parentUUID&quot;:&quot;b98f7730-b9b9-43fc-9b48-3a56a14e2065&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;title&quot;:&quot;#configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can modify all parameters&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can modify all parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = (0, _mocks.testMinterParams)(hre.users.treasury.address);\nawait (0, _chai.expect)(hre.Diamond.setMinCollateralRatioMinter(update.minCollateralRatio)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.setLiquidationThresholdMinter(update.liquidationThreshold)).to.not.be.reverted;\nawait (0, _chai.expect)(hre.Diamond.setMaxLiquidationRatioMinter(update.maxLiquidationRatio)).to.not.be.reverted;\nconst params = await hre.Diamond.getParametersMinter();\n(0, _chai.expect)(update.minCollateralRatio).to.equal(params.minCollateralRatio);\n(0, _chai.expect)(update.maxLiquidationRatio).to.equal(params.maxLiquidationRatio);\n(0, _chai.expect)(update.liquidationThreshold).to.equal(params.liquidationThreshold);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1af24767-590d-4bc9-ae3f-213f5647a0c5&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:767,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract } = await (0, _collaterals.addMockExtAsset)(_mocks.testCollateralConfig);\n(0, _chai.expect)(await hre.Diamond.getCollateralExists(contract.address)).to.equal(true);\nconst priceOfOne = await hre.Diamond.getValue(contract.address, (0, _values.toBig)(1));\n(0, _chai.expect)(Number(priceOfOne)).to.equal((0, _values.toBig)(_mocks.testCollateralConfig.price, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;26e8f9e6-24e0-472f-a62f-7b928e639d5a&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can add a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2022,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract, assetInfo } = await (0, _krassets.addMockKreskoAsset)({\n    ..._mocks.testKrAssetConfig,\n    name: &#x27;Kresko Asset: 5&#x27;,\n    symbol: &#x27;KrAsset5&#x27;,\n    ticker: &#x27;KrAsset5&#x27;\n});\nconst values = await assetInfo();\nconst kreskoPriceAnswer = (0, _values.fromBig)(await hre.Diamond.getValue(contract.address, (0, _values.toBig)(1)), 8);\nconst config = _mocks.testKrAssetConfig.krAssetConfig;\n(0, _chai.expect)(values.isMinterMintable).to.equal(true);\n(0, _chai.expect)(values.kFactor).to.equal(config.kFactor);\n(0, _chai.expect)(kreskoPriceAnswer).to.equal(_mocks.testKrAssetConfig.price);\n(0, _chai.expect)(values.maxDebtMinter).to.equal(config.maxDebtMinter);\n(0, _chai.expect)(values.closeFee).to.equal(config.closeFee);\n(0, _chai.expect)(values.openFee).to.equal(config.openFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb9b939c-eae7-45e3-8809-72a9a368286e&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update default oracle precision decimals&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update default oracle precision decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const decimals = 8;\nawait hre.Diamond.setDefaultOraclePrecision(decimals);\n(0, _chai.expect)(await hre.Diamond.getDefaultOraclePrecision()).to.equal(decimals);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;157b5d44-0b5c-4f51-babc-688e395b4436&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update minter max liquidation ratio&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update minter max liquidation ratio&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentMLM = await hre.Diamond.getMaxLiquidationRatioMinter();\nconst newMLR = 1.42e4;\n(0, _chai.expect)(currentMLM).to.not.eq(newMLR);\nawait (0, _chai.expect)(hre.Diamond.setMaxLiquidationRatioMinter(newMLR)).to.not.be.reverted;\n(0, _chai.expect)(await hre.Diamond.getMaxLiquidationRatioMinter()).to.eq(newMLR);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9e29ba7a-28db-4f1d-8554-67fc712a449b&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update global oracle deviation pct&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update global oracle deviation pct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currentDeviationPct = await hre.Diamond.getOracleDeviationPct();\nconst newDeviationPct = 0.03e4;\n(0, _chai.expect)(currentDeviationPct).to.not.equal(newDeviationPct);\nawait (0, _chai.expect)(hre.Diamond.setMaxPriceDeviationPct(newDeviationPct)).to.not.be.reverted;\n(0, _chai.expect)(await hre.Diamond.getOracleDeviationPct()).to.equal(newDeviationPct);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f08cfcf-6d18-40a6-83e4-a67c89e0fc47&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update kFactor of a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update kFactor of a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getAsset(f.KrAsset.address)).kFactor;\nconst newRatio = 1.2e4;\n(0, _chai.expect)(oldRatio === newRatio).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.setAssetKFactor(f.KrAsset.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getAsset(f.KrAsset.address)).kFactor === newRatio).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b2a100f-2ade-4ca2-8469-bd577480b401&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update cFactor of a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update cFactor of a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oldRatio = (await hre.Diamond.getAsset(f.Collateral.address)).factor;\nconst newRatio = 0.9e4;\n(0, _chai.expect)(oldRatio === newRatio).to.be.false;\nawait (0, _chai.expect)(hre.Diamond.setAssetCFactor(f.Collateral.address, newRatio)).to.not.be.reverted;\n(0, _chai.expect)((await hre.Diamond.getAsset(f.Collateral.address)).factor === newRatio).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;30a7516c-569a-4485-8897-303904702e1e&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update configuration of an asset&quot;,&quot;fullTitle&quot;:&quot;Minter - Configuration #configuration can update configuration of an asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:240,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const oracleAnswer = (0, _values.fromBig)((await f.KrAsset.priceFeed.latestRoundData())[1], 8);\nconst priceOfOne = (0, _values.fromBig)(await hre.Diamond.getValue(f.KrAsset.address, (0, _values.toBig)(1)), 8);\n(0, _chai.expect)(oracleAnswer).to.equal(priceOfOne);\n(0, _chai.expect)(oracleAnswer).to.equal(_mocks.testKrAssetConfig.price);\nconst update = {\n    kFactor: 1.2e4,\n    maxDebtMinter: (0, _values.toBig)(12000),\n    closeFee: 0.03e4,\n    openFee: 0.03e4,\n    anchor: f.KrAsset.anchor.address\n};\nconst FakeFeed = await (0, _oracle.createOracles)(hre, f.KrAsset.pythId.toString(), 20);\nconst newConfig = await (0, _general.getAssetConfig)(f.KrAsset.contract, {\n    ..._mocks.testKrAssetConfig,\n    feed: FakeFeed.address,\n    price: 20,\n    krAssetConfig: update\n});\nawait hre.Diamond.setFeedsForTicker(newConfig.assetStruct.ticker, newConfig.feedConfig);\nawait hre.Diamond.connect(hre.users.deployer).updateAsset(f.KrAsset.address, newConfig.assetStruct);\nconst newValues = await hre.Diamond.getAsset(f.KrAsset.address);\nconst updatedOracleAnswer = (0, _values.fromBig)((await FakeFeed.latestRoundData())[1], 8);\nconst newPriceOfOne = (0, _values.fromBig)(await hre.Diamond.getValue(f.KrAsset.address, (0, _values.toBig)(1)), 8);\n(0, _chai.expect)(newValues.isMinterMintable).to.equal(true);\n(0, _chai.expect)(newValues.isMinterCollateral).to.equal(false);\n(0, _chai.expect)(newValues.kFactor).to.equal(update.kFactor);\n(0, _chai.expect)(newValues.maxDebtMinter).to.equal(update.maxDebtMinter);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(newPriceOfOne);\n(0, _chai.expect)(updatedOracleAnswer).to.equal(20);\nconst update2 = {\n    ...await hre.Diamond.getAsset(f.KrAsset.address),\n    kFactor: 1.75e4,\n    maxDebtMinter: (0, _values.toBig)(12000),\n    closeFee: 0.052e4,\n    openFee: 0.052e4,\n    isSwapMintable: true,\n    swapInFeeSCDP: 0.052e4,\n    liqIncentiveSCDP: 1.1e4,\n    anchor: f.KrAsset.anchor.address\n};\nawait hre.Diamond.updateAsset(f.KrAsset.address, update2);\nconst newValues2 = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(newValues2.isMinterMintable).to.equal(true);\n(0, _chai.expect)(newValues2.isSharedOrSwappedCollateral).to.equal(true);\n(0, _chai.expect)(newValues2.isSwapMintable).to.equal(true);\n(0, _chai.expect)(newValues2.isMinterCollateral).to.equal(false);\n(0, _chai.expect)(newValues2.isSharedCollateral).to.equal(false);\n(0, _chai.expect)(newValues2.isCoverAsset).to.equal(false);\n(0, _chai.expect)(newValues2.kFactor).to.equal(update2.kFactor);\n(0, _chai.expect)(newValues2.openFee).to.equal(update2.closeFee);\n(0, _chai.expect)(newValues2.closeFee).to.equal(update2.openFee);\n(0, _chai.expect)(newValues2.swapInFeeSCDP).to.equal(update2.swapInFeeSCDP);\n(0, _chai.expect)(newValues2.maxDebtMinter).to.equal(update2.maxDebtMinter);\nawait f.KrAsset.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95703142-31a0-48d3-a3b6-fddb790cb15c&quot;,&quot;parentUUID&quot;:&quot;44afae44-804a-4fc2-befc-e82098db9840&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1af24767-590d-4bc9-ae3f-213f5647a0c5&quot;,&quot;26e8f9e6-24e0-472f-a62f-7b928e639d5a&quot;,&quot;eb9b939c-eae7-45e3-8809-72a9a368286e&quot;,&quot;157b5d44-0b5c-4f51-babc-688e395b4436&quot;,&quot;9e29ba7a-28db-4f1d-8554-67fc712a449b&quot;,&quot;9f08cfcf-6d18-40a6-83e4-a67c89e0fc47&quot;,&quot;8b2a100f-2ade-4ca2-8469-bd577480b401&quot;,&quot;30a7516c-569a-4485-8897-303904702e1e&quot;,&quot;95703142-31a0-48d3-a3b6-fddb790cb15c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3118,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d8352fef-a4f3-4c80-99fd-a5f2f66c8098&quot;,&quot;title&quot;:&quot;Minter - Deposit Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw \&quot;before each\&quot; hook in \&quot;Minter - Deposit Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.depositWithdrawFixture)();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8fe207d1-496a-4444-83c9-36e353ad43d0&quot;,&quot;parentUUID&quot;:&quot;d8352fef-a4f3-4c80-99fd-a5f2f66c8098&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3c4adb5f-a0f9-45ae-a3e8-bf50281fa568&quot;,&quot;title&quot;:&quot;#collateral&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;title&quot;:&quot;#deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts withdraws of krAsset collateral when deposits go below MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:80,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _values.toBig)(100);\nawait f.KrAssetCollateral.setBalance(f.user, collateralAmount, _hardhat.default.Diamond.address);\nconst depositAmount = collateralAmount.div(2);\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, depositAmount);\n// Rebase the asset according to params\nconst denominator = 4;\nconst positive = true;\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst rebasedDepositAmount = depositAmount.mul(denominator);\nconst withdrawAmount = rebasedDepositAmount.sub(9e11.toString());\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountCollateralAssets(f.user.address)).to.include(f.KrAssetCollateral.address);\nawait (0, _chai.expect)(f.User.withdrawCollateral({\n    account: f.user.address,\n    asset: f.KrAssetCollateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 0,\n    receiver: f.user.address\n}, await _hardhat.default.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;COLLATERAL_AMOUNT_LOW&#x27;).withArgs(f.KrAssetCollateral.errorId, 9e11, 1e12);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2bda1703-ee4f-451b-94d1-3008a1a446ed&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit reverts deposits of krAsset collateral for less than MIN_KRASSET_COLLATERAL_AMOUNT&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmount = (0, _values.toBig)(100);\nawait f.KrAssetCollateral.setBalance(f.user, collateralAmount, _hardhat.default.Diamond.address);\nawait (0, _chai.expect)(f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, 9e11.toString())).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;COLLATERAL_AMOUNT_LOW&#x27;).withArgs(f.KrAssetCollateral.errorId, 9e11, 1e12);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d4e94918-9e84-4037-a0e8-3df45dfddcfb&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit whitelisted collateral&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit whitelisted collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Account has deposit entry\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(f.depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Account&#x27;s collateral deposit balances have increased\n(0, _chai.expect)(await _hardhat.default.Diamond.getAccountCollateralAmount(f.depositor.address, f.Collateral.address)).to.equal(f.initialDeposits);\n// Kresko&#x27;s balance has increased\n(0, _chai.expect)(await f.Collateral.balanceOf(_hardhat.default.Diamond.address)).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Account&#x27;s balance has decreased\n(0, _chai.expect)((0, _values.fromBig)(await f.Collateral.balanceOf(f.depositor.address))).to.equal((0, _values.fromBig)(f.initialBalance) - (0, _values.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aa853ba3-4a01-4c3a-bc30-b7aa88afd1b3&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the f.user&#x27;s deposited collateral assets should be empty.\nconst depositedCollateralAssetsBefore = await _hardhat.default.Diamond.getAccountCollateralAssets(f.user.address);\n(0, _chai.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral, from f.depositor -&gt; f.user.\nawait (0, _chai.expect)(f.Depositor.depositCollateral(f.user.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the f.user&#x27;s deposited collateral assets has been pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(f.user.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the f.user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits);\n// Confirm the amount as been transferred from the f.user into Kresko.sol\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.add(f.initialDeposits));\n// Confirm the f.depositor&#x27;s wallet balance has been adjusted accordingly\nconst depositorBalanceAfter = await f.Collateral.balanceOf(f.depositor.address);\n(0, _chai.expect)((0, _values.fromBig)(depositorBalanceAfter)).to.equal((0, _values.fromBig)(f.initialBalance) - (0, _values.fromBig)(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;023b9281-df84-41c9-9b6f-852fda21d530&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit more collateral to an existing deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to deposit more collateral to an existing deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit first batch of collateral\nawait (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit second batch of collateral\nawait (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the f.user&#x27;s deposited collateral assets hasn&#x27;t been double-pushed to.\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(f.depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address\n]);\n// Confirm the amount deposited is recorded for the f.user.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(f.depositor.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.add(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;df287538-5349-48e7-b9a8-1b5872a8470f&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to have deposited multiple collateral assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should allow an account to have deposited multiple collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load f.user account with a different type of collateral\nawait f.Collateral2.setBalance(f.depositor, f.initialBalance, _hardhat.default.Diamond.address);\n// Deposit batch of first collateral type\nawait (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, f.initialDeposits)).not.to.be.reverted;\n// Deposit batch of second collateral type\nawait (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral2.address, f.initialDeposits)).not.to.be.reverted;\n// Confirm the array of the f.user&#x27;s deposited collateral assets contains both collateral assets\nconst depositedCollateralAssetsAfter = await _hardhat.default.Diamond.getAccountCollateralAssets(f.depositor.address);\n(0, _chai.expect)(depositedCollateralAssetsAfter).to.deep.equal([\n    f.Collateral.address,\n    f.Collateral2.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;40a123d3-0b8e-4d76-aa9a-dd5856bec17a&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralDeposited event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should emit CollateralDeposited event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:14,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, f.initialDeposits);\nconst event = await (0, _events.getInternalEvent)(tx, _hardhat.default.Diamond, &#x27;CollateralDeposited&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.depositor.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;881c7e13-fd4d-4ac7-abaa-aefd53a5a318&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing collateral that has not been whitelisted&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing collateral that has not been whitelisted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, &#x27;0x0000000000000000000000000000000000000001&#x27;, f.initialDeposits)).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ASSET_NOT_MINTER_COLLATERAL&#x27;).withArgs([\n    &#x27;&#x27;,\n    &#x27;0x0000000000000000000000000000000000000001&#x27;\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ca2c9c0-73c1-410a-81d3-04119cb7bbdd&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if depositing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Depositor.depositCollateral(f.depositor.address, f.Collateral.address, 0)).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ZERO_DEPOSIT&#x27;).withArgs(f.Collateral.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;737b4871-6cfc-49c3-abcb-e239e6513977&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if collateral is not depositable&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit should revert if collateral is not depositable&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:46,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { deployer, devOne, extOne } = await _hardhat.default.ethers.getNamedSigners();\nawait (0, _execution.executeContractCallWithSigners)(_hardhat.default.Multisig, _hardhat.default.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    true,\n    0\n], [\n    deployer,\n    devOne,\n    extOne\n]);\nconst isDepositPaused = await _hardhat.default.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isDepositPaused).to.equal(true);\nawait (0, _chai.expect)(_hardhat.default.Diamond.connect(f.depositor).depositCollateral(f.depositor.address, f.Collateral.contract.address, 0)).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ASSET_PAUSED_FOR_THIS_ACTION&#x27;).withArgs(f.Collateral.errorId, _types.Action.DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2df66f7-d930-46f7-b4bb-a9081d9cfa9a&quot;,&quot;parentUUID&quot;:&quot;c00c3866-e712-44c1-8c03-40bf36e6f474&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2bda1703-ee4f-451b-94d1-3008a1a446ed&quot;,&quot;d4e94918-9e84-4037-a0e8-3df45dfddcfb&quot;,&quot;aa853ba3-4a01-4c3a-bc30-b7aa88afd1b3&quot;,&quot;023b9281-df84-41c9-9b6f-852fda21d530&quot;,&quot;df287538-5349-48e7-b9a8-1b5872a8470f&quot;,&quot;40a123d3-0b8e-4d76-aa9a-dd5856bec17a&quot;,&quot;881c7e13-fd4d-4ac7-abaa-aefd53a5a318&quot;,&quot;2ca2c9c0-73c1-410a-81d3-04119cb7bbdd&quot;,&quot;737b4871-6cfc-49c3-abcb-e239e6513977&quot;,&quot;b2df66f7-d930-46f7-b4bb-a9081d9cfa9a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:273,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;25c899ca-c497-46b0-bdb3-a1e40c8d5901&quot;,&quot;title&quot;:&quot;#withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their entire deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw their entire deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(f.withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: f.initialDeposits,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Ensure that the collateral asset is removed from the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssetsPostWithdraw = await _hardhat.default.Diamond.getAccountCollateralAssets(f.withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssetsPostWithdraw).to.deep.equal([]);\n// Ensure the change in the f.user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(0);\n// Ensure the amount transferred is correct\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(0);\nconst userOneBalance = await f.Collateral.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c258c13b-ff92-4300-bd67-0ed731bbc3db&quot;,&quot;parentUUID&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to withdraw a portion of their deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw a portion of their deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:65,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Ensure the change in the f.user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(f.withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst userOneBalance = await f.Collateral.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(userOneBalance).to.equal(f.initialDeposits.sub(amountDeposited));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c09fcca5-0012-4fbc-8c51-ddeb48a145ef&quot;,&quot;parentUUID&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow trusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait _hardhat.default.Diamond.grantRole(_roles.Role.MANAGER, f.user.address);\n(0, _chai.expect)(await _hardhat.default.Diamond.hasRole(_roles.Role.MANAGER, f.user.address)).to.equal(true);\nconst collateralBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\nawait (0, _chai.expect)(f.User.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: f.initialDeposits,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData())).to.not.be.reverted;\nconst collateralAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\n// Ensure that collateral was withdrawn\n(0, _chai.expect)(collateralAfter).to.equal(collateralBefore.sub(f.initialDeposits));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;259fb03c-a81a-477c-8cbd-ee05e220db90&quot;,&quot;parentUUID&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralWithdrawn event&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should emit CollateralWithdrawn event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: f.initialDeposits,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst event = await (0, _events.getInternalEvent)(tx, _hardhat.default.Diamond, &#x27;CollateralWithdrawn&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.withdrawer.address);\n(0, _chai.expect)(event.collateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialDeposits);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e4ffac5-62bc-4e38-b5da-f8c0ee4fea0c&quot;,&quot;parentUUID&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:48,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.User.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: f.initialBalance,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData())).to.be.revertedWith(`AccessControl: account ${f.user.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2b853cec-153f-4be4-8f08-2e2f726edef2&quot;,&quot;parentUUID&quot;:&quot;49bcaf08-f2c8-416a-a05a-20310431b11c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is &gt; 0&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 \&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne mints some kr assets\nthis.mintAmount = (0, _values.toBig)(100);\nawait f.Withdrawer.mintKreskoAsset({\n    account: f.withdrawer.address,\n    krAsset: f.KrAsset.address,\n    amount: this.mintAmount,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Mint amount differs from deposited amount due to open fee\nconst amountDeposited = await _optimizations.default.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\nthis.initialUserOneDeposited = amountDeposited;\nthis.mcr = await _optimizations.default.getMinCollateralRatioMinter();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2f37fdba-9a7c-4c5a-b786-d6b2a11c9316&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:129,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = (0, _values.toBig)(10);\n// Ensure that the withdrawal would not put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst [accMinCollateralValue, accCollateralValue, withdrawnCollateralValue] = await Promise.all([\n    _hardhat.default.Diamond.getAccountMinCollateralAtRatio(f.withdrawer.address, this.mcr),\n    _hardhat.default.Diamond.getAccountTotalCollateralValue(f.withdrawer.address),\n    _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount)\n]);\n(0, _chai.expect)(accCollateralValue.sub(withdrawnCollateralValue).gte(accMinCollateralValue)).to.be.true;\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await _hardhat.default.Diamond.getAccountCollateralAssets(f.withdrawer.address);\n(0, _chai.expect)(depositedCollateralAssets).to.deep.equal([\n    f.Collateral.address\n]);\n// Ensure the change in the f.user&#x27;s deposit is recorded.\nconst amountDeposited = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(amountDeposited).to.equal(f.initialDeposits.sub(withdrawAmount));\n// Check the balances of the contract and f.user\nconst kreskoBalance = await f.Collateral.balanceOf(_hardhat.default.Diamond.address);\n(0, _chai.expect)(kreskoBalance).to.equal(f.initialDeposits.sub(withdrawAmount));\nconst withdrawerBalance = await f.Collateral.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(withdrawerBalance).to.equal(withdrawAmount);\n// Ensure the account&#x27;s minimum collateral value is &lt;= the account collateral value\nconst accountMinCollateralValueAfter = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(f.withdrawer.address, this.mcr);\nconst accountCollateralValueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.withdrawer.address);\n(0, _chai.expect)(accountMinCollateralValueAfter.lte(accountCollateralValueAfter)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3a20c0c-d045-4d7a-83bc-3e73bc9533e9&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:74,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomUser = _hardhat.default.users.userFour;\nawait f.Collateral.setBalance(randomUser, (0, _values.toBig)(0));\nawait f.Collateral.setBalance(randomUser, (0, _values.toBig)(1000));\nawait f.Collateral.contract.connect(randomUser).approve(_hardhat.default.Diamond.address, _hardhat.default.ethers.constants.MaxUint256);\nawait (0, _collaterals.depositCollateral)({\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(1000),\n    user: randomUser\n});\nawait (0, _collaterals.withdrawCollateral)({\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(1010),\n    user: randomUser\n}, await _hardhat.default.updateData());\n(0, _chai.expect)(await f.Collateral.balanceOf(randomUser.address)).to.equal((0, _values.toBig)(1000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;29c7b495-cc52-48b7-a560-edd010becfea&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if withdrawing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if withdrawing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 0;\nawait (0, _chai.expect)(f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ZERO_AMOUNT&#x27;).withArgs(f.Collateral.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5e1e10de-bd54-4eb4-8df8-98efe265d129&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the withdrawal violates the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the withdrawal violates the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:91,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne has a debt position, so attempting to withdraw the entire collateral deposit should be impossible\nconst withdrawAmount = f.initialBalance;\n// Ensure that the withdrawal would in fact put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await _hardhat.default.Diamond.getAccountMinCollateralAtRatio(f.withdrawer.address, this.mcr);\nconst accountCollateralValue = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.withdrawer.address);\nconst withdrawnCollateralValue = await _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount);\n(0, _chai.expect)(accountCollateralValue.sub(withdrawnCollateralValue).lt(accountMinCollateralValue)).to.be.true;\nawait (0, _chai.expect)(f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 0,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ACCOUNT_COLLATERAL_VALUE_LESS_THAN_REQUIRED&#x27;).withArgs(f.withdrawer.address, 0, 150000000000, await _hardhat.default.Diamond.getMinCollateralRatioMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9fcfcaf1-90dc-4e73-8c75-432738aadcd0&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the depositIndex is incorrect&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the depositIndex is incorrect&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = f.initialDeposits.div(2);\nawait (0, _chai.expect)(f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: 1,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(_hardhat.default), &#x27;ARRAY_INDEX_OUT_OF_BOUNDS&#x27;).withArgs(f.Collateral.errorId, 1, [\n    f.Collateral.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;724f3763-13a0-4210-80bb-b6ec5a6761f4&quot;,&quot;parentUUID&quot;:&quot;53da6bd2-e499-4a8f-b45f-9f01e588a22c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f3a20c0c-d045-4d7a-83bc-3e73bc9533e9&quot;,&quot;29c7b495-cc52-48b7-a560-edd010becfea&quot;,&quot;5e1e10de-bd54-4eb4-8df8-98efe265d129&quot;,&quot;9fcfcaf1-90dc-4e73-8c75-432738aadcd0&quot;,&quot;724f3763-13a0-4210-80bb-b6ec5a6761f4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:392,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;c258c13b-ff92-4300-bd67-0ed731bbc3db&quot;,&quot;c09fcca5-0012-4fbc-8c51-ddeb48a145ef&quot;,&quot;259fb03c-a81a-477c-8cbd-ee05e220db90&quot;,&quot;6e4ffac5-62bc-4e38-b5da-f8c0ee4fea0c&quot;,&quot;2b853cec-153f-4be4-8f08-2e2f726edef2&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:289,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a3647e68-02d8-4d8d-91de-2fc6129eefdd&quot;,&quot;title&quot;:&quot;#deposit - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase \&quot;before each\&quot; hook in \&quot;#deposit - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:94,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setBalance(f.user, f.initialBalance, _hardhat.default.Diamond.address);\n// Add krAsset as a collateral with anchor and cFactor of 1\n// Allowance for Kresko\nawait f.KrAssetCollateral.contract.setVariable(&#x27;_allowances&#x27;, {\n    [f.user.address]: {\n        [_hardhat.default.Diamond.address]: _hardhat.default.ethers.constants.MaxInt256\n    }\n});\n// Deposit some collateral\nawait f.User.depositCollateral(f.user.address, f.Collateral.address, f.initialDeposits);\n// Mint some krAssets\nawait f.User.mintKreskoAsset({\n    account: f.user.address,\n    krAsset: f.KrAssetCollateral.address,\n    amount: mintAmount,\n    receiver: f.user.address\n}, await _hardhat.default.updateData());\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await f.User.getAccountDebtAmount(f.user.address, f.KrAssetCollateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f6ecc30-905a-4748-9116-98aeaba0f10b&quot;,&quot;parentUUID&quot;:&quot;a3647e68-02d8-4d8d-91de-2fc6129eefdd&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;title&quot;:&quot;deposit amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:35,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst expectedDepositsAfter = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(expectedDepositsAfter);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0f339b95-faaa-4eb6-8d4b-88fd94dcc71f&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:35,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmountAfterRebase = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmountAfterRebase);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;794559c9-afe9-4f91-beb5-c19dafaa84b0&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5f6f8d05-784b-4e6e-9c9c-762ea85e1e37&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\nconst depositsBefore = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsBefore).to.not.equal(finalDeposits);\n(0, _chai.expect)(finalDeposits).to.equal(depositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3f057ff-bed8-48fc-871b-c65e09c43029&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:48,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(halfDepositAfterRebase);\n// Deposit second time\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7468e100-293e-4a3a-844d-256c950a8ba1&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit amounts are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get deposits after\nconst depositsAfterRebase = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfterRebase).to.equal(halfDepositAfterRebase);\n// Deposit second time\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.user.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalDeposits).to.equal(fullDepositAmount);\n(0, _chai.expect)(await f.KrAssetCollateral.balanceOf(f.user.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d914371e-b57c-410f-86de-1fb3689fe4ed&quot;,&quot;parentUUID&quot;:&quot;7fba5a64-b409-4d92-90c1-ef0a7c6860a9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0f339b95-faaa-4eb6-8d4b-88fd94dcc71f&quot;,&quot;794559c9-afe9-4f91-beb5-c19dafaa84b0&quot;,&quot;5f6f8d05-784b-4e6e-9c9c-762ea85e1e37&quot;,&quot;f3f057ff-bed8-48fc-871b-c65e09c43029&quot;,&quot;7468e100-293e-4a3a-844d-256c950a8ba1&quot;,&quot;d914371e-b57c-410f-86de-1fb3689fe4ed&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:228,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;title&quot;:&quot;deposit usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:113,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\nawait f.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3dbb5e37-2f07-4c65-b3ef-7dfbeccce769&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:112,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst valueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.user.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\nawait f.KrAssetCollateral.setPrice(newPrice);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.user.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(valueBefore).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d6a74cd0-7cea-4e64-816f-7d274e145d0d&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:90,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\n// Get expected value before rebase and deposit\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, depositAmount);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0c33f04b-1302-423c-96fb-4cef8a0cd37c&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:89,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\n// Get expected value before rebase and deposit\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, depositAmount);\n// Get collateral value of account after\nconst valueAfter = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, depositAmount);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0c591a0-c9ef-4ce2-8cf1-35187b41e305&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:129,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst valueAfterRebase = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst expectedValueAfterSecondDeposit = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, fullDepositAmount);\n// Deposit more\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bae9ee9e-3ef3-4ff0-b859-19516a7763ce&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #deposit - rebase deposit usd values are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:128,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositBeforeRebase);\nconst expectedValue = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst valueAfterRebase = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Calculate added value since price adjusted in the rebase\nconst expectedValueAfterSecondDeposit = await _hardhat.default.Diamond.getValue(f.KrAssetCollateral.address, fullDepositAmount);\n// Deposit more\nawait f.User.depositCollateral(f.user.address, f.KrAssetCollateral.address, halfDepositAfterRebase);\n// Get deposits after\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.user.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(finalValue).to.equal(expectedValueAfterSecondDeposit);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2b239d6b-3262-4156-b9fc-0ddf91d7963c&quot;,&quot;parentUUID&quot;:&quot;ba8d7aff-ba0b-4e6b-8004-b923278bb2d6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3dbb5e37-2f07-4c65-b3ef-7dfbeccce769&quot;,&quot;d6a74cd0-7cea-4e64-816f-7d274e145d0d&quot;,&quot;0c33f04b-1302-423c-96fb-4cef8a0cd37c&quot;,&quot;f0c591a0-c9ef-4ce2-8cf1-35187b41e305&quot;,&quot;bae9ee9e-3ef3-4ff0-b859-19516a7763ce&quot;,&quot;2b239d6b-3262-4156-b9fc-0ddf91d7963c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:661,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b23246e4-9077-4186-b3f2-c0a607614de0&quot;,&quot;title&quot;:&quot;#withdraw - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase \&quot;before each\&quot; hook in \&quot;#withdraw - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Withdrawer.mintKreskoAsset({\n    account: f.withdrawer.address,\n    krAsset: f.KrAssetCollateral.address,\n    amount: mintAmount,\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await _optimizations.default.getAccountDebtAmount(f.withdrawer.address, f.KrAssetCollateral);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2f3c60df-334e-44db-935a-df1d492d3d09&quot;,&quot;parentUUID&quot;:&quot;b23246e4-9077-4186-b3f2-c0a607614de0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;title&quot;:&quot;withdraw amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit collateral before rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4689bc3b-5a21-470b-a9d2-30d177e8da2f&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit collateral before rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;32079691-dc2c-4adf-883e-c37c591917e0&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after an positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:104,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;826cbba5-a8f6-48d4-acfb-522e06d61e53&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, rebasedDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, _chai.expect)(depositsAfter).to.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3a4fc38c-e0f7-4c86-bec8-1f81688c016b&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:127,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit before the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: fullDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2c9af964-c748-4fac-a48f-4e885eb66a90&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit before the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\n// Get deposits before\nconst depositsFirst = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsFirst).to.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit after the rebase\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure deposit balance matches expected\n(0, _chai.expect)(depositsAfter).to.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: fullDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalDeposits = await _hardhat.default.Diamond.getAccountCollateralAmount(f.withdrawer.address, f.KrAssetCollateral.address);\nconst finalBalance = await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address);\n(0, _chai.expect)(finalDeposits).to.equal(0);\n(0, _chai.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;019a5e0d-ed63-4448-ab8d-548b7c2fe57d&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw amounts are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:150,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\nconst withdrawAmount = (0, _values.toBig)(10);\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst nrcBalanceBefore = await f.Collateral.contract.balanceOf(f.withdrawer.address);\nconst expectedNrcBalanceAfter = nrcBalanceBefore.add(withdrawAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.Collateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(f.withdrawer.address)).to.equal(expectedNrcBalanceAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;596f6b3e-aa43-49ab-83de-b7658eca148a&quot;,&quot;parentUUID&quot;:&quot;5b92a8a2-42c3-433e-a87b-fe69e53f8afc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4689bc3b-5a21-470b-a9d2-30d177e8da2f&quot;,&quot;32079691-dc2c-4adf-883e-c37c591917e0&quot;,&quot;826cbba5-a8f6-48d4-acfb-522e06d61e53&quot;,&quot;3a4fc38c-e0f7-4c86-bec8-1f81688c016b&quot;,&quot;2c9af964-c748-4fac-a48f-4e885eb66a90&quot;,&quot;019a5e0d-ed63-4448-ab8d-548b7c2fe57d&quot;,&quot;596f6b3e-aa43-49ab-83de-b7658eca148a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:827,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;title&quot;:&quot;withdraw usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:159,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fd648ac2-a407-4520-bf54-6537e83ea93a&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:160,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Withdraw the full rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: rebasedDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;86bbe650-bac0-45ef-9bba-21e7bd862a04&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:160,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: depositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e13e61cc-f561-417f-9e7f-6d07d4b46fa6&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:158,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Deposit rebased amount after\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, depositAmount);\n// Withdraw the full rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: depositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c79f040c-570d-497d-9bcd-1f934f82fb09&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:198,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Deposit more\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: fullDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51f40c92-c9b7-48a0-b2ab-69f6fcbd3400&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:204,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) * denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(denominator).div(2);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, firstDepositAmount);\nconst [expectedValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Get value after\nconst [valueAfterRebase] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n// Ensure that the collateral value stays the same\n(0, _chai.expect)(expectedValue).to.equal(valueAfterRebase);\n// Deposit more\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, secondDepositAmount);\n// Withdraw the full rebased amount\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.KrAssetCollateral.address,\n    amount: fullDepositAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\n// Get value\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(finalValue).to.equal(0);\n(0, _chai.expect)(await f.KrAssetCollateral.contract.balanceOf(f.withdrawer.address)).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;01f6aa1c-a45d-40e3-a5a3-bce235569486&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Deposit Withdraw #collateral #withdraw - rebase withdraw usd values are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:225,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, _values.fromBig)((await f.KrAssetCollateral.getPrice()).pyth, 8) / denominator;\nconst withdrawAmount = (0, _values.toBig)(10);\nawait f.Withdrawer.depositCollateral(f.withdrawer.address, f.KrAssetCollateral.address, this.krAssetCollateralAmount);\nconst accountValueBefore = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.withdrawer.address);\nconst [nrcValueBefore] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.Collateral.address);\nconst withdrawValue = await _hardhat.default.Diamond.getValue(f.Collateral.address, withdrawAmount);\nconst expectedNrcValueAfter = nrcValueBefore.sub(withdrawValue);\n// Rebase the asset according to params\nawait f.KrAssetCollateral.setPrice(newPrice);\nawait f.KrAssetCollateral.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.Withdrawer.withdrawCollateral({\n    account: f.withdrawer.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    collateralIndex: _optimizations.default.getAccountDepositIndex(f.withdrawer.address, f.KrAssetCollateral.address),\n    receiver: f.withdrawer.address\n}, await _hardhat.default.updateData());\nconst finalAccountValue = await _hardhat.default.Diamond.getAccountTotalCollateralValue(f.withdrawer.address);\nconst [finalValue] = await _hardhat.default.Diamond.getAccountCollateralValues(f.withdrawer.address, f.Collateral.address);\n(0, _chai.expect)(finalValue).to.equal(expectedNrcValueAfter);\n(0, _chai.expect)(finalAccountValue).to.equal(accountValueBefore.sub(withdrawValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fc15bd3c-6473-4958-8e98-ab0d04353653&quot;,&quot;parentUUID&quot;:&quot;11a2a939-a8f9-4f3d-baed-278d79b1332c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;fd648ac2-a407-4520-bf54-6537e83ea93a&quot;,&quot;86bbe650-bac0-45ef-9bba-21e7bd862a04&quot;,&quot;e13e61cc-f561-417f-9e7f-6d07d4b46fa6&quot;,&quot;c79f040c-570d-497d-9bcd-1f934f82fb09&quot;,&quot;51f40c92-c9b7-48a0-b2ab-69f6fcbd3400&quot;,&quot;01f6aa1c-a45d-40e3-a5a3-bce235569486&quot;,&quot;fc15bd3c-6473-4958-8e98-ab0d04353653&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1264,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f73a861e-587f-43e5-b36a-feed2f37ed2b&quot;,&quot;title&quot;:&quot;Minter - Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations \&quot;before each\&quot; hook in \&quot;Minter - Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:240,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.liquidationsFixture)();\nawait f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2ea0118-8ccd-4a5c-8a93-3b90ed04e6ee&quot;,&quot;parentUUID&quot;:&quot;f73a861e-587f-43e5-b36a-feed2f37ed2b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f42cfcee-5736-479c-9690-e48bdf6fd9d1&quot;,&quot;title&quot;:&quot;#isAccountLiquidatable&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify accounts below their liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #isAccountLiquidatable should identify accounts below their liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [cr, minCollateralUSD, initialCanLiquidate] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(f.user1.address),\n    hre.Diamond.getAccountMinCollateralAtRatio(f.user1.address, hre.Diamond.getLiquidationThresholdMinter()),\n    hre.Diamond.getAccountLiquidatable(f.user1.address)\n]);\n(0, _chai.expect)(cr).to.be.equal(1.5e4);\n(0, _chai.expect)(f.initialDeposits.mul(10).gt(minCollateralUSD));\n(0, _chai.expect)(initialCanLiquidate).to.equal(false);\nawait f.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user1.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d3796e92-d87c-4066-b338-413822052c68&quot;,&quot;parentUUID&quot;:&quot;f42cfcee-5736-479c-9690-e48bdf6fd9d1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d3796e92-d87c-4066-b338-413822052c68&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:123,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;08bbd5f5-a7c9-4758-b57f-86ef4509fdb7&quot;,&quot;title&quot;:&quot;#maxLiquidatableValue&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV when kFactor = 1, cFactor = 0.25&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:233,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const MLVBeforeC1 = await hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral.address);\nconst MLVBeforeC2 = await hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral2.address);\n(0, _chai.expect)(MLVBeforeC1.repayValue).to.be.closeTo(MLVBeforeC2.repayValue, USD_DELTA);\nawait hre.Diamond.setAssetCFactor(f.Collateral.address, 0.25e4);\nawait (0, _collaterals.depositMockCollateral)({\n    user: f.user1,\n    amount: f.initialDeposits.div(2),\n    asset: f.Collateral2\n});\nconst expectedCR = 1.125e4;\nconst [crAfter, isLiquidatableAfter, MLVAfterC1, MLVAfterC2] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(f.user1.address),\n    hre.Diamond.getAccountLiquidatable(f.user1.address),\n    hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral.address),\n    hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral2.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.true;\n(0, _chai.expect)(crAfter).to.be.closeTo(expectedCR, 1);\n(0, _chai.expect)(MLVAfterC1.repayValue).to.gt(MLVBeforeC1.repayValue);\n(0, _chai.expect)(MLVAfterC2.repayValue).to.gt(MLVBeforeC2.repayValue);\n(0, _chai.expect)(MLVAfterC2.repayValue.gt(MLVAfterC1.repayValue)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;39760a47-b577-45f1-b1d8-6eb813320785&quot;,&quot;parentUUID&quot;:&quot;08bbd5f5-a7c9-4758-b57f-86ef4509fdb7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct MLV with multiple cdps&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #maxLiquidatableValue calculates correct MLV with multiple cdps&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:173,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: f.user1,\n    amount: (0, _values.toBig)(0.1, 8),\n    asset: f.Collateral8Dec\n});\nawait f.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user1.address)).to.be.true;\nconst [maxLiq, maxLiq8Dec] = await Promise.all([\n    hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral.address),\n    hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(maxLiq.repayValue).gt(0);\n(0, _chai.expect)(maxLiq8Dec.repayValue).gt(0);\n(0, _chai.expect)(maxLiq.repayValue).gt(maxLiq8Dec.repayValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b7a9d919-5142-4383-8d7b-5fa97b22b494&quot;,&quot;parentUUID&quot;:&quot;08bbd5f5-a7c9-4758-b57f-86ef4509fdb7&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;39760a47-b577-45f1-b1d8-6eb813320785&quot;,&quot;b7a9d919-5142-4383-8d7b-5fa97b22b494&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:406,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;35a77adc-f2b8-4e50-8d7b-11f931b74ae1&quot;,&quot;title&quot;:&quot;#liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;title&quot;:&quot;#liquidate&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate \&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:48,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setPrice(7.5);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dd336f48-8afe-48a4-8e6d-72234d8d3d62&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow unhealthy accounts to be liquidated&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow unhealthy accounts to be liquidated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:144,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Fetch pre-liquidation state for users and contracts\nconst beforeUserOneCollateralAmount = await _optimizations.default.getAccountCollateralAmount(f.user1.address, f.Collateral);\nconst userOneDebtBefore = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\nconst liquidatorBalanceBefore = await f.Collateral.balanceOf(f.liquidator.address);\nconst liquidatorBalanceKrBefore = await f.KrAsset.balanceOf(f.liquidator.address);\nconst kreskoBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\n// Liquidate userOne\nconst maxRepayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _values.toBig)(11, 8));\nawait f.Liquidator.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: maxRepayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: _optimizations.default.getAccountMintIndex(f.user1.address, f.KrAsset.address),\n    seizeAssetIndex: _optimizations.default.getAccountDepositIndex(f.user1.address, f.Collateral.address),\n    prices: await hre.updateData()\n});\n// Confirm that the liquidated user&#x27;s debt amount has decreased by the repaid amount\nconst userOneDebtAfterLiquidation = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebtAfterLiquidation.eq(userOneDebtBefore.sub(maxRepayAmount)));\n// Confirm that some of the liquidated user&#x27;s collateral has been seized\nconst userOneCollateralAfterLiquidation = await _optimizations.default.getAccountCollateralAmount(f.user1.address, f.Collateral);\n(0, _chai.expect)(userOneCollateralAfterLiquidation.lt(beforeUserOneCollateralAmount));\n// Confirm that userTwo&#x27;s kresko asset balance has decreased by the repaid amount\n(0, _chai.expect)(await f.KrAsset.balanceOf(f.liquidator.address)).eq(liquidatorBalanceKrBefore.sub(maxRepayAmount));\n// Confirm that userTwo has received some collateral from the contract\n(0, _chai.expect)(await f.Collateral.balanceOf(f.liquidator.address)).gt(liquidatorBalanceBefore);\n// Confirm that Kresko contract&#x27;s collateral balance has decreased.\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).lt(kreskoBalanceBefore);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;14fd38d3-13f8-4136-965f-b47f50762e50&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with a single CDP&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with a single CDP&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:209,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setAssetCFactor(f.Collateral.address, 0.99e4);\nawait hre.Diamond.setAssetKFactor(f.KrAsset.address, 1.02e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral.address);\nawait f.Liquidator.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: maxLiq.repayAmount.add((0, _values.toBig)(1222, 27)),\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: maxLiq.repayAssetIndex,\n    seizeAssetIndex: maxLiq.seizeAssetIndex,\n    prices: await hre.updateData()\n});\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(f.user1.address)).to.be.eq(await _optimizations.default.getMaxLiquidationRatioMinter());\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a007cbaa-b17f-4ae9-9e81-9d7da0446cda&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate up to MLR with multiple CDPs&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should liquidate up to MLR with multiple CDPs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:383,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _collaterals.depositMockCollateral)({\n    user: f.user1,\n    amount: (0, _values.toBig)(10, 8),\n    asset: f.Collateral8Dec\n});\nawait f.Collateral.setPrice(5.5);\nawait f.Collateral8Dec.setPrice(6);\nawait hre.Diamond.setAssetCFactor(f.Collateral.address, 0.9754e4);\nawait hre.Diamond.setAssetKFactor(f.KrAsset.address, 1.05e4);\nawait (0, _liquidations.liquidate)(f.user1, f.KrAsset, f.Collateral8Dec);\nconst [crAfter, isLiquidatableAfter] = await Promise.all([\n    hre.Diamond.getAccountCollateralRatio(f.user1.address),\n    hre.Diamond.getAccountLiquidatable(f.user1.address)\n]);\n(0, _chai.expect)(isLiquidatableAfter).to.be.false;\n(0, _chai.expect)(crAfter).to.be.eq(await _optimizations.default.getMaxLiquidationRatioMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;acf3524c-d4db-4c65-9e11-0a9d46645a1e&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit LiquidationOccurred event&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should emit LiquidationOccurred event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:116,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = f.userOneMaxLiqPrecalc.wadDiv((0, _values.toBig)(11));\nconst tx = await f.Liquidator.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: _optimizations.default.getAccountMintIndex(f.user1.address, f.KrAsset.address),\n    seizeAssetIndex: _optimizations.default.getAccountDepositIndex(f.user1.address, f.Collateral.address),\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;LiquidationOccurred&#x27;);\n(0, _chai.expect)(event.args.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(f.liquidator.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.repayAmount).to.equal(repayAmount);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44f33983-972c-4fc0-9c94-7cbc9ce38f68&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations of healthy accounts&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations of healthy accounts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setPrice(10);\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, _chai.expect)(f.Liquidator.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: mintedKreskoAssetIndex,\n    seizeAssetIndex: depositedCollateralAssetIndex,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;CANNOT_LIQUIDATE_HEALTHY_ACCOUNT&#x27;).withArgs(f.user1.address, 16500000000, 15400000000, await hre.Diamond.getLiquidationThresholdMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;680c41c6-327b-49b8-9d88-8916c736308b&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations if repayment amount is 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations if repayment amount is 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:89,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 0;\nawait (0, _chai.expect)(f.LiquidatorTwo.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: 0,\n    seizeAssetIndex: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;LIQUIDATION_VALUE_IS_ZERO&#x27;).withArgs(f.KrAsset.errorId, f.Collateral.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b8e20ff3-1d74-4de2-ab3d-862d18bd9e99&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should clamp liquidations if repay value/amount exceeds debt&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should clamp liquidations if repay value/amount exceeds debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:199,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Get user&#x27;s debt for this kresko asset\nconst krAssetDebtUserOne = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n// Ensure we are repaying more than debt\nconst repayAmount = krAssetDebtUserOne.add((0, _values.toBig)(10));\nawait f.KrAsset.setBalance(f.liquidatorTwo, repayAmount, hre.Diamond.address);\n// Liquidation should fail\nconst liquidatorBalanceBefore = await f.KrAsset.balanceOf(f.liquidatorTwo.address);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(f.user1.address, f.KrAsset.address, f.Collateral.address);\n(0, _chai.expect)(maxLiq.repayAmount).to.be.lt(repayAmount);\nconst tx = await f.LiquidatorTwo.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: 0,\n    seizeAssetIndex: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;LiquidationOccurred&#x27;);\nconst liquidatorBalanceAfter = await f.KrAsset.balanceOf(f.liquidatorTwo.address);\n(0, _chai.expect)(event.args.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.args.liquidator).to.equal(f.liquidatorTwo.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.args.seizedCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.args.repayAmount).to.not.equal(repayAmount);\n(0, _chai.expect)(event.args.repayAmount).to.equal(maxLiq.repayAmount);\n(0, _chai.expect)(event.args.collateralSent).to.be.equal(maxLiq.seizeAmount);\n(0, _chai.expect)(liquidatorBalanceAfter.add(repayAmount)).to.not.equal(liquidatorBalanceBefore);\n(0, _chai.expect)(liquidatorBalanceAfter.add(maxLiq.repayAmount)).to.equal(liquidatorBalanceBefore);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(f.user1.address)).to.be.eq(await hre.Diamond.getMaxLiquidationRatioMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3f99151-735a-449b-8d06-8c085dff8856&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:174,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setPrice(f.Collateral.config.args.price);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user1.address)).to.be.false;\nconst minCollateralUSD = await hre.Diamond.getAccountMinCollateralAtRatio(f.user1.address, _optimizations.default.getMinCollateralRatioMinter());\nconst liquidationThresholdUSD = await hre.Diamond.getAccountMinCollateralAtRatio(f.user1.address, _optimizations.default.getLiquidationThresholdMinter());\nawait f.Collateral.setPrice(9.9);\nconst accountCollateralValue = await hre.Diamond.getAccountTotalCollateralValue(f.user1.address);\n(0, _chai.expect)(accountCollateralValue.lt(minCollateralUSD)).to.be.true;\n(0, _chai.expect)(accountCollateralValue.gt(liquidationThresholdUSD)).to.be.true;\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user1.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f487354-4592-416c-96f9-2942c8ade001&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations without f.liquidator token approval for Kresko Assets&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should allow liquidations without f.liquidator token approval for Kresko Assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:126,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check that f.liquidator&#x27;s token approval to Kresko.sol contract is 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(f.liquidatorTwo.address, hre.Diamond.address)).to.equal(0);\nconst repayAmount = (0, _values.toBig)(0.5);\nawait f.KrAsset.setBalance(f.liquidatorTwo, repayAmount);\nawait f.LiquidatorTwo.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: 0,\n    seizeAssetIndex: 0,\n    prices: await hre.updateData()\n});\n// Confirm that f.liquidator&#x27;s token approval is still 0\n(0, _chai.expect)(await f.KrAsset.contract.allowance(f.user2.address, hre.Diamond.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f961d424-3c6f-46d1-a377-e3efda656f92&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not change f.liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not change f.liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const repayAmount = (0, _values.toBig)(0.5);\nawait f.KrAsset.setBalance(f.liquidatorTwo, repayAmount);\nawait f.KrAsset.contract.setVariable(&#x27;_allowances&#x27;, {\n    [f.liquidatorTwo.address]: {\n        [hre.Diamond.address]: repayAmount\n    }\n});\nawait (0, _chai.expect)(f.LiquidatorTwo.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: 0,\n    seizeAssetIndex: 0,\n    prices: await hre.updateData()\n})).not.to.be.reverted;\n// Confirm that f.liquidator&#x27;s token approval is unchanged\n(0, _chai.expect)(await f.KrAsset.contract.allowance(f.liquidatorTwo.address, hre.Diamond.address)).to.equal(repayAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fdf1e7f3-9fb3-480b-a395-33c97ce1ea37&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow borrowers to liquidate themselves&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should not allow borrowers to liquidate themselves&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 5;\nawait (0, _chai.expect)(f.User.liquidate({\n    account: f.user1.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: repayAmount,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: 0,\n    seizeAssetIndex: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;CANNOT_LIQUIDATE_SELF&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;800f4ade-2786-407d-a5ec-60892ca7ae9e&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should error on seize underflow&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate should error on seize underflow&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c3b3d586-7d16-4f8c-921d-7d674bda49e9&quot;,&quot;parentUUID&quot;:&quot;0b721981-3e89-4f47-8161-42fe82ae6dc2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;14fd38d3-13f8-4136-965f-b47f50762e50&quot;,&quot;a007cbaa-b17f-4ae9-9e81-9d7da0446cda&quot;,&quot;acf3524c-d4db-4c65-9e11-0a9d46645a1e&quot;,&quot;44f33983-972c-4fc0-9c94-7cbc9ce38f68&quot;,&quot;680c41c6-327b-49b8-9d88-8916c736308b&quot;,&quot;b8e20ff3-1d74-4de2-ab3d-862d18bd9e99&quot;,&quot;a3f99151-735a-449b-8d06-8c085dff8856&quot;,&quot;9f487354-4592-416c-96f9-2942c8ade001&quot;,&quot;f961d424-3c6f-46d1-a377-e3efda656f92&quot;,&quot;fdf1e7f3-9fb3-480b-a395-33c97ce1ea37&quot;,&quot;800f4ade-2786-407d-a5ec-60892ca7ae9e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;c3b3d586-7d16-4f8c-921d-7d674bda49e9&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:1720,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;title&quot;:&quot;#liquidate - rebasing events&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events \&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.resetRebasing();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;802c9a50-2d6a-40aa-8db8-5e26e690da5d&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should setup correct&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should setup correct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:82,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [mcr, cr, cr2, liquidatable] = await Promise.all([\n    _optimizations.default.getMinCollateralRatioMinter(),\n    hre.Diamond.getAccountCollateralRatio(f.user3.address),\n    hre.Diamond.getAccountCollateralRatio(f.user4.address),\n    hre.Diamond.getAccountLiquidatable(f.user3.address)\n]);\n(0, _chai.expect)(cr).to.closeTo(mcr, 8);\n(0, _chai.expect)(cr2).to.closeTo(mcr, 1);\n(0, _chai.expect)(liquidatable).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1d9b115f-06b6-404e-b9d6-1bb3aa42911c&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:146,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(f.Liquidator.liquidate({\n    account: f.user4.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: 100,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: _optimizations.default.getAccountMintIndex(f.user4.address, f.KrAsset.address),\n    seizeAssetIndex: _optimizations.default.getAccountDepositIndex(f.user4.address, f.Collateral.address),\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;CANNOT_LIQUIDATE_HEALTHY_ACCOUNT&#x27;).withArgs(f.user4.address, 1000000000000, 933333332400, await hre.Diamond.getLiquidationThresholdMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;60479d48-e592-4cfa-b021-4205b537b2cf&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:145,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait (0, _chai.expect)(f.Liquidator.liquidate({\n    account: f.user4.address,\n    repayAssetAddr: f.KrAsset.address,\n    repayAmount: 100,\n    seizeAssetAddr: f.Collateral.address,\n    repayAssetIndex: _optimizations.default.getAccountMintIndex(f.user4.address, f.KrAsset.address),\n    seizeAssetIndex: _optimizations.default.getAccountDepositIndex(f.user4.address, f.Collateral.address),\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;CANNOT_LIQUIDATE_HEALTHY_ACCOUNT&#x27;).withArgs(f.user4.address, 1000000000000, 933333332400, await hre.Diamond.getLiquidationThresholdMinter());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0f4e5bb9-f7c1-4e24-9d68-ec76a346500d&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:913,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = true;\nconst rebasePrice = 1 / denominator;\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user4.address)).to.be.false;\nawait f.Collateral.setPrice(7.5);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user4.address)).to.be.true;\nawait (0, _liquidations.liquidate)(f.user4, f.KrAsset, f.Collateral, true);\nawait (0, _chai.expect)((0, _liquidations.liquidate)(f.user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dfa3c782-cd3a-4396-ac72-d4b3a8fb4dee&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:462,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 4;\nconst positive = false;\nconst rebasePrice = 1 * denominator;\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user4.address)).to.be.false;\nawait f.KrAsset.setPrice(rebasePrice + 1);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user4.address)).to.be.true;\nawait (0, _chai.expect)((0, _liquidations.liquidate)(f.user4, f.KrAsset, f.Collateral, true)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e12b89e-5ac9-4eca-9adc-d68e8f5006e0&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate krAsset collaterals up to min amount&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate krAsset collaterals up to min amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:265,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.KrAssetCollateral.setPrice(100);\nawait hre.Diamond.setAssetCFactor(f.KrAssetCollateral.address, 0.99e4);\nawait hre.Diamond.setAssetKFactor(f.KrAssetCollateral.address, 1e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(f.user3.address, f.KrAssetCollateral.address, f.KrAssetCollateral.address);\nawait f.KrAssetCollateral.setBalance(f.liquidator, maxLiq.repayAmount, hre.Diamond.address);\nawait f.Liquidator.liquidate({\n    account: f.user3.address,\n    repayAssetAddr: f.KrAssetCollateral.address,\n    repayAmount: maxLiq.repayAmount.sub(1e9),\n    seizeAssetAddr: f.KrAssetCollateral.address,\n    repayAssetIndex: maxLiq.repayAssetIndex,\n    seizeAssetIndex: maxLiq.seizeAssetIndex,\n    prices: await hre.updateData()\n});\nconst depositsAfter = await hre.Diamond.getAccountCollateralAmount(f.user3.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsAfter).to.equal(1e12.toString());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b55d0a1c-3707-4def-bf27-092b97047c04&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate to 0&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate to 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:264,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.KrAssetCollateral.setPrice(100);\nawait hre.Diamond.setAssetCFactor(f.KrAssetCollateral.address, 1e4);\nawait hre.Diamond.setAssetKFactor(f.KrAssetCollateral.address, 1e4);\nconst maxLiq = await hre.Diamond.getMaxLiqValue(f.user3.address, f.KrAssetCollateral.address, f.KrAssetCollateral.address);\nconst liquidationAmount = maxLiq.repayAmount.add((0, _values.toBig)(20, 27));\nawait f.KrAssetCollateral.setBalance(hre.users.liquidator, liquidationAmount, hre.Diamond.address);\nawait f.Liquidator.liquidate({\n    account: f.user3.address,\n    repayAssetAddr: f.KrAssetCollateral.address,\n    repayAmount: liquidationAmount,\n    seizeAssetAddr: f.KrAssetCollateral.address,\n    repayAssetIndex: maxLiq.repayAssetIndex,\n    seizeAssetIndex: maxLiq.seizeAssetIndex,\n    prices: await hre.updateData()\n});\nconst depositsAfter = await hre.Diamond.getAccountCollateralAmount(f.user3.address, f.KrAssetCollateral.address);\n(0, _chai.expect)(depositsAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b4e93a3-2406-4337-8785-f0c61c075eb6&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:742,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nawait f.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(f.user4.address)){\n    const values = await (0, _liquidations.liquidate)(f.user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(f.user4.address), 8);\nresults.userOneHFAfter = (await hre.Diamond.getAccountCollateralRatio(f.user4.address)).toNumber();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = newPrice / denominator;\n// Rebase\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(f.user5.address)){\n    const values = await (0, _liquidations.liquidate)(f.user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(f.user5.address), 8);\nresults.userTwoHFAfter = (await hre.Diamond.getAccountCollateralRatio(f.user5.address)).toNumber();\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid * denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;be485a2e-a16c-4fcf-9c07-793facec1727&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of assets after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter - Liquidations #liquidation #liquidate - rebasing events should liquidate correct amount of assets after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:854,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newPrice = 1.2;\nawait f.KrAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0\n};\n// Get values for a liquidation that happens before rebase\nwhile(await hre.Diamond.getAccountLiquidatable(f.user4.address)){\n    const values = await (0, _liquidations.liquidate)(f.user4, f.KrAsset, f.Collateral);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(f.user4.address), 8);\nresults.userOneHFAfter = (await hre.Diamond.getAccountCollateralRatio(f.user4.address)).toNumber();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = newPrice * denominator;\n// Rebase\nawait f.KrAsset.setPrice(rebasePrice);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n(0, _chai.expect)(await hre.Diamond.getAccountLiquidatable(f.user5.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile(await hre.Diamond.getAccountLiquidatable(f.user5.address)){\n    const values = await (0, _liquidations.liquidate)(f.user5, f.KrAsset, f.Collateral);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = (0, _values.fromBig)(await hre.Diamond.getAccountTotalCollateralValue(f.user5.address), 8);\nresults.userTwoHFAfter = (await hre.Diamond.getAccountCollateralRatio(f.user5.address)).toNumber();\n(0, _chai.expect)(results.userTwoHFAfter).to.equal(results.userOneHFAfter);\n(0, _chai.expect)(results.collateralSeized).to.equal(results.collateralSeizedRebase);\n(0, _chai.expect)(results.debtRepaid / denominator).to.equal(results.debtRepaidRebase);\n(0, _chai.expect)(results.userOneValueAfter).to.equal(results.userTwoValueAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae53d7d6-36f8-4b8b-bb9d-36e8d0cd38af&quot;,&quot;parentUUID&quot;:&quot;48a2b094-f7b0-43a0-a15e-1c537501e860&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1d9b115f-06b6-404e-b9d6-1bb3aa42911c&quot;,&quot;60479d48-e592-4cfa-b021-4205b537b2cf&quot;,&quot;0f4e5bb9-f7c1-4e24-9d68-ec76a346500d&quot;,&quot;dfa3c782-cd3a-4396-ac72-d4b3a8fb4dee&quot;,&quot;6e12b89e-5ac9-4eca-9adc-d68e8f5006e0&quot;,&quot;b55d0a1c-3707-4def-bf27-092b97047c04&quot;,&quot;0b4e93a3-2406-4337-8785-f0c61c075eb6&quot;,&quot;be485a2e-a16c-4fcf-9c07-793facec1727&quot;,&quot;ae53d7d6-36f8-4b8b-bb9d-36e8d0cd38af&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3873,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f57ecc8c-c23f-4f37-8ffe-86a0a054f45c&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.mintRepayFixture)();\nawait f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c98a37e0-3fd8-4bbf-8ca5-f470c05dc1aa&quot;,&quot;parentUUID&quot;:&quot;f57ecc8c-c23f-4f37-8ffe-86a0a054f45c&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;d176c3fe-7bef-4f3f-a357-c5b1ef0058a4&quot;,&quot;title&quot;:&quot;#mint+burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyBefore).to.equal(f.initialMintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hre.Diamond.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, _values.toBig)(10);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMinted = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMinted).to.equal(mintAmount);\n// Confirm the user&#x27;s Kresko asset balance has increased\nconst userBalance = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalance).to.equal(mintAmount);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter.eq(kreskoAssetTotalSupplyBefore.add(mintAmount)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;73ffb6c0-eebd-4004-b258-38e7017e3be7&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow successive, valid mints of the same Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow successive, valid mints of the same Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:194,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Mint Kresko asset\nconst firstMintAmount = (0, _values.toBig)(50);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: firstMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hre.Diamond.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _values.toBig)(50);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: secondMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm the array of the user&#x27;s minted Kresko assets is unchanged\nconst mintedKreskoAssetsFinal = await hre.Diamond.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedFinal = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(amountMintedFinal).to.closeTo(firstMintAmount.add(secondMintAmount), INTEREST_RATE_DELTA);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalanceFinal).to.closeTo(amountMintedFinal, INTEREST_RATE_DELTA);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyFinal = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyFinal).to.closeTo(kreskoAssetTotalSupplyAfter.add(secondMintAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c88c8a78-d179-4475-8a08-aceb6aa4e69f&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint multiple different Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint multiple different Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:191,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, _values.toBig)(10);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: firstMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await f.KrAsset.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(f.initialMintAmount.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, _values.toBig)(20);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset2.address,\n    amount: secondMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm that the second address has been pushed to the array of the user&#x27;s minted Kresko assets\nconst mintedKreskoAssetsFinal = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsFinal).to.deep.equal([\n    f.KrAsset.address,\n    f.KrAsset2.address\n]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedAssetTwo = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset2);\n(0, _chai.expect)(amountMintedAssetTwo).to.equal(secondMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await f.KrAsset2.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalanceFinal).to.equal(amountMintedAssetTwo);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst secondKreskoAssetTotalSupply = await f.KrAsset2.contract.totalSupply();\n(0, _chai.expect)(secondKreskoAssetTotalSupply).to.equal(secondMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dda02433-07a8-4160-89ce-fdfeadb4e6cc&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:98,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the mint amount&#x27;s USD value is equal to the contract&#x27;s current minimum debt value\nconst mintAmount = (0, _values.toBig)(1) // 1 * $10 = $10\n;\nconst mintAmountUSDValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nconst currMinimumDebtValue = await hre.Diamond.getMinDebtValueMinter();\n(0, _chai.expect)(mintAmountUSDValue).to.equal(currMinimumDebtValue);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Confirm that the mint was successful and user&#x27;s balances have increased\nconst finalKreskoAssetDebt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(finalKreskoAssetDebt).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;223618a4-3d33-4ce5-81da-4dbdc3bafeee&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_roles.Role.MANAGER, f.user2.address);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// userThree (trusted contract) mints Kresko asset for userOne\nconst mintAmount = (0, _values.toBig)(1);\nawait f.User2.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Check that debt exists now for userOne\nconst userTwoBalanceAfter = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(userTwoBalanceAfter).to.equal(mintAmount);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3fd94b57-8ad6-4d15-9f4a-0c82b8d5941f&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetMinted event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should emit KreskoAssetMinted event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:83,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: f.initialMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, &#x27;KreskoAssetMinted&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7513050b-26e0-43ec-a4b3-bec04eb972d2&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:42,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user2.address,\n    krAsset: f.KrAsset.address,\n    amount: (0, _values.toBig)(1),\n    receiver: f.user2.address\n}, await hre.updateData())).to.be.revertedWith(`AccessControl: account ${f.user1.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a5fdf104-5cde-410f-9b05-aeff2312f647&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const currMinimumDebtValue = await _optimizations.default.getMinDebtValue();\nconst mintAmount = currMinimumDebtValue.wadDiv(_mocks.TEN_USD.ebn(8)).sub(1e9);\nawait (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;MINT_VALUE_LESS_THAN_MIN_DEBT_VALUE&#x27;).withArgs(f.KrAsset.errorId, 10e8 - 1, currMinimumDebtValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;310da3c3-0c92-491b-a0e3-5620da8d85db&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt to mint a non-deployed, non-whitelisted Kresko asset\nawait (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: &#x27;0x0000000000000000000000000000000000000002&#x27;,\n    amount: (0, _values.toBig)(1),\n    receiver: f.user1.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ASSET_NOT_MINTABLE_FROM_MINTER&#x27;).withArgs([\n    &#x27;&#x27;,\n    &#x27;0x0000000000000000000000000000000000000002&#x27;\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;29036c4e-368f-42d3-9f0d-da8da523fac6&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const collateralAmountDeposited = await _optimizations.default.getAccountCollateralAmount(f.user1.address, f.Collateral.address);\nconst MCR = await hre.Diamond.getMinCollateralRatioMinter();\nconst mcrAmount = collateralAmountDeposited.percentMul(MCR);\nconst mintAmount = mcrAmount.add(1);\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nconst userState = await hre.Diamond.getAccountState(f.user1.address);\nawait (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ACCOUNT_COLLATERAL_VALUE_LESS_THAN_REQUIRED&#x27;).withArgs(f.user1.address, userState.totalCollateralValue, mintValue.percentMul(MCR), MCR);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a98bbfe1-e9ba-4863-a49b-5d330eb71cf1&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:143,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// User deposits another 10,000 collateral tokens, enabling mints of up to 20,000/1.5 = ~13,333 kresko asset tokens\nawait f.Collateral.setBalance(f.user1, (0, _values.toBig)(100000000));\nawait (0, _chai.expect)(f.User1.depositCollateral(f.user1.address, f.Collateral.address, (0, _values.toBig)(10000))).not.to.be.reverted;\nconst assetSupplyLimit = (0, _values.toBig)(1);\nconst mintAmount = (0, _values.toBig)(2);\nawait f.KrAsset.update({\n    maxDebtMinter: assetSupplyLimit\n});\nawait (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;EXCEEDS_ASSET_MINTING_LIMIT&#x27;).withArgs(f.KrAsset.errorId, (await f.KrAsset.contract.totalSupply()).add(mintAmount), assetSupplyLimit);\nawait f.KrAsset.update({\n    maxDebtMinter: assetSupplyLimit\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4972bf2f-ccdc-452b-9d65-4d773f0359fc&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2d555278-c638-4fbd-ae13-6894320f5947&quot;,&quot;parentUUID&quot;:&quot;a546ae9f-37f3-41df-9e91-05e600e4ff89&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;73ffb6c0-eebd-4004-b258-38e7017e3be7&quot;,&quot;c88c8a78-d179-4475-8a08-aceb6aa4e69f&quot;,&quot;dda02433-07a8-4160-89ce-fdfeadb4e6cc&quot;,&quot;223618a4-3d33-4ce5-81da-4dbdc3bafeee&quot;,&quot;3fd94b57-8ad6-4d15-9f4a-0c82b8d5941f&quot;,&quot;7513050b-26e0-43ec-a4b3-bec04eb972d2&quot;,&quot;a5fdf104-5cde-410f-9b05-aeff2312f647&quot;,&quot;310da3c3-0c92-491b-a0e3-5620da8d85db&quot;,&quot;29036c4e-368f-42d3-9f0d-da8da523fac6&quot;,&quot;a98bbfe1-e9ba-4863-a49b-5d330eb71cf1&quot;,&quot;4972bf2f-ccdc-452b-9d65-4d773f0359fc&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;2d555278-c638-4fbd-ae13-6894320f5947&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:1162,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d17bda01-68c3-4f2a-84c5-339cfd93bd32&quot;,&quot;title&quot;:&quot;#mint - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;628a64c5-269b-4dca-8fef-3d3eec7265de&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst balanceBefore = await f.KrAsset.balanceOf(f.user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0ac5a6b2-cc96-4e77-8bab-a4c662a04569&quot;,&quot;parentUUID&quot;:&quot;628a64c5-269b-4dca-8fef-3d3eec7265de&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst balanceBefore = await f.KrAsset.balanceOf(f.user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5761833c-9815-4d70-852e-1483e2e09d70&quot;,&quot;parentUUID&quot;:&quot;628a64c5-269b-4dca-8fef-3d3eec7265de&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst balanceBefore = await f.KrAsset.balanceOf(f.user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.mul(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cd0768b5-bca9-4987-a466-b458e896dec5&quot;,&quot;parentUUID&quot;:&quot;628a64c5-269b-4dca-8fef-3d3eec7265de&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt amounts are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst balanceBefore = await f.KrAsset.balanceOf(f.user1.address);\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\n(0, _chai.expect)(balanceAfter).to.equal(mintAmount.div(denominator));\n(0, _chai.expect)(balanceBefore).to.not.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterAdjusted).to.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;626ebafb-5c6b-4b41-9cbc-bbbd15dda8da&quot;,&quot;parentUUID&quot;:&quot;628a64c5-269b-4dca-8fef-3d3eec7265de&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0ac5a6b2-cc96-4e77-8bab-a4c662a04569&quot;,&quot;5761833c-9815-4d70-852e-1483e2e09d70&quot;,&quot;cd0768b5-bca9-4987-a466-b458e896dec5&quot;,&quot;626ebafb-5c6b-4b41-9cbc-bbbd15dda8da&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:369,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;22a6fff3-ebeb-4c3c-81a9-cf21ebaa381f&quot;,&quot;title&quot;:&quot;debt values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when mint is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:160,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst valueBeforeRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n// Adjust price accordingly\nconst { pyth: assetPrice } = await f.KrAsset.getPrice();\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPrice.div(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4da4dfa0-5398-481f-ba54-a8746a8d339c&quot;,&quot;parentUUID&quot;:&quot;22a6fff3-ebeb-4c3c-81a9-cf21ebaa381f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when mint is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when mint is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:161,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\nconst valueBeforeRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n// Adjust price accordingly\nconst { pyth: assetPrice } = await f.KrAsset.getPrice();\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPrice.mul(denominator), 8));\n// Rebase the asset according to params\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6221ffcc-8f39-4248-9523-3e56b00576e4&quot;,&quot;parentUUID&quot;:&quot;22a6fff3-ebeb-4c3c-81a9-cf21ebaa381f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:157,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.mul(denominator);\nconst { pyth: assetPrice } = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price accordingly\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPrice, 8) / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: equalMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3a660881-f125-4262-bb75-44c2c57acd52&quot;,&quot;parentUUID&quot;:&quot;22a6fff3-ebeb-4c3c-81a9-cf21ebaa381f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.div(denominator);\nconst { pyth: assetPrice } = await f.KrAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price accordingly\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPrice.mul(denominator), 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: equalMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(valueAfterRebase).to.equal(valueBeforeRebase);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4850312-7276-4b96-8d84-240e3c2b1736&quot;,&quot;parentUUID&quot;:&quot;22a6fff3-ebeb-4c3c-81a9-cf21ebaa381f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4da4dfa0-5398-481f-ba54-a8746a8d339c&quot;,&quot;6221ffcc-8f39-4248-9523-3e56b00576e4&quot;,&quot;3a660881-f125-4262-bb75-44c2c57acd52&quot;,&quot;a4850312-7276-4b96-8d84-240e3c2b1736&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:644,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;8d6d4b2c-5f67-4d2f-b966-868c3b2b444f&quot;,&quot;title&quot;:&quot;debt values and amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:293,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { pyth: assetPrice } = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintAmountAfterRebase = mintAmount.mul(denominator);\nconst assetPriceRebase = assetPrice.div(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(f.user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.equal(debtValueAfterFirstMint);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterFirstRebase, f.KrAsset)).to.equal(valueBeforeRebase);\n// Mint after rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmountAfterRebase,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Ensure debt amounts and balances match\nconst balanceAfterSecondMint = await f.KrAsset.contract.balanceOf(f.user1.address);\n// Ensure balance matches\nconst expectedBalanceAfterSecondMint = balanceAfterFirstRebase.add(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterSecondMint).to.equal(expectedBalanceAfterSecondMint);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(await (0, _calculations.fromScaledAmount)(debtValueAfterSecondMint, f.KrAsset)).to.closeTo(debtValueAfterFirstMint.mul(2), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(valueBeforeRebase.mul(2), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0153384-bdc0-486c-a73f-a79034d68f5d&quot;,&quot;parentUUID&quot;:&quot;8d6d4b2c-5f67-4d2f-b966-868c3b2b444f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase debt values and amounts are calculated correctly when minted before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:282,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { pyth: assetPrice } = await f.KrAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintAmountAfterRebase = mintAmount.div(denominator);\nconst assetPriceRebase = assetPrice.mul(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Mint before rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Get results\nconst balanceAfterFirstMint = await f.KrAsset.contract.balanceOf(f.user1.address);\nconst debtAmountAfterFirstMint = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfterFirstMint = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n// Assert\n(0, _chai.expect)(balanceAfterFirstMint).to.equal(debtAmountAfterFirstMint);\n(0, _chai.expect)(valueBeforeRebase).to.equal(debtValueAfterFirstMint);\n// Adjust price and rebase\nawait f.KrAsset.setPrice((0, _values.fromBig)(assetPriceRebase, 8));\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, _krassets.getDebtIndexAdjustedBalance)(f.user1, f.KrAsset);\nconst debtAmountAfterFirstRebase = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(balanceAfterFirstRebase).to.equal(mintAmountAfterRebase);\n(0, _chai.expect)(balanceAfterFirstRebaseAdjusted).to.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(debtValueAfterFirstRebase).to.equal(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint, f.KrAsset));\n(0, _chai.expect)(debtValueAfterFirstRebase).to.equal(await (0, _calculations.toScaledAmount)(valueBeforeRebase, f.KrAsset));\n// Mint after rebase\nawait f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmountAfterRebase,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await hre.Diamond.getAccountTotalDebtValue(f.user1.address);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(await (0, _calculations.toScaledAmount)(debtValueAfterFirstMint.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);\n(0, _chai.expect)(debtValueAfterSecondMint).to.closeTo(await (0, _calculations.toScaledAmount)(valueBeforeRebase.mul(2), f.KrAsset), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce80dfea-ae75-41d8-8eda-46ffe137ab1f&quot;,&quot;parentUUID&quot;:&quot;8d6d4b2c-5f67-4d2f-b966-868c3b2b444f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f0153384-bdc0-486c-a73f-a79034d68f5d&quot;,&quot;ce80dfea-ae75-41d8-8eda-46ffe137ab1f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:575,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: f.initialMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e69acb89-e60c-4f7b-b04c-c8d1fe04114c&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to burn some of their Kresko asset balances&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn some of their Kresko asset balances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _values.toBig)(1);\nconst kreskoAssetIndex = 0;\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Confirm the user no long holds the burned Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(f.user1.address);\n(0, _chai.expect)(userBalance).to.equal(f.initialMintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userDebt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(userDebt).to.closeTo(f.initialMintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;05457568-8f02-42e8-9787-ff5c681a266f&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:102,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.grantRole(_roles.Role.MANAGER, f.user2.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, _values.toBig)(1);\nconst kreskoAssetIndex = 0;\nconst userOneBalanceBefore = await f.KrAsset.balanceOf(f.user1.address);\n// User three burns it&#x27;s KreskoAsset to reduce userOnes debt\nawait f.User2.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user2.address\n}, await hre.updateData());\n// await expect(f.User2.burnKreskoAsset(f.user1.address, f.KrAsset.address, burnAmount, kreskoAssetIndex)).to.not.be\n//   .reverted;\n// Confirm the userOne had no effect on it&#x27;s kreskoAsset balance\nconst userOneBalance = await f.KrAsset.balanceOf(f.user1.address);\n(0, _chai.expect)(userOneBalance).to.equal(userOneBalanceBefore, &#x27;userOneBalance&#x27;);\n// Confirm the userThree no long holds the burned Kresko asset amount\nconst userThreeBalance = await f.KrAsset.balanceOf(f.user2.address);\n(0, _chai.expect)(userThreeBalance).to.equal(f.initialMintAmount.sub(burnAmount), &#x27;userThreeBalance&#x27;);\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount), &#x27;totalSupplyAfter&#x27;);\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(f.user2.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n], &#x27;mintedKreskoAssetsAfter&#x27;);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(userOneDebt).to.equal(f.initialMintAmount.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f0e3af09-f6b4-40db-8543-cf0f9d24b8f1&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;277dac0e-5f78-4700-94cc-07fc26ecafb5&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:100,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalanceBefore = await f.KrAsset.balanceOf(f.user1.address);\nconst kreskoAssetTotalSupplyBefore = await f.KrAsset.contract.totalSupply();\n// Calculate actual burn amount\nconst userOneDebt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\nconst minDebtValue = (0, _values.fromBig)(await _optimizations.default.getMinDebtValue(), 8);\nconst oraclePrice = f.KrAsset.config.args.price;\nconst burnAmount = (0, _values.toBig)((0, _values.fromBig)(userOneDebt) - minDebtValue / oraclePrice);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Confirm the user holds the expected Kresko asset amount\nconst userBalance = await f.KrAsset.balanceOf(f.user1.address);\n// expect(fromBig(userBalance)).to.equal(fromBig(userBalanceBefore.sub(burnAmount)));\n(0, _chai.expect)(userBalance).eq(userBalanceBefore.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await f.KrAsset.contract.totalSupply();\n(0, _chai.expect)(kreskoAssetTotalSupplyAfter).eq(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfter).to.deep.equal([\n    f.KrAsset.address\n]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst newUserDebt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\n(0, _chai.expect)(newUserDebt).to.be.equal(userOneDebt.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fb03cb48-6556-48a7-b5c1-4cc10fdcff57&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetBurned event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should emit KreskoAssetBurned event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:82,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst tx = await f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: f.initialMintAmount.div(5),\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData());\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, &#x27;KreskoAssetBurned&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.kreskoAsset).to.equal(f.KrAsset.address);\n(0, _chai.expect)(event.amount).to.equal(f.initialMintAmount.div(5));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d2b31409-409f-4fb6-abff-db74ecf25ad8&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:153,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const secondMintAmount = 1;\nconst burnAmount = f.initialMintAmount.add(secondMintAmount);\nawait (0, _chai.expect)(f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: secondMintAmount,\n    receiver: f.user1.address\n}, await hre.updateData())).to.not.be.reverted;\nconst kreskoAssetIndex = 0;\nawait (0, _chai.expect)(f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData())).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4cd26612-7e68-49d4-8775-93627ffd60dc&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:47,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: 0,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ZERO_BURN&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c29ebf1a-1a42-43ec-b2ee-41ffa5de606c&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:43,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(f.User2.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: 100,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData())).to.be.revertedWith(`AccessControl: account ${f.user2.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5c631d96-f3ee-43bb-8ae1-60a6cbc66580&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to use another repayee to burn kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to use another repayee to burn kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, _chai.expect)(f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: 100,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user2.address\n}, await hre.updateData())).to.be.revertedWith(`AccessControl: account ${f.user1.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;93c01ace-9e2d-43b5-9f14-510690b576d5&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst debt = await _optimizations.default.getAccountDebtAmount(f.user1.address, f.KrAsset);\nconst burnAmount = debt.add((0, _values.toBig)(1));\nawait (0, _chai.expect)(f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae837239-1b8c-4607-a2f2-2a4e645df126&quot;,&quot;parentUUID&quot;:&quot;b136fea2-079f-4a4e-88e4-7cb9cc76604e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;4b857d28-4ad5-43d3-aef9-5d025a1f5245&quot;,&quot;title&quot;:&quot;Protocol open fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit FeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol open fee should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit FeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:175,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const openFee = 0.01e4;\nawait f.KrAsset.update({\n    openFee,\n    maxDebtMinter: _values.MaxUint128\n});\nconst mintAmount = (0, _values.toBig)(1);\nconst mintValue = mintAmount.wadMul(_mocks.TEN_USD.ebn(8));\nconst expectedFeeValue = mintValue.percentMul(openFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.wadDiv(_mocks.TEN_USD.ebn(8));\n// Get the balances prior to the fee being charged.\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Mint Kresko asset\nconst tx = await f.User1.mintKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: mintAmount,\n    receiver: f.user1.address\n}, await hre.updateData());\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal(expectedCollateralFeeAmount);\n// Ensure the emitted event is as expected.\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedCollateralFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n(0, _chai.expect)(event.feeType).to.equal(_types.MinterFee.OPEN);\n// Now verify that calcExpectedFee function returns accurate fee amount\nconst [, values] = await hre.Diamond.previewFee(f.user1.address, f.KrAsset.address, mintAmount, _types.MinterFee.OPEN);\n(0, _chai.expect)(values[0]).eq(expectedCollateralFeeAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c3c58f9d-8d10-496a-b944-a47ad3842cb6&quot;,&quot;parentUUID&quot;:&quot;4b857d28-4ad5-43d3-aef9-5d025a1f5245&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c3c58f9d-8d10-496a-b944-a47ad3842cb6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:175,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c22f15b5-bc5d-43b0-be7a-912748a5fb39&quot;,&quot;title&quot;:&quot;Protocol Close Fee&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit FeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit FeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:88,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const burnAmount = (0, _values.toBig)(1);\nconst burnValue = burnAmount.wadMul(_mocks.TEN_USD.ebn(8));\nconst closeFee = f.KrAsset.config.args.krAssetConfig.closeFee // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\n;\nconst expectedFeeValue = burnValue.percentMul(closeFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.wadDiv(f.Collateral.config.args.price.ebn(8));\nconst feeRecipient = await hre.Diamond.getFeeRecipient();\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await f.Collateral.balanceOf(feeRecipient);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nconst tx = await f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: burnAmount,\n    mintIndex: kreskoAssetIndex,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await f.Collateral.balanceOf(hre.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await f.Collateral.balanceOf(feeRecipient);\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, _chai.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\n(0, _chai.expect)(feeRecipientBalanceIncrease).to.equal(expectedCollateralFeeAmount);\n// Ensure the emitted event is as expected.\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(event.account).to.equal(f.user1.address);\n(0, _chai.expect)(event.paymentCollateralAsset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedCollateralFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n(0, _chai.expect)(event.feeType).to.equal(_types.MinterFee.CLOSE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dfa68e52-881f-4cfe-9872-1c37b4c11ca7&quot;,&quot;parentUUID&quot;:&quot;c22f15b5-bc5d-43b0-be7a-912748a5fb39&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:294,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = (0, _values.toBig)(1);\nconst expectedFeeAmount = burnAmount.percentMul(f.KrAsset.config.args.krAssetConfig.closeFee);\nconst expectedFeeValue = expectedFeeAmount.wadMul((0, _values.toBig)(_mocks.TEN_USD, 8));\nconst event = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: f.user2,\n    asset: f.KrAsset,\n    amount: burnAmount\n}), hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n(0, _chai.expect)(event.feeType).to.equal(_types.MinterFee.CLOSE);\n// rebase params\nconst denominator = 4;\nconst positive = true;\nawait f.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount.mul(denominator);\nawait (0, _collaterals.withdrawCollateral)({\n    user: f.user2,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(wAmount)\n}, await hre.updateData());\nconst eventAfterRebase = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: f.user2,\n    asset: f.KrAsset,\n    amount: burnAmountRebase\n}), hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8537403b-08d2-4b38-882a-27ccfb688396&quot;,&quot;parentUUID&quot;:&quot;c22f15b5-bc5d-43b0-be7a-912748a5fb39&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol Close Fee should charge correct protocol close fee after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:307,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const wAmount = 1;\nconst burnAmount = (0, _values.toBig)(1);\nconst expectedFeeAmount = burnAmount.percentMul(f.KrAsset.config.args.krAssetConfig.closeFee);\nconst expectedFeeValue = expectedFeeAmount.wadMul((0, _values.toBig)(_mocks.TEN_USD, 8));\nconst event = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: f.user2,\n    asset: f.KrAsset,\n    amount: burnAmount\n}), hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(event.paymentValue).to.equal(expectedFeeValue);\n(0, _chai.expect)(event.feeType).to.equal(_types.MinterFee.CLOSE);\n// rebase params\nconst denominator = 4;\nconst positive = false;\nconst priceAfter = (0, _values.fromBig)((await f.KrAsset.getPrice()).pyth, 8) * denominator;\nawait f.KrAsset.setPrice(priceAfter);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nconst burnAmountRebase = burnAmount.div(denominator);\nawait (0, _collaterals.withdrawCollateral)({\n    user: f.user2,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(wAmount)\n}, await hre.updateData());\nconst eventAfterRebase = await (0, _events.getInternalEvent)(await (0, _krassets.burnKrAsset)({\n    user: f.user2,\n    asset: f.KrAsset,\n    amount: burnAmountRebase\n}), hre.Diamond, &#x27;FeePaid&#x27;);\n(0, _chai.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, _chai.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, _chai.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cd5cb781-f1e7-4cb7-8e26-4a336d5e2eba&quot;,&quot;parentUUID&quot;:&quot;c22f15b5-bc5d-43b0-be7a-912748a5fb39&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;dfa68e52-881f-4cfe-9872-1c37b4c11ca7&quot;,&quot;8537403b-08d2-4b38-882a-27ccfb688396&quot;,&quot;cd5cb781-f1e7-4cb7-8e26-4a336d5e2eba&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:689,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[&quot;05457568-8f02-42e8-9787-ff5c681a266f&quot;,&quot;f0e3af09-f6b4-40db-8543-cf0f9d24b8f1&quot;,&quot;fb03cb48-6556-48a7-b5c1-4cc10fdcff57&quot;,&quot;d2b31409-409f-4fb6-abff-db74ecf25ad8&quot;,&quot;4cd26612-7e68-49d4-8775-93627ffd60dc&quot;,&quot;c29ebf1a-1a42-43ec-b2ee-41ffa5de606c&quot;,&quot;5c631d96-f3ee-43bb-8ae1-60a6cbc66580&quot;,&quot;93c01ace-9e2d-43b5-9f14-510690b576d5&quot;,&quot;ae837239-1b8c-4607-a2f2-2a4e645df126&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;277dac0e-5f78-4700-94cc-07fc26ecafb5&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:719,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a0a5b1ba-7da0-4798-847b-76b16128798d&quot;,&quot;title&quot;:&quot;#burn - rebase&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase \&quot;before each\&quot; hook in \&quot;#burn - rebase\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:80,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _krassets.mintKrAsset)({\n    asset: f.KrAsset,\n    amount: mintAmount,\n    user: f.user1\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;abd5e6c7-f9b0-4ed1-991d-d08ee2a32b51&quot;,&quot;parentUUID&quot;:&quot;a0a5b1ba-7da0-4798-847b-76b16128798d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;68a8ebb6-0043-483e-962a-94077b7d7ed1&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:371,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: repayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n(0, _chai.expect)(debtAfter).to.equal(0);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(0);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(f.initialMintAmount) // WEI\n;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7368777a-c055-4c0c-b7d8-e5f731d2aaf6&quot;,&quot;parentUUID&quot;:&quot;68a8ebb6-0043-483e-962a-94077b7d7ed1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:148,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: repayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).mul(denominator);\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.mul(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.div(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2be01d2a-578e-4eb7-92ab-c2b6d39deb85&quot;,&quot;parentUUID&quot;:&quot;68a8ebb6-0043-483e-962a-94077b7d7ed1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:141,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst repayAmount = debt;\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: repayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = 0;\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = (0, _values.fromBig)(await f.KrAsset.contract.balanceOf(f.user1.address));\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal((0, _values.toBig)(expectedBalanceAfterBurn * denominator).add(f.initialMintAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e871ced6-2e71-409b-82f1-63db88b99b9c&quot;,&quot;parentUUID&quot;:&quot;68a8ebb6-0043-483e-962a-94077b7d7ed1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt amounts are calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:142,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst repayAmount = debt.div(2);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: repayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).div(denominator);\n(0, _chai.expect)(debtAfter).to.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.div(denominator).sub(repayAmount);\nconst balanceAfterBurn = await f.KrAsset.contract.balanceOf(f.user1.address);\n(0, _chai.expect)(balanceAfterBurn).to.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.mul(denominator)).add(f.initialMintAmount);\nconst wkrAssetBalanceKresko = await f.KrAsset.anchor.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed780398-c017-47e9-b5b9-b464b66b7b61&quot;,&quot;parentUUID&quot;:&quot;68a8ebb6-0043-483e-962a-94077b7d7ed1&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7368777a-c055-4c0c-b7d8-e5f731d2aaf6&quot;,&quot;2be01d2a-578e-4eb7-92ab-c2b6d39deb85&quot;,&quot;e871ced6-2e71-409b-82f1-63db88b99b9c&quot;,&quot;ed780398-c017-47e9-b5b9-b464b66b7b61&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:802,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;f036071d-e53c-4869-9667-11a486d07c9a&quot;,&quot;title&quot;:&quot;debt value and mintedKreskoAssets book-keeping is calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:132,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst fullRepayAmount = mintAmount.mul(denominator);\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: fullRepayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c3b2309d-23f2-430d-9c38-8577666c06df&quot;,&quot;parentUUID&quot;:&quot;f036071d-e53c-4869-9667-11a486d07c9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:163,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD / denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Should contain minted krAsset\nconst mintedKreskoAssetsBeforeBurn = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsBeforeBurn).to.contain(f.KrAsset.address);\n// Burn assets\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: debt.div(2),\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await _optimizations.default.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aa2a53b6-6204-484e-bdcf-e27bb29c0a18&quot;,&quot;parentUUID&quot;:&quot;f036071d-e53c-4869-9667-11a486d07c9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:131,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst fullRepayAmount = mintAmount.div(denominator);\n// Adjust price according to rebase params\nawait f.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: fullRepayAmount,\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n(0, _chai.expect)(debtValueAfter).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;75c45928-d851-44e3-a120-9ac25ef5e767&quot;,&quot;parentUUID&quot;:&quot;f036071d-e53c-4869-9667-11a486d07c9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:163,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintValue = await hre.Diamond.getValue(f.KrAsset.address, mintAmount);\nawait f.KrAsset.setPrice(_mocks.TEN_USD * denominator);\nawait f.KrAsset.contract.rebase((0, _values.toBig)(denominator), positive, []);\n// Pay half of debt\nconst debt = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nawait f.User1.burnKreskoAsset({\n    account: f.user1.address,\n    krAsset: f.KrAsset.address,\n    amount: debt.div(2),\n    mintIndex: 0,\n    repayee: f.user1.address\n}, await hre.updateData());\n// Debt value after half repayment\nconst debtAfter = await hre.Diamond.getAccountDebtAmount(f.user1.address, f.KrAsset.address);\nconst debtValueAfter = await hre.Diamond.getValue(f.KrAsset.address, debtAfter);\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, _chai.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hre.Diamond.getAccountMintedAssets(f.user1.address);\n(0, _chai.expect)(mintedKreskoAssetsAfterBurn).to.contain(f.KrAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0a9db3e0-57aa-4017-8d7e-a84b11f81228&quot;,&quot;parentUUID&quot;:&quot;f036071d-e53c-4869-9667-11a486d07c9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c3b2309d-23f2-430d-9c38-8577666c06df&quot;,&quot;aa2a53b6-6204-484e-bdcf-e27bb29c0a18&quot;,&quot;75c45928-d851-44e3-a120-9ac25ef5e767&quot;,&quot;0a9db3e0-57aa-4017-8d7e-a84b11f81228&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:589,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c7fb5f5a-cda4-416d-9fab-9b498aae8e0b&quot;,&quot;title&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw \&quot;before each\&quot; hook in \&quot;CollateralReceiver - UncheckedCollateralWithdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n[, , [user]] = f.users;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d4e5336c-7b86-4897-a0ff-9c0f721b85b8&quot;,&quot;parentUUID&quot;:&quot;c7fb5f5a-cda4-416d-9fab-9b498aae8e0b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;26710765-ff7d-40d2-84ef-fcf2eb80a242&quot;,&quot;title&quot;:&quot;#unchecked-collateral-withdrawal&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;title&quot;:&quot;#unchecked-withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;withdraw correct amount&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw withdraw correct amount&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawalAmount = 42069;\nawait (0, _chai.expect)(f.Receiver.testWithdrawalAmount(f.Collateral.address, withdrawalAmount, await hre.updateData())).to.not.be.revertedWith(&#x27;wrong amount received&#x27;);\n(0, _chai.expect)(await f.Collateral.balanceOf(f.Receiver.address)).to.equal(withdrawalAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;75f5645e-739f-43c8-9322-539bea49a5a8&quot;,&quot;parentUUID&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should send correct values to the callback&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should send correct values to the callback&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst balKreskoBefore = await f.Collateral.contract.balanceOf(hre.Diamond.address);\nawait Receiver.test(f.Collateral.address, 1, await hre.updateData());\n(0, _chai.expect)(await Receiver.collateralAsset()).to.equal(f.Collateral.address);\n(0, _chai.expect)(await Receiver.account()).to.equal(user.address);\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(1);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(1);\nconst balKreskoAfter = await f.Collateral.contract.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore.sub(balKreskoAfter)).to.equal(1);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;445fcba5-61b4-400c-8615-ffb7b5916808&quot;,&quot;parentUUID&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw collateral up to MRC without returning it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw collateral up to MRC without returning it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:209,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait Receiver.test(f.Collateral.address, maxWithdrawAmount, await hre.updateData());\n(0, _chai.expect)((await Receiver.userData()).val).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await f.Collateral.contract.balanceOf(Receiver.address)).to.equal(maxWithdrawAmount);\n(0, _chai.expect)(await hre.Diamond.getAccountCollateralRatio(user.address)).to.be.eq(1.5e4);\nawait (0, _chai.expect)(Receiver.test(f.Collateral.address, 10e15.toString(), await hre.updateData())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c29fdecb-3335-4c94-a666-1213d6877c51&quot;,&quot;parentUUID&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and return it&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and return it&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\nconst balKreskoBefore = await f.Collateral.balanceOf(hre.Diamond.address);\nawait Receiver.testRedeposit(f.Collateral.address, deposits, await hre.updateData());\n(0, _chai.expect)(await Receiver.withdrawalAmountRequested()).to.equal(deposits);\n(0, _chai.expect)(await Receiver.withdrawalAmountReceived()).to.equal(deposits);\n(0, _chai.expect)(await f.Collateral.balanceOf(Receiver.address)).to.equal(0);\nconst balKreskoAfter = await f.Collateral.balanceOf(hre.Diamond.address);\n(0, _chai.expect)(balKreskoBefore).to.equal(balKreskoAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e056f424-1fed-4103-8ba8-861f379f9afe&quot;,&quot;parentUUID&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw should be able to withdraw full collateral and deposit another asset in its place&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:141,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst deposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral.address);\n(0, _chai.expect)(deposits.gt(0)).to.be.true;\n// set second collateral price to half of the first and balance to twice that\nawait f.Collateral2.setPrice(10);\nawait f.Collateral2.setBalance(user, f.depositAmount);\nawait f.Collateral2.contract.setVariable(&#x27;_allowances&#x27;, {\n    [user.address]: {\n        [hre.Diamond.address]: f.depositAmount,\n        [Receiver.address]: f.depositAmount\n    }\n});\nawait Receiver.testDepositAlternate(f.Collateral.address, deposits, f.Collateral2.address, await hre.updateData());\nconst secondCollateralDeposits = await _optimizations.default.getAccountCollateralAmount(user.address, f.Collateral2.address);\n(0, _chai.expect)(secondCollateralDeposits.eq(deposits)).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fb9216b4-eeb3-4760-b74f-70079d43d6ac&quot;,&quot;parentUUID&quot;:&quot;70c20f0b-0bbe-4d00-bb13-3be4c695174a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;75f5645e-739f-43c8-9322-539bea49a5a8&quot;,&quot;445fcba5-61b4-400c-8615-ffb7b5916808&quot;,&quot;c29fdecb-3335-4c94-a666-1213d6877c51&quot;,&quot;e056f424-1fed-4103-8ba8-861f379f9afe&quot;,&quot;fb9216b4-eeb3-4760-b74f-70079d43d6ac&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:631,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;74763a7d-ce36-4da9-8187-4063a5f65a33&quot;,&quot;title&quot;:&quot;#unchecked-withdraw-reverts&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/05-collateral-receiver.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/05-collateral-receiver.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert on zero withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert on zero withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 0, await hre.updateData())).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 0)).to.be.revertedWith(Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1bd39842-5e00-4aa0-bac2-211b79aad7b6&quot;,&quot;parentUUID&quot;:&quot;74763a7d-ce36-4da9-8187-4063a5f65a33&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert with no manager role&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert with no manager role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.revokeRole(_roles.Role.MANAGER, f.Receiver.address);\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, 10000, await hre.updateData())).to.be.reverted;\n            // await expect(f.Receiver.test(f.Collateral.address, 10000)).to.be.revertedWith(\n            //     `AccessControl: account ${f.Receiver.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`,\n            // );&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2e25252-aac1-4094-b6d8-ea307974b078&quot;,&quot;parentUUID&quot;:&quot;74763a7d-ce36-4da9-8187-4063a5f65a33&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after withdrawal&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after withdrawal&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:102,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(f.Receiver.test(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()), await hre.updateData())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b863e9f6-5eaa-42f1-8f40-68080075010f&quot;,&quot;parentUUID&quot;:&quot;74763a7d-ce36-4da9-8187-4063a5f65a33&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if under MCR after redeposit&quot;,&quot;fullTitle&quot;:&quot;CollateralReceiver - UncheckedCollateralWithdraw #unchecked-collateral-withdrawal #unchecked-withdraw-reverts should revert if under MCR after redeposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:107,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Receiver = f.Receiver;\nconst { maxWithdrawAmount } = await (0, _collaterals.getMaxWithdrawal)(user.address, f.Collateral);\n(0, _chai.expect)(maxWithdrawAmount.gt(0)).to.be.true;\nawait (0, _chai.expect)(Receiver.testInsufficientRedeposit(f.Collateral.address, maxWithdrawAmount.add(0.5e18.toString()), await hre.updateData())).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;616d437b-bcf1-4efc-a660-1794ae726ed6&quot;,&quot;parentUUID&quot;:&quot;74763a7d-ce36-4da9-8187-4063a5f65a33&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1bd39842-5e00-4aa0-bac2-211b79aad7b6&quot;,&quot;c2e25252-aac1-4094-b6d8-ea307974b078&quot;,&quot;b863e9f6-5eaa-42f1-8f40-68080075010f&quot;,&quot;616d437b-bcf1-4efc-a660-1794ae726ed6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:321,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;title&quot;:&quot;Gating&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/minter/06-gating.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/06-gating.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;fullTitle&quot;:&quot;Gating \&quot;before each\&quot; hook in \&quot;Gating\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n[nft] = await hre.deploy(&#x27;MockERC1155&#x27;, {\n    args: [\n        &#x27;MockERC1155_1&#x27;,\n        &#x27;MockERC1155_1&#x27;,\n        &#x27;https://mock.com/{id}.json&#x27;,\n        &#x27;https://mock.com/contract.json&#x27;\n    ],\n    deploymentName: &#x27;MockERC1155_1&#x27;,\n    from: hre.users.deployer.address\n});\n[nft2] = await hre.deploy(&#x27;MockERC1155&#x27;, {\n    args: [\n        &#x27;MockERC1155_2&#x27;,\n        &#x27;MockERC1155_2&#x27;,\n        &#x27;https://mock2.com/{id}.json&#x27;,\n        &#x27;https://mock2.com/contract2.json&#x27;\n    ],\n    deploymentName: &#x27;MockERC1155_2&#x27;,\n    from: hre.users.deployer.address\n});\n[this.GatingManager] = await hre.deploy(&#x27;GatingManager&#x27;, {\n    args: [\n        hre.users.deployer.address,\n        nft.address,\n        nft2.address,\n        1\n    ],\n    from: hre.users.deployer.address\n});\nawait hre.Diamond.setGatingManager(this.GatingManager.address);\n// setup collateral for userOne and userTwo\nthis.initialBalance = (0, _values.toBig)(100000);\nawait f.Collateral.setBalance(hre.users.userOne, this.initialBalance, hre.Diamond.address);\nawait f.Collateral.setBalance(hre.users.userTwo, this.initialBalance, hre.Diamond.address);\nthis.depositArgsOne = {\n    user: hre.users.userOne,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(10000)\n};\nthis.depositArgsTwo = {\n    user: hre.users.userTwo,\n    asset: f.Collateral,\n    amount: (0, _values.toBig)(10000)\n};&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7ff5a147-9c7d-4953-b4ca-eed30449dc48&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not allow users to access phase 1 without nfts&quot;,&quot;fullTitle&quot;:&quot;Gating should not allow users to access phase 1 without nfts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;\nawait nft[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 1, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 2, 1);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9bb23284-d94b-46f6-af6a-3f88156e1958&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to access in phase 1&quot;,&quot;fullTitle&quot;:&quot;Gating should allow users to access in phase 1&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await nft[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 1, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 2, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 3, 1);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bd48a878-1b57-4e8e-81b6-933a39ca1ec5&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to access phase 2 without nfts&quot;,&quot;fullTitle&quot;:&quot;Gating should not allow users to access phase 2 without nfts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.GatingManager.setPhase(2);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;\nawait nft[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7a3ba799-b435-4e69-a6f1-2c4978ccc00a&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to access in phase 2&quot;,&quot;fullTitle&quot;:&quot;Gating should allow users to access in phase 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.GatingManager.setPhase(2);\nawait nft[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait nft2[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;226ff046-6f75-4a5a-9e69-9d80ab8b558c&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to access phase 3 without nfts&quot;,&quot;fullTitle&quot;:&quot;Gating should not allow users to access phase 3 without nfts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.GatingManager.setPhase(3);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d4790f06-a401-4873-879a-d4421dcfbd22&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to access in phase 3&quot;,&quot;fullTitle&quot;:&quot;Gating should allow users to access in phase 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.GatingManager.setPhase(3);\nawait nft[&#x27;mint(address,uint256,uint256)&#x27;](this.depositArgsOne.user.address, 0, 1);\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsOne.user).depositCollateral(this.depositArgsOne.user.address, f.Collateral.address, this.depositArgsOne.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1066939e-2ff0-4e7d-b207-d0b735ce7267&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;After all the phases anyone should be able to deposit collateral&quot;,&quot;fullTitle&quot;:&quot;Gating After all the phases anyone should be able to deposit collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.GatingManager.setPhase(0);\n// Anyone should be able to deposit collateral\nawait (0, _chai.expect)(hre.Diamond.connect(this.depositArgsTwo.user).depositCollateral(this.depositArgsTwo.user.address, f.Collateral.address, this.depositArgsTwo.amount)).not.to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8939193d-d048-4e15-b74c-b6aeea8c612c&quot;,&quot;parentUUID&quot;:&quot;0f2a7934-dbc2-4062-a7af-cb6cccbcd406&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9bb23284-d94b-46f6-af6a-3f88156e1958&quot;,&quot;bd48a878-1b57-4e8e-81b6-933a39ca1ec5&quot;,&quot;7a3ba799-b435-4e69-a6f1-2c4978ccc00a&quot;,&quot;226ff046-6f75-4a5a-9e69-9d80ab8b558c&quot;,&quot;d4790f06-a401-4873-879a-d4421dcfbd22&quot;,&quot;1066939e-2ff0-4e7d-b207-d0b735ce7267&quot;,&quot;8939193d-d048-4e15-b74c-b6aeea8c612c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:184,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c63c1858-ed05-4085-b6eb-b312518773e1&quot;,&quot;title&quot;:&quot;Oracles&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;fullTitle&quot;:&quot;Oracles \&quot;before each\&quot; hook in \&quot;Oracles\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n[, [user]] = f.users;\nthis.deployer = await hre.ethers.getNamedSigner(&#x27;deployer&#x27;);\nthis.userOne = await hre.ethers.getNamedSigner(&#x27;userOne&#x27;);\nawait f.Collateral.setPrice(10);\nmockPyth = await hre.getContractOrFork(&#x27;MockPyth&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c565e3ad-3326-49ef-9c5a-555a27e10c43&quot;,&quot;parentUUID&quot;:&quot;c63c1858-ed05-4085-b6eb-b312518773e1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;8d12ba83-da26-4dc5-85ae-02d5518798e6&quot;,&quot;title&quot;:&quot;Redstone&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/oracle/00-oracles.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-oracles.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have correct setup&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should have correct setup&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// check initial conditions\n(0, _chai.expect)(await hre.Diamond.getAccountTotalCollateralValue(user.address)).to.equal((0, _values.toBig)(10000, 8), &#x27;collateral value should be $10&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9be9a7eb-1d6f-417c-80ef-d9955800b17e&quot;,&quot;parentUUID&quot;:&quot;8d12ba83-da26-4dc5-85ae-02d5518798e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should get primary price when price +- maxPriceDeviationPct of reference price &quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should get primary price when price +- maxPriceDeviationPct of reference price &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await f.Collateral.setOracleOrder([\n    _types.OracleType.Pyth,\n    _types.OracleType.Chainlink\n]);\n/// set chainlink price to 12\nawait f.Collateral.setPrice(12);\n/// set price to 11\nconst pythPrice = 11;\nawait mockPyth.updatePriceFeeds(await (0, _oracle.mapToUpdateData)(mockPyth, [\n    [\n        f.Collateral.pythId,\n        pythPrice\n    ]\n]));\n(0, _chai.expect)(await hre.Diamond.getAccountTotalCollateralValue(user.address)).to.equal(f.depositAmount.wadMul((0, _values.toBig)(pythPrice, 8)), &#x27;collateral value should be $11&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2cb07290-932d-4f38-aee6-3861999aa27f&quot;,&quot;parentUUID&quot;:&quot;8d12ba83-da26-4dc5-85ae-02d5518798e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if price deviates too much&quot;,&quot;fullTitle&quot;:&quot;Oracles Redstone should revert if price deviates too much&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:113,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;/// set chainlink price to 20\nawait f.Collateral.setPrice(20);\nconst pythPrice = 10;\nawait mockPyth.updatePriceFeeds(await (0, _oracle.mapToUpdateData)(mockPyth, [\n    [\n        f.Collateral.pythId,\n        pythPrice\n    ]\n]));\n// should revert if price deviates more than maxPriceDeviationPct\nawait (0, _chai.expect)(hre.Diamond.getAccountTotalCollateralValue(user.address)).to.be.reverted;\nawait f.Collateral.setPrice(10);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6dce9dff-1a39-489e-b2a2-e19fe60ea7a7&quot;,&quot;parentUUID&quot;:&quot;8d12ba83-da26-4dc5-85ae-02d5518798e6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9be9a7eb-1d6f-417c-80ef-d9955800b17e&quot;,&quot;2cb07290-932d-4f38-aee6-3861999aa27f&quot;,&quot;6dce9dff-1a39-489e-b2a2-e19fe60ea7a7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:211,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b7ab51c5-9e74-4660-9367-d794305a57da&quot;,&quot;title&quot;:&quot;Safety Council&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.defaultFixture)();\n// These are the 5 signers on the SafetyCouncil multisig\nconst { deployer, devOne, userOne, extOne, extTwo } = await hre.ethers.getNamedSigners();\nthis.deployer = deployer;\nthis.devOne = devOne;\nthis.userOne = userOne;\nthis.extOne = extOne;\nthis.extTwo = extTwo;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;019d4770-7823-4b08-8e75-4ea5372a95b3&quot;,&quot;parentUUID&quot;:&quot;b7ab51c5-9e74-4660-9367-d794305a57da&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e1627f44-fa98-492a-9478-3e286aece22d&quot;,&quot;title&quot;:&quot;#setSafetyStateSet&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;correctly sets the safety state&quot;,&quot;fullTitle&quot;:&quot;Safety Council #setSafetyStateSet correctly sets the safety state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const beforeSafetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(beforeSafetyState).to.equal(false);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;setSafetyStateSet&#x27;, [\n    true\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n]);\nconst safetyState = await hre.Diamond.safetyStateSet();\n(0, _chai.expect)(safetyState).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4fd0fe7b-54ae-4feb-886e-0d6f49abc1a4&quot;,&quot;parentUUID&quot;:&quot;e1627f44-fa98-492a-9478-3e286aece22d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4fd0fe7b-54ae-4feb-886e-0d6f49abc1a4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:31,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;13657ecf-f5c7-4b0a-a717-632e38ba7b96&quot;,&quot;title&quot;:&quot;#toggleAssetsPaused&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;afcb0c47-24ca-48a5-b99d-ceb9f0eb444b&quot;,&quot;title&quot;:&quot;multisig signature threshold&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;multisig transacts successfully with majority of signers (3/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with majority of signers (3/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d036a635-2837-40df-adcb-d1c525bc0085&quot;,&quot;parentUUID&quot;:&quot;afcb0c47-24ca-48a5-b99d-ceb9f0eb444b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne,\n    this.extOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;04df8cc7-3028-4dc6-9ee2-a40c8ce160fa&quot;,&quot;parentUUID&quot;:&quot;afcb0c47-24ca-48a5-b99d-ceb9f0eb444b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with all signers (5/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with all signers (5/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne,\n    this.extOne,\n    this.extTwo\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cdf7504a-e9f3-4e25-a856-729581bf6e5d&quot;,&quot;parentUUID&quot;:&quot;afcb0c47-24ca-48a5-b99d-ceb9f0eb444b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer\n])).to.be.reverted;\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99e73b7f-c4eb-4c72-add3-56cbd4089650&quot;,&quot;parentUUID&quot;:&quot;afcb0c47-24ca-48a5-b99d-ceb9f0eb444b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d036a635-2837-40df-adcb-d1c525bc0085&quot;,&quot;04df8cc7-3028-4dc6-9ee2-a40c8ce160fa&quot;,&quot;cdf7504a-e9f3-4e25-a856-729581bf6e5d&quot;,&quot;99e73b7f-c4eb-4c72-add3-56cbd4089650&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:107,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;5558571e-4d9b-4c3d-81f6-cc88d0459323&quot;,&quot;title&quot;:&quot;toggle actions only for listed assets&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle actions for listed collateral assets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;23424d21-3dd2-4867-8413-9638574ec99f&quot;,&quot;parentUUID&quot;:&quot;5558571e-4d9b-4c3d-81f6-cc88d0459323&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle actions for listed krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.KrAsset.address\n    ],\n    _types.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n]);\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.REPAY.toString(), f.KrAsset.address);\n(0, _chai.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ed4b7edf-70d3-46c6-aed7-aa3483e7e1a4&quot;,&quot;parentUUID&quot;:&quot;5558571e-4d9b-4c3d-81f6-cc88d0459323&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomAddr = hre.ethers.utils.computeAddress(&#x27;0xb976778317b23a1285ec2d483eda6904d9319135b89f1d8eee9f6d2593e2665d&#x27;);\nawait (0, _chai.expect)((0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        randomAddr\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n])).to.be.reverted;\nconst isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), randomAddr);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4c774f62-1525-43d5-b0d8-ddd8df65f9a9&quot;,&quot;parentUUID&quot;:&quot;5558571e-4d9b-4c3d-81f6-cc88d0459323&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;23424d21-3dd2-4867-8413-9638574ec99f&quot;,&quot;ed4b7edf-70d3-46c6-aed7-aa3483e7e1a4&quot;,&quot;4c774f62-1525-43d5-b0d8-ddd8df65f9a9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:87,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;3810b6fe-a7f9-4120-9d52-224649f23801&quot;,&quot;title&quot;:&quot;duration based pausing&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can optionally set a timeout on a given pause command&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing can optionally set a timeout on a given pause command&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000000;\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    true,\n    duration\n], [\n    this.deployer,\n    this.devOne,\n    this.userOne\n]);\nconst depositSafetyState = await hre.Diamond.safetyStateFor(f.Collateral.address, _types.Action.DEPOSIT);\n(0, _chai.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, _chai.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;84b7de11-e829-4a8c-a9b1-460d6427feb8&quot;,&quot;parentUUID&quot;:&quot;3810b6fe-a7f9-4120-9d52-224649f23801&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;duration based pause functionality should expire after the duration has passed&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing duration based pause functionality should expire after the duration has passed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;064b5ad2-fb89-4340-8e76-60bcd757501c&quot;,&quot;parentUUID&quot;:&quot;3810b6fe-a7f9-4120-9d52-224649f23801&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;84b7de11-e829-4a8c-a9b1-460d6427feb8&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;064b5ad2-fb89-4340-8e76-60bcd757501c&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:29,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;title&quot;:&quot;toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle action DEPOSIT pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action DEPOSIT pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:56,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_types.Action.DEPOSIT.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0e5a7134-5538-405d-a777-97eb3534992b&quot;,&quot;parentUUID&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action WITHDRAW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action WITHDRAW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_types.Action.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.WITHDRAW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_types.Action.WITHDRAW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f3d4ff79-ac9d-4135-8bba-e1a220f23c88&quot;,&quot;parentUUID&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action REPAY pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action REPAY pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_types.Action.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.REPAY,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_types.Action.REPAY.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b6a66678-9b80-4b38-b067-40432a2fbcb1&quot;,&quot;parentUUID&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action BORROW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action BORROW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_types.Action.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.BORROW,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_types.Action.BORROW.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b1278ca6-d99d-44da-b6bb-6abdfd9d9c3c&quot;,&quot;parentUUID&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action LIQUIDATION pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action LIQUIDATION pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nlet isPaused = await hre.Diamond.assetActionPaused(_types.Action.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(true);\nawait (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.LIQUIDATION,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nisPaused = await hre.Diamond.assetActionPaused(_types.Action.LIQUIDATION.toString(), f.Collateral.address);\n(0, _chai.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ac90f8f0-2abb-400d-b9b4-06e55523cfe7&quot;,&quot;parentUUID&quot;:&quot;d9ab199d-60b5-4c18-bcb6-87232b1fff20&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0e5a7134-5538-405d-a777-97eb3534992b&quot;,&quot;f3d4ff79-ac9d-4135-8bba-e1a220f23c88&quot;,&quot;b6a66678-9b80-4b38-b067-40432a2fbcb1&quot;,&quot;b1278ca6-d99d-44da-b6bb-6abdfd9d9c3c&quot;,&quot;ac90f8f0-2abb-400d-b9b4-06e55523cfe7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:282,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;4fbce6bf-1d53-4bf0-938f-7821b1b90106&quot;,&quot;title&quot;:&quot;event emission&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused event emission should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:28,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, _execution.executeContractCallWithSigners)(hre.Multisig, hre.Diamond, &#x27;toggleAssetsPaused&#x27;, [\n    [\n        f.Collateral.address\n    ],\n    _types.Action.DEPOSIT,\n    false,\n    0\n], [\n    this.deployer,\n    this.devOne,\n    this.extOne\n]);\nconst event = await (0, _events.getInternalEvent)(tx, hre.Diamond, &#x27;SafetyStateChange&#x27;);\n(0, _chai.expect)(event.action).to.equal(_types.Action.DEPOSIT);\n(0, _chai.expect)(event.asset).to.equal(f.Collateral.address);\n(0, _chai.expect)(event.description).to.equal(&#x27;paused&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;76464a95-8c4b-4ad3-9d12-ba35becab7bb&quot;,&quot;parentUUID&quot;:&quot;4fbce6bf-1d53-4bf0-938f-7821b1b90106&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;76464a95-8c4b-4ad3-9d12-ba35becab7bb&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:28,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;a8ffca7f-2bfa-4d73-94ea-0f2cc96607de&quot;,&quot;title&quot;:&quot;SCDP&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP \&quot;before each\&quot; hook in \&quot;SCDP\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:240,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;f = await (0, _fixtures.scdpFixture)();\nawait f.reset();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bfbff117-6689-4207-b2a3-402070cd093c&quot;,&quot;parentUUID&quot;:&quot;a8ffca7f-2bfa-4d73-94ea-0f2cc96607de&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;title&quot;:&quot;#Configuration&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be initialized correctly&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be initialized correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { args } = await (0, _deploy.getSCDPInitializer)(hre);\nconst configuration = await hre.Diamond.getParametersSCDP();\n(0, _chai.expect)(configuration.liquidationThreshold).to.equal(args.liquidationThreshold);\n(0, _chai.expect)(configuration.minCollateralRatio).to.equal(args.minCollateralRatio);\n(0, _chai.expect)(configuration.maxLiquidationRatio).to.equal(Number(args.liquidationThreshold) + 0.01e4);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include.members([\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst depositsEnabled = await Promise.all([\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral.address),\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral8Dec.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KISS.address)\n]);\n(0, _chai.expect)(depositsEnabled).to.deep.equal([\n    true,\n    true,\n    false,\n    false,\n    true\n]);\nconst depositAssets = await hre.Diamond.viewSCDPDepositAssets();\n(0, _chai.expect)(depositAssets).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KISS.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;91931fc0-4935-49a0-9754-a2b01de01d87&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to whitelist new deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to whitelist new deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetInfoBefore = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoBefore.isSharedCollateral).to.equal(false);\nawait hre.Diamond.updateAsset(f.KrAsset2.address, {\n    ...assetInfoBefore,\n    isSharedCollateral: true,\n    depositLimitSCDP: 1\n});\nconst assetInfoAfter = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoAfter.decimals).to.equal(await f.KrAsset2.contract.decimals());\n(0, _chai.expect)(assetInfoAfter.depositLimitSCDP).to.equal(1);\nconst indicesAfter = await hre.Diamond.getAssetIndexesSCDP(f.KrAsset2.address);\n(0, _chai.expect)(indicesAfter.currLiqIndex).to.equal(_values.RAY);\n(0, _chai.expect)(indicesAfter.currFeeIndex).to.equal(_values.RAY);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;45033a4e-8ef3-4711-b6e0-c71385580ce1&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update deposit limit of asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to update deposit limit of asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setDepositLimitSCDP(f.Collateral.address, 1);\nconst collateral = await hre.Diamond.getAsset(f.Collateral.address);\n(0, _chai.expect)(collateral.decimals).to.equal(await f.Collateral.contract.decimals());\n(0, _chai.expect)(collateral.depositLimitSCDP).to.equal(1);\nconst indicesAfter = await hre.Diamond.getAssetIndexesSCDP(f.Collateral.address);\n(0, _chai.expect)(indicesAfter.currLiqIndex).to.equal(_values.RAY);\n(0, _chai.expect)(indicesAfter.currFeeIndex).to.equal(_values.RAY);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;91348b2c-058f-47e2-93c9-f2fb088a85c8&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable a deposit asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to disable a deposit asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:20,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, false);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.Collateral.address);\nconst depositAssets = await hre.Diamond.viewSCDPDepositAssets();\n(0, _chai.expect)(depositAssets).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a6204caa-b04a-4919-9df2-9c23af194d9e&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to disable and enable a collateral asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to disable and enable a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setAssetIsSharedOrSwappedCollateralSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\nawait hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setAssetIsSharedOrSwappedCollateralSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.include(f.Collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;41ca8129-a187-48c0-a146-3d97d6d1e5cc&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to add whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to add whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(f.swapKrAssetConfig.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(f.swapKrAssetConfig.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(f.swapKrAssetConfig.liqIncentiveSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(f.swapKrAssetConfig.protocolFeeShareSCDP);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c15ff53d-9d97-4191-830d-c8b1b440a5b8&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to update a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to update a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const update = {\n    ...f.KrAsset.config.assetStruct,\n    swapInFeeSCDP: 0.05e4,\n    swapOutFeeSCDP: 0.05e4,\n    liqIncentiveSCDP: 1.06e4,\n    protocolFeeShareSCDP: 0.4e4\n};\nawait hre.Diamond.updateAsset(f.KrAsset.address, update);\nconst assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(update.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(update.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(update.protocolFeeShareSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(update.liqIncentiveSCDP);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include(f.KrAsset.address);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6cf0a0e1-10c0-433c-93d4-bc3f84689ee2&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to remove a whitelisted kresko asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to remove a whitelisted kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setAssetIsSwapMintableSCDP(f.KrAsset.address, false);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.not.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b674a6b8-7f1c-4d14-abdb-ffc4a92497fa&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to enable and disable swap pairs&quot;,&quot;fullTitle&quot;:&quot;SCDP #Configuration should be able to enable and disable swap pairs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapPairsEnabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: true\n    }\n];\nawait hre.Diamond.setSwapRoutesSCDP(swapPairsEnabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(true);\nconst swapPairsDisabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: false\n    }\n];\nawait hre.Diamond.setSwapRoutesSCDP(swapPairsDisabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(false);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eab2aa49-584d-499f-8da7-6042c0e97997&quot;,&quot;parentUUID&quot;:&quot;c32bab6d-3708-45da-bd16-c3a5831e70c0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;91931fc0-4935-49a0-9754-a2b01de01d87&quot;,&quot;45033a4e-8ef3-4711-b6e0-c71385580ce1&quot;,&quot;91348b2c-058f-47e2-93c9-f2fb088a85c8&quot;,&quot;a6204caa-b04a-4919-9df2-9c23af194d9e&quot;,&quot;41ca8129-a187-48c0-a146-3d97d6d1e5cc&quot;,&quot;c15ff53d-9d97-4191-830d-c8b1b440a5b8&quot;,&quot;6cf0a0e1-10c0-433c-93d4-bc3f84689ee2&quot;,&quot;b674a6b8-7f1c-4d14-abdb-ffc4a92497fa&quot;,&quot;eab2aa49-584d-499f-8da7-6042c0e97997&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:291,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;0341a899-74c4-454d-a468-167b2986fba0&quot;,&quot;title&quot;:&quot;#Deposit&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to deposit collateral, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Deposit should be able to deposit collateral, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:515,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted = (f.CollateralPrice.num(8) * depositAmount).ebn(8) // cfactor = 1\n;\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait Promise.all(f.usersArr.map((user)=&gt;{\n    return hre.Diamond.connect(user).depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n}));\nconst prices = hre.viewData();\nconst [userInfos, { scdp }, [assetInfo]] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((user)=&gt;user.address), [\n        f.Collateral.address\n    ]),\n    hre.Diamond.viewProtocolData(prices),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const balance = await f.Collateral.balanceOf(userInfo.addr);\n    (0, _chai.expect)(balance).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.totals.valFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].val).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].valFees).to.equal(0);\n}\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.amountColl).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.valColl).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n// Adjusted\n(0, _chai.expect)(assetInfo.valCollAdj).to.equal(expectedValueAdjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valCollAdj).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valDebtOgAdj).to.equal(0);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.crOgAdj).to.equal(_viem.maxUint256);\n(0, _chai.expect)(scdp.totals.crOg).to.equal(_viem.maxUint256);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d8625301-1b40-4b10-b39c-4b123c0f3662&quot;,&quot;parentUUID&quot;:&quot;0341a899-74c4-454d-a468-167b2986fba0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;fullTitle&quot;:&quot;SCDP #Deposit should be able to deposit multiple collaterals, calculate correct deposit values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:580,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted = (0, _values.toBig)(f.CollateralPrice.num(8) / 1 * depositAmount, 8) // cfactor = 1\n;\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * 0.8 * depositAmount, 8) // cfactor = 0.8\n;\nawait Promise.all(f.usersArr.map(async (user)=&gt;{\n    const User = hre.Diamond.connect(user);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\n    await User.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\n    await User.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec);\n}));\nconst prices = hre.viewData();\nconst [userInfos, assetInfos, { scdp }] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].val).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(depositAmount8Dec);\n    (0, _chai.expect)(userInfo.deposits[1].val).to.equal(expectedValueUnadjusted8Dec);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec));\n}\n(0, _chai.expect)(assetInfos[0].amountColl).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfos[1].amountColl).to.equal(depositAmount8Dec.mul(f.usersArr.length));\n// WITH_FACTORS global\nconst valueTotalAdjusted = expectedValueAdjusted.mul(f.usersArr.length);\nconst valueTotalAdjusted8Dec = expectedValueAdjusted8Dec.mul(f.usersArr.length);\nconst valueAdjusted = valueTotalAdjusted.add(valueTotalAdjusted8Dec);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(valueTotalAdjusted);\n(0, _chai.expect)(assetInfos[1].valCollAdj).to.equal(valueTotalAdjusted8Dec);\n(0, _chai.expect)(scdp.totals.valCollAdj).to.equal(valueAdjusted);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);\n// WITHOUT_FACTORS global\nconst valueTotalUnadjusted = expectedValueUnadjusted.mul(f.usersArr.length);\nconst valueTotalUnadjusted8Dec = expectedValueUnadjusted8Dec.mul(f.usersArr.length);\nconst valueUnadjusted = valueTotalUnadjusted.add(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(valueTotalUnadjusted);\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(scdp.totals.valColl).to.equal(valueUnadjusted);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9c7270d0-d8c5-4916-b2d8-0e66475e57a3&quot;,&quot;parentUUID&quot;:&quot;0341a899-74c4-454d-a468-167b2986fba0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d8625301-1b40-4b10-b39c-4b123c0f3662&quot;,&quot;9c7270d0-d8c5-4916-b2d8-0e66475e57a3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1095,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;b700578b-ec51-424c-b687-6a28ac1d2dfb&quot;,&quot;title&quot;:&quot;#Withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Withdraw \&quot;before each\&quot; hook in \&quot;#Withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = hre.Diamond.connect(user);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\n    await UserKresko.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\n    await UserKresko.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec);\n}));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c5dc7c6d-a92b-4ae4-bab5-024d55e6cd81&quot;,&quot;parentUUID&quot;:&quot;b700578b-ec51-424c-b687-6a28ac1d2dfb&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to withdraw full collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Withdraw should be able to withdraw full collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:864,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = hre.Diamond.connect(user);\n    return Promise.all([\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral.address,\n            amount: depositAmount18Dec,\n            receiver: user.address\n        }, await hre.updateData()),\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral8Dec.address,\n            amount: depositAmount8Dec,\n            receiver: user.address\n        }, await hre.updateData())\n    ]);\n}));\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(0);\nconst prices = hre.viewData();\nconst [userInfos, assetInfos, { scdp }] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(await f.Collateral.balanceOf(userInfo.addr)).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(0);\n}\nfor (const assetInfo of assetInfos){\n    (0, _chai.expect)(assetInfo.valColl).to.equal(0);\n    (0, _chai.expect)(assetInfo.amountColl).to.equal(0);\n    (0, _chai.expect)(assetInfo.amountSwapDeposit).to.equal(0);\n}\n(0, _chai.expect)(scdp.totals.valColl).to.equal(0);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;155206e1-2966-4398-bb39-b3d2292c0f0e&quot;,&quot;parentUUID&quot;:&quot;b700578b-ec51-424c-b687-6a28ac1d2dfb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to withdraw partial collateral of multiple assets&quot;,&quot;fullTitle&quot;:&quot;SCDP #Withdraw should be able to withdraw partial collateral of multiple assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:886,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const partialWithdraw = depositAmount18Dec.div(f.usersArr.length);\nconst partialWithdraw8Dec = depositAmount8Dec.div(f.usersArr.length);\nconst expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * 1 * depositAmount, 8).mul(200).div(300) // cfactor = 1\n;\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * 0.8 * depositAmount, 8).mul(200).div(300) // cfactor = 0.8\n;\nawait Promise.all(f.usersArr.map(async (user)=&gt;{\n    const UserKresko = hre.Diamond.connect(user);\n    return Promise.all([\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral.address,\n            amount: partialWithdraw,\n            receiver: user.address\n        }, await hre.updateData()),\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral8Dec.address,\n            amount: partialWithdraw8Dec,\n            receiver: user.address\n        }, await hre.updateData())\n    ]);\n}));\nconst [collateralBalanceAfter, collateral8DecBalanceAfter, { scdp }, assetInfos, userInfos] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    f.Collateral8Dec.balanceOf(hre.Diamond.address),\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAccounts(hre.viewData(), f.usersArr.map((u)=&gt;u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const [balance18Dec, balance8Dec] = await Promise.all([\n        f.Collateral.balanceOf(userInfo.addr),\n        f.Collateral8Dec.balanceOf(userInfo.addr)\n    ]);\n    (0, _chai.expect)(balance18Dec).to.equal(partialWithdraw);\n    (0, _chai.expect)(balance8Dec).to.equal(partialWithdraw8Dec);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.deposits[1].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.totals.valColl).to.closeTo(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec), (0, _values.toBig)(0.00001, 8));\n}\n(0, _chai.expect)(collateralBalanceAfter).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(collateral8DecBalanceAfter).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].amountColl).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(assetInfos[1].amountColl).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].valColl).to.closeTo(expectedValueUnadjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[0].valCollAdj).to.closeTo(expectedValueAdjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].valColl).to.closeTo(expectedValueUnadjusted8Dec.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].valCollAdj).to.closeTo(expectedValueAdjusted8Dec.mul(f.usersArr.length), 20);\nconst totalValueRemaining = expectedValueUnadjusted8Dec.mul(f.usersArr.length).add(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valColl).to.closeTo(totalValueRemaining, 20);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51c826ea-0d86-43e5-9a6f-020640976397&quot;,&quot;parentUUID&quot;:&quot;b700578b-ec51-424c-b687-6a28ac1d2dfb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;155206e1-2966-4398-bb39-b3d2292c0f0e&quot;,&quot;51c826ea-0d86-43e5-9a6f-020640976397&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1750,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;d367e611-77c8-46b3-a45f-b23894f3a0cd&quot;,&quot;title&quot;:&quot;#Fee Distribution&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Fee Distribution \&quot;before each\&quot; hook in \&quot;#Fee Distribution\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;incomeCumulator = hre.users.deployer;\nIncomeCumulator = hre.Diamond.connect(incomeCumulator);\nawait f.Collateral.setBalance(incomeCumulator, depositAmount18Dec.mul(f.usersArr.length), hre.Diamond.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c0563113-4980-4e40-b885-485c6e650b9d&quot;,&quot;parentUUID&quot;:&quot;d367e611-77c8-46b3-a45f-b23894f3a0cd&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should be able to cumulate fees into deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Fee Distribution should be able to cumulate fees into deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:866,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nconst feePerUser = depositAmount18Dec;\nconst feesToCumulate = feePerUser.mul(f.usersArr.length);\nconst feePerUserValue = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedDepositValue = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\n// deposit some\nawait Promise.all(f.usersArr.map((signer)=&gt;hre.Diamond.connect(signer).depositSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\n// cumulate some income\nawait IncomeCumulator.cumulateIncomeSCDP(f.Collateral.address, feesToCumulate);\n// check that the fees are cumulated\nfor (const data of (await hre.Diamond.viewSCDPAccounts(hre.viewData(), f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    (0, _chai.expect)(data.deposits[0].val).to.equal(expectedDepositValue);\n    (0, _chai.expect)(data.deposits[0].valFees).to.equal(feePerUserValue);\n    (0, _chai.expect)(data.totals.valColl).to.equal(expectedDepositValue);\n    (0, _chai.expect)(data.totals.valFees).to.equal(feePerUserValue);\n}\n// withdraw principal\nawait Promise.all(f.usersArr.map(async (signer)=&gt;hre.Diamond.connect(signer).withdrawSCDP({\n        account: signer.address,\n        asset: f.Collateral.address,\n        amount: depositAmount18Dec,\n        receiver: signer.address\n    }, await hre.updateData())));\nconst prices = hre.viewData();\nfor (const user of (await hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=&gt;u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(user.addr);\n    (0, _chai.expect)(user.deposits[0].val).to.equal(0);\n    (0, _chai.expect)(user.deposits[0].valFees).to.equal(0);\n    (0, _chai.expect)(user.totals.valFees).to.equal(0);\n    (0, _chai.expect)(user.totals.valColl).to.equal(0);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec.add(feePerUser));\n}\nconst [[assetInfo], { scdp }, balance] = await Promise.all([\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ]),\n    hre.Diamond.viewProtocolData(prices),\n    f.Collateral.balanceOf(hre.Diamond.address)\n]);\n(0, _chai.expect)(balance).to.equal(0);\n(0, _chai.expect)(assetInfo.amountColl).to.equal(0);\n(0, _chai.expect)(assetInfo.valColl).to.equal(0);\n(0, _chai.expect)(assetInfo.valCollAdj).to.equal(0);\n(0, _chai.expect)(scdp.totals.valColl).to.equal(0);\n// nothing left in protocol.\nconst [colalteralBalanceKresko, [assetInfoFinal]] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ])\n]);\n(0, _chai.expect)(colalteralBalanceKresko).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.amountColl).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.valColl).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.valCollAdj).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6183b0d3-f07b-492e-9965-932284b6342f&quot;,&quot;parentUUID&quot;:&quot;d367e611-77c8-46b3-a45f-b23894f3a0cd&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;6183b0d3-f07b-492e-9965-932284b6342f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:866,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;title&quot;:&quot;#Swap&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap \&quot;before each\&quot; hook in \&quot;#Swap\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:21,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor, (0, _values.toBig)(10_000));\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, depositAmount18Dec);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af43bd69-6594-4667-87de-7f30a5ef0039&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should have collateral in pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should have collateral in pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:650,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.valColl).to.equal((0, _values.toBig)(depositAmount, 8));\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9286c3fd-aaf5-4676-86a3-bbfa9a1cba6f&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to preview a swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should be able to preview a swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\n(0, _chai.expect)((await f.KrAsset2.getPrice()).pyth).to.equal(f.KrAsset2Price);\nconst feePercentageProtocol = Number(f.KISS.config.assetStruct.protocolFeeShareSCDP) + Number(f.KrAsset2.config.assetStruct.protocolFeeShareSCDP);\nconst expectedTotalFee = swapAmount.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst expectedProtocolFee = expectedTotalFee.percentMul(feePercentageProtocol);\nconst expectedFee = expectedTotalFee.sub(expectedProtocolFee);\nconst amountInAfterFees = swapAmount.sub(expectedTotalFee);\nconst expectedAmountOut = amountInAfterFees.wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst [amountOut, feeAmount, feeAmountProtocol] = await hre.Diamond.previewSwapSCDP(f.KISS.address, f.KrAsset2.address, swapAmount);\n(0, _chai.expect)(amountOut).to.equal(expectedAmountOut);\n(0, _chai.expect)(feeAmount).to.equal(expectedFee);\n(0, _chai.expect)(feeAmountProtocol).to.equal(expectedProtocolFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;00ad3b25-0c55-4647-b694-3b124c016580&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == 0 | swap collateral == 0&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should be able to swap, shared debt == 0 | swap collateral == 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1026,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1) // $1\n;\nconst kissInAfterFees = swapAmount.sub(swapAmount.percentMul(f.KRASSET_KISS_ROUTE_FEE));\nconst expectedAmountOut = kissInAfterFees.wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;Swap&#x27;);\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmount);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedAmountOut);\nconst prices = hre.viewData();\nconst [KR2Balance, KISSBalance, swapperInfos, assetInfos, { scdp }] = await Promise.all([\n    f.KrAsset2.balanceOf(f.swapper.address),\n    f.KISS.balanceOf(f.swapper.address),\n    hre.Diamond.viewSCDPAccounts(prices, [\n        f.swapper.address\n    ], [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nconst swapperInfo = swapperInfos[0];\n(0, _chai.expect)(KR2Balance).to.equal(expectedAmountOut);\n(0, _chai.expect)(KISSBalance).to.equal((0, _values.toBig)(10_000).sub(swapAmount));\n(0, _chai.expect)(swapperInfo.deposits[0].val).to.equal(0);\n(0, _chai.expect)(swapperInfo.deposits[1].val).to.equal(0);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(expectedAmountOut);\n(0, _chai.expect)(assetInfos[1].amountSwapDeposit).to.equal(kissInAfterFees);\nconst expectedDepositValue = (0, _values.toBig)(depositAmount, 8).add(kissInAfterFees.wadMul(f.KISSPrice));\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(expectedDepositValue);\n(0, _chai.expect)(assetInfos[0].valDebt).to.equal(expectedAmountOut.wadMul(f.KrAsset2Price));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedDepositValue);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(expectedAmountOut.wadMul(f.KrAsset2Price));\n(0, _chai.expect)(scdp.totals.cr).to.equal(expectedDepositValue.percentDiv(expectedAmountOut.wadMul(f.KrAsset2Price)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;961bfbc6-12d6-40e6-b3a3-a7900776c781&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should be able to swap, shared debt == assetsIn | swap collateral == assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1447,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(100) // $100\n;\nconst swapAmountAsset = swapAmount.percentMul(1e4 - Number(f.KRASSET_KISS_ROUTE_FEE)).wadMul(f.KISSPrice.wadDiv(f.KrAsset2Price));\nconst expectedKissOut = swapAmountAsset.percentMul(1e4 - f.KRASSET_KISS_ROUTE_FEE).wadMul(f.KrAsset2Price).wadDiv(f.KISSPrice);\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: f.swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(100)\n});\nawait (0, _krassets.mintKrAsset)({\n    user: f.swapper,\n    asset: f.KrAsset2,\n    amount: (0, _values.toBig)(0.1)\n});\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.valColl).to.equal(initialDepositValue);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n// the swap that clears debt\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountAsset,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst [event, assetInfos] = await Promise.all([\n    (0, _events.getNamedEvent)(tx, &#x27;Swap&#x27;),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.KISS.address,\n        f.KrAsset2.address\n    ])\n]);\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(0);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(initialDepositValue);\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(0);\nconst { scdp: scdpAfter } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdpAfter.totals.valColl).to.equal((0, _values.toBig)(1000, 8));\n(0, _chai.expect)(scdpAfter.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdpAfter.totals.cr).to.equal(_viem.maxUint256);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4e69c00b-f423-44fb-bd6c-f76541040b57&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, debt &gt; assetsIn | swap deposits &gt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should be able to swap, debt &gt; assetsIn | swap deposits &gt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:677,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1) // $1\n;\nconst swapValue = (0, _values.toBig)(1, 8);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst [assetInfoKISS] = await hre.Diamond.viewSCDPAssets(hre.viewData(), [\n    f.KISS.address\n]);\nconst feeValueFirstSwap = swapValue.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst valueInAfterFees = swapValue.sub(feeValueFirstSwap);\n(0, _chai.expect)(assetInfoKISS.valColl).to.equal(depositValue.add(valueInAfterFees));\nconst expectedSwapDeposits = valueInAfterFees.num(8).ebn(18);\n(0, _chai.expect)(assetInfoKISS.amountSwapDeposit).to.equal(expectedSwapDeposits);\nconst swapAmountSecond = (0, _values.toBig)(0.009) // this is $0.90, so less than $0.96 since we want to ensure debt &gt; assetsIn | swap deposits &gt; assetsOut\n;\nconst swapValueSecond = swapAmountSecond.wadMul(f.KrAsset2Price);\nconst feeValueSecondSwap = swapValueSecond.sub(swapValueSecond.percentMul(f.KRASSET_KISS_ROUTE_FEE));\nconst expectedKissOut = feeValueSecondSwap.wadDiv(f.KISSPrice) // 0.8685\n;\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountSecond,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;Swap&#x27;);\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountSecond);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\nconst [depositValueKR2, depositValueKISS, assetInfos, { scdp }] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.swapper.address, f.KrAsset2.address),\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.swapper.address, f.KISS.address),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.KISS.address,\n        f.KrAsset2.address\n    ]),\n    hre.Diamond.viewProtocolData(hre.viewData())\n]);\n(0, _chai.expect)(depositValueKR2).to.equal(0);\n(0, _chai.expect)(depositValueKISS).to.equal(0);\nconst expectedSwapDepositsAfter = expectedSwapDeposits.sub((0, _values.toBig)(0.9));\nconst expectedSwapDepositsValue = expectedSwapDepositsAfter.wadMul(assetInfoKISS.price);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(expectedSwapDepositsAfter);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal((0, _values.toBig)(depositAmount, 8).add(expectedSwapDepositsValue));\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(expectedSwapDepositsValue);\nconst expectedDebtAfter = expectedSwapDepositsValue.wadDiv((await f.KrAsset2.getPrice()).pyth);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(expectedDebtAfter);\nconst expectedCollateralValue = expectedSwapDepositsValue.add(depositAmount.ebn(8));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedCollateralValue) // swap deposits + collateral deposited\n;\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(expectedSwapDepositsValue) //\n;\n(0, _chai.expect)(scdp.totals.cr).to.equal(expectedCollateralValue.percentDiv(expectedSwapDepositsValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d5cd2629-a13d-41a4-b302-52bad31c9f01&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should be able to swap, debt &lt; assetsIn | swap deposits &lt; assetsOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap should be able to swap, debt &lt; assetsIn | swap deposits &lt; assetsOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1199,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmountKiss = (0, _values.toBig)(100) // $100\n;\nconst swapAmountKrAsset = (0, _values.toBig)(2) // $200\n;\nconst swapValue = 200;\nconst firstSwapFeeAmount = swapAmountKiss.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst expectedKissOutSecondSwap = swapAmountKrAsset.sub(swapAmountKrAsset.percentMul(f.KRASSET_KISS_ROUTE_FEE)).wadMul(f.KrAsset2Price).wadDiv(f.KISSPrice);\nconst krAssetOutFirstSwap = swapAmountKiss.sub(firstSwapFeeAmount).wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst krAssetOutFirstSwapValue = krAssetOutFirstSwap.wadMul(f.KrAsset2Price);\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: f.swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(400)\n});\nconst ICDPMintAmount = (0, _values.toBig)(1.04);\nawait (0, _krassets.mintKrAsset)({\n    user: f.swapper,\n    asset: f.KrAsset2,\n    amount: ICDPMintAmount\n});\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmountKiss,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst expectedSwapDeposits = swapAmountKiss.sub(firstSwapFeeAmount);\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(await f.KreskoSwapper.getSwapDepositsSCDP(f.KISS.address)).to.equal(expectedSwapDeposits);\n(0, _chai.expect)(scdp.totals.valColl).to.be.eq(depositAmount.ebn().add(expectedSwapDeposits).wadMul(f.KISSPrice));\n// the swap that matters, here user has 0.96 (previous swap) + 1.04 (mint). expecting 192 kiss from swap.\nconst [expectedAmountOut] = await f.KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmountKrAsset);\n(0, _chai.expect)(expectedAmountOut).to.equal(expectedKissOutSecondSwap);\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountKrAsset,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;Swap&#x27;);\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountKrAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOutSecondSwap);\nconst assetInfos = await hre.Diamond.viewSCDPAssets(hre.viewData(), [\n    f.KISS.address,\n    f.KrAsset2.address\n]);\n// f.KISS deposits sent in swap\nconst acocuntPrincipalDepositsKISS = await f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(0) // half of 2 krAsset\n;\n(0, _chai.expect)(assetInfos[0].amountColl).to.equal(acocuntPrincipalDepositsKISS);\n// KrAsset debt is cleared\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(0);\n// KISS debt is issued\nconst expectedKissDebtValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[0].valDebt).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(expectedKissDebtValue.wadDiv(f.KISSPrice));\n// krAsset swap deposits\nconst expectedSwapDepositValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[1].amountSwapDeposit).to.equal((0, _values.toBig)(2).sub(krAssetOutFirstSwap));\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(expectedSwapDepositValue) // asset price is $100\n;\nconst { scdp: scdpAfter } = await hre.Diamond.viewProtocolData(hre.viewData());\nconst expectedCollateralValue = (0, _values.toBig)(1000, 8).add(expectedSwapDepositValue);\n(0, _chai.expect)(scdpAfter.totals.valColl).to.equal(expectedCollateralValue);\n(0, _chai.expect)(scdpAfter.totals.valDebt).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(scdpAfter.totals.cr).to.equal(expectedCollateralValue.percentDiv(expectedKissDebtValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ea83e820-6f08-4841-b022-1ad4e1ad591c&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cumulates fees on swap&quot;,&quot;fullTitle&quot;:&quot;SCDP #Swap cumulates fees on swap&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:365,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositAmountNew = (0, _values.toBig)(10000 - depositAmount);\nawait f.KISS.setBalance(f.depositor, depositAmountNew);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, depositAmountNew);\nconst swapAmount = (0, _values.toBig)(2600);\nconst feesBeforeSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst feesAfterSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(feesAfterSwap).to.gt(feesBeforeSwap);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: f.KrAsset2.balanceOf(f.swapper.address),\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst feesAfterSecondSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(feesAfterSecondSwap).to.gt(feesAfterSwap);\nawait f.KreskoDepositor.claimFeesSCDP(f.depositor.address, f.KISS.address, f.depositor.address);\nconst [depositsAfter, feesAfter] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.KISS.address),\n    f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(feesAfter).to.eq(0);\n(0, _chai.expect)(depositsAfter).to.eq((0, _values.toBig)(10000));\nawait f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.KISS.address,\n    amount: (0, _values.toBig)(10000),\n    receiver: f.depositor.address\n}, await hre.updateData());\nconst [depositsAfterWithdraw, feesAfterWithdraw] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.depositor.address, f.KISS.address),\n    f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(depositsAfterWithdraw).to.eq(0);\n(0, _chai.expect)(feesAfterWithdraw).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6da55cbb-c669-4007-ba7e-4e63ad33be1e&quot;,&quot;parentUUID&quot;:&quot;c593c19d-22d5-4c5b-a2a4-b76a005726e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9286c3fd-aaf5-4676-86a3-bbfa9a1cba6f&quot;,&quot;00ad3b25-0c55-4647-b694-3b124c016580&quot;,&quot;961bfbc6-12d6-40e6-b3a3-a7900776c781&quot;,&quot;4e69c00b-f423-44fb-bd6c-f76541040b57&quot;,&quot;d5cd2629-a13d-41a4-b302-52bad31c9f01&quot;,&quot;ea83e820-6f08-4841-b022-1ad4e1ad591c&quot;,&quot;6da55cbb-c669-4007-ba7e-4e63ad33be1e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:5387,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;title&quot;:&quot;#Liquidations&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Liquidations \&quot;before each\&quot; hook in \&quot;#Liquidations\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;for (const signer of f.usersArr){\n    await f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000));\n}\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor2, (0, _values.toBig)(10_000));\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral8Dec.address, depositAmount8Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.KISS.address);\nf.KreskoDepositor2.depositSCDP(f.depositor2.address, f.KISS.address, depositAmount18Dec);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bbd474b3-3df3-4952-a23a-7130359ef904&quot;,&quot;parentUUID&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Liquidations should identify if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:186,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(2600) // $1\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9647977c-c7dd-44ad-a847-e92bc218b7b1&quot;,&quot;parentUUID&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert liquidations if the pool is not underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Liquidations should revert liquidations if the pool is not underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:287,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(2600) // $1\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;\nawait f.KrAsset2.setBalance(hre.users.liquidator, (0, _values.toBig)(1_000_000));\nawait (0, _chai.expect)(f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount: (0, _values.toBig)(7.7),\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;COLLATERAL_VALUE_GREATER_THAN_REQUIRED&#x27;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5bfd990b-3a35-4855-8f64-17728b3950dc&quot;,&quot;parentUUID&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should identify if the pool is underwater&quot;,&quot;fullTitle&quot;:&quot;SCDP #Liquidations should identify if the pool is underwater&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:646,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(2600);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nawait f.Collateral.setPrice(f.CollateralPrice.num(8) / 1000);\nawait f.Collateral8Dec.setPrice(f.CollateralPrice.num(8) / 1000);\nconst [{ scdp }, liquidatable] = await Promise.all([\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(scdp.totals.cr).to.be.lt(scdp.LT);\n(0, _chai.expect)(liquidatable).to.be.true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7df5dd3a-4f04-404f-997c-6eea32e2d648&quot;,&quot;parentUUID&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidating the underwater pool&quot;,&quot;fullTitle&quot;:&quot;SCDP #Liquidations should allow liquidating the underwater pool&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1770,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(2600);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst newKreskoAssetPrice = 500;\nawait f.KrAsset2.setPrice(newKreskoAssetPrice);\nconst [scdpParams, maxLiquidatable, krAssetPrice, { scdp: scdpBefore }] = await Promise.all([\n    hre.Diamond.getParametersSCDP(),\n    hre.Diamond.getMaxLiqValueSCDP(f.KrAsset2.address, f.Collateral8Dec.address),\n    f.KrAsset2.getPrice(),\n    hre.Diamond.viewProtocolData(hre.viewData())\n]);\nconst repayAmount = maxLiquidatable.repayValue.wadDiv(krAssetPrice.pyth);\nawait f.KrAsset2.setBalance(hre.users.liquidator, repayAmount.add(1e18.toString()));\n(0, _chai.expect)(scdpBefore.totals.cr).to.lt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(scdpBefore.totals.cr).to.gt(1e4);\n// Liquidate the shared CDP\nconst tx = await f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount,\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n});\n// Check the state after liquidation\nconst [{ scdp: scdpAfter }, liquidatableAfter] = await Promise.all([\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(scdpAfter.totals.cr).to.gt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(scdpAfter.totals.crOgAdj).to.eq(2.01e4);\n(0, _chai.expect)(liquidatableAfter).to.eq(false);\n// Shared CDP should not be liquidatable since it is above the threshold\nawait (0, _chai.expect)(f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount,\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;COLLATERAL_VALUE_GREATER_THAN_REQUIRED&#x27;);\n// Check what was emitted in the event\nconst event = await (0, _events.getNamedEvent)(tx, &#x27;SCDPLiquidationOccured&#x27;);\nconst expectedSeizeAmount = repayAmount.wadMul((0, _values.toBig)(newKreskoAssetPrice, 8)).percentMul(1.05e4).wadDiv(f.CollateralPrice).div(10 ** 10);\n(0, _chai.expect)(event.args.liquidator).to.eq(hre.users.liquidator.address);\n(0, _chai.expect)(event.args.seizeAmount).to.eq(expectedSeizeAmount);\n(0, _chai.expect)(event.args.repayAmount).to.eq(repayAmount);\n(0, _chai.expect)(event.args.seizeCollateral).to.eq(f.Collateral8Dec.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.eq(f.KrAsset2.address);\n// Check account state changes\nconst expectedDepositsAfter = depositAmount8Dec.sub(event.args.seizeAmount);\n(0, _chai.expect)(expectedDepositsAfter).to.be.lt(depositAmount8Dec);\nconst [principalDeposits, fees, params] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountFeesSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getParametersSCDP()\n]);\n(0, _chai.expect)(principalDeposits).to.eq(expectedDepositsAfter);\n(0, _chai.expect)(fees).to.eq(0);\n// Sanity checking that users should be able to withdraw what is left\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec.mul(10));\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.cr).to.gt(params.minCollateralRatio);\nawait (0, _chai.expect)(f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.Collateral8Dec.address,\n    amount: expectedDepositsAfter,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.not.be.reverted;\nconst [principalEnd, feesAfter] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountFeesSCDP(f.depositor.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(principalEnd).to.eq(0);\n(0, _chai.expect)(feesAfter).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8037175-7877-4529-963a-d69d1d80ebfe&quot;,&quot;parentUUID&quot;:&quot;33f47dac-3380-410f-8d9e-cfceaf56e862&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9647977c-c7dd-44ad-a847-e92bc218b7b1&quot;,&quot;5bfd990b-3a35-4855-8f64-17728b3950dc&quot;,&quot;7df5dd3a-4f04-404f-997c-6eea32e2d648&quot;,&quot;c8037175-7877-4529-963a-d69d1d80ebfe&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2889,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000},{&quot;uuid&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;title&quot;:&quot;#Error&quot;,&quot;fullFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts&quot;,&quot;file&quot;:&quot;/src/test/scdp/00-scdp.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error \&quot;before each\&quot; hook in \&quot;#Error\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await Promise.all(f.usersArr.map((signer)=&gt;f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor, hre.ethers.BigNumber.from(1));\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.KISS.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, 1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;50ddc978-9514-4292-a75e-4f4d4f15cf10&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should revert depositing unsupported tokens&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert depositing unsupported tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [UnsupportedToken] = await hre.deploy(&#x27;MockERC20&#x27;, {\n    args: [\n        &#x27;UnsupportedToken&#x27;,\n        &#x27;UnsupportedToken&#x27;,\n        18,\n        (0, _values.toBig)(1)\n    ]\n});\nawait UnsupportedToken.approve(hre.Diamond.address, hre.ethers.constants.MaxUint256);\nconst { deployer } = await hre.getNamedAccounts();\nawait (0, _chai.expect)(hre.Diamond.depositSCDP(deployer, UnsupportedToken.address, 1)).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ASSET_NOT_FEE_ACCUMULATING_ASSET&#x27;).withArgs([\n    &#x27;UnsupportedToken&#x27;,\n    UnsupportedToken.address\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f8ce1d18-53d9-4385-901c-85cb814b5433&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawing without deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert withdrawing without deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 1;\nawait (0, _chai.expect)(f.KreskoSwapper.withdrawSCDP({\n    account: f.swapper.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    receiver: f.swapper.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ACCOUNT_HAS_NO_DEPOSITS&#x27;).withArgs(f.swapper.address, f.Collateral.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;87ec4788-58ca-4948-81cd-8b569e6921ae&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert withdrawals below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:204,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1000) // $1000\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n}) // generates the debt\n;\nconst deposits = await f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.Collateral.address);\nawait (0, _chai.expect)(f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.Collateral.address,\n    amount: deposits,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;COLLATERAL_VALUE_LESS_THAN_REQUIRED&#x27;).withArgs(960e8, 4800e8, 5e4);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5580b48c-258b-4a2f-9f65-a4b964205695&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert withdrawals of swap owned collateral deposits&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert withdrawals of swap owned collateral deposits&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:192,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst deposits = await f.KreskoSwapper.getSwapDepositsSCDP(f.KrAsset2.address);\n(0, _chai.expect)(deposits).to.be.gt(0);\nawait (0, _chai.expect)(f.KreskoSwapper.withdrawSCDP({\n    account: f.swapper.address,\n    asset: f.KrAsset2.address,\n    amount: deposits,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;ASSET_DOES_NOT_HAVE_DEPOSITS&#x27;).withArgs(f.KrAsset2.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fa6290ef-dc68-4fc7-822c-1ac6b765912f&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping with price below minAmountOut&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert swapping with price below minAmountOut&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nconst [amountOut] = await f.KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmount);\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: amountOut.add(1),\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;RECEIVED_LESS_THAN_DESIRED&#x27;).withArgs(f.KISS.errorId, amountOut, amountOut.add(1));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;029af9e3-7cd8-43e3-8f96-a2e2922007ec&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping unsupported asset&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert swapping unsupported asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.Collateral.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;SWAP_ROUTE_NOT_ENABLED&#x27;).withArgs(f.KrAsset2.errorId, f.Collateral.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e4e8c3c-9bea-495c-b9c9-063cfe50837f&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping a disabled route&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert swapping a disabled route&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:65,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait hre.Diamond.setSingleSwapRouteSCDP({\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    enabled: false\n});\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;SWAP_ROUTE_NOT_ENABLED&#x27;).withArgs(f.KrAsset2.errorId, f.KISS.errorId);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;16943b8e-8704-42f8-825d-d2aee0a9f933&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert swapping causes CDP to go below MCR&quot;,&quot;fullTitle&quot;:&quot;SCDP #Error should revert swapping causes CDP to go below MCR&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:139,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const swapAmount = (0, _values.toBig)(1_500_000);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nconst tx = f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nawait (0, _chai.expect)(tx).to.be.revertedWithCustomError((0, _errors.Errors)(hre), &#x27;COLLATERAL_VALUE_LESS_THAN_REQUIRED&#x27;).withArgs(&#x27;15001000000000000&#x27;, &#x27;75000000000000000&#x27;, 5e4);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3bc472ee-beb8-4f2a-8f6a-5b9622c646c3&quot;,&quot;parentUUID&quot;:&quot;8e64dcd6-1ece-49e3-b259-fef898296b01&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f8ce1d18-53d9-4385-901c-85cb814b5433&quot;,&quot;87ec4788-58ca-4948-81cd-8b569e6921ae&quot;,&quot;5580b48c-258b-4a2f-9f65-a4b964205695&quot;,&quot;fa6290ef-dc68-4fc7-822c-1ac6b765912f&quot;,&quot;029af9e3-7cd8-43e3-8f96-a2e2922007ec&quot;,&quot;6e4e8c3c-9bea-495c-b9c9-063cfe50837f&quot;,&quot;16943b8e-8704-42f8-825d-d2aee0a9f933&quot;,&quot;3bc472ee-beb8-4f2a-8f6a-5b9622c646c3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:876,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:30000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:30000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;options&quot;:{&quot;reportDir&quot;:&quot;docs/test-report&quot;,&quot;assetsDir&quot;:&quot;docs/test-report/assets&quot;,&quot;reportTitle&quot;:&quot;Kresko Protocol Hardhat Test Report&quot;,&quot;reportPageTitle&quot;:&quot;Kresko Protocol Hardhat Test Report&quot;},&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;docs/test-report&quot;,&quot;reportTitle&quot;:&quot;Kresko Protocol Hardhat Test Report&quot;,&quot;reportPageTitle&quot;:&quot;Kresko Protocol Hardhat Test Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;assetsDir&quot;:&quot;docs/test-report/assets&quot;,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;jsonFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/docs/test-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/panukettunen/projects/kresko-protocol/docs/test-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>