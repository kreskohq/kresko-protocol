{
  "stats": {
    "suites": 8,
    "tests": 33,
    "passes": 33,
    "pending": 0,
    "failures": 0,
    "start": "2024-02-01T20:40:02.515Z",
    "end": "2024-02-01T20:40:25.359Z",
    "duration": 22844,
    "testsRegistered": 33,
    "passPercent": 100,
    "pendingPercent": 0,
    "other": 0,
    "hasOther": false,
    "skipped": 0,
    "hasSkipped": false
  },
  "results": [
    {
      "uuid": "37086995-23b7-4dbe-a9e0-231bab7e2cb7",
      "title": "",
      "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
      "file": "/src/test/scdp/00-scdp.ts",
      "beforeHooks": [],
      "afterHooks": [],
      "tests": [],
      "suites": [
        {
          "uuid": "632b1f30-5982-4dff-abed-5f008a291400",
          "title": "SCDP",
          "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
          "file": "/src/test/scdp/00-scdp.ts",
          "beforeHooks": [
            {
              "title": "\"before each\" hook in \"SCDP\"",
              "fullTitle": "SCDP \"before each\" hook in \"SCDP\"",
              "timedOut": false,
              "duration": 552,
              "state": null,
              "speed": null,
              "pass": false,
              "fail": false,
              "pending": false,
              "context": null,
              "code": "f = await (0, _fixtures.scdpFixture)();\nawait f.reset();",
              "err": {},
              "uuid": "65cd7873-0d8f-46dc-a785-43eb414bcabf",
              "parentUUID": "632b1f30-5982-4dff-abed-5f008a291400",
              "isHook": true,
              "skipped": false
            }
          ],
          "afterHooks": [],
          "tests": [],
          "suites": [
            {
              "uuid": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
              "title": "#Configuration",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should be initialized correctly",
                  "fullTitle": "SCDP #Configuration should be initialized correctly",
                  "timedOut": false,
                  "duration": 36,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const { args } = await (0, _deploy.getSCDPInitializer)(hre);\nconst configuration = await hre.Diamond.getParametersSCDP();\n(0, _chai.expect)(configuration.liquidationThreshold).to.equal(args.liquidationThreshold);\n(0, _chai.expect)(configuration.minCollateralRatio).to.equal(args.minCollateralRatio);\n(0, _chai.expect)(configuration.maxLiquidationRatio).to.equal(Number(args.liquidationThreshold) + 0.01e4);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include.members([\n    f.KrAsset.address,\n    f.KrAsset2.address,\n    f.KISS.address\n]);\nconst depositsEnabled = await Promise.all([\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral.address),\n    hre.Diamond.getDepositEnabledSCDP(f.Collateral8Dec.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address),\n    hre.Diamond.getDepositEnabledSCDP(f.KISS.address)\n]);\n(0, _chai.expect)(depositsEnabled).to.deep.equal([\n    true,\n    true,\n    false,\n    false,\n    true\n]);\nconst depositAssets = await hre.Diamond.viewSCDPDepositAssets();\n(0, _chai.expect)(depositAssets).to.include.members([\n    f.Collateral.address,\n    f.Collateral8Dec.address,\n    f.KISS.address\n]);",
                  "err": {},
                  "uuid": "d97df68b-f186-48df-80f1-e6d0b95627ec",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to whitelist new deposit asset",
                  "fullTitle": "SCDP #Configuration should be able to whitelist new deposit asset",
                  "timedOut": false,
                  "duration": 57,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const assetInfoBefore = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoBefore.isSharedCollateral).to.equal(false);\nawait hre.Diamond.updateAsset(f.KrAsset2.address, {\n    ...assetInfoBefore,\n    isSharedCollateral: true,\n    depositLimitSCDP: 1\n});\nconst assetInfoAfter = await hre.Diamond.getAsset(f.KrAsset2.address);\n(0, _chai.expect)(assetInfoAfter.decimals).to.equal(await f.KrAsset2.contract.decimals());\n(0, _chai.expect)(assetInfoAfter.depositLimitSCDP).to.equal(1);\nconst indicesAfter = await hre.Diamond.getAssetIndexesSCDP(f.KrAsset2.address);\n(0, _chai.expect)(indicesAfter.currLiqIndex).to.equal(_values.RAY);\n(0, _chai.expect)(indicesAfter.currFeeIndex).to.equal(_values.RAY);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset2.address)).to.equal(true);",
                  "err": {},
                  "uuid": "46d94637-397b-4dd5-994b-29714f3b00d0",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to update deposit limit of asset",
                  "fullTitle": "SCDP #Configuration should be able to update deposit limit of asset",
                  "timedOut": false,
                  "duration": 16,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await hre.Diamond.setDepositLimitSCDP(f.Collateral.address, 1);\nconst collateral = await hre.Diamond.getAsset(f.Collateral.address);\n(0, _chai.expect)(collateral.decimals).to.equal(await f.Collateral.contract.decimals());\n(0, _chai.expect)(collateral.depositLimitSCDP).to.equal(1);\nconst indicesAfter = await hre.Diamond.getAssetIndexesSCDP(f.Collateral.address);\n(0, _chai.expect)(indicesAfter.currLiqIndex).to.equal(_values.RAY);\n(0, _chai.expect)(indicesAfter.currFeeIndex).to.equal(_values.RAY);",
                  "err": {},
                  "uuid": "536a5802-2370-4e12-8793-b1953280c0df",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to disable a deposit asset",
                  "fullTitle": "SCDP #Configuration should be able to disable a deposit asset",
                  "timedOut": false,
                  "duration": 17,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, false);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.Collateral.address);\nconst depositAssets = await hre.Diamond.viewSCDPDepositAssets();\n(0, _chai.expect)(depositAssets).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);",
                  "err": {},
                  "uuid": "2728b07e-d4eb-4eec-9b8a-a2294ad627da",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to disable and enable a collateral asset",
                  "fullTitle": "SCDP #Configuration should be able to disable and enable a collateral asset",
                  "timedOut": false,
                  "duration": 57,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await hre.Diamond.setAssetIsSharedOrSwappedCollateralSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\nawait hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, false);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setAssetIsSharedOrSwappedCollateralSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getCollateralsSCDP()).to.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.not.include(f.Collateral.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(false);\nawait hre.Diamond.setAssetIsSharedCollateralSCDP(f.Collateral.address, true);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.Collateral.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.viewSCDPDepositAssets()).to.include(f.Collateral.address);",
                  "err": {},
                  "uuid": "bad4b903-680f-4c07-a9b9-7b371cc04875",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to add whitelisted kresko asset",
                  "fullTitle": "SCDP #Configuration should be able to add whitelisted kresko asset",
                  "timedOut": false,
                  "duration": 9,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(f.swapKrAssetConfig.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(f.swapKrAssetConfig.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(f.swapKrAssetConfig.liqIncentiveSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(f.swapKrAssetConfig.protocolFeeShareSCDP);",
                  "err": {},
                  "uuid": "f939dd3b-3190-458f-9054-62850ddfff85",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to update a whitelisted kresko asset",
                  "fullTitle": "SCDP #Configuration should be able to update a whitelisted kresko asset",
                  "timedOut": false,
                  "duration": 50,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const update = {\n    ...f.KrAsset.config.assetStruct,\n    swapInFeeSCDP: 0.05e4,\n    swapOutFeeSCDP: 0.05e4,\n    liqIncentiveSCDP: 1.06e4,\n    protocolFeeShareSCDP: 0.4e4\n};\nawait hre.Diamond.updateAsset(f.KrAsset.address, update);\nconst assetInfo = await hre.Diamond.getAsset(f.KrAsset.address);\n(0, _chai.expect)(assetInfo.swapInFeeSCDP).to.equal(update.swapInFeeSCDP);\n(0, _chai.expect)(assetInfo.swapOutFeeSCDP).to.equal(update.swapOutFeeSCDP);\n(0, _chai.expect)(assetInfo.protocolFeeShareSCDP).to.equal(update.protocolFeeShareSCDP);\n(0, _chai.expect)(assetInfo.liqIncentiveSCDP).to.equal(update.liqIncentiveSCDP);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.include(f.KrAsset.address);\nconst collaterals = await hre.Diamond.getCollateralsSCDP();\n(0, _chai.expect)(collaterals).to.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);",
                  "err": {},
                  "uuid": "489b48c9-ae2c-4e9f-be6b-aa1628f680fc",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to remove a whitelisted kresko asset",
                  "fullTitle": "SCDP #Configuration should be able to remove a whitelisted kresko asset",
                  "timedOut": false,
                  "duration": 14,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await hre.Diamond.setAssetIsSwapMintableSCDP(f.KrAsset.address, false);\nconst krAssets = await hre.Diamond.getKreskoAssetsSCDP();\n(0, _chai.expect)(krAssets).to.not.include(f.KrAsset.address);\n(0, _chai.expect)(await hre.Diamond.getDepositEnabledSCDP(f.KrAsset.address)).to.equal(false);",
                  "err": {},
                  "uuid": "a706b97f-b800-4c24-9835-60b77aa2186f",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to enable and disable swap pairs",
                  "fullTitle": "SCDP #Configuration should be able to enable and disable swap pairs",
                  "timedOut": false,
                  "duration": 22,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapPairsEnabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: true\n    }\n];\nawait hre.Diamond.setSwapRoutesSCDP(swapPairsEnabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(true);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(true);\nconst swapPairsDisabled = [\n    {\n        assetIn: f.Collateral.address,\n        assetOut: f.KrAsset.address,\n        enabled: false\n    }\n];\nawait hre.Diamond.setSwapRoutesSCDP(swapPairsDisabled);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.Collateral.address, f.KrAsset.address)).to.equal(false);\n(0, _chai.expect)(await hre.Diamond.getSwapEnabledSCDP(f.KrAsset.address, f.Collateral.address)).to.equal(false);",
                  "err": {},
                  "uuid": "6d10555a-62af-47f0-9833-cd44bd3bc4f6",
                  "parentUUID": "162dcbbd-5043-467d-8a72-3ea76a4a1bb7",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "d97df68b-f186-48df-80f1-e6d0b95627ec",
                "46d94637-397b-4dd5-994b-29714f3b00d0",
                "536a5802-2370-4e12-8793-b1953280c0df",
                "2728b07e-d4eb-4eec-9b8a-a2294ad627da",
                "bad4b903-680f-4c07-a9b9-7b371cc04875",
                "f939dd3b-3190-458f-9054-62850ddfff85",
                "489b48c9-ae2c-4e9f-be6b-aa1628f680fc",
                "a706b97f-b800-4c24-9835-60b77aa2186f",
                "6d10555a-62af-47f0-9833-cd44bd3bc4f6"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 278,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "e2587ae8-8bfa-4cf6-9ae2-ed0f19a14374",
              "title": "#Deposit",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should be able to deposit collateral, calculate correct deposit values",
                  "fullTitle": "SCDP #Deposit should be able to deposit collateral, calculate correct deposit values",
                  "timedOut": false,
                  "duration": 486,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted = (f.CollateralPrice.num(8) * depositAmount).ebn(8) // cfactor = 1\n;\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait Promise.all(f.usersArr.map((user)=>{\n    return hre.Diamond.connect(user).depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n}));\nconst prices = hre.viewData();\nconst [userInfos, { scdp }, [assetInfo]] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((user)=>user.address), [\n        f.Collateral.address\n    ]),\n    hre.Diamond.viewProtocolData(prices),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const balance = await f.Collateral.balanceOf(userInfo.addr);\n    (0, _chai.expect)(balance).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.totals.valFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].val).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[0].valFees).to.equal(0);\n}\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.amountColl).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfo.valColl).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n// Adjusted\n(0, _chai.expect)(assetInfo.valCollAdj).to.equal(expectedValueAdjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valCollAdj).to.equal(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valDebtOgAdj).to.equal(0);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.crOgAdj).to.equal(_viem.maxUint256);\n(0, _chai.expect)(scdp.totals.crOg).to.equal(_viem.maxUint256);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);",
                  "err": {},
                  "uuid": "8d537810-6d8e-42a5-9323-9f08267b711d",
                  "parentUUID": "e2587ae8-8bfa-4cf6-9ae2-ed0f19a14374",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to deposit multiple collaterals, calculate correct deposit values",
                  "fullTitle": "SCDP #Deposit should be able to deposit multiple collaterals, calculate correct deposit values",
                  "timedOut": false,
                  "duration": 552,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted = (0, _values.toBig)(f.CollateralPrice.num(8) / 1 * depositAmount, 8) // cfactor = 1\n;\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * 0.8 * depositAmount, 8) // cfactor = 0.8\n;\nawait Promise.all(f.usersArr.map(async (user)=>{\n    const User = hre.Diamond.connect(user);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\n    await User.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\n    await User.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec);\n}));\nconst prices = hre.viewData();\nconst [userInfos, assetInfos, { scdp }] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=>u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].val).to.equal(expectedValueUnadjusted);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(depositAmount8Dec);\n    (0, _chai.expect)(userInfo.deposits[1].val).to.equal(expectedValueUnadjusted8Dec);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec));\n}\n(0, _chai.expect)(assetInfos[0].amountColl).to.equal(depositAmount18Dec.mul(f.usersArr.length));\n(0, _chai.expect)(assetInfos[1].amountColl).to.equal(depositAmount8Dec.mul(f.usersArr.length));\n// WITH_FACTORS global\nconst valueTotalAdjusted = expectedValueAdjusted.mul(f.usersArr.length);\nconst valueTotalAdjusted8Dec = expectedValueAdjusted8Dec.mul(f.usersArr.length);\nconst valueAdjusted = valueTotalAdjusted.add(valueTotalAdjusted8Dec);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(valueTotalAdjusted);\n(0, _chai.expect)(assetInfos[1].valCollAdj).to.equal(valueTotalAdjusted8Dec);\n(0, _chai.expect)(scdp.totals.valCollAdj).to.equal(valueAdjusted);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);\n// WITHOUT_FACTORS global\nconst valueTotalUnadjusted = expectedValueUnadjusted.mul(f.usersArr.length);\nconst valueTotalUnadjusted8Dec = expectedValueUnadjusted8Dec.mul(f.usersArr.length);\nconst valueUnadjusted = valueTotalUnadjusted.add(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(valueTotalUnadjusted);\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(valueTotalUnadjusted8Dec);\n(0, _chai.expect)(scdp.totals.valColl).to.equal(valueUnadjusted);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);",
                  "err": {},
                  "uuid": "be18ca29-ee5d-47d0-8b3c-01557628fe89",
                  "parentUUID": "e2587ae8-8bfa-4cf6-9ae2-ed0f19a14374",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "8d537810-6d8e-42a5-9323-9f08267b711d",
                "be18ca29-ee5d-47d0-8b3c-01557628fe89"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 1038,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "aee16185-7b0a-4ee3-a0eb-30516ba1e531",
              "title": "#Withdraw",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Withdraw\"",
                  "fullTitle": "SCDP #Withdraw \"before each\" hook in \"#Withdraw\"",
                  "timedOut": false,
                  "duration": 89,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await Promise.all(f.usersArr.map(async (user)=>{\n    const UserKresko = hre.Diamond.connect(user);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\n    await UserKresko.depositSCDP(user.address, f.Collateral.address, depositAmount18Dec);\n    await hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\n    await UserKresko.depositSCDP(user.address, f.Collateral8Dec.address, depositAmount8Dec);\n}));",
                  "err": {},
                  "uuid": "0e36574f-f3f6-4691-86b2-4962f19169cb",
                  "parentUUID": "aee16185-7b0a-4ee3-a0eb-30516ba1e531",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should be able to withdraw full collateral of multiple assets",
                  "fullTitle": "SCDP #Withdraw should be able to withdraw full collateral of multiple assets",
                  "timedOut": false,
                  "duration": 809,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await Promise.all(f.usersArr.map(async (user)=>{\n    const UserKresko = hre.Diamond.connect(user);\n    return Promise.all([\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral.address,\n            amount: depositAmount18Dec,\n            receiver: user.address\n        }, await hre.updateData()),\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral8Dec.address,\n            amount: depositAmount8Dec,\n            receiver: user.address\n        }, await hre.updateData())\n    ]);\n}));\n(0, _chai.expect)(await f.Collateral.balanceOf(hre.Diamond.address)).to.equal(0);\nconst prices = hre.viewData();\nconst [userInfos, assetInfos, { scdp }] = await Promise.all([\n    hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=>u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nfor (const userInfo of userInfos){\n    (0, _chai.expect)(await f.Collateral.balanceOf(userInfo.addr)).to.equal(depositAmount18Dec);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.totals.valColl).to.equal(0);\n}\nfor (const assetInfo of assetInfos){\n    (0, _chai.expect)(assetInfo.valColl).to.equal(0);\n    (0, _chai.expect)(assetInfo.amountColl).to.equal(0);\n    (0, _chai.expect)(assetInfo.amountSwapDeposit).to.equal(0);\n}\n(0, _chai.expect)(scdp.totals.valColl).to.equal(0);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(0);",
                  "err": {},
                  "uuid": "6afa29ab-1776-4b35-9e8a-911652d68a4c",
                  "parentUUID": "aee16185-7b0a-4ee3-a0eb-30516ba1e531",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to withdraw partial collateral of multiple assets",
                  "fullTitle": "SCDP #Withdraw should be able to withdraw partial collateral of multiple assets",
                  "timedOut": false,
                  "duration": 852,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const partialWithdraw = depositAmount18Dec.div(f.usersArr.length);\nconst partialWithdraw8Dec = depositAmount8Dec.div(f.usersArr.length);\nconst expectedValueUnadjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted = (0, _values.toBig)(f.CollateralPrice.num(8) * 1 * depositAmount, 8).mul(200).div(300) // cfactor = 1\n;\nconst expectedValueUnadjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8).mul(200).div(300);\nconst expectedValueAdjusted8Dec = (0, _values.toBig)(f.CollateralPrice.num(8) * 0.8 * depositAmount, 8).mul(200).div(300) // cfactor = 0.8\n;\nawait Promise.all(f.usersArr.map(async (user)=>{\n    const UserKresko = hre.Diamond.connect(user);\n    return Promise.all([\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral.address,\n            amount: partialWithdraw,\n            receiver: user.address\n        }, await hre.updateData()),\n        UserKresko.withdrawSCDP({\n            account: user.address,\n            asset: f.Collateral8Dec.address,\n            amount: partialWithdraw8Dec,\n            receiver: user.address\n        }, await hre.updateData())\n    ]);\n}));\nconst [collateralBalanceAfter, collateral8DecBalanceAfter, { scdp }, assetInfos, userInfos] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    f.Collateral8Dec.balanceOf(hre.Diamond.address),\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ]),\n    hre.Diamond.viewSCDPAccounts(hre.viewData(), f.usersArr.map((u)=>u.address), [\n        f.Collateral.address,\n        f.Collateral8Dec.address\n    ])\n]);\nfor (const userInfo of userInfos){\n    const [balance18Dec, balance8Dec] = await Promise.all([\n        f.Collateral.balanceOf(userInfo.addr),\n        f.Collateral8Dec.balanceOf(userInfo.addr)\n    ]);\n    (0, _chai.expect)(balance18Dec).to.equal(partialWithdraw);\n    (0, _chai.expect)(balance8Dec).to.equal(partialWithdraw8Dec);\n    (0, _chai.expect)(userInfo.deposits[0].amount).to.equal(depositAmount18Dec.sub(partialWithdraw));\n    (0, _chai.expect)(userInfo.deposits[0].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.deposits[1].amount).to.equal(depositAmount8Dec.sub(partialWithdraw8Dec));\n    (0, _chai.expect)(userInfo.deposits[1].amountFees).to.equal(0);\n    (0, _chai.expect)(userInfo.totals.valColl).to.closeTo(expectedValueUnadjusted.add(expectedValueUnadjusted8Dec), (0, _values.toBig)(0.00001, 8));\n}\n(0, _chai.expect)(collateralBalanceAfter).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(collateral8DecBalanceAfter).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].amountColl).to.closeTo((0, _values.toBig)(2000), 1);\n(0, _chai.expect)(assetInfos[1].amountColl).to.closeTo((0, _values.toBig)(2000, 8), 1);\n(0, _chai.expect)(assetInfos[0].valColl).to.closeTo(expectedValueUnadjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[0].valCollAdj).to.closeTo(expectedValueAdjusted.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].valColl).to.closeTo(expectedValueUnadjusted8Dec.mul(f.usersArr.length), 20);\n(0, _chai.expect)(assetInfos[1].valCollAdj).to.closeTo(expectedValueAdjusted8Dec.mul(f.usersArr.length), 20);\nconst totalValueRemaining = expectedValueUnadjusted8Dec.mul(f.usersArr.length).add(expectedValueUnadjusted.mul(f.usersArr.length));\n(0, _chai.expect)(scdp.totals.valColl).to.closeTo(totalValueRemaining, 20);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);",
                  "err": {},
                  "uuid": "5ca2b4e7-576c-4ce1-a8b5-1f2cbb850ede",
                  "parentUUID": "aee16185-7b0a-4ee3-a0eb-30516ba1e531",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "6afa29ab-1776-4b35-9e8a-911652d68a4c",
                "5ca2b4e7-576c-4ce1-a8b5-1f2cbb850ede"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 1661,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "da87a9ff-8ba9-4647-b885-37219ca54254",
              "title": "#Fee Distribution",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Fee Distribution\"",
                  "fullTitle": "SCDP #Fee Distribution \"before each\" hook in \"#Fee Distribution\"",
                  "timedOut": false,
                  "duration": 2,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "incomeCumulator = hre.users.deployer;\nIncomeCumulator = hre.Diamond.connect(incomeCumulator);\nawait f.Collateral.setBalance(incomeCumulator, depositAmount18Dec.mul(f.usersArr.length), hre.Diamond.address);",
                  "err": {},
                  "uuid": "e0fbe1ce-aa77-4e2c-b3f3-7c6b2e122cc7",
                  "parentUUID": "da87a9ff-8ba9-4647-b885-37219ca54254",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should be able to cumulate fees into deposits",
                  "fullTitle": "SCDP #Fee Distribution should be able to cumulate fees into deposits",
                  "timedOut": false,
                  "duration": 823,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nconst feePerUser = depositAmount18Dec;\nconst feesToCumulate = feePerUser.mul(f.usersArr.length);\nconst feePerUserValue = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\nconst expectedDepositValue = (0, _values.toBig)(f.CollateralPrice.num(8) * depositAmount, 8);\n// deposit some\nawait Promise.all(f.usersArr.map((signer)=>hre.Diamond.connect(signer).depositSCDP(signer.address, f.Collateral.address, depositAmount18Dec)));\n// cumulate some income\nawait IncomeCumulator.cumulateIncomeSCDP(f.Collateral.address, feesToCumulate);\n// check that the fees are cumulated\nfor (const data of (await hre.Diamond.viewSCDPAccounts(hre.viewData(), f.usersArr.map((u)=>u.address), [\n    f.Collateral.address\n]))){\n    (0, _chai.expect)(data.deposits[0].val).to.equal(expectedDepositValue);\n    (0, _chai.expect)(data.deposits[0].valFees).to.equal(feePerUserValue);\n    (0, _chai.expect)(data.totals.valColl).to.equal(expectedDepositValue);\n    (0, _chai.expect)(data.totals.valFees).to.equal(feePerUserValue);\n}\n// withdraw principal\nawait Promise.all(f.usersArr.map(async (signer)=>hre.Diamond.connect(signer).withdrawSCDP({\n        account: signer.address,\n        asset: f.Collateral.address,\n        amount: depositAmount18Dec,\n        receiver: signer.address\n    }, await hre.updateData())));\nconst prices = hre.viewData();\nfor (const user of (await hre.Diamond.viewSCDPAccounts(prices, f.usersArr.map((u)=>u.address), [\n    f.Collateral.address\n]))){\n    const balance = await f.Collateral.balanceOf(user.addr);\n    (0, _chai.expect)(user.deposits[0].val).to.equal(0);\n    (0, _chai.expect)(user.deposits[0].valFees).to.equal(0);\n    (0, _chai.expect)(user.totals.valFees).to.equal(0);\n    (0, _chai.expect)(user.totals.valColl).to.equal(0);\n    (0, _chai.expect)(balance).to.equal(depositAmount18Dec.add(feePerUser));\n}\nconst [[assetInfo], { scdp }, balance] = await Promise.all([\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ]),\n    hre.Diamond.viewProtocolData(prices),\n    f.Collateral.balanceOf(hre.Diamond.address)\n]);\n(0, _chai.expect)(balance).to.equal(0);\n(0, _chai.expect)(assetInfo.amountColl).to.equal(0);\n(0, _chai.expect)(assetInfo.valColl).to.equal(0);\n(0, _chai.expect)(assetInfo.valCollAdj).to.equal(0);\n(0, _chai.expect)(scdp.totals.valColl).to.equal(0);\n// nothing left in protocol.\nconst [colalteralBalanceKresko, [assetInfoFinal]] = await Promise.all([\n    f.Collateral.balanceOf(hre.Diamond.address),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.Collateral.address\n    ])\n]);\n(0, _chai.expect)(colalteralBalanceKresko).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.amountColl).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.valColl).to.equal(0);\n(0, _chai.expect)(assetInfoFinal.valCollAdj).to.equal(0);",
                  "err": {},
                  "uuid": "880307fa-7304-4acc-b4d2-11ce94c0cb63",
                  "parentUUID": "da87a9ff-8ba9-4647-b885-37219ca54254",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "880307fa-7304-4acc-b4d2-11ce94c0cb63"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 823,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "965922e5-2c32-4526-9dee-7347a3b0b25e",
              "title": "#Swap",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Swap\"",
                  "fullTitle": "SCDP #Swap \"before each\" hook in \"#Swap\"",
                  "timedOut": false,
                  "duration": 20,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await Promise.all(f.usersArr.map((signer)=>f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor, (0, _values.toBig)(10_000));\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, depositAmount18Dec);",
                  "err": {},
                  "uuid": "3f074f8a-952a-4c91-8347-640093e61346",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should have collateral in pool",
                  "fullTitle": "SCDP #Swap should have collateral in pool",
                  "timedOut": false,
                  "duration": 301,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.valColl).to.equal((0, _values.toBig)(depositAmount, 8));\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdp.totals.cr).to.equal(_viem.maxUint256);",
                  "err": {},
                  "uuid": "645e7050-2d4e-47f0-966f-7f2a7811c946",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to preview a swap",
                  "fullTitle": "SCDP #Swap should be able to preview a swap",
                  "timedOut": false,
                  "duration": 22,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1);\n(0, _chai.expect)((await f.KrAsset2.getPrice()).pyth).to.equal(f.KrAsset2Price);\nconst feePercentageProtocol = Number(f.KISS.config.assetStruct.protocolFeeShareSCDP) + Number(f.KrAsset2.config.assetStruct.protocolFeeShareSCDP);\nconst expectedTotalFee = swapAmount.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst expectedProtocolFee = expectedTotalFee.percentMul(feePercentageProtocol);\nconst expectedFee = expectedTotalFee.sub(expectedProtocolFee);\nconst amountInAfterFees = swapAmount.sub(expectedTotalFee);\nconst expectedAmountOut = amountInAfterFees.wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst [amountOut, feeAmount, feeAmountProtocol] = await hre.Diamond.previewSwapSCDP(f.KISS.address, f.KrAsset2.address, swapAmount);\n(0, _chai.expect)(amountOut).to.equal(expectedAmountOut);\n(0, _chai.expect)(feeAmount).to.equal(expectedFee);\n(0, _chai.expect)(feeAmountProtocol).to.equal(expectedProtocolFee);",
                  "err": {},
                  "uuid": "5b4db091-01a0-4e2d-8089-d45b6016acc5",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to swap, shared debt == 0 | swap collateral == 0",
                  "fullTitle": "SCDP #Swap should be able to swap, shared debt == 0 | swap collateral == 0",
                  "timedOut": false,
                  "duration": 540,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1) // $1\n;\nconst kissInAfterFees = swapAmount.sub(swapAmount.percentMul(f.KRASSET_KISS_ROUTE_FEE));\nconst expectedAmountOut = kissInAfterFees.wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, 'Swap');\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmount);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedAmountOut);\nconst prices = hre.viewData();\nconst [KR2Balance, KISSBalance, swapperInfos, assetInfos, { scdp }] = await Promise.all([\n    f.KrAsset2.balanceOf(f.swapper.address),\n    f.KISS.balanceOf(f.swapper.address),\n    hre.Diamond.viewSCDPAccounts(prices, [\n        f.swapper.address\n    ], [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.viewSCDPAssets(prices, [\n        f.KrAsset2.address,\n        f.KISS.address\n    ]),\n    hre.Diamond.viewProtocolData(prices)\n]);\nconst swapperInfo = swapperInfos[0];\n(0, _chai.expect)(KR2Balance).to.equal(expectedAmountOut);\n(0, _chai.expect)(KISSBalance).to.equal((0, _values.toBig)(10_000).sub(swapAmount));\n(0, _chai.expect)(swapperInfo.deposits[0].val).to.equal(0);\n(0, _chai.expect)(swapperInfo.deposits[1].val).to.equal(0);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(expectedAmountOut);\n(0, _chai.expect)(assetInfos[1].amountSwapDeposit).to.equal(kissInAfterFees);\nconst expectedDepositValue = (0, _values.toBig)(depositAmount, 8).add(kissInAfterFees.wadMul(f.KISSPrice));\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(expectedDepositValue);\n(0, _chai.expect)(assetInfos[0].valDebt).to.equal(expectedAmountOut.wadMul(f.KrAsset2Price));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedDepositValue);\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(expectedAmountOut.wadMul(f.KrAsset2Price));\n(0, _chai.expect)(scdp.totals.cr).to.equal(expectedDepositValue.percentDiv(expectedAmountOut.wadMul(f.KrAsset2Price)));",
                  "err": {},
                  "uuid": "3c459960-1bc3-4879-ae14-ba738d53ee28",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to swap, shared debt == assetsIn | swap collateral == assetsOut",
                  "fullTitle": "SCDP #Swap should be able to swap, shared debt == assetsIn | swap collateral == assetsOut",
                  "timedOut": false,
                  "duration": 950,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(100) // $100\n;\nconst swapAmountAsset = swapAmount.percentMul(1e4 - Number(f.KRASSET_KISS_ROUTE_FEE)).wadMul(f.KISSPrice.wadDiv(f.KrAsset2Price));\nconst expectedKissOut = swapAmountAsset.percentMul(1e4 - f.KRASSET_KISS_ROUTE_FEE).wadMul(f.KrAsset2Price).wadDiv(f.KISSPrice);\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: f.swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(100)\n});\nawait (0, _krassets.mintKrAsset)({\n    user: f.swapper,\n    asset: f.KrAsset2,\n    amount: (0, _values.toBig)(0.1)\n});\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.valColl).to.equal(initialDepositValue);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n// the swap that clears debt\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountAsset,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst [event, assetInfos] = await Promise.all([\n    (0, _events.getNamedEvent)(tx, 'Swap'),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.KISS.address,\n        f.KrAsset2.address\n    ])\n]);\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(0);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal(initialDepositValue);\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(0);\nconst { scdp: scdpAfter } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdpAfter.totals.valColl).to.equal((0, _values.toBig)(1000, 8));\n(0, _chai.expect)(scdpAfter.totals.valDebt).to.equal(0);\n(0, _chai.expect)(scdpAfter.totals.cr).to.equal(_viem.maxUint256);",
                  "err": {},
                  "uuid": "ad7bb061-8b03-4df9-a8cc-0d7518f292dd",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to swap, debt > assetsIn | swap deposits > assetsOut",
                  "fullTitle": "SCDP #Swap should be able to swap, debt > assetsIn | swap deposits > assetsOut",
                  "timedOut": false,
                  "duration": 634,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1) // $1\n;\nconst swapValue = (0, _values.toBig)(1, 8);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst [assetInfoKISS] = await hre.Diamond.viewSCDPAssets(hre.viewData(), [\n    f.KISS.address\n]);\nconst feeValueFirstSwap = swapValue.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst valueInAfterFees = swapValue.sub(feeValueFirstSwap);\n(0, _chai.expect)(assetInfoKISS.valColl).to.equal(depositValue.add(valueInAfterFees));\nconst expectedSwapDeposits = valueInAfterFees.num(8).ebn(18);\n(0, _chai.expect)(assetInfoKISS.amountSwapDeposit).to.equal(expectedSwapDeposits);\nconst swapAmountSecond = (0, _values.toBig)(0.009) // this is $0.90, so less than $0.96 since we want to ensure debt > assetsIn | swap deposits > assetsOut\n;\nconst swapValueSecond = swapAmountSecond.wadMul(f.KrAsset2Price);\nconst feeValueSecondSwap = swapValueSecond.sub(swapValueSecond.percentMul(f.KRASSET_KISS_ROUTE_FEE));\nconst expectedKissOut = feeValueSecondSwap.wadDiv(f.KISSPrice) // 0.8685\n;\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountSecond,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, 'Swap');\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountSecond);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOut);\nconst [depositValueKR2, depositValueKISS, assetInfos, { scdp }] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.swapper.address, f.KrAsset2.address),\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.swapper.address, f.KISS.address),\n    hre.Diamond.viewSCDPAssets(hre.viewData(), [\n        f.KISS.address,\n        f.KrAsset2.address\n    ]),\n    hre.Diamond.viewProtocolData(hre.viewData())\n]);\n(0, _chai.expect)(depositValueKR2).to.equal(0);\n(0, _chai.expect)(depositValueKISS).to.equal(0);\nconst expectedSwapDepositsAfter = expectedSwapDeposits.sub((0, _values.toBig)(0.9));\nconst expectedSwapDepositsValue = expectedSwapDepositsAfter.wadMul(assetInfoKISS.price);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(expectedSwapDepositsAfter);\n(0, _chai.expect)(assetInfos[0].valColl).to.equal((0, _values.toBig)(depositAmount, 8).add(expectedSwapDepositsValue));\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(expectedSwapDepositsValue);\nconst expectedDebtAfter = expectedSwapDepositsValue.wadDiv((await f.KrAsset2.getPrice()).pyth);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(expectedDebtAfter);\nconst expectedCollateralValue = expectedSwapDepositsValue.add(depositAmount.ebn(8));\n(0, _chai.expect)(scdp.totals.valColl).to.equal(expectedCollateralValue) // swap deposits + collateral deposited\n;\n(0, _chai.expect)(scdp.totals.valDebt).to.equal(expectedSwapDepositsValue) //\n;\n(0, _chai.expect)(scdp.totals.cr).to.equal(expectedCollateralValue.percentDiv(expectedSwapDepositsValue));",
                  "err": {},
                  "uuid": "1695c635-a12c-44c6-b6ed-aa68d1db36ef",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should be able to swap, debt < assetsIn | swap deposits < assetsOut",
                  "fullTitle": "SCDP #Swap should be able to swap, debt < assetsIn | swap deposits < assetsOut",
                  "timedOut": false,
                  "duration": 1339,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmountKiss = (0, _values.toBig)(100) // $100\n;\nconst swapAmountKrAsset = (0, _values.toBig)(2) // $200\n;\nconst swapValue = 200;\nconst firstSwapFeeAmount = swapAmountKiss.percentMul(f.KRASSET_KISS_ROUTE_FEE);\nconst expectedKissOutSecondSwap = swapAmountKrAsset.sub(swapAmountKrAsset.percentMul(f.KRASSET_KISS_ROUTE_FEE)).wadMul(f.KrAsset2Price).wadDiv(f.KISSPrice);\nconst krAssetOutFirstSwap = swapAmountKiss.sub(firstSwapFeeAmount).wadMul(f.KISSPrice).wadDiv(f.KrAsset2Price);\nconst krAssetOutFirstSwapValue = krAssetOutFirstSwap.wadMul(f.KrAsset2Price);\n// deposit some to kresko for minting first\nawait (0, _collaterals.depositCollateral)({\n    user: f.swapper,\n    asset: f.KISS,\n    amount: (0, _values.toBig)(400)\n});\nconst ICDPMintAmount = (0, _values.toBig)(1.04);\nawait (0, _krassets.mintKrAsset)({\n    user: f.swapper,\n    asset: f.KrAsset2,\n    amount: ICDPMintAmount\n});\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmountKiss,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst expectedSwapDeposits = swapAmountKiss.sub(firstSwapFeeAmount);\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(await f.KreskoSwapper.getSwapDepositsSCDP(f.KISS.address)).to.equal(expectedSwapDeposits);\n(0, _chai.expect)(scdp.totals.valColl).to.be.eq(depositAmount.ebn().add(expectedSwapDeposits).wadMul(f.KISSPrice));\n// the swap that matters, here user has 0.96 (previous swap) + 1.04 (mint). expecting 192 kiss from swap.\nconst [expectedAmountOut] = await f.KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmountKrAsset);\n(0, _chai.expect)(expectedAmountOut).to.equal(expectedKissOutSecondSwap);\nconst tx = await f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmountKrAsset,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst event = await (0, _events.getNamedEvent)(tx, 'Swap');\n(0, _chai.expect)(event.args.who).to.equal(f.swapper.address);\n(0, _chai.expect)(event.args.assetIn).to.equal(f.KrAsset2.address);\n(0, _chai.expect)(event.args.assetOut).to.equal(f.KISS.address);\n(0, _chai.expect)(event.args.amountIn).to.equal(swapAmountKrAsset);\n(0, _chai.expect)(event.args.amountOut).to.equal(expectedKissOutSecondSwap);\nconst assetInfos = await hre.Diamond.viewSCDPAssets(hre.viewData(), [\n    f.KISS.address,\n    f.KrAsset2.address\n]);\n// f.KISS deposits sent in swap\nconst acocuntPrincipalDepositsKISS = await f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(assetInfos[0].amountSwapDeposit).to.equal(0) // half of 2 krAsset\n;\n(0, _chai.expect)(assetInfos[0].amountColl).to.equal(acocuntPrincipalDepositsKISS);\n// KrAsset debt is cleared\n(0, _chai.expect)(assetInfos[1].valDebt).to.equal(0);\n(0, _chai.expect)(assetInfos[1].amountDebt).to.equal(0);\n// KISS debt is issued\nconst expectedKissDebtValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[0].valDebt).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(assetInfos[0].amountDebt).to.equal(expectedKissDebtValue.wadDiv(f.KISSPrice));\n// krAsset swap deposits\nconst expectedSwapDepositValue = (0, _values.toBig)(swapValue, 8).sub(krAssetOutFirstSwapValue);\n(0, _chai.expect)(assetInfos[1].amountSwapDeposit).to.equal((0, _values.toBig)(2).sub(krAssetOutFirstSwap));\n(0, _chai.expect)(assetInfos[1].valColl).to.equal(expectedSwapDepositValue) // asset price is $100\n;\nconst { scdp: scdpAfter } = await hre.Diamond.viewProtocolData(hre.viewData());\nconst expectedCollateralValue = (0, _values.toBig)(1000, 8).add(expectedSwapDepositValue);\n(0, _chai.expect)(scdpAfter.totals.valColl).to.equal(expectedCollateralValue);\n(0, _chai.expect)(scdpAfter.totals.valDebt).to.equal(expectedKissDebtValue);\n(0, _chai.expect)(scdpAfter.totals.cr).to.equal(expectedCollateralValue.percentDiv(expectedKissDebtValue));",
                  "err": {},
                  "uuid": "87b450f2-629e-4815-afb7-cf528753db18",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "cumulates fees on swap",
                  "fullTitle": "SCDP #Swap cumulates fees on swap",
                  "timedOut": false,
                  "duration": 331,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const depositAmountNew = (0, _values.toBig)(10000 - depositAmount);\nawait f.KISS.setBalance(f.depositor, depositAmountNew);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, depositAmountNew);\nconst swapAmount = (0, _values.toBig)(2600);\nconst feesBeforeSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst feesAfterSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(feesAfterSwap).to.gt(feesBeforeSwap);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: f.KrAsset2.balanceOf(f.swapper.address),\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst feesAfterSecondSwap = await f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address);\n(0, _chai.expect)(feesAfterSecondSwap).to.gt(feesAfterSwap);\nawait f.KreskoDepositor.claimFeesSCDP(f.depositor.address, f.KISS.address, f.depositor.address);\nconst [depositsAfter, feesAfter] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.KISS.address),\n    f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(feesAfter).to.eq(0);\n(0, _chai.expect)(depositsAfter).to.eq((0, _values.toBig)(10000));\nawait f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.KISS.address,\n    amount: (0, _values.toBig)(10000),\n    receiver: f.depositor.address\n}, await hre.updateData());\nconst [depositsAfterWithdraw, feesAfterWithdraw] = await Promise.all([\n    f.KreskoSwapper.getAccountDepositValueSCDP(f.depositor.address, f.KISS.address),\n    f.KreskoSwapper.getAccountFeesSCDP(f.depositor.address, f.KISS.address)\n]);\n(0, _chai.expect)(depositsAfterWithdraw).to.eq(0);\n(0, _chai.expect)(feesAfterWithdraw).to.eq(0);",
                  "err": {},
                  "uuid": "8d588179-cada-4cd2-8fe9-6136dc656e42",
                  "parentUUID": "965922e5-2c32-4526-9dee-7347a3b0b25e",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "645e7050-2d4e-47f0-966f-7f2a7811c946",
                "5b4db091-01a0-4e2d-8089-d45b6016acc5",
                "3c459960-1bc3-4879-ae14-ba738d53ee28",
                "ad7bb061-8b03-4df9-a8cc-0d7518f292dd",
                "1695c635-a12c-44c6-b6ed-aa68d1db36ef",
                "87b450f2-629e-4815-afb7-cf528753db18",
                "8d588179-cada-4cd2-8fe9-6136dc656e42"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 4117,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "29513991-bf0b-4185-bfa9-87de696f6542",
              "title": "#Liquidations",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Liquidations\"",
                  "fullTitle": "SCDP #Liquidations \"before each\" hook in \"#Liquidations\"",
                  "timedOut": false,
                  "duration": 41,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "for (const signer of f.usersArr){\n    await f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000));\n}\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor2, (0, _values.toBig)(10_000));\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral8Dec.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral8Dec.address, depositAmount8Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.KISS.address);\nf.KreskoDepositor2.depositSCDP(f.depositor2.address, f.KISS.address, depositAmount18Dec);",
                  "err": {},
                  "uuid": "fe5ad420-e93d-4698-8ab0-917b080cd55a",
                  "parentUUID": "29513991-bf0b-4185-bfa9-87de696f6542",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should identify if the pool is not underwater",
                  "fullTitle": "SCDP #Liquidations should identify if the pool is not underwater",
                  "timedOut": false,
                  "duration": 177,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(2600) // $1\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;",
                  "err": {},
                  "uuid": "304abb49-323b-437c-90c9-d38b4a0bcadc",
                  "parentUUID": "29513991-bf0b-4185-bfa9-87de696f6542",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert liquidations if the pool is not underwater",
                  "fullTitle": "SCDP #Liquidations should revert liquidations if the pool is not underwater",
                  "timedOut": false,
                  "duration": 276,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(2600) // $1\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\n(0, _chai.expect)(await hre.Diamond.getLiquidatableSCDP()).to.be.false;\nawait f.KrAsset2.setBalance(hre.users.liquidator, (0, _values.toBig)(1_000_000));\nawait (0, _chai.expect)(f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount: (0, _values.toBig)(7.7),\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'COLLATERAL_VALUE_GREATER_THAN_REQUIRED');",
                  "err": {},
                  "uuid": "8180f3c8-80ea-4bbf-a2da-3990261256fa",
                  "parentUUID": "29513991-bf0b-4185-bfa9-87de696f6542",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should identify if the pool is underwater",
                  "fullTitle": "SCDP #Liquidations should identify if the pool is underwater",
                  "timedOut": false,
                  "duration": 604,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(2600);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nawait f.Collateral.setPrice(f.CollateralPrice.num(8) / 1000);\nawait f.Collateral8Dec.setPrice(f.CollateralPrice.num(8) / 1000);\nconst [{ scdp }, liquidatable] = await Promise.all([\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(scdp.totals.cr).to.be.lt(scdp.LT);\n(0, _chai.expect)(liquidatable).to.be.true;",
                  "err": {},
                  "uuid": "c857ff75-7317-4eef-8a4a-7d7b33a20954",
                  "parentUUID": "29513991-bf0b-4185-bfa9-87de696f6542",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should allow liquidating the underwater pool",
                  "fullTitle": "SCDP #Liquidations should allow liquidating the underwater pool",
                  "timedOut": false,
                  "duration": 1692,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(2600);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst newKreskoAssetPrice = 500;\nawait f.KrAsset2.setPrice(newKreskoAssetPrice);\nconst [scdpParams, maxLiquidatable, krAssetPrice, { scdp: scdpBefore }] = await Promise.all([\n    hre.Diamond.getParametersSCDP(),\n    hre.Diamond.getMaxLiqValueSCDP(f.KrAsset2.address, f.Collateral8Dec.address),\n    f.KrAsset2.getPrice(),\n    hre.Diamond.viewProtocolData(hre.viewData())\n]);\nconst repayAmount = maxLiquidatable.repayValue.wadDiv(krAssetPrice.pyth);\nawait f.KrAsset2.setBalance(hre.users.liquidator, repayAmount.add(1e18.toString()));\n(0, _chai.expect)(scdpBefore.totals.cr).to.lt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(scdpBefore.totals.cr).to.gt(1e4);\n// Liquidate the shared CDP\nconst tx = await f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount,\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n});\n// Check the state after liquidation\nconst [{ scdp: scdpAfter }, liquidatableAfter] = await Promise.all([\n    hre.Diamond.viewProtocolData(hre.viewData()),\n    hre.Diamond.getLiquidatableSCDP()\n]);\n(0, _chai.expect)(scdpAfter.totals.cr).to.gt(scdpParams.liquidationThreshold);\n(0, _chai.expect)(scdpAfter.totals.crOgAdj).to.eq(2.01e4);\n(0, _chai.expect)(liquidatableAfter).to.eq(false);\n// Shared CDP should not be liquidatable since it is above the threshold\nawait (0, _chai.expect)(f.KreskoLiquidator.liquidateSCDP({\n    repayAsset: f.KrAsset2.address,\n    repayAmount,\n    seizeAsset: f.Collateral8Dec.address,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'COLLATERAL_VALUE_GREATER_THAN_REQUIRED');\n// Check what was emitted in the event\nconst event = await (0, _events.getNamedEvent)(tx, 'SCDPLiquidationOccured');\nconst expectedSeizeAmount = repayAmount.wadMul((0, _values.toBig)(newKreskoAssetPrice, 8)).percentMul(1.05e4).wadDiv(f.CollateralPrice).div(10 ** 10);\n(0, _chai.expect)(event.args.liquidator).to.eq(hre.users.liquidator.address);\n(0, _chai.expect)(event.args.seizeAmount).to.eq(expectedSeizeAmount);\n(0, _chai.expect)(event.args.repayAmount).to.eq(repayAmount);\n(0, _chai.expect)(event.args.seizeCollateral).to.eq(f.Collateral8Dec.address);\n(0, _chai.expect)(event.args.repayKreskoAsset).to.eq(f.KrAsset2.address);\n// Check account state changes\nconst expectedDepositsAfter = depositAmount8Dec.sub(event.args.seizeAmount);\n(0, _chai.expect)(expectedDepositsAfter).to.be.lt(depositAmount8Dec);\nconst [principalDeposits, fees, params] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountFeesSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getParametersSCDP()\n]);\n(0, _chai.expect)(principalDeposits).to.eq(expectedDepositsAfter);\n(0, _chai.expect)(fees).to.eq(0);\n// Sanity checking that users should be able to withdraw what is left\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec.mul(10));\nconst { scdp } = await hre.Diamond.viewProtocolData(hre.viewData());\n(0, _chai.expect)(scdp.totals.cr).to.gt(params.minCollateralRatio);\nawait (0, _chai.expect)(f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.Collateral8Dec.address,\n    amount: expectedDepositsAfter,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.not.be.reverted;\nconst [principalEnd, feesAfter] = await Promise.all([\n    hre.Diamond.getAccountDepositSCDP(f.depositor.address, f.Collateral8Dec.address),\n    hre.Diamond.getAccountFeesSCDP(f.depositor.address, f.Collateral8Dec.address)\n]);\n(0, _chai.expect)(principalEnd).to.eq(0);\n(0, _chai.expect)(feesAfter).to.eq(0);",
                  "err": {},
                  "uuid": "23e8d6e6-b876-4e58-92b7-39bf68eed439",
                  "parentUUID": "29513991-bf0b-4185-bfa9-87de696f6542",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "304abb49-323b-437c-90c9-d38b4a0bcadc",
                "8180f3c8-80ea-4bbf-a2da-3990261256fa",
                "c857ff75-7317-4eef-8a4a-7d7b33a20954",
                "23e8d6e6-b876-4e58-92b7-39bf68eed439"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 2749,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            },
            {
              "uuid": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
              "title": "#Error",
              "fullFile": "/Users/panukettunen/projects/kresko-protocol/src/test/scdp/00-scdp.ts",
              "file": "/src/test/scdp/00-scdp.ts",
              "beforeHooks": [
                {
                  "title": "\"before each\" hook in \"#Error\"",
                  "fullTitle": "SCDP #Error \"before each\" hook in \"#Error\"",
                  "timedOut": false,
                  "duration": 63,
                  "state": null,
                  "speed": null,
                  "pass": false,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "await Promise.all(f.usersArr.map((signer)=>f.Collateral.setBalance(signer, (0, _values.toBig)(1_000_000))));\nawait f.KISS.setBalance(f.swapper, (0, _values.toBig)(10_000));\nawait f.KISS.setBalance(f.depositor, hre.ethers.BigNumber.from(1));\nawait hre.Diamond.setFeeAssetSCDP(f.Collateral.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.Collateral.address, depositAmount18Dec);\nawait hre.Diamond.setFeeAssetSCDP(f.KISS.address);\nawait f.KreskoDepositor.depositSCDP(f.depositor.address, f.KISS.address, 1);",
                  "err": {},
                  "uuid": "f9d6fc76-0414-4648-b619-309011c67447",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": true,
                  "skipped": false
                }
              ],
              "afterHooks": [],
              "tests": [
                {
                  "title": "should revert depositing unsupported tokens",
                  "fullTitle": "SCDP #Error should revert depositing unsupported tokens",
                  "timedOut": false,
                  "duration": 62,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const [UnsupportedToken] = await hre.deploy('MockERC20', {\n    args: [\n        'UnsupportedToken',\n        'UnsupportedToken',\n        18,\n        (0, _values.toBig)(1)\n    ]\n});\nawait UnsupportedToken.approve(hre.Diamond.address, hre.ethers.constants.MaxUint256);\nconst { deployer } = await hre.getNamedAccounts();\nawait (0, _chai.expect)(hre.Diamond.depositSCDP(deployer, UnsupportedToken.address, 1)).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'ASSET_NOT_FEE_ACCUMULATING_ASSET').withArgs([\n    'UnsupportedToken',\n    UnsupportedToken.address\n]);",
                  "err": {},
                  "uuid": "7a9826f1-07a6-46d7-b1a3-91c1960c9c81",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert withdrawing without deposits",
                  "fullTitle": "SCDP #Error should revert withdrawing without deposits",
                  "timedOut": false,
                  "duration": 51,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const withdrawAmount = 1;\nawait (0, _chai.expect)(f.KreskoSwapper.withdrawSCDP({\n    account: f.swapper.address,\n    asset: f.Collateral.address,\n    amount: withdrawAmount,\n    receiver: f.swapper.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'ACCOUNT_HAS_NO_DEPOSITS').withArgs(f.swapper.address, f.Collateral.errorId);",
                  "err": {},
                  "uuid": "5b9c240c-12d4-4002-8ef4-b33209139cd7",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert withdrawals below MCR",
                  "fullTitle": "SCDP #Error should revert withdrawals below MCR",
                  "timedOut": false,
                  "duration": 197,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1000) // $1000\n;\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KISS.address,\n    assetOut: f.KrAsset2.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n}) // generates the debt\n;\nconst deposits = await f.KreskoSwapper.getAccountDepositSCDP(f.depositor.address, f.Collateral.address);\nawait (0, _chai.expect)(f.KreskoDepositor.withdrawSCDP({\n    account: f.depositor.address,\n    asset: f.Collateral.address,\n    amount: deposits,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'COLLATERAL_VALUE_LESS_THAN_REQUIRED').withArgs(960e8, 4800e8, 5e4);",
                  "err": {},
                  "uuid": "fee5befd-fc69-47d1-9bed-7c0a7a327aee",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert withdrawals of swap owned collateral deposits",
                  "fullTitle": "SCDP #Error should revert withdrawals of swap owned collateral deposits",
                  "timedOut": false,
                  "duration": 182,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nconst deposits = await f.KreskoSwapper.getSwapDepositsSCDP(f.KrAsset2.address);\n(0, _chai.expect)(deposits).to.be.gt(0);\nawait (0, _chai.expect)(f.KreskoSwapper.withdrawSCDP({\n    account: f.swapper.address,\n    asset: f.KrAsset2.address,\n    amount: deposits,\n    receiver: f.depositor.address\n}, await hre.updateData())).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'ASSET_DOES_NOT_HAVE_DEPOSITS').withArgs(f.KrAsset2.errorId);",
                  "err": {},
                  "uuid": "c993fc73-0066-457d-8ef3-5b0f2106b2c9",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert swapping with price below minAmountOut",
                  "fullTitle": "SCDP #Error should revert swapping with price below minAmountOut",
                  "timedOut": false,
                  "duration": 107,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nconst [amountOut] = await f.KreskoSwapper.previewSwapSCDP(f.KrAsset2.address, f.KISS.address, swapAmount);\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: amountOut.add(1),\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'RECEIVED_LESS_THAN_DESIRED').withArgs(f.KISS.errorId, amountOut, amountOut.add(1));",
                  "err": {},
                  "uuid": "49b630e1-7523-4245-bacb-b420b3eee1eb",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert swapping unsupported asset",
                  "fullTitle": "SCDP #Error should revert swapping unsupported asset",
                  "timedOut": false,
                  "duration": 54,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.Collateral.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'SWAP_ROUTE_NOT_ENABLED').withArgs(f.KrAsset2.errorId, f.Collateral.errorId);",
                  "err": {},
                  "uuid": "097fa9d1-5bcb-4a88-9b61-fbe7e2e89d77",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert swapping a disabled route",
                  "fullTitle": "SCDP #Error should revert swapping a disabled route",
                  "timedOut": false,
                  "duration": 57,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nawait hre.Diamond.setSingleSwapRouteSCDP({\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    enabled: false\n});\nawait (0, _chai.expect)(f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n})).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'SWAP_ROUTE_NOT_ENABLED').withArgs(f.KrAsset2.errorId, f.KISS.errorId);",
                  "err": {},
                  "uuid": "2fe2965e-cc89-4ff0-b139-269858180cec",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                },
                {
                  "title": "should revert swapping causes CDP to go below MCR",
                  "fullTitle": "SCDP #Error should revert swapping causes CDP to go below MCR",
                  "timedOut": false,
                  "duration": 140,
                  "state": "passed",
                  "speed": "fast",
                  "pass": true,
                  "fail": false,
                  "pending": false,
                  "context": null,
                  "code": "const swapAmount = (0, _values.toBig)(1_500_000);\nawait f.KrAsset2.setBalance(f.swapper, swapAmount);\nconst tx = f.KreskoSwapper.swapSCDP({\n    receiver: f.swapper.address,\n    assetIn: f.KrAsset2.address,\n    assetOut: f.KISS.address,\n    amountIn: swapAmount,\n    amountOutMin: 0,\n    prices: await hre.updateData()\n});\nawait (0, _chai.expect)(tx).to.be.revertedWithCustomError((0, _errors.Errors)(hre), 'COLLATERAL_VALUE_LESS_THAN_REQUIRED').withArgs('15001000000000000', '75000000000000000', 5e4);",
                  "err": {},
                  "uuid": "fd20b83f-87e9-43bc-8534-e6e90adcd371",
                  "parentUUID": "24f6e2fa-e9e9-4408-8e06-c30f4397d4f5",
                  "isHook": false,
                  "skipped": false
                }
              ],
              "suites": [],
              "passes": [
                "7a9826f1-07a6-46d7-b1a3-91c1960c9c81",
                "5b9c240c-12d4-4002-8ef4-b33209139cd7",
                "fee5befd-fc69-47d1-9bed-7c0a7a327aee",
                "c993fc73-0066-457d-8ef3-5b0f2106b2c9",
                "49b630e1-7523-4245-bacb-b420b3eee1eb",
                "097fa9d1-5bcb-4a88-9b61-fbe7e2e89d77",
                "2fe2965e-cc89-4ff0-b139-269858180cec",
                "fd20b83f-87e9-43bc-8534-e6e90adcd371"
              ],
              "failures": [],
              "pending": [],
              "skipped": [],
              "duration": 850,
              "root": false,
              "rootEmpty": false,
              "_timeout": 30000
            }
          ],
          "passes": [],
          "failures": [],
          "pending": [],
          "skipped": [],
          "duration": 0,
          "root": false,
          "rootEmpty": false,
          "_timeout": 30000
        }
      ],
      "passes": [],
      "failures": [],
      "pending": [],
      "skipped": [],
      "duration": 0,
      "root": true,
      "rootEmpty": true,
      "_timeout": 30000
    }
  ],
  "meta": {
    "mocha": {
      "version": "10.2.0"
    },
    "mochawesome": {
      "options": {
        "quiet": false,
        "reportFilename": "mochawesome",
        "saveHtml": true,
        "saveJson": true,
        "consoleReporter": "spec",
        "useInlineDiffs": false,
        "code": true
      },
      "version": "7.1.3"
    },
    "marge": {
      "options": {
        "reportDir": "docs/test-report",
        "assetsDir": "docs/test-report/assets",
        "reportTitle": "Kresko Protocol Hardhat Test Report",
        "reportPageTitle": "Kresko Protocol Hardhat Test Report"
      },
      "version": "6.2.0"
    }
  }
}